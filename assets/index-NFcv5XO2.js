var fs=Object.defineProperty;var ms=(fi,ci,hi)=>ci in fi?fs(fi,ci,{enumerable:!0,configurable:!0,writable:!0,value:hi}):fi[ci]=hi;var hs=(fi,ci,hi)=>ms(fi,typeof ci!="symbol"?ci+"":ci,hi);(function(){const ci=document.createElement("link").relList;if(ci&&ci.supports&&ci.supports("modulepreload"))return;for(const pi of document.querySelectorAll('link[rel="modulepreload"]'))_i(pi);new MutationObserver(pi=>{for(const mi of pi)if(mi.type==="childList")for(const gi of mi.addedNodes)gi.tagName==="LINK"&&gi.rel==="modulepreload"&&_i(gi)}).observe(document,{childList:!0,subtree:!0});function hi(pi){const mi={};return pi.integrity&&(mi.integrity=pi.integrity),pi.referrerPolicy&&(mi.referrerPolicy=pi.referrerPolicy),pi.crossOrigin==="use-credentials"?mi.credentials="include":pi.crossOrigin==="anonymous"?mi.credentials="omit":mi.credentials="same-origin",mi}function _i(pi){if(pi.ep)return;pi.ep=!0;const mi=hi(pi);fetch(pi.href,mi)}})();var n$1,l$2,u$3,i$2,r$2,o$2,e$1,f$3,c$2,s$2,a$2,h$2,p$2={},v$2=[],y$2=/acit|ex(?:s|g|n|p|$)|rph|grid|ows|mnc|ntw|ine[ch]|zoo|^ord|itera/i,d$2=Array.isArray;function w$3(fi,ci){for(var hi in ci)fi[hi]=ci[hi];return fi}function _$2(fi){fi&&fi.parentNode&&fi.parentNode.removeChild(fi)}function g$3(fi,ci,hi){var _i,pi,mi,gi={};for(mi in ci)mi=="key"?_i=ci[mi]:mi=="ref"?pi=ci[mi]:gi[mi]=ci[mi];if(arguments.length>2&&(gi.children=arguments.length>3?n$1.call(arguments,2):hi),typeof fi=="function"&&fi.defaultProps!=null)for(mi in fi.defaultProps)gi[mi]===void 0&&(gi[mi]=fi.defaultProps[mi]);return m$2(fi,gi,_i,pi,null)}function m$2(fi,ci,hi,_i,pi){var mi={type:fi,props:ci,key:hi,ref:_i,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:pi??++u$3,__i:-1,__u:0};return pi==null&&l$2.vnode!=null&&l$2.vnode(mi),mi}function b$1(){return{current:null}}function k$3(fi){return fi.children}function x$3(fi,ci){this.props=fi,this.context=ci}function C$3(fi,ci){if(ci==null)return fi.__?C$3(fi.__,fi.__i+1):null;for(var hi;ci<fi.__k.length;ci++)if((hi=fi.__k[ci])!=null&&hi.__e!=null)return hi.__e;return typeof fi.type=="function"?C$3(fi):null}function S$1(fi){var ci,hi;if((fi=fi.__)!=null&&fi.__c!=null){for(fi.__e=fi.__c.base=null,ci=0;ci<fi.__k.length;ci++)if((hi=fi.__k[ci])!=null&&hi.__e!=null){fi.__e=fi.__c.base=hi.__e;break}return S$1(fi)}}function M$2(fi){(!fi.__d&&(fi.__d=!0)&&i$2.push(fi)&&!P$3.__r++||r$2!==l$2.debounceRendering)&&((r$2=l$2.debounceRendering)||o$2)(P$3)}function P$3(){var fi,ci,hi,_i,pi,mi,gi,vi;for(i$2.sort(e$1);fi=i$2.shift();)fi.__d&&(ci=i$2.length,_i=void 0,mi=(pi=(hi=fi).__v).__e,gi=[],vi=[],hi.__P&&((_i=w$3({},pi)).__v=pi.__v+1,l$2.vnode&&l$2.vnode(_i),j$3(hi.__P,_i,pi,hi.__n,hi.__P.namespaceURI,32&pi.__u?[mi]:null,gi,mi??C$3(pi),!!(32&pi.__u),vi),_i.__v=pi.__v,_i.__.__k[_i.__i]=_i,z$3(gi,_i,vi),_i.__e!=mi&&S$1(_i)),i$2.length>ci&&i$2.sort(e$1));P$3.__r=0}function $$2(fi,ci,hi,_i,pi,mi,gi,vi,xi,wi,yi){var Ci,Ei,Si,ki,Ai,Ii,Ti=_i&&_i.__k||v$2,Pi=ci.length;for(xi=I$2(hi,ci,Ti,xi,Pi),Ci=0;Ci<Pi;Ci++)(Si=hi.__k[Ci])!=null&&(Ei=Si.__i===-1?p$2:Ti[Si.__i]||p$2,Si.__i=Ci,Ii=j$3(fi,Si,Ei,pi,mi,gi,vi,xi,wi,yi),ki=Si.__e,Si.ref&&Ei.ref!=Si.ref&&(Ei.ref&&V$2(Ei.ref,null,Si),yi.push(Si.ref,Si.__c||ki,Si)),Ai==null&&ki!=null&&(Ai=ki),4&Si.__u||Ei.__k===Si.__k?xi=A$3(Si,xi,fi):typeof Si.type=="function"&&Ii!==void 0?xi=Ii:ki&&(xi=ki.nextSibling),Si.__u&=-7);return hi.__e=Ai,xi}function I$2(fi,ci,hi,_i,pi){var mi,gi,vi,xi,wi,yi=hi.length,Ci=yi,Ei=0;for(fi.__k=new Array(pi),mi=0;mi<pi;mi++)(gi=ci[mi])!=null&&typeof gi!="boolean"&&typeof gi!="function"?(xi=mi+Ei,(gi=fi.__k[mi]=typeof gi=="string"||typeof gi=="number"||typeof gi=="bigint"||gi.constructor==String?m$2(null,gi,null,null,null):d$2(gi)?m$2(k$3,{children:gi},null,null,null):gi.constructor===void 0&&gi.__b>0?m$2(gi.type,gi.props,gi.key,gi.ref?gi.ref:null,gi.__v):gi).__=fi,gi.__b=fi.__b+1,vi=null,(wi=gi.__i=L$2(gi,hi,xi,Ci))!==-1&&(Ci--,(vi=hi[wi])&&(vi.__u|=2)),vi==null||vi.__v===null?(wi==-1&&Ei--,typeof gi.type!="function"&&(gi.__u|=4)):wi!=xi&&(wi==xi-1?Ei--:wi==xi+1?Ei++:(wi>xi?Ei--:Ei++,gi.__u|=4))):fi.__k[mi]=null;if(Ci)for(mi=0;mi<yi;mi++)(vi=hi[mi])!=null&&!(2&vi.__u)&&(vi.__e==_i&&(_i=C$3(vi)),q$3(vi,vi));return _i}function A$3(fi,ci,hi){var _i,pi;if(typeof fi.type=="function"){for(_i=fi.__k,pi=0;_i&&pi<_i.length;pi++)_i[pi]&&(_i[pi].__=fi,ci=A$3(_i[pi],ci,hi));return ci}fi.__e!=ci&&(ci&&fi.type&&!hi.contains(ci)&&(ci=C$3(fi)),hi.insertBefore(fi.__e,ci||null),ci=fi.__e);do ci=ci&&ci.nextSibling;while(ci!=null&&ci.nodeType==8);return ci}function H$2(fi,ci){return ci=ci||[],fi==null||typeof fi=="boolean"||(d$2(fi)?fi.some(function(hi){H$2(hi,ci)}):ci.push(fi)),ci}function L$2(fi,ci,hi,_i){var pi,mi,gi=fi.key,vi=fi.type,xi=ci[hi];if(xi===null||xi&&gi==xi.key&&vi===xi.type&&!(2&xi.__u))return hi;if(_i>(xi!=null&&!(2&xi.__u)?1:0))for(pi=hi-1,mi=hi+1;pi>=0||mi<ci.length;){if(pi>=0){if((xi=ci[pi])&&!(2&xi.__u)&&gi==xi.key&&vi===xi.type)return pi;pi--}if(mi<ci.length){if((xi=ci[mi])&&!(2&xi.__u)&&gi==xi.key&&vi===xi.type)return mi;mi++}}return-1}function T$3(fi,ci,hi){ci[0]=="-"?fi.setProperty(ci,hi??""):fi[ci]=hi==null?"":typeof hi!="number"||y$2.test(ci)?hi:hi+"px"}function F$3(fi,ci,hi,_i,pi){var mi;t:if(ci=="style")if(typeof hi=="string")fi.style.cssText=hi;else{if(typeof _i=="string"&&(fi.style.cssText=_i=""),_i)for(ci in _i)hi&&ci in hi||T$3(fi.style,ci,"");if(hi)for(ci in hi)_i&&hi[ci]===_i[ci]||T$3(fi.style,ci,hi[ci])}else if(ci[0]=="o"&&ci[1]=="n")mi=ci!=(ci=ci.replace(f$3,"$1")),ci=ci.toLowerCase()in fi||ci=="onFocusOut"||ci=="onFocusIn"?ci.toLowerCase().slice(2):ci.slice(2),fi.l||(fi.l={}),fi.l[ci+mi]=hi,hi?_i?hi.u=_i.u:(hi.u=c$2,fi.addEventListener(ci,mi?a$2:s$2,mi)):fi.removeEventListener(ci,mi?a$2:s$2,mi);else{if(pi=="http://www.w3.org/2000/svg")ci=ci.replace(/xlink(H|:h)/,"h").replace(/sName$/,"s");else if(ci!="width"&&ci!="height"&&ci!="href"&&ci!="list"&&ci!="form"&&ci!="tabIndex"&&ci!="download"&&ci!="rowSpan"&&ci!="colSpan"&&ci!="role"&&ci!="popover"&&ci in fi)try{fi[ci]=hi??"";break t}catch{}typeof hi=="function"||(hi==null||hi===!1&&ci[4]!="-"?fi.removeAttribute(ci):fi.setAttribute(ci,ci=="popover"&&hi==1?"":hi))}}function O$2(fi){return function(ci){if(this.l){var hi=this.l[ci.type+fi];if(ci.t==null)ci.t=c$2++;else if(ci.t<hi.u)return;return hi(l$2.event?l$2.event(ci):ci)}}}function j$3(fi,ci,hi,_i,pi,mi,gi,vi,xi,wi){var yi,Ci,Ei,Si,ki,Ai,Ii,Ti,Pi,Li,Ri,Di,Fi,Mi,$i,Oi,Gi,Ui=ci.type;if(ci.constructor!==void 0)return null;128&hi.__u&&(xi=!!(32&hi.__u),mi=[vi=ci.__e=hi.__e]),(yi=l$2.__b)&&yi(ci);t:if(typeof Ui=="function")try{if(Ti=ci.props,Pi="prototype"in Ui&&Ui.prototype.render,Li=(yi=Ui.contextType)&&_i[yi.__c],Ri=yi?Li?Li.props.value:yi.__:_i,hi.__c?Ii=(Ci=ci.__c=hi.__c).__=Ci.__E:(Pi?ci.__c=Ci=new Ui(Ti,Ri):(ci.__c=Ci=new x$3(Ti,Ri),Ci.constructor=Ui,Ci.render=B$3),Li&&Li.sub(Ci),Ci.props=Ti,Ci.state||(Ci.state={}),Ci.context=Ri,Ci.__n=_i,Ei=Ci.__d=!0,Ci.__h=[],Ci._sb=[]),Pi&&Ci.__s==null&&(Ci.__s=Ci.state),Pi&&Ui.getDerivedStateFromProps!=null&&(Ci.__s==Ci.state&&(Ci.__s=w$3({},Ci.__s)),w$3(Ci.__s,Ui.getDerivedStateFromProps(Ti,Ci.__s))),Si=Ci.props,ki=Ci.state,Ci.__v=ci,Ei)Pi&&Ui.getDerivedStateFromProps==null&&Ci.componentWillMount!=null&&Ci.componentWillMount(),Pi&&Ci.componentDidMount!=null&&Ci.__h.push(Ci.componentDidMount);else{if(Pi&&Ui.getDerivedStateFromProps==null&&Ti!==Si&&Ci.componentWillReceiveProps!=null&&Ci.componentWillReceiveProps(Ti,Ri),!Ci.__e&&(Ci.shouldComponentUpdate!=null&&Ci.shouldComponentUpdate(Ti,Ci.__s,Ri)===!1||ci.__v==hi.__v)){for(ci.__v!=hi.__v&&(Ci.props=Ti,Ci.state=Ci.__s,Ci.__d=!1),ci.__e=hi.__e,ci.__k=hi.__k,ci.__k.some(function(zi){zi&&(zi.__=ci)}),Di=0;Di<Ci._sb.length;Di++)Ci.__h.push(Ci._sb[Di]);Ci._sb=[],Ci.__h.length&&gi.push(Ci);break t}Ci.componentWillUpdate!=null&&Ci.componentWillUpdate(Ti,Ci.__s,Ri),Pi&&Ci.componentDidUpdate!=null&&Ci.__h.push(function(){Ci.componentDidUpdate(Si,ki,Ai)})}if(Ci.context=Ri,Ci.props=Ti,Ci.__P=fi,Ci.__e=!1,Fi=l$2.__r,Mi=0,Pi){for(Ci.state=Ci.__s,Ci.__d=!1,Fi&&Fi(ci),yi=Ci.render(Ci.props,Ci.state,Ci.context),$i=0;$i<Ci._sb.length;$i++)Ci.__h.push(Ci._sb[$i]);Ci._sb=[]}else do Ci.__d=!1,Fi&&Fi(ci),yi=Ci.render(Ci.props,Ci.state,Ci.context),Ci.state=Ci.__s;while(Ci.__d&&++Mi<25);Ci.state=Ci.__s,Ci.getChildContext!=null&&(_i=w$3(w$3({},_i),Ci.getChildContext())),Pi&&!Ei&&Ci.getSnapshotBeforeUpdate!=null&&(Ai=Ci.getSnapshotBeforeUpdate(Si,ki)),vi=$$2(fi,d$2(Oi=yi!=null&&yi.type===k$3&&yi.key==null?yi.props.children:yi)?Oi:[Oi],ci,hi,_i,pi,mi,gi,vi,xi,wi),Ci.base=ci.__e,ci.__u&=-161,Ci.__h.length&&gi.push(Ci),Ii&&(Ci.__E=Ci.__=null)}catch(zi){if(ci.__v=null,xi||mi!=null)if(zi.then){for(ci.__u|=xi?160:128;vi&&vi.nodeType==8&&vi.nextSibling;)vi=vi.nextSibling;mi[mi.indexOf(vi)]=null,ci.__e=vi}else for(Gi=mi.length;Gi--;)_$2(mi[Gi]);else ci.__e=hi.__e,ci.__k=hi.__k;l$2.__e(zi,ci,hi)}else mi==null&&ci.__v==hi.__v?(ci.__k=hi.__k,ci.__e=hi.__e):vi=ci.__e=N$2(hi.__e,ci,hi,_i,pi,mi,gi,xi,wi);return(yi=l$2.diffed)&&yi(ci),128&ci.__u?void 0:vi}function z$3(fi,ci,hi){for(var _i=0;_i<hi.length;_i++)V$2(hi[_i],hi[++_i],hi[++_i]);l$2.__c&&l$2.__c(ci,fi),fi.some(function(pi){try{fi=pi.__h,pi.__h=[],fi.some(function(mi){mi.call(pi)})}catch(mi){l$2.__e(mi,pi.__v)}})}function N$2(fi,ci,hi,_i,pi,mi,gi,vi,xi){var wi,yi,Ci,Ei,Si,ki,Ai,Ii=hi.props,Ti=ci.props,Pi=ci.type;if(Pi=="svg"?pi="http://www.w3.org/2000/svg":Pi=="math"?pi="http://www.w3.org/1998/Math/MathML":pi||(pi="http://www.w3.org/1999/xhtml"),mi!=null){for(wi=0;wi<mi.length;wi++)if((Si=mi[wi])&&"setAttribute"in Si==!!Pi&&(Pi?Si.localName==Pi:Si.nodeType==3)){fi=Si,mi[wi]=null;break}}if(fi==null){if(Pi==null)return document.createTextNode(Ti);fi=document.createElementNS(pi,Pi,Ti.is&&Ti),vi&&(l$2.__m&&l$2.__m(ci,mi),vi=!1),mi=null}if(Pi===null)Ii===Ti||vi&&fi.data===Ti||(fi.data=Ti);else{if(mi=mi&&n$1.call(fi.childNodes),Ii=hi.props||p$2,!vi&&mi!=null)for(Ii={},wi=0;wi<fi.attributes.length;wi++)Ii[(Si=fi.attributes[wi]).name]=Si.value;for(wi in Ii)if(Si=Ii[wi],wi!="children"){if(wi=="dangerouslySetInnerHTML")Ci=Si;else if(!(wi in Ti)){if(wi=="value"&&"defaultValue"in Ti||wi=="checked"&&"defaultChecked"in Ti)continue;F$3(fi,wi,null,Si,pi)}}for(wi in Ti)Si=Ti[wi],wi=="children"?Ei=Si:wi=="dangerouslySetInnerHTML"?yi=Si:wi=="value"?ki=Si:wi=="checked"?Ai=Si:vi&&typeof Si!="function"||Ii[wi]===Si||F$3(fi,wi,Si,Ii[wi],pi);if(yi)vi||Ci&&(yi.__html===Ci.__html||yi.__html===fi.innerHTML)||(fi.innerHTML=yi.__html),ci.__k=[];else if(Ci&&(fi.innerHTML=""),$$2(fi,d$2(Ei)?Ei:[Ei],ci,hi,_i,Pi=="foreignObject"?"http://www.w3.org/1999/xhtml":pi,mi,gi,mi?mi[0]:hi.__k&&C$3(hi,0),vi,xi),mi!=null)for(wi=mi.length;wi--;)_$2(mi[wi]);vi||(wi="value",Pi=="progress"&&ki==null?fi.removeAttribute("value"):ki!==void 0&&(ki!==fi[wi]||Pi=="progress"&&!ki||Pi=="option"&&ki!==Ii[wi])&&F$3(fi,wi,ki,Ii[wi],pi),wi="checked",Ai!==void 0&&Ai!==fi[wi]&&F$3(fi,wi,Ai,Ii[wi],pi))}return fi}function V$2(fi,ci,hi){try{if(typeof fi=="function"){var _i=typeof fi.__u=="function";_i&&fi.__u(),_i&&ci==null||(fi.__u=fi(ci))}else fi.current=ci}catch(pi){l$2.__e(pi,hi)}}function q$3(fi,ci,hi){var _i,pi;if(l$2.unmount&&l$2.unmount(fi),(_i=fi.ref)&&(_i.current&&_i.current!==fi.__e||V$2(_i,null,ci)),(_i=fi.__c)!=null){if(_i.componentWillUnmount)try{_i.componentWillUnmount()}catch(mi){l$2.__e(mi,ci)}_i.base=_i.__P=null}if(_i=fi.__k)for(pi=0;pi<_i.length;pi++)_i[pi]&&q$3(_i[pi],ci,hi||typeof fi.type!="function");hi||_$2(fi.__e),fi.__c=fi.__=fi.__e=void 0}function B$3(fi,ci,hi){return this.constructor(fi,hi)}function D$3(fi,ci,hi){var _i,pi,mi,gi;ci==document&&(ci=document.documentElement),l$2.__&&l$2.__(fi,ci),pi=(_i=typeof hi=="function")?null:hi&&hi.__k||ci.__k,mi=[],gi=[],j$3(ci,fi=(!_i&&hi||ci).__k=g$3(k$3,null,[fi]),pi||p$2,p$2,ci.namespaceURI,!_i&&hi?[hi]:pi?null:ci.firstChild?n$1.call(ci.childNodes):null,mi,!_i&&hi?hi:pi?pi.__e:ci.firstChild,_i,gi),z$3(mi,fi,gi)}function E$2(fi,ci){D$3(fi,ci,E$2)}function G$2(fi,ci,hi){var _i,pi,mi,gi,vi=w$3({},fi.props);for(mi in fi.type&&fi.type.defaultProps&&(gi=fi.type.defaultProps),ci)mi=="key"?_i=ci[mi]:mi=="ref"?pi=ci[mi]:vi[mi]=ci[mi]===void 0&&gi!==void 0?gi[mi]:ci[mi];return arguments.length>2&&(vi.children=arguments.length>3?n$1.call(arguments,2):hi),m$2(fi.type,vi,_i||fi.key,pi||fi.ref,null)}function J$2(fi,ci){var hi={__c:ci="__cC"+h$2++,__:fi,Consumer:function(_i,pi){return _i.children(pi)},Provider:function(_i){var pi,mi;return this.getChildContext||(pi=new Set,(mi={})[ci]=this,this.getChildContext=function(){return mi},this.componentWillUnmount=function(){pi=null},this.shouldComponentUpdate=function(gi){this.props.value!==gi.value&&pi.forEach(function(vi){vi.__e=!0,M$2(vi)})},this.sub=function(gi){pi.add(gi);var vi=gi.componentWillUnmount;gi.componentWillUnmount=function(){pi&&pi.delete(gi),vi&&vi.call(gi)}}),_i.children}};return hi.Provider.__=hi.Consumer.contextType=hi}n$1=v$2.slice,l$2={__e:function(fi,ci,hi,_i){for(var pi,mi,gi;ci=ci.__;)if((pi=ci.__c)&&!pi.__)try{if((mi=pi.constructor)&&mi.getDerivedStateFromError!=null&&(pi.setState(mi.getDerivedStateFromError(fi)),gi=pi.__d),pi.componentDidCatch!=null&&(pi.componentDidCatch(fi,_i||{}),gi=pi.__d),gi)return pi.__E=pi}catch(vi){fi=vi}throw fi}},u$3=0,x$3.prototype.setState=function(fi,ci){var hi;hi=this.__s!=null&&this.__s!==this.state?this.__s:this.__s=w$3({},this.state),typeof fi=="function"&&(fi=fi(w$3({},hi),this.props)),fi&&w$3(hi,fi),fi!=null&&this.__v&&(ci&&this._sb.push(ci),M$2(this))},x$3.prototype.forceUpdate=function(fi){this.__v&&(this.__e=!0,fi&&this.__h.push(fi),M$2(this))},x$3.prototype.render=k$3,i$2=[],o$2=typeof Promise=="function"?Promise.prototype.then.bind(Promise.resolve()):setTimeout,e$1=function(fi,ci){return fi.__v.__b-ci.__v.__b},P$3.__r=0,f$3=/(PointerCapture)$|Capture$/i,c$2=0,s$2=O$2(!1),a$2=O$2(!0),h$2=0;var f$2=0;function u$2(fi,ci,hi,_i,pi,mi){ci||(ci={});var gi,vi,xi=ci;"ref"in ci&&(gi=ci.ref,delete ci.ref);var wi={type:fi,props:xi,key:hi,ref:gi,__k:null,__:null,__b:0,__e:null,__c:null,constructor:void 0,__v:--f$2,__i:-1,__u:0,__source:pi,__self:mi};if(typeof fi=="function"&&(gi=fi.defaultProps))for(vi in gi)xi[vi]===void 0&&(xi[vi]=gi[vi]);return l$2.vnode&&l$2.vnode(wi),wi}/*!
 * excalibur - 0.30.3 - 2025-1-1
 * https://github.com/excaliburjs/Excalibur
 * Copyright (c) 2025 Excalibur.js <https://github.com/excaliburjs/Excalibur/graphs/contributors>
 * Licensed BSD-2-Clause
 * @preserve
 */var __webpack_modules__={851:(fi,ci,hi)=>{hi.d(ci,{A:()=>xi});var _i=hi(1),pi=hi.n(_i),mi=hi(935),gi=hi.n(mi),vi=gi()(pi());vi.push([fi.id,`/* Buttons styles start */

button#excalibur-play {
  display: inline-block;
  position: relative;
  z-index: 999;
  border-radius: 6px;
  border: none;
  /*border: 3px solid;
    border-color: white;
    box-shadow: 0 0 10px #ccc;*/
  padding: 1rem 1.5rem 1rem 4rem;
  margin: 0;
  text-decoration: none;
  background: #00b233;
  color: #ffffff;
  font-family: sans-serif;
  font-size: 2rem;
  white-space: nowrap;
  line-height: 1;
  cursor: pointer;
  text-align: center;
  transition:
    background 250ms ease-in-out,
    transform 150ms ease;
  -webkit-appearance: none;
  -moz-appearance: none;

  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */
  animation: excalibur-button-fadein 200ms;
}

/*
button#excalibur-play {
  display: none;
}*/

button#excalibur-play:after {
  position: absolute;
  content: '';
  border: 8px solid;
  border-color: transparent transparent transparent white;
  left: 35px;
  top: 24px;
  width: 0;
  height: 0;
}

button#excalibur-play:before {
  position: absolute;
  content: '';
  border: 3px solid;
  left: 19px;
  top: 14px;
  border-radius: 20px;
  width: 30px;
  height: 30px;
}

button#excalibur-play:hover,
button#excalibur-play:focus {
  background: #00982c;
}

button#excalibur-play:focus {
  outline: 1px solid #fff;
  outline-offset: -4px;
}

button#excalibur-play:active {
  transform: scale(0.99);
}

@keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Firefox < 16 */
@-moz-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Safari, Chrome and Opera > 12.1 */
@-webkit-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Internet Explorer */
@-ms-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}

/* Opera < 12.1 */
@-o-keyframes excalibur-button-fadein {
  from {
    opacity: 0;
  }
  to {
    opacity: 1;
  }
}
`,"",{version:3,sources:["webpack://./Director/Loader.css"],names:[],mappings:"AAAA,yBAAyB;;AAEzB;EACE,qBAAqB;EACrB,kBAAkB;EAClB,YAAY;EACZ,kBAAkB;EAClB,YAAY;EACZ;;+BAE6B;EAC7B,8BAA8B;EAC9B,SAAS;EACT,qBAAqB;EACrB,mBAAmB;EACnB,cAAc;EACd,uBAAuB;EACvB,eAAe;EACf,mBAAmB;EACnB,cAAc;EACd,eAAe;EACf,kBAAkB;EAClB;;wBAEsB;EACtB,wBAAwB;EACxB,qBAAqB;;EAErB,gDAAgD,EAAE,oCAAoC;EACtF,6CAA6C,EAAE,iBAAiB;EAChE,4CAA4C,EAAE,sBAAsB;EACpE,2CAA2C,EAAE,iBAAiB;EAC9D,wCAAwC;AAC1C;;AAEA;;;EAGE;;AAEF;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,uDAAuD;EACvD,UAAU;EACV,SAAS;EACT,QAAQ;EACR,SAAS;AACX;;AAEA;EACE,kBAAkB;EAClB,WAAW;EACX,iBAAiB;EACjB,UAAU;EACV,SAAS;EACT,mBAAmB;EACnB,WAAW;EACX,YAAY;AACd;;AAEA;;EAEE,mBAAmB;AACrB;;AAEA;EACE,uBAAuB;EACvB,oBAAoB;AACtB;;AAEA;EACE,sBAAsB;AACxB;;AAEA;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,oCAAoC;AACpC;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,sBAAsB;AACtB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF;;AAEA,iBAAiB;AACjB;EACE;IACE,UAAU;EACZ;EACA;IACE,UAAU;EACZ;AACF",sourcesContent:[`/* Buttons styles start */\r
\r
button#excalibur-play {\r
  display: inline-block;\r
  position: relative;\r
  z-index: 999;\r
  border-radius: 6px;\r
  border: none;\r
  /*border: 3px solid;\r
    border-color: white;\r
    box-shadow: 0 0 10px #ccc;*/\r
  padding: 1rem 1.5rem 1rem 4rem;\r
  margin: 0;\r
  text-decoration: none;\r
  background: #00b233;\r
  color: #ffffff;\r
  font-family: sans-serif;\r
  font-size: 2rem;\r
  white-space: nowrap;\r
  line-height: 1;\r
  cursor: pointer;\r
  text-align: center;\r
  transition:\r
    background 250ms ease-in-out,\r
    transform 150ms ease;\r
  -webkit-appearance: none;\r
  -moz-appearance: none;\r
\r
  -webkit-animation: excalibur-button-fadein 200ms; /* Safari, Chrome and Opera > 12.1 */\r
  -moz-animation: excalibur-button-fadein 200ms; /* Firefox < 16 */\r
  -ms-animation: excalibur-button-fadein 200ms; /* Internet Explorer */\r
  -o-animation: excalibur-button-fadein 200ms; /* Opera < 12.1 */\r
  animation: excalibur-button-fadein 200ms;\r
}\r
\r
/*\r
button#excalibur-play {\r
  display: none;\r
}*/\r
\r
button#excalibur-play:after {\r
  position: absolute;\r
  content: '';\r
  border: 8px solid;\r
  border-color: transparent transparent transparent white;\r
  left: 35px;\r
  top: 24px;\r
  width: 0;\r
  height: 0;\r
}\r
\r
button#excalibur-play:before {\r
  position: absolute;\r
  content: '';\r
  border: 3px solid;\r
  left: 19px;\r
  top: 14px;\r
  border-radius: 20px;\r
  width: 30px;\r
  height: 30px;\r
}\r
\r
button#excalibur-play:hover,\r
button#excalibur-play:focus {\r
  background: #00982c;\r
}\r
\r
button#excalibur-play:focus {\r
  outline: 1px solid #fff;\r
  outline-offset: -4px;\r
}\r
\r
button#excalibur-play:active {\r
  transform: scale(0.99);\r
}\r
\r
@keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Firefox < 16 */\r
@-moz-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Safari, Chrome and Opera > 12.1 */\r
@-webkit-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Internet Explorer */\r
@-ms-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
\r
/* Opera < 12.1 */\r
@-o-keyframes excalibur-button-fadein {\r
  from {\r
    opacity: 0;\r
  }\r
  to {\r
    opacity: 1;\r
  }\r
}\r
`],sourceRoot:""}]);const xi=vi},296:(fi,ci,hi)=>{hi.d(ci,{A:()=>xi});var _i=hi(1),pi=hi.n(_i),mi=hi(935),gi=hi.n(mi),vi=gi()(pi());vi.push([fi.id,`#ex-toast-container {
  position: absolute;
  height: 0;
  min-width: 50%;
  left: 50%;
  top: 0;
}

.ex-toast-message {
  left: -50%;
  position: relative;
  display: flex;
  justify-content: space-between;

  padding: 10px;
  margin-top: 5px;
  font-size: 18px;
  font-family: sans-serif;
  border-radius: 6px;
  border: 3px solid #b7b779;
  background-color: rgb(253, 253, 192);
}

.ex-toast-message button {
  align-self: flex-start;
}
`,"",{version:3,sources:["webpack://./Util/Toaster.css"],names:[],mappings:"AAAA;EACE,kBAAkB;EAClB,SAAS;EACT,cAAc;EACd,SAAS;EACT,MAAM;AACR;;AAEA;EACE,UAAU;EACV,kBAAkB;EAClB,aAAa;EACb,8BAA8B;;EAE9B,aAAa;EACb,eAAe;EACf,eAAe;EACf,uBAAuB;EACvB,kBAAkB;EAClB,yBAAyB;EACzB,oCAAoC;AACtC;;AAEA;EACE,sBAAsB;AACxB",sourcesContent:[`#ex-toast-container {\r
  position: absolute;\r
  height: 0;\r
  min-width: 50%;\r
  left: 50%;\r
  top: 0;\r
}\r
\r
.ex-toast-message {\r
  left: -50%;\r
  position: relative;\r
  display: flex;\r
  justify-content: space-between;\r
\r
  padding: 10px;\r
  margin-top: 5px;\r
  font-size: 18px;\r
  font-family: sans-serif;\r
  border-radius: 6px;\r
  border: 3px solid #b7b779;\r
  background-color: rgb(253, 253, 192);\r
}\r
\r
.ex-toast-message button {\r
  align-self: flex-start;\r
}\r
`],sourceRoot:""}]);const xi=vi},935:fi=>{fi.exports=function(ci){var hi=[];return hi.toString=function(){return this.map(function(pi){var mi="",gi=typeof pi[5]<"u";return pi[4]&&(mi+="@supports (".concat(pi[4],") {")),pi[2]&&(mi+="@media ".concat(pi[2]," {")),gi&&(mi+="@layer".concat(pi[5].length>0?" ".concat(pi[5]):""," {")),mi+=ci(pi),gi&&(mi+="}"),pi[2]&&(mi+="}"),pi[4]&&(mi+="}"),mi}).join("")},hi.i=function(pi,mi,gi,vi,xi){typeof pi=="string"&&(pi=[[null,pi,void 0]]);var wi={};if(gi)for(var yi=0;yi<this.length;yi++){var Ci=this[yi][0];Ci!=null&&(wi[Ci]=!0)}for(var Ei=0;Ei<pi.length;Ei++){var Si=[].concat(pi[Ei]);gi&&wi[Si[0]]||(typeof xi<"u"&&(typeof Si[5]>"u"||(Si[1]="@layer".concat(Si[5].length>0?" ".concat(Si[5]):""," {").concat(Si[1],"}")),Si[5]=xi),mi&&(Si[2]&&(Si[1]="@media ".concat(Si[2]," {").concat(Si[1],"}")),Si[2]=mi),vi&&(Si[4]?(Si[1]="@supports (".concat(Si[4],") {").concat(Si[1],"}"),Si[4]=vi):Si[4]="".concat(vi)),hi.push(Si))}},hi}},1:fi=>{fi.exports=function(ci){var hi=ci[1],_i=ci[3];if(!_i)return hi;if(typeof btoa=="function"){var pi=btoa(unescape(encodeURIComponent(JSON.stringify(_i)))),mi="sourceMappingURL=data:application/json;charset=utf-8;base64,".concat(pi),gi="/*# ".concat(mi," */");return[hi].concat([gi]).join(`
`)}return[hi].join(`
`)}}},__webpack_module_cache__={};function __webpack_require__(fi){var ci=__webpack_module_cache__[fi];if(ci!==void 0)return ci.exports;var hi=__webpack_module_cache__[fi]={id:fi,exports:{}};return __webpack_modules__[fi](hi,hi.exports,__webpack_require__),hi.exports}__webpack_require__.n=fi=>{var ci=fi&&fi.__esModule?()=>fi.default:()=>fi;return __webpack_require__.d(ci,{a:ci}),ci};__webpack_require__.d=(fi,ci)=>{for(var hi in ci)__webpack_require__.o(ci,hi)&&!__webpack_require__.o(fi,hi)&&Object.defineProperty(fi,hi,{enumerable:!0,get:ci[hi]})};__webpack_require__.o=(fi,ci)=>Object.prototype.hasOwnProperty.call(fi,ci);__webpack_require__.r=fi=>{typeof Symbol<"u"&&Symbol.toStringTag&&Object.defineProperty(fi,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(fi,"__esModule",{value:!0})};var __webpack_exports__={};__webpack_require__.d(__webpack_exports__,{eKr:()=>ActionCompleteEvent,yVm:()=>ActionContext,a7j:()=>ActionQueue,U_w:()=>ActionSequence,JF2:()=>ActionStartEvent,htg:()=>ActionsComponent,HXL:()=>ActionsSystem,mcg:()=>ActivateEvent,Agj:()=>Actor,J3_:()=>ActorEvents,Wgv:()=>AddEvent,u6S:()=>AddedComponent,x7M:()=>AffineMatrix,X55:()=>Animation,m3M:()=>AnimationDirection,aE5:()=>AnimationEvents,YJU:()=>AnimationStrategy,eZi:()=>ArcadeSolver,GNv:()=>AudioContextFactory,Y56:()=>Axes,_0v:()=>Axis,vhs:()=>BaseAlign,vrQ:()=>BezierCurve,Z8b:()=>Blink,Yfw:()=>BodyComponent,IcQ:()=>BoundingBox,kgJ:()=>BrowserComponent,GTT:()=>BrowserEvents,ypY:()=>Buttons,i7d:()=>Camera,fQ3:()=>CameraEvents,HlI:()=>Canvas$1,jlt:()=>Circle,VQc:()=>CircleCollider,zD7:()=>Clock,AUF:()=>ClosestLineJumpTable,JoF:()=>Collider,MlA:()=>ColliderComponent,PZh:()=>CollisionContact,qA:()=>CollisionEndEvent,CrD:()=>CollisionGroup,dQK:()=>CollisionGroupManager,D3r:()=>CollisionJumpTable,Qpo:()=>CollisionPostSolveEvent,D9n:()=>CollisionPreSolveEvent,b6v:()=>CollisionStartEvent,mvh:()=>CollisionSystem,Bpo:()=>CollisionType,Q1f:()=>Color,IKv:()=>ColorBlindFlags,fcV:()=>ColorBlindnessMode,Glf:()=>ColorBlindnessPostProcessor,uAl:()=>Component,ElT:()=>CompositeCollider,Z8r:()=>ConsoleAppender,QSL:()=>ContactConstraintPoint,sPV:()=>ContactEndEvent,nAn:()=>ContactSolveBias,zCU:()=>ContactStartEvent,QrV:()=>CoordPlane,fF9:()=>CrossFade,Jqv:()=>CurveBy,d_u:()=>CurveTo,xI8:()=>DeactivateEvent,yar:()=>Debug,SP7:()=>DebugConfig,oRy:()=>DebugGraphicsComponent,f5X:()=>DebugSystem,V1c:()=>DebugText,Mlx:()=>DefaultAntialiasOptions,ZiM:()=>DefaultGarbageCollectionOptions,ZCo:()=>DefaultLoader,J5p:()=>DefaultPixelArtOptions,mL_:()=>DegreeOfFreedom,Guw:()=>Delay,N5j:()=>Detector,pgY:()=>Die,OP3:()=>Direction,rl5:()=>Director,eod:()=>DirectorEvents,q5Z:()=>DisplayMode,YUC:()=>DynamicTree,saR:()=>DynamicTreeCollisionProcessor,hvr:()=>EX_VERSION,Qol:()=>EaseBy,Wf4:()=>EaseTo,JCs:()=>EasingFunctions,gJV:()=>EdgeCollider,fWD:()=>ElasticToActorStrategy,Va_:()=>EmitterType,N$8:()=>Engine,_jQ:()=>EngineEvents,rxj:()=>EnterTriggerEvent,rhv:()=>EnterViewPortEvent,wCu:()=>Entity,HAp:()=>EntityEvents,Zy1:()=>EntityManager,bkB:()=>EventEmitter,wfL:()=>EventTypes,sVA:()=>Events_namespaceObject,$Gs:()=>ExResponse,CJ0:()=>ExcaliburGraphicsContext2DCanvas,NWh:()=>ExcaliburGraphicsContextWebGL,tWi:()=>ExitTriggerEvent,xAj:()=>ExitViewPortEvent,zWh:()=>Fade,i_4:()=>FadeInOut,iIx:()=>Flags,Hxo:()=>Flash,c9e:()=>Follow,KQV:()=>Font,weH:()=>FontCache,jXp:()=>FontSource,zzY:()=>FontStyle,yRQ:()=>FontUnit,MtE:()=>FpsSampler,rPj:()=>FrameStats,KLc:()=>Future,Fir:()=>GameEvent,V5f:()=>GameStartEvent,Xj7:()=>GameStopEvent,Wud:()=>Gamepad,FVg:()=>GamepadAxisEvent,g5Y:()=>GamepadButtonEvent,YQB:()=>GamepadConnectEvent,KPb:()=>GamepadDisconnectEvent,nHK:()=>Gamepads,Jrb:()=>GarbageCollector,TX_:()=>Gif,Olt:()=>GifParser,r3n:()=>GlobalCoordinates,Fvk:()=>GpuParticleEmitter,gpR:()=>GpuParticleRenderer,vYh:()=>Graphic,hnk:()=>GraphicsComponent,D2R:()=>GraphicsGroup,n1o:()=>GraphicsSystem,h9O:()=>HashColliderProxy,X5j:()=>HashGridCell,p3P:()=>HashGridProxy,RLG:()=>HiddenEvent,fBU:()=>HorizontalFirst,Adb:()=>ImageFiltering,bEs:()=>ImageSource,wCy:()=>ImageSourceAttributeConstants,CbD:()=>ImageWrapping,x_C:()=>InitializeEvent,pGf:()=>InputHost,ibQ:()=>InputMapper,shR:()=>IsometricEntityComponent,Yjk:()=>IsometricEntitySystem,_u1:()=>IsometricMap,OBI:()=>IsometricTile,klh:()=>KeyEvent,s3S:()=>Keyboard$1,D$R:()=>Keys,xth:()=>KillEvent,JU7:()=>Label,h9x:()=>LimitCameraBoundsStrategy,N1A:()=>Line,e_k:()=>LineSegment,aHM:()=>Loader,tlv:()=>LoaderEvents,Vi9:()=>LockCameraToActorAxisStrategy,ieR:()=>LockCameraToActorStrategy,$bb:()=>LogLevel,VyI:()=>Logger,imn:()=>Material,uqu:()=>Matrix,QnL:()=>MatrixLocations,vnc:()=>MediaEvent,wk_:()=>Meet,GH0:()=>MotionComponent,_1r:()=>MotionSystem,l0X:()=>MoveBy,bT:()=>MoveByWithOptions,HHX:()=>MoveTo,jtW:()=>MoveToWithOptions,tjk:()=>NativePointerButton,rWe:()=>NativeSoundEvent,j9l:()=>NativeSoundProcessedEvent,l0$:()=>NineSlice,sGJ:()=>NineSliceStretch,NVp:()=>None,cPK:()=>Observable,XoL:()=>OffscreenSystem,RmF:()=>Pair,DXI:()=>ParallaxComponent,tCD:()=>ParallelActions,J3D:()=>Particle,vCJ:()=>ParticleEmitter,e6k:()=>ParticleRenderer,f9l:()=>ParticleTransform,v9m:()=>PhysicsStats,yRJ:()=>PhysicsWorld,EU6:()=>PointerAbstraction,m3O:()=>PointerButton,Ryz:()=>PointerComponent,OxP:()=>PointerEvent,LEs:()=>PointerEventReceiver,Ec:()=>PointerScope,Pi5:()=>PointerSystem,gmH:()=>PointerType,tS:()=>Polygon,XxX:()=>PolygonCollider,bCz:()=>Pool,nYS:()=>PostCollisionEvent,yiT:()=>PostDebugDrawEvent,NHl:()=>PostDrawEvent,mO8:()=>PostFrameEvent,PXI:()=>PostKillEvent,bn5:()=>PostTransformDrawEvent,Ywr:()=>PostUpdateEvent,cMd:()=>PreCollisionEvent,Bs6:()=>PreDebugDrawEvent,G0k:()=>PreDrawEvent,pyn:()=>PreFrameEvent,QeM:()=>PreKillEvent,aPX:()=>PreLoadEvent,ITP:()=>PreTransformDrawEvent,BY0:()=>PreUpdateEvent,MFw:()=>Projection,sBn:()=>QuadIndexBuffer,S3L:()=>QuadTree,XKQ:()=>Query,ESI:()=>QueryManager,uxz:()=>RadiusAroundActorStrategy,o8N:()=>Random,u_r:()=>Raster,RlV:()=>Ray,gVA:()=>RealisticSolver,M_G:()=>Rectangle,BpG:()=>RemoveEvent,GRB:()=>RemovedComponent,kM6:()=>Repeat,dO8:()=>RepeatForever,jgM:()=>Resolution,FWq:()=>Resource,s3j:()=>ResourceEvents,hlw:()=>RotateBy,L0q:()=>RotateByWithOptions,B7e:()=>RotateTo,PGN:()=>RotateToWithOptions,H_X:()=>RotationType,S_d:()=>ScaleBy,_Tq:()=>ScaleByWithOptions,U7E:()=>ScaleTo,IOH:()=>ScaleToWithOptions,Z58:()=>Scene,yh2:()=>SceneEvents,ff$:()=>Screen,cWi:()=>ScreenAppender,NBt:()=>ScreenElement,oNz:()=>ScreenEvents,QlU:()=>ScreenShader,Xey:()=>ScrollPreventionMode,jft:()=>Semaphore,_r8:()=>SeparatingAxis,bTC:()=>SeparationInfo,Mtr:()=>Shader,ypk:()=>Shape,mnM:()=>Side,q7S:()=>Slide,bAZ:()=>SolverStrategy,ABN:()=>Sound,VK6:()=>SoundEvents,Hj2:()=>SparseHashGrid,Df8:()=>SparseHashGridCollisionProcessor,oOx:()=>SpatialPartitionStrategy,kxk:()=>Sprite,DT1:()=>SpriteFont,FLG:()=>SpriteSheet,qN_:()=>StandardClock,Z37:()=>StateMachine,FtL:()=>StrategyContainer,Z6X:()=>Stream$1,iQT:()=>System,ziO:()=>SystemManager,OEF:()=>SystemPriority,uuE:()=>SystemType,tiv:()=>TagQuery,T$Y:()=>TestClock,EYj:()=>Text,nOB:()=>TextAlign,Tap:()=>TextureLoader,FAs:()=>Tile,B_P:()=>TileMap,aA5:()=>TileMapEvents,J3s:()=>TiledAnimation,Y0Q:()=>TiledSprite,M4G:()=>Timer,l$l:()=>Toaster,dLy:()=>transform_Transform,WZP:()=>TransformComponent,eB6:()=>Transition,nFK:()=>TreeNode,l9z:()=>Trigger,YOF:()=>TriggerEvents,yhB:()=>TwoPI,J0N:()=>Util_Index_namespaceObject,Miz:()=>Vector,Bj4:()=>VectorView,Rcs:()=>VertexBuffer,vJ4:()=>VertexLayout,TqC:()=>VerticalFirst,nM0:()=>VisibleEvent,X1u:()=>WebAudio,SpZ:()=>WebAudioInstance,DX8:()=>WheelDeltaMode,Yx$:()=>WheelEvent,HK4:()=>World,yt5:()=>approximatelyEqual,vAR:()=>assert,SE$:()=>canonicalizeAngle,qE8:()=>clamp,Pz7:()=>coroutine,sX_:()=>createId,JuI:()=>frac,pxT:()=>getDefaultPhysicsConfig,Nl$:()=>hasGraphicsTick,zDr:()=>hasOnAdd,OwT:()=>hasOnInitialize,P$G:()=>hasOnPostUpdate,mHV:()=>hasOnPreUpdate,kEA:()=>hasOnRemove,Fx_:()=>hasPostDraw,WFC:()=>hasPreDraw,vKu:()=>has_add,aDq:()=>has_initialize,jIg:()=>has_postupdate,UH3:()=>has_preupdate,AJO:()=>has_remove,U4:()=>inverseLerp,xAc:()=>inverseLerpVector,_3Y:()=>isActor,K6X:()=>isAddedComponent,C1Y:()=>isComponentCtor,Aw1:()=>isLoaderConstructor,tm8:()=>isMoveByOptions,LBV:()=>isMoveToOptions,A8$:()=>isRemovedComponent,F5e:()=>isRotateByOptions,ran:()=>isRotateToOptions,c8L:()=>isScaleByOptions,o6M:()=>isScaleToOptions,hsx:()=>isSceneConstructor,l9E:()=>isScreenElement,aSf:()=>isSystemConstructor,CcK:()=>lerp,nU8:()=>lerpAngle,td6:()=>lerpVector,Zex:()=>maxMessages,bkJ:()=>nextActionId,mXP:()=>obsolete,vt$:()=>parseImageFiltering,hCA:()=>parseImageWrapping,pjR:()=>pixelSnapEpsilon,U43:()=>randomInRange,pSZ:()=>randomIntInRange,y17:()=>range,Ew7:()=>remap,hG1:()=>remapVector,jVr:()=>resetObsoleteCounter,_SZ:()=>sign,xWn:()=>toDegrees,ehJ:()=>toRadians,t6s:()=>vec,Eyn:()=>webgl_util_namespaceObject});var webgl_util_namespaceObject={};__webpack_require__.r(webgl_util_namespaceObject);__webpack_require__.d(webgl_util_namespaceObject,{getAttributeComponentSize:()=>getAttributeComponentSize,getAttributePointerType:()=>getAttributePointerType,getGLTypeFromSource:()=>getGLTypeFromSource,getGlTypeSizeBytes:()=>getGlTypeSizeBytes,getMaxShaderComplexity:()=>getMaxShaderComplexity,isAttributeInSource:()=>isAttributeInSource});var DrawUtil_namespaceObject={};__webpack_require__.r(DrawUtil_namespaceObject);__webpack_require__.d(DrawUtil_namespaceObject,{circle:()=>circle,line:()=>line,point:()=>point,roundRect:()=>roundRect,vector:()=>vector});var Events_namespaceObject={};__webpack_require__.r(Events_namespaceObject);__webpack_require__.d(Events_namespaceObject,{ActionCompleteEvent:()=>ActionCompleteEvent,ActionStartEvent:()=>ActionStartEvent,ActivateEvent:()=>ActivateEvent,AddEvent:()=>AddEvent,CollisionEndEvent:()=>CollisionEndEvent,CollisionPostSolveEvent:()=>CollisionPostSolveEvent,CollisionPreSolveEvent:()=>CollisionPreSolveEvent,CollisionStartEvent:()=>CollisionStartEvent,ContactEndEvent:()=>ContactEndEvent,ContactStartEvent:()=>ContactStartEvent,DeactivateEvent:()=>DeactivateEvent,EnterTriggerEvent:()=>EnterTriggerEvent,EnterViewPortEvent:()=>EnterViewPortEvent,EventTypes:()=>EventTypes,ExitTriggerEvent:()=>ExitTriggerEvent,ExitViewPortEvent:()=>ExitViewPortEvent,GameEvent:()=>GameEvent,GameStartEvent:()=>GameStartEvent,GameStopEvent:()=>GameStopEvent,GamepadAxisEvent:()=>GamepadAxisEvent,GamepadButtonEvent:()=>GamepadButtonEvent,GamepadConnectEvent:()=>GamepadConnectEvent,GamepadDisconnectEvent:()=>GamepadDisconnectEvent,HiddenEvent:()=>HiddenEvent,InitializeEvent:()=>InitializeEvent,KillEvent:()=>KillEvent,PostCollisionEvent:()=>PostCollisionEvent,PostDebugDrawEvent:()=>PostDebugDrawEvent,PostDrawEvent:()=>PostDrawEvent,PostFrameEvent:()=>PostFrameEvent,PostKillEvent:()=>PostKillEvent,PostTransformDrawEvent:()=>PostTransformDrawEvent,PostUpdateEvent:()=>PostUpdateEvent,PreCollisionEvent:()=>PreCollisionEvent,PreDebugDrawEvent:()=>PreDebugDrawEvent,PreDrawEvent:()=>PreDrawEvent,PreFrameEvent:()=>PreFrameEvent,PreKillEvent:()=>PreKillEvent,PreTransformDrawEvent:()=>PreTransformDrawEvent,PreUpdateEvent:()=>PreUpdateEvent,RemoveEvent:()=>RemoveEvent,VisibleEvent:()=>VisibleEvent});var Util_Index_namespaceObject={};__webpack_require__.r(Util_Index_namespaceObject);__webpack_require__.d(Util_Index_namespaceObject,{ConsoleAppender:()=>ConsoleAppender,DrawUtil:()=>DrawUtil_namespaceObject,EasingFunctions:()=>EasingFunctions,LogLevel:()=>LogLevel,Logger:()=>Logger,Observable:()=>Observable,ScreenAppender:()=>ScreenAppender,addItemToArray:()=>addItemToArray,contains:()=>contains,delay:()=>delay,fail:()=>fail,getPosition:()=>getPosition,isObject:()=>isObject,mergeDeep:()=>mergeDeep,omit:()=>omit,removeItemFromArray:()=>removeItemFromArray});function polyfill(){if(typeof window>"u"&&(window={audioContext:function(){}}),typeof window<"u"&&!window.requestAnimationFrame&&(window.requestAnimationFrame=window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(fi){window.setInterval(fi,1e3/60)}),typeof window<"u"&&!window.cancelAnimationFrame&&(window.cancelAnimationFrame=window.webkitCancelAnimationFrame||window.mozCancelAnimationFrame||function(){}),typeof window<"u"&&!window.AudioContext){if(window.webkitAudioContext){const ci=window.webkitAudioContext.prototype.decodeAudioData;window.webkitAudioContext.prototype.decodeAudioData=function(hi){return new Promise((_i,pi)=>{ci.call(this,hi,_i,pi)})}}window.AudioContext=window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext}typeof window<"u"&&!window.devicePixelRatio&&(window.devicePixelRatio=window.devicePixelRatio||1),typeof window<"u"&&!window.requestIdleCallback&&(window.requestIdleCallback=window.requestIdleCallback||function(fi){const ci=Date.now();return setTimeout(function(){fi({didTimeout:!1,timeRemaining:function(){return Math.max(0,50-(Date.now()-ci))}})},1)},window.cancelIdleCallback=window.cancelIdleCallback||function(fi){clearTimeout(fi)})}class Flags{static useCanvasGraphicsContext(){Flags.enable("use-canvas-context")}static useLegacyImageRenderer(){Flags.enable("use-legacy-image-renderer")}static freeze(){Flags._FROZEN=!0}static _reset(){Flags._FROZEN=!1,Flags._FLAGS={}}static enable(ci){if(this._FROZEN)throw Error("Feature flags can only be enabled before Engine constructor time");Flags._FLAGS[ci]=!0}static disable(ci){if(this._FROZEN)throw Error("Feature flags can only be disabled before Engine constructor time");Flags._FLAGS[ci]=!1}static isEnabled(ci){return!!Flags._FLAGS[ci]}static show(){return Object.keys(Flags._FLAGS)}}Flags._FROZEN=!1;Flags._FLAGS={};function createId(fi,ci){return{type:fi,value:ci}}class Future{constructor(){this._isCompleted=!1,this.promise=new Promise((ci,hi)=>{this._resolver=ci,this._rejecter=hi})}get isCompleted(){return this._isCompleted}resolve(ci){this._isCompleted||(this._isCompleted=!0,this._resolver(ci))}reject(ci){this._isCompleted||(this._isCompleted=!0,this._rejecter(ci))}}class EventEmitter{constructor(){this._paused=!1,this._empty=!0,this._listeners={},this._listenersOnce={},this._pipes=[]}clear(){this._listeners={},this._listenersOnce={},this._pipes.length=0,this._empty=!0}on(ci,hi){var _i;return this._empty=!1,this._listeners[ci]=(_i=this._listeners[ci])!==null&&_i!==void 0?_i:[],this._listeners[ci].push(hi),{close:()=>this.off(ci,hi)}}once(ci,hi){var _i;return this._empty=!1,this._listenersOnce[ci]=(_i=this._listenersOnce[ci])!==null&&_i!==void 0?_i:[],this._listenersOnce[ci].push(hi),{close:()=>this.off(ci,hi)}}off(ci,hi){var _i,pi;if(hi){const mi=(_i=this._listeners[ci])===null||_i===void 0?void 0:_i.filter(vi=>vi!==hi);this._listeners[ci]=mi;const gi=(pi=this._listenersOnce[ci])===null||pi===void 0?void 0:pi.filter(vi=>vi!==hi);this._listenersOnce[ci]=gi}else delete this._listeners[ci]}emit(ci,hi){if(this._empty||this._paused)return;const _i=this._listeners[ci];if(_i)for(let mi=0;mi<_i.length;mi++)_i[mi](hi);const pi=this._listenersOnce[ci];if(this._listenersOnce[ci]=[],pi)for(let mi=0;mi<pi.length;mi++)pi[mi](hi);for(let mi=0;mi<this._pipes.length;mi++)this._pipes[mi].emit(ci,hi)}pipe(ci){if(this===ci)throw Error("Cannot pipe to self");return this._empty=!1,this._pipes.push(ci),{close:()=>{const hi=this._pipes.indexOf(ci);hi>-1&&this._pipes.splice(hi,1)}}}unpipe(ci){const hi=this._pipes.indexOf(ci);hi>-1&&this._pipes.splice(hi,1)}pause(){this._paused=!0}unpause(){this._paused=!1}}var PointerScope;(function(fi){fi.Canvas="Canvas",fi.Document="Document"})(PointerScope||(PointerScope={}));var RotationType;(function(fi){fi.ShortestPath="shortest-path",fi.LongestPath="longest-path",fi.Clockwise="clockwise",fi.CounterClockwise="counter-clockwise"})(RotationType||(RotationType={}));const BITMASK32=4294967295;class Random{constructor(ci){this.seed=ci,this._lowerMask=2147483647,this._upperMask=2147483648,this._w=32,this._n=624,this._m=397,this._a=2567483615,this._u=11,this._s=7,this._b=2636928640,this._t=15,this._c=4022730752,this._l=18,this._f=1812433253,this._mt=new Array(this._n),this._mt[0]=(ci||Date.now())>>>0;for(let hi=1;hi<this._n;hi++){const _i=this._mt[hi-1]^this._mt[hi-1]>>>this._w-2;this._mt[hi]=(this._f*((_i&4294901760)>>>16)<<16)+this._f*(_i&65535)+hi>>>0}this._index=this._n}_twist(){const ci=[0,this._a];let hi=0,_i=0;for(;_i<this._n-this._m;_i++)hi=this._mt[_i]&this._upperMask|this._mt[_i+1]&this._lowerMask,this._mt[_i]=this._mt[_i+this._m]^hi>>>1^ci[hi&1]&BITMASK32;for(;_i<this._n-1;_i++)hi=this._mt[_i]&this._upperMask|this._mt[_i+1]&this._lowerMask,this._mt[_i]=this._mt[_i+(this._m-this._n)]^hi>>>1^ci[hi&1]&BITMASK32;hi=this._mt[this._n-1]&this._upperMask|this._mt[0]&this._lowerMask,this._mt[this._n-1]=this._mt[this._m-1]^hi>>>1^ci[hi&1]&BITMASK32,this._index=0}nextInt(){this._index>=this._n&&this._twist();let ci=this._mt[this._index++];return ci^=ci>>>this._u,ci^=ci<<this._s&this._b,ci^=ci<<this._t&this._c,ci^=ci>>>this._l,ci>>>0}next(){return this.nextInt()*(1/4294967296)}floating(ci,hi){return(hi-ci)*this.next()+ci}integer(ci,hi){return Math.floor((hi-ci+1)*this.next()+ci)}bool(ci=.5){return this.next()<=ci}pickOne(ci){return ci[this.integer(0,ci.length-1)]}pickSet(ci,hi,_i=!1){return _i?this._pickSetWithDuplicates(ci,hi):this._pickSetWithoutDuplicates(ci,hi)}_pickSetWithoutDuplicates(ci,hi){if(hi>ci.length||hi<0)throw new Error("Invalid number of elements to pick, must pick a value 0 < n <= length");if(hi===ci.length)return ci;const _i=new Array(hi);let pi=0;const mi=ci.slice(0);for(;pi<hi;){const gi=this.integer(0,mi.length-1);_i[pi++]=mi[gi],mi.splice(gi,1)}return _i}_pickSetWithDuplicates(ci,hi){if(hi<0)throw new Error("Invalid number of elements to pick, must pick a value 0 <= n < MAX_INT");const _i=new Array(hi);for(let pi=0;pi<hi;pi++)_i[pi]=this.pickOne(ci);return _i}shuffle(ci){const hi=ci.slice(0);let _i;for(let pi=0;pi<hi.length-2;pi++){const mi=this.integer(pi,hi.length-1);_i=hi[pi],hi[pi]=hi[mi],hi[mi]=_i}return hi}range(ci,hi,_i){const pi=new Array(ci);for(let mi=0;mi<ci;mi++)pi[mi]=this.integer(hi,_i);return pi}d4(){return this.integer(1,4)}d6(){return this.integer(1,6)}d8(){return this.integer(1,8)}d10(){return this.integer(1,10)}d12(){return this.integer(1,12)}d20(){return this.integer(1,20)}}const TwoPI=Math.PI*2;function frac(fi){return fi>=0?fi-Math.floor(fi):fi-Math.ceil(fi)}function sign(fi){return fi===0?0:fi<0?-1:1}function clamp(fi,ci,hi){return Math.min(Math.max(ci,fi),hi)}function approximatelyEqual(fi,ci,hi){return Math.abs(fi-ci)<hi}function canonicalizeAngle(fi){let ci=fi;if(fi>=TwoPI)for(;ci>=TwoPI;)ci-=TwoPI;if(fi<0)for(;ci<0;)ci+=TwoPI;return ci}function toDegrees(fi){return 180/Math.PI*fi}function toRadians(fi){return fi/180*Math.PI}const range=(fi,ci)=>Array.from(new Array(ci-fi+1),(hi,_i)=>_i+fi);function randomInRange(fi,ci,hi=new Random){return hi?hi.floating(fi,ci):fi+Math.random()*(ci-fi)}function randomIntInRange(fi,ci,hi=new Random){return hi?hi.integer(fi,ci):Math.round(randomInRange(fi,ci))}class Vector{static get Zero(){return new Vector(0,0)}static get One(){return new Vector(1,1)}static get Half(){return new Vector(.5,.5)}static get Up(){return new Vector(0,-1)}static get Down(){return new Vector(0,1)}static get Left(){return new Vector(-1,0)}static get Right(){return new Vector(1,0)}static fromAngle(ci){return new Vector(Math.cos(ci),Math.sin(ci))}static isValid(ci){return!(ci==null||isNaN(ci.x)||isNaN(ci.y)||ci.x===1/0||ci.y===1/0||ci.x===-1/0||ci.y===-1/0)}static distance(ci,hi){return Math.sqrt(Math.pow(ci.x-hi.x,2)+Math.pow(ci.y-hi.y,2))}static min(ci,hi){return new Vector(Math.min(ci.x,hi.x),Math.min(ci.y,hi.y))}static max(ci,hi){return new Vector(Math.max(ci.x,hi.x),Math.max(ci.y,hi.y))}constructor(ci,hi){this._x=0,this._y=0,this._x=ci,this._y=hi}get x(){return this._x}set x(ci){this._x=ci}get y(){return this._y}set y(ci){this._y=ci}setTo(ci,hi){this.x=ci,this.y=hi}equals(ci,hi=Vector.EQUALS_EPSILON){return Math.abs(this.x-ci.x)<=hi&&Math.abs(this.y-ci.y)<=hi}distance(ci){if(!ci)return Math.sqrt(this.x*this.x+this.y*this.y);const hi=this.x-ci.x,_i=this.y-ci.y;return Math.sqrt(hi*hi+_i*_i)}squareDistance(ci){ci||(ci=Vector.Zero);const hi=this.x-ci.x,_i=this.y-ci.y;return hi*hi+_i*_i}clampMagnitude(ci){const hi=this.magnitude,_i=clamp(hi,0,ci);return this.magnitude=_i,this}get size(){return this.distance()}set size(ci){const hi=this.normalize().scale(ci);this.setTo(hi.x,hi.y)}get magnitude(){return this.distance()}set magnitude(ci){this.normalize().scale(ci,this)}normalize(){const ci=this.distance();return ci===0?Vector.Zero:new Vector(this.x/ci,this.y/ci)}average(ci){return this.add(ci).scale(.5)}scale(ci,hi){const _i=hi||new Vector(0,0);return ci instanceof Vector?(_i.x=this.x*ci.x,_i.y=this.y*ci.y):(_i.x=this.x*ci,_i.y=this.y*ci),_i}add(ci,hi){return hi?(hi.x=this.x+ci.x,hi.y=this.y+ci.y,hi):new Vector(this.x+ci.x,this.y+ci.y)}sub(ci,hi){const _i=hi||new Vector(0,0),pi=this.x-ci.x,mi=this.y-ci.y;return _i.x=pi,_i.y=mi,_i}addEqual(ci){return this.setTo(this.x+ci.x,this.y+ci.y),this}subEqual(ci){return this.setTo(this.x-ci.x,this.y-ci.y),this}scaleEqual(ci){return this.setTo(this.x*ci,this.y*ci),this}dot(ci){return this.x*ci.x+this.y*ci.y}cross(ci){if(ci instanceof Vector)return this.x*ci.y-this.y*ci.x;if(typeof ci=="number")return new Vector(ci*this.y,-ci*this.x)}static cross(ci,hi){return new Vector(-ci*hi.y,ci*hi.x)}perpendicular(){return new Vector(this.y,-this.x)}normal(){return this.perpendicular().normalize()}negate(){return this.scale(-1)}toAngle(){return canonicalizeAngle(Math.atan2(this.y,this.x))}angleBetween(ci,hi){const _i=this.toAngle(),pi=canonicalizeAngle(ci);let mi=0,gi=0;switch(pi>_i?mi=pi-_i:mi=(TwoPI-_i+pi)%TwoPI,gi=(mi-TwoPI)%TwoPI,hi){case RotationType.ShortestPath:return Math.abs(mi)<Math.abs(gi)?mi:gi;case RotationType.LongestPath:return Math.abs(mi)>Math.abs(gi)?mi:gi;case RotationType.Clockwise:return mi;case RotationType.CounterClockwise:return gi}}rotate(ci,hi,_i){const pi=_i||new Vector(0,0);hi||(hi=new Vector(0,0));const mi=Math.sin(ci),gi=Math.cos(ci),vi=gi*(this.x-hi.x)-mi*(this.y-hi.y)+hi.x,xi=mi*(this.x-hi.x)+gi*(this.y-hi.y)+hi.y;return pi.x=vi,pi.y=xi,pi}clone(ci){const hi=ci??new Vector(0,0);return hi.x=this.x,hi.y=this.y,hi}toString(ci){return ci?`(${this.x.toFixed(ci)}, ${this.y.toFixed(ci)})`:`(${this.x}, ${this.y})`}}Vector.EQUALS_EPSILON=.001;function vec(fi,ci){return new Vector(fi,ci)}class Color{constructor(ci,hi,_i,pi){this.r=ci,this.g=hi,this.b=_i,this.a=pi??1}static fromRGB(ci,hi,_i,pi){return new Color(ci,hi,_i,pi)}static fromRGBString(ci){const hi=/^rgba?\((\d+),\s*(\d+),\s*(\d+)(?:,\s*(\d+(?:\.\d+)?))?\)/i;let _i=null;if(_i=ci.match(hi)){const pi=parseInt(_i[1],10),mi=parseInt(_i[2],10),gi=parseInt(_i[3],10);let vi=1;return _i[4]&&(vi=parseFloat(_i[4])),new Color(pi,mi,gi,vi)}else throw new Error("Invalid rgb/a string: "+ci)}static fromHex(ci){const hi=/^#?([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})([0-9a-f]{2})?$/i;let _i=null;if(_i=ci.match(hi)){const pi=parseInt(_i[1],16),mi=parseInt(_i[2],16),gi=parseInt(_i[3],16);let vi=1;return _i[4]&&(vi=parseInt(_i[4],16)/255),new Color(pi,mi,gi,vi)}else throw new Error("Invalid hex string: "+ci)}static fromHSL(ci,hi,_i,pi=1){return new HSLColor(ci,hi,_i,pi).toRGBA()}lighten(ci=.1){const hi=HSLColor.fromRGBA(this.r,this.g,this.b,this.a);return hi.l+=(1-hi.l)*ci,hi.toRGBA()}darken(ci=.1){const hi=HSLColor.fromRGBA(this.r,this.g,this.b,this.a);return hi.l-=hi.l*ci,hi.toRGBA()}saturate(ci=.1){const hi=HSLColor.fromRGBA(this.r,this.g,this.b,this.a);return hi.s+=hi.s*ci,hi.toRGBA()}desaturate(ci=.1){const hi=HSLColor.fromRGBA(this.r,this.g,this.b,this.a);return hi.s-=hi.s*ci,hi.toRGBA()}multiply(ci){const hi=ci.r/255*this.r/255*255,_i=ci.g/255*this.g/255*255,pi=ci.b/255*this.b/255*255,mi=ci.a*this.a;return new Color(hi,_i,pi,mi)}screen(ci){const hi=ci.invert(),_i=ci.invert();return hi.multiply(_i).invert()}invert(){return new Color(255-this.r,255-this.g,255-this.b,1-this.a)}average(ci){const hi=(ci.r+this.r)/2,_i=(ci.g+this.g)/2,pi=(ci.b+this.b)/2,mi=(ci.a+this.a)/2;return new Color(hi,_i,pi,mi)}equal(ci){return this.toString()===ci.toString()}toString(ci="rgb"){switch(ci){case"rgb":return this.toRGBA();case"hsl":return this.toHSLA();case"hex":return this.toHex();default:throw new Error("Invalid Color format")}}_componentToHex(ci){const hi=Math.max(Math.round(ci),0).toString(16);return hi.length===1?"0"+hi:hi}toHex(){let ci="#"+this._componentToHex(this.r)+this._componentToHex(this.g)+this._componentToHex(this.b);return this.a!==1&&(ci+=this._componentToHex(this.a*255)),ci}toRGBA(){const ci=String(this.r.toFixed(0))+", "+String(this.g.toFixed(0))+", "+String(this.b.toFixed(0));return this.a!==void 0||this.a!==null?"rgba("+ci+", "+String(this.a)+")":"rgb("+ci+")"}toHSLA(){return HSLColor.fromRGBA(this.r,this.g,this.b,this.a).toString()}fillStyle(){return this.toString()}clone(ci){const hi=ci||new Color(this.r,this.g,this.b,this.a);return hi.r=this.r,hi.g=this.g,hi.b=this.b,hi.a=this.a,hi}static get Black(){return Color.fromHex("#000000")}static get White(){return Color.fromHex("#FFFFFF")}static get Gray(){return Color.fromHex("#808080")}static get LightGray(){return Color.fromHex("#D3D3D3")}static get DarkGray(){return Color.fromHex("#A9A9A9")}static get Yellow(){return Color.fromHex("#FFFF00")}static get Orange(){return Color.fromHex("#FFA500")}static get Red(){return Color.fromHex("#FF0000")}static get Vermilion(){return Color.fromHex("#FF5B31")}static get Rose(){return Color.fromHex("#FF007F")}static get Pink(){return Color.fromHex("#FFC0CB")}static get Magenta(){return Color.fromHex("#FF00FF")}static get Violet(){return Color.fromHex("#7F00FF")}static get Purple(){return Color.fromHex("#800080")}static get Blue(){return Color.fromHex("#0000FF")}static get Azure(){return Color.fromHex("#007FFF")}static get Cyan(){return Color.fromHex("#00FFFF")}static get Viridian(){return Color.fromHex("#59978F")}static get Teal(){return Color.fromHex("#008080")}static get Green(){return Color.fromHex("#00FF00")}static get Chartreuse(){return Color.fromHex("#7FFF00")}static get Transparent(){return Color.fromHex("#FFFFFF00")}static get ExcaliburBlue(){return Color.fromHex("#176BAA")}static get Brown(){return Color.fromHex("#964B00")}}class HSLColor{constructor(ci,hi,_i,pi){this.h=ci,this.s=hi,this.l=_i,this.a=pi}static hue2rgb(ci,hi,_i){return _i<0&&(_i+=1),_i>1&&(_i-=1),_i<1/6?ci+(hi-ci)*6*_i:_i<1/2?hi:_i<2/3?ci+(hi-ci)*(2/3-_i)*6:ci}static fromRGBA(ci,hi,_i,pi){ci/=255,hi/=255,_i/=255;const mi=Math.max(ci,hi,_i),gi=Math.min(ci,hi,_i);let vi,xi;const wi=(mi+gi)/2;if(mi===gi)vi=xi=0;else{const yi=mi-gi;switch(xi=wi>.5?yi/(2-mi-gi):yi/(mi+gi),mi){case ci:vi=(hi-_i)/yi+(hi<_i?6:0);break;case hi:vi=(_i-ci)/yi+2;break;case _i:vi=(ci-hi)/yi+4;break}vi/=6}return new HSLColor(vi,xi,wi,pi)}toRGBA(){let ci,hi,_i;if(this.s===0)ci=hi=_i=this.l;else{const pi=this.l<.5?this.l*(1+this.s):this.l+this.s-this.l*this.s,mi=2*this.l-pi;ci=HSLColor.hue2rgb(mi,pi,this.h+1/3),hi=HSLColor.hue2rgb(mi,pi,this.h),_i=HSLColor.hue2rgb(mi,pi,this.h-1/3)}return new Color(ci*255,hi*255,_i*255,this.a)}toString(){const ci=this.h.toFixed(0),hi=this.s.toFixed(0),_i=this.l.toFixed(0),pi=this.a.toFixed(0);return`hsla(${ci}, ${hi}, ${_i}, ${pi})`}}var LogLevel;(function(fi){fi[fi.Debug=0]="Debug",fi[fi.Info=1]="Info",fi[fi.Warn=2]="Warn",fi[fi.Error=3]="Error",fi[fi.Fatal=4]="Fatal"})(LogLevel||(LogLevel={}));class Logger{constructor(){if(this._appenders=[],this.defaultLevel=LogLevel.Info,this._logOnceSet=new Set,Logger._INSTANCE)throw new Error("Logger is a singleton");return Logger._INSTANCE=this,Logger._INSTANCE.addAppender(new ConsoleAppender),Logger._INSTANCE}static getInstance(){return Logger._INSTANCE==null&&(Logger._INSTANCE=new Logger),Logger._INSTANCE}addAppender(ci){this._appenders.push(ci)}clearAppenders(){this._appenders.length=0}_log(ci,hi){ci==null&&(ci=this.defaultLevel);const _i=this._appenders.length;for(let pi=0;pi<_i;pi++)ci>=this.defaultLevel&&this._appenders[pi].log(ci,hi)}_logOnce(ci,hi){const _i=ci+hi.join("+");this._logOnceSet.has(_i)||(this._logOnceSet.add(_i),this._log(ci,hi))}debug(...ci){this._log(LogLevel.Debug,ci)}debugOnce(...ci){this._logOnce(LogLevel.Debug,ci)}info(...ci){this._log(LogLevel.Info,ci)}infoOnce(...ci){this._logOnce(LogLevel.Info,ci)}warn(...ci){this._log(LogLevel.Warn,ci)}warnOnce(...ci){this._logOnce(LogLevel.Warn,ci)}error(...ci){this._log(LogLevel.Error,ci)}errorOnce(...ci){this._logOnce(LogLevel.Error,ci)}fatal(...ci){this._log(LogLevel.Fatal,ci)}fatalOnce(...ci){this._logOnce(LogLevel.Fatal,ci)}}Logger._INSTANCE=null;class ConsoleAppender{log(ci,hi){if(!console&&!console.log&&console.warn&&console.error)return;const _i=[];_i.unshift.apply(_i,hi),_i.unshift("["+LogLevel[ci]+"] : "),ci<LogLevel.Warn?console.log.apply?console.log.apply(console,_i):console.log(_i.join(" ")):ci<LogLevel.Error?console.warn.apply?console.warn.apply(console,_i):console.warn(_i.join(" ")):console.error.apply?console.error.apply(console,_i):console.error(_i.join(" "))}}class ScreenAppender{constructor(ci){var hi,_i;this._messages=[],this._pos=10,this._color=Color.Black,this._options=ci,this.canvas=document.createElement("canvas"),this._ctx=this.canvas.getContext("2d"),this.canvas.style.position="absolute",this.canvas.style.zIndex=(_i=(hi=ci.zIndex)===null||hi===void 0?void 0:hi.toString())!==null&&_i!==void 0?_i:"99",document.body.appendChild(this.canvas),this._positionScreenAppenderCanvas(),ci.engine.screen.events.on("resize",()=>{this._positionScreenAppenderCanvas()})}_positionScreenAppenderCanvas(){var ci,hi,_i,pi;const mi=this._options;this.canvas.width=(ci=mi.width)!==null&&ci!==void 0?ci:mi.engine.screen.resolution.width,this.canvas.height=(hi=mi.height)!==null&&hi!==void 0?hi:mi.engine.screen.resolution.height,this.canvas.style.position="absolute";const gi=mi.engine.screen.screenToPageCoordinates(vec(0,0));this.canvas.style.left=gi.x+"px",this.canvas.style.top=gi.y+"px",this._pos=(_i=mi.xPos)!==null&&_i!==void 0?_i:this._pos,this._color=(pi=mi.color)!==null&&pi!==void 0?pi:this._color}log(ci,hi){const _i=hi.join(",");this._ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this._messages.unshift("["+LogLevel[ci]+"] : "+_i);let pi=10;this._messages=this._messages.slice(0,1e3);for(let mi=0;mi<this._messages.length;mi++)this._ctx.fillStyle=this._color.toRGBA(),this._ctx.fillText(this._messages[mi],this._pos,pi),pi+=10}}var Side;(function(fi){fi.None="None",fi.Top="Top",fi.Bottom="Bottom",fi.Left="Left",fi.Right="Right"})(Side||(Side={}));(function(fi){function ci(_i){return _i===fi.Top?fi.Bottom:_i===fi.Bottom?fi.Top:_i===fi.Left?fi.Right:_i===fi.Right?fi.Left:fi.None}fi.getOpposite=ci;function hi(_i){return Math.abs(_i.x)>=Math.abs(_i.y)?_i.x<=0?fi.Left:fi.Right:_i.y<=0?fi.Top:fi.Bottom}fi.fromDirection=hi})(Side||(Side={}));class BoundingBox{constructor(ci=0,hi=0,_i=0,pi=0){this._points=[],typeof ci=="object"?(this.left=ci.left,this.top=ci.top,this.right=ci.right,this.bottom=ci.bottom):typeof ci=="number"&&(this.left=ci,this.top=hi,this.right=_i,this.bottom=pi)}clone(ci){const hi=ci||new BoundingBox(0,0,0,0);return hi.left=this.left,hi.right=this.right,hi.top=this.top,hi.bottom=this.bottom,hi}reset(){this.left=0,this.top=0,this.bottom=0,this.right=0}static getSideFromIntersection(ci){return ci&&ci?Math.abs(ci.x)>Math.abs(ci.y)?ci.x<0?Side.Right:Side.Left:ci.y<0?Side.Bottom:Side.Top:Side.None}static fromPoints(ci){let hi=1/0,_i=1/0,pi=-1/0,mi=-1/0;for(let gi=0;gi<ci.length;gi++)ci[gi].x<hi&&(hi=ci[gi].x),ci[gi].x>pi&&(pi=ci[gi].x),ci[gi].y<_i&&(_i=ci[gi].y),ci[gi].y>mi&&(mi=ci[gi].y);return new BoundingBox(hi,_i,pi,mi)}static fromDimension(ci,hi,_i=Vector.Half,pi=Vector.Zero){return new BoundingBox(-ci*_i.x+pi.x,-hi*_i.y+pi.y,ci-ci*_i.x+pi.x,hi-hi*_i.y+pi.y)}get width(){return this.right-this.left}get height(){return this.bottom-this.top}hasZeroDimensions(){return this.width===0||this.height===0}get center(){return new Vector((this.left+this.right)/2,(this.top+this.bottom)/2)}get topLeft(){return new Vector(this.left,this.top)}get bottomRight(){return new Vector(this.right,this.bottom)}get topRight(){return new Vector(this.right,this.top)}get bottomLeft(){return new Vector(this.left,this.bottom)}translate(ci){return new BoundingBox(this.left+ci.x,this.top+ci.y,this.right+ci.x,this.bottom+ci.y)}rotate(ci,hi=Vector.Zero){const _i=this.getPoints().map(pi=>pi.rotate(ci,hi));return BoundingBox.fromPoints(_i)}scale(ci,hi=Vector.Zero){const _i=this.translate(hi);return new BoundingBox(_i.left*ci.x,_i.top*ci.y,_i.right*ci.x,_i.bottom*ci.y)}transform(ci){const hi=ci.data[0]*this.left,_i=ci.data[1]*this.left,pi=ci.data[0]*this.right,mi=ci.data[1]*this.right,gi=ci.data[2]*this.top,vi=ci.data[3]*this.top,xi=ci.data[2]*this.bottom,wi=ci.data[3]*this.bottom,yi=ci.getPosition(),Ci=Math.min(hi,pi)+Math.min(gi,xi)+yi.x,Ei=Math.min(_i,mi)+Math.min(vi,wi)+yi.y,Si=Math.max(hi,pi)+Math.max(gi,xi)+yi.x,ki=Math.max(_i,mi)+Math.max(vi,wi)+yi.y;return new BoundingBox({left:Ci,top:Ei,right:Si,bottom:ki})}getPerimeter(){const ci=this.width,hi=this.height;return 2*(ci+hi)}getPoints(){return(this._left!==this.left||this._right!==this.right||this._top!==this.top||this._bottom!==this.bottom)&&(this._points.length=0,this._points.push(new Vector(this.left,this.top)),this._points.push(new Vector(this.right,this.top)),this._points.push(new Vector(this.right,this.bottom)),this._points.push(new Vector(this.left,this.bottom)),this._left=this.left,this._right=this.right,this._top=this.top,this._bottom=this.bottom),this._points}rayCast(ci,hi=1/0){let _i=-1/0,pi=1/0;const mi=ci.dir.x===0?Number.MAX_VALUE:1/ci.dir.x,gi=ci.dir.y===0?Number.MAX_VALUE:1/ci.dir.y,vi=(this.left-ci.pos.x)*mi,xi=(this.right-ci.pos.x)*mi;_i=Math.min(vi,xi),pi=Math.max(vi,xi);const wi=(this.top-ci.pos.y)*gi,yi=(this.bottom-ci.pos.y)*gi;return _i=Math.max(_i,Math.min(wi,yi)),pi=Math.min(pi,Math.max(wi,yi)),pi>=Math.max(0,_i)&&_i<hi}rayCastTime(ci,hi=1/0){let _i=-1/0,pi=1/0;const mi=ci.dir.x===0?Number.MAX_VALUE:1/ci.dir.x,gi=ci.dir.y===0?Number.MAX_VALUE:1/ci.dir.y,vi=(this.left-ci.pos.x)*mi,xi=(this.right-ci.pos.x)*mi;_i=Math.min(vi,xi),pi=Math.max(vi,xi);const wi=(this.top-ci.pos.y)*gi,yi=(this.bottom-ci.pos.y)*gi;return _i=Math.max(_i,Math.min(wi,yi)),pi=Math.min(pi,Math.max(wi,yi)),pi>=Math.max(0,_i)&&_i<hi?_i:-1}contains(ci){return ci instanceof Vector?this.left<=ci.x&&this.top<=ci.y&&ci.y<=this.bottom&&ci.x<=this.right:ci instanceof BoundingBox?this.left<=ci.left&&this.top<=ci.top&&ci.bottom<=this.bottom&&ci.right<=this.right:!1}combine(ci,hi){const _i=hi||new BoundingBox(0,0,0,0),pi=Math.min(this.left,ci.left),mi=Math.min(this.top,ci.top),gi=Math.max(this.right,ci.right),vi=Math.max(this.bottom,ci.bottom);return _i.left=pi,_i.top=mi,_i.right=gi,_i.bottom=vi,_i}get dimensions(){return new Vector(this.width,this.height)}overlaps(ci,hi){const _i=hi||0;if(ci.hasZeroDimensions())return this.contains(ci);if(this.hasZeroDimensions())return ci.contains(this);const pi=this.combine(ci);return pi.width+_i<ci.width+this.width&&pi.height+_i<ci.height+this.height}intersect(ci){const hi=this.combine(ci);if(hi.width<ci.width+this.width&&hi.height<ci.height+this.height&&!hi.dimensions.equals(ci.dimensions)&&!hi.dimensions.equals(this.dimensions)){let _i=0;this.right>=ci.left&&this.right<=ci.right?_i=ci.left-this.right:_i=ci.right-this.left;let pi=0;return this.top<=ci.bottom&&this.top>=ci.top?pi=ci.bottom-this.top:pi=ci.top-this.bottom,Math.abs(_i)<Math.abs(pi)?new Vector(_i,0):new Vector(0,pi)}else if(hi.dimensions.equals(ci.dimensions)||hi.dimensions.equals(this.dimensions)){let _i=0;this.width-ci.width>=0?this.right-ci.right<=ci.left-this.left?_i=ci.left-this.right:_i=ci.right-this.left:ci.right-this.right<=this.left-ci.left?_i=this.left-ci.right:_i=this.right-ci.left;let pi=0;return this.height-ci.height>=0?this.bottom-ci.bottom<=ci.top-this.top?pi=ci.top-this.bottom:pi=ci.bottom-this.top:ci.bottom-this.bottom<=this.top-ci.top?pi=this.top-ci.bottom:pi=this.bottom-ci.top,Math.abs(_i)<Math.abs(pi)?new Vector(_i,0):new Vector(0,pi)}else return null}intersectWithSide(ci){const hi=this.intersect(ci);return BoundingBox.getSideFromIntersection(hi)}draw(ci,hi=Color.Yellow){ci.debug.drawRect(this.left,this.top,this.width,this.height,{color:hi})}}function getPosition(fi){if(fi&&fi.getBoundingClientRect){const ci=fi.getBoundingClientRect();return vec(ci.x+window.scrollX,ci.y+window.scrollY)}return Vector.Zero}function addItemToArray(fi,ci){return ci.indexOf(fi)===-1?(ci.push(fi),!0):!1}function removeItemFromArray(fi,ci){let hi=-1;return(hi=ci.indexOf(fi))>-1?(ci.splice(hi,1),!0):!1}function contains(fi,ci){for(let hi=0;hi<fi.length;hi++)if(fi[hi]===ci)return!0;return!1}function fail(fi){throw new Error(fi)}function delay(fi,ci){var hi;const _i=new Future;return((hi=ci==null?void 0:ci.schedule.bind(ci))!==null&&hi!==void 0?hi:setTimeout)(()=>{_i.resolve()},fi),_i.promise}function omit(fi,ci){const hi={};for(const _i in fi)ci.includes(_i)||(hi[_i]=fi[_i]);return hi}function isObject(fi){return fi&&typeof fi=="object"&&!Array.isArray(fi)}function mergeDeep(fi,...ci){if(!ci.length)return fi;const hi=ci.shift();if(isObject(fi)&&isObject(hi))for(const _i in hi)isObject(hi[_i])?(fi[_i]||Object.assign(fi,{[_i]:{}}),mergeDeep(fi[_i],hi[_i])):Object.assign(fi,{[_i]:hi[_i]});return mergeDeep(fi,...ci)}var MatrixLocations;(function(fi){fi[fi.X=12]="X",fi[fi.Y=13]="Y"})(MatrixLocations||(MatrixLocations={}));class Matrix{constructor(){this.data=new Float32Array(16),this._scaleX=1,this._scaleSignX=1,this._scaleY=1,this._scaleSignY=1}static ortho(ci,hi,_i,pi,mi,gi){const vi=new Matrix;return vi.data[0]=2/(hi-ci),vi.data[1]=0,vi.data[2]=0,vi.data[3]=0,vi.data[4]=0,vi.data[5]=2/(pi-_i),vi.data[6]=0,vi.data[7]=0,vi.data[8]=0,vi.data[9]=0,vi.data[10]=-2/(gi-mi),vi.data[11]=0,vi.data[12]=-(hi+ci)/(hi-ci),vi.data[13]=-(pi+_i)/(pi-_i),vi.data[14]=-(gi+mi)/(gi-mi),vi.data[15]=1,vi}clone(ci){const hi=ci||new Matrix;return hi.data[0]=this.data[0],hi.data[1]=this.data[1],hi.data[2]=this.data[2],hi.data[3]=this.data[3],hi.data[4]=this.data[4],hi.data[5]=this.data[5],hi.data[6]=this.data[6],hi.data[7]=this.data[7],hi.data[8]=this.data[8],hi.data[9]=this.data[9],hi.data[10]=this.data[10],hi.data[11]=this.data[11],hi.data[12]=this.data[12],hi.data[13]=this.data[13],hi.data[14]=this.data[14],hi.data[15]=this.data[15],hi}toDOMMatrix(){return new DOMMatrix([...this.data])}static fromFloat32Array(ci){const hi=new Matrix;return hi.data=ci,hi}static identity(){const ci=new Matrix;return ci.data[0]=1,ci.data[1]=0,ci.data[2]=0,ci.data[3]=0,ci.data[4]=0,ci.data[5]=1,ci.data[6]=0,ci.data[7]=0,ci.data[8]=0,ci.data[9]=0,ci.data[10]=1,ci.data[11]=0,ci.data[12]=0,ci.data[13]=0,ci.data[14]=0,ci.data[15]=1,ci}reset(){const ci=this;return ci.data[0]=1,ci.data[1]=0,ci.data[2]=0,ci.data[3]=0,ci.data[4]=0,ci.data[5]=1,ci.data[6]=0,ci.data[7]=0,ci.data[8]=0,ci.data[9]=0,ci.data[10]=1,ci.data[11]=0,ci.data[12]=0,ci.data[13]=0,ci.data[14]=0,ci.data[15]=1,ci}static translation(ci,hi){const _i=Matrix.identity();return _i.data[12]=ci,_i.data[13]=hi,_i}static scale(ci,hi){const _i=Matrix.identity();return _i.data[0]=ci,_i.data[5]=hi,_i.data[10]=1,_i.data[15]=1,_i}static rotation(ci){const hi=Matrix.identity();return hi.data[0]=Math.cos(ci),hi.data[4]=-Math.sin(ci),hi.data[1]=Math.sin(ci),hi.data[5]=Math.cos(ci),hi}multiply(ci,hi){if(ci instanceof Vector){const _i=hi||new Vector(0,0),pi=ci,mi=pi.x*this.data[0]+pi.y*this.data[4]+this.data[12],gi=pi.x*this.data[1]+pi.y*this.data[5]+this.data[13];return _i.x=mi,_i.y=gi,_i}else{const _i=hi||new Matrix,pi=ci,mi=this.data[0],gi=this.data[1],vi=this.data[2],xi=this.data[3],wi=this.data[4],yi=this.data[5],Ci=this.data[6],Ei=this.data[7],Si=this.data[8],ki=this.data[9],Ai=this.data[10],Ii=this.data[11],Ti=this.data[12],Pi=this.data[13],Li=this.data[14],Ri=this.data[15],Di=pi.data[0],Fi=pi.data[1],Mi=pi.data[2],$i=pi.data[3],Oi=pi.data[4],Gi=pi.data[5],Ui=pi.data[6],zi=pi.data[7],Wi=pi.data[8],Ni=pi.data[9],Hi=pi.data[10],ji=pi.data[11],Bi=pi.data[12],Ji=pi.data[13],Ki=pi.data[14],Vi=pi.data[15];_i.data[0]=mi*Di+wi*Fi+Si*Mi+Ti*$i,_i.data[1]=gi*Di+yi*Fi+ki*Mi+Pi*$i,_i.data[2]=vi*Di+Ci*Fi+Ai*Mi+Li*$i,_i.data[3]=xi*Di+Ei*Fi+Ii*Mi+Ri*$i,_i.data[4]=mi*Oi+wi*Gi+Si*Ui+Ti*zi,_i.data[5]=gi*Oi+yi*Gi+ki*Ui+Pi*zi,_i.data[6]=vi*Oi+Ci*Gi+Ai*Ui+Li*zi,_i.data[7]=xi*Oi+Ei*Gi+Ii*Ui+Ri*zi,_i.data[8]=mi*Wi+wi*Ni+Si*Hi+Ti*ji,_i.data[9]=gi*Wi+yi*Ni+ki*Hi+Pi*ji,_i.data[10]=vi*Wi+Ci*Ni+Ai*Hi+Li*ji,_i.data[11]=xi*Wi+Ei*Ni+Ii*Hi+Ri*ji,_i.data[12]=mi*Bi+wi*Ji+Si*Ki+Ti*Vi,_i.data[13]=gi*Bi+yi*Ji+ki*Ki+Pi*Vi,_i.data[14]=vi*Bi+Ci*Ji+Ai*Ki+Li*Vi,_i.data[15]=xi*Bi+Ei*Ji+Ii*Ki+Ri*Vi;const qi=this.getScale();return _i._scaleSignX=sign(qi.x)*sign(_i._scaleSignX),_i._scaleSignY=sign(qi.y)*sign(_i._scaleSignY),_i}}translate(ci,hi){const _i=this.data[0],pi=this.data[1],mi=this.data[2],gi=this.data[3],vi=this.data[4],xi=this.data[5],wi=this.data[6],yi=this.data[7],Ci=this.data[8],Ei=this.data[9],Si=this.data[10],ki=this.data[11],Ai=this.data[12],Ii=this.data[13],Ti=this.data[14],Pi=this.data[15],Li=0,Ri=1;return this.data[12]=_i*ci+vi*hi+Ci*Li+Ai*Ri,this.data[13]=pi*ci+xi*hi+Ei*Li+Ii*Ri,this.data[14]=mi*ci+wi*hi+Si*Li+Ti*Ri,this.data[15]=gi*ci+yi*hi+ki*Li+Pi*Ri,this}setPosition(ci,hi){this.data[12]=ci,this.data[13]=hi}getPosition(){return vec(this.data[12],this.data[13])}rotate(ci){const hi=this.data[0],_i=this.data[1],pi=this.data[2],mi=this.data[3],gi=this.data[4],vi=this.data[5],xi=this.data[6],wi=this.data[7],yi=Math.sin(ci),Ci=Math.cos(ci);return this.data[0]=Ci*hi+yi*gi,this.data[1]=Ci*_i+yi*vi,this.data[2]=Ci*pi+yi*xi,this.data[3]=Ci*mi+yi*wi,this.data[4]=Ci*gi-yi*hi,this.data[5]=Ci*vi-yi*_i,this.data[6]=Ci*xi-yi*pi,this.data[7]=Ci*wi-yi*mi,this}scale(ci,hi){const _i=this.data[0],pi=this.data[1],mi=this.data[2],gi=this.data[3],vi=this.data[4],xi=this.data[5],wi=this.data[6],yi=this.data[7];return this.data[0]=_i*ci,this.data[1]=pi*ci,this.data[2]=mi*ci,this.data[3]=gi*ci,this.data[4]=vi*hi,this.data[5]=xi*hi,this.data[6]=wi*hi,this.data[7]=yi*hi,this}setRotation(ci){const hi=this.getScale(),_i=Math.sin(ci),pi=Math.cos(ci);this.data[0]=pi*hi.x,this.data[1]=_i*hi.y,this.data[4]=-_i*hi.x,this.data[5]=pi*hi.y}getRotation(){const ci=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return canonicalizeAngle(ci)}getScaleX(){const ci=vec(this.data[0],this.data[4]).magnitude;return this._scaleSignX*ci}getScaleY(){const ci=vec(this.data[1],this.data[5]).magnitude;return this._scaleSignY*ci}getScale(){return vec(this.getScaleX(),this.getScaleY())}setScaleX(ci){if(this._scaleX===ci)return;this._scaleSignX=sign(ci);const hi=vec(this.data[0]*this._scaleSignX,this.data[4]*this._scaleSignX).normalize();this.data[0]=hi.x*ci,this.data[4]=hi.y*ci,this._scaleX=ci}setScaleY(ci){if(this._scaleY===ci)return;this._scaleSignY=sign(ci);const hi=vec(this.data[1]*this._scaleSignY,this.data[5]*this._scaleSignY).normalize();this.data[1]=hi.x*ci,this.data[5]=hi.y*ci,this._scaleY=ci}setScale(ci){this.setScaleX(ci.x),this.setScaleY(ci.y)}getBasisDeterminant(){return this.data[0]*this.data[5]-this.data[1]*this.data[4]}getAffineInverse(ci){const _i=1/this.getBasisDeterminant(),pi=this.data[0],mi=this.data[4],gi=this.data[1],vi=this.data[5],xi=ci||Matrix.identity();xi.data[0]=vi*_i,xi.data[1]=-gi*_i,xi.data[4]=-mi*_i,xi.data[5]=pi*_i;const wi=this.data[12],yi=this.data[13];return xi.data[12]=-(wi*xi.data[0]+yi*xi.data[4]),xi.data[13]=-(wi*xi.data[1]+yi*xi.data[5]),xi}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===0&&this.data[4]===0&&this.data[5]===1&&this.data[6]===0&&this.data[7]===0&&this.data[8]===0&&this.data[9]===0&&this.data[10]===1&&this.data[11]===0&&this.data[12]===0&&this.data[13]===0&&this.data[14]===0&&this.data[15]===1}toString(){return`
[${this.data[0]} ${this.data[4]} ${this.data[8]} ${this.data[12]}]
[${this.data[1]} ${this.data[5]} ${this.data[9]} ${this.data[13]}]
[${this.data[2]} ${this.data[6]} ${this.data[10]} ${this.data[14]}]
[${this.data[3]} ${this.data[7]} ${this.data[11]} ${this.data[15]}]
`}}class AffineMatrix{constructor(){this.data=new Float64Array(6),this._scale=new Float64Array([1,1]),this._scaleSignX=1,this._scaleSignY=1}toDOMMatrix(){return new DOMMatrix([...this.data])}static identity(){const ci=new AffineMatrix;return ci.data[0]=1,ci.data[1]=0,ci.data[2]=0,ci.data[3]=1,ci.data[4]=0,ci.data[5]=0,ci}static translation(ci,hi){const _i=AffineMatrix.identity();return _i.data[4]=ci,_i.data[5]=hi,_i}static scale(ci,hi){const _i=AffineMatrix.identity();return _i.data[0]=ci,_i.data[3]=hi,_i._scale[0]=ci,_i._scale[1]=hi,_i}static rotation(ci){const hi=AffineMatrix.identity();return hi.data[0]=Math.cos(ci),hi.data[1]=Math.sin(ci),hi.data[2]=-Math.sin(ci),hi.data[3]=Math.cos(ci),hi}setPosition(ci,hi){this.data[4]=ci,this.data[5]=hi}getPosition(){return vec(this.data[4],this.data[5])}rotate(ci){const hi=this.data[0],_i=this.data[1],pi=this.data[2],mi=this.data[3],gi=Math.sin(ci),vi=Math.cos(ci);return this.data[0]=vi*hi+gi*pi,this.data[1]=vi*_i+gi*mi,this.data[2]=vi*pi-gi*hi,this.data[3]=vi*mi-gi*_i,this}translate(ci,hi){const _i=this.data[0],pi=this.data[1],mi=this.data[2],gi=this.data[3],vi=this.data[4],xi=this.data[5];return this.data[4]=_i*ci+mi*hi+vi,this.data[5]=pi*ci+gi*hi+xi,this}scale(ci,hi){const _i=this.data[0],pi=this.data[1],mi=this.data[2],gi=this.data[3];return this.data[0]=_i*ci,this.data[1]=pi*ci,this.data[2]=mi*hi,this.data[3]=gi*hi,this._scale[0]=ci,this._scale[1]=hi,this._scaleSignX=sign(ci),this._scaleSignY=sign(hi),this}determinant(){return this.data[0]*this.data[3]-this.data[1]*this.data[2]}inverse(ci){const hi=this.determinant();let _i=hi;hi!==0&&(_i=1/hi);const pi=this.data[0],mi=this.data[2],gi=this.data[1],vi=this.data[3],xi=ci||AffineMatrix.identity();xi.data[0]=vi*_i,xi.data[1]=-gi*_i,xi.data[2]=-mi*_i,xi.data[3]=pi*_i;const wi=this.data[4],yi=this.data[5];return xi.data[4]=-(wi*xi.data[0]+yi*xi.data[2]),xi.data[5]=-(wi*xi.data[1]+yi*xi.data[3]),xi}multiply(ci,hi){if(ci instanceof Vector){const _i=hi||new Vector(0,0),pi=ci,mi=pi.x*this.data[0]+pi.y*this.data[2]+this.data[4],gi=pi.x*this.data[1]+pi.y*this.data[3]+this.data[5];return _i.x=mi,_i.y=gi,_i}else{const _i=hi||new AffineMatrix,pi=ci,mi=this.data[0],gi=this.data[1],vi=this.data[2],xi=this.data[3],wi=this.data[4],yi=this.data[5],Ci=pi.data[0],Ei=pi.data[1],Si=pi.data[2],ki=pi.data[3],Ai=pi.data[4],Ii=pi.data[5];_i.data[0]=mi*Ci+vi*Ei,_i.data[1]=gi*Ci+xi*Ei,_i.data[2]=mi*Si+vi*ki,_i.data[3]=gi*Si+xi*ki,_i.data[4]=mi*Ai+vi*Ii+wi,_i.data[5]=gi*Ai+xi*Ii+yi;const Ti=this._scaleSignX,Pi=this._scaleSignY;return _i._scaleSignX=Ti*sign(_i._scaleSignX),_i._scaleSignY=Pi*sign(_i._scaleSignY),_i}}multiplyQuadInPlace(ci){const hi=ci[0]*this.data[0]+ci[1]*this.data[2]+this.data[4],_i=ci[0]*this.data[1]+ci[1]*this.data[3]+this.data[5];ci[0]=hi,ci[1]=_i;const pi=ci[2]*this.data[0]+ci[3]*this.data[2]+this.data[4],mi=ci[2]*this.data[1]+ci[3]*this.data[3]+this.data[5];ci[2]=pi,ci[3]=mi;const gi=ci[4]*this.data[0]+ci[5]*this.data[2]+this.data[4],vi=ci[4]*this.data[1]+ci[5]*this.data[3]+this.data[5];ci[4]=gi,ci[5]=vi;const xi=ci[6]*this.data[0]+ci[7]*this.data[2]+this.data[4],wi=ci[6]*this.data[1]+ci[7]*this.data[3]+this.data[5];ci[6]=xi,ci[7]=wi}to4x4(){const ci=new Matrix;return ci.data[0]=this.data[0],ci.data[1]=this.data[1],ci.data[2]=0,ci.data[3]=0,ci.data[4]=this.data[2],ci.data[5]=this.data[3],ci.data[6]=0,ci.data[7]=0,ci.data[8]=0,ci.data[9]=0,ci.data[10]=1,ci.data[11]=0,ci.data[12]=this.data[4],ci.data[13]=this.data[5],ci.data[14]=0,ci.data[15]=1,ci}setRotation(ci){const hi=this.getScale(),_i=Math.sin(ci),pi=Math.cos(ci);this.data[0]=pi*hi.x,this.data[1]=_i*hi.y,this.data[2]=-_i*hi.x,this.data[3]=pi*hi.y}getRotation(){const ci=Math.atan2(this.data[1]/this.getScaleY(),this.data[0]/this.getScaleX());return canonicalizeAngle(ci)}getScaleX(){const ci=this.data[0]*this.data[0]+this.data[2]*this.data[2];return ci===1?this._scaleSignX:this._scaleSignX*Math.sqrt(ci)}getScaleY(){const ci=this.data[1]*this.data[1]+this.data[3]*this.data[3];return ci===1?this._scaleSignY:this._scaleSignY*Math.sqrt(ci)}getScale(){return vec(this.getScaleX(),this.getScaleY())}setScaleX(ci){if(ci===this._scale[0])return;this._scaleSignX=sign(ci);const hi=vec(this.data[0]*this._scaleSignX,this.data[2]*this._scaleSignX).normalize();this.data[0]=hi.x*ci,this.data[2]=hi.y*ci,this._scale[0]=ci}setScaleY(ci){if(ci===this._scale[1])return;this._scaleSignY=sign(ci);const hi=vec(this.data[1]*this._scaleSignY,this.data[3]*this._scaleSignY).normalize();this.data[1]=hi.x*ci,this.data[3]=hi.y*ci,this._scale[1]=ci}setScale(ci){this.setScaleX(ci.x),this.setScaleY(ci.y)}isIdentity(){return this.data[0]===1&&this.data[1]===0&&this.data[2]===0&&this.data[3]===1&&this.data[4]===0&&this.data[5]===0}reset(){const ci=this;return ci.data[0]=1,ci.data[1]=0,ci.data[2]=0,ci.data[3]=1,ci.data[4]=0,ci.data[5]=0,ci}clone(ci){const hi=ci||new AffineMatrix;return hi.data[0]=this.data[0],hi.data[1]=this.data[1],hi.data[2]=this.data[2],hi.data[3]=this.data[3],hi.data[4]=this.data[4],hi.data[5]=this.data[5],hi._scaleSignX=this._scaleSignX,hi._scaleSignY=this._scaleSignY,hi}toString(){return`
[${this.data[0]} ${this.data[2]} ${this.data[4]}]
[${this.data[1]} ${this.data[3]} ${this.data[5]}]
[0 0 1]
`}}class RentalPool{constructor(ci,hi,_i=1){this.builder=ci,this.cleaner=hi,this._pool=[],this._size=0,this.grow(_i)}grow(ci){if(ci>0){this._size+=ci;for(let hi=0;hi<ci;hi++)this._pool.push(this.builder())}}rent(ci=!1){return this._pool.length===0&&this.grow(this._size),ci?this.cleaner(this._pool.pop()):this._pool.pop()}return(ci){this._pool.push(ci)}}class TransformStack{constructor(){this._pool=new RentalPool(()=>AffineMatrix.identity(),ci=>ci.reset(),100),this._transforms=[],this._currentTransform=this._pool.rent(!0)}save(){this._transforms.push(this._currentTransform),this._currentTransform=this._currentTransform.clone(this._pool.rent())}restore(){this._pool.return(this._currentTransform),this._currentTransform=this._transforms.pop()}translate(ci,hi){return this._currentTransform.translate(ci,hi)}rotate(ci){return this._currentTransform.rotate(ci)}scale(ci,hi){return this._currentTransform.scale(ci,hi)}reset(){this._currentTransform.reset()}set current(ci){this._currentTransform=ci}get current(){return this._currentTransform}}class ContextState{constructor(){this.opacity=1,this.z=0,this.tint=Color.White,this.material=null}}class StateStack{constructor(){this._pool=new RentalPool(()=>new ContextState,ci=>(ci.opacity=1,ci.z=0,ci.tint=Color.White,ci.material=null,ci),100),this.current=this._pool.rent(!0),this._states=[]}_cloneState(ci){var hi;return ci.opacity=this.current.opacity,ci.z=this.current.z,ci.tint=(hi=this.current.tint)===null||hi===void 0?void 0:hi.clone(),ci.material=this.current.material,ci}save(){this._states.push(this.current),this.current=this._cloneState(this._pool.rent())}restore(){this._pool.return(this.current),this.current=this._states.pop()}}const ResourceEvents={Complete:"complete",Load:"load",LoadStart:"loadstart",Progress:"progress",Error:"error"};class Resource{constructor(ci,hi,_i=!1){this.path=ci,this.responseType=hi,this.bustCache=_i,this.data=null,this.logger=Logger.getInstance(),this.events=new EventEmitter}isLoaded(){return this.data!==null}_cacheBust(ci){return/\?\w*=\w*/.test(ci)?ci+="&__="+Date.now():ci+="?__="+Date.now(),ci}load(){return new Promise((ci,hi)=>{if(this.data!==null){this.logger.debug("Already have data for resource",this.path),this.events.emit("complete",this.data),ci(this.data);return}const _i=new XMLHttpRequest;_i.open("GET",this.bustCache?this._cacheBust(this.path):this.path,!0),_i.responseType=this.responseType,_i.addEventListener("loadstart",pi=>this.events.emit("loadstart",pi)),_i.addEventListener("progress",pi=>this.events.emit("progress",pi)),_i.addEventListener("error",pi=>this.events.emit("error",pi)),_i.addEventListener("load",pi=>this.events.emit("load",pi)),_i.addEventListener("load",()=>{if(_i.status!==0&&_i.status!==200){this.logger.error("Failed to load resource ",this.path," server responded with error code",_i.status),this.events.emit("error",_i.response),hi(new Error(_i.statusText));return}if(_i.response instanceof Blob&&_i.response.type==="text/html"){const pi=`Expected blob (usually image) data from the server when loading ${this.path}, but got HTML content instead!

Check your server configuration, for example Vite serves static files from the /public folder`;this.events.emit("error",_i.response),hi(new Error(pi));return}this.data=_i.response,this.events.emit("complete",this.data),this.logger.debug("Completed loading resource",this.path),ci(this.data)}),_i.send()})}}function watch(fi,ci){return fi&&(fi.__isProxy===void 0?new Proxy(fi,{set:(hi,_i,pi)=>(hi[_i]!==pi&&(hi[_i]=pi,typeof _i=="string"&&_i[0]!=="_"&&ci(hi)),!0),get:(hi,_i)=>_i!=="__isProxy"?hi[_i]:!0}):fi)}const createHandler=(fi=[],ci,hi)=>({get:(_i,pi)=>pi==="__isProxy"?!0:typeof _i[pi]=="object"&&_i[pi]!=null?new Proxy(_i[pi],createHandler([...fi,pi],ci,hi)):_i[pi],set:(_i,pi,mi)=>(typeof pi=="string"&&pi[0]!=="_"&&ci(hi),_i[pi]=mi,!0)});function watchDeep(fi,ci){return fi&&(fi.__isProxy===void 0?new Proxy(fi,createHandler([],ci,fi)):fi)}class Graphic{isStale(){return this._transformStale}get flipHorizontal(){return this._flipHorizontal}set flipHorizontal(ci){this._flipHorizontal=ci,this._transformStale=!0}get flipVertical(){return this._flipVertical}set flipVertical(ci){this._flipVertical=ci,this._transformStale=!0}get rotation(){return this._rotation}set rotation(ci){this._rotation=ci,this._transformStale=!0}get scale(){return this._scale}set scale(ci){this._scale=watch(ci,()=>{this._transformStale=!0}),this._transformStale=!0}get origin(){return this._origin}set origin(ci){ci&&(this._origin=watch(ci,()=>{this._transformStale=!0})),this._transformStale=!0}constructor(ci){var hi,_i,pi,mi,gi,vi,xi;this.id=Graphic._ID++,this.transform=AffineMatrix.identity(),this._transformStale=!0,this.showDebug=!1,this._flipHorizontal=!1,this._flipVertical=!1,this._rotation=0,this.opacity=1,this._scale=Vector.One,this._width=0,this._height=0,ci&&(this.origin=(hi=ci.origin)!==null&&hi!==void 0?hi:this.origin,this.flipHorizontal=(_i=ci.flipHorizontal)!==null&&_i!==void 0?_i:this.flipHorizontal,this.flipVertical=(pi=ci.flipVertical)!==null&&pi!==void 0?pi:this.flipVertical,this.rotation=(mi=ci.rotation)!==null&&mi!==void 0?mi:this.rotation,this.opacity=(gi=ci.opacity)!==null&&gi!==void 0?gi:this.opacity,this.scale=(vi=ci.scale)!==null&&vi!==void 0?vi:this.scale,this.tint=(xi=ci.tint)!==null&&xi!==void 0?xi:this.tint,ci.width&&(this._width=ci.width),ci.height&&(this._height=ci.height))}cloneGraphicOptions(){return{width:this.width/this.scale.x,height:this.height/this.scale.y,origin:this.origin?this.origin.clone():void 0,flipHorizontal:this.flipHorizontal,flipVertical:this.flipVertical,rotation:this.rotation,opacity:this.opacity,scale:this.scale?this.scale.clone():void 0,tint:this.tint?this.tint.clone():void 0}}get width(){return Math.abs(this._width*this.scale.x)}get height(){return Math.abs(this._height*this.scale.y)}set width(ci){this._width=ci,this._transformStale=!0}set height(ci){this._height=ci,this._transformStale=!0}get localBounds(){return BoundingBox.fromDimension(this.width,this.height,Vector.Zero)}draw(ci,hi,_i){this._preDraw(ci,hi,_i),this._drawImage(ci,0,0),this._postDraw(ci)}_preDraw(ci,hi,_i){ci.save(),ci.translate(hi,_i),this._transformStale&&(this.transform.reset(),this.transform.scale(Math.abs(this.scale.x),Math.abs(this.scale.y)),this._rotate(this.transform),this._flip(this.transform),this._transformStale=!1),ci.multiply(this.transform),ci.opacity=ci.opacity*this.opacity,this.tint&&(ci.tint=this.tint)}_rotate(ci){var hi;const _i=this.scale.x>0?1:-1,pi=this.scale.y>0?1:-1,mi=(hi=this.origin)!==null&&hi!==void 0?hi:vec(this.width/2,this.height/2);ci.translate(mi.x,mi.y),ci.rotate(this.rotation),ci.scale(_i,pi),ci.translate(-mi.x,-mi.y)}_flip(ci){this.flipHorizontal&&(ci.translate(this.width/this.scale.x,0),ci.scale(-1,1)),this.flipVertical&&(ci.translate(0,this.height/this.scale.y),ci.scale(1,-1))}_postDraw(ci){this.showDebug&&ci.debug.drawRect(0,0,this.width,this.height),ci.restore()}}Graphic._ID=0;class Sprite extends Graphic{static from(ci,hi){return new Sprite({image:ci,...hi})}constructor(ci){var hi,_i;super(ci),this._logger=Logger.getInstance(),this._dirty=!0,this.image=ci.image;const{width:pi,height:mi}=ci;this.sourceView=(hi=ci.sourceView)!==null&&hi!==void 0?hi:{x:0,y:0,width:pi??0,height:mi??0},this.destSize=(_i=ci.destSize)!==null&&_i!==void 0?_i:{width:pi??0,height:mi??0},this._updateSpriteDimensions(),this.image.ready.then(()=>{this._updateSpriteDimensions()})}get width(){return Math.abs(this.destSize.width*this.scale.x)}get height(){return Math.abs(this.destSize.height*this.scale.y)}set width(ci){ci/=Math.abs(this.scale.x),this.destSize.width=ci,super.width=Math.ceil(this.destSize.width)}set height(ci){ci/=Math.abs(this.scale.y),this.destSize.height=ci,super.height=Math.ceil(this.destSize.height)}_updateSpriteDimensions(){var ci,hi,_i,pi,mi,gi;const{width:vi,height:xi}=this.image;this.sourceView.width=((ci=this.sourceView)===null||ci===void 0?void 0:ci.width)||vi,this.sourceView.height=((hi=this.sourceView)===null||hi===void 0?void 0:hi.height)||xi,this.destSize.width=((_i=this.destSize)===null||_i===void 0?void 0:_i.width)||((pi=this.sourceView)===null||pi===void 0?void 0:pi.width)||vi,this.destSize.height=((mi=this.destSize)===null||mi===void 0?void 0:mi.height)||((gi=this.sourceView)===null||gi===void 0?void 0:gi.height)||xi,this.width=Math.ceil(this.destSize.width)*this.scale.x,this.height=Math.ceil(this.destSize.height)*this.scale.y}_preDraw(ci,hi,_i){this.image.isLoaded()&&this._dirty&&(this._dirty=!1,this._updateSpriteDimensions()),super._preDraw(ci,hi,_i)}_drawImage(ci,hi,_i){this.image.isLoaded()?ci.drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,hi,_i,this.destSize.width,this.destSize.height):this._logger.warnOnce(`ImageSource ${this.image.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}clone(){return new Sprite({image:this.image,sourceView:{...this.sourceView},destSize:{...this.destSize},...this.cloneGraphicOptions()})}}var ImageFiltering;(function(fi){fi.Pixel="Pixel",fi.Blended="Blended"})(ImageFiltering||(ImageFiltering={}));function parseImageFiltering(fi){switch(fi){case ImageFiltering.Pixel:return ImageFiltering.Pixel;case ImageFiltering.Blended:return ImageFiltering.Blended;default:return}}var ImageWrapping;(function(fi){fi.Clamp="Clamp",fi.Repeat="Repeat",fi.Mirror="Mirror"})(ImageWrapping||(ImageWrapping={}));function parseImageWrapping(fi){switch(fi){case ImageWrapping.Clamp:return ImageWrapping.Clamp;case ImageWrapping.Repeat:return ImageWrapping.Repeat;case ImageWrapping.Mirror:return ImageWrapping.Mirror;default:return ImageWrapping.Clamp}}class TextureLoader{constructor(ci,hi){var _i;this._garbageCollector=hi,this._textureMap=new Map,this._collect=pi=>{var mi;if(this._gl){const gi=(mi=pi.dataset.originalSrc)!==null&&mi!==void 0?mi:pi.constructor.name;return TextureLoader._LOGGER.debug(`WebGL Texture for ${gi} collected`),this.delete(pi),!0}return!1},this._gl=ci,TextureLoader._MAX_TEXTURE_SIZE=ci.getParameter(ci.MAX_TEXTURE_SIZE),this._garbageCollector&&(TextureLoader._LOGGER.debug("WebGL Texture collection interval:",this._garbageCollector.collectionInterval),(_i=this._garbageCollector.garbageCollector)===null||_i===void 0||_i.registerCollector("texture",this._garbageCollector.collectionInterval,this._collect))}dispose(){for(const[ci]of this._textureMap)this.delete(ci);this._textureMap.clear(),this._gl=null}get(ci){return this._textureMap.get(ci)}has(ci){return this._textureMap.has(ci)}load(ci,hi,_i=!1){var pi,mi;const gi=this._gl;if(!gi)return null;const{filtering:vi,wrapping:xi}={...hi};let wi=null;if(this.has(ci)&&(wi=this.get(ci)),wi)return _i&&(gi.bindTexture(gi.TEXTURE_2D,wi),gi.texImage2D(gi.TEXTURE_2D,0,gi.RGBA,gi.RGBA,gi.UNSIGNED_BYTE,ci)),(pi=this._garbageCollector)===null||pi===void 0||pi.garbageCollector.touch(ci),wi;wi=gi.createTexture(),TextureLoader.checkImageSizeSupportedAndLog(ci),gi.bindTexture(gi.TEXTURE_2D,wi),gi.pixelStorei(gi.UNPACK_PREMULTIPLY_ALPHA_WEBGL,!0);let yi;xi&&(typeof xi=="string"?yi={x:xi,y:xi}:yi={x:xi.x,y:xi.y});const{x:Ci,y:Ei}=yi??TextureLoader.wrapping;switch(Ci){case ImageWrapping.Clamp:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_S,gi.CLAMP_TO_EDGE);break;case ImageWrapping.Repeat:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_S,gi.REPEAT);break;case ImageWrapping.Mirror:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_S,gi.MIRRORED_REPEAT);break;default:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_S,gi.CLAMP_TO_EDGE)}switch(Ei){case ImageWrapping.Clamp:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_T,gi.CLAMP_TO_EDGE);break;case ImageWrapping.Repeat:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_T,gi.REPEAT);break;case ImageWrapping.Mirror:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_T,gi.MIRRORED_REPEAT);break;default:gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_WRAP_T,gi.CLAMP_TO_EDGE)}const Si=vi??TextureLoader.filtering;return gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_MIN_FILTER,Si===ImageFiltering.Pixel?gi.NEAREST:gi.LINEAR),gi.texParameteri(gi.TEXTURE_2D,gi.TEXTURE_MAG_FILTER,Si===ImageFiltering.Pixel?gi.NEAREST:gi.LINEAR),gi.texImage2D(gi.TEXTURE_2D,0,gi.RGBA,gi.RGBA,gi.UNSIGNED_BYTE,ci),this._textureMap.set(ci,wi),(mi=this._garbageCollector)===null||mi===void 0||mi.garbageCollector.addCollectableResource("texture",ci),wi}delete(ci){const hi=this._gl;if(hi&&this.has(ci)){const _i=this.get(ci);_i&&(this._textureMap.delete(ci),hi.deleteTexture(_i))}}static checkImageSizeSupportedAndLog(ci){var hi;const _i=(hi=ci.dataset.originalSrc)!==null&&hi!==void 0?hi:"internal canvas bitmap";return ci.width>TextureLoader._MAX_TEXTURE_SIZE||ci.height>TextureLoader._MAX_TEXTURE_SIZE?(TextureLoader._LOGGER.error(`The image [${_i}] provided to Excalibur is too large for the device's maximum texture size of (${TextureLoader._MAX_TEXTURE_SIZE}x${TextureLoader._MAX_TEXTURE_SIZE}) please resize to an image for excalibur to render properly.

Images will likely render as black rectangles.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!1):((ci.width>4096||ci.height>4096)&&TextureLoader._LOGGER.warn(`The image [${_i}] provided to excalibur is too large may not work on all mobile devices, it is recommended you resize images to a maximum (4096x4096).

Images will likely render as black rectangles on some mobile platforms.

Read more here: https://developer.mozilla.org/en-US/docs/Web/API/WebGL_API/WebGL_best_practices#understand_system_limits`),!0)}}TextureLoader._LOGGER=Logger.getInstance();TextureLoader.filtering=ImageFiltering.Blended;TextureLoader.wrapping={x:ImageWrapping.Clamp,y:ImageWrapping.Clamp};TextureLoader._MAX_TEXTURE_SIZE=4096;const ImageSourceAttributeConstants={Filtering:"filtering",WrappingX:"wrapping-x",WrappingY:"wrapping-y"};class ImageSource{get width(){return this.image.naturalWidth}get height(){return this.image.naturalHeight}isLoaded(){return this._src||(this._src=this.data.src),!!this._src}get image(){return this.data}constructor(ci,hi,_i){this._logger=Logger.getInstance(),this.data=new Image,this._readyFuture=new Future,this.ready=this._readyFuture.promise,this.path=ci;let pi=!1,mi;typeof hi=="boolean"?pi=hi:{filtering:_i,wrapping:mi,bustCache:pi}={...hi},this._resource=new Resource(ci,"blob",pi),this.filtering=_i??this.filtering,typeof mi=="string"?this.wrapping={x:mi,y:mi}:this.wrapping=mi??this.wrapping,ci.endsWith(".gif")&&this._logger.warn(`Use the ex.Gif type to load gifs, you may have mixed results with ${ci} in ex.ImageSource. Fully supported: svg, jpg, bmp, and png`)}static fromHtmlImageElement(ci,hi){const _i=new ImageSource("");if(_i._src="image-element",_i.data=ci,_i.data.setAttribute("data-original-src","image-element"),hi!=null&&hi.filtering?_i.data.setAttribute(ImageSourceAttributeConstants.Filtering,hi==null?void 0:hi.filtering):_i.data.setAttribute(ImageSourceAttributeConstants.Filtering,ImageFiltering.Blended),hi!=null&&hi.wrapping){let pi;typeof hi.wrapping=="string"?pi={x:hi.wrapping,y:hi.wrapping}:pi={x:hi.wrapping.x,y:hi.wrapping.y},_i.data.setAttribute(ImageSourceAttributeConstants.WrappingX,pi.x),_i.data.setAttribute(ImageSourceAttributeConstants.WrappingY,pi.y)}else _i.data.setAttribute(ImageSourceAttributeConstants.WrappingX,ImageWrapping.Clamp),_i.data.setAttribute(ImageSourceAttributeConstants.WrappingY,ImageWrapping.Clamp);return TextureLoader.checkImageSizeSupportedAndLog(ci),_i._readyFuture.resolve(ci),_i}static fromHtmlCanvasElement(ci,hi){const _i=new ImageSource("");if(_i._src="canvas-element-blob",_i.data.setAttribute("data-original-src","canvas-element-blob"),hi!=null&&hi.filtering?_i.data.setAttribute(ImageSourceAttributeConstants.Filtering,hi==null?void 0:hi.filtering):_i.data.setAttribute(ImageSourceAttributeConstants.Filtering,ImageFiltering.Blended),hi!=null&&hi.wrapping){let pi;typeof hi.wrapping=="string"?pi={x:hi.wrapping,y:hi.wrapping}:pi={x:hi.wrapping.x,y:hi.wrapping.y},_i.data.setAttribute(ImageSourceAttributeConstants.WrappingX,pi.x),_i.data.setAttribute(ImageSourceAttributeConstants.WrappingY,pi.y)}else _i.data.setAttribute(ImageSourceAttributeConstants.WrappingX,ImageWrapping.Clamp),_i.data.setAttribute(ImageSourceAttributeConstants.WrappingY,ImageWrapping.Clamp);return TextureLoader.checkImageSizeSupportedAndLog(ci),ci.toBlob(pi=>{const mi=URL.createObjectURL(pi);_i.image.onload=()=>{URL.revokeObjectURL(mi),_i.data=_i.image,_i._readyFuture.resolve(_i.image)},_i.image.src=mi}),_i}static fromSvgString(ci,hi){const _i=new Blob([ci],{type:"image/svg+xml"}),pi=URL.createObjectURL(_i);return new ImageSource(pi,hi)}get bustCache(){return this._resource.bustCache}set bustCache(ci){this._resource.bustCache=ci}async load(){var ci,hi,_i,pi;if(this.isLoaded())return this.data;try{let mi;if(this.path.includes("data:image/"))mi=this.path;else{const xi=await this._resource.load();mi=URL.createObjectURL(xi)}const gi=new Image,vi=new Future;gi.onload=()=>vi.resolve(),gi.src=mi,gi.setAttribute("data-original-src",this.path),await vi.promise,this.data=gi,TextureLoader.checkImageSizeSupportedAndLog(this.data)}catch(mi){throw`Error loading ImageSource from path '${this.path}' with error [${mi.message}]`}return this.data.setAttribute(ImageSourceAttributeConstants.Filtering,this.filtering),this.data.setAttribute(ImageSourceAttributeConstants.WrappingX,(hi=(ci=this.wrapping)===null||ci===void 0?void 0:ci.x)!==null&&hi!==void 0?hi:ImageWrapping.Clamp),this.data.setAttribute(ImageSourceAttributeConstants.WrappingY,(pi=(_i=this.wrapping)===null||_i===void 0?void 0:_i.y)!==null&&pi!==void 0?pi:ImageWrapping.Clamp),this._readyFuture.resolve(this.data),this.data}toSprite(ci){return Sprite.from(this,ci)}unload(){this.data=new Image}}class SpriteFont extends Graphic{constructor(ci){super(ci),this._text="",this.alphabet="",this.shadow=void 0,this.caseInsensitive=!1,this.spacing=0,this.lineHeight=void 0,this._logger=Logger.getInstance();const{alphabet:hi,spriteSheet:_i,caseInsensitive:pi,spacing:mi,shadow:gi,lineHeight:vi}=ci;this.alphabet=hi,this.spriteSheet=_i,this.caseInsensitive=pi??this.caseInsensitive,this.spacing=mi??this.spacing,this.shadow=gi??this.shadow,this.lineHeight=vi??this.lineHeight}_getCharacterSprites(ci){const hi=[],_i=this.caseInsensitive?ci.toLocaleLowerCase():ci,pi=this.caseInsensitive?this.alphabet.toLocaleLowerCase():this.alphabet;for(let mi=0;mi<_i.length;mi++){const gi=_i[mi];let vi=pi.indexOf(gi);vi===-1&&(vi=0,this._logger.warnOnce(`SpriteFont - Cannot find letter '${gi}' in configured alphabet '${pi}'.`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."));const xi=this.spriteSheet.sprites[vi];xi?hi.push(xi):(this._logger.warnOnce(`SpriteFont - Cannot find sprite for '${gi}' at index '${vi}' in configured SpriteSheet`),this._logger.warnOnce("There maybe be more issues in the SpriteFont configuration. No additional warnings will be logged."))}return hi}measureText(ci,hi){const _i=this._getLinesFromText(ci,hi),pi=_i.reduce((xi,wi)=>xi.length>wi.length?xi:wi),mi=this._getCharacterSprites(pi);let gi=0,vi=0;for(const xi of mi)gi+=xi.width+this.spacing,vi=Math.max(vi,xi.height);return BoundingBox.fromDimension(gi*this.scale.x,vi*_i.length*this.scale.y,Vector.Zero)}_drawImage(ci,hi,_i,pi){var mi;let gi=0,vi=0,xi=0;const wi=this._getLinesFromText(this._text,pi);for(const yi of wi){for(const Ci of this._getCharacterSprites(yi))Ci.draw(ci,hi+gi,_i+vi),gi+=Ci.width+this.spacing,xi=Math.max(xi,Ci.height);gi=0,vi+=(mi=this.lineHeight)!==null&&mi!==void 0?mi:xi}}render(ci,hi,_i,pi,mi,gi){this._text=hi;const vi=this.measureText(hi,gi);this.width=vi.width,this.height=vi.height,this.shadow&&(ci.save(),ci.translate(this.shadow.offset.x,this.shadow.offset.y),this._preDraw(ci,pi,mi),this._drawImage(ci,0,0,gi),this._postDraw(ci),ci.restore()),this._preDraw(ci,pi,mi),this._drawImage(ci,0,0,gi),this._postDraw(ci)}clone(){return new SpriteFont({alphabet:this.alphabet,spriteSheet:this.spriteSheet,spacing:this.spacing})}_getLinesFromText(ci,hi){var _i;if(this._cachedText===ci&&this._cachedRenderWidth===hi&&(!((_i=this._cachedLines)===null||_i===void 0)&&_i.length))return this._cachedLines;const pi=ci.split(`
`);if(hi==null)return pi;for(let mi=0;mi<pi.length;mi++){let gi=pi[mi],vi="";if(this.measureText(gi).width>hi){for(;this.measureText(gi).width>hi;)vi=gi[gi.length-1]+vi,gi=gi.slice(0,-1);pi[mi]=gi,pi[mi+1]=vi}}return this._cachedText=ci,this._cachedLines=pi,this._cachedRenderWidth=hi,pi}}class TiledSprite extends Sprite{constructor(ci){super({image:ci.image,sourceView:ci.sourceView,destSize:{width:ci.width,height:ci.height},flipHorizontal:ci.flipHorizontal,flipVertical:ci.flipVertical,rotation:ci.rotation,scale:ci.scale,opacity:ci.opacity,tint:ci.tint,origin:ci.origin}),this._ready=new Future,this.ready=this._ready.promise,this._options=ci,this.image.isLoaded()?this._applyTiling():this.image.ready.then(()=>this._applyTiling())}static fromSprite(ci,hi){return new TiledSprite({sourceView:{...ci.sourceView},width:ci.width,height:ci.height,...hi,image:ci.image})}_applyTiling(){const{width:ci,height:hi,filtering:_i,wrapping:pi}={...this._options},mi=document.createElement("canvas");mi.width=this.sourceView.width,mi.height=this.sourceView.height,mi.getContext("2d").drawImage(this.image.image,this.sourceView.x,this.sourceView.y,this.sourceView.width,this.sourceView.height,0,0,this.sourceView.width,this.sourceView.height);const vi=ImageSource.fromHtmlCanvasElement(mi,{wrapping:pi??ImageWrapping.Repeat,filtering:_i});ci&&(this.destSize.width=ci,this.sourceView.width=ci),hi&&(this.destSize.height=hi,this.sourceView.height=hi),this.sourceView.x=0,this.sourceView.y=0,this.image=vi,this.image.ready.then(()=>this._ready.resolve())}}class SpriteSheet{constructor(ci){this.sprites=[];const{sprites:hi,rows:_i,columns:pi}=ci;this.sprites=hi,this.rows=_i??1,this.columns=pi??this.sprites.length}getSprite(ci,hi,_i){var pi,mi,gi,vi,xi,wi,yi,Ci,Ei;if(ci>=this.columns||ci<0)throw Error(`No sprite exists in the SpriteSheet at (${ci}, ${hi}), x: ${ci} should be between 0 and ${this.columns-1} columns`);if(hi>=this.rows||hi<0)throw Error(`No sprite exists in the SpriteSheet at (${ci}, ${hi}), y: ${hi} should be between 0 and ${this.rows-1} rows`);const Si=ci+hi*this.columns,ki=this.sprites[Si];if(ki){if(_i){const Ai=ki.clone();return Ai.flipHorizontal=(pi=_i.flipHorizontal)!==null&&pi!==void 0?pi:Ai.flipHorizontal,Ai.flipVertical=(mi=_i.flipVertical)!==null&&mi!==void 0?mi:Ai.flipVertical,Ai.width=(gi=_i.width)!==null&&gi!==void 0?gi:Ai.width,Ai.height=(vi=_i.height)!==null&&vi!==void 0?vi:Ai.height,Ai.rotation=(xi=_i.rotation)!==null&&xi!==void 0?xi:Ai.rotation,Ai.scale=(wi=_i.scale)!==null&&wi!==void 0?wi:Ai.scale,Ai.opacity=(yi=_i.opacity)!==null&&yi!==void 0?yi:Ai.opacity,Ai.tint=(Ci=_i.tint)!==null&&Ci!==void 0?Ci:Ai.tint,Ai.origin=(Ei=_i.origin)!==null&&Ei!==void 0?Ei:Ai.origin,Ai}return ki}throw Error(`Invalid sprite coordinates (${ci}, ${hi})`)}getTiledSprite(ci,hi,_i){if(ci>=this.columns||ci<0)throw Error(`No sprite exists in the SpriteSheet at (${ci}, ${hi}), x: ${ci} should be between 0 and ${this.columns-1} columns`);if(hi>=this.rows||hi<0)throw Error(`No sprite exists in the SpriteSheet at (${ci}, ${hi}), y: ${hi} should be between 0 and ${this.rows-1} rows`);const pi=ci+hi*this.columns,mi=this.sprites[pi];if(mi)return TiledSprite.fromSprite(mi,_i);throw Error(`Invalid sprite coordinates (${ci}, ${hi})`)}static fromImageSourceWithSourceViews(ci){const hi=ci.sourceViews.map(_i=>new Sprite({image:ci.image,sourceView:_i}));return new SpriteSheet({sprites:hi})}static fromImageSource(ci){var hi;const _i=[];ci.spacing=(hi=ci.spacing)!==null&&hi!==void 0?hi:{};const{image:pi,grid:{rows:mi,columns:gi,spriteWidth:vi,spriteHeight:xi},spacing:{originOffset:wi,margin:yi}}=ci,Ci={x:0,y:0,...wi},Ei={x:0,y:0,...yi};for(let Si=0;Si<gi;Si++)for(let ki=0;ki<mi;ki++)_i[Si+ki*gi]=new Sprite({image:pi,sourceView:{x:Si*vi+Ei.x*Si+Ci.x,y:ki*xi+Ei.y*ki+Ci.y,width:vi,height:xi},destSize:{height:xi,width:vi}});return new SpriteSheet({sprites:_i,rows:mi,columns:gi})}clone(){return new SpriteSheet({sprites:this.sprites.map(ci=>ci.clone()),rows:this.rows,columns:this.columns})}}const debug_font="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAQAAAABACAYAAAD1Xam+AAAAAXNSR0IArs4c6QAABlFJREFUeJztndmy4yoMRcWt/v9fdr8EWoDAaDD4JntVpeqcxBrMIGQDNhEAAAAAAAAAAAAAAOCrSbMfr+u6yoEpTY+906GV57YtPkjyXj9WZZ+wHWHfo2N3/bU6Tte9Rv6ptruqRyMvKvvIX/zY3I/vjLeqsg6l/CWdp0KHKO/1Y1H2EdsR9j06Ntdfp+N03SvkH2u7i3pu5XkQ+DNTkgNJSok+/183xpcdWZHjgUzpQ2pGD67vaf//KRAGAq3tdhCy2tcMQKPyXyz7iPqrdBjbX5h9g7xbtvWf4ZJvM4D/BKG24Sd+IkQ0TC9aW5NM5FbO2HgrPVzW2vmN50DZNv/QWtl5bfPy85SBtdy9dFmjsf2F2SehTBVE+u+tkE5+lAGcJlFwGuodwRRU2Qe3rx0FhPNflc3HWC7BEh8EDGVR5IMCiLnDONtPp87qhxVH/S/LvzUAuDs/kyGimA5oSONKR1w8vsLpv+v+S9vhmS71JRiX1xB5CWZNw7m6rMrllMag/RJyWb67BEgpDVMWSydc+K47pr35w05kWd7ReEq6116KaG4CsbJ7OmV9PdZLEKkONiC1/7ZONVgDsajLIJPYp2OUAXRpnPcGmnIE6eSK4nv5YQqqSYO52JqnYfYj/PdQXQIY7XszuMofMgZRT/1LdeC5h2I5/0EdWDMY2Yb05WDE1RodVdpSA5r85slArAVnSf+89iP896St0f5bZKVA7Gk/3ja8q+152/+wrLqBWZTem3IBADbRBoDuHgAA4HdAAADgh0EAAOCHQQAA4IdBAADgh0EAAOCHuVsKbJ3P9M7jjuxHzGfv8j9iDt47Dx7hP8cjq5F/o/0T62Aer//ZOgDrajBp6aNlOWTEajKLjgj/Pcs/vfZD/a++3Pc8hNfZ966EVeh5vP75luDRJUAl0KzJfnopaqbaTuzZiulc2BS5lltFXntu3dcQsXadl59Wn1H+dfYNtrt2d6D/LDF9HkCQw6eXFbr8P9X5W/un5Ol8gz1t39p5pWOPn0vLynbgdnfe8maEQw+UIPJdfxdOd/4oTtVD0IYg8wDywGas0I04T5O3P8/qf2UWwPpkn1PbOT1bN2tFe59EM7TvKf+TRFw+erZ2ey4hpS3hp9qBkqq/tjsSU1OYqucBWB1yynt5QxC42Mdk30pAEIio//zRG3feBzLUX+TTjCKwlH83aI/KbpQBVEHgUGF0j/SitcLofHem8q6AyH0wBhFv4WszuOjy0yK2vc/oRWQoP2X9ve78jfaLnpncbBqQSC6s0HnIRT0a2yNZjfxT8+ir8t+yDsDTWaS6X70GP33+d77stp+I5HtBdwEAAPBl8ECApcAA/DBvfSowAGAB7/05ZAAA/DAIAADMMU3fOuS2ggAAwBjrorKoxWiPBxHMAgAg490Ts0VeePdA+ZfJDKcCh7sBqY88mmjklZeOt9iXPrvx2I2QPRnN2/qzyJ84h4gNcbtfasq5mM1rZr+bBWh2A+bIIX13Z9wqL+nQvFno7v3oq4tJItCed7isUT6C/I7BUn9KP95wDicYBYpcjncrO2c/dmW4tBtw4RiRld1IDxDyYsoXMHxF1w3dyz0Nne8033AOFsT6VgRCafl89fenTZUfbm8CGhrgdDcS7anAsvnkkP0IeCfQ+JzYunky6jhNYj5bl7++4fJvN9WDSKS/292A0wyANyKDI91bfkm3kcH7ckaP/SKW/VHKRZAcI14pP3beu0fPyn/DuZQbWMogNnsc16sziE96f7H/iai7uTf0/3N8lwFz/e13T00Djt4OrInCnkeChXT+qOcKOLA21tJpsv/G8/COnGnw97J9QwbTvd6djYSv7fxEVTuV/LzNhj7nOawv6bfbAGCYEpQ6HxFtuxs6sq9tzOYHobQ6Nje+6vo5BwFrPZ4OgMayS4PPt1NlzdLfbRCYBoBc+NaO4JWPwLEf33oN3unY3InKPQBW6Z7nEZzEmrl4iZjC804lqgePPEOguQcwWghUphxm343wyt/pWpWR0OrR+jvyxavHajfb9pTjbt9bH07Z5/expM4TLWfwb7QQqMoC+UDWXZo/4RgA38LOgUvLJAAQ1Td9y9//0ylxAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAB+g79apuVUsS5ZmwAAAABJRU5ErkJggg==";class DebugText{constructor(){this.fontSheet=debug_font,this.size=16,this.load()}load(){return this._imageSource=new ImageSource(this.fontSheet),this._imageSource.load().then(()=>{this._spriteSheet=SpriteSheet.fromImageSource({image:this._imageSource,grid:{rows:4,columns:16,spriteWidth:16,spriteHeight:16}}),this._spriteFont=new SpriteFont({alphabet:`0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ,!'&."?-()+# `,caseInsensitive:!0,spriteSheet:this._spriteSheet,spacing:-6})})}write(ci,hi,_i){this._imageSource.isLoaded()&&this._spriteFont.render(ci,hi,null,_i.x,_i.y)}}class RenderSource{constructor(ci,hi){this._gl=ci,this._texture=hi}use(){const ci=this._gl;ci.activeTexture(ci.TEXTURE0),ci.bindTexture(ci.TEXTURE_2D,this._texture)}disable(){const ci=this._gl;ci.bindTexture(ci.TEXTURE_2D,null)}}class RenderTarget{constructor(ci){var hi,_i;this.antialias=!1,this.samples=1,this._gl=ci.gl,this.width=ci.width,this.height=ci.height,this.transparency=ci.transparency,this.antialias=(hi=ci.antialias)!==null&&hi!==void 0?hi:this.antialias,this.samples=(_i=ci.samples)!==null&&_i!==void 0?_i:this._gl.getParameter(this._gl.MAX_SAMPLES);const pi=this._gl;pi.drawingBufferFormat?this.bufferFormat=pi.drawingBufferFormat:this.transparency?this.bufferFormat=pi.RGBA8:this.bufferFormat=pi.RGB8,this._setupRenderBuffer(),this._setupFramebuffer()}setResolution(ci,hi){const _i=this._gl;this.width=ci,this.height=hi,_i.bindTexture(_i.TEXTURE_2D,this._frameTexture),_i.texImage2D(_i.TEXTURE_2D,0,_i.RGBA,this.width,this.height,0,_i.RGBA,_i.UNSIGNED_BYTE,null),this._renderBuffer&&(_i.bindRenderbuffer(_i.RENDERBUFFER,this._renderBuffer),_i.renderbufferStorageMultisample(_i.RENDERBUFFER,Math.min(this.samples,_i.getParameter(_i.MAX_SAMPLES)),this.bufferFormat,this.width,this.height))}get renderBuffer(){return this._renderBuffer}get renderFrameBuffer(){return this._renderFrameBuffer}get frameBuffer(){return this._frameBuffer}get frameTexture(){return this._frameTexture}_setupRenderBuffer(){if(this.antialias){const ci=this._gl;this._renderBuffer=ci.createRenderbuffer(),this._renderFrameBuffer=ci.createFramebuffer(),ci.bindRenderbuffer(ci.RENDERBUFFER,this._renderBuffer),ci.renderbufferStorageMultisample(ci.RENDERBUFFER,Math.min(this.samples,ci.getParameter(ci.MAX_SAMPLES)),this.bufferFormat,this.width,this.height),ci.bindFramebuffer(ci.FRAMEBUFFER,this._renderFrameBuffer),ci.framebufferRenderbuffer(ci.FRAMEBUFFER,ci.COLOR_ATTACHMENT0,ci.RENDERBUFFER,this._renderBuffer)}}_setupFramebuffer(){const ci=this._gl;this._frameTexture=ci.createTexture(),ci.bindTexture(ci.TEXTURE_2D,this._frameTexture),ci.texImage2D(ci.TEXTURE_2D,0,ci.RGBA,this.width,this.height,0,ci.RGBA,ci.UNSIGNED_BYTE,null),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_MIN_FILTER,ci.NEAREST),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_MAG_FILTER,ci.NEAREST),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_WRAP_S,ci.CLAMP_TO_EDGE),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_WRAP_T,ci.CLAMP_TO_EDGE);const hi=ci.COLOR_ATTACHMENT0;this._frameBuffer=ci.createFramebuffer(),ci.bindFramebuffer(ci.FRAMEBUFFER,this._frameBuffer),ci.framebufferTexture2D(ci.FRAMEBUFFER,hi,ci.TEXTURE_2D,this._frameTexture,0),this.disable()}toRenderSource(){return this.renderBuffer&&this.blitRenderBufferToFrameBuffer(),new RenderSource(this._gl,this._frameTexture)}blitToScreen(){const ci=this._gl;this._renderBuffer?(ci.bindFramebuffer(ci.READ_FRAMEBUFFER,this.renderFrameBuffer),ci.bindFramebuffer(ci.DRAW_FRAMEBUFFER,null),ci.clearBufferfv(ci.COLOR,0,[0,0,1,1]),ci.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,ci.COLOR_BUFFER_BIT,ci.LINEAR)):(ci.bindFramebuffer(ci.READ_FRAMEBUFFER,this.frameBuffer),ci.bindFramebuffer(ci.DRAW_FRAMEBUFFER,null),ci.clearBufferfv(ci.COLOR,0,[0,0,1,1]),ci.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,ci.COLOR_BUFFER_BIT,ci.LINEAR))}blitRenderBufferToFrameBuffer(){if(this._renderBuffer){const ci=this._gl;ci.bindFramebuffer(ci.READ_FRAMEBUFFER,this.renderFrameBuffer),ci.bindFramebuffer(ci.DRAW_FRAMEBUFFER,this.frameBuffer),ci.clearBufferfv(ci.COLOR,0,[0,0,1,1]),ci.blitFramebuffer(0,0,this.width,this.height,0,0,this.width,this.height,ci.COLOR_BUFFER_BIT,ci.LINEAR)}}copyToTexture(ci){const hi=this._gl;this._renderBuffer&&this.blitRenderBufferToFrameBuffer(),hi.bindFramebuffer(hi.FRAMEBUFFER,this._frameBuffer),hi.bindTexture(hi.TEXTURE_2D,ci),hi.copyTexImage2D(hi.TEXTURE_2D,0,hi.RGBA,0,0,this.width,this.height,0)}use(){const ci=this._gl;this.antialias?ci.bindFramebuffer(ci.FRAMEBUFFER,this._renderFrameBuffer):ci.bindFramebuffer(ci.FRAMEBUFFER,this._frameBuffer),ci.viewport(0,0,this.width,this.height)}disable(){const ci=this._gl;ci.bindFramebuffer(ci.FRAMEBUFFER,null),ci.bindTexture(ci.TEXTURE_2D,null)}}const line_vertex=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
\r
out lowp vec4 v_color;\r
\r
uniform mat4 u_matrix;\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Passthrough the color\r
   v_color = a_color;\r
}`,line_fragment=`#version 300 es\r
precision mediump float;\r
\r
// Color\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  fragColor = v_color;\r
}`;function getGlTypeSizeBytes(fi,ci){switch(ci){case fi.INT:case fi.UNSIGNED_INT:case fi.FLOAT:return 4;case fi.SHORT:return 2;case fi.UNSIGNED_SHORT:return 2;case fi.BYTE:return 1;case fi.UNSIGNED_BYTE:return 1;default:return 1}}function isAttributeInSource(fi,ci){const hi=`(?<type>[a-z0-9]+)\\s+${ci};`,pi=new RegExp(hi,"g").exec(fi);return(pi==null?void 0:pi.length)>0}function getGLTypeFromSource(fi,ci,hi){var _i;const pi=`(?<type>[a-z0-9]+)\\s+${hi};`,gi=new RegExp(pi,"g").exec(ci);switch((_i=gi==null?void 0:gi.groups)===null||_i===void 0?void 0:_i.type){case"float":case"vec2":case"vec3":case"vec4":return fi.FLOAT;case"int":case"ivec2":case"ivec3":case"ivec4":return fi.INT;case"uint":case"uvec2":case"uvec3":case"uvec4":return fi.UNSIGNED_INT;case"bool":case"bvec2":case"bvec3":case"bvec4":return fi.BOOL;case"short":return fi.SHORT;case"ushort":return fi.UNSIGNED_SHORT;case"ubyte":return fi.UNSIGNED_BYTE;case"byte":return fi.BYTE;default:return fi.FLOAT}}function getAttributeComponentSize(fi,ci){switch(ci){case fi.LOW_FLOAT:case fi.HIGH_FLOAT:case fi.FLOAT:return 1;case fi.FLOAT_VEC2:return 2;case fi.FLOAT_VEC3:return 3;case fi.FLOAT_VEC4:return 4;case fi.BYTE:return 1;case fi.UNSIGNED_BYTE:return 1;case fi.UNSIGNED_SHORT:case fi.SHORT:return 1;default:return 1}}function getAttributePointerType(fi,ci){switch(ci){case fi.LOW_FLOAT:case fi.HIGH_FLOAT:case fi.FLOAT:case fi.FLOAT_VEC2:case fi.FLOAT_VEC3:case fi.FLOAT_VEC4:return fi.FLOAT;case fi.BYTE:return fi.BYTE;case fi.UNSIGNED_BYTE:return fi.UNSIGNED_BYTE;case fi.SHORT:return fi.SHORT;case fi.UNSIGNED_SHORT:return fi.UNSIGNED_SHORT;default:return fi.FLOAT}}function getMaxShaderComplexity(fi,ci){const hi=pi=>{const mi=`#version 300 es
    precision mediump float;
    out vec4 fragColor;
    void main() {
      float index = 1.01;
      %%complexity%%
    }`;let gi="";for(let vi=0;vi<pi;vi++)vi===0?gi+=`if (index <= ${vi}.5) {
`:gi+=`   else if (index <= ${vi}.5) {
`,gi+=`      fragColor = vec4(1.0);
`,gi+=`   }
`;return mi.replace("%%complexity%%",gi)};let _i=!1;do{const pi=hi(ci),mi=fi.createShader(fi.FRAGMENT_SHADER);fi.shaderSource(mi,pi),fi.compileShader(mi),_i=fi.getShaderParameter(mi,fi.COMPILE_STATUS),_i||(ci=ci/2|0)}while(!_i);return ci}class Shader{get compiled(){return this._compiled}constructor(ci){this._logger=Logger.getInstance(),this.uniforms={},this.attributes={},this._compiled=!1;const{gl:hi,vertexSource:_i,fragmentSource:pi,onPreLink:mi,onPostCompile:gi}=ci;this._gl=hi,this.vertexSource=_i,this.fragmentSource=pi,this._onPreLink=mi,this._onPostCompile=gi}dispose(){this._gl.deleteProgram(this.program),this._gl=null}use(){this._gl.useProgram(this.program),Shader._ACTIVE_SHADER_INSTANCE=this}isCurrentlyBound(){return Shader._ACTIVE_SHADER_INSTANCE===this}compile(){const ci=this._gl,hi=this._compileShader(ci,this.vertexSource,ci.VERTEX_SHADER),_i=this._compileShader(ci,this.fragmentSource,ci.FRAGMENT_SHADER);this.program=this._createProgram(ci,hi,_i);const pi=this.getAttributes();for(const gi of pi)this.attributes[gi.name]=gi;const mi=this.getUniforms();for(const gi of mi)this.uniforms[gi.name]=gi;return this._compiled=!0,this._onPostCompile&&this._onPostCompile(this),this.program}getUniforms(){const ci=this._gl,hi=ci.getProgramParameter(this.program,ci.ACTIVE_UNIFORMS),_i=[];for(let pi=0;pi<hi;pi++){const mi=ci.getActiveUniform(this.program,pi),gi=ci.getUniformLocation(this.program,mi.name);_i.push({name:mi.name,glType:mi.type,location:gi})}return _i}getAttributes(){const ci=this._gl,hi=ci.getProgramParameter(this.program,ci.ACTIVE_ATTRIBUTES),_i=[];for(let pi=0;pi<hi;pi++){const mi=ci.getActiveAttrib(this.program,pi),gi=ci.getAttribLocation(this.program,mi.name);_i.push({name:mi.name,glType:getAttributePointerType(ci,mi.type),size:getAttributeComponentSize(ci,mi.type),location:gi,normalized:!1})}return _i}setTexture(ci,hi){const _i=this._gl;_i.activeTexture(_i.TEXTURE0+ci),_i.bindTexture(_i.TEXTURE_2D,hi)}setUniformInt(ci,hi){this.setUniform("uniform1i",ci,~~hi)}trySetUniformInt(ci,hi){return this.trySetUniform("uniform1i",ci,~~hi)}setUniformIntArray(ci,hi){this.setUniform("uniform1iv",ci,hi)}trySetUniformIntArray(ci,hi){return this.trySetUniform("uniform1iv",ci,hi)}setUniformBoolean(ci,hi){this.setUniform("uniform1i",ci,hi?1:0)}trySetUniformBoolean(ci,hi){return this.trySetUniform("uniform1i",ci,hi?1:0)}setUniformFloat(ci,hi){this.setUniform("uniform1f",ci,hi)}trySetUniformFloat(ci,hi){return this.trySetUniform("uniform1f",ci,hi)}setUniformFloatArray(ci,hi){this.setUniform("uniform1fv",ci,hi)}trySetUniformFloatArray(ci,hi){return this.trySetUniform("uniform1fv",ci,hi)}setUniformFloatVector(ci,hi){this.setUniform("uniform2f",ci,hi.x,hi.y)}trySetUniformFloatVector(ci,hi){return this.trySetUniform("uniform2f",ci,hi.x,hi.y)}setUniformFloatColor(ci,hi){this.setUniform("uniform4f",ci,hi.r/255,hi.g/255,hi.b/255,hi.a)}trySetUniformFloatColor(ci,hi){return this.trySetUniform("uniform4f",ci,hi.r/255,hi.g/255,hi.b/255,hi.a)}setUniformMatrix(ci,hi){this.setUniform("uniformMatrix4fv",ci,!1,hi.data)}setUniformAffineMatrix(ci,hi){this.setUniform("uniformMatrix4fv",ci,!1,[hi.data[0],hi.data[1],0,0,hi.data[2],hi.data[3],0,0,0,0,1,0,hi.data[4],hi.data[5],0,1])}trySetUniformMatrix(ci,hi){return this.trySetUniform("uniformMatrix4fv",ci,!1,hi.data)}setUniform(ci,hi,..._i){if(!this._compiled)throw Error(`Must compile shader before setting a uniform ${ci}:${hi}`);if(!this.isCurrentlyBound())throw Error("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms");const mi=this._gl.getUniformLocation(this.program,hi);if(mi){const gi=[mi,..._i];this._gl[ci].apply(this._gl,gi)}else throw Error(`Uniform ${ci}:${hi} doesn't exist or is not used in the shader source code, unused uniforms are optimized away by most browsers`)}trySetUniform(ci,hi,..._i){if(!this._compiled)return this._logger.warn(`Must compile shader before setting a uniform ${ci}:${hi}`),!1;if(!this.isCurrentlyBound())return this._logger.warn("Currently accessed shader instance is not the current active shader in WebGL, must call `shader.use()` before setting uniforms"),!1;const mi=this._gl.getUniformLocation(this.program,hi);if(mi){const gi=[mi,..._i];this._gl[ci].apply(this._gl,gi)}else return!1;return!0}_createProgram(ci,hi,_i){const pi=ci.createProgram();if(pi===null)throw Error("Could not create graphics shader program");if(ci.attachShader(pi,hi),ci.attachShader(pi,_i),this._onPreLink&&this._onPreLink(pi),ci.linkProgram(pi),!ci.getProgramParameter(pi,ci.LINK_STATUS))throw Error(`Could not link the program: [${ci.getProgramInfoLog(pi)}]`);return pi}_compileShader(ci,hi,_i){const pi=ci.VERTEX_SHADER===_i?"vertex":"fragment",mi=ci.createShader(_i);if(mi===null)throw Error(`Could not build shader: [${hi}]`);if(ci.shaderSource(mi,hi),ci.compileShader(mi),!ci.getShaderParameter(mi,ci.COMPILE_STATUS)){const vi=ci.getShaderInfoLog(mi);throw Error(`Could not compile ${pi} shader:

${vi}${this._processSourceForError(hi,vi)}`)}return mi}_processSourceForError(ci,hi){if(!ci)return hi;const _i=ci.split(`
`),pi=hi.search(/\d:\d/),mi=hi.indexOf(" ",pi),[gi,vi]=hi.slice(pi,mi).split(":").map(xi=>Number(xi));for(let xi=0;xi<_i.length;xi++)_i[xi]=`${xi+1}: ${_i[xi]}${vi===xi+1?" <----- ERROR!":""}`;return`

Source:
`+_i.join(`
`)}}Shader._ACTIVE_SHADER_INSTANCE=null;class VertexBuffer{constructor(ci){this.type="dynamic";const{gl:hi,size:_i,type:pi,data:mi}=ci;if(this._gl=hi,this.buffer=this._gl.createBuffer(),!mi&&!_i)throw Error("Must either provide data or a size to the VertexBuffer");mi?this.bufferData=mi:this.bufferData=new Float32Array(_i),this.type=pi??this.type,hi.bindBuffer(hi.ARRAY_BUFFER,this.buffer),hi.bufferData(hi.ARRAY_BUFFER,this.bufferData,this.type==="static"?hi.STATIC_DRAW:hi.DYNAMIC_DRAW)}bind(){const ci=this._gl;ci.bindBuffer(ci.ARRAY_BUFFER,this.buffer)}unbind(){const ci=this._gl;ci.bindBuffer(ci.ARRAY_BUFFER,null)}upload(ci){const hi=this._gl;hi.bindBuffer(hi.ARRAY_BUFFER,this.buffer),ci?hi.bufferSubData(hi.ARRAY_BUFFER,0,this.bufferData,0,ci):hi.bufferData(hi.ARRAY_BUFFER,this.bufferData,this.type==="static"?hi.STATIC_DRAW:hi.DYNAMIC_DRAW)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}class VertexLayout{get vertexBuffer(){return this._vertexBuffer}get attributes(){return this._attributes}constructor(ci){this._logger=Logger.getInstance(),this._suppressWarnings=!1,this._layout=[],this._attributes=[],this._vertexTotalSizeBytes=0,this._initialized=!1;const{gl:hi,shader:_i,vertexBuffer:pi,attributes:mi,suppressWarnings:gi}=ci;this._gl=hi,this._vertexBuffer=pi,this._attributes=mi,this._shader=_i,this._suppressWarnings=gi,_i&&this.initialize()}get totalVertexSizeBytes(){return this._vertexTotalSizeBytes}set shader(ci){ci&&this._shader!==ci&&(this._shader=ci,this.initialize())}get shader(){return this._shader}initialize(){if(this._initialized||!this._shader)return;if(!this._shader.compiled)throw Error("Shader not compiled, shader must be compiled before defining a vertex layout");this._vertexTotalSizeBytes=0,this._layout.length=0;const ci=this._shader.attributes;for(const mi of this._attributes){const gi=ci[mi[0]];if(!gi){if(!isAttributeInSource(this._shader.vertexSource,mi[0]))throw Error(`The attribute named: ${mi[0]} size ${mi[1]} not found in the shader source code:
 ${this._shader.vertexSource}`);this._suppressWarnings||this._logger.warn(`The attribute named: ${mi[0]} size ${mi[1]} not found in the compiled shader. This is possibly a bug:
 1. Not a bug, but should remove unused code - attribute "${mi[0]}" is unused in vertex/fragment and has been automatically removed by glsl compiler.
 2. Definitely a bug, attribute "${mi[0]}" in layout has been mistyped or is missing in shader, check vertex/fragment source.`);const vi=getGLTypeFromSource(this._gl,this._shader.vertexSource,mi[0]);this._layout.push({name:mi[0],glType:vi,size:mi[1],location:-1,normalized:!1})}if(gi){if(gi.size!==mi[1])throw Error(`VertexLayout size definition for attribute: [${mi[0]}, ${mi[1]}], doesn't match shader source size ${gi.size}:
 ${this._shader.vertexSource}`);this._layout.push(gi)}}let hi=0;for(const mi of this._layout){const gi=getGlTypeSizeBytes(this._gl,mi.glType);this._vertexTotalSizeBytes+=gi*mi.size,hi+=mi.size}this._vertexBuffer.bufferData.length%hi!==0&&this._logger.warn(`The vertex component size (${hi})  does NOT divide evenly into the specified vertex buffer (${this._vertexBuffer.bufferData.length})`);const _i=this._gl;this._vao=_i.createVertexArray(),_i.bindVertexArray(this._vao),this._vertexBuffer.bind();let pi=0;for(const mi of this._layout)mi.location!==-1&&(mi.glType===_i.INT?_i.vertexAttribIPointer(mi.location,mi.size,mi.glType,this.totalVertexSizeBytes,pi):_i.vertexAttribPointer(mi.location,mi.size,mi.glType,mi.normalized,this.totalVertexSizeBytes,pi),_i.enableVertexAttribArray(mi.location)),pi+=getGlTypeSizeBytes(_i,mi.glType)*mi.size;_i.bindVertexArray(null),this._vertexBuffer.unbind(),this._initialized=!0}use(ci=!1,hi){if(!this._shader)throw Error("No shader is associated with this vertex layout, a shader must be set");const _i=this._gl;if(!this._shader.isCurrentlyBound())throw Error("Shader associated with this vertex layout is not active! Call shader.use() before layout.use()");this._vertexBuffer.bind(),ci&&this._vertexBuffer.upload(hi),_i.bindVertexArray(this._vao)}}class GraphicsDiagnostics{static clear(){GraphicsDiagnostics.DrawCallCount=0,GraphicsDiagnostics.DrawnImagesCount=0}}GraphicsDiagnostics.DrawCallCount=0;GraphicsDiagnostics.DrawnImagesCount=0;class LineRenderer{constructor(){this.type="ex.line",this.priority=0,this._maxLines=10922,this._vertexIndex=0,this._lineCount=0,this._startScratch=vec(0,0),this._endScratch=vec(0,0)}initialize(ci,hi){this._gl=ci,this._context=hi,this._shader=new Shader({gl:ci,vertexSource:line_vertex,fragmentSource:line_fragment}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._vertexBuffer=new VertexBuffer({gl:ci,size:6*2*this._maxLines,type:"dynamic"}),this._layout=new VertexLayout({gl:ci,vertexBuffer:this._vertexBuffer,shader:this._shader,attributes:[["a_position",2],["a_color",4]]})}dispose(){this._vertexBuffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(ci,hi,_i){this._isFull()&&this.flush(),this._lineCount++;const pi=this._context.getTransform(),mi=pi.multiply(ci,this._startScratch),gi=pi.multiply(hi,this._endScratch),vi=this._vertexBuffer.bufferData;vi[this._vertexIndex++]=mi.x,vi[this._vertexIndex++]=mi.y,vi[this._vertexIndex++]=_i.r/255,vi[this._vertexIndex++]=_i.g/255,vi[this._vertexIndex++]=_i.b/255,vi[this._vertexIndex++]=_i.a,vi[this._vertexIndex++]=gi.x,vi[this._vertexIndex++]=gi.y,vi[this._vertexIndex++]=_i.r/255,vi[this._vertexIndex++]=_i.g/255,vi[this._vertexIndex++]=_i.b/255,vi[this._vertexIndex++]=_i.a}_isFull(){return this._lineCount>=this._maxLines}hasPendingDraws(){return this._lineCount!==0}flush(){if(this._lineCount===0)return;const ci=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),ci.drawArrays(ci.LINES,0,this._lineCount*2),GraphicsDiagnostics.DrawnImagesCount+=this._lineCount,GraphicsDiagnostics.DrawCallCount++,this._vertexIndex=0,this._lineCount=0}}const point_vertex=`#version 300 es\r
in vec2 a_position;\r
in vec4 a_color;\r
in float a_size;\r
out lowp vec4 v_color;\r
uniform mat4 u_matrix;\r
\r
void main() {\r
  gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
  gl_PointSize = a_size * 2.0;\r
  v_color = a_color;\r
}`,point_fragment=`#version 300 es\r
\r
precision mediump float;\r
in lowp vec4 v_color;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  float r = 0.0, delta = 0.0, alpha = 1.0;\r
  vec2 cxy = 2.0 * gl_PointCoord - 1.0;\r
  r = dot(cxy, cxy);\r
\r
  delta = fwidth(r);\r
  alpha = 1.0 - smoothstep(1.0 - delta, 1.0 + delta, r);\r
  // "premultiply" the color by alpha\r
  vec4 color = v_color;\r
  color.a = color.a * alpha;\r
  color.rgb = color.rgb * color.a;\r
  fragColor = color;\r
}`;class PointRenderer{constructor(){this.type="ex.point",this.priority=0,this._maxPoints=10922,this._pointCount=0,this._vertexIndex=0}initialize(ci,hi){this._gl=ci,this._context=hi,this._shader=new Shader({gl:ci,vertexSource:point_vertex,fragmentSource:point_fragment}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._buffer=new VertexBuffer({gl:ci,size:7*this._maxPoints,type:"dynamic"}),this._layout=new VertexLayout({gl:ci,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_color",4],["a_size",1]]})}dispose(){this._buffer.dispose(),this._shader.dispose(),this._context=null,this._gl=null}draw(ci,hi,_i){this._isFull()&&this.flush(),this._pointCount++;const pi=this._context.getTransform(),mi=this._context.opacity,gi=this._context.snapToPixel,vi=pi.multiply(ci);gi&&(vi.x=~~(vi.x+pixelSnapEpsilon),vi.y=~~(vi.y+pixelSnapEpsilon));const xi=this._buffer.bufferData;xi[this._vertexIndex++]=vi.x,xi[this._vertexIndex++]=vi.y,xi[this._vertexIndex++]=hi.r/255,xi[this._vertexIndex++]=hi.g/255,xi[this._vertexIndex++]=hi.b/255,xi[this._vertexIndex++]=hi.a*mi,xi[this._vertexIndex++]=_i*Math.max(pi.getScaleX(),pi.getScaleY())}_isFull(){return this._pointCount>=this._maxPoints}hasPendingDraws(){return this._pointCount!==0}flush(){if(this._pointCount===0)return;const ci=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),ci.drawArrays(ci.POINTS,0,this._pointCount),GraphicsDiagnostics.DrawnImagesCount+=this._pointCount,GraphicsDiagnostics.DrawCallCount++,this._pointCount=0,this._vertexIndex=0}}const screen_vertex=`#version 300 es\r
in vec2 a_position;\r
\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
void main() {\r
  gl_Position = vec4(a_position, 0.0, 1.0);\r
\r
  // Pass the texcoord to the fragment shader.\r
  v_texcoord = a_texcoord;\r
}`,screen_fragment=`#version 300 es\r
precision mediump float;\r
\r
// Passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// The texture.\r
uniform sampler2D u_texture;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
   fragColor = texture(u_texture, v_texcoord);\r
}`;class ScreenPassPainter{constructor(ci){this._gl=ci,this._shader=new Shader({gl:ci,vertexSource:screen_vertex,fragmentSource:screen_fragment}),this._shader.compile(),this._buffer=new VertexBuffer({gl:ci,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new VertexLayout({gl:ci,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_texcoord",2]]}),this._buffer.upload()}renderWithPostProcessor(ci){const hi=this._gl,_i=ci.getShader();_i.use(),ci.getLayout().use(),hi.activeTexture(hi.TEXTURE0),_i.trySetUniformInt("u_image",0),ci.onDraw&&ci.onDraw(),hi.drawArrays(hi.TRIANGLES,0,6)}renderToScreen(){const ci=this._gl;this._shader.use(),this._layout.use(),ci.drawArrays(ci.TRIANGLES,0,6)}}class QuadIndexBuffer{constructor(ci,hi,_i){this._logger=Logger.getInstance(),this._gl=ci,this.buffer=ci.createBuffer(),ci.bindBuffer(ci.ELEMENT_ARRAY_BUFFER,this.buffer);const pi=hi*6;if(!_i)this.bufferData=new Uint32Array(pi);else{const vi=Math.floor(16383.5);this.bufferGlType=ci.UNSIGNED_SHORT,this.bufferData=new Uint16Array(pi),hi>vi&&this._logger.warn(`Total quads exceeds hardware index buffer limit (uint16), max(${vi}) requested quads(${hi})`)}let mi=0;for(let gi=0;gi<pi;gi+=6)this.bufferData[gi+0]=mi+0,this.bufferData[gi+1]=mi+1,this.bufferData[gi+2]=mi+2,this.bufferData[gi+3]=mi+2,this.bufferData[gi+4]=mi+1,this.bufferData[gi+5]=mi+3,mi+=4;ci.bufferData(ci.ELEMENT_ARRAY_BUFFER,this.bufferData,ci.STATIC_DRAW)}get size(){return this.bufferData.length}upload(){const ci=this._gl;ci.bindBuffer(ci.ELEMENT_ARRAY_BUFFER,this.buffer),ci.bufferData(ci.ELEMENT_ARRAY_BUFFER,this.bufferData,ci.STATIC_DRAW)}bind(){const ci=this._gl;ci.bindBuffer(ci.ELEMENT_ARRAY_BUFFER,this.buffer)}dispose(){this._gl.deleteBuffer(this.buffer),this._gl=null}}const image_renderer_frag=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Texture index\r
in lowp float v_textureIndex;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
// Opacity\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
in vec2 v_res;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
  \r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
  \r
  return pixel/texture_size;\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
  \r
  vec4 color=vec4(1.,0,0,1.);\r
  \r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
  \r
  color.rgb=color.rgb*v_opacity;\r
  color.a=color.a*v_opacity;\r
  fragColor=color*v_tint;\r
}`,image_renderer_vert=`#version 300 es\r
in vec2 a_position;\r
\r
// Opacity\r
in float a_opacity;\r
out float v_opacity;\r
\r
// UV coordinate\r
in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
// Texture res\r
in vec2 a_res;\r
out vec2 v_res;\r
\r
// Texture number\r
in lowp float a_textureIndex;\r
out lowp float v_textureIndex;\r
\r
in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  // Set the vertex position using the ortho transform matrix\r
  gl_Position=u_matrix*vec4(a_position,0.,1.);\r
  \r
  // Pass through the Opacity to the fragment shader\r
  v_opacity=a_opacity;\r
  // Pass through the UV coord to the fragment shader\r
  v_texcoord=a_texcoord;\r
\r
  v_res = a_res;\r
\r
  // Pass through the texture number to the fragment shader\r
  v_textureIndex=a_textureIndex;\r
  // Pass through the tint\r
  v_tint=a_tint;\r
}`;class ImageRenderer{constructor(ci){this.type="ex.image",this.priority=0,this._maxImages=10922,this._maxTextures=0,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._quad=[0,0,0,0,0,0,0,0],this._defaultTint=Color.White,this.pixelArtSampler=ci.pixelArtSampler,this.uvPadding=ci.uvPadding}initialize(ci,hi){this._gl=ci,this._context=hi;const _i=ci.getParameter(ci.MAX_TEXTURE_IMAGE_UNITS),pi=getMaxShaderComplexity(ci,_i);this._maxTextures=Math.min(_i,pi);const mi=this._transformFragmentSource(image_renderer_frag,this._maxTextures);this._shader=new Shader({gl:ci,fragmentSource:mi,vertexSource:image_renderer_vert}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",hi.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((gi,vi)=>vi)),this._buffer=new VertexBuffer({gl:ci,size:12*4*this._maxImages,type:"dynamic"}),this._layout=new VertexLayout({gl:ci,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_opacity",1],["a_res",2],["a_texcoord",2],["a_textureIndex",1],["a_tint",4]]}),this._quads=new QuadIndexBuffer(ci,this._maxImages,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(ci,hi){let _i=ci.replace("%%count%%",hi.toString()),pi="";for(let mi=0;mi<hi;mi++)mi===0?pi+=`if (v_textureIndex <= ${mi}.5) {
`:pi+=`   else if (v_textureIndex <= ${mi}.5) {
`,pi+=`      vec2 uv = u_pixelart ? uv_iq(v_texcoord, v_res) : v_texcoord;
`,pi+=`      color = texture(u_textures[${mi}], uv);
`,pi+=`   }
`;return _i=_i.replace("%%texture_picker%%",pi),_i}_addImageAsTexture(ci){if(this._images.has(ci))return;const hi=ci.getAttribute(ImageSourceAttributeConstants.Filtering),_i=hi?parseImageFiltering(hi):void 0,pi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingX)),mi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingY)),gi=ci.getAttribute("forceUpload")==="true",vi=this._context.textureLoader.load(ci,{filtering:_i,wrapping:{x:pi,y:mi}},gi);ci.removeAttribute("forceUpload"),this._textures.indexOf(vi)===-1&&(this._textures.push(vi),this._textureToIndex.set(vi,this._textureIndex++),this._images.add(ci))}_bindTextures(ci){for(let hi=0;hi<this._maxTextures;hi++)ci.activeTexture(ci.TEXTURE0+hi),ci.bindTexture(ci.TEXTURE_2D,this._textures[hi]||this._textures[0])}_getTextureIdForImage(ci){var hi;if(ci){const _i=this._context.textureLoader.get(ci);return(hi=this._textureToIndex.get(_i))!==null&&hi!==void 0?hi:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(ci){let hi=this._imageToWidth.get(ci);return hi===void 0&&(hi=ci.width,this._imageToWidth.set(ci,hi)),hi}_getImageHeight(ci){let hi=this._imageToHeight.get(ci);return hi===void 0&&(hi=ci.height,this._imageToHeight.set(ci,hi)),hi}draw(ci,hi,_i,pi,mi,gi,vi,xi,wi){var yi,Ci,Ei,Si;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(ci);const ki=this._getImageWidth(ci),Ai=this._getImageHeight(ci);let Ii=ki||pi||0,Ti=Ai||mi||0;this._view[0]=0,this._view[1]=0,this._view[2]=(yi=pi??ki)!==null&&yi!==void 0?yi:0,this._view[3]=(Ci=mi??Ai)!==null&&Ci!==void 0?Ci:0,this._dest[0]=hi??1,this._dest[1]=_i??1,gi!==void 0&&vi!==void 0&&xi!==void 0&&wi!==void 0&&(this._view[0]=hi??1,this._view[1]=_i??1,this._view[2]=(Ei=pi??ki)!==null&&Ei!==void 0?Ei:0,this._view[3]=(Si=mi??Ai)!==null&&Si!==void 0?Si:0,this._dest[0]=gi,this._dest[1]=vi,Ii=xi,Ti=wi),hi=this._view[0],_i=this._view[1];const Pi=this._view[2],Li=this._view[3],Ri=this._context.getTransform(),Di=this._context.opacity,Fi=this._context.snapToPixel;this._quad[0]=this._dest[0],this._quad[1]=this._dest[1],this._quad[2]=this._dest[0]+Ii,this._quad[3]=this._dest[1],this._quad[4]=this._dest[0],this._quad[5]=this._dest[1]+Ti,this._quad[6]=this._dest[0]+Ii,this._quad[7]=this._dest[1]+Ti,Ri.multiplyQuadInPlace(this._quad),Fi&&(this._quad[0]=~~(this._quad[0]+sign(this._quad[0])*pixelSnapEpsilon),this._quad[1]=~~(this._quad[1]+sign(this._quad[1])*pixelSnapEpsilon),this._quad[2]=~~(this._quad[2]+sign(this._quad[2])*pixelSnapEpsilon),this._quad[3]=~~(this._quad[3]+sign(this._quad[3])*pixelSnapEpsilon),this._quad[4]=~~(this._quad[4]+sign(this._quad[4])*pixelSnapEpsilon),this._quad[5]=~~(this._quad[5]+sign(this._quad[5])*pixelSnapEpsilon),this._quad[6]=~~(this._quad[6]+sign(this._quad[6])*pixelSnapEpsilon),this._quad[7]=~~(this._quad[7]+sign(this._quad[7])*pixelSnapEpsilon));const Mi=this._context.tint||this._defaultTint,$i=this._getTextureIdForImage(ci),Oi=ki||Ii,Gi=Ai||Ti,Ui=(hi+this.uvPadding)/Oi,zi=(_i+this.uvPadding)/Gi,Wi=(hi+Pi-this.uvPadding)/Oi,Ni=(_i+Li-this.uvPadding)/Gi,Hi=ki,ji=Ai,Bi=this._layout.vertexBuffer.bufferData;Bi[this._vertexIndex++]=this._quad[0],Bi[this._vertexIndex++]=this._quad[1],Bi[this._vertexIndex++]=Di,Bi[this._vertexIndex++]=Hi,Bi[this._vertexIndex++]=ji,Bi[this._vertexIndex++]=Ui,Bi[this._vertexIndex++]=zi,Bi[this._vertexIndex++]=$i,Bi[this._vertexIndex++]=Mi.r/255,Bi[this._vertexIndex++]=Mi.g/255,Bi[this._vertexIndex++]=Mi.b/255,Bi[this._vertexIndex++]=Mi.a,Bi[this._vertexIndex++]=this._quad[4],Bi[this._vertexIndex++]=this._quad[5],Bi[this._vertexIndex++]=Di,Bi[this._vertexIndex++]=Hi,Bi[this._vertexIndex++]=ji,Bi[this._vertexIndex++]=Ui,Bi[this._vertexIndex++]=Ni,Bi[this._vertexIndex++]=$i,Bi[this._vertexIndex++]=Mi.r/255,Bi[this._vertexIndex++]=Mi.g/255,Bi[this._vertexIndex++]=Mi.b/255,Bi[this._vertexIndex++]=Mi.a,Bi[this._vertexIndex++]=this._quad[2],Bi[this._vertexIndex++]=this._quad[3],Bi[this._vertexIndex++]=Di,Bi[this._vertexIndex++]=Hi,Bi[this._vertexIndex++]=ji,Bi[this._vertexIndex++]=Wi,Bi[this._vertexIndex++]=zi,Bi[this._vertexIndex++]=$i,Bi[this._vertexIndex++]=Mi.r/255,Bi[this._vertexIndex++]=Mi.g/255,Bi[this._vertexIndex++]=Mi.b/255,Bi[this._vertexIndex++]=Mi.a,Bi[this._vertexIndex++]=this._quad[6],Bi[this._vertexIndex++]=this._quad[7],Bi[this._vertexIndex++]=Di,Bi[this._vertexIndex++]=Hi,Bi[this._vertexIndex++]=ji,Bi[this._vertexIndex++]=Wi,Bi[this._vertexIndex++]=Ni,Bi[this._vertexIndex++]=$i,Bi[this._vertexIndex++]=Mi.r/255,Bi[this._vertexIndex++]=Mi.g/255,Bi[this._vertexIndex++]=Mi.b/255,Bi[this._vertexIndex++]=Mi.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const ci=this._gl;this._shader.use(),this._layout.use(!0,4*12*this._imageCount),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(ci),this._quads.bind(),ci.drawElements(ci.TRIANGLES,this._imageCount*6,this._quads.bufferGlType,0),GraphicsDiagnostics.DrawnImagesCount+=this._imageCount,GraphicsDiagnostics.DrawCallCount++,this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const rectangle_renderer_frag=`#version 300 es\r
\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
in vec2 v_size; // in pixels\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness; // in pixels\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
    // modified from https://stackoverflow.com/questions/59197671/glsl-rounded-rectangle-with-variable-border\r
    vec2 uv = v_uv;\r
    vec2 fragCoord = uv * v_size;\r
    float maxX = v_size.x - v_strokeThickness;\r
    float minX = v_strokeThickness;\r
    float maxY = v_size.y - v_strokeThickness;\r
    float minY = v_strokeThickness;\r
\r
    if (fragCoord.x < maxX && fragCoord.x > minX &&\r
        fragCoord.y < maxY && fragCoord.y > minY) {\r
      fragColor = v_color;\r
    } else {\r
      fragColor = v_strokeColor;\r
    }\r
    fragColor.a *= v_opacity;\r
    fragColor.rgb *= fragColor.a;\r
\r
    // vec2 v2CenteredPos     = abs(fragCoord - v_size.xy / 2.0);\r
    // vec2 v2HalfShapeSizePx = v_size.xy/2.0 - v_strokeThickness/2.0;\r
\r
    // float fHalfBorderDist      = 0.0;\r
    // float fHalfBorderThickness = 0.0;\r
\r
    // if (fragCoord.x > max(v_radius, v_strokeThickness) && \r
    //     fragCoord.x < v_size.x - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.y - v2HalfShapeSizePx.y;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else if (fragCoord.y > max(v_radius, v_strokeThickness) && \r
    //          fragCoord.y < v_size.y - max(v_radius, v_strokeThickness))\r
    // {\r
    //     fHalfBorderDist      = v2CenteredPos.x - v2HalfShapeSizePx.x;\r
    //     fHalfBorderThickness = v_strokeThickness / 2.0;\r
    // }\r
    // else\r
    // {\r
    //     vec2 edgeVec = max(vec2(0.0), v_radius - vec2(\r
    //         uv.x > 0.5 ? v_size.x - fragCoord.x : fragCoord.x,\r
    //         uv.y > 0.5 ? v_size.y - fragCoord.y : fragCoord.y));\r
        \r
    //     float ellipse_ab    = v_radius-v_strokeThickness;\r
    //     vec2 ellipse_isect = (v_strokeThickness > v_radius || v_strokeThickness > v_radius) ? vec2(0.0) :\r
    //                             edgeVec.xy * ellipse_ab*ellipse_ab / length(ellipse_ab*edgeVec.yx); \r
            \r
    //     fHalfBorderThickness = (v_radius - length(ellipse_isect)) / 2.0;\r
    //     fHalfBorderDist      = length(edgeVec) - (v_radius - fHalfBorderThickness);\r
    // }\r
\r
    // vec4 v4FromColor = v_strokeColor;\r
    // v4FromColor.rgb *= v4FromColor.a;\r
    // vec4 v4ToColor   = vec4(0.0); // background color is transparent\r
    // if (fHalfBorderDist < 0.0) {\r
    //     v4ToColor = v_color;\r
    //     v4ToColor.rgb *= v4ToColor.a;\r
    // }\r
\r
    // float mixPct = abs(fHalfBorderDist) - fHalfBorderThickness;\r
\r
    // vec4 finalColor = mix(v4FromColor, v4ToColor, mixPct);\r
    // gl_FragColor = finalColor;\r
}`,rectangle_renderer_vert=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
in vec2 a_size;\r
out vec2 v_size;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through size\r
   v_size = a_size;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class RectangleRenderer{constructor(){this.type="ex.rectangle",this.priority=0,this._maxRectangles=10922,this._rectangleCount=0,this._vertexIndex=0,this._transparent=Color.Transparent,this._scratch1=vec(0,0),this._scratch2=vec(0,0),this._scratch3=vec(0,0),this._scratch4=vec(0,0)}initialize(ci,hi){this._gl=ci,this._context=hi,this._shader=new Shader({gl:ci,fragmentSource:rectangle_renderer_frag,vertexSource:rectangle_renderer_vert}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",hi.ortho),this._buffer=new VertexBuffer({gl:ci,size:16*4*this._maxRectangles,type:"dynamic"}),this._layout=new VertexLayout({gl:ci,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_size",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new QuadIndexBuffer(ci,this._maxRectangles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._rectangleCount>=this._maxRectangles}draw(...ci){ci[0]instanceof Vector&&ci[1]instanceof Vector?this.drawLine.apply(this,ci):this.drawRectangle.apply(this,ci)}drawLine(ci,hi,_i,pi=1){this._isFull()&&this.flush(),this._rectangleCount++;const mi=this._context.getTransform(),gi=this._context.opacity,vi=this._context.snapToPixel,xi=hi.sub(ci),wi=xi.magnitude,yi=xi.normalize().perpendicular(),Ci=pi/2,Ei=mi.multiply(yi.scale(Ci,this._scratch1).add(ci,this._scratch1),this._scratch1),Si=mi.multiply(yi.scale(-Ci,this._scratch2).add(ci,this._scratch2),this._scratch2),ki=mi.multiply(yi.scale(Ci,this._scratch3).add(hi,this._scratch3),this._scratch3),Ai=mi.multiply(yi.scale(-Ci,this._scratch4).add(hi,this._scratch4),this._scratch4);vi&&(Ei.x=~~(Ei.x+pixelSnapEpsilon),Ei.y=~~(Ei.y+pixelSnapEpsilon),ki.x=~~(ki.x+pixelSnapEpsilon),ki.y=~~(ki.y+pixelSnapEpsilon),Si.x=~~(Si.x+pixelSnapEpsilon),Si.y=~~(Si.y+pixelSnapEpsilon),Ai.x=~~(Ai.x+pixelSnapEpsilon),Ai.y=~~(Ai.y+pixelSnapEpsilon));const Ii=0,Ti=0,Pi=1,Li=1,Ri=this._transparent,Di=0,Fi=1,Mi=this._layout.vertexBuffer.bufferData;Mi[this._vertexIndex++]=Ei.x,Mi[this._vertexIndex++]=Ei.y,Mi[this._vertexIndex++]=Ii,Mi[this._vertexIndex++]=Ti,Mi[this._vertexIndex++]=wi,Mi[this._vertexIndex++]=pi,Mi[this._vertexIndex++]=gi,Mi[this._vertexIndex++]=_i.r/255,Mi[this._vertexIndex++]=_i.g/255,Mi[this._vertexIndex++]=_i.b/255,Mi[this._vertexIndex++]=_i.a,Mi[this._vertexIndex++]=Ri.r/255,Mi[this._vertexIndex++]=Ri.g/255,Mi[this._vertexIndex++]=Ri.b/255,Mi[this._vertexIndex++]=Ri.a,Mi[this._vertexIndex++]=Di/Fi,Mi[this._vertexIndex++]=Si.x,Mi[this._vertexIndex++]=Si.y,Mi[this._vertexIndex++]=Ii,Mi[this._vertexIndex++]=Li,Mi[this._vertexIndex++]=wi,Mi[this._vertexIndex++]=pi,Mi[this._vertexIndex++]=gi,Mi[this._vertexIndex++]=_i.r/255,Mi[this._vertexIndex++]=_i.g/255,Mi[this._vertexIndex++]=_i.b/255,Mi[this._vertexIndex++]=_i.a,Mi[this._vertexIndex++]=Ri.r/255,Mi[this._vertexIndex++]=Ri.g/255,Mi[this._vertexIndex++]=Ri.b/255,Mi[this._vertexIndex++]=Ri.a,Mi[this._vertexIndex++]=Di/Fi,Mi[this._vertexIndex++]=ki.x,Mi[this._vertexIndex++]=ki.y,Mi[this._vertexIndex++]=Pi,Mi[this._vertexIndex++]=Ti,Mi[this._vertexIndex++]=wi,Mi[this._vertexIndex++]=pi,Mi[this._vertexIndex++]=gi,Mi[this._vertexIndex++]=_i.r/255,Mi[this._vertexIndex++]=_i.g/255,Mi[this._vertexIndex++]=_i.b/255,Mi[this._vertexIndex++]=_i.a,Mi[this._vertexIndex++]=Ri.r/255,Mi[this._vertexIndex++]=Ri.g/255,Mi[this._vertexIndex++]=Ri.b/255,Mi[this._vertexIndex++]=Ri.a,Mi[this._vertexIndex++]=Di/Fi,Mi[this._vertexIndex++]=Ai.x,Mi[this._vertexIndex++]=Ai.y,Mi[this._vertexIndex++]=Pi,Mi[this._vertexIndex++]=Li,Mi[this._vertexIndex++]=wi,Mi[this._vertexIndex++]=pi,Mi[this._vertexIndex++]=gi,Mi[this._vertexIndex++]=_i.r/255,Mi[this._vertexIndex++]=_i.g/255,Mi[this._vertexIndex++]=_i.b/255,Mi[this._vertexIndex++]=_i.a,Mi[this._vertexIndex++]=Ri.r/255,Mi[this._vertexIndex++]=Ri.g/255,Mi[this._vertexIndex++]=Ri.b/255,Mi[this._vertexIndex++]=Ri.a,Mi[this._vertexIndex++]=Di/Fi}drawRectangle(ci,hi,_i,pi,mi=Color.Transparent,gi=0){this._isFull()&&this.flush(),this._rectangleCount++;const vi=this._context.getTransform(),xi=this._context.opacity,wi=this._context.snapToPixel,yi=vi.multiply(ci.add(vec(0,0))),Ci=vi.multiply(ci.add(vec(hi,0))),Ei=vi.multiply(ci.add(vec(hi,_i))),Si=vi.multiply(ci.add(vec(0,_i)));wi&&(yi.x=~~(yi.x+pixelSnapEpsilon),yi.y=~~(yi.y+pixelSnapEpsilon),Ci.x=~~(Ci.x+pixelSnapEpsilon),Ci.y=~~(Ci.y+pixelSnapEpsilon),Si.x=~~(Si.x+pixelSnapEpsilon),Si.y=~~(Si.y+pixelSnapEpsilon),Ei.x=~~(Ei.x+pixelSnapEpsilon),Ei.y=~~(Ei.y+pixelSnapEpsilon));const ki=0,Ai=0,Ii=1,Ti=1,Pi=this._layout.vertexBuffer.bufferData;Pi[this._vertexIndex++]=yi.x,Pi[this._vertexIndex++]=yi.y,Pi[this._vertexIndex++]=ki,Pi[this._vertexIndex++]=Ai,Pi[this._vertexIndex++]=hi,Pi[this._vertexIndex++]=_i,Pi[this._vertexIndex++]=xi,Pi[this._vertexIndex++]=pi.r/255,Pi[this._vertexIndex++]=pi.g/255,Pi[this._vertexIndex++]=pi.b/255,Pi[this._vertexIndex++]=pi.a,Pi[this._vertexIndex++]=mi.r/255,Pi[this._vertexIndex++]=mi.g/255,Pi[this._vertexIndex++]=mi.b/255,Pi[this._vertexIndex++]=mi.a,Pi[this._vertexIndex++]=gi,Pi[this._vertexIndex++]=Si.x,Pi[this._vertexIndex++]=Si.y,Pi[this._vertexIndex++]=ki,Pi[this._vertexIndex++]=Ti,Pi[this._vertexIndex++]=hi,Pi[this._vertexIndex++]=_i,Pi[this._vertexIndex++]=xi,Pi[this._vertexIndex++]=pi.r/255,Pi[this._vertexIndex++]=pi.g/255,Pi[this._vertexIndex++]=pi.b/255,Pi[this._vertexIndex++]=pi.a,Pi[this._vertexIndex++]=mi.r/255,Pi[this._vertexIndex++]=mi.g/255,Pi[this._vertexIndex++]=mi.b/255,Pi[this._vertexIndex++]=mi.a,Pi[this._vertexIndex++]=gi,Pi[this._vertexIndex++]=Ci.x,Pi[this._vertexIndex++]=Ci.y,Pi[this._vertexIndex++]=Ii,Pi[this._vertexIndex++]=Ai,Pi[this._vertexIndex++]=hi,Pi[this._vertexIndex++]=_i,Pi[this._vertexIndex++]=xi,Pi[this._vertexIndex++]=pi.r/255,Pi[this._vertexIndex++]=pi.g/255,Pi[this._vertexIndex++]=pi.b/255,Pi[this._vertexIndex++]=pi.a,Pi[this._vertexIndex++]=mi.r/255,Pi[this._vertexIndex++]=mi.g/255,Pi[this._vertexIndex++]=mi.b/255,Pi[this._vertexIndex++]=mi.a,Pi[this._vertexIndex++]=gi,Pi[this._vertexIndex++]=Ei.x,Pi[this._vertexIndex++]=Ei.y,Pi[this._vertexIndex++]=Ii,Pi[this._vertexIndex++]=Ti,Pi[this._vertexIndex++]=hi,Pi[this._vertexIndex++]=_i,Pi[this._vertexIndex++]=xi,Pi[this._vertexIndex++]=pi.r/255,Pi[this._vertexIndex++]=pi.g/255,Pi[this._vertexIndex++]=pi.b/255,Pi[this._vertexIndex++]=pi.a,Pi[this._vertexIndex++]=mi.r/255,Pi[this._vertexIndex++]=mi.g/255,Pi[this._vertexIndex++]=mi.b/255,Pi[this._vertexIndex++]=mi.a,Pi[this._vertexIndex++]=gi}hasPendingDraws(){return this._rectangleCount!==0}flush(){if(this._rectangleCount===0)return;const ci=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),ci.drawElements(ci.TRIANGLES,this._rectangleCount*6,this._quads.bufferGlType,0),GraphicsDiagnostics.DrawnImagesCount+=this._rectangleCount,GraphicsDiagnostics.DrawCallCount++,this._rectangleCount=0,this._vertexIndex=0}}const circle_renderer_frag=`#version 300 es\r
precision highp float;\r
\r
// UV coord\r
in vec2 v_uv;\r
\r
// Color coord to blend with image\r
in lowp vec4 v_color;\r
\r
// Stroke color if used\r
in lowp vec4 v_strokeColor;\r
\r
// Stroke thickness if used\r
in lowp float v_strokeThickness;\r
\r
// Opacity\r
in float v_opacity;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  // make (0, 0) the center the uv \r
  vec2 uv = v_uv * 2.0 - 1.0;\r
\r
  vec4 color = v_color;\r
  vec4 strokeColor = v_strokeColor;\r
\r
  // circle border is at radius 1.0 \r
  // dist is > 0 when inside the circle \r
  float d = length(uv);\r
  float dist = 1.0 - length(uv);\r
\r
  // Fade based on fwidth\r
  float fade = fwidth(dot(uv, uv));\r
\r
  // if dist is greater than 0 step to 1;\r
  // when we cross this 0 threshold add a smooth fade\r
  float fill = smoothstep(-fade/2.0, fade/2.0, dist);\r
\r
  // if dist is greater than the stroke thickness step to 1\r
  float stroke = 1.0 - smoothstep(v_strokeThickness, v_strokeThickness + fade, dist);\r
\r
  strokeColor.a *= fill * stroke;\r
  strokeColor.rgb *= strokeColor.a;\r
\r
  color.a *= fill * (1.0 - stroke);\r
  color.rgb *= color.a;\r
\r
  vec4 finalColor = mix(vec4(0.0), (color + strokeColor), fill);\r
  finalColor.rgb = finalColor.rgb * v_opacity;\r
  finalColor.a = finalColor.a * v_opacity;\r
  fragColor = finalColor;\r
}`,circle_renderer_vert=`#version 300 es\r
in vec2 a_position;\r
\r
// UV coordinate\r
in vec2 a_uv;\r
out vec2 v_uv;\r
\r
// Opacity \r
in float a_opacity;\r
out float v_opacity;\r
\r
in vec4 a_color;\r
out vec4 v_color;\r
\r
in vec4 a_strokeColor;\r
out vec4 v_strokeColor;\r
\r
in float a_strokeThickness;\r
out float v_strokeThickness;\r
\r
uniform mat4 u_matrix;\r
\r
\r
void main() {\r
   // Set the vertex position using the ortho transform matrix\r
   gl_Position = u_matrix * vec4(a_position, 0.0, 1.0);\r
\r
   // Pass through UV coords\r
   v_uv = a_uv;\r
   // Pass through the Opacity to the fragment shader\r
   v_opacity = a_opacity;\r
   // Pass through the color to the fragment shader\r
   v_color = a_color;\r
   // Pass through the stroke color to the fragment shader\r
   v_strokeColor = a_strokeColor;\r
   // Pass through the stroke thickenss to the fragment shader\r
   v_strokeThickness = a_strokeThickness;\r
}`;class CircleRenderer{constructor(){this.type="ex.circle",this.priority=0,this._maxCircles=10922,this._circleCount=0,this._vertexIndex=0}initialize(ci,hi){this._gl=ci,this._context=hi,this._shader=new Shader({gl:ci,fragmentSource:circle_renderer_frag,vertexSource:circle_renderer_vert}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",hi.ortho),this._buffer=new VertexBuffer({gl:ci,size:14*4*this._maxCircles,type:"dynamic"}),this._layout=new VertexLayout({gl:ci,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_opacity",1],["a_color",4],["a_strokeColor",4],["a_strokeThickness",1]]}),this._quads=new QuadIndexBuffer(ci,this._maxCircles,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._shader.dispose(),this._context=null,this._gl=null}_isFull(){return this._circleCount>=this._maxCircles}draw(ci,hi,_i,pi=Color.Transparent,mi=0){this._isFull()&&this.flush(),this._circleCount++;const gi=this._context.getTransform(),vi=this._context.opacity,xi=this._context.snapToPixel,wi=gi.multiply(ci.add(vec(-hi,-hi))),yi=gi.multiply(ci.add(vec(hi,-hi))),Ci=gi.multiply(ci.add(vec(hi,hi))),Ei=gi.multiply(ci.add(vec(-hi,hi)));xi&&(wi.x=~~(wi.x+pixelSnapEpsilon),wi.y=~~(wi.y+pixelSnapEpsilon),yi.x=~~(yi.x+pixelSnapEpsilon),yi.y=~~(yi.y+pixelSnapEpsilon),Ei.x=~~(Ei.x+pixelSnapEpsilon),Ei.y=~~(Ei.y+pixelSnapEpsilon),Ci.x=~~(Ci.x+pixelSnapEpsilon),Ci.y=~~(Ci.y+pixelSnapEpsilon));const Si=0,ki=0,Ai=1,Ii=1,Ti=this._layout.vertexBuffer.bufferData;Ti[this._vertexIndex++]=wi.x,Ti[this._vertexIndex++]=wi.y,Ti[this._vertexIndex++]=Si,Ti[this._vertexIndex++]=ki,Ti[this._vertexIndex++]=vi,Ti[this._vertexIndex++]=_i.r/255,Ti[this._vertexIndex++]=_i.g/255,Ti[this._vertexIndex++]=_i.b/255,Ti[this._vertexIndex++]=_i.a,Ti[this._vertexIndex++]=pi.r/255,Ti[this._vertexIndex++]=pi.g/255,Ti[this._vertexIndex++]=pi.b/255,Ti[this._vertexIndex++]=pi.a,Ti[this._vertexIndex++]=mi/hi,Ti[this._vertexIndex++]=Ei.x,Ti[this._vertexIndex++]=Ei.y,Ti[this._vertexIndex++]=Si,Ti[this._vertexIndex++]=Ii,Ti[this._vertexIndex++]=vi,Ti[this._vertexIndex++]=_i.r/255,Ti[this._vertexIndex++]=_i.g/255,Ti[this._vertexIndex++]=_i.b/255,Ti[this._vertexIndex++]=_i.a,Ti[this._vertexIndex++]=pi.r/255,Ti[this._vertexIndex++]=pi.g/255,Ti[this._vertexIndex++]=pi.b/255,Ti[this._vertexIndex++]=pi.a,Ti[this._vertexIndex++]=mi/hi,Ti[this._vertexIndex++]=yi.x,Ti[this._vertexIndex++]=yi.y,Ti[this._vertexIndex++]=Ai,Ti[this._vertexIndex++]=ki,Ti[this._vertexIndex++]=vi,Ti[this._vertexIndex++]=_i.r/255,Ti[this._vertexIndex++]=_i.g/255,Ti[this._vertexIndex++]=_i.b/255,Ti[this._vertexIndex++]=_i.a,Ti[this._vertexIndex++]=pi.r/255,Ti[this._vertexIndex++]=pi.g/255,Ti[this._vertexIndex++]=pi.b/255,Ti[this._vertexIndex++]=pi.a,Ti[this._vertexIndex++]=mi/hi,Ti[this._vertexIndex++]=Ci.x,Ti[this._vertexIndex++]=Ci.y,Ti[this._vertexIndex++]=Ai,Ti[this._vertexIndex++]=Ii,Ti[this._vertexIndex++]=vi,Ti[this._vertexIndex++]=_i.r/255,Ti[this._vertexIndex++]=_i.g/255,Ti[this._vertexIndex++]=_i.b/255,Ti[this._vertexIndex++]=_i.a,Ti[this._vertexIndex++]=pi.r/255,Ti[this._vertexIndex++]=pi.g/255,Ti[this._vertexIndex++]=pi.b/255,Ti[this._vertexIndex++]=pi.a,Ti[this._vertexIndex++]=mi/hi}hasPendingDraws(){return this._circleCount!==0}flush(){if(this._circleCount===0)return;const ci=this._gl;this._shader.use(),this._layout.use(!0),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._quads.bind(),ci.drawElements(ci.TRIANGLES,this._circleCount*6,this._quads.bufferGlType,0),GraphicsDiagnostics.DrawnImagesCount+=this._circleCount,GraphicsDiagnostics.DrawCallCount++,this._circleCount=0,this._vertexIndex=0}}class Pool{constructor(ci,hi,_i=100){this.builder=ci,this.recycler=hi,this.maxObjects=_i,this.totalAllocations=0,this.index=0,this.objects=[],this.disableWarnings=!1,this._logger=Logger.getInstance()}dispose(){this.objects.length=0}preallocate(){for(let ci=0;ci<this.maxObjects;ci++)this.objects[ci]=this.builder()}using(ci){const hi=ci(this);return hi?this.done(...hi):this.done()}borrow(ci){const hi=this.get();ci(hi),this.index--}get(){return this.index===this.maxObjects&&(this.disableWarnings||this._logger.warn("Max pooled objects reached, possible memory leak? Doubling"),this.maxObjects=this.maxObjects*2),this.objects[this.index]?this.recycler?this.recycler(this.objects[this.index++]):this.objects[this.index++]:(this.totalAllocations++,this.objects[this.index++]=this.builder())}done(...ci){this.index=0;for(const hi of ci){const _i=this.objects.indexOf(hi);this.objects[_i]=this.builder(),this.totalAllocations++}return ci}}class DrawCall{constructor(){this.z=0,this.priority=0,this.renderer="",this.transform=AffineMatrix.identity(),this.state={z:0,opacity:1,tint:Color.White,material:null},this.args=new Array(10)}}const defaultVertexSource=`#version 300 es
in vec2 a_position;

in vec2 a_uv;
out vec2 v_uv;

in vec2 a_screenuv;
out vec2 v_screenuv;

uniform mat4 u_matrix;
uniform mat4 u_transform;

void main() {
  // Set the vertex position using the ortho & transform matrix
  gl_Position = u_matrix * u_transform * vec4(a_position, 0.0, 1.0);

  // Pass through the UV coord to the fragment shader
  v_uv = a_uv;
  v_screenuv = a_screenuv;
}
`;class Material{constructor(ci){this._logger=Logger.getInstance(),this._color=Color.Transparent,this._initialized=!1,this._images=new Map,this._textures=new Map;const{color:hi,name:_i,vertexSource:pi,fragmentSource:mi,graphicsContext:gi,images:vi}=ci;if(this._name=_i??"anonymous material",this._vertexSource=pi??defaultVertexSource,this._fragmentSource=mi,this._color=hi??this._color,!gi)throw Error(`Material ${_i} must be provided an excalibur webgl graphics context`);if(gi instanceof ExcaliburGraphicsContextWebGL?(this._graphicsContext=gi,this._initialize(gi)):this._logger.warn(`Material ${_i} was created in 2D Canvas mode, currently only WebGL is supported`),vi)for(const xi in vi)this.addImageSource(xi,vi[xi])}_initialize(ci){if(this._initialized)return;const hi=ci.__gl;this._maxTextureSlots=hi.getParameter(hi.MAX_TEXTURE_IMAGE_UNITS)-2,this._shader=ci.createShader({vertexSource:this._vertexSource,fragmentSource:this._fragmentSource}),this._shader.compile(),this._initialized=!0}get color(){return this._color}set color(ci){this._color=ci}get name(){var ci;return(ci=this._name)!==null&&ci!==void 0?ci:"anonymous material"}get isUsingScreenTexture(){return this._fragmentSource.includes("u_screen_texture")}update(ci){this._shader&&(this._shader.use(),ci(this._shader))}getShader(){return this._shader}addImageSource(ci,hi){this._images.size<this._maxTextureSlots?this._images.set(ci,hi):this._logger.warn(`Max number texture slots ${this._maxTextureSlots} have been reached for material "${this.name}", no more textures will be uploaded due to hardware constraints.`)}removeImageSource(ci){const hi=this._images.get(ci);this._graphicsContext.textureLoader.delete(hi.image),this._images.delete(ci)}_loadImageSource(ci){const hi=ci.image,_i=hi.getAttribute(ImageSourceAttributeConstants.Filtering),pi=_i?parseImageFiltering(_i):void 0,mi=parseImageWrapping(hi.getAttribute(ImageSourceAttributeConstants.WrappingX)),gi=parseImageWrapping(hi.getAttribute(ImageSourceAttributeConstants.WrappingY)),vi=hi.getAttribute("forceUpload")==="true",xi=this._graphicsContext.textureLoader.load(hi,{filtering:pi,wrapping:{x:mi,y:gi}},vi);return hi.removeAttribute("forceUpload"),this._textures.has(ci)||this._textures.set(ci,xi),xi}uploadAndBind(ci,hi=2){let _i=hi;for(const[pi,mi]of this._images.entries()){if(!mi.isLoaded()){this._logger.warnOnce(`Image named ${pi} in material ${this.name} not loaded, nothing will be uploaded to the shader. Did you forget to add this to a loader? https://excaliburjs.com/docs/loaders/`);continue}const gi=this._loadImageSource(mi);ci.activeTexture(ci.TEXTURE0+_i),ci.bindTexture(ci.TEXTURE_2D,gi),this._shader.trySetUniformInt(pi,_i),_i++}}use(){if(this._initialized)this._shader.use(),this._shader.trySetUniformFloatColor("u_color",this._color);else throw Error(`Material ${this.name} not yet initialized, use the ExcaliburGraphicsContext.createMaterial() to work around this.`)}}class MaterialRenderer{constructor(){this.type="ex.material",this.priority=0,this._textures=[]}initialize(ci,hi){this._gl=ci,this._context=hi,this._buffer=new VertexBuffer({gl:ci,size:6*4,type:"dynamic"}),this._layout=new VertexLayout({gl:ci,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2],["a_screenuv",2]],suppressWarnings:!0}),this._quads=new QuadIndexBuffer(ci,1,!0)}dispose(){this._buffer.dispose(),this._quads.dispose(),this._textures.length=0,this._context=null,this._gl=null}draw(ci,hi,_i,pi,mi,gi,vi,xi,wi){var yi,Ci,Ei,Si;const ki=this._gl,Ai=this._context.material;if(!Ai)return;const Ii=this._context.getTransform(),Ti=this._context.opacity,Pi=Ai.getShader(),Li=this._layout.vertexBuffer.bufferData;let Ri=0,Di=(ci==null?void 0:ci.width)||pi||0,Fi=(ci==null?void 0:ci.height)||mi||0,Mi=[0,0,(yi=pi??(ci==null?void 0:ci.width))!==null&&yi!==void 0?yi:0,(Ci=mi??(ci==null?void 0:ci.height))!==null&&Ci!==void 0?Ci:0],$i=[hi??1,_i??1];gi!==void 0&&vi!==void 0&&xi!==void 0&&wi!==void 0&&(Mi=[hi??1,_i??1,(Ei=pi??(ci==null?void 0:ci.width))!==null&&Ei!==void 0?Ei:0,(Si=mi??(ci==null?void 0:ci.height))!==null&&Si!==void 0?Si:0],$i=[gi,vi],Di=xi,Fi=wi),hi=Mi[0],_i=Mi[1];const Oi=Mi[2],Gi=Mi[3],Ui=vec($i[0],$i[1]),zi=vec($i[0]+Di,$i[1]),Wi=vec($i[0],$i[1]+Fi),Ni=vec($i[0]+Di,$i[1]+Fi),Hi=ci.width||Di,ji=ci.height||Fi,Bi=hi/Hi,Ji=_i/ji,Ki=(hi+Oi-.01)/Hi,Vi=(_i+Gi-.01)/ji,qi=Ii.getPosition(),Yi=qi.add(Ni),Qi=qi.x/this._context.width,ts=qi.y/this._context.height,Zi=Yi.x/this._context.width,is=Yi.y/this._context.height;Li[Ri++]=Ui.x,Li[Ri++]=Ui.y,Li[Ri++]=Bi,Li[Ri++]=Ji,Li[Ri++]=Qi,Li[Ri++]=ts,Li[Ri++]=Wi.x,Li[Ri++]=Wi.y,Li[Ri++]=Bi,Li[Ri++]=Vi,Li[Ri++]=Qi,Li[Ri++]=is,Li[Ri++]=zi.x,Li[Ri++]=zi.y,Li[Ri++]=Ki,Li[Ri++]=Ji,Li[Ri++]=Zi,Li[Ri++]=ts,Li[Ri++]=Ni.x,Li[Ri++]=Ni.y,Li[Ri++]=Ki,Li[Ri++]=Vi,Li[Ri++]=Zi,Li[Ri++]=is;const ss=this._addImageAsTexture(ci);Ai.use(),this._layout.shader=Pi,this._layout.use(!0),Pi.trySetUniformFloat("u_time_ms",performance.now()),Pi.trySetUniformFloat("u_opacity",Ti),Pi.trySetUniformFloatVector("u_resolution",vec(this._context.width,this._context.height)),Pi.trySetUniformFloatVector("u_graphic_resolution",vec(Hi,ji)),Pi.trySetUniformFloatVector("u_size",vec(Oi,Gi)),Pi.trySetUniformMatrix("u_matrix",this._context.ortho),Pi.trySetUniformMatrix("u_transform",Ii.to4x4()),ki.activeTexture(ki.TEXTURE0+0),ki.bindTexture(ki.TEXTURE_2D,ss),Pi.trySetUniformInt("u_graphic",0),ki.activeTexture(ki.TEXTURE0+1),ki.bindTexture(ki.TEXTURE_2D,this._context.materialScreenTexture),Pi.trySetUniformInt("u_screen_texture",1),Ai.uploadAndBind(ki),this._quads.bind(),ki.drawElements(ki.TRIANGLES,6,this._quads.bufferGlType,0),GraphicsDiagnostics.DrawnImagesCount++,GraphicsDiagnostics.DrawCallCount++}_addImageAsTexture(ci){const hi=ci.getAttribute(ImageSourceAttributeConstants.Filtering),_i=hi?parseImageFiltering(hi):void 0,pi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingX)),mi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingY)),gi=ci.getAttribute("forceUpload")==="true",vi=this._context.textureLoader.load(ci,{filtering:_i,wrapping:{x:pi,y:mi}},gi);return ci.removeAttribute("forceUpload"),this._textures.indexOf(vi)===-1&&this._textures.push(vi),vi}hasPendingDraws(){return!1}flush(){}}const particle_vertex=`#version 300 es\r
precision mediump float;\r
\r
uniform float deltaMs;\r
uniform float maxLifeMs;\r
uniform vec2 gravity;\r
uniform vec2 focus;\r
uniform float focusAccel;\r
uniform mat4 u_matrix;\r
uniform mat4 u_transform;\r
uniform float startSize;\r
uniform float endSize;\r
// uniform sampler2D obstacle;\r
\r
layout(location=0)in vec2 position;\r
layout(location=1)in vec2 velocity;\r
layout(location=2)in float rotation;\r
layout(location=3)in float angularVelocity;\r
layout(location=4)in float lifeMs;\r
\r
// TODO z index to handle buffer wrapping?\r
\r
// DO NOT RE-ORDER\r
out vec2 finalPosition;\r
out vec2 finalVelocity;\r
out float finalRotation;\r
out float finalAngularVelocity;\r
out float finalLifeMs;\r
void main(){\r
  // Evolve particle\r
  float seconds = deltaMs / 1000.;\r
  // euler integration\r
  // Weird artifact of re-using the same buffer layout for update/draw\r
  // we need differently named variables\r
  vec2 finalGravity = gravity + normalize(focus - position) * focusAccel;\r
  finalVelocity = velocity + finalGravity * seconds;\r
  finalPosition = position + velocity * seconds + finalGravity * .5 * seconds * seconds;\r
  finalRotation = rotation + angularVelocity * seconds;\r
  finalAngularVelocity = angularVelocity;\r
  finalLifeMs = clamp(lifeMs - deltaMs, 0., maxLifeMs);\r
\r
  // Collision mask sampling\r
  // vec2 samplePoint = finalPosition / vec2(width, height);\r
  // vec4 collides = texture(obstacle, samplePoint);\r
  // if (distance(collides,vec4(0.)) > .01) {\r
  //   // non opaque means we collide! recalc final pos/vel\r
  //   vec2 newVelocity = velocity * -.1;// lose energy\r
  //   finalVelocity = newVelocity + gravity * seconds;\r
  //   finalPosition = position + newVelocity * seconds + gravity * .5 * seconds * seconds;\r
  // }\r
\r
  float lifePercent = finalLifeMs / maxLifeMs;\r
  vec2 transformedPos = (u_matrix * u_transform * vec4(finalPosition,0.,1.)).xy;\r
  float scale = sqrt(u_transform[0][0] * u_transform[0][0] + u_transform[1][1] * u_transform[1][1]);\r
  gl_Position = vec4(transformedPos, 1.0 - lifePercent, 1.); // use life percent to sort z\r
  gl_PointSize = mix(startSize, endSize, 1.0 - lifePercent) * scale;\r
}`,particle_fragment=`#version 300 es\r
precision mediump float;\r
\r
uniform sampler2D graphic;\r
uniform bool useTexture;\r
uniform float maxLifeMs;\r
\r
uniform vec4 beginColor;\r
uniform vec4 endColor;\r
uniform bool fade;\r
uniform float startOpacity;\r
\r
in float finalRotation;\r
in float finalLifeMs;\r
out vec4 fragColor;\r
\r
void main(){\r
\r
  float lifePct = finalLifeMs / maxLifeMs;\r
\r
  if (useTexture) {\r
    /** Draw texture */\r
    if (lifePct <= 0.) discard;\r
    float mid = .5;\r
    float cosine = cos(finalRotation);\r
    float sine = sin(finalRotation);\r
    vec2 rotated = vec2(cosine * (gl_PointCoord.x - mid) + sine * (gl_PointCoord.y - mid) + mid,\r
                        cosine * (gl_PointCoord.y - mid) - sine * (gl_PointCoord.x - mid) + mid);\r
    vec4 color = texture(graphic, rotated);\r
    fragColor = color * (fade ? lifePct : 1.0);\r
  } else {\r
    /** Draw circle */\r
    if (lifePct <= 0.) discard;\r
    vec2 uv = gl_PointCoord.xy * 2.0 - 1.0;\r
    float dist = 1.0 - length(uv);\r
    float edge = fwidth(dot(uv, uv));\r
    float circle = smoothstep(-edge/2.0, edge/2.0, dist);\r
    vec3 color = mix(beginColor.rgb, endColor.rgb, 1.0 - lifePct);\r
    fragColor.rgb = color;\r
    fragColor.a = startOpacity * circle * (fade ? lifePct : 1.0);// * mix(beginColor.a, endColor.a, 1.0 - lifePct);\r
    fragColor.rgb *= fragColor.a;\r
  }\r
}`;var CoordPlane;(function(fi){fi.World="world",fi.Screen="screen"})(CoordPlane||(CoordPlane={}));class VectorView extends Vector{constructor(ci){super(0,0),this._getX=ci.getX,this._getY=ci.getY,this._setX=ci.setX,this._setY=ci.setY}get x(){return this._x=this._getX()}set x(ci){this._setX(ci),this._x=ci}get y(){return this._y=this._getY()}set y(ci){this._setY(ci),this._y=ci}}class WatchVector extends Vector{constructor(ci,hi){super(ci.x,ci.y),this.original=ci,this.change=hi}get x(){return this._x=this.original.x}set x(ci){ci!==this._x&&(this.change(ci,this._y),this._x=this.original.x=ci)}get y(){return this._y=this.original.y}set y(ci){ci!==this._y&&(this.change(this._x,ci),this._y=this.original.y=ci)}setTo(ci,hi){this.x=ci,this.y=hi}}class transform_Transform{constructor(){this._parent=null,this._children=[],this._pos=new WatchVector(vec(0,0),()=>{this.flagDirty()}),this._globalPos=new VectorView({getX:()=>this.matrix.data[4],getY:()=>this.matrix.data[5],setX:ci=>{if(this.parent){const{x:hi}=this.parent.inverse.multiply(vec(ci,this.pos.y));this.pos.x=hi}else this.pos.x=ci;ci!==this.matrix.data[4]&&this.flagDirty()},setY:ci=>{if(this.parent){const{y:hi}=this.parent.inverse.multiply(vec(this.pos.x,ci));this.pos.y=hi}else this.pos.y=ci;ci!==this.matrix.data[5]&&this.flagDirty()}}),this._rotation=0,this._scale=new WatchVector(vec(1,1),()=>{this.flagDirty()}),this._globalScale=new VectorView({getX:()=>this.parent?this.matrix.getScaleX():this.scale.x,getY:()=>this.parent?this.matrix.getScaleY():this.scale.y,setX:ci=>{if(this.parent){const hi=this.parent.globalScale.x;this.scale.x=ci/hi}else this.scale.x=ci},setY:ci=>{if(this.parent){const hi=this.parent.globalScale.y;this.scale.y=ci/hi}else this.scale.y=ci}}),this._z=0,this._isDirty=!1,this._isInverseDirty=!1,this._matrix=AffineMatrix.identity(),this._inverse=AffineMatrix.identity(),this._scratch=AffineMatrix.identity()}get parent(){return this._parent}set parent(ci){if(this._parent){const hi=this._parent._children.indexOf(this);hi>-1&&this._parent._children.splice(hi,1)}this._parent=ci,this._parent&&this._parent._children.push(this),this.flagDirty()}get children(){return this._children}set pos(ci){this._pos.x=ci.x,this._pos.y=ci.y}get pos(){return this._pos}set globalPos(ci){let hi=ci.clone();this.parent&&(hi=this.parent.inverse.multiply(ci)),hi.equals(this._pos)||(this._pos=hi,this.flagDirty())}get globalPos(){return this._globalPos}set rotation(ci){const hi=canonicalizeAngle(ci);hi!==this._rotation&&this.flagDirty(),this._rotation=hi}get rotation(){return this._rotation}set globalRotation(ci){let hi=0;this.parent&&(hi=this.parent.globalRotation);const _i=canonicalizeAngle(ci+hi);_i!==this._rotation&&this.flagDirty(),this._rotation=_i}get globalRotation(){return this.parent?this.matrix.getRotation():this.rotation}set scale(ci){this._scale.x=ci.x,this._scale.y=ci.y}get scale(){return this._scale}set globalScale(ci){let hi=vec(1,1);this.parent&&(hi=this.parent.globalScale),this.scale=ci.scale(vec(1/hi.x,1/hi.y))}get globalScale(){return this._globalScale}set z(ci){this._z=ci,this.flagDirty()}get z(){return this._z}set globalZ(ci){this.parent?this.z=ci-this.parent.globalZ:this.z=ci}get globalZ(){return this.parent?this.z+this.parent.globalZ:this.z}get matrix(){return this._isDirty&&(this.parent===null?this._calculateMatrix().clone(this._matrix):this.parent.matrix.multiply(this._calculateMatrix()).clone(this._matrix),this._isDirty=!1),this._matrix}get inverse(){return this._isInverseDirty&&(this.matrix.inverse(this._inverse),this._isInverseDirty=!1),this._inverse}_calculateMatrix(){return this._scratch.data[0]=Math.cos(this._rotation),this._scratch.data[1]=Math.sin(this._rotation),this._scratch.data[2]=-Math.sin(this._rotation),this._scratch.data[3]=Math.cos(this.rotation),this._scratch.data[4]=this._pos.x,this._scratch.data[5]=this._pos.y,this._scratch.scale(this._scale.x,this._scale.y),this._scratch}flagDirty(){this._isDirty=!0,this._isInverseDirty=!0;for(let ci=0;ci<this._children.length;ci++)this._children[ci].flagDirty()}apply(ci){return this.matrix.multiply(ci)}applyInverse(ci){return this.inverse.multiply(ci)}setTransform(ci,hi,_i){this._pos.x=ci.x,this._pos.y=ci.y,this._rotation=canonicalizeAngle(hi),this._scale.x=_i.x,this._scale.y=_i.y,this.flagDirty()}isMirrored(){const ci=sign(this.scale.x)>>>31,hi=sign(this.scale.y)>>>31;return!!(ci^hi)}clone(ci){const hi=ci??new transform_Transform;return this._pos.clone(hi._pos),hi._z=this._z,hi._rotation=this._rotation,this._scale.clone(hi._scale),hi.flagDirty(),hi}cloneWithParent(ci){const hi=ci??new transform_Transform;return this._pos.clone(hi._pos),hi._z=this._z,hi._rotation=this._rotation,this._scale.clone(hi._scale),hi.parent=this.parent,hi.flagDirty(),hi}toString(){return this.matrix.toString()}}function isComponentCtor(fi){return!!fi&&!!fi.prototype&&!!fi.prototype.constructor}function hasClone(fi){return!!(fi!=null&&fi.clone)}class Component{constructor(){this.owner=void 0}clone(){const ci=new this.constructor;for(const hi in this)if(this.hasOwnProperty(hi)){const _i=this[hi];hasClone(_i)&&hi!=="owner"&&hi!=="clone"?ci[hi]=_i.clone():ci[hi]=_i}return ci}}class Observable{constructor(){this.observers=[],this.subscriptions=[]}register(ci){this.observers.push(ci)}subscribe(ci){this.subscriptions.push(ci)}unregister(ci){const hi=this.observers.indexOf(ci);hi!==-1&&this.observers.splice(hi,1)}unsubscribe(ci){const hi=this.subscriptions.indexOf(ci);hi!==-1&&this.subscriptions.splice(hi,1)}notifyAll(ci){const hi=this.observers.length;for(let pi=0;pi<hi;pi++)this.observers[pi].notify(ci);const _i=this.subscriptions.length;for(let pi=0;pi<_i;pi++)this.subscriptions[pi](ci)}clear(){this.observers.length=0,this.subscriptions.length=0}}class TransformComponent extends Component{constructor(){super(...arguments),this._logger=Logger.getInstance(),this._parentComponent=null,this._transform=new transform_Transform,this._addChildTransform=ci=>{const hi=ci.get(TransformComponent);hi&&(hi._transform.parent=this._transform,hi._parentComponent=this)},this.zIndexChanged$=new Observable,this._coordPlane=CoordPlane.World}get(){return this._transform}onAdd(ci){for(const hi of ci.children)this._addChildTransform(hi);ci.childrenAdded$.subscribe(hi=>this._addChildTransform(hi)),ci.childrenRemoved$.subscribe(hi=>{const _i=hi.get(TransformComponent);_i&&(_i._transform.parent=null,_i._parentComponent=null)})}onRemove(ci){this._transform.parent=null,this._parentComponent=null}get z(){return this._transform.z}set z(ci){const hi=this._transform.z;this._transform.z=ci,hi!==ci&&this.zIndexChanged$.notifyAll(ci)}get globalZ(){return this._transform.globalZ}set globalZ(ci){this._transform.globalZ=ci}get coordPlane(){return this._parentComponent?this._parentComponent.coordPlane:this._coordPlane}set coordPlane(ci){var hi;this._parentComponent?this._logger.warn(`Cannot set coordinate plane on child entity ${(hi=this.owner)===null||hi===void 0?void 0:hi.name}, children inherit their coordinate plane from their parents.`):this._coordPlane=ci}get pos(){return this._transform.pos}set pos(ci){this._transform.pos=ci}get globalPos(){return this._transform.globalPos}set globalPos(ci){this._transform.globalPos=ci}get rotation(){return this._transform.rotation}set rotation(ci){this._transform.rotation=ci}get globalRotation(){return this._transform.globalRotation}set globalRotation(ci){this._transform.globalRotation=ci}get scale(){return this._transform.scale}set scale(ci){this._transform.scale=ci}get globalScale(){return this._transform.globalScale}set globalScale(ci){this._transform.globalScale=ci}applyInverse(ci){return this._transform.applyInverse(ci)}apply(ci){return this._transform.apply(ci)}clone(){const ci=new TransformComponent;return ci._transform=this._transform.clone(),ci}}var AnimationDirection;(function(fi){fi.Forward="forward",fi.Backward="backward"})(AnimationDirection||(AnimationDirection={}));var AnimationStrategy;(function(fi){fi.End="end",fi.Loop="loop",fi.PingPong="pingpong",fi.Freeze="freeze"})(AnimationStrategy||(AnimationStrategy={}));const AnimationEvents={Frame:"frame",Loop:"loop",End:"end"};class Animation extends Graphic{constructor(ci){var hi,_i,pi;super(ci),this.events=new EventEmitter,this.frames=[],this.strategy=AnimationStrategy.Loop,this.frameDuration=100,this._idempotencyToken=-1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=0,this._pingPongDirection=1,this._done=!1,this._playing=!0,this._speed=1,this._reversed=!1,this.frames=ci.frames,this.speed=(hi=ci.speed)!==null&&hi!==void 0?hi:this.speed,this.strategy=(_i=ci.strategy)!==null&&_i!==void 0?_i:this.strategy,this.frameDuration=ci.totalDuration?ci.totalDuration/this.frames.length:(pi=ci.frameDuration)!==null&&pi!==void 0?pi:this.frameDuration,ci.reverse&&this.reverse(),this.goToFrame(0)}clone(){return new Animation({frames:this.frames.map(ci=>({...ci})),frameDuration:this.frameDuration,speed:this.speed,reverse:this._reversed,strategy:this.strategy,...this.cloneGraphicOptions()})}get width(){const ci=this.currentFrame;return ci&&ci.graphic?Math.abs(ci.graphic.width*this.scale.x):0}get height(){const ci=this.currentFrame;return ci&&ci.graphic?Math.abs(ci.graphic.height*this.scale.y):0}static fromSpriteSheet(ci,hi,_i,pi=AnimationStrategy.Loop){const mi=ci.sprites.length-1,gi=hi.filter(vi=>vi<0||vi>mi);return gi.length&&Animation._LOGGER.warn(`Indices into SpriteSheet were provided that don't exist: ${gi.join(",")} no frame will be shown`),new Animation({frames:ci.sprites.filter((vi,xi)=>hi.indexOf(xi)>-1).map(vi=>({graphic:vi,duration:_i})),strategy:pi})}static fromSpriteSheetCoordinates(ci){var hi;const{spriteSheet:_i,frameCoordinates:pi,durationPerFrame:mi,durationPerFrameMs:gi,speed:vi,strategy:xi,reverse:wi}=ci,yi=(hi=mi??gi)!==null&&hi!==void 0?hi:100,Ci=[];for(const Ei of pi){const{x:Si,y:ki,duration:Ai,options:Ii}=Ei,Ti=_i.getSprite(Si,ki,Ii);Ti?Ci.push({graphic:Ti,duration:Ai??yi}):Animation._LOGGER.warn(`Skipping frame! SpriteSheet does not have coordinate (${Si}, ${ki}), please check your SpriteSheet to confirm that sprite exists`)}return new Animation({frames:Ci,strategy:xi,speed:vi,reverse:wi})}get speed(){return this._speed}set speed(ci){this._speed=clamp(Math.abs(ci),0,1/0)}get currentFrame(){return this._currentFrame>=0&&this._currentFrame<this.frames.length?this.frames[this._currentFrame]:null}get currentFrameIndex(){return this._currentFrame}get currentFrameTimeLeft(){return this._timeLeftInFrame}get isPlaying(){return this._playing}get isReversed(){return this._reversed}reverse(){this.frames=this.frames.slice().reverse(),this._reversed=!this._reversed}get direction(){return!!(this._reversed&&this._pingPongDirection===1)?AnimationDirection.Backward:AnimationDirection.Forward}play(){this._playing=!0}pause(){this._playing=!1,this._firstTick=!0}reset(){this._done=!1,this._firstTick=!0,this._currentFrame=0,this._timeLeftInFrame=this.frameDuration;const ci=this.frames[this._currentFrame];ci&&(this._timeLeftInFrame=(ci==null?void 0:ci.duration)||this.frameDuration)}get canFinish(){switch(this.strategy){case AnimationStrategy.End:case AnimationStrategy.Freeze:return!0;default:return!1}}get done(){return this._done}goToFrame(ci,hi){this._currentFrame=ci,this._timeLeftInFrame=hi??this.frameDuration;const _i=this.frames[this._currentFrame];_i&&!this._done&&(this._timeLeftInFrame=hi??((_i==null?void 0:_i.duration)||this.frameDuration),this.events.emit("frame",{..._i,frameIndex:this.currentFrameIndex}))}_nextFrame(){const ci=this._currentFrame;if(this._done)return ci;let hi=-1;switch(this.strategy){case AnimationStrategy.Loop:{hi=(ci+1)%this.frames.length,hi===0&&this.events.emit("loop",this);break}case AnimationStrategy.End:{hi=ci+1,hi>=this.frames.length&&(this._done=!0,this._currentFrame=this.frames.length,this.events.emit("end",this));break}case AnimationStrategy.Freeze:{hi=clamp(ci+1,0,this.frames.length-1),hi>=this.frames.length-1&&(this._done=!0,this.events.emit("end",this));break}case AnimationStrategy.PingPong:{ci+this._pingPongDirection>=this.frames.length&&(this._pingPongDirection=-1,this.events.emit("loop",this)),ci+this._pingPongDirection<0&&(this._pingPongDirection=1,this.events.emit("loop",this)),hi=ci+this._pingPongDirection%this.frames.length;break}}return hi}tick(ci,hi=0){this._idempotencyToken!==hi&&(this._idempotencyToken=hi,this._playing&&(this._firstTick&&(this._firstTick=!1,this.events.emit("frame",{...this.currentFrame,frameIndex:this.currentFrameIndex})),this._timeLeftInFrame-=ci*this._speed,this._timeLeftInFrame<=0&&this.goToFrame(this._nextFrame())))}_drawImage(ci,hi,_i){this.currentFrame&&this.currentFrame.graphic&&this.currentFrame.graphic.draw(ci,hi,_i)}}Animation._LOGGER=Logger.getInstance();class GraphicsGroup extends Graphic{constructor(ci){var hi;super(ci),this._logger=Logger.getInstance(),this.useAnchor=!0,this.members=[],this.members=ci.members,this.useAnchor=(hi=ci.useAnchor)!==null&&hi!==void 0?hi:this.useAnchor,this._updateDimensions()}clone(){return new GraphicsGroup({members:[...this.members],...this.cloneGraphicOptions()})}_updateDimensions(){const ci=this.localBounds;return this.width=ci.width,this.height=ci.height,ci}get localBounds(){const ci=new BoundingBox;for(const hi of this.members)if(hi instanceof Graphic)hi.localBounds.combine(ci,ci);else{const{graphic:_i,offset:pi,useBounds:mi}=hi;_i?(mi===void 0?!0:mi)&&_i.localBounds.translate(pi).combine(ci,ci):this._logger.warnOnce(`Graphics group member has an null or undefined graphic, member definition: ${JSON.stringify(hi)}.`)}return ci}_isAnimationOrGroup(ci){return ci instanceof Animation||ci instanceof GraphicsGroup}tick(ci,hi){for(const _i of this.members){let pi;_i instanceof Graphic?pi=_i:pi=_i.graphic,this._isAnimationOrGroup(pi)&&pi.tick(ci,hi)}}reset(){for(const ci of this.members){let hi;ci instanceof Graphic?hi=ci:hi=ci.graphic,this._isAnimationOrGroup(hi)&&hi.reset()}}_preDraw(ci,hi,_i){this._updateDimensions(),super._preDraw(ci,this.useAnchor?hi:0,this.useAnchor?_i:0)}_drawImage(ci,hi,_i){const pi=Vector.Zero;for(const mi of this.members){let gi;mi instanceof Graphic?gi=mi:(gi=mi.graphic,mi.offset.clone(pi)),gi&&(ci.save(),ci.translate(hi,_i),gi.draw(ci,pi.x,pi.y),this.showDebug&&ci.debug.drawRect(0,0,this.width,this.height),ci.restore())}}}class Raster extends Graphic{constructor(ci){var hi,_i,pi,mi,gi,vi,xi,wi,yi,Ci;super(omit({...ci},["width","height"])),this.lineCap="butt",this.quality=1,this._dirty=!0,this._smoothing=!1,this._color=watch(Color.Black,()=>this.flagDirty()),this._lineWidth=1,this._lineDash=[],this._padding=0,ci&&(this.quality=(hi=ci.quality)!==null&&hi!==void 0?hi:this.quality,this.color=(_i=ci.color)!==null&&_i!==void 0?_i:Color.Black,this.strokeColor=ci==null?void 0:ci.strokeColor,this.smoothing=(pi=ci.smoothing)!==null&&pi!==void 0?pi:this.smoothing,this.lineWidth=(mi=ci.lineWidth)!==null&&mi!==void 0?mi:this.lineWidth,this.lineDash=(gi=ci.lineDash)!==null&&gi!==void 0?gi:this.lineDash,this.lineCap=(vi=ci.lineCap)!==null&&vi!==void 0?vi:this.lineCap,this.padding=(xi=ci.padding)!==null&&xi!==void 0?xi:this.padding,this.filtering=(wi=ci.filtering)!==null&&wi!==void 0?wi:this.filtering),this._bitmap=document.createElement("canvas");const Ei=(yi=ci==null?void 0:ci.width)!==null&&yi!==void 0?yi:this._bitmap.width,Si=(Ci=ci==null?void 0:ci.height)!==null&&Ci!==void 0?Ci:this._bitmap.height;this.width=Ei,this.height=Si;const ki=this._bitmap.getContext("2d");if(ki)this._ctx=ki;else throw new Error("Browser does not support 2d canvas drawing, cannot create Raster graphic")}cloneRasterOptions(){return{color:this.color?this.color.clone():void 0,strokeColor:this.strokeColor?this.strokeColor.clone():void 0,smoothing:this.smoothing,lineWidth:this.lineWidth,lineDash:this.lineDash,lineCap:this.lineCap,quality:this.quality,padding:this.padding}}get dirty(){return this._dirty}flagDirty(){this._dirty=!0}get width(){return Math.abs(this._getTotalWidth()*this.scale.x)}set width(ci){ci/=Math.abs(this.scale.x),this._bitmap.width=ci,this._originalWidth=ci,this.flagDirty()}get height(){return Math.abs(this._getTotalHeight()*this.scale.y)}set height(ci){ci/=Math.abs(this.scale.y),this._bitmap.height=ci,this._originalHeight=ci,this.flagDirty()}_getTotalWidth(){var ci;return(((ci=this._originalWidth)!==null&&ci!==void 0?ci:this._bitmap.width)+this.padding*2)*1}_getTotalHeight(){var ci;return(((ci=this._originalHeight)!==null&&ci!==void 0?ci:this._bitmap.height)+this.padding*2)*1}get localBounds(){return BoundingBox.fromDimension(this._getTotalWidth()*this.scale.x,this._getTotalHeight()*this.scale.y,Vector.Zero)}get smoothing(){return this._smoothing}set smoothing(ci){this._smoothing=ci,this.flagDirty()}get color(){return this._color}set color(ci){this.flagDirty(),this._color=watch(ci,()=>this.flagDirty())}get strokeColor(){return this._strokeColor}set strokeColor(ci){this.flagDirty(),ci&&(this._strokeColor=watch(ci,()=>this.flagDirty()))}get lineWidth(){return this._lineWidth}set lineWidth(ci){this._lineWidth=ci,this.flagDirty()}get lineDash(){return this._lineDash}set lineDash(ci){this._lineDash=ci,this.flagDirty()}get padding(){return this._padding}set padding(ci){this._padding=ci,this.flagDirty()}rasterize(){this._dirty=!1,this._ctx.clearRect(0,0,this._getTotalWidth(),this._getTotalHeight()),this._ctx.save(),this._applyRasterProperties(this._ctx),this.execute(this._ctx),this._ctx.restore()}_applyRasterProperties(ci){var hi,_i,pi,mi;this._bitmap.width=this._getTotalWidth()*this.quality,this._bitmap.height=this._getTotalHeight()*this.quality,this._bitmap.setAttribute("filtering",this.filtering),this._bitmap.setAttribute("forceUpload","true"),ci.scale(this.quality,this.quality),ci.translate(this.padding,this.padding),ci.imageSmoothingEnabled=this.smoothing,ci.lineWidth=this.lineWidth,ci.setLineDash((hi=this.lineDash)!==null&&hi!==void 0?hi:ci.getLineDash()),ci.lineCap=this.lineCap,ci.strokeStyle=(pi=(_i=this.strokeColor)===null||_i===void 0?void 0:_i.toString())!==null&&pi!==void 0?pi:"",ci.fillStyle=(mi=this.color)===null||mi===void 0?void 0:mi.toString()}_drawImage(ci,hi,_i){this._dirty&&this.rasterize(),ci.scale(1/this.quality,1/this.quality),ci.drawImage(this._bitmap,hi,_i)}}var FontUnit;(function(fi){fi.Em="em",fi.Rem="rem",fi.Px="px",fi.Pt="pt",fi.Percent="%"})(FontUnit||(FontUnit={}));var TextAlign;(function(fi){fi.Left="left",fi.Right="right",fi.Center="center",fi.Start="start",fi.End="end"})(TextAlign||(TextAlign={}));var BaseAlign;(function(fi){fi.Top="top",fi.Hanging="hanging",fi.Middle="middle",fi.Alphabetic="alphabetic",fi.Ideographic="ideographic",fi.Bottom="bottom"})(BaseAlign||(BaseAlign={}));var FontStyle;(function(fi){fi.Normal="normal",fi.Italic="italic",fi.Oblique="oblique"})(FontStyle||(FontStyle={}));var Direction;(function(fi){fi.LeftToRight="ltr",fi.RightToLeft="rtl"})(Direction||(Direction={}));function line(fi,ci=Color.Red,hi,_i,pi,mi,gi=1,vi="butt"){fi.save(),fi.beginPath(),fi.lineWidth=gi,fi.lineCap=vi,fi.strokeStyle=ci.toString(),fi.moveTo(hi,_i),fi.lineTo(pi,mi),fi.closePath(),fi.stroke(),fi.restore()}function point(fi,ci=Color.Red,hi){fi.beginPath(),fi.strokeStyle=ci.toString(),fi.arc(hi.x,hi.y,5,0,Math.PI*2),fi.closePath(),fi.stroke()}function vector(fi,ci,hi,_i,pi=1){const mi=ci?ci.toString():"blue",gi=_i.scale(pi);fi.beginPath(),fi.strokeStyle=mi,fi.moveTo(hi.x,hi.y),fi.lineTo(hi.x+gi.x,hi.y+gi.y),fi.closePath(),fi.stroke()}function roundRect(fi,ci,hi,_i,pi,mi=5,gi=Color.White,vi=null){let xi;if(typeof mi=="number")xi={tl:mi,tr:mi,br:mi,bl:mi};else{const wi={tl:0,tr:0,br:0,bl:0};for(const yi in wi)if(wi.hasOwnProperty(yi)){const Ci=yi;xi[Ci]=mi[Ci]||wi[Ci]}}fi.beginPath(),fi.moveTo(ci+xi.tl,hi),fi.lineTo(ci+_i-xi.tr,hi),fi.quadraticCurveTo(ci+_i,hi,ci+_i,hi+xi.tr),fi.lineTo(ci+_i,hi+pi-xi.br),fi.quadraticCurveTo(ci+_i,hi+pi,ci+_i-xi.br,hi+pi),fi.lineTo(ci+xi.bl,hi+pi),fi.quadraticCurveTo(ci,hi+pi,ci,hi+pi-xi.bl),fi.lineTo(ci,hi+xi.tl),fi.quadraticCurveTo(ci,hi,ci+xi.tl,hi),fi.closePath(),vi&&(fi.fillStyle=vi.toString(),fi.fill()),gi&&(fi.strokeStyle=gi.toString(),fi.stroke())}function circle(fi,ci,hi,_i,pi=Color.White,mi=null){fi.beginPath(),fi.arc(ci,hi,_i,0,Math.PI*2),fi.closePath(),mi&&(fi.fillStyle=mi.toString(),fi.fill()),pi&&(fi.strokeStyle=pi.toString(),fi.stroke())}class FontTextInstance{constructor(ci,hi,_i,pi){this.font=ci,this.text=hi,this.color=_i,this.maxWidth=pi,this._textFragments=[],this.disposed=!1,this._dirty=!0,this.canvas=document.createElement("canvas");const mi=this.canvas.getContext("2d");if(!mi)throw new Error("Unable to create FontTextInstance, internal canvas failed to create");this.ctx=mi,this.dimensions=this.measureText(hi),this._setDimension(this.dimensions,this.ctx),this._lastHashCode=this.getHashCode()}measureText(ci,hi){if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);let _i=null;hi!=null?_i=this._getLinesFromText(ci,hi):_i=ci.split(`
`);const pi=_i.reduce((Ei,Si)=>Ei.length>Si.length?Ei:Si);this._applyFont(this.ctx);const mi=this.ctx.measureText(pi);let gi=Math.abs(mi.actualBoundingBoxAscent)+Math.abs(mi.actualBoundingBoxDescent);const vi=gi*_i.length;gi=vi;const xi=vi-Math.abs(mi.actualBoundingBoxAscent),wi=0,yi=0;return new BoundingBox({left:wi-Math.abs(mi.actualBoundingBoxLeft)-this.font.padding,top:yi-Math.abs(mi.actualBoundingBoxAscent)-this.font.padding,bottom:yi+xi+this.font.padding,right:wi+Math.abs(mi.actualBoundingBoxRight)+this.font.padding})}_setDimension(ci,hi){let _i=1;this.font.lineHeight&&(_i=this.font.lineHeight/this.font.size),hi.canvas.width=(ci.width+this.font.padding*2)*2*this.font.quality,hi.canvas.height=(ci.height+this.font.padding*2)*2*this.font.quality*_i}static getHashCode(ci,hi,_i){var pi;return hi+"__hashcode__"+ci.fontString+ci.showDebug+ci.textAlign+ci.baseAlign+ci.direction+ci.lineHeight+JSON.stringify(ci.shadow)+(ci.padding.toString()+ci.smoothing.toString()+ci.lineWidth.toString()+ci.lineDash.toString()+((pi=ci.strokeColor)===null||pi===void 0?void 0:pi.toString())+(_i?_i.toString():ci.color.toString()))}getHashCode(ci=!0){return FontTextInstance.getHashCode(this.font,this.text,ci?this.color:void 0)}_applyRasterProperties(ci){var hi,_i,pi;ci.translate(this.font.padding,this.font.padding),ci.imageSmoothingEnabled=this.font.smoothing,ci.lineWidth=this.font.lineWidth,ci.setLineDash((hi=this.font.lineDash)!==null&&hi!==void 0?hi:ci.getLineDash()),ci.strokeStyle=(pi=(_i=this.font.strokeColor)===null||_i===void 0?void 0:_i.toString())!==null&&pi!==void 0?pi:"",ci.fillStyle=this.color.toString()}_applyFont(ci){ci.resetTransform(),ci.translate(this.font.padding+ci.canvas.width/2,this.font.padding+ci.canvas.height/2),ci.scale(this.font.quality,this.font.quality),ci.textAlign=this.font.textAlign,ci.textBaseline=this.font.baseAlign,ci.font=this.font.fontString,ci.direction=this.font.direction,this.font.shadow&&(this.font.shadow.color&&(ci.shadowColor=this.font.shadow.color.toString()),this.font.shadow.blur&&(ci.shadowBlur=this.font.shadow.blur),this.font.shadow.offset&&(ci.shadowOffsetX=this.font.shadow.offset.x,ci.shadowOffsetY=this.font.shadow.offset.y))}_drawText(ci,hi,_i){this._applyRasterProperties(ci),this._applyFont(ci);for(let pi=0;pi<hi.length;pi++){const mi=hi[pi];this.color&&ci.fillText(mi,0,pi*_i),this.font.strokeColor&&ci.strokeText(mi,0,pi*_i)}this.font.showDebug&&(line(ci,Color.Green,-ci.canvas.width/2,0,ci.canvas.width/2,0,2),line(ci,Color.Red,0,-ci.canvas.height/2,0,ci.canvas.height/2,2))}_splitTextBitmap(ci){const hi=[];let _i=0,pi=0;const mi=Math.min(4096,ci.canvas.width),gi=Math.min(4096,ci.canvas.height);for(;_i<ci.canvas.width;){for(;pi<ci.canvas.height;){const vi=document.createElement("canvas");vi.width=mi,vi.height=gi;const xi=vi.getContext("2d");if(!xi)throw new Error("Unable to split internal FontTextInstance bitmap, failed to create internal canvas");xi.drawImage(ci.canvas,_i,pi,mi,gi,0,0,mi,gi),hi.push({x:_i,y:pi,canvas:vi}),pi+=gi}_i+=mi,pi=0}return hi}flagDirty(){this._dirty=!0}render(ci,hi,_i,pi){var mi;if(this.disposed)throw Error("Accessing disposed text instance! "+this.text);this._ex=ci;const gi=this.getHashCode();if(this._lastHashCode!==gi&&(this._dirty=!0),this._dirty){this.dimensions=this.measureText(this.text,pi),this._setDimension(this.dimensions,this.ctx);const vi=this._getLinesFromText(this.text,pi),xi=(mi=this.font.lineHeight)!==null&&mi!==void 0?mi:this.dimensions.height/vi.length;if(this._drawText(this.ctx,vi,xi),ci instanceof ExcaliburGraphicsContextWebGL)for(const wi of this._textFragments)ci.textureLoader.delete(wi.canvas);if(this._textFragments=this._splitTextBitmap(this.ctx),ci instanceof ExcaliburGraphicsContextWebGL)for(const wi of this._textFragments)ci.textureLoader.load(wi.canvas,{filtering:this.font.filtering},!0);this._lastHashCode=gi,this._dirty=!1}for(const vi of this._textFragments)ci.drawImage(vi.canvas,0,0,vi.canvas.width,vi.canvas.height,vi.x/this.font.quality+hi-this.ctx.canvas.width/this.font.quality/2,vi.y/this.font.quality+_i-this.ctx.canvas.height/this.font.quality/2,vi.canvas.width/this.font.quality,vi.canvas.height/this.font.quality)}dispose(){if(this.disposed=!0,this.dimensions=void 0,this.canvas=void 0,this.ctx=void 0,this._ex instanceof ExcaliburGraphicsContextWebGL)for(const ci of this._textFragments)this._ex.textureLoader.delete(ci.canvas);this._textFragments.length=0}_getLinesFromText(ci,hi){var _i;if(this._cachedText===ci&&this._cachedRenderWidth===hi&&(!((_i=this._cachedLines)===null||_i===void 0)&&_i.length))return this._cachedLines;const pi=ci.split(`
`);if(hi==null)return pi;for(let mi=0;mi<pi.length;mi++){let gi=pi[mi],vi="";if(this.measureText(gi).width>hi){for(;this.measureText(gi).width>hi;)vi=gi[gi.length-1]+vi,gi=gi.slice(0,-1);pi[mi]=gi,pi[mi+1]=vi}}return this._cachedText=ci,this._cachedLines=pi,this._cachedRenderWidth=hi,pi}}class FontCache{static measureText(ci,hi,_i){const pi=FontTextInstance.getHashCode(hi,ci);if(FontCache._MEASURE_CACHE.has(pi))return FontCache._MEASURE_CACHE.get(pi);FontCache._LOGGER.debug("Font text measurement cache miss");const mi=hi.measureTextWithoutCache(ci,_i);return FontCache._MEASURE_CACHE.set(pi,mi),mi}static getTextInstance(ci,hi,_i){const pi=FontTextInstance.getHashCode(hi,ci,_i);let mi=FontCache._TEXT_CACHE.get(pi);return mi||(mi=new FontTextInstance(hi,ci,_i),FontCache._TEXT_CACHE.set(pi,mi),FontCache._LOGGER.debug("Font text instance cache miss")),FontCache._TEXT_USAGE.set(mi,performance.now()),mi}static checkAndClearCache(){const ci=[],hi=new Set;for(const[pi,mi]of FontCache._TEXT_USAGE.entries())if(mi+FontCache.FONT_TIMEOUT<performance.now())FontCache._LOGGER.debug(`Text cache entry timed out ${pi.text}`),ci.push(pi),pi.dispose();else{const gi=pi.getHashCode(!1);hi.add(gi)}ci.forEach(pi=>{FontCache._TEXT_USAGE.delete(pi)}),this._TEXT_CACHE.clear();for(const[pi]of this._TEXT_USAGE.entries())this._TEXT_CACHE.set(pi.getHashCode(),pi);const _i=new Map;for(const pi of hi)FontCache._MEASURE_CACHE.has(pi)&&_i.set(pi,FontCache._MEASURE_CACHE.get(pi));this._MEASURE_CACHE.clear(),this._MEASURE_CACHE=_i}static get cacheSize(){return FontCache._TEXT_USAGE.size}static clearCache(){for(const[ci]of FontCache._TEXT_USAGE.entries())ci.dispose();FontCache._TEXT_USAGE.clear(),FontCache._TEXT_CACHE.clear(),FontCache._MEASURE_CACHE.clear()}}FontCache.FONT_TIMEOUT=500;FontCache._LOGGER=Logger.getInstance();FontCache._TEXT_USAGE=new Map;FontCache._TEXT_CACHE=new Map;FontCache._MEASURE_CACHE=new Map;class Font extends Graphic{constructor(ci={}){var hi,_i,pi,mi,gi,vi,xi,wi,yi,Ci,Ei,Si,ki,Ai,Ii,Ti,Pi,Li,Ri,Di;super(ci),this.filtering=ImageFiltering.Blended,this.quality=2,this.padding=2,this.smoothing=!1,this.lineWidth=1,this.lineDash=[],this.color=Color.Black,this.family="sans-serif",this.style=FontStyle.Normal,this.bold=!1,this.unit=FontUnit.Px,this.textAlign=TextAlign.Left,this.baseAlign=BaseAlign.Top,this.direction=Direction.LeftToRight,this.lineHeight=void 0,this.size=10,this._textBounds=new BoundingBox,this._textMeasurement=new FontTextInstance(this,"",Color.Black),this.smoothing=(hi=ci==null?void 0:ci.smoothing)!==null&&hi!==void 0?hi:this.smoothing,this.padding=(_i=ci==null?void 0:ci.padding)!==null&&_i!==void 0?_i:this.padding,this.color=(pi=ci==null?void 0:ci.color)!==null&&pi!==void 0?pi:this.color,this.strokeColor=(mi=ci==null?void 0:ci.strokeColor)!==null&&mi!==void 0?mi:this.strokeColor,this.lineDash=(gi=ci==null?void 0:ci.lineDash)!==null&&gi!==void 0?gi:this.lineDash,this.lineWidth=(vi=ci==null?void 0:ci.lineWidth)!==null&&vi!==void 0?vi:this.lineWidth,this.filtering=(xi=ci==null?void 0:ci.filtering)!==null&&xi!==void 0?xi:this.filtering,this.family=(wi=ci==null?void 0:ci.family)!==null&&wi!==void 0?wi:this.family,this.style=(yi=ci==null?void 0:ci.style)!==null&&yi!==void 0?yi:this.style,this.bold=(Ci=ci==null?void 0:ci.bold)!==null&&Ci!==void 0?Ci:this.bold,this.size=(Ei=ci==null?void 0:ci.size)!==null&&Ei!==void 0?Ei:this.size,this.unit=(Si=ci==null?void 0:ci.unit)!==null&&Si!==void 0?Si:this.unit,this.textAlign=(ki=ci==null?void 0:ci.textAlign)!==null&&ki!==void 0?ki:this.textAlign,this.baseAlign=(Ai=ci==null?void 0:ci.baseAlign)!==null&&Ai!==void 0?Ai:this.baseAlign,this.direction=(Ii=ci==null?void 0:ci.direction)!==null&&Ii!==void 0?Ii:this.direction,this.lineHeight=(Ti=ci==null?void 0:ci.lineHeight)!==null&&Ti!==void 0?Ti:this.lineHeight,this.quality=(Pi=ci==null?void 0:ci.quality)!==null&&Pi!==void 0?Pi:this.quality,ci!=null&&ci.shadow&&(this.shadow={},this.shadow.blur=(Li=ci.shadow.blur)!==null&&Li!==void 0?Li:this.shadow.blur,this.shadow.offset=(Ri=ci.shadow.offset)!==null&&Ri!==void 0?Ri:this.shadow.offset,this.shadow.color=(Di=ci.shadow.color)!==null&&Di!==void 0?Di:this.shadow.color)}clone(){return new Font({...this.cloneGraphicOptions(),size:this.size,unit:this.unit,family:this.family,style:this.style,bold:this.bold,textAlign:this.textAlign,baseAlign:this.baseAlign,direction:this.direction,shadow:this.shadow?{blur:this.shadow.blur,offset:this.shadow.offset,color:this.shadow.color}:void 0})}get fontString(){return`${this.style} ${this.bold?"bold":""} ${this.size}${this.unit} ${this.family}`}get localBounds(){return this._textBounds}_drawImage(ci,hi,_i){}_rotate(ci){var hi;const _i=(hi=this.origin)!==null&&hi!==void 0?hi:this._textBounds.center;ci.translate(_i.x,_i.y),ci.rotate(this.rotation),ci.translate(-_i.x,-_i.y)}_flip(ci){this.flipHorizontal&&(ci.translate(this._textBounds.width/this.scale.x,0),ci.scale(-1,1)),this.flipVertical&&(ci.translate(0,-this._textBounds.height/2/this.scale.y),ci.scale(1,-1))}measureTextWithoutCache(ci,hi){return this._textMeasurement.measureText(ci,hi)}measureText(ci,hi){return FontCache.measureText(ci,this,hi)}_postDraw(ci){ci.restore()}render(ci,hi,_i,pi,mi,gi){const vi=FontCache.getTextInstance(hi,this,_i);this._textBounds=vi.dimensions,this._preDraw(ci,pi,mi),vi.render(ci,pi,mi,gi),this._postDraw(ci)}}class Text extends Graphic{constructor(ci){var hi,_i;super(ci),this._text="",this._textWidth=0,this._textHeight=0,this.font=(hi=ci.font)!==null&&hi!==void 0?hi:new Font,this.color=(_i=ci.color)!==null&&_i!==void 0?_i:this.color,this.text=ci.text,this.maxWidth=ci.maxWidth}clone(){var ci,hi;return new Text({text:this.text.slice(),color:(hi=(ci=this.color)===null||ci===void 0?void 0:ci.clone())!==null&&hi!==void 0?hi:Color.Black,font:this.font.clone(),maxWidth:this.maxWidth})}get text(){return this._text}set text(ci){this._text=ci,this._calculateDimension()}get font(){return this._font}set font(ci){this._font=ci}get width(){return this._textWidth===0&&this._calculateDimension(),this._textWidth*this.scale.x}get height(){return this._textHeight===0&&this._calculateDimension(),this._textHeight*this.scale.y}_calculateDimension(){const{width:ci,height:hi}=this.font.measureText(this._text,this.maxWidth);this._textWidth=ci,this._textHeight=hi}get localBounds(){return this.font.measureText(this._text,this.maxWidth).scale(this.scale)}_rotate(ci){}_flip(ci){}_preDraw(ci,hi,_i){(this.isStale()||this.font.isStale())&&(this.font.flipHorizontal=this.flipHorizontal,this.font.flipVertical=this.flipVertical,this.font.rotation=this.rotation,this.font.origin=this.origin,this.font.opacity=this.opacity),this.font.tint=this.tint,super._preDraw(ci,hi,_i)}_drawImage(ci,hi,_i){var pi;let mi=Color.Black;this.font instanceof Font&&(mi=(pi=this.color)!==null&&pi!==void 0?pi:this.font.color);const{width:gi,height:vi}=this.font.measureText(this._text,this.maxWidth);this._textWidth=gi,this._textHeight=vi,this.font.render(ci,this._text,mi,hi,_i,this.maxWidth),this.font.showDebug&&(ci.debug.drawRect(hi-gi,_i-vi,gi*2,vi*2),this.maxWidth!=null&&ci.debug.drawRect(hi,_i,this.maxWidth,this.height,{color:Color.Yellow}))}}function hasGraphicsTick(fi){return!!fi.tick}class GraphicsComponent extends Component{get visible(){return this.isVisible}set visible(ci){this.isVisible=ci}get offset(){return this._offset}set offset(ci){this._offset=new WatchVector(ci,()=>this.recalculateBounds()),this.recalculateBounds()}get anchor(){return this._anchor}set anchor(ci){this._anchor=new WatchVector(ci,()=>this.recalculateBounds()),this.recalculateBounds()}get color(){return this._color}set color(ci){if(ci){this._color=ci.clone();const hi=this.graphics.current;(hi instanceof Raster||hi instanceof Text)&&(hi.color=this._color)}}constructor(ci){super(),this._logger=Logger.getInstance(),this._current="default",this._graphics={},this._options={},this.material=null,this.isVisible=!0,this.forceOnScreen=!1,this.opacity=1,this._offset=new WatchVector(Vector.Zero,()=>this.recalculateBounds()),this._anchor=new WatchVector(Vector.Half,()=>this.recalculateBounds()),this.flipHorizontal=!1,this.flipVertical=!1,this.copyGraphics=!1,ci={visible:this.isVisible,graphics:{},...ci};const{current:hi,anchor:_i,color:pi,opacity:mi,visible:gi,graphics:vi,offset:xi,copyGraphics:wi,onPreDraw:yi,onPostDraw:Ci,onPreTransformDraw:Ei,onPostTransformDraw:Si}=ci;for(const[ki,Ai]of Object.entries(vi))Ai instanceof Graphic?this._graphics[ki]=Ai:(this._graphics[ki]=Ai.graphic,this._options[ki]=Ai.options);this.offset=xi??this.offset,this.opacity=mi??this.opacity,this.anchor=_i??this.anchor,this.color=pi??this.color,this.copyGraphics=wi??this.copyGraphics,this.onPreDraw=yi??this.onPreDraw,this.onPostDraw=Ci??this.onPostDraw,this.onPreDraw=Ei??this.onPreTransformDraw,this.onPostTransformDraw=Si??this.onPostTransformDraw,this.isVisible=!!gi,this._current=hi??this._current,hi&&this._graphics[hi]&&this.use(hi)}getGraphic(ci){return this._graphics[ci]}getOptions(ci){return this._options[ci]}getNames(){return Object.keys(this._graphics)}get current(){return this._graphics[this._current]}get currentOptions(){return this._options[this._current]}get graphics(){return this._graphics}get options(){return this._options}add(ci,hi,_i){let pi="default",mi=null,gi;if(typeof ci=="string"&&hi instanceof Graphic&&(pi=ci,mi=hi,gi=_i),ci instanceof Graphic&&!(hi instanceof Graphic)&&(mi=ci,gi=hi),!mi)throw new Error("Need to provide a graphic or valid graphic string");return this._graphics[pi]=this.copyGraphics?mi.clone():mi,this._options[pi]=this.copyGraphics?{...gi}:gi,pi==="default"&&this.use("default"),mi}remove(ci){delete this._graphics[ci],delete this._options[ci],this._current===ci&&(this._current="default",this.recalculateBounds())}use(ci,hi){var _i;if(ci instanceof Graphic){let pi=ci;this.copyGraphics&&(pi=ci.clone()),this._current="default",this._graphics[this._current]=pi,this._options[this._current]=hi}else this._current=ci,this._options[this._current]=hi,this._current in this._graphics||this._logger.warn(`Graphic ${this._current} is not registered with the graphics component owned by ${(_i=this.owner)===null||_i===void 0?void 0:_i.name}. Nothing will be drawn.`);return this.recalculateBounds(),this.current}hide(){this._current="ex.none"}set localBounds(ci){this._localBounds=ci}recalculateBounds(){let ci=new BoundingBox;const hi=this._graphics[this._current],_i=this._options[this._current];if(!hi){this._localBounds=ci;return}let pi=this.anchor,mi=this.offset;_i!=null&&_i.anchor&&(pi=_i.anchor),_i!=null&&_i.offset&&(mi=_i.offset);const gi=hi.localBounds,vi=-gi.width*pi.x+mi.x,xi=-gi.height*pi.y+mi.y;hi instanceof GraphicsGroup&&!hi.useAnchor?ci=hi==null?void 0:hi.localBounds.combine(ci):ci=hi==null?void 0:hi.localBounds.translate(vec(vi,xi)).combine(ci),this._localBounds=ci}get localBounds(){return(!this._localBounds||this._localBounds.hasZeroDimensions())&&this.recalculateBounds(),this._localBounds}get bounds(){let ci=this.localBounds;if(this.owner){const hi=this.owner.get(TransformComponent);hi&&(ci=ci.transform(hi.get().matrix))}return ci}update(ci,hi=0){const _i=this.current;_i&&hasGraphicsTick(_i)&&_i.tick(ci,hi)}clone(){const ci=new GraphicsComponent;return ci._graphics={...this._graphics},ci._options={...this._options},ci.offset=this.offset.clone(),this.color&&(ci.color=this.color.clone()),ci.opacity=this.opacity,ci.anchor=this.anchor.clone(),ci.copyGraphics=this.copyGraphics,ci.onPreDraw=this.onPreDraw,ci.onPostDraw=this.onPostDraw,ci.isVisible=this.isVisible,ci}}var EventTypes;(function(fi){fi.Kill="kill",fi.PreKill="prekill",fi.PostKill="postkill",fi.PreDraw="predraw",fi.PostDraw="postdraw",fi.PreDebugDraw="predebugdraw",fi.PostDebugDraw="postdebugdraw",fi.PreUpdate="preupdate",fi.PostUpdate="postupdate",fi.PreFrame="preframe",fi.PostFrame="postframe",fi.PreCollision="precollision",fi.CollisionStart="collisionstart",fi.CollisionEnd="collisionend",fi.PostCollision="postcollision",fi.Initialize="initialize",fi.Activate="activate",fi.Deactivate="deactivate",fi.ExitViewport="exitviewport",fi.EnterViewport="enterviewport",fi.ExitTrigger="exit",fi.EnterTrigger="enter",fi.Connect="connect",fi.Disconnect="disconnect",fi.Button="button",fi.Axis="axis",fi.Visible="visible",fi.Hidden="hidden",fi.Start="start",fi.Stop="stop",fi.PointerUp="pointerup",fi.PointerDown="pointerdown",fi.PointerMove="pointermove",fi.PointerEnter="pointerenter",fi.PointerLeave="pointerleave",fi.PointerCancel="pointercancel",fi.PointerWheel="pointerwheel",fi.Up="up",fi.Down="down",fi.Move="move",fi.Enter="enter",fi.Leave="leave",fi.Cancel="cancel",fi.Wheel="wheel",fi.Press="press",fi.Release="release",fi.Hold="hold",fi.PointerDragStart="pointerdragstart",fi.PointerDragEnd="pointerdragend",fi.PointerDragEnter="pointerdragenter",fi.PointerDragLeave="pointerdragleave",fi.PointerDragMove="pointerdragmove",fi.ActionStart="actionstart",fi.ActionComplete="actioncomplete",fi.Add="add",fi.Remove="remove"})(EventTypes||(EventTypes={}));class GameEvent{constructor(){this.other=null,this._bubbles=!0}get bubbles(){return this._bubbles}set bubbles(ci){this._bubbles=ci}stopPropagation(){this.bubbles=!1}}class KillEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class PreKillEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class PostKillEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class GameStartEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class GameStopEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class PreDrawEvent extends GameEvent{constructor(ci,hi,_i){super(),this.ctx=ci,this.elapsed=hi,this.self=_i,this.target=_i}}class PostDrawEvent extends GameEvent{constructor(ci,hi,_i){super(),this.ctx=ci,this.elapsed=hi,this.self=_i,this.target=_i}}class PreTransformDrawEvent extends GameEvent{constructor(ci,hi,_i){super(),this.ctx=ci,this.elapsed=hi,this.self=_i,this.target=_i}}class PostTransformDrawEvent extends GameEvent{constructor(ci,hi,_i){super(),this.ctx=ci,this.elapsed=hi,this.self=_i,this.target=_i}}class PreDebugDrawEvent extends GameEvent{constructor(ci,hi){super(),this.ctx=ci,this.self=hi,this.target=hi}}class PostDebugDrawEvent extends GameEvent{constructor(ci,hi){super(),this.ctx=ci,this.self=hi,this.target=hi}}class PreUpdateEvent extends GameEvent{constructor(ci,hi,_i){super(),this.engine=ci,this.elapsed=hi,this.self=_i,this.target=_i}}class PostUpdateEvent extends GameEvent{constructor(ci,hi,_i){super(),this.engine=ci,this.elapsed=hi,this.self=_i,this.target=_i}}class PreFrameEvent extends GameEvent{constructor(ci,hi){super(),this.engine=ci,this.prevStats=hi,this.target=ci}}class PostFrameEvent extends GameEvent{constructor(ci,hi){super(),this.engine=ci,this.stats=hi,this.target=ci}}class GamepadConnectEvent extends GameEvent{constructor(ci,hi){super(),this.index=ci,this.gamepad=hi,this.target=hi}}class GamepadDisconnectEvent extends GameEvent{constructor(ci,hi){super(),this.index=ci,this.gamepad=hi,this.target=hi}}class GamepadButtonEvent extends GameEvent{constructor(ci,hi,_i,pi){super(),this.button=ci,this.index=hi,this.value=_i,this.self=pi,this.target=pi}}class GamepadAxisEvent extends GameEvent{constructor(ci,hi,_i){super(),this.axis=ci,this.value=hi,this.self=_i,this.target=_i}}class VisibleEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class HiddenEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class PreCollisionEvent extends GameEvent{constructor(ci,hi,_i,pi,mi){super(),this.self=ci,this.other=hi,this.side=_i,this.intersection=pi,this.contact=mi,this.target=ci}}class PostCollisionEvent extends GameEvent{constructor(ci,hi,_i,pi,mi){super(),this.self=ci,this.other=hi,this.side=_i,this.intersection=pi,this.contact=mi,this.target=ci}}class ContactStartEvent{constructor(ci,hi,_i,pi){this.self=ci,this.other=hi,this.side=_i,this.contact=pi}}class ContactEndEvent{constructor(ci,hi,_i,pi){this.self=ci,this.other=hi,this.side=_i,this.lastContact=pi}}class CollisionPreSolveEvent{constructor(ci,hi,_i,pi,mi){this.self=ci,this.other=hi,this.side=_i,this.intersection=pi,this.contact=mi}}class CollisionPostSolveEvent{constructor(ci,hi,_i,pi,mi){this.self=ci,this.other=hi,this.side=_i,this.intersection=pi,this.contact=mi}}class CollisionStartEvent extends GameEvent{constructor(ci,hi,_i,pi){super(),this.self=ci,this.other=hi,this.side=_i,this.contact=pi,this.target=ci}}class CollisionEndEvent extends GameEvent{constructor(ci,hi,_i,pi){super(),this.self=ci,this.other=hi,this.side=_i,this.lastContact=pi,this.target=ci}}class InitializeEvent extends GameEvent{constructor(ci,hi){super(),this.engine=ci,this.self=hi,this.target=hi}}class ActivateEvent extends GameEvent{constructor(ci,hi){super(),this.context=ci,this.self=hi,this.target=hi}}class DeactivateEvent extends GameEvent{constructor(ci,hi){super(),this.context=ci,this.self=hi,this.target=hi}}class ExitViewPortEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class EnterViewPortEvent extends GameEvent{constructor(ci){super(),this.self=ci,this.target=ci}}class EnterTriggerEvent extends GameEvent{constructor(ci,hi){super(),this.self=ci,this.entity=hi,this.target=ci}}class ExitTriggerEvent extends GameEvent{constructor(ci,hi){super(),this.self=ci,this.entity=hi,this.target=ci}}class ActionStartEvent extends GameEvent{constructor(ci,hi){super(),this.action=ci,this.self=hi,this.target=hi}}class ActionCompleteEvent extends GameEvent{constructor(ci,hi){super(),this.action=ci,this.self=hi,this.target=hi}}class AddEvent extends GameEvent{constructor(ci,hi){super(),this.engine=ci,this.self=hi,this.target=hi}}class RemoveEvent extends GameEvent{constructor(ci,hi){super(),this.engine=ci,this.self=hi,this.target=hi}}class AddedComponent{constructor(ci){this.data=ci,this.type="Component Added"}}function isAddedComponent(fi){return!!fi&&fi.type==="Component Added"}class RemovedComponent{constructor(ci){this.data=ci,this.type="Component Removed"}}function isRemovedComponent(fi){return!!fi&&fi.type==="Component Removed"}const EntityEvents={Add:"add",Remove:"remove",Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate",Kill:"kill"};class Entity{constructor(ci,hi){this.id=Entity._ID++,this.name=`Entity#${this.id}`,this.events=new EventEmitter,this._tags=new Set,this.componentAdded$=new Observable,this.componentRemoved$=new Observable,this.tagAdded$=new Observable,this.tagRemoved$=new Observable,this.components=new Map,this.componentValues=[],this._componentsToRemove=[],this.scene=null,this.isActive=!0,this._parent=null,this.childrenAdded$=new Observable,this.childrenRemoved$=new Observable,this._children=[],this._isInitialized=!1,this._isAdded=!1;let _i,pi;if(Array.isArray(ci))_i=ci,pi=hi;else if(ci&&typeof ci=="object"){const{components:mi,name:gi,silenceWarnings:vi}=ci;_i=mi??[],pi=gi}if(pi&&(this.name=pi),_i)for(const mi of _i)this.addComponent(mi)}get active(){return this.isActive}set active(ci){this.isActive=ci}kill(){this.isActive&&(this.isActive=!1,this.unparent()),this.emit("kill",new KillEvent(this))}isKilled(){return!this.isActive}get tags(){return this._tags}hasTag(ci){return this._tags.has(ci)}addTag(ci){return this._tags.add(ci),this.tagAdded$.notifyAll(ci),this}removeTag(ci){return this._tags.delete(ci),this.tagRemoved$.notifyAll(ci),this}get types(){return Array.from(this.components.keys())}getComponents(){return Array.from(this.components.values())}hasAll(ci){for(let hi=0;hi<ci.length;hi++)if(!this.components.has(ci[hi]))return!1;return!0}hasAllTags(ci){for(let hi=0;hi<ci.length;hi++)if(!this.tags.has(ci[hi]))return!1;return!0}get(ci){return this.components.get(ci)}get parent(){return this._parent}get children(){return this._children}unparent(){this._parent&&(this._parent.removeChild(this),this._parent=null)}addChild(ci){if(ci.parent===null){if(this.getAncestors().includes(ci))throw new Error("Cycle detected, cannot add entity");this._children.push(ci),ci._parent=this,this.childrenAdded$.notifyAll(ci)}else throw new Error("Entity already has a parent, cannot add without unparenting");return this}removeChild(ci){return ci.parent===this&&(removeItemFromArray(ci,this._children),ci._parent=null,this.childrenRemoved$.notifyAll(ci)),this}removeAllChildren(){for(let ci=this.children.length-1;ci>=0;ci--)this.removeChild(this.children[ci]);return this}getAncestors(){const ci=[this];let hi=this.parent;for(;hi;)ci.push(hi),hi=hi.parent;return ci.reverse()}getDescendants(){let ci=[this],hi=[this];for(;hi.length>0;){const _i=hi.pop();_i&&(hi=hi.concat(_i.children),ci=ci.concat(_i.children))}return ci}clone(){const ci=new Entity;for(const hi of this.types){const _i=this.get(hi);_i&&ci.addComponent(_i.clone())}for(const hi of this.children)ci.addChild(hi.clone());return ci}addTemplate(ci,hi=!1){for(const _i of ci.getComponents())this.addComponent(_i.clone(),hi);for(const _i of ci.children)this.addChild(_i.clone().addTemplate(_i));return this}_getClassHierarchyRoot(ci){var hi,_i;let pi=ci,mi=(hi=Object.getPrototypeOf(pi.prototype))===null||hi===void 0?void 0:hi.constructor;for(;mi&&mi!==Object&&mi!==Component;)pi=mi,mi=(_i=Object.getPrototypeOf(pi.prototype))===null||_i===void 0?void 0:_i.constructor;return pi}addComponent(ci,hi=!1){if(this.has(ci.constructor))if(hi)this.removeComponent(ci.constructor,!0);else return this;if(ci.dependencies&&ci.dependencies.length)for(const pi of ci.dependencies)this.addComponent(new pi);ci.owner=this;const _i=this._getClassHierarchyRoot(ci.constructor);return this.components.set(_i,ci),this.components.set(ci.constructor,ci),this.componentValues.push(ci),ci.onAdd&&ci.onAdd(this),this.componentAdded$.notifyAll(ci),this}removeComponent(ci,hi=!1){let _i;if(isComponentCtor(ci)?_i=ci:_i=ci.constructor,hi){const pi=this.components.get(_i);if(pi){this.componentRemoved$.notifyAll(pi),pi.owner=void 0,pi.onRemove&&pi.onRemove(this);const gi=this.componentValues.indexOf(pi);gi>-1&&this.componentValues.splice(gi,1)}const mi=this._getClassHierarchyRoot(_i);this.components.delete(mi),this.components.delete(_i)}else this._componentsToRemove.push(_i);return this}clearComponents(){const ci=this.types;for(const hi of ci)this.removeComponent(hi)}processComponentRemoval(){for(const ci of this._componentsToRemove)this.removeComponent(ci,!0);this._componentsToRemove.length=0}has(ci){return this.components.has(ci)}get isInitialized(){return this._isInitialized}get isAdded(){return this._isAdded}_initialize(ci){this.isInitialized||(this.onInitialize(ci),this.events.emit("initialize",new InitializeEvent(ci,this)),this._isInitialized=!0)}_add(ci){!this.isAdded&&this.isActive&&(this.onAdd(ci),this.events.emit("add",new AddEvent(ci,this)),this._isAdded=!0)}_remove(ci){this.isAdded&&!this.isActive&&(this.onRemove(ci),this.events.emit("remove",new RemoveEvent(ci,this)),this._isAdded=!1)}_preupdate(ci,hi){this.events.emit("preupdate",new PreUpdateEvent(ci,hi,this)),this.onPreUpdate(ci,hi)}_postupdate(ci,hi){this.events.emit("postupdate",new PostUpdateEvent(ci,hi,this)),this.onPostUpdate(ci,hi)}onInitialize(ci){}onAdd(ci){}onRemove(ci){}onPreUpdate(ci,hi){}onPostUpdate(ci,hi){}update(ci,hi){this._initialize(ci),this._add(ci),this._preupdate(ci,hi);for(const _i of this.children)_i.update(ci,hi);this._postupdate(ci,hi),this._remove(ci)}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){hi?this.events.off(ci,hi):this.events.off(ci)}}Entity._ID=0;class MotionComponent extends Component{constructor(){super(...arguments),this.vel=Vector.Zero,this.acc=Vector.Zero,this.scaleFactor=Vector.Zero,this.angularVelocity=0,this.torque=0,this.inertia=1}}class EulerIntegrator{static integrate(ci,hi,_i,pi){const mi=pi/1e3;hi.vel.addEqual(_i.scale(mi,EulerIntegrator._ACC)),ci.pos.add(hi.vel.scale(mi,EulerIntegrator._VEL),EulerIntegrator._POS).addEqual(_i.scale(.5*mi*mi,EulerIntegrator._VEL_ACC)),hi.angularVelocity+=hi.torque*(1/hi.inertia)*mi;const gi=ci.rotation+hi.angularVelocity*mi;ci.scale.add(hi.scaleFactor.scale(mi,this._SCALE_FACTOR),EulerIntegrator._SCALE),ci.get().setTransform(EulerIntegrator._POS,gi,EulerIntegrator._SCALE)}}EulerIntegrator._POS=new Vector(0,0);EulerIntegrator._SCALE=new Vector(1,1);EulerIntegrator._ACC=new Vector(0,0);EulerIntegrator._VEL=new Vector(0,0);EulerIntegrator._VEL_ACC=new Vector(0,0);EulerIntegrator._SCALE_FACTOR=new Vector(0,0);class Particle extends Entity{constructor(ci){super({silenceWarnings:!0}),this.beginColor=Color.White,this.endColor=Color.White,this.life=300,this.fade=!1,this._rRate=1,this._gRate=1,this._bRate=1,this._aRate=0,this._currentColor=Color.White,this.size=5,this.sizeRate=0,this.visible=!0,this.isOffscreen=!1,this.particleTransform=ParticleTransform.Global,this.name=`Particle#${this.id}`,this.addComponent(this.transform=new TransformComponent),this.addComponent(this.motion=new MotionComponent),this.addComponent(this.graphics=new GraphicsComponent),this.configure(ci)}registerEmitter(ci){if(this._emitter=ci,this.particleTransform===ParticleTransform.Global){const hi=this._emitter.transform.globalPos;this.transform.pos=this.transform.pos.add(hi),this.motion.vel=this.motion.vel.rotate(this._emitter.transform.globalRotation)}}configure(ci){var hi,_i,pi,mi,gi,vi,xi,wi,yi,Ci,Ei,Si,ki,Ai;this.particleTransform=(hi=ci.transform)!==null&&hi!==void 0?hi:this.particleTransform,this.life=(_i=ci.life)!==null&&_i!==void 0?_i:this.life,this.fade=(pi=ci.fade)!==null&&pi!==void 0?pi:this.fade,this.size=(mi=ci.size)!==null&&mi!==void 0?mi:this.size,this.endColor=(gi=ci.endColor)!==null&&gi!==void 0?gi:this.endColor.clone(),this.beginColor=(vi=ci.beginColor)!==null&&vi!==void 0?vi:this.beginColor.clone(),this._currentColor=this.beginColor.clone(),this.graphic=ci.graphic,this.graphics.opacity=(xi=ci.opacity)!==null&&xi!==void 0?xi:this.graphics.opacity,this.transform.pos=(wi=ci.pos)!==null&&wi!==void 0?wi:this.transform.pos,this.transform.rotation=(yi=ci.rotation)!==null&&yi!==void 0?yi:0,this.transform.scale=vec(1,1),this.motion.vel=(Ci=ci.vel)!==null&&Ci!==void 0?Ci:this.motion.vel,this.motion.angularVelocity=(Ei=ci.angularVelocity)!==null&&Ei!==void 0?Ei:0,this.motion.acc=(Si=ci.acc)!==null&&Si!==void 0?Si:this.motion.acc,this._rRate=(this.endColor.r-this.beginColor.r)/this.life,this._gRate=(this.endColor.g-this.beginColor.g)/this.life,this._bRate=(this.endColor.b-this.beginColor.b)/this.life,this._aRate=this.graphics.opacity/this.life,this.startSize=(ki=ci.startSize)!==null&&ki!==void 0?ki:0,this.endSize=(Ai=ci.endSize)!==null&&Ai!==void 0?Ai:0,this.endSize>0&&this.startSize>0&&(this.sizeRate=(this.endSize-this.startSize)/this.life,this.size=this.startSize),this.graphic?(this.graphics.use(this.graphic),this.graphics.onPostDraw=void 0):(this.graphics.localBounds=BoundingBox.fromDimension(this.size,this.size,Vector.Half),this.graphics.onPostDraw=Ii=>{Ii.save(),Ii.debug.drawPoint(vec(0,0),{color:this._currentColor,size:this.size}),Ii.restore()})}kill(){var ci;!((ci=this._emitter)===null||ci===void 0)&&ci.isActive?this._emitter.removeParticle(this):super.kill()}update(ci,hi){this.life=this.life-hi,this.life<0&&this.kill(),this.fade&&(this.graphics.opacity=clamp(this._aRate*this.life,1e-4,1)),this.startSize&&this.endSize&&this.startSize>0&&this.endSize>0&&(this.size=clamp(this.sizeRate*hi+this.size,Math.min(this.startSize,this.endSize),Math.max(this.startSize,this.endSize))),this._currentColor.r=clamp(this._currentColor.r+this._rRate*hi,0,255),this._currentColor.g=clamp(this._currentColor.g+this._gRate*hi,0,255),this._currentColor.b=clamp(this._currentColor.b+this._bRate*hi,0,255),this._currentColor.a=this.graphics.opacity;let _i=this.motion.acc;this.focus&&(_i=this.focus.sub(this.transform.pos).normalize().scale(this.focusAccel||0).scale(hi/1e3)),EulerIntegrator.integrate(this.transform,this.motion,_i,hi)}}Particle.DefaultConfig={beginColor:Color.White,endColor:Color.White,life:300,fade:!1,size:5,graphic:void 0,startSize:void 0,endSize:void 0};var ParticleTransform;(function(fi){fi.Global="global",fi.Local="local"})(ParticleTransform||(ParticleTransform={}));class ParticleRenderer{constructor(){this.type="ex.particle",this.priority=0}initialize(ci,hi){this._gl=ci,this._context=hi,this._shader=new Shader({gl:ci,vertexSource:particle_vertex,fragmentSource:particle_fragment,onPreLink:_i=>{ci.transformFeedbackVaryings(_i,["finalPosition","finalVelocity","finalRotation","finalAngularVelocity","finalLifeMs"],ci.INTERLEAVED_ATTRIBS)}}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho)}_getTexture(ci){const hi=ci.getAttribute(ImageSourceAttributeConstants.Filtering),_i=hi?parseImageFiltering(hi):void 0,pi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingX)),mi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingY)),gi=ci.getAttribute("forceUpload")==="true",vi=this._context.textureLoader.load(ci,{filtering:_i,wrapping:{x:pi,y:mi}},gi);return ci.removeAttribute("forceUpload"),vi}draw(ci,hi){var _i,pi,mi,gi,vi,xi,wi,yi,Ci;const Ei=this._gl;this._shader.use(),this._shader.setUniformMatrix("u_matrix",this._context.ortho);const Si=ci.particle.transform===ParticleTransform.Local?this._context.getTransform():this._context.getTransform().multiply(ci.emitter.transform.get().inverse);this._shader.setUniformAffineMatrix("u_transform",Si),this._shader.setUniformBoolean("fade",!!ci.particle.fade),this._shader.setUniformBoolean("useTexture",!!ci.particle.graphic),this._shader.setUniformFloat("maxLifeMs",(_i=ci.particle.life)!==null&&_i!==void 0?_i:2e3),this._shader.setUniformFloat("deltaMs",hi),this._shader.setUniformFloatVector("gravity",(pi=ci.particle.acc)!==null&&pi!==void 0?pi:vec(0,0)),this._shader.setUniformFloatColor("beginColor",(mi=ci.particle.beginColor)!==null&&mi!==void 0?mi:Color.Transparent),this._shader.setUniformFloatColor("endColor",(gi=ci.particle.endColor)!==null&&gi!==void 0?gi:Color.Transparent);let ki=(vi=ci.particle.startSize)!==null&&vi!==void 0?vi:0,Ai=(xi=ci.particle.endSize)!==null&&xi!==void 0?xi:0;const Ii=(wi=ci.particle.size)!==null&&wi!==void 0?wi:0;if(Ii>0&&(ki=Ii,Ai=Ii),this._shader.setUniformFloat("startSize",ki??10),this._shader.setUniformFloat("endSize",Ai??10),this._shader.setUniformFloat("startOpacity",(yi=ci.particle.opacity)!==null&&yi!==void 0?yi:1),ci.particle.focus&&(this._shader.setUniformFloatVector("focus",ci.particle.focus),this._shader.setUniformFloat("focusAccel",(Ci=ci.particle.focusAccel)!==null&&Ci!==void 0?Ci:0)),ci.particle.graphic){const Ti=ci.particle.graphic,Pi=this._getTexture(Ti.image.image);Ei.activeTexture(Ei.TEXTURE0),Ei.bindTexture(Ei.TEXTURE_2D,Pi),this._shader.setUniformInt("graphic",0)}ci.draw(Ei)}hasPendingDraws(){return!1}flush(){}dispose(){}}const image_renderer_v2_frag=`#version 300 es\r
precision mediump float;\r
\r
// UV coord\r
in vec2 v_texcoord;\r
\r
// Textures in the current draw\r
uniform sampler2D u_textures[%%count%%];\r
\r
uniform bool u_pixelart;\r
\r
in float v_texture_index;\r
\r
in float v_opacity;\r
\r
in vec4 v_tint;\r
\r
// texture resolution\r
in vec2 v_res;\r
\r
in vec2 v_size;\r
\r
in vec2 v_uv_min;\r
in vec2 v_uv_max;\r
\r
out vec4 fragColor;\r
\r
// Inigo Quilez pixel art filter https://jorenjoestar.github.io/post/pixel_art_filtering/\r
vec2 uv_iq(in vec2 uv, in vec2 texture_size) {\r
  vec2 pixel = uv * texture_size;\r
\r
  vec2 seam=floor(pixel+.5);\r
  vec2 dudv=fwidth(pixel);\r
  pixel=seam+clamp((pixel-seam)/dudv,-.5,.5);\r
\r
  return pixel/texture_size;\r
}\r
\r
float lerp(float from, float to, float rel){\r
  return ((1. - rel) * from) + (rel * to);\r
}\r
\r
float invLerp(float from, float to, float value){\r
  return (value - from) / (to - from);\r
}\r
\r
float remap(float origFrom, float origTo, float targetFrom, float targetTo, float value){\r
  float rel = invLerp(origFrom, origTo, value);\r
  return lerp(targetFrom, targetTo, rel);\r
}\r
\r
void main(){\r
  // In order to support the most efficient sprite batching, we have multiple\r
  // textures loaded into the gpu (usually 8) this picker logic skips over textures\r
  // that do not apply to a particular sprite.\r
\r
  vec4 color=vec4(1.,0,0,1.);\r
  vec2 remapped_uv = v_texcoord;\r
  remapped_uv.x = remap(0.,1., v_uv_min.x, v_uv_max.x, v_texcoord.x);\r
  remapped_uv.y = remap(0.,1., v_uv_min.y, v_uv_max.y, v_texcoord.y);\r
  vec2 uv = u_pixelart ? uv_iq(remapped_uv, v_size) : remapped_uv;\r
\r
  // GLSL is templated out to pick the right texture and set the vec4 color\r
  %%texture_picker%%\r
\r
  color.rgb = color.rgb * v_opacity;\r
  color.a = color.a * v_opacity;\r
  fragColor = color * v_tint;\r
}`,image_renderer_v2_vert=`#version 300 es\r
layout(location=0) in vec2 pos;\r
layout(location=1) in vec2 a_texcoord;\r
out vec2 v_texcoord;\r
\r
layout(location=2) in vec2 a_offset;\r
layout(location=3) in vec2 a_mat_column1;\r
layout(location=4) in vec2 a_mat_column2;\r
layout(location=5) in vec2 a_mat_column3;\r
\r
layout(location=6) in float a_opacity;\r
out float v_opacity;\r
\r
// Texture resolution (could be bigger than a_size)\r
layout(location=7) in vec2 a_res;\r
out vec2 v_res;\r
\r
// Final size of graphic\r
layout(location=8) in vec2 a_size;\r
out vec2 v_size;\r
\r
layout(location=9) in lowp float a_texture_index;\r
out lowp float v_texture_index;\r
\r
layout(location=10) in vec2 a_uv_min;\r
out vec2 v_uv_min;\r
\r
layout(location=11) in vec2 a_uv_max;\r
out vec2 v_uv_max;\r
\r
layout(location=12) in vec4 a_tint;\r
out vec4 v_tint;\r
\r
uniform mat4 u_matrix;\r
\r
void main(){\r
  mat4 world_mat = mat4(\r
    a_mat_column1.x, a_mat_column1.y, 0., 0.,\r
    a_mat_column2.x, a_mat_column2.y, 0., 0.,\r
    0.             , 0.             , 1., 0.,\r
    a_mat_column3.x, a_mat_column3.y, 0., 1.\r
  );\r
\r
  vec2 newPos = vec2(pos.x * a_res.x, pos.y * a_res.y);\r
  gl_Position = u_matrix * world_mat * vec4(newPos + a_offset, 0., 1.);\r
\r
  v_opacity = a_opacity;\r
  v_texcoord = a_texcoord;\r
  v_uv_min = a_uv_min;\r
  v_uv_max = a_uv_max;\r
  v_res = a_res;\r
  v_size = a_size;\r
  v_texture_index = a_texture_index;\r
  v_tint = a_tint;\r
}`;class ImageRendererV2{constructor(ci){this.type="ex.image-v2",this.priority=0,this._maxImages=2e4,this._maxTextures=0,this._components=22,this._imageCount=0,this._textures=[],this._textureIndex=0,this._textureToIndex=new Map,this._images=new Set,this._vertexIndex=0,this._imageToWidth=new Map,this._imageToHeight=new Map,this._view=[0,0,0,0],this._dest=[0,0],this._defaultTint=Color.White,this.pixelArtSampler=ci.pixelArtSampler,this.uvPadding=ci.uvPadding}initialize(ci,hi){this._gl=ci,this._context=hi;const _i=ci.getParameter(ci.MAX_TEXTURE_IMAGE_UNITS),pi=getMaxShaderComplexity(ci,_i);this._maxTextures=Math.min(_i,pi);const mi=this._transformFragmentSource(image_renderer_v2_frag,this._maxTextures);this._shader=new Shader({gl:ci,fragmentSource:mi,vertexSource:image_renderer_v2_vert}),this._shader.compile(),this._shader.use(),this._shader.setUniformMatrix("u_matrix",hi.ortho),this._shader.setUniformIntArray("u_textures",[...Array(this._maxTextures)].map((Ci,Ei)=>Ei)),this._vao=ci.createVertexArray(),ci.bindVertexArray(this._vao),this._quadMesh=new Float32Array([0,0,0,0,0,1,0,1,1,0,1,0,1,0,1,0,0,1,0,1,1,1,1,1]),this._meshBuffer=ci.createBuffer(),ci.bindBuffer(ci.ARRAY_BUFFER,this._meshBuffer),ci.bufferData(ci.ARRAY_BUFFER,this._quadMesh,ci.STATIC_DRAW),ci.vertexAttribPointer(0,2,ci.FLOAT,!1,16,0),ci.enableVertexAttribArray(0),ci.vertexAttribPointer(1,2,ci.FLOAT,!1,16,8),ci.enableVertexAttribArray(1),ci.bindBuffer(ci.ARRAY_BUFFER,null);const gi=this._components;this._transformData=new VertexBuffer({gl:ci,size:gi*this._maxImages,type:"dynamic"}),this._transformData.bind();let vi=0,xi=2;const wi=4,yi=gi*4;ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(2),vi+=2*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(3),vi+=2*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(4),vi+=2*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(5),vi+=2*wi,ci.vertexAttribPointer(xi++,1,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(6),vi+=1*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(7),vi+=2*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(8),vi+=2*wi,ci.vertexAttribPointer(xi++,1,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(9),vi+=1*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(10),vi+=2*wi,ci.vertexAttribPointer(xi++,2,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(11),vi+=2*wi,ci.vertexAttribPointer(xi++,4,ci.FLOAT,!1,yi,vi),ci.enableVertexAttribArray(12),vi+=4*wi,ci.vertexAttribDivisor(2,1),ci.vertexAttribDivisor(3,1),ci.vertexAttribDivisor(4,1),ci.vertexAttribDivisor(5,1),ci.vertexAttribDivisor(6,1),ci.vertexAttribDivisor(7,1),ci.vertexAttribDivisor(8,1),ci.vertexAttribDivisor(9,1),ci.vertexAttribDivisor(10,1),ci.vertexAttribDivisor(11,1),ci.vertexAttribDivisor(12,1),ci.bindVertexArray(null)}_bindData(ci){const hi=this._components;this._transformData.bind(),this._transformData.upload(hi*this._imageCount),ci.bindVertexArray(this._vao)}dispose(){this._transformData.dispose(),this._shader.dispose(),this._textures.length=0,this._context=null,this._gl=null}_transformFragmentSource(ci,hi){let _i=ci.replace("%%count%%",hi.toString()),pi="";for(let mi=0;mi<hi;mi++)mi===0?pi+=`if (v_texture_index <= ${mi}.5) {
`:pi+=`   else if (v_texture_index <= ${mi}.5) {
`,pi+=`      color = texture(u_textures[${mi}], uv);
`,pi+=`   }
`;return _i=_i.replace("%%texture_picker%%",pi),_i}_addImageAsTexture(ci){if(this._images.has(ci))return;const hi=ci.getAttribute(ImageSourceAttributeConstants.Filtering),_i=hi?parseImageFiltering(hi):void 0,pi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingX)),mi=parseImageWrapping(ci.getAttribute(ImageSourceAttributeConstants.WrappingY)),gi=ci.getAttribute("forceUpload")==="true",vi=this._context.textureLoader.load(ci,{filtering:_i,wrapping:{x:pi,y:mi}},gi);ci.removeAttribute("forceUpload"),this._textures.indexOf(vi)===-1&&(this._textures.push(vi),this._textureToIndex.set(vi,this._textureIndex++),this._images.add(ci))}_bindTextures(ci){const hi=Math.min(this._textureIndex,this._maxTextures);for(let _i=0;_i<hi;_i++)ci.activeTexture(ci.TEXTURE0+_i),ci.bindTexture(ci.TEXTURE_2D,this._textures[_i]||this._textures[0])}_getTextureIdForImage(ci){var hi;if(ci){const _i=this._context.textureLoader.get(ci);return(hi=this._textureToIndex.get(_i))!==null&&hi!==void 0?hi:-1}return-1}_isFull(){return this._imageCount>=this._maxImages||this._textures.length>=this._maxTextures}_getImageWidth(ci){let hi=this._imageToWidth.get(ci);return hi===void 0&&(hi=ci.width,this._imageToWidth.set(ci,hi)),hi}_getImageHeight(ci){let hi=this._imageToHeight.get(ci);return hi===void 0&&(hi=ci.height,this._imageToHeight.set(ci,hi)),hi}draw(ci,hi,_i,pi,mi,gi,vi,xi,wi){var yi,Ci,Ei,Si;this._isFull()&&this.flush(),this._imageCount++,this._addImageAsTexture(ci);const ki=this._getImageWidth(ci),Ai=this._getImageHeight(ci);let Ii=ki||pi||0,Ti=Ai||mi||0;this._view[0]=0,this._view[1]=0,this._view[2]=(yi=pi??ki)!==null&&yi!==void 0?yi:0,this._view[3]=(Ci=mi??Ai)!==null&&Ci!==void 0?Ci:0,this._dest[0]=hi??1,this._dest[1]=_i??1,gi!==void 0&&vi!==void 0&&xi!==void 0&&wi!==void 0&&(this._view[0]=hi??1,this._view[1]=_i??1,this._view[2]=(Ei=pi??ki)!==null&&Ei!==void 0?Ei:0,this._view[3]=(Si=mi??Ai)!==null&&Si!==void 0?Si:0,this._dest[0]=gi,this._dest[1]=vi,Ii=xi,Ti=wi),hi=this._view[0],_i=this._view[1];const Pi=this._view[2],Li=this._view[3],Ri=this._context.getTransform(),Di=this._context.opacity;this._context.snapToPixel&&(this._dest[0]=~~(this._dest[0]+pixelSnapEpsilon),this._dest[1]=~~(this._dest[1]+pixelSnapEpsilon));const Mi=this._context.tint||this._defaultTint,$i=this._getTextureIdForImage(ci),Oi=ki||Ii,Gi=Ai||Ti,Ui=(hi+this.uvPadding)/Oi,zi=(_i+this.uvPadding)/Gi,Wi=(hi+Pi-this.uvPadding)/Oi,Ni=(_i+Li-this.uvPadding)/Gi,Hi=ki,ji=Ai,Bi=this._transformData.bufferData;Bi[this._vertexIndex++]=this._dest[0],Bi[this._vertexIndex++]=this._dest[1],Bi[this._vertexIndex++]=Ri.data[0],Bi[this._vertexIndex++]=Ri.data[1],Bi[this._vertexIndex++]=Ri.data[2],Bi[this._vertexIndex++]=Ri.data[3],Bi[this._vertexIndex++]=Ri.data[4],Bi[this._vertexIndex++]=Ri.data[5],Bi[this._vertexIndex++]=Di,Bi[this._vertexIndex++]=Ii,Bi[this._vertexIndex++]=Ti,Bi[this._vertexIndex++]=Hi,Bi[this._vertexIndex++]=ji,Bi[this._vertexIndex++]=$i,Bi[this._vertexIndex++]=Ui,Bi[this._vertexIndex++]=zi,Bi[this._vertexIndex++]=Wi,Bi[this._vertexIndex++]=Ni,Bi[this._vertexIndex++]=Mi.r/255,Bi[this._vertexIndex++]=Mi.g/255,Bi[this._vertexIndex++]=Mi.b/255,Bi[this._vertexIndex++]=Mi.a}hasPendingDraws(){return this._imageCount!==0}flush(){if(this._imageCount===0)return;const ci=this._gl;this._shader.use(),this._bindData(ci),this._shader.setUniformMatrix("u_matrix",this._context.ortho),this._shader.setUniformBoolean("u_pixelart",this.pixelArtSampler),this._bindTextures(ci),ci.drawArraysInstanced(ci.TRIANGLES,0,6,this._imageCount),GraphicsDiagnostics.DrawnImagesCount+=this._imageCount,GraphicsDiagnostics.DrawCallCount++,ci.bindVertexArray(null),this._imageCount=0,this._vertexIndex=0,this._textures.length=0,this._textureIndex=0,this._textureToIndex.clear(),this._images.clear(),this._imageToWidth.clear(),this._imageToHeight.clear()}}const pixelSnapEpsilon=1e-4;class ExcaliburGraphicsContextWebGLDebug{constructor(ci){this._webglCtx=ci,this._debugText=new DebugText}drawRect(ci,hi,_i,pi,mi={color:Color.Black}){this.drawLine(vec(ci,hi),vec(ci+_i,hi),{...mi}),this.drawLine(vec(ci+_i,hi),vec(ci+_i,hi+pi),{...mi}),this.drawLine(vec(ci+_i,hi+pi),vec(ci,hi+pi),{...mi}),this.drawLine(vec(ci,hi+pi),vec(ci,hi),{...mi})}drawLine(ci,hi,_i){var pi;this._webglCtx.draw("ex.line",ci,hi,(pi=_i==null?void 0:_i.color)!==null&&pi!==void 0?pi:Color.Black)}drawPoint(ci,hi={color:Color.Black,size:5}){this._webglCtx.draw("ex.point",ci,hi.color,hi.size)}drawText(ci,hi){this._debugText.write(this._webglCtx,ci,hi)}}class ExcaliburGraphicsContextWebGL{get z(){return this._state.current.z}set z(ci){this._state.current.z=ci}get opacity(){return this._state.current.opacity}set opacity(ci){this._state.current.opacity=ci}get tint(){return this._state.current.tint}set tint(ci){this._state.current.tint=ci}get width(){return this.__gl.canvas.width}get height(){return this.__gl.canvas.height}get ortho(){return this._ortho}checkIfResolutionSupported(ci){let hi=!0;return(ci.width>4096||ci.height>4096)&&(hi=!1),hi}constructor(ci){this._logger=Logger.getInstance(),this._renderers=new Map,this._lazyRenderersFactory=new Map,this.imageRenderer=Flags.isEnabled("use-legacy-image-renderer")?"ex.image":"ex.image-v2",this._isDrawLifecycle=!1,this.useDrawSorting=!0,this._drawCallPool=new Pool(()=>new DrawCall,void 0,4e3),this._drawCallIndex=0,this._drawCalls=new Array(4e3).fill(null),this._postProcessTargets=[],this._postprocessors=[],this._transform=new TransformStack,this._state=new StateStack,this.snapToPixel=!1,this.smoothing=!1,this.pixelArtSampler=!1,this.uvPadding=.01,this.backgroundColor=Color.ExcaliburBlue,this.multiSampleAntialiasing=!0,this.transparency=!0,this._isContextLost=!1,this._disposed=!1,this._imageToWidth=new Map,this._imageToHeight=new Map,this.debug=new ExcaliburGraphicsContextWebGLDebug(this),this._totalPostProcessorTime=0;const{canvasElement:hi,context:_i,enableTransparency:pi,antialiasing:mi,uvPadding:gi,multiSampleAntialiasing:vi,pixelArtSampler:xi,powerPreference:wi,snapToPixel:yi,backgroundColor:Ci,useDrawSorting:Ei,garbageCollector:Si,handleContextLost:ki,handleContextRestored:Ai}=ci;if(this.__gl=_i??hi.getContext("webgl2",{antialias:mi??this.smoothing,premultipliedAlpha:!1,alpha:pi??this.transparency,depth:!1,powerPreference:wi??"high-performance"}),!this.__gl)throw Error("Failed to retrieve webgl context from browser");ki&&this.__gl.canvas.addEventListener("webglcontextlost",ki,!1),Ai&&this.__gl.canvas.addEventListener("webglcontextrestored",Ai,!1),this.__gl.canvas.addEventListener("webglcontextlost",()=>{this._isContextLost=!0}),this.__gl.canvas.addEventListener("webglcontextrestored",()=>{this._isContextLost=!1}),this.textureLoader=new TextureLoader(this.__gl,Si),this.snapToPixel=yi??this.snapToPixel,this.smoothing=mi??this.smoothing,this.transparency=pi??this.transparency,this.pixelArtSampler=xi??this.pixelArtSampler,this.uvPadding=gi??this.uvPadding,this.multiSampleAntialiasing=typeof vi=="boolean"?vi:this.multiSampleAntialiasing,this.samples=typeof vi=="object"?vi.samples:void 0,this.backgroundColor=Ci??this.backgroundColor,this.useDrawSorting=Ei??this.useDrawSorting,this._drawCallPool.disableWarnings=!0,this._drawCallPool.preallocate(),this._init()}dispose(){if(!this._disposed){this._disposed=!0,this.textureLoader.dispose();for(const ci of this._renderers.values())ci.dispose();this._renderers.clear(),this._drawCallPool.dispose(),this._drawCalls.length=0,this.__gl=null}}_init(){const ci=this.__gl;if(this._ortho=Matrix.ortho(0,ci.canvas.width,ci.canvas.height,0,400,-400),ci.viewport(0,0,ci.canvas.width,ci.canvas.height),ci.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),ci.clear(ci.COLOR_BUFFER_BIT),ci.enable(ci.BLEND),ci.blendEquation(ci.FUNC_ADD),ci.blendFunc(ci.ONE,ci.ONE_MINUS_SRC_ALPHA),ci.blendEquationSeparate(ci.FUNC_ADD,ci.FUNC_ADD),ci.blendFuncSeparate(ci.ONE,ci.ONE_MINUS_SRC_ALPHA,ci.ONE,ci.ONE_MINUS_SRC_ALPHA),ci.depthMask(!1),this.register(new ImageRenderer({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.register(new MaterialRenderer),this.register(new RectangleRenderer),this.register(new CircleRenderer),this.register(new PointRenderer),this.register(new LineRenderer),this.lazyRegister("ex.particle",()=>new ParticleRenderer),this.register(new ImageRendererV2({uvPadding:this.uvPadding,pixelArtSampler:this.pixelArtSampler})),this.materialScreenTexture=ci.createTexture(),!this.materialScreenTexture)throw new Error("Could not create screen texture!");ci.bindTexture(ci.TEXTURE_2D,this.materialScreenTexture),ci.texImage2D(ci.TEXTURE_2D,0,ci.RGBA,this.width,this.height,0,ci.RGBA,ci.UNSIGNED_BYTE,null),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_MIN_FILTER,ci.NEAREST),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_MAG_FILTER,ci.NEAREST),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_WRAP_S,ci.REPEAT),ci.texParameteri(ci.TEXTURE_2D,ci.TEXTURE_WRAP_T,ci.REPEAT),ci.bindTexture(ci.TEXTURE_2D,null),this._screenRenderer=new ScreenPassPainter(ci),this._renderTarget=new RenderTarget({gl:ci,transparency:this.transparency,width:ci.canvas.width,height:ci.canvas.height}),this._postProcessTargets=[new RenderTarget({gl:ci,transparency:this.transparency,width:ci.canvas.width,height:ci.canvas.height}),new RenderTarget({gl:ci,transparency:this.transparency,width:ci.canvas.width,height:ci.canvas.height})],this._msaaTarget=new RenderTarget({gl:ci,transparency:this.transparency,width:ci.canvas.width,height:ci.canvas.height,antialias:this.multiSampleAntialiasing,samples:this.samples})}register(ci){this._renderers.set(ci.type,ci),ci.initialize(this.__gl,this)}lazyRegister(ci,hi){this._lazyRenderersFactory.set(ci,hi)}get(ci){let hi=this._renderers.get(ci);if(!hi){const _i=this._lazyRenderersFactory.get(ci);_i&&(this._logger.debug("lazy init renderer:",ci),hi=_i(),this.register(hi))}return hi}_isCurrentRenderer(ci){return!this._currentRenderer||this._currentRenderer===ci}beginDrawLifecycle(){this._isDrawLifecycle=!0}endDrawLifecycle(){this._isDrawLifecycle=!1}draw(ci,...hi){if(this._isDrawLifecycle||this._logger.warnOnce(`Attempting to draw outside the the drawing lifecycle (preDraw/postDraw) is not supported and is a source of bugs/errors.
If you want to do custom drawing, use Actor.graphics, or any onPreDraw or onPostDraw handler.`),this._isContextLost){this._logger.errorOnce(`Unable to draw ${ci}, the webgl context is lost`);return}const _i=this.get(ci);if(_i)if(this.useDrawSorting){const pi=this._drawCallPool.get();pi.z=this._state.current.z,pi.priority=_i.priority,pi.renderer=ci,this.getTransform().clone(pi.transform),pi.state.z=this._state.current.z,pi.state.opacity=this._state.current.opacity,pi.state.tint=this._state.current.tint,pi.state.material=this._state.current.material,pi.args[0]=hi[0],pi.args[1]=hi[1],pi.args[2]=hi[2],pi.args[3]=hi[3],pi.args[4]=hi[4],pi.args[5]=hi[5],pi.args[6]=hi[6],pi.args[7]=hi[7],pi.args[8]=hi[8],pi.args[9]=hi[9],this._drawCalls[this._drawCallIndex++]=pi}else this._currentRenderer||(this._currentRenderer=_i),this._isCurrentRenderer(_i)||this._currentRenderer.flush(),_i.draw(hi[0],hi[1],hi[2],hi[3],hi[4],hi[5],hi[6],hi[7],hi[8],hi[9]),this._currentRenderer=_i;else throw Error(`No renderer with name ${ci} has been registered`)}resetTransform(){this._transform.reset()}updateViewport(ci){const hi=this.__gl;this._ortho=this._ortho=Matrix.ortho(0,ci.width,ci.height,0,400,-400),this._renderTarget.setResolution(hi.canvas.width,hi.canvas.height),this._msaaTarget.setResolution(hi.canvas.width,hi.canvas.height),this._postProcessTargets[0].setResolution(hi.canvas.width,hi.canvas.height),this._postProcessTargets[1].setResolution(hi.canvas.width,hi.canvas.height)}_getImageWidth(ci){let hi=this._imageToWidth.get(ci);return hi===void 0&&(hi=ci.width,this._imageToWidth.set(ci,hi)),hi}_getImageHeight(ci){let hi=this._imageToHeight.get(ci);return hi===void 0&&(hi=ci.height,this._imageToHeight.set(ci,hi)),hi}drawImage(ci,hi,_i,pi,mi,gi,vi,xi,wi){if(!(pi===0||mi===0)){{if(xi===0||wi===0)return;if(this._getImageWidth(ci)===0||this._getImageHeight(ci)===0)return}if(!ci){Logger.getInstance().warn("Cannot draw a null or undefined image"),console.trace&&console.trace();return}this._state.current.material?this.draw("ex.material",ci,hi,_i,pi,mi,gi,vi,xi,wi):this.imageRenderer==="ex.image"?this.draw(this.imageRenderer,ci,hi,_i,pi,mi,gi,vi,xi,wi):this.draw(this.imageRenderer,ci,hi,_i,pi,mi,gi,vi,xi,wi)}}drawLine(ci,hi,_i,pi=1){this.draw("ex.rectangle",ci,hi,_i,pi)}drawRectangle(ci,hi,_i,pi,mi,gi){this.draw("ex.rectangle",ci,hi,_i,pi,mi,gi)}drawCircle(ci,hi,_i,pi,mi){this.draw("ex.circle",ci,hi,_i,pi,mi)}save(){this._transform.save(),this._state.save()}restore(){this._transform.restore(),this._state.restore()}translate(ci,hi){this._transform.translate(this.snapToPixel?~~(ci+pixelSnapEpsilon):ci,this.snapToPixel?~~(hi+pixelSnapEpsilon):hi)}rotate(ci){this._transform.rotate(ci)}scale(ci,hi){this._transform.scale(ci,hi)}transform(ci){this._transform.current=ci}getTransform(){return this._transform.current}multiply(ci){this._transform.current.multiply(ci,this._transform.current)}addPostProcessor(ci){this._postprocessors.push(ci),ci.initialize(this.__gl)}removePostProcessor(ci){const hi=this._postprocessors.indexOf(ci);hi!==-1&&this._postprocessors.splice(hi,1)}clearPostProcessors(){this._postprocessors.length=0}updatePostProcessors(ci){for(const hi of this._postprocessors){const _i=hi.getShader();_i.use();const pi=_i.getUniforms();this._totalPostProcessorTime+=ci,pi.find(mi=>mi.name==="u_time_ms")&&_i.setUniformFloat("u_time_ms",this._totalPostProcessorTime),pi.find(mi=>mi.name==="u_elapsed_ms")&&_i.setUniformFloat("u_elapsed_ms",ci),pi.find(mi=>mi.name==="u_resolution")&&_i.setUniformFloatVector("u_resolution",vec(this.width,this.height)),hi.onUpdate&&hi.onUpdate(ci)}}set material(ci){this._state.current.material=ci}get material(){return this._state.current.material}createMaterial(ci){return new Material({...ci,graphicsContext:this})}createShader(ci){const hi=this.__gl,{vertexSource:_i,fragmentSource:pi}=ci,mi=new Shader({gl:hi,vertexSource:_i,fragmentSource:pi});return mi.compile(),mi}clear(){const ci=this.__gl;(this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget).use(),ci.clearColor(this.backgroundColor.r/255,this.backgroundColor.g/255,this.backgroundColor.b/255,this.backgroundColor.a),ci.clear(ci.COLOR_BUFFER_BIT)}flush(){var ci;if(this._isContextLost){this._logger.errorOnce("Unable to flush the webgl context is lost");return}let hi=this.multiSampleAntialiasing?this._msaaTarget:this._renderTarget;if(hi.use(),this.useDrawSorting){for(let gi=this._drawCallIndex;gi<this._drawCalls.length;gi++)this._drawCalls[gi]=null;const _i=new Map;for(const[gi]of this._renderers){let vi=0;for(vi=0;vi<this._drawCallIndex&&this._drawCalls[vi].renderer!==gi;vi++);_i.set(gi,vi)}this._drawCalls.sort((gi,vi)=>{if(gi===null||vi===null)return 0;const xi=gi.z-vi.z,wi=_i.get(gi.renderer)-_i.get(vi.renderer),yi=gi.priority-vi.priority;return xi===0?yi===0?wi:yi:xi});const pi=this._transform.current,mi=this._state.current;if(this._drawCalls.length&&this._drawCallIndex){let gi=this._drawCalls[0].renderer,vi=this.get(gi);for(let xi=0;xi<this._drawCallIndex;xi++)this._transform.current=this._drawCalls[xi].transform,this._state.current=this._drawCalls[xi].state,this._drawCalls[xi].renderer!==gi&&(vi.flush(),gi=this._drawCalls[xi].renderer,vi=this.get(gi)),vi instanceof MaterialRenderer&&(!((ci=this.material)===null||ci===void 0)&&ci.isUsingScreenTexture)&&(hi.copyToTexture(this.materialScreenTexture),hi.use()),vi.draw(...this._drawCalls[xi].args);vi.hasPendingDraws()&&vi.flush()}this._transform.current=pi,this._state.current=mi,this._drawCallPool.done(),this._drawCallIndex=0,this._imageToHeight.clear(),this._imageToWidth.clear()}else for(const _i of this._renderers.values())_i.hasPendingDraws()&&_i.flush();hi.disable(),this._postprocessors.length>0&&hi.toRenderSource().use();for(let _i=0;_i<this._postprocessors.length;_i++)hi=this._postProcessTargets[_i%2],this._postProcessTargets[_i%2].use(),this._screenRenderer.renderWithPostProcessor(this._postprocessors[_i]),this._postProcessTargets[_i%2].toRenderSource().use();hi.blitToScreen()}}const ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon=1e-4;class ExcaliburGraphicsContext2DCanvasDebug{constructor(ci){this._ex=ci,this._debugText=new DebugText}drawRect(ci,hi,_i,pi){this._ex.__ctx.save(),this._ex.__ctx.strokeStyle="red",this._ex.__ctx.strokeRect(this._ex.snapToPixel?~~(ci+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci,this._ex.snapToPixel?~~(hi+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi,this._ex.snapToPixel?~~(_i+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):_i,this._ex.snapToPixel?~~(pi+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):pi),this._ex.__ctx.restore()}drawLine(ci,hi,_i={color:Color.Black}){var pi,mi;this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.strokeStyle=(mi=(pi=_i.color)===null||pi===void 0?void 0:pi.toString())!==null&&mi!==void 0?mi:"",this._ex.__ctx.moveTo(this._ex.snapToPixel?~~(ci.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.x,this._ex.snapToPixel?~~(ci.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.y),this._ex.__ctx.lineTo(this._ex.snapToPixel?~~(hi.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi.x,this._ex.snapToPixel?~~(hi.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi.y),this._ex.__ctx.lineWidth=2,this._ex.__ctx.stroke(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawPoint(ci,hi={color:Color.Black,size:5}){this._ex.__ctx.save(),this._ex.__ctx.beginPath(),this._ex.__ctx.fillStyle=hi.color.toString(),this._ex.__ctx.arc(this._ex.snapToPixel?~~(ci.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.x,this._ex.snapToPixel?~~(ci.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.y,hi.size,0,Math.PI*2),this._ex.__ctx.fill(),this._ex.__ctx.closePath(),this._ex.__ctx.restore()}drawText(ci,hi){this._debugText.write(this._ex,ci,hi)}}class ExcaliburGraphicsContext2DCanvas{get width(){return this.__ctx.canvas.width}get height(){return this.__ctx.canvas.height}get opacity(){return this._state.current.opacity}set opacity(ci){this._state.current.opacity=ci}get tint(){return this._state.current.tint}set tint(ci){this._state.current.tint=ci}get smoothing(){return this.__ctx.imageSmoothingEnabled}set smoothing(ci){this.__ctx.imageSmoothingEnabled=ci}constructor(ci){this.useDrawSorting=!1,this.z=0,this.backgroundColor=Color.ExcaliburBlue,this._state=new StateStack,this.snapToPixel=!1,this.debug=new ExcaliburGraphicsContext2DCanvasDebug(this);const{canvasElement:hi,context:_i,enableTransparency:pi,snapToPixel:mi,antialiasing:gi,backgroundColor:vi}=ci;if(this.__ctx=_i??hi.getContext("2d",{alpha:pi??!0}),!this.__ctx)throw new Error("Cannot build new ExcaliburGraphicsContext2D for some reason!");this.backgroundColor=vi??this.backgroundColor,this.snapToPixel=mi??this.snapToPixel,this.smoothing=gi??this.smoothing}resetTransform(){this.__ctx.resetTransform()}updateViewport(ci){}drawImage(ci,hi,_i,pi,mi,gi,vi,xi,wi){if(pi===0||mi===0)return;if(xi===0||wi===0)return;if(ci.width===0||ci.height===0)return;this.__ctx.globalAlpha=this.opacity;const yi=[ci,hi,_i,pi,mi,gi,vi,xi,wi].filter(Ci=>Ci!==void 0).map(Ci=>typeof Ci=="number"&&this.snapToPixel?~~Ci:Ci);this.__ctx.drawImage.apply(this.__ctx,yi),GraphicsDiagnostics.DrawCallCount++,GraphicsDiagnostics.DrawnImagesCount=1}drawLine(ci,hi,_i,pi=1){this.__ctx.save(),this.__ctx.beginPath(),this.__ctx.strokeStyle=_i.toString(),this.__ctx.moveTo(this.snapToPixel?~~(ci.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.x,this.snapToPixel?~~(ci.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.y),this.__ctx.lineTo(this.snapToPixel?~~(hi.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi.x,this.snapToPixel?~~(hi.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi.y),this.__ctx.lineWidth=pi,this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}drawRectangle(ci,hi,_i,pi){this.__ctx.save(),this.__ctx.fillStyle=pi.toString(),this.__ctx.fillRect(this.snapToPixel?~~(ci.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.x,this.snapToPixel?~~(ci.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.y,this.snapToPixel?~~(hi+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi,this.snapToPixel?~~(_i+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):_i),this.__ctx.restore()}drawCircle(ci,hi,_i,pi,mi){this.__ctx.save(),this.__ctx.beginPath(),pi&&(this.__ctx.strokeStyle=pi.toString()),mi&&(this.__ctx.lineWidth=mi),this.__ctx.fillStyle=_i.toString(),this.__ctx.arc(this.snapToPixel?~~(ci.x+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.x,this.snapToPixel?~~(ci.y+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci.y,hi,0,Math.PI*2),this.__ctx.fill(),pi&&this.__ctx.stroke(),this.__ctx.closePath(),this.__ctx.restore()}save(){this.__ctx.save(),this._state.save()}restore(){this.__ctx.restore(),this._state.restore()}translate(ci,hi){this.__ctx.translate(this.snapToPixel?~~(ci+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):ci,this.snapToPixel?~~(hi+ExcaliburGraphicsContext2DCanvas_pixelSnapEpsilon):hi)}rotate(ci){this.__ctx.rotate(ci)}scale(ci,hi){this.__ctx.scale(ci,hi)}getTransform(){throw new Error("Not implemented")}multiply(ci){this.__ctx.setTransform(this.__ctx.getTransform().multiply(ci.toDOMMatrix()))}addPostProcessor(ci){}removePostProcessor(ci){}clearPostProcessors(){}updatePostProcessors(ci){}beginDrawLifecycle(){}endDrawLifecycle(){}set material(ci){this._state.current.material=ci}get material(){return this._state.current.material}createMaterial(ci){return null}clear(){this.__ctx.clearRect(0,0,this.width,this.height),this.__ctx.fillStyle=this.backgroundColor.toString(),this.__ctx.fillRect(0,0,this.width,this.height),GraphicsDiagnostics.clear()}flush(){}dispose(){this.__ctx=void 0}}var DisplayMode;(function(fi){fi.Fixed="Fixed",fi.FitContainerAndFill="FitContainerAndFill",fi.FitScreenAndFill="FitScreenAndFill",fi.FitContainerAndZoom="FitContainerAndZoom",fi.FitScreenAndZoom="FitScreenAndZoom",fi.FitScreen="FitScreen",fi.FillScreen="FillScreen",fi.FitContainer="FitContainer",fi.FillContainer="FillContainer"})(DisplayMode||(DisplayMode={}));class Resolution{static get SVGA(){return{width:800,height:600}}static get Standard(){return{width:1920,height:1080}}static get Atari2600(){return{width:160,height:192}}static get GameBoy(){return{width:160,height:144}}static get GameBoyAdvance(){return{width:240,height:160}}static get NintendoDS(){return{width:256,height:192}}static get NES(){return{width:256,height:224}}static get SNES(){return{width:256,height:244}}}const ScreenEvents={ScreenResize:"resize",PixelRatioChange:"pixelratio",FullScreenChange:"fullscreen"};class Screen{constructor(ci){var hi,_i,pi,mi;this.events=new EventEmitter,this._antialiasing=!0,this._canvasImageRendering="auto",this._resolutionStack=[],this._viewportStack=[],this._pixelRatioOverride=null,this._isFullscreen=!1,this._isDisposed=!1,this._logger=Logger.getInstance(),this._fullscreenChangeHandler=()=>{this._isDisposed||(this._isFullscreen=!this._isFullscreen,this._logger.debug("Fullscreen Change",this._isFullscreen),this.events.emit("fullscreen",{fullscreen:this.isFullscreen}))},this._pixelRatioChangeHandler=()=>{this._isDisposed||(this._logger.debug("Pixel Ratio Change",window.devicePixelRatio),this._listenForPixelRatio(),this._devicePixelRatio=this._calculateDevicePixelRatio(),this.applyResolutionAndViewport(),this.events.emit("pixelratio",{pixelRatio:this.pixelRatio}))},this._resizeHandler=()=>{if(this._isDisposed)return;const gi=this.parent;this._logger.debug("View port resized"),this._setResolutionAndViewportByDisplayMode(gi),this.applyResolutionAndViewport(),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})},this._devicePixelRatio=this._calculateDevicePixelRatio(),this._contentArea=new BoundingBox,this._unsafeArea=new BoundingBox,this.viewport=ci.viewport,this.resolution=(hi=ci.resolution)!==null&&hi!==void 0?hi:{...this.viewport},this._contentResolution=this.resolution,this._displayMode=(_i=ci.displayMode)!==null&&_i!==void 0?_i:DisplayMode.Fixed,this._canvas=ci.canvas,this.graphicsContext=ci.context,this._antialiasing=(pi=ci.antialiasing)!==null&&pi!==void 0?pi:this._antialiasing,this._canvasImageRendering=(mi=ci.canvasImageRendering)!==null&&mi!==void 0?mi:this._canvasImageRendering,this._browser=ci.browser,this._pixelRatioOverride=ci.pixelRatio,this._applyDisplayMode(),this._listenForPixelRatio(),this._canvas.addEventListener("fullscreenchange",this._fullscreenChangeHandler),this.applyResolutionAndViewport()}_listenForPixelRatio(){this._mediaQueryList&&!this._mediaQueryList.addEventListener&&this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._mediaQueryList=this._browser.window.nativeComponent.matchMedia(`(resolution: ${window.devicePixelRatio}dppx)`),this._mediaQueryList.addEventListener?this._mediaQueryList.addEventListener("change",this._pixelRatioChangeHandler,{once:!0}):this._mediaQueryList.addListener(this._pixelRatioChangeHandler)}dispose(){this._isDisposed||(this._isDisposed=!0,this.events.clear(),this._browser.window.off("resize",this._resizeHandler),this._browser.window.clear(),this._resizeObserver&&this._resizeObserver.disconnect(),this.parent.removeEventListener("resize",this._resizeHandler),this._mediaQueryList.removeEventListener?this._mediaQueryList.removeEventListener("change",this._pixelRatioChangeHandler):this._mediaQueryList.removeListener(this._pixelRatioChangeHandler),this._canvas.removeEventListener("fullscreenchange",this._fullscreenChangeHandler),this._canvas=null)}_calculateDevicePixelRatio(){return window.devicePixelRatio<1?1:window.devicePixelRatio||1}get pixelRatio(){return this._pixelRatioOverride?this._pixelRatioOverride:this._devicePixelRatio}get worldToPagePixelRatio(){if(this._canvas){const ci=this.worldToPageCoordinates(Vector.Zero);return this.worldToPageCoordinates(vec(1,0)).sub(ci).x}else return 1}get pixelRatioOverride(){return this._pixelRatioOverride}set pixelRatioOverride(ci){this._pixelRatioOverride=ci}get isHiDpi(){return this.pixelRatio!==1}get displayMode(){return this._displayMode}get canvas(){return this._canvas}get parent(){switch(this.displayMode){case DisplayMode.FillContainer:case DisplayMode.FitContainer:case DisplayMode.FitContainerAndFill:case DisplayMode.FitContainerAndZoom:return this.canvas.parentElement||document.body;default:return window}}get resolution(){return this._resolution}set resolution(ci){this._resolution=ci}get viewport(){return this._viewport?this._viewport:this._resolution}set viewport(ci){this._viewport=ci}get aspectRatio(){return this._resolution.width/this._resolution.height}get scaledWidth(){return this._resolution.width*this.pixelRatio}get scaledHeight(){return this._resolution.height*this.pixelRatio}setCurrentCamera(ci){this._camera=ci}pushResolutionAndViewport(){this._resolutionStack.push(this.resolution),this._viewportStack.push(this.viewport),this.resolution={...this.resolution},this.viewport={...this.viewport}}peekViewport(){return this._viewportStack[this._viewportStack.length-1]}peekResolution(){return this._resolutionStack[this._resolutionStack.length-1]}popResolutionAndViewport(){this._resolutionStack.length&&this._viewportStack.length&&(this.resolution=this._resolutionStack.pop(),this.viewport=this._viewportStack.pop())}applyResolutionAndViewport(){if(this.graphicsContext instanceof ExcaliburGraphicsContextWebGL&&!this.graphicsContext.checkIfResolutionSupported({width:this.scaledWidth,height:this.scaledHeight})&&(this._logger.warnOnce(`The currently configured resolution (${this.resolution.width}x${this.resolution.height}) and pixel ratio (${this.pixelRatio}) are too large for the platform WebGL implementation, this may work but cause WebGL rendering to behave oddly. Try reducing the resolution or disabling Hi DPI scaling to avoid this (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`),!this.pixelRatioOverride)){let pi=Math.max(1,this.pixelRatio-.5),mi=!1;for(;pi>1&&!mi;){pi=Math.max(1,pi-.5);const gi=this._resolution.width*pi,vi=this._resolution.height*pi;mi=this.graphicsContext.checkIfResolutionSupported({width:gi,height:vi})}this.pixelRatioOverride=pi,this._logger.warnOnce(`Scaled resolution too big attempted recovery! Pixel ratio was automatically reduced to (${this.pixelRatio}) to avoid 4k texture limit. Setting \`ex.Engine({pixelRatio: ...}) will override any automatic recalculation, do so at your own risk.\`  (read more here https://excaliburjs.com/docs/screens#understanding-viewport--resolution).`)}this._canvas.width=this.scaledWidth,this._canvas.height=this.scaledHeight,this._canvasImageRendering==="auto"?this._canvas.style.imageRendering="auto":(this._canvas.style.imageRendering="pixelated",this._canvas.style.imageRendering===""&&(this._canvas.style.imageRendering="crisp-edges"));const ci=this.viewport.widthUnit==="percent"?"%":"px",hi=this.viewport.heightUnit==="percent"?"%":"px";this._canvas.style.width=this.viewport.width+ci,this._canvas.style.height=this.viewport.height+hi,this.graphicsContext.updateViewport(this.resolution),this.graphicsContext.resetTransform(),this.graphicsContext.smoothing=this._antialiasing,this.graphicsContext instanceof ExcaliburGraphicsContext2DCanvas&&this.graphicsContext.scale(this.pixelRatio,this.pixelRatio),document.documentElement.style.setProperty("--ex-pixel-ratio",this.worldToPagePixelRatio.toString())}get antialiasing(){return this._antialiasing}set antialiasing(ci){this._antialiasing=ci,this.graphicsContext.smoothing=this._antialiasing}get isFullScreen(){return this._isFullscreen}get isFullscreen(){return this._isFullscreen}goFullScreen(ci){return this.enterFullscreen(ci)}enterFullscreen(ci){var hi,_i,pi,mi,gi,vi;if(ci){const xi=document.getElementById(ci);if(xi!=null&&xi.requestFullscreen||xi!=null&&xi.webkitRequestFullscreen){if(xi.getAttribute("ex-fullscreen-listener")||(xi.setAttribute("ex-fullscreen-listener","true"),xi.addEventListener("fullscreenchange",this._fullscreenChangeHandler)),xi.requestFullscreen)return(hi=xi.requestFullscreen())!==null&&hi!==void 0?hi:Promise.resolve();if(xi.webkitRequestFullscreen)return(_i=xi.webkitRequestFullscreen())!==null&&_i!==void 0?_i:Promise.resolve()}}return!((pi=this._canvas)===null||pi===void 0)&&pi.requestFullscreen?(gi=(mi=this._canvas)===null||mi===void 0?void 0:mi.requestFullscreen())!==null&&gi!==void 0?gi:Promise.resolve():this._canvas.webkitRequestFullscreen?(vi=this._canvas.webkitRequestFullscreen())!==null&&vi!==void 0?vi:Promise.resolve():(this._logger.warnOnce("Could not go fullscreen, is this an iPhone? Currently Apple does not support fullscreen on iPhones"),Promise.resolve())}exitFullScreen(){return this.exitFullscreen()}exitFullscreen(){return document.exitFullscreen()}_viewportToPixels(ci){return{width:ci.widthUnit==="percent"?this.canvas.offsetWidth:ci.width,height:ci.heightUnit==="percent"?this.canvas.offsetHeight:ci.height}}pageToScreenCoordinates(ci){let hi=ci.x,_i=ci.y;this._isFullscreen||(hi-=getPosition(this._canvas).x,_i-=getPosition(this._canvas).y);const pi=this._viewportToPixels(this.viewport);if(this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const mi=window.innerWidth/this.aspectRatio,gi=(window.innerHeight-mi)/2;_i=(_i-gi)/mi*pi.height,hi=hi/window.innerWidth*pi.width}else{const mi=window.innerHeight*this.aspectRatio,gi=(window.innerWidth-mi)/2;hi=(hi-gi)/mi*pi.width,_i=_i/window.innerHeight*pi.height}return hi=hi/pi.width*this.resolution.width,_i=_i/pi.height*this.resolution.height,hi=hi-this.contentArea.left,_i=_i-this.contentArea.top,new Vector(hi,_i)}screenToPageCoordinates(ci){let hi=ci.x,_i=ci.y;const pi=this._viewportToPixels(this.viewport);if(hi=hi/this.resolution.width*pi.width,_i=_i/this.resolution.height*pi.height,this._isFullscreen)if(window.innerWidth/this.aspectRatio<window.innerHeight){const mi=window.innerWidth/this.aspectRatio,gi=(window.innerHeight-mi)/2;_i=_i/pi.height*mi+gi,hi=hi/pi.width*window.innerWidth}else{const mi=window.innerHeight*this.aspectRatio,gi=(window.innerWidth-mi)/2;hi=hi/pi.width*mi+gi,_i=_i/pi.height*window.innerHeight}return this._isFullscreen||(hi+=getPosition(this._canvas).x,_i+=getPosition(this._canvas).y),new Vector(hi,_i)}screenToWorldCoordinates(ci){return ci=ci.add(vec(this.contentArea.left,this.contentArea.top)),this._camera?this._camera.inverse.multiply(ci):ci.sub(vec(this.resolution.width/2,this.resolution.height/2))}worldToScreenCoordinates(ci){return this._camera?this._camera.transform.multiply(ci):ci.add(vec(this.resolution.width/2,this.resolution.height/2))}pageToWorldCoordinates(ci){const hi=this.pageToScreenCoordinates(ci);return this.screenToWorldCoordinates(hi)}worldToPageCoordinates(ci){const hi=this.worldToScreenCoordinates(ci);return this.screenToPageCoordinates(hi)}getWorldBounds(){return BoundingBox.fromDimension(this.resolution.width,this.resolution.height,Vector.Half).scale(vec(1/this._camera.zoom,1/this._camera.zoom)).rotate(this._camera.rotation).translate(this._camera.drawPos)}getScreenBounds(){return BoundingBox.fromDimension(this.resolution.width,this.resolution.height,Vector.Zero,Vector.Zero)}get canvasWidth(){return this.canvas.width}get halfCanvasWidth(){return this.canvas.width/2}get canvasHeight(){return this.canvas.height}get halfCanvasHeight(){return this.canvas.height/2}get drawWidth(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get width(){return this._camera?this.resolution.width/this._camera.zoom:this.resolution.width}get halfDrawWidth(){return this.drawWidth/2}get drawHeight(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get height(){return this._camera?this.resolution.height/this._camera.zoom:this.resolution.height}get halfDrawHeight(){return this.drawHeight/2}get center(){return vec(this.halfDrawWidth,this.halfDrawHeight)}get contentArea(){return this._contentArea}get unsafeArea(){return this._unsafeArea}_computeFit(){document.body.style.margin="0px",document.body.style.overflow="hidden";const ci=this.aspectRatio;let hi=0,_i=0;window.innerWidth/ci<window.innerHeight?(hi=window.innerWidth,_i=window.innerWidth/ci):(hi=window.innerHeight*ci,_i=window.innerHeight),this.viewport={width:hi,height:_i},this._contentArea=BoundingBox.fromDimension(this.resolution.width,this.resolution.height,Vector.Zero),this._unsafeArea=BoundingBox.fromDimension(this.resolution.width,this.resolution.height,Vector.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitScreenAndFill(){document.body.style.margin="0px",document.body.style.overflow="hidden";const ci=window.innerWidth,hi=window.innerHeight;this._computeFitAndFill(ci,hi),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndFill(){this.canvas.style.width="100%",this.canvas.style.height="100%",this._computeFitAndFill(this.canvas.offsetWidth,this.canvas.offsetHeight,{width:100,widthUnit:"percent",height:100,heightUnit:"percent"}),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndFill(ci,hi,_i){if(this.viewport=_i??{width:ci,height:hi},ci/hi<=this._contentResolution.width/this._contentResolution.height){this.resolution={width:ci*this._contentResolution.width/ci,height:ci*this._contentResolution.width/ci*hi/ci};const pi=(this.resolution.height-this._contentResolution.height)/2;this._contentArea=new BoundingBox({top:pi,left:0,right:this._contentResolution.width,bottom:this.resolution.height-pi}),this._unsafeArea=new BoundingBox({top:-pi,left:0,right:this._contentResolution.width,bottom:this.resolution.height+pi})}else{this.resolution={width:hi*this._contentResolution.height/hi*ci/hi,height:hi*this._contentResolution.height/hi};const pi=(this.resolution.width-this._contentResolution.width)/2;this._contentArea=new BoundingBox({top:0,left:pi,right:this.resolution.width-pi,bottom:this._contentResolution.height}),this._unsafeArea=new BoundingBox({top:0,left:-pi,right:this.resolution.width+pi,bottom:this._contentResolution.height})}}_computeFitScreenAndZoom(){document.body.style.margin="0px",document.body.style.overflow="hidden",this.canvas.style.position="absolute";const ci=window.innerWidth,hi=window.innerHeight;this._computeFitAndZoom(ci,hi),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitContainerAndZoom(){this.canvas.style.width="100%",this.canvas.style.height="100%",this.canvas.style.position="relative";const ci=this.canvas.parentElement;ci.style.overflow="hidden";const{offsetWidth:hi,offsetHeight:_i}=this.canvas;this._computeFitAndZoom(hi,_i),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_computeFitAndZoom(ci,hi){const _i=this.aspectRatio;let pi=0,mi=0;ci/_i<hi?(pi=ci,mi=ci/_i):(pi=hi*_i,mi=hi);const gi=ci/pi,vi=hi/mi,xi=Math.max(gi,vi),wi=pi*xi,yi=mi*xi;wi>ci?this.canvas.style.left=-(wi-ci)/2+"px":this.canvas.style.left="",yi>hi?this.canvas.style.top=-(yi-hi)/2+"px":this.canvas.style.top="",this.viewport={width:wi,height:yi};const Ci=BoundingBox.fromDimension(this.viewport.width,this.viewport.height,Vector.Zero);if(this.viewport.width>ci){const Ei=(this.viewport.width-ci)/this.viewport.width*this.resolution.width;Ci.top=0,Ci.left=Ei/2,Ci.right=this.resolution.width-Ei/2,Ci.bottom=this.resolution.height}if(this.viewport.height>hi){const Ei=(this.viewport.height-hi)/this.viewport.height*this.resolution.height;Ci.top=Ei/2,Ci.left=0,Ci.bottom=this.resolution.height-Ei/2,Ci.right=this.resolution.width}this._contentArea=Ci}_computeFitContainer(){const ci=this.aspectRatio;let hi=0,_i=0,pi="pixel",mi="pixel";const gi=this.canvas.parentElement;gi.clientWidth/ci<gi.clientHeight?(this.canvas.style.width="100%",hi=100,pi="percent",_i=this.canvas.offsetWidth/ci):(this.canvas.style.height="100%",_i=100,mi="percent",hi=this.canvas.offsetHeight*ci),this.viewport={width:hi,widthUnit:pi,height:_i,heightUnit:mi},this._contentArea=BoundingBox.fromDimension(this.resolution.width,this.resolution.height,Vector.Zero),this.events.emit("resize",{resolution:this.resolution,viewport:this.viewport})}_applyDisplayMode(){this._setResolutionAndViewportByDisplayMode(this.parent),this.parent instanceof Window?this._browser.window.on("resize",this._resizeHandler):(this._resizeObserver=new ResizeObserver(()=>{this._resizeHandler()}),this._resizeObserver.observe(this.parent)),this.parent.addEventListener("resize",this._resizeHandler)}_setResolutionAndViewportByDisplayMode(ci){this.displayMode===DisplayMode.FillContainer&&(this.canvas.style.width="100%",this.canvas.style.height="100%",this.viewport={width:100,widthUnit:"percent",height:100,heightUnit:"percent"},this.resolution={width:this.canvas.offsetWidth,height:this.canvas.offsetHeight}),this.displayMode===DisplayMode.FillScreen&&(document.body.style.margin="0px",document.body.style.overflow="hidden",this.resolution={width:ci.innerWidth,height:ci.innerHeight},this.viewport=this.resolution),this._contentArea=BoundingBox.fromDimension(this.resolution.width,this.resolution.height,Vector.Zero),this.displayMode===DisplayMode.FitScreen&&this._computeFit(),this.displayMode===DisplayMode.FitContainer&&this._computeFitContainer(),this.displayMode===DisplayMode.FitScreenAndFill&&this._computeFitScreenAndFill(),this.displayMode===DisplayMode.FitContainerAndFill&&this._computeFitContainerAndFill(),this.displayMode===DisplayMode.FitScreenAndZoom&&this._computeFitScreenAndZoom(),this.displayMode===DisplayMode.FitContainerAndZoom&&this._computeFitContainerAndZoom()}}class AudioContextFactory{static create(){return this._INSTANCE||(window.AudioContext||window.webkitAudioContext)&&(this._INSTANCE=new AudioContext),this._INSTANCE}}function isLegacyWebAudioSource(fi){return!!fi.playbackState}class WebAudio{static unlock(){return new Promise((hi,_i)=>{if(WebAudio._UNLOCKED||!AudioContextFactory.create())return hi(!0);const pi=setTimeout(()=>{Logger.getInstance().warn("Excalibur was unable to unlock the audio context, audio probably will not play in this browser."),hi(!1)},200),mi=AudioContextFactory.create();mi.resume().then(()=>{const gi=mi.createBuffer(1,1,22050),vi=mi.createBufferSource();let xi=!1;vi.buffer=gi,vi.connect(mi.destination),vi.onended=()=>xi=!0,vi.start(0),setTimeout(()=>{isLegacyWebAudioSource(vi)?(vi.playbackState===vi.PLAYING_STATE||vi.playbackState===vi.FINISHED_STATE)&&(WebAudio._UNLOCKED=!0):(mi.currentTime>0||xi)&&(WebAudio._UNLOCKED=!0)},0),clearTimeout(pi),hi(!0)},()=>{_i()})})}static isUnlocked(){return this._UNLOCKED}}WebAudio._UNLOCKED=!1;let Canvas$1=class ds extends Raster{get ctx(){return this._ctx}constructor(ci={}){super(ci),this._options=ci}clone(){return new ds({...this._options,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(ci){var hi,_i;!((hi=this._options)===null||hi===void 0)&&hi.draw&&((_i=this._options)===null||_i===void 0||_i.draw(ci)),this._options.cache||this.flagDirty()}};class ExResponse{}ExResponse.type={any:"",blob:"blob",json:"json",text:"text",document:"document",arraybuffer:"arraybuffer"};class StateMachine{constructor(){this.states=new Map}get currentState(){return this._currentState}set currentState(ci){this._currentState=ci}static create(ci,hi){const _i=new StateMachine;_i.data=hi;for(const pi in ci.states)_i.states.set(pi,{name:pi,...ci.states[pi]});for(const pi of _i.states.values())for(const mi of pi.transitions)if(mi!=="*"&&!_i.states.has(mi))throw Error(`Invalid state machine, state [${pi.name}] has a transition to another state that doesn't exist [${mi}]`);return _i.currentState=_i.startState=_i.states.get(ci.start),_i}in(ci){return this.currentState.name===ci}go(ci,hi){var _i,pi;if(this.currentState.transitions.includes(ci)||this.currentState.transitions.includes("*")){const mi=this.states.get(ci);return this.currentState.onExit&&((_i=this.currentState)===null||_i===void 0?void 0:_i.onExit({to:mi.name,data:this.data}))===!1||mi!=null&&mi.onEnter&&(mi==null?void 0:mi.onEnter({from:this.currentState.name,eventData:hi,data:this.data}))===!1?!1:(this.currentState=mi,!((pi=this.currentState)===null||pi===void 0)&&pi.onState&&this.currentState.onState(),!0)}return!1}update(ci){this.currentState.onUpdate&&this.currentState.onUpdate(this.data,ci)}save(ci){localStorage.setItem(ci,JSON.stringify({currentState:this.currentState.name,data:this.data}))}restore(ci){const hi=JSON.parse(localStorage.getItem(ci));this.currentState=this.states.get(hi.currentState),this.data=hi.data}}class WebAudioInstance{_createNewBufferSource(){this._instance=this._audioContext.createBufferSource(),this._instance.buffer=this._src,this._instance.loop=this.loop,this._instance.playbackRate.value=this._playbackRate,this._instance.connect(this._volumeNode),this._volumeNode.connect(this._audioContext.destination)}_handleEnd(){this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)})}set loop(ci){this._loop=ci,this._instance&&(this._instance.loop=ci,this.loop||(this._instance.onended=()=>{this._playingFuture.resolve(!0)}))}get loop(){return this._loop}set volume(ci){ci=clamp(ci,0,1),this._volume=ci,this._stateMachine.in("PLAYING")&&this._volumeNode.gain.setTargetAtTime?this._volumeNode.gain.setTargetAtTime(ci,this._audioContext.currentTime,.1):this._volumeNode.gain.value=ci}get volume(){return this._volume}get duration(){var ci;return(ci=this._duration)!==null&&ci!==void 0?ci:this.getTotalPlaybackDuration()}set duration(ci){this._duration=ci}constructor(ci){this._src=ci,this._audioContext=AudioContextFactory.create(),this._volumeNode=this._audioContext.createGain(),this._playingFuture=new Future,this._stateMachine=StateMachine.create({start:"STOPPED",states:{PLAYING:{onEnter:({data:hi})=>{this._createNewBufferSource(),this._handleEnd(),this.loop?this._instance.start(0,hi.pausedAt*this._playbackRate):this._instance.start(0,hi.pausedAt*this._playbackRate,this.duration),hi.startedAt=this._audioContext.currentTime-hi.pausedAt,hi.pausedAt=0},onState:()=>this._playStarted(),onExit:({to:hi})=>{hi==="STOPPED"&&this._playingFuture.resolve(!0),this._instance.onended=null,this._instance.disconnect(),this._instance.stop(0),this._instance=null},transitions:["STOPPED","PAUSED","SEEK"]},SEEK:{onEnter:({eventData:hi,data:_i})=>{_i.pausedAt=(hi??0)/this._playbackRate,_i.startedAt=0},transitions:["*"]},STOPPED:{onEnter:({data:hi})=>{hi.pausedAt=0,hi.startedAt=0,this._playingFuture.resolve(!0)},transitions:["PLAYING","PAUSED","SEEK"]},PAUSED:{onEnter:({data:hi})=>{hi.pausedAt=this._audioContext.currentTime-hi.startedAt},transitions:["PLAYING","STOPPED","SEEK"]}}},{startedAt:0,pausedAt:0}),this._volume=1,this._loop=!1,this._playStarted=()=>{},this._playbackRate=1,this._createNewBufferSource()}isPlaying(){return this._stateMachine.in("PLAYING")}isPaused(){return this._stateMachine.in("PAUSED")||this._stateMachine.in("SEEK")}isStopped(){return this._stateMachine.in("STOPPED")}play(ci=()=>{}){return this._playStarted=ci,this._stateMachine.go("PLAYING"),this._playingFuture.promise}pause(){this._stateMachine.go("PAUSED")}stop(){this._stateMachine.go("STOPPED")}seek(ci){this._stateMachine.go("PAUSED"),this._stateMachine.go("SEEK",ci)}getTotalPlaybackDuration(){return this._src.duration}getPlaybackPosition(){const{pausedAt:ci,startedAt:hi}=this._stateMachine.data;return ci?ci*this._playbackRate:hi?(this._audioContext.currentTime-hi)*this._playbackRate:0}set playbackRate(ci){this._instance.playbackRate.value=this._playbackRate=ci}get playbackRate(){return this._instance.playbackRate.value}}class MediaEvent extends GameEvent{set bubbles(ci){}get bubbles(){return!1}get _path(){return null}set _path(ci){}constructor(ci,hi="MediaEvent"){super(),this.target=ci,this._name=hi}stopPropagation(){}action(){}propagate(){}layPath(ci){}}class NativeSoundEvent extends MediaEvent{constructor(ci,hi){super(ci,"NativeSoundEvent"),this.track=hi}}class NativeSoundProcessedEvent extends MediaEvent{constructor(ci,hi){super(ci,"NativeSoundProcessedEvent"),this._processedData=hi,this.data=this._processedData}}function canPlayFile(fi){try{const ci=new Audio,hi=/.*\.([A-Za-z0-9]+)(?:(?:\?|\#).*)*$/,_i=fi.match(hi)[1];return!!ci.canPlayType("audio/"+_i)}catch(ci){return Logger.getInstance().warn("Cannot determine audio support, assuming no support for the Audio Tag",ci),!1}}const SoundEvents={VolumeChange:"volumechange",Processed:"processed",Pause:"pause",Stop:"stop",PlaybackEnd:"playbackend",Resume:"resume",PlaybackStart:"playbackstart"};class Sound{set loop(ci){this._loop=ci;for(const hi of this._tracks)hi.loop=this._loop;this.logger.debug("Set loop for all instances of sound",this.path,"to",this._loop)}get loop(){return this._loop}set volume(ci){this._volume=ci;for(const hi of this._tracks)hi.volume=this._volume;this.events.emit("volumechange",new NativeSoundEvent(this)),this.logger.debug("Set loop for all instances of sound",this.path,"to",this._volume)}get volume(){return this._volume}get duration(){return this._duration}set duration(ci){this._duration=ci}get instances(){return this._tracks}get path(){return this._resource.path}set path(ci){this._resource.path=ci}get bustCache(){return this._resource.bustCache}set bustCache(ci){this._resource.bustCache=ci}constructor(...ci){this.events=new EventEmitter,this.logger=Logger.getInstance(),this._loop=!1,this._volume=1,this._isStopped=!1,this._tracks=[],this._wasPlayingOnHidden=!1,this._playbackRate=1,this._audioContext=AudioContextFactory.create(),this._resource=new Resource("",ExResponse.type.arraybuffer);for(const hi of ci)if(canPlayFile(hi)){this.path=hi;break}this.path||(this.logger.warn("This browser does not support any of the audio files specified:",ci.join(", ")),this.logger.warn("Attempting to use",ci[0]),this.path=ci[0])}isLoaded(){return!!this.data}async load(){var ci,hi;if(this.data)return this.data;const _i=await this._resource.load(),pi=await this.decodeAudio(_i.slice(0));return this._duration=(hi=(ci=this._duration)!==null&&ci!==void 0?ci:pi==null?void 0:pi.duration)!==null&&hi!==void 0?hi:void 0,this.events.emit("processed",new NativeSoundProcessedEvent(this,pi)),this.data=pi}async decodeAudio(ci){try{return await this._audioContext.decodeAudioData(ci.slice(0))}catch{return this.logger.error("Unable to decode  this browser may not fully support this format, or the file may be corrupt, if this is an mp3 try removing id3 tags and album art from the file."),await Promise.reject()}}wireEngine(ci){ci&&(this._engine=ci,this._engine.on("hidden",()=>{ci.pauseAudioWhenHidden&&this.isPlaying()&&(this._wasPlayingOnHidden=!0,this.pause())}),this._engine.on("visible",()=>{ci.pauseAudioWhenHidden&&this._wasPlayingOnHidden&&(this.play(),this._wasPlayingOnHidden=!1)}),this._engine.on("start",()=>{this._isStopped=!1}),this._engine.on("stop",()=>{this.stop(),this._isStopped=!0}))}instanceCount(){return this._tracks.length}isPlaying(){return this._tracks.some(ci=>ci.isPlaying())}isPaused(){return this._tracks.some(ci=>ci.isPaused())}isStopped(){return this._tracks.some(ci=>ci.isStopped())}play(ci){return this.isLoaded()?this._isStopped?(this.logger.warn("Cannot start playing. Engine is in a stopped state."),Promise.resolve(!1)):(this.volume=ci||this.volume,this.isPaused()?this._resumePlayback():this._startPlayback()):(this.logger.warn("Cannot start playing. Resource",this.path,"is not loaded yet"),Promise.resolve(!0))}pause(){if(this.isPlaying()){for(const ci of this._tracks)ci.pause();this.events.emit("pause",new NativeSoundEvent(this)),this.logger.debug("Paused all instances of sound",this.path)}}stop(){for(const ci of this._tracks)ci.stop();this.events.emit("stop",new NativeSoundEvent(this)),this._tracks.length=0,this.logger.debug("Stopped all instances of sound",this.path)}get playbackRate(){return this._playbackRate}set playbackRate(ci){this._playbackRate=ci,this._tracks.forEach(hi=>{hi.playbackRate=this._playbackRate})}seek(ci,hi=0){this._tracks.length===0&&this._getTrackInstance(this.data),this._tracks[hi].seek(ci)}getTotalPlaybackDuration(){return this.isLoaded()?this.data.duration:(this.logger.warnOnce(`Sound from ${this.path} is not loaded, cannot return total playback duration.Did you forget to add Sound to a loader? https://excaliburjs.com/docs/loaders/`),0)}getPlaybackPosition(ci=0){return this._tracks.length?this._tracks[ci].getPlaybackPosition():0}getTrackId(ci){return this._tracks.indexOf(ci)}async _resumePlayback(){if(this.isPaused()){const ci=[];for(const hi of this._tracks)ci.push(hi.play().then(()=>(this._tracks.splice(this.getTrackId(hi),1),!0)));this.events.emit("resume",new NativeSoundEvent(this)),this.logger.debug("Resuming paused instances for sound",this.path,this._tracks),await Promise.all(ci)}return!0}async _startPlayback(){const ci=this._getTrackInstance(this.data),hi=await ci.play(()=>{this.events.emit("playbackstart",new NativeSoundEvent(this,ci)),this.logger.debug("Playing new instance for sound",this.path)});this.events.emit("playbackend",new NativeSoundEvent(this,ci));const _i=this.getTrackId(ci);return _i!==-1&&this._tracks.splice(_i,1),hi}_getTrackInstance(ci){var hi;const _i=new WebAudioInstance(ci);return _i.loop=this.loop,_i.volume=this.volume,_i.duration=(hi=this.duration)!==null&&hi!==void 0?hi:0,_i.playbackRate=this._playbackRate,this._tracks.push(_i),_i}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}}const LoaderEvents={BeforeLoad:"beforeload",AfterLoad:"afterload",UserAction:"useraction",LoadResourceStart:"loadresourcestart",LoadResourceEnd:"loadresourceend"};function isLoaderConstructor(fi){var ci,hi;return!!(fi!=null&&fi.prototype)&&!!(!((hi=(ci=fi==null?void 0:fi.prototype)===null||ci===void 0?void 0:ci.constructor)===null||hi===void 0)&&hi.name)}class DefaultLoader{get resources(){return this._resources}constructor(ci){var hi;this.events=new EventEmitter,this.canvas=new Canvas$1({filtering:ImageFiltering.Blended,smoothing:!0,cache:!1,draw:this.onDraw.bind(this)}),this._resources=[],this._numLoaded=0,this._totalTimeMs=0,this._loadingFuture=new Future,ci&&(!((hi=ci.loadables)===null||hi===void 0)&&hi.length)&&this.addResources(ci.loadables)}onInitialize(ci){this.engine=ci,this.canvas.width=this.engine.screen.resolution.width,this.canvas.height=this.engine.screen.resolution.height}async onUserAction(){return await Promise.resolve()}async onBeforeLoad(){}async onAfterLoad(){await delay(500,this.engine.clock)}addResource(ci){this._resources.push(ci)}addResources(ci){let hi=0;const _i=ci.length;for(hi;hi<_i;hi++)this.addResource(ci[hi])}markResourceComplete(){this._numLoaded++}get progress(){const ci=this._resources.length;return ci>0?clamp(this._numLoaded,0,ci)/ci:1}isLoaded(){return this._numLoaded===this._resources.length}onUpdate(ci,hi){this._totalTimeMs+=hi}onDraw(ci){const hi=this._totalTimeMs/1e3;ci.fillStyle=Color.Black.toRGBA(),ci.fillRect(0,0,this.engine.screen.resolution.width,this.engine.screen.resolution.height),ci.save(),ci.translate(this.engine.screen.resolution.width/2,this.engine.screen.resolution.height/2);const _i=hi*10;ci.strokeStyle="white",ci.lineWidth=10,ci.lineCap="round",ci.arc(0,0,40,_i,_i+Math.PI*3/2),ci.stroke(),ci.fillStyle="white",ci.font="16px sans-serif";const pi=(this.progress*100).toFixed(0)+"%",mi=ci.measureText(pi),gi=Math.abs(mi.actualBoundingBoxLeft)+Math.abs(mi.actualBoundingBoxRight),vi=Math.abs(mi.actualBoundingBoxAscent)+Math.abs(mi.actualBoundingBoxDescent);ci.fillText(pi,-gi/2,vi/2),ci.restore()}areResourcesLoaded(){return this._resources.length===0?Promise.resolve():this._loadingFuture.promise}async load(){await this.onBeforeLoad(),this.events.emit("beforeload"),this.canvas.flagDirty(),await Promise.all(this._resources.map(async ci=>{this.events.emit("loadresourcestart",ci),await ci.load().finally(()=>{this._numLoaded++,this.canvas.flagDirty(),this.events.emit("loadresourceend",ci)})}));for(const ci of this._resources)ci instanceof Sound&&ci.wireEngine(this.engine);return this._loadingFuture.resolve(),this.canvas.flagDirty(),await this.onUserAction(),this.events.emit("useraction"),await WebAudio.unlock(),await this.onAfterLoad(),this.events.emit("afterload"),this.data=this._resources}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}}const Loader_logo="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAdQAAAB2CAYAAABxhGI9AAAACXBIWXMAAAsSAAALEgHS3X78AAAKnUlEQVR42u3dP2wjSx0H8N8hJIonIRmJjsq0SBR+BQ1dcqKhe0lD77SvSwpKkJKGPulpktfRIMUdEqKIqV57rpAokM4dbSiyq7ONPTP7x39ifz7SFbnEnp3xer47O7uzH15fXwMA6OYHmgAABCoACFQAEKgAgEAFAIEKAAIVAAQqACBQAUCgAoBABQCBCgAIVAAQqAAgUAFAoAIAAhUABCoACFQAEKgAgECFLbmOiNeFf2PbAyz68Pr6qhUgbRwR92v+/zwiJrYHMEKFMmcN///UtgcQqFBk1PD/97U9Qx8VCFSgu4EmAIEKAAIVAAQqACBQ4Z25jojP8eX+0WtNAgIVaOY+Im5j+eKh24h41jQgUIEyZ7F5NaPU7wCBCiwYd/w9cOB+qAlgJ3KLLow0EV198803RWvJfvfddx+0lhEqHKu5JgAjVCBvlhmFzjQRXUekHz9+TP79y8uLRjNChXfvoePvAYEKxNtj1e42/O5JoIJABcrdRMRVLM+X3kTEpaaB988cKuzWg9EobTWdMx0Oly8uN4dqhAoARqgnaN3arHfqu7OyH8ItKLVB/P+CEfMTHyGPY3npx1m8zWGDEeoBfUk/xdti57dr/r1Wv2+6EPow3tZ5rRdS72s1neuF97xvWd+XTH0/V+UMttDWqbI/r2nrxfp+jv2uSjSO7S+OXy/A/3lN+9xX5T5HxEUPZZ0tfB71+w57eJ/HFu+z+jkv1u92YX9fbI/HhX3JA9rp5MPr66tWaG9UfUGbrHIzi7cLUyYFf/tpTady03EEeL8mUJ6i7MKYNvWNqr4Pe2jradXO60LrvPAz2PQ5RPX684ah8dxD+2zantnCgVipSVV+m/tgB9W2DDq2Sx/vM95wcHhZhWVJm8yrv58cSgfTdc70+++/X/r522+/tUKSEepBqo+om4ZLPerMjUwuNnQCtx1GWJtee1FwdD5uWd86xLs8UaVt2aNEO1/saZ/Z5rYMW4zq6v34rGV9Bg3q2eZ9SkeNm9qwyUh30OPIHYFKx5FG03C7znSOqYBq+qW/zpQ3anH037TNHluG6f0WPsPhHvab4QFty7ogOeuxDYcNy2/zu2214WNYWxmBurNO8bGn97pNBOO8xy/9uCorZZ4I2r4C7aJgO7ZV9iE49Dm6NvOWx+pWE9CUq3zbdTp9doz38TbXtzqH9RT5CyWe422OaZoZGeZCabrhPQY9HjwsjpTvCg4YtlE2+Ta/j2bzn8fqrDqgm+6yUHOmAvWUjAtGhbNYvsBknDnqH1Qhc7VmxHgeb/NbudA5j/UXlYwif2p6luhAc9teu1npiHKnDs8if6tCm7JLX3NKpgttXe9ruc9mHMd7a83iwdxF5vt8tutARaCeklRnNK9C8WnNF7geJQ4T4XG3JhSnVdilQrG+yOnrlVHfsEGYzhNBn7Lu6tS7+HJafJQ4EMiNlNqWXZ9WPvVgnVYHG5M1ByDXkT6leX2EgTqJtyt45yv7S2qO3sEZjZhDLXeR+YKdJ0Zdk8QocvH9N732KrNtq+FZ/zzIHABcJrYpd+Xv14lOd5ap76SgrduW/VTQ1qcQpqnbgu4ifZvUMNpd9XuoZmvCtPaQ2Y/BCHVLgbrJTeRPDdVf6pfMKDU2fOkHmVFFfXr3MsouLsnNvV5kRoe5+s431PeuoKPqWnaurY/ZPBEeqwceN4l96iwO6H7Mjq4y7VGPVNe10VaZMzVCPVWpI/Z6FZbcv5fMqGCU+dLfFGzj58jP8+bCdJCo7yzKTwdOF0bu9Ug7V4c+yz7FJfYeGoysUss0HssIdVZwYLDujMqlESoCdTtGsZtbHnJBeNdDSJSs0jTKdMJN1HNX54Wv7bvsU9NkVJVa13dX+/wuArV0X/l5RHyo/lnfF4G6p6DrS0kHdtXhy35TGErDPYZUn2WfWqDOo/lVqdMD2O/hKJhD7S/odukymq9s02QN4EEPR/zbaOumZc+r15zK1Zqznl9jsfiemTM1QmV3HUuTkedlg9HIQzRbUD93dfC+2tpj2fIHEH2+RqCCQH13gZq7hWXTNpVu19OB1fc9nQ0AKOKUb5lU0P1kDyOneoWk0lOZ9cIP0x7qu8+2BhCoR2wYu1+e7DmaXzBSsu5vaX1ne2zrpmUPTmxf7PM1Dm4y/vC7ny7Nif7+z/9ZmtM0Z3panPLtPmra9f16bcK0Dpbnwk43Vd/RHtu6zfNQTy1QBy3aqG2g9nVmxml+BOoJyT3NpWmn9xhfFnu4bvDa+44BXhqqfdf3uUF9+yz77AT31Yue2mjecYQ62NLfgkA9ghHqLNEhNem4H1c6vdyDxhf/bpz5m4coW/c39wi6VH2bPtHlcaV9cvXts+zxCe6rTeqc2ndL7uGd93QwM9bFcAzMoZZ7SgTBbWx+asui61h/iq1+RmjqdbnQXQ3T1DNQ63V/U9ucqm/pMzPb1rePsk/1iTOjgvatR4W3Lc8ULB78pELyrnAfeTcj1NU509/86mfJ33/8+Mf00a05UyPUEw7UVCeWG/WNEiExyHRMt5ltW30izUPk18ytt7lNfc8i//DvtvXto+ySA5BjljsLUF8lPkqMPEtW1JomDsiGBZ9Byb4NAvUITSN9GuwsIj6t6UTOqk7jJREkmzqli8xIs96udSO20sX0H1vW92IL9e1a9rgqVyf91gbPsTy9UD9n9lOkT8k+RfkFR5PMNqxOcdSf32PBvg3vilO+zdxE+okx9Wm0ph36XYsRZCpMF993GOk5qvqB3Dct6jvssb67KvuUNJ3frw92bhr8/STSF0JdRPMLpUCgnsgo9S76PZ246ZFk1wWvK5m3vVoYvW1Sz7nN91jfXbQ1ZQc7TW6HeaoOalypG/8/p/rP1aNAc6ZHzSnfdqPUPhdy2PQw6Nz9gSVhuhiqueUHR3uu7y7K3rdDX4u46ZrPbUa0IFBZ0seKQ3XQTRt2vm3W/a2DbNKys++rvm3ep6+y1x2UdP3bWU9lzra47U1GmlctX/sQ23t+aOlByLTh/4NAPaCRxtcdO5HLSJ/6vNtCwGx67VPmPbvWd1q9frKHtp4kAqRJ2HR9j762JfX3bZ//elPtj13PPDx1+D5tqk/Xi6NO8SHz7MmH19dXrdBNfVFP6T2PT1UHNit87/t4m5+aRH+nQBdvqyhZDKJLfZs8h7XPsqdV2ZOV+tanKB8aln0dyxdAXbV4j4gvt4oMOrbP6vbU73NW7TMlbdTnPrWpfqXfh9HKZ9vke7KuTeZRNtXRSe6+1FV//ce/ln5eXfsXgcqXzr6+9261M3moOoa7E6nvTZTfy7iNsmfb7kjfgXGsvxe0vihsEts9HTquPpt1q1vtahu2TqAiUAEEKj0zhwoARqgAu/OnX/442WH+9xc/Wvr58re/Tr7f41/+ZsRqhAoACFQAEKgAcHjMoQJskJsz/eqrr5Z+vvr7v5fmQFevAl5lztQIFQAQqAAgUAHgIJlDBdhgdQ41N2eKESoAIFABQKACwFEwhwoARqgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAEKgAgUAFAoAKAQAUAgQoACFQAEKgAIFABQKACAAIVAAQqAAhUABCoAIBABQCBCgACFQAQqAAgUAFAoAKAQAUAlvwPcFDns1DsH4sAAAAASUVORK5CYII=";var Director_Loader=__webpack_require__(851);class Loader extends DefaultLoader{get _image(){return this._imageElement||(this._imageElement=new Image,this._imageElement.onload=()=>this._imageLoaded.resolve(),this._imageElement.src=this.logo),this._imageElement}get playButtonRootElement(){return this._playButtonRootElement}get playButtonElement(){return this._playButtonElement}get _playButton(){const ci=document.getElementById("excalibur-play-root");return ci&&(this._playButtonRootElement=ci),this._playButtonRootElement||(this._playButtonRootElement=document.createElement("div"),this._playButtonRootElement.id="excalibur-play-root",this._playButtonRootElement.style.position="absolute",document.body.appendChild(this._playButtonRootElement)),this._styleBlock||(this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._playButtonStyles,document.head.appendChild(this._styleBlock)),this._playButtonElement||(this._playButtonElement=this.startButtonFactory(),this._playButtonRootElement.appendChild(this._playButtonElement)),this._playButtonElement}constructor(ci){const hi=Array.isArray(ci)?{loadables:ci}:ci;super(hi),this._logger=Logger.getInstance(),this._originalOptions={loadables:[]},this.events=new EventEmitter,this._playButtonShown=!1,this.logo=Loader_logo,this.logoWidth=468,this.logoHeight=118,this.loadingBarColor=Color.White,this.backgroundColor="#176BAA",this._imageLoaded=new Future,this.suppressPlayButton=!1,this._playButtonStyles=Director_Loader.A.toString(),this.playButtonText="Play game",this.startButtonFactory=()=>{let _i=document.getElementById("excalibur-play");return _i||(_i=document.createElement("button")),_i.id="excalibur-play",_i.textContent=this.playButtonText,_i.style.display="none",_i},this._originalOptions={...Loader._DEFAULT_LOADER_OPTIONS,...hi}}onInitialize(ci){this.engine=ci,this.screen=ci.screen,this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height,this.screen.events.on("resize",()=>{this.canvas.width=this.engine.canvas.width,this.canvas.height=this.engine.canvas.height})}async showPlayButton(){var ci,hi;if(this.suppressPlayButton)this.hidePlayButton(),await delay(500,(ci=this.engine)===null||ci===void 0?void 0:ci.clock);else{const _i=()=>{try{this._positionPlayButton()}catch{}};return!((hi=this.engine)===null||hi===void 0)&&hi.browser&&this.engine.browser.window.on("resize",_i),this._playButtonShown=!0,this._playButton.style.display="block",document.body.addEventListener("keyup",mi=>{mi.key==="Enter"&&this._playButton.click()}),this._positionPlayButton(),await new Promise(mi=>{const gi=vi=>{var xi;if(vi.stopPropagation(),this.hidePlayButton(),!((xi=this.engine)===null||xi===void 0)&&xi.browser&&this.engine.browser.window.off("resize",_i),this._originalOptions.fullscreenAfterLoad)try{this._logger.info("requesting fullscreen"),this._originalOptions.fullscreenContainer instanceof HTMLElement?this._originalOptions.fullscreenContainer.requestFullscreen():this.engine.screen.enterFullscreen(this._originalOptions.fullscreenContainer)}catch(wi){this._logger.error("could not go fullscreen",wi)}mi()};this._playButton.addEventListener("click",gi),this._playButton.addEventListener("touchend",gi),this._playButton.addEventListener("pointerup",gi),this.engine&&this.engine.input.gamepads.once("button",()=>gi(new Event("button")))})}}hidePlayButton(){this._playButtonShown=!1,this._playButton.style.display="none"}dispose(){this._playButtonRootElement.parentElement&&(this._playButtonRootElement.removeChild(this._playButtonElement),document.body.removeChild(this._playButtonRootElement),document.head.removeChild(this._styleBlock),this._playButtonRootElement=null,this._playButtonElement=null,this._styleBlock=null)}async onUserAction(){var ci;await delay(200,(ci=this.engine)===null||ci===void 0?void 0:ci.clock),this.canvas.flagDirty(),await this.showPlayButton()}async onBeforeLoad(){this.screen.pushResolutionAndViewport(),this.screen.resolution={width:this.canvas.width,height:this.canvas.height},this.screen.applyResolutionAndViewport();const ci=this._image;await this._imageLoaded.promise,await(ci==null?void 0:ci.decode())}async onAfterLoad(){this.screen.popResolutionAndViewport(),this.screen.applyResolutionAndViewport(),this.dispose()}_positionPlayButton(){if(this.engine){const{x:ci,y:hi,width:_i,height:pi}=this.engine.canvas.getBoundingClientRect();if(this._playButtonRootElement){const mi=this._playButton.clientWidth,gi=this._playButton.clientHeight;this.playButtonPosition?(this._playButtonRootElement.style.left=`${this.playButtonPosition.x}px`,this._playButtonRootElement.style.top=`${this.playButtonPosition.y}px`):(this._playButtonRootElement.style.left=`${ci+_i/2-mi/2}px`,this._playButtonRootElement.style.top=`${hi+pi/2-gi/2+100}px`)}}}onDraw(ci){const hi=this.engine.canvasHeight/this.engine.pixelRatio,_i=this.engine.canvasWidth/this.engine.pixelRatio;this._positionPlayButton(),ci.fillStyle=this.backgroundColor,ci.fillRect(0,0,_i,hi);let pi=hi/2;const mi=Math.min(this.logoWidth,_i*.75);let gi=_i/2-mi/2;this.logoPosition&&(gi=this.logoPosition.x,pi=this.logoPosition.y);const vi=Math.floor(mi*(this.logoHeight/this.logoWidth)),xi=this.engine.screen.antialiasing;if(this.engine.screen.antialiasing=!0,this.logoPosition?ci.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,gi,pi,mi,vi):ci.drawImage(this._image,0,0,this.logoWidth,this.logoHeight,gi,pi-vi-20,mi,vi),!this.suppressPlayButton&&this._playButtonShown){this.engine.screen.antialiasing=xi;return}let wi=gi,yi=pi;this.loadingBarPosition&&(wi=this.loadingBarPosition.x,yi=this.loadingBarPosition.y),ci.lineWidth=2,roundRect(ci,wi,yi,mi,20,10,this.loadingBarColor);const Ci=mi*this.progress,Ei=5,Si=Ci-Ei*2,ki=20-Ei*2;roundRect(ci,wi+Ei,yi+Ei,Si>10?Si:10,ki,5,null,this.loadingBarColor),this.engine.screen.antialiasing=xi}}Loader._DEFAULT_LOADER_OPTIONS={loadables:[],fullscreenAfterLoad:!1,fullscreenContainer:void 0};const REPORTED_FEATURES={webgl:"WebGL",webaudio:"WebAudio",gamepadapi:"Gamepad API"};class Detector{constructor(){this._features=null,this.failedTests=[],this._criticalTests={canvasSupport:function(){const ci=document.createElement("canvas");return!!(ci.getContext&&ci.getContext("2d"))},arrayBufferSupport:function(){const ci=new XMLHttpRequest;ci.open("GET","/");try{ci.responseType="arraybuffer"}catch{return!1}return ci.responseType==="arraybuffer"},dataUrlSupport:function(){return document.createElement("canvas").toDataURL("image/png").indexOf("data:image/png")===0},objectUrlSupport:function(){return"URL"in window&&"revokeObjectURL"in URL&&"createObjectURL"in URL},rgbaSupport:function(){const ci=document.createElement("a").style;return ci.cssText="background-color:rgba(150,255,150,.5)",(""+ci.backgroundColor).indexOf("rgba")>-1}},this._warningTest={webAudioSupport:function(){return!!(window.AudioContext||window.webkitAudioContext||window.mozAudioContext||window.msAudioContext||window.oAudioContext)},webglSupport:function(){const ci=document.createElement("canvas");return!!(ci.getContext&&ci.getContext("webgl"))}},this._features=this._loadBrowserFeatures()}getBrowserFeatures(){return this._features===null&&(this._features=this._loadBrowserFeatures()),this._features}logBrowserFeatures(){let ci=`%cSUPPORTED BROWSER FEATURES
==========================%c
`;const hi=["font-weight: bold; color: navy","font-weight: normal; color: inherit"],_i=this.getBrowserFeatures();for(const pi of Object.keys(REPORTED_FEATURES))_i[pi]?(ci+="(%c%c)",hi.push("font-weight: bold; color: green"),hi.push("font-weight: normal; color: inherit")):(ci+="(%c%c)",hi.push("font-weight: bold; color: red"),hi.push("font-weight: normal; color: inherit")),ci+=" "+REPORTED_FEATURES[pi]+`
`;hi.unshift(ci),console.log.apply(console,hi)}_loadBrowserFeatures(){return{canvas:this._criticalTests.canvasSupport(),arraybuffer:this._criticalTests.arrayBufferSupport(),dataurl:this._criticalTests.dataUrlSupport(),objecturl:this._criticalTests.objectUrlSupport(),rgba:this._criticalTests.rgbaSupport(),webaudio:this._warningTest.webAudioSupport(),webgl:this._warningTest.webglSupport(),gamepadapi:!!navigator.getGamepads}}test(){let ci=!1;for(const hi in this._criticalTests)this._criticalTests[hi].call(this)||(this.failedTests.push(hi),Logger.getInstance().error("Critical browser feature missing, Excalibur requires:",hi),ci=!0);if(ci)return!1;for(const hi in this._warningTest)this._warningTest[hi]()||Logger.getInstance().warn("Warning browser feature missing, Excalibur will have reduced performance:",hi);return!0}}var CollisionType;(function(fi){fi.PreventCollision="PreventCollision",fi.Passive="Passive",fi.Active="Active",fi.Fixed="Fixed"})(CollisionType||(CollisionType={}));class CollisionGroupManager{static create(ci,hi){if(this._CURRENT_GROUP>this._MAX_GROUPS)throw new Error(`Cannot have more than ${this._MAX_GROUPS} collision groups`);if(this._GROUPS.get(ci)){const pi=this._GROUPS.get(ci);if(pi.mask===hi)return pi;throw new Error(`Collision group ${ci} already exists with a different mask!`)}const _i=new CollisionGroup(ci,this._CURRENT_BIT,hi!==void 0?hi:~this._CURRENT_BIT);return this._CURRENT_BIT=this._CURRENT_BIT<<1|0,this._CURRENT_GROUP++,this._GROUPS.set(ci,_i),_i}static get groups(){return Array.from(this._GROUPS.values())}static groupByName(ci){return this._GROUPS.get(ci)}static reset(){this._GROUPS=new Map,this._CURRENT_BIT=this._STARTING_BIT,this._CURRENT_GROUP=1}}CollisionGroupManager._STARTING_BIT=1;CollisionGroupManager._MAX_GROUPS=32;CollisionGroupManager._CURRENT_GROUP=1;CollisionGroupManager._CURRENT_BIT=CollisionGroupManager._STARTING_BIT;CollisionGroupManager._GROUPS=new Map;class CollisionGroup{constructor(ci,hi,_i){this._name=ci,this._category=hi,this._mask=_i}get name(){return this._name}get category(){return this._category}get mask(){return this._mask}canCollide(ci){const hi=this.category&ci.mask,_i=this.mask&ci.category;return hi!==0&&_i!==0}invert(){const ci=CollisionGroupManager.create("~("+this.name+")",~this.mask|0);return ci._category=~this.category,ci}static combine(ci){const hi=ci.map(mi=>mi.name).join("+"),pi=~ci.reduce((mi,gi)=>gi.category|mi,0);return CollisionGroupManager.create(hi,pi)}static collidesWith(ci){const hi=`collidesWith(${ci.map(pi=>pi.name).join("+")})`,_i=ci.reduce((pi,mi)=>mi.category|pi,0);return CollisionGroupManager.create(hi,_i)}toString(){return`
category: ${this.category.toString(2).padStart(32,"0")}
mask:     ${(this.mask>>>0).toString(2).padStart(32,"0")}
    `}}CollisionGroup.All=new CollisionGroup("Collide with all groups",-1,-1);class Pair{constructor(ci,hi){this.colliderA=ci,this.colliderB=hi,this.id=null,this.id=Pair.calculatePairHash(ci.id,hi.id)}static canCollide(ci,hi){var _i,pi;if(ci.id===hi.id||ci.owner&&hi.owner&&ci.owner.id===hi.owner.id||ci.localBounds.hasZeroDimensions()||hi.localBounds.hasZeroDimensions())return!1;const mi=(_i=ci==null?void 0:ci.owner)===null||_i===void 0?void 0:_i.get(BodyComponent),gi=(pi=hi==null?void 0:hi.owner)===null||pi===void 0?void 0:pi.get(BodyComponent);return!(!mi||!gi||!mi.group.canCollide(gi.group)||mi.collisionType===CollisionType.Fixed&&gi.collisionType===CollisionType.Fixed||gi.collisionType===CollisionType.PreventCollision||mi.collisionType===CollisionType.PreventCollision||!mi.isActive||!gi.isActive)}get canCollide(){const ci=this.colliderA,hi=this.colliderB;return Pair.canCollide(ci,hi)}collide(){return this.colliderA.collide(this.colliderB)}hasCollider(ci){return ci===this.colliderA||ci===this.colliderB}static calculatePairHash(ci,hi){return ci.value<hi.value?`#${ci.value}+${hi.value}`:`#${hi.value}+${ci.value}`}}class Projection{constructor(ci,hi){this.min=ci,this.max=hi}overlaps(ci){return this.max>ci.min&&ci.max>this.min}getOverlap(ci){return this.overlaps(ci)?this.max>ci.max?ci.max-this.min:this.max-ci.min:0}}class TreeNode{constructor(ci){this.parent=ci,this.parent=ci||null,this.data=null,this.bounds=new BoundingBox,this.left=null,this.right=null,this.height=0}isLeaf(){return!this.left&&!this.right}}class DynamicTree{constructor(ci,hi=new BoundingBox(-Number.MAX_VALUE,-Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)){this._config=ci,this.worldBounds=hi,this.root=null,this.nodes={}}_insert(ci){if(this.root===null){this.root=ci,this.root.parent=null;return}const hi=ci.bounds;let _i=this.root;for(;!_i.isLeaf();){const vi=_i.left,xi=_i.right,wi=_i.bounds.getPerimeter(),Ci=_i.bounds.combine(hi).getPerimeter(),Ei=2*Ci,Si=2*(Ci-wi);let ki=0;const Ai=hi.combine(vi.bounds);let Ii,Ti;vi.isLeaf()?ki=Ai.getPerimeter()+Si:(Ti=vi.bounds.getPerimeter(),Ii=Ai.getPerimeter(),ki=Ii-Ti+Si);let Pi=0;const Li=hi.combine(xi.bounds);if(xi.isLeaf()?Pi=Li.getPerimeter()+Si:(Ti=xi.bounds.getPerimeter(),Ii=Li.getPerimeter(),Pi=Ii-Ti+Si),Ei<ki&&Ei<Pi)break;ki<Pi?_i=vi:_i=xi}const pi=_i.parent,mi=new TreeNode(pi);mi.bounds=hi.combine(_i.bounds),mi.height=_i.height+1,pi!==null?(pi.left===_i?pi.left=mi:pi.right=mi,mi.left=_i,mi.right=ci,_i.parent=mi,ci.parent=mi):(mi.left=_i,mi.right=ci,_i.parent=mi,ci.parent=mi,this.root=mi);let gi=ci.parent;for(;gi;){if(gi=this._balance(gi),!gi.left)throw new Error("Parent of current leaf cannot have a null left child"+gi);if(!gi.right)throw new Error("Parent of current leaf cannot have a null right child"+gi);gi.height=1+Math.max(gi.left.height,gi.right.height),gi.bounds=gi.left.bounds.combine(gi.right.bounds),gi=gi.parent}}_remove(ci){if(ci===this.root){this.root=null;return}const hi=ci.parent,_i=hi.parent;let pi;if(hi.left===ci?pi=hi.right:pi=hi.left,_i){_i.left===hi?_i.left=pi:_i.right=pi,pi.parent=_i;let mi=_i;for(;mi;)mi=this._balance(mi),mi.bounds=mi.left.bounds.combine(mi.right.bounds),mi.height=1+Math.max(mi.left.height,mi.right.height),mi=mi.parent}else this.root=pi,pi.parent=null}trackCollider(ci){const hi=new TreeNode;hi.data=ci,hi.bounds=ci.bounds,hi.bounds.left-=2,hi.bounds.top-=2,hi.bounds.right+=2,hi.bounds.bottom+=2,this.nodes[ci.id.value]=hi,this._insert(hi)}updateCollider(ci){var hi;const _i=this.nodes[ci.id.value];if(!_i)return!1;const pi=ci.bounds;if(!this.worldBounds.contains(pi))return Logger.getInstance().warn("Collider with id "+ci.id.value+" is outside the world bounds and will no longer be tracked for physics"),this.untrackCollider(ci),!1;if(_i.bounds.contains(pi))return!1;if(this._remove(_i),pi.left-=this._config.boundsPadding,pi.top-=this._config.boundsPadding,pi.right+=this._config.boundsPadding,pi.bottom+=this._config.boundsPadding,ci.owner){const mi=(hi=ci.owner)===null||hi===void 0?void 0:hi.get(BodyComponent);if(mi){const gi=mi.vel.x*32/1e3*this._config.velocityMultiplier,vi=mi.vel.y*32/1e3*this._config.velocityMultiplier;gi<0?pi.left+=gi:pi.right+=gi,vi<0?pi.top+=vi:pi.bottom+=vi}}return _i.bounds=pi,this._insert(_i),!0}untrackCollider(ci){const hi=this.nodes[ci.id.value];hi&&(this._remove(hi),this.nodes[ci.id.value]=null,delete this.nodes[ci.id.value])}_balance(ci){if(ci===null)throw new Error("Cannot balance at null node");if(ci.isLeaf()||ci.height<2)return ci;const hi=ci.left,_i=ci.right,pi=ci,mi=hi,gi=_i,vi=hi.left,xi=hi.right,wi=_i.left,yi=_i.right,Ci=gi.height-mi.height;if(Ci>1)return gi.left=pi,gi.parent=pi.parent,pi.parent=gi,gi.parent?gi.parent.left===pi?gi.parent.left=gi:gi.parent.right=gi:this.root=gi,wi.height>yi.height?(gi.right=wi,pi.right=yi,yi.parent=pi,pi.bounds=mi.bounds.combine(yi.bounds),gi.bounds=pi.bounds.combine(wi.bounds),pi.height=1+Math.max(mi.height,yi.height),gi.height=1+Math.max(pi.height,wi.height)):(gi.right=yi,pi.right=wi,wi.parent=pi,pi.bounds=mi.bounds.combine(wi.bounds),gi.bounds=pi.bounds.combine(yi.bounds),pi.height=1+Math.max(mi.height,wi.height),gi.height=1+Math.max(pi.height,yi.height)),gi;if(Ci<-1){if(mi.left=pi,mi.parent=pi.parent,pi.parent=mi,mi.parent)if(mi.parent.left===pi)mi.parent.left=mi;else{if(mi.parent.right!==pi)throw"Error rotating Dynamic Tree";mi.parent.right=mi}else this.root=mi;return vi.height>xi.height?(mi.right=vi,pi.left=xi,xi.parent=pi,pi.bounds=gi.bounds.combine(xi.bounds),mi.bounds=pi.bounds.combine(vi.bounds),pi.height=1+Math.max(gi.height,xi.height),mi.height=1+Math.max(pi.height,vi.height)):(mi.right=xi,pi.left=vi,vi.parent=pi,pi.bounds=gi.bounds.combine(vi.bounds),mi.bounds=pi.bounds.combine(xi.bounds),pi.height=1+Math.max(gi.height,vi.height),mi.height=1+Math.max(pi.height,xi.height)),mi}return ci}getHeight(){return this.root===null?0:this.root.height}query(ci,hi){const _i=ci.bounds,pi=mi=>{if(mi&&mi.bounds.overlaps(_i))if(mi.isLeaf()&&mi.data!==ci){if(hi.call(ci,mi.data))return!0}else return pi(mi.left)||pi(mi.right);return!1};pi(this.root)}rayCastQuery(ci,hi=1/0,_i){const pi=mi=>{if(mi&&mi.bounds.rayCast(ci,hi))if(mi.isLeaf()){if(_i.call(ci,mi.data))return!0}else return pi(mi.left)||pi(mi.right);return!1};pi(this.root)}getNodes(){const ci=hi=>hi?[hi].concat(ci(hi.left),ci(hi.right)):[];return ci(this.root)}debug(ci){const hi=_i=>{_i&&(_i.isLeaf()?_i.bounds.draw(ci,Color.Green):_i.bounds.draw(ci,Color.White),_i.left&&hi(_i.left),_i.right&&hi(_i.right))};hi(this.root)}}class Ray{constructor(ci,hi){this.pos=ci,this.dir=hi.normalize()}intersect(ci){const hi=ci.begin.sub(this.pos);if(this.dir.cross(ci.getSlope())===0&&hi.cross(this.dir)!==0)return-1;const _i=this.dir.cross(ci.getSlope());if(_i===0)return-1;const pi=hi.cross(ci.getSlope())/_i;if(pi>=0){const mi=hi.cross(this.dir)/_i/ci.getLength();if(mi>=0&&mi<=1)return pi}return-1}intersectPoint(ci){const hi=this.intersect(ci);return hi<0?null:this.getPoint(hi)}getPoint(ci){return this.pos.add(this.dir.scale(ci))}}class DynamicTreeCollisionProcessor{constructor(ci){this._config=ci,this._pairs=new Set,this._collisionPairCache=[],this._colliders=[],this._dynamicCollisionTree=new DynamicTree(ci.dynamicTree)}getColliders(){return this._colliders}query(ci){const hi=[];return ci instanceof BoundingBox?this._dynamicCollisionTree.query({id:createId("collider",-1),owner:null,bounds:ci},_i=>(hi.push(_i),!1)):this._dynamicCollisionTree.query({id:createId("collider",-1),owner:null,bounds:new BoundingBox(ci.x,ci.y,ci.x,ci.y)},_i=>(hi.push(_i),!1)),hi}rayCast(ci,hi){var _i,pi,mi;const gi=[],vi=(_i=hi==null?void 0:hi.maxDistance)!==null&&_i!==void 0?_i:1/0,xi=hi==null?void 0:hi.collisionGroup,wi=xi?xi.category:(pi=hi==null?void 0:hi.collisionMask)!==null&&pi!==void 0?pi:CollisionGroup.All.category,yi=(mi=hi==null?void 0:hi.searchAllColliders)!==null&&mi!==void 0?mi:!1;return this._dynamicCollisionTree.rayCastQuery(ci,vi,Ci=>{const Si=Ci.owner.get(BodyComponent);if(hi!=null&&hi.ignoreCollisionGroupAll&&Si.group===CollisionGroup.All)return!1;const ki=(wi&Si.group.category)!==0;if(Si!=null&&Si.group&&!ki)return!1;const Ai=Ci.rayCast(ci,vi);if(Ai){if(hi!=null&&hi.filter){if(hi.filter(Ai)&&(gi.push(Ai),!yi))return!0}else if(gi.push(Ai),!yi)return!0}return!1}),gi}track(ci){if(!ci){Logger.getInstance().warn("Cannot track null collider");return}if(ci instanceof CompositeCollider){const hi=ci.getColliders();for(const _i of hi)_i.owner=ci.owner,this._colliders.push(_i),this._dynamicCollisionTree.trackCollider(_i)}else this._colliders.push(ci),this._dynamicCollisionTree.trackCollider(ci)}untrack(ci){if(!ci){Logger.getInstance().warn("Cannot untrack a null collider");return}if(ci instanceof CompositeCollider){const hi=ci.getColliders();for(const _i of hi){const pi=this._colliders.indexOf(_i);pi!==-1&&this._colliders.splice(pi,1),this._dynamicCollisionTree.untrackCollider(_i)}}else{const hi=this._colliders.indexOf(ci);hi!==-1&&this._colliders.splice(hi,1),this._dynamicCollisionTree.untrackCollider(ci)}}_pairExists(ci,hi){const _i=Pair.calculatePairHash(ci.id,hi.id);return this._pairs.has(_i)}broadphase(ci,hi,_i){const pi=hi/1e3,mi=ci.filter(vi=>{var xi,wi;const yi=(xi=vi.owner)===null||xi===void 0?void 0:xi.get(BodyComponent);return((wi=vi.owner)===null||wi===void 0?void 0:wi.isActive)&&yi.collisionType!==CollisionType.PreventCollision});this._collisionPairCache=[],this._pairs.clear();let gi;for(let vi=0,xi=mi.length;vi<xi;vi++)gi=mi[vi],this._dynamicCollisionTree.query(gi,wi=>{if(!this._pairExists(gi,wi)&&Pair.canCollide(gi,wi)){const yi=new Pair(gi,wi);this._pairs.add(yi.id),this._collisionPairCache.push(yi)}return!1});if(_i&&(_i.physics.pairs=this._collisionPairCache.length),this._config.continuous.checkForFastBodies)for(const vi of mi){const xi=vi.owner.get(BodyComponent);if(xi.collisionType!==CollisionType.Active)continue;const wi=xi.vel.magnitude*pi+xi.acc.magnitude*.5*pi*pi,yi=Math.min(vi.bounds.height,vi.bounds.width);if(this._config.continuous.disableMinimumSpeedForFastBody||wi>yi/2){_i&&_i.physics.fastBodies++;const Ci=xi.globalPos.sub(xi.oldPos),Ei=vi.center,Si=vi.getFurthestPoint(xi.vel),ki=Si.sub(Ci),Ai=new Ray(ki,xi.vel);Ai.pos=Ai.pos.add(Ai.dir.scale(-2*this._config.continuous.surfaceEpsilon));let Ii,Ti=new Vector(1/0,1/0);if(this._dynamicCollisionTree.rayCastQuery(Ai,wi+this._config.continuous.surfaceEpsilon*2,Pi=>{if(!this._pairExists(vi,Pi)&&Pair.canCollide(vi,Pi)){const Li=Pi.rayCast(Ai,wi+this._config.continuous.surfaceEpsilon*10);if(Li){const Ri=Li.point.sub(ki);Ri.magnitude<Ti.magnitude&&(Ti=Ri,Ii=Pi)}}return!1}),Ii&&Vector.isValid(Ti)){const Pi=new Pair(vi,Ii);this._pairs.has(Pi.id)||(this._pairs.add(Pi.id),this._collisionPairCache.push(Pi));const Li=Ei.sub(Si);xi.globalPos=ki.add(Li).add(Ti).add(Ai.dir.scale(10*this._config.continuous.surfaceEpsilon)),vi.update(xi.transform.get()),_i&&_i.physics.fastBodyCollisions++}}}return this._collisionPairCache}narrowphase(ci,hi){let _i=[];for(let pi=0;pi<ci.length;pi++){const mi=ci[pi].collide();if(_i=_i.concat(mi),hi&&mi.length>0)for(const gi of mi)hi.physics.contacts.set(gi.id,gi)}return hi&&(hi.physics.collisions+=_i.length),_i}update(ci){let hi=0;const _i=ci.length;for(let pi=0;pi<_i;pi++)this._dynamicCollisionTree.updateCollider(ci[pi])&&hi++;return hi}debug(ci){this._dynamicCollisionTree.debug(ci)}}class Collider{constructor(){this.id=createId("collider",Collider._ID++),this.composite=null,this.events=new EventEmitter,this.offset=Vector.Zero}touching(ci){return!!this.collide(ci)}}Collider._ID=0;var SolverStrategy;(function(fi){fi.Arcade="arcade",fi.Realistic="realistic"})(SolverStrategy||(SolverStrategy={}));var ContactSolveBias;(function(fi){fi.None="none",fi.VerticalFirst="vertical-first",fi.HorizontalFirst="horizontal-first"})(ContactSolveBias||(ContactSolveBias={}));const VerticalFirst={vertical:1,horizontal:2},HorizontalFirst={horizontal:1,vertical:2},None={horizontal:0,vertical:0};var SpatialPartitionStrategy;(function(fi){fi.DynamicTree="dynamic-tree",fi.SparseHashGrid="sparse-hash-grid"})(SpatialPartitionStrategy||(SpatialPartitionStrategy={}));const getDefaultPhysicsConfig=()=>({enabled:!0,gravity:vec(0,0).clone(),solver:SolverStrategy.Arcade,substep:1,colliders:{compositeStrategy:"together"},continuous:{checkForFastBodies:!0,disableMinimumSpeedForFastBody:!1,surfaceEpsilon:.1},bodies:{canSleepByDefault:!1,sleepEpsilon:.07,wakeThreshold:.07*3,sleepBias:.9,defaultMass:10},spatialPartition:SpatialPartitionStrategy.SparseHashGrid,sparseHashGrid:{size:100},dynamicTree:{boundsPadding:5,velocityMultiplier:2},arcade:{contactSolveBias:ContactSolveBias.None},realistic:{contactSolveBias:ContactSolveBias.None,positionIterations:3,velocityIterations:8,slop:1,steeringFactor:.2,warmStart:!0}});class CompositeCollider extends Collider{set compositeStrategy(ci){this._compositeStrategy=ci}get compositeStrategy(){return this._compositeStrategy}constructor(ci){super(),this._collisionProcessor=new DynamicTreeCollisionProcessor({...getDefaultPhysicsConfig()}),this._dynamicAABBTree=new DynamicTree({boundsPadding:5,velocityMultiplier:2}),this._colliders=[];for(const hi of ci)this.addCollider(hi)}clearColliders(){this._colliders=[]}addCollider(ci){let hi;ci instanceof CompositeCollider?(hi=ci.getColliders(),hi.forEach(_i=>_i.offset.addEqual(ci.offset))):hi=[ci];for(const _i of hi)_i.events.pipe(this.events),_i.composite=this,this._colliders.push(_i),this._collisionProcessor.track(_i),this._dynamicAABBTree.trackCollider(_i)}removeCollider(ci){ci.events.pipe(this.events),ci.composite=null,removeItemFromArray(ci,this._colliders),this._collisionProcessor.untrack(ci),this._dynamicAABBTree.untrackCollider(ci)}getColliders(){return this._colliders}get worldPos(){var ci,hi;return((hi=(ci=this._transform)===null||ci===void 0?void 0:ci.pos)!==null&&hi!==void 0?hi:Vector.Zero).add(this.offset)}get center(){var ci,hi;return((hi=(ci=this._transform)===null||ci===void 0?void 0:ci.pos)!==null&&hi!==void 0?hi:Vector.Zero).add(this.offset)}get bounds(){var ci,hi;const _i=this.getColliders();return _i.reduce((mi,gi)=>mi.combine(gi.bounds),(hi=(ci=_i[0])===null||ci===void 0?void 0:ci.bounds)!==null&&hi!==void 0?hi:new BoundingBox().translate(this.worldPos)).translate(this.offset)}get localBounds(){var ci,hi;const _i=this.getColliders();return _i.reduce((mi,gi)=>mi.combine(gi.localBounds),(hi=(ci=_i[0])===null||ci===void 0?void 0:ci.localBounds)!==null&&hi!==void 0?hi:new BoundingBox)}get axes(){const ci=this.getColliders();let hi=[];for(const _i of ci)hi=hi.concat(_i.axes);return hi}getFurthestPoint(ci){const hi=this.getColliders(),_i=[];for(const gi of hi)_i.push(gi.getFurthestPoint(ci));let pi=_i[0],mi=-Number.MAX_VALUE;for(const gi of _i){const vi=gi.dot(ci);vi>mi&&(pi=gi,mi=vi)}return pi}getInertia(ci){const hi=this.getColliders();let _i=0;for(const pi of hi)_i+=pi.getInertia(ci);return _i}collide(ci){let hi=[ci];ci instanceof CompositeCollider&&(hi=ci.getColliders());const _i=[];for(const mi of hi)this._dynamicAABBTree.query(mi,gi=>(_i.push(new Pair(mi,gi)),!1));let pi=[];for(const mi of _i)pi=pi.concat(mi.collide());return pi}getClosestLineBetween(ci){const hi=this.getColliders(),_i=[];if(ci instanceof CompositeCollider){const pi=ci.getColliders();for(const mi of hi)for(const gi of pi){const vi=mi.getClosestLineBetween(gi);vi&&_i.push(vi)}}else for(const pi of hi){const mi=ci.getClosestLineBetween(pi);mi&&_i.push(mi)}if(_i.length){let pi=_i[0].getLength(),mi=_i[0];for(const gi of _i){const vi=gi.getLength();vi<pi&&(pi=vi,mi=gi)}return mi}return null}contains(ci){const hi=this.getColliders();for(const _i of hi)if(_i.contains(ci))return!0;return!1}rayCast(ci,hi){const _i=this.getColliders(),pi=[];for(const mi of _i){const gi=mi.rayCast(ci,hi);gi&&pi.push(gi)}if(pi.length){let mi=pi[0],gi=mi.point.dot(ci.dir);for(const vi of pi){const xi=ci.dir.dot(vi.point);xi<gi&&(mi=vi,gi=xi)}return mi}return null}project(ci){const hi=this.getColliders(),_i=[];for(const pi of hi){const mi=pi.project(ci);mi&&_i.push(mi)}if(_i.length){const pi=new Projection(_i[0].min,_i[0].max);for(const mi of _i)pi.min=Math.min(mi.min,pi.min),pi.max=Math.max(mi.max,pi.max);return pi}return null}update(ci){if(ci){const hi=this.getColliders();for(const _i of hi)_i.owner=this.owner,_i.update(ci)}}debug(ci,hi,_i){const pi=this.getColliders();ci.save(),ci.translate(this.offset.x,this.offset.y);for(const mi of pi)mi.debug(ci,hi,_i);ci.restore()}clone(){const ci=new CompositeCollider(this._colliders.map(hi=>hi.clone()));return ci.offset=this.offset.clone(),ci}}class LineSegment{constructor(ci,hi){this.begin=ci,this.end=hi}clone(ci){const hi=ci||new LineSegment(this.begin.clone(),this.end.clone());return hi.begin=this.begin.clone(hi.begin),hi.end=this.end.clone(hi.end),hi}transform(ci,hi){const _i=hi||new LineSegment(Vector.Zero,Vector.Zero);return _i.begin=ci.multiply(this.begin,_i.begin),_i.end=ci.multiply(this.end,_i.end),_i}get slope(){return(this.end.y-this.begin.y)/(this.end.x-this.begin.x)}get intercept(){return this.begin.y-this.slope*this.begin.x}normal(){return this._normal?this._normal:this._normal=this.end.sub(this.begin).normal()}dir(){return this._dir?this._dir:this._dir=this.end.sub(this.begin)}getPoints(){return[this.begin,this.end]}getSlope(){if(this._slope)return this._slope;const ci=this.begin,hi=this.end,_i=ci.distance(hi);return this._slope=hi.sub(ci).scale(1/_i)}getEdge(){const ci=this.begin;return this.end.sub(ci)}getLength(){const ci=this.begin,hi=this.end;return ci.distance(hi)}get midpoint(){return this.begin.add(this.end).scale(.5)}flip(){return new LineSegment(this.end,this.begin)}below(ci){return(this.end.x-this.begin.x)*(ci.y-this.begin.y)-(this.end.y-this.begin.y)*(ci.x-this.begin.x)>=0}clip(ci,hi,_i=!0){let pi=ci;_i&&(pi=pi.normalize());const mi=pi.dot(this.begin)-hi,gi=pi.dot(this.end)-hi,vi=[];if(mi<=0&&vi.push(this.begin),gi<=0&&vi.push(this.end),mi*gi<0){const xi=mi/(mi-gi);vi.push(this.begin.add(this.end.sub(this.begin).scale(xi)))}return vi.length!==2?null:new LineSegment(vi[0],vi[1])}distanceToPoint(ci,hi=!1){const _i=ci.x,pi=ci.y,mi=this.getLength(),gi=this.end.y-this.begin.y,vi=this.end.x-this.begin.x,xi=(gi*_i-vi*pi+this.end.x*this.begin.y-this.end.y*this.begin.x)/mi;return hi?xi:Math.abs(xi)}findVectorToPoint(ci){const hi=this.begin.sub(ci),_i=this.getSlope();return hi.sub(_i.scale(hi.dot(_i)))}findPoint(ci=null,hi=null){const _i=this.slope,pi=this.intercept;if(ci!==null)return new Vector(ci,_i*ci+pi);if(hi!==null)return new Vector((hi-pi)/_i,hi);throw new Error("You must provide an X or a Y value")}hasPoint(){let ci,hi=0;if(typeof arguments[0]=="number"&&typeof arguments[1]=="number")ci=new Vector(arguments[0],arguments[1]),hi=arguments[2]||0;else if(arguments[0]instanceof Vector)ci=arguments[0],hi=arguments[1]||0;else throw"Could not determine the arguments for Vector.hasPoint";const _i=ci.x-this.begin.x,pi=ci.y-this.begin.y,mi=this.end.x-this.begin.x,gi=this.end.y-this.begin.y,vi=_i*gi-pi*mi;return Math.abs(vi)>hi?!1:Math.abs(mi)>=Math.abs(gi)?mi>0?this.begin.x<=ci.x&&ci.x<=this.end.x:this.end.x<=ci.x&&ci.x<=this.begin.x:gi>0?this.begin.y<=ci.y&&ci.y<=this.end.y:this.end.y<=ci.y&&ci.y<=this.begin.y}}function ClosestLine(fi,ci){const _i=fi.dir(),pi=ci.dir(),mi=_i.dot(_i),gi=pi.dot(pi);if(mi<1e-9&&gi<1e-9)return new LineSegment(fi.begin,ci.begin);if(mi<1e-9){const Ii=clamp(pi.dot(fi.begin.sub(ci.begin))/gi,0,1),Ti=ci.begin.add(pi.scale(Ii));return new LineSegment(fi.begin,Ti)}if(gi<1e-9){const Ii=clamp(_i.dot(ci.begin.sub(fi.begin))/mi,0,1),Ti=fi.begin.add(_i.scale(Ii));return new LineSegment(Ti,ci.begin)}const vi=fi.begin.sub(ci.begin),xi=mi,wi=gi,yi=pi.dot(vi),Ci=xi*wi-Math.pow(_i.dot(pi),2);let Ei=0,Si=0;Math.abs(Ci)>1e-9?Ei=clamp((_i.dot(pi)*yi-wi*_i.dot(vi))/Ci,0,1):Ei=clamp(_i.dot(vi)/xi,0,1),Math.abs(wi)>1e-9?Si=clamp((_i.dot(pi)*Ei+yi)/wi,0,1):Si=0;const ki=fi.begin.add(_i.scale(Ei)),Ai=ci.begin.add(pi.scale(Si));return new LineSegment(ki,Ai)}const ClosestLineJumpTable={PolygonPolygonClosestLine(fi,ci){const hi=fi.getSides(),_i=ci.getSides();let pi=Number.MAX_VALUE,mi=null;for(let gi=0;gi<hi.length;gi++)for(let vi=0;vi<_i.length;vi++){const xi=ClosestLine(hi[gi],_i[vi]),wi=xi.getLength();wi<pi&&(pi=wi,mi=xi)}return mi},PolygonEdgeClosestLine(fi,ci){const _i=ci.worldPos.sub(fi.worldPos),pi=new Ray(fi.worldPos,_i),mi=fi.rayCast(pi).point.add(pi.dir.scale(.1)),gi=fi.getClosestFace(mi),vi=ci.asLine();return ClosestLine(gi.face,vi)},PolygonCircleClosestLine(fi,ci){const hi=ci.worldPos,_i=hi.sub(fi.worldPos),pi=new Ray(fi.worldPos,_i.normalize()),mi=fi.rayCast(pi).point.add(pi.dir.scale(.1)),gi=fi.getClosestFace(mi),vi=gi.face.begin,xi=gi.face.getEdge();let wi=(xi.x*(hi.x-vi.x)+xi.y*(hi.y-vi.y))/(xi.x*xi.x+xi.y*xi.y);wi>1?wi=1:wi<0&&(wi=0);const yi=Math.sqrt(Math.pow(vi.x+xi.x*wi-hi.x,2)+Math.pow(vi.y+xi.y*wi-hi.y,2))-ci.radius,Ci=(vi.x+xi.x*wi-hi.x)*ci.radius/(ci.radius+yi),Ei=(vi.y+xi.y*wi-hi.y)*ci.radius/(ci.radius+yi);return new LineSegment(xi.scale(wi).add(vi),new Vector(hi.x+Ci,hi.y+Ei))},CircleCircleClosestLine(fi,ci){const _i=ci.worldPos.sub(fi.worldPos),mi=fi.worldPos.sub(ci.worldPos),gi=new Ray(fi.worldPos,_i),vi=new Ray(ci.worldPos,mi),xi=fi.rayCast(gi),wi=ci.rayCast(vi);return new LineSegment(xi.point,wi.point)},CircleEdgeClosestLine(fi,ci){const hi=fi.worldPos,_i=ci.asLine(),pi=_i.begin,mi=_i.getEdge(),gi=pi,vi=mi;let xi=(vi.x*(hi.x-gi.x)+vi.y*(hi.y-gi.y))/(vi.x*vi.x+vi.y*vi.y);xi>1?xi=1:xi<0&&(xi=0);const wi=Math.sqrt(Math.pow(gi.x+vi.x*xi-hi.x,2)+Math.pow(gi.y+vi.y*xi-hi.y,2))-fi.radius,yi=(gi.x+vi.x*xi-hi.x)*fi.radius/(fi.radius+wi),Ci=(gi.y+vi.y*xi-hi.y)*fi.radius/(fi.radius+wi);return new LineSegment(vi.scale(xi).add(gi),new Vector(hi.x+yi,hi.y+Ci))},EdgeEdgeClosestLine(fi,ci){const hi=fi.asLine(),_i=ci.asLine();return ClosestLine(hi,_i)}};class CircleCollider extends Collider{get worldPos(){return this._globalMatrix.getPosition()}get radius(){var ci;if(this._radius)return this._radius;const hi=this._transform,_i=(ci=hi==null?void 0:hi.globalScale)!==null&&ci!==void 0?ci:Vector.One;return this._radius=this._naturalRadius*Math.min(_i.x,_i.y)}set radius(ci){var hi;const _i=this._transform,pi=(hi=_i==null?void 0:_i.globalScale)!==null&&hi!==void 0?hi:Vector.One;this._naturalRadius=ci/Math.min(pi.x,pi.y),this._localBoundsDirty=!0,this._radius=ci}constructor(ci){super(),this.offset=Vector.Zero,this._globalMatrix=AffineMatrix.identity(),this._localBoundsDirty=!0,this.offset=ci.offset||Vector.Zero,this.radius=ci.radius||0,this._globalMatrix.translate(this.offset.x,this.offset.y)}clone(){return new CircleCollider({offset:this.offset.clone(),radius:this.radius})}get center(){return this._globalMatrix.getPosition()}contains(ci){var hi,_i;return((_i=(hi=this._transform)===null||hi===void 0?void 0:hi.pos)!==null&&_i!==void 0?_i:this.offset).distance(ci)<=this.radius}rayCast(ci,hi=1/0){var _i,pi;const mi=this.center,gi=ci.dir,vi=ci.pos,xi=mi.sub(vi),wi=gi.scale(xi.dot(gi)),Ci=xi.sub(wi).magnitude;if(Ci>this.radius)return null;{let Ei=0;if(approximatelyEqual(Ci,this.radius,1e-4)){if(Ei=-gi.dot(vi.sub(mi)),Ei>0&&Ei<hi){const Si=ci.getPoint(Ei);return{point:Si,normal:Si.sub(mi).normalize(),collider:this,body:(_i=this.owner)===null||_i===void 0?void 0:_i.get(BodyComponent),distance:Ei}}return null}else{const Si=Math.sqrt(Math.pow(gi.dot(vi.sub(mi)),2)-Math.pow(vi.sub(mi).distance(),2)+Math.pow(this.radius,2)),ki=-gi.dot(vi.sub(mi))+Si,Ai=-gi.dot(vi.sub(mi))-Si,Ii=[];ki>=0&&Ii.push(ki),Ai>=0&&Ii.push(Ai);const Ti=Math.min(...Ii);if(Ti<=hi){const Pi=ci.getPoint(Ti);return{point:Pi,normal:Pi.sub(mi).normalize(),collider:this,body:(pi=this.owner)===null||pi===void 0?void 0:pi.get(BodyComponent),distance:Ti}}return null}}}getClosestLineBetween(ci){if(ci instanceof CircleCollider)return ClosestLineJumpTable.CircleCircleClosestLine(this,ci);if(ci instanceof PolygonCollider)return ClosestLineJumpTable.PolygonCircleClosestLine(ci,this).flip();if(ci instanceof EdgeCollider)return ClosestLineJumpTable.CircleEdgeClosestLine(this,ci).flip();throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof ci}`)}collide(ci){if(ci instanceof CircleCollider)return CollisionJumpTable.CollideCircleCircle(this,ci);if(ci instanceof PolygonCollider)return CollisionJumpTable.CollideCirclePolygon(this,ci);if(ci instanceof EdgeCollider)return CollisionJumpTable.CollideCircleEdge(this,ci);throw new Error(`Circle could not collide with unknown CollisionShape ${typeof ci}`)}getFurthestPoint(ci){return this.center.add(ci.normalize().scale(this.radius))}getFurthestLocalPoint(ci){return ci.normalize().scale(this.radius)}get bounds(){return this.localBounds.transform(this._globalMatrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=new BoundingBox(-this._naturalRadius,-this._naturalRadius,+this._naturalRadius,+this._naturalRadius),this._localBoundsDirty=!1),this._localBounds}get axes(){return[]}getInertia(ci){return ci*this.radius*this.radius/2}update(ci){var hi;this._transform=ci,((hi=ci.matrix)!==null&&hi!==void 0?hi:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y),this._radius=void 0}project(ci){const hi=[],pi=this.center.dot(ci);return hi.push(pi),hi.push(pi+this.radius),hi.push(pi-this.radius),new Projection(Math.min.apply(Math,hi),Math.max.apply(Math,hi))}debug(ci,hi,_i){var pi,mi,gi,vi;const{lineWidth:xi}={lineWidth:1,..._i},wi=this._transform,yi=(pi=wi==null?void 0:wi.globalScale)!==null&&pi!==void 0?pi:Vector.One,Ci=(mi=wi==null?void 0:wi.globalRotation)!==null&&mi!==void 0?mi:0,Ei=(gi=wi==null?void 0:wi.globalPos)!==null&&gi!==void 0?gi:Vector.Zero;ci.save(),ci.translate(Ei.x,Ei.y),ci.rotate(Ci),ci.scale(yi.x,yi.y),ci.drawCircle((vi=this.offset)!==null&&vi!==void 0?vi:Vector.Zero,this._naturalRadius,Color.Transparent,hi,xi),ci.restore()}}class CollisionContact{constructor(ci,hi,_i,pi,mi,gi,vi,xi){var wi,yi,Ci,Ei,Si,ki;if(this._canceled=!1,this.bodyA=null,this.bodyB=null,this.colliderA=ci,this.colliderB=hi,this.mtv=_i,this.normal=pi,this.tangent=mi,this.points=gi,this.localPoints=vi,this.info=xi,this.id=Pair.calculatePairHash(ci.id,hi.id),ci.composite||hi.composite){const Ai=((wi=ci.composite)===null||wi===void 0?void 0:wi.compositeStrategy)==="separate"?ci.id:(Ci=(yi=ci.composite)===null||yi===void 0?void 0:yi.id)!==null&&Ci!==void 0?Ci:ci.id,Ii=((Ei=hi.composite)===null||Ei===void 0?void 0:Ei.compositeStrategy)==="separate"?hi.id:(ki=(Si=hi.composite)===null||Si===void 0?void 0:Si.id)!==null&&ki!==void 0?ki:hi.id;this.id+="|"+Pair.calculatePairHash(Ai,Ii)}this.colliderA.owner&&(this.bodyA=this.colliderA.owner.get(BodyComponent)),this.colliderB.owner&&(this.bodyB=this.colliderB.owner.get(BodyComponent))}matchAwake(){const ci=this.bodyA,hi=this.bodyB;ci&&hi&&ci.isSleeping!==hi.isSleeping&&(ci.isSleeping&&ci.collisionType!==CollisionType.Fixed&&hi.sleepMotion>=ci.wakeThreshold&&(ci.isSleeping=!1),hi.isSleeping&&hi.collisionType!==CollisionType.Fixed&&ci.sleepMotion>=hi.wakeThreshold&&(hi.isSleeping=!1))}isCanceled(){return this._canceled}cancel(){this._canceled=!0}bias(ci){if(ci!==this.colliderA&&ci!==this.colliderB)throw new Error("Collider must be either colliderA or colliderB from this contact");if(ci===this.colliderA)return this;const hi=this.colliderA,_i=this.colliderB;return this.colliderB=hi,this.colliderA=_i,this.mtv=this.mtv.negate(),this.normal=this.normal.negate(),this.tangent=this.tangent.negate(),this}}class SeparationInfo{constructor(){this.axis=vec(0,0),this.localAxis=vec(0,0),this.side=new LineSegment(vec(0,0),vec(0,0)),this.localSide=new LineSegment(vec(0,0),vec(0,0)),this.point=vec(0,0),this.localPoint=vec(0,0)}}class SeparatingAxis{static findPolygonPolygonSeparation(ci,hi){if(hi.transform.matrix.determinant()===0)return SeparatingAxis.findPolygonPolygonSeparationDegenerate(ci,hi);let _i=-Number.MAX_VALUE,pi=-1,mi;const gi=hi.transform.inverse.multiply(ci.transform.matrix,SeparatingAxis._SCRATCH_MATRIX),vi=gi.getRotation(),xi=ci.normals,wi=ci.points,yi=hi.points;for(let Si=0;Si<wi.length;Si++){const ki=xi[Si].rotate(vi,SeparatingAxis._ZERO,SeparatingAxis._SCRATCH_NORMAL),Ai=gi.multiply(wi[Si],SeparatingAxis._SCRATCH_POINT);let Ii=Number.MAX_VALUE,Ti;for(let Pi=0;Pi<yi.length;Pi++){const Li=ki.dot(yi[Pi].sub(Ai,SeparatingAxis._SCRATCH_SUB_POINT));Li<Ii&&(Ii=Li,Ti=yi[Pi])}Ii>_i&&(_i=Ii,pi=Si,mi=Ti)}const Ci=(pi+1)%wi.length,Ei=SeparatingAxis.SeparationPool.get();return Ei.collider=ci,Ei.separation=_i,_i>0||(xi[pi].clone(Ei.localAxis),xi[pi].rotate(ci.transform.rotation,SeparatingAxis._ZERO,Ei.axis),ci.transform.matrix.multiply(wi[pi],Ei.side.begin),ci.transform.matrix.multiply(wi[Ci],Ei.side.end),hi.transform.matrix.multiply(mi,Ei.point),Ei.sideId=pi,mi.clone(Ei.localPoint),wi[pi].clone(Ei.localSide.begin),wi[Ci].clone(Ei.localSide.end)),Ei}static findCirclePolygonSeparation(ci,hi){const _i=hi.axes,mi=hi.center.sub(ci.worldPos),gi=hi.getFurthestPoint(mi.negate());_i.push(gi.sub(ci.worldPos).normalize());let vi=Number.MAX_VALUE,xi=null,wi=-1;for(let yi=0;yi<_i.length;yi++){const Ci=hi.project(_i[yi]),Ei=ci.project(_i[yi]),Si=Ci.getOverlap(Ei);if(Si<=0)return null;Si<vi&&(vi=Si,xi=_i[yi],wi=yi)}return wi<0?null:xi.normalize().scale(vi)}static findPolygonPolygonSeparationDegenerate(ci,hi){let _i=-Number.MAX_VALUE,pi=null,mi=null,gi=-1,vi=null;const xi=ci.getSides(),wi=ci.getLocalSides();for(let yi=0;yi<xi.length;yi++){const Ci=xi[yi],Ei=Ci.normal(),Si=hi.getFurthestPoint(Ei.negate()),ki=Ci.distanceToPoint(Si,!0);ki>_i&&(_i=ki,pi=Ci,mi=Ei,gi=yi,vi=Si)}return{collider:ci,separation:mi?_i:99,axis:mi,side:pi,localSide:wi[gi],sideId:gi,point:vi,localPoint:mi?hi.getFurthestLocalPoint(mi.negate()):null}}}SeparatingAxis.SeparationPool=new Pool(()=>new SeparationInfo,fi=>fi,500);SeparatingAxis._ZERO=vec(0,0);SeparatingAxis._SCRATCH_POINT=vec(0,0);SeparatingAxis._SCRATCH_SUB_POINT=vec(0,0);SeparatingAxis._SCRATCH_NORMAL=vec(0,0);SeparatingAxis._SCRATCH_MATRIX=AffineMatrix.identity();SeparatingAxis.SeparationPool.disableWarnings=!0;const ScratchZero=Vector.Zero,ScratchNormal=Vector.Zero,ScratchMatrix=AffineMatrix.identity(),CollisionJumpTable={CollideCircleCircle(fi,ci){const hi=fi.worldPos,_i=ci.worldPos,pi=fi.radius+ci.radius,mi=hi.distance(_i);if(mi>pi)return[];const gi=pi-mi,vi=_i.sub(hi).normalize(),xi=vi.perpendicular(),wi=vi.scale(gi),yi=fi.getFurthestPoint(vi),Ci=fi.getFurthestLocalPoint(vi),Ei={collider:fi,separation:gi,axis:vi,point:yi};return[new CollisionContact(fi,ci,wi,vi,xi,[yi],[Ci],Ei)]},CollideCirclePolygon(fi,ci){var hi,_i;let pi=SeparatingAxis.findCirclePolygonSeparation(fi,ci);if(!pi)return[];pi=pi.dot(ci.center.sub(fi.center))<0?pi.negate():pi;const gi=fi.getFurthestPoint(pi),xi=((_i=(hi=fi.owner)===null||hi===void 0?void 0:hi.get(TransformComponent))!==null&&_i!==void 0?_i:new TransformComponent).applyInverse(gi),wi=pi.normalize(),yi={collider:fi,separation:-pi.magnitude,axis:wi,point:gi,localPoint:xi,side:ci.findSide(wi.negate()),localSide:ci.findLocalSide(wi.negate())};return[new CollisionContact(fi,ci,pi,wi,wi.perpendicular(),[gi],[xi],yi)]},CollideCircleEdge(fi,ci){const hi=fi.center,_i=ci.asLine(),pi=_i.end.sub(_i.begin),mi=pi.dot(_i.end.sub(hi)),gi=pi.dot(hi.sub(_i.begin)),vi=ci.asLine(),xi=ci.asLocalLine();if(gi<=0){const Ti=_i.begin.sub(hi),Pi=Ti.dot(Ti);if(Pi>fi.radius*fi.radius)return[];const Li=Ti.normalize(),Ri=fi.radius-Math.sqrt(Pi),Di={collider:fi,separation:Ri,axis:Li,point:vi.begin,side:vi,localSide:xi};return[new CollisionContact(fi,ci,Li.scale(Ri),Li,Li.perpendicular(),[vi.begin],[xi.begin],Di)]}if(mi<=0){const Ti=_i.end.sub(hi),Pi=Ti.dot(Ti);if(Pi>fi.radius*fi.radius)return[];const Li=Ti.normalize(),Ri=fi.radius-Math.sqrt(Pi),Di={collider:fi,separation:Ri,axis:Li,point:vi.end,side:vi,localSide:xi};return[new CollisionContact(fi,ci,Li.scale(Ri),Li,Li.perpendicular(),[vi.end],[xi.end],Di)]}const wi=pi.dot(pi),yi=_i.begin.scale(mi).add(_i.end.scale(gi)).scale(1/wi),Ci=hi.sub(yi),Ei=Ci.dot(Ci);if(Ei>fi.radius*fi.radius)return[];let Si=pi.perpendicular();Si.dot(hi.sub(_i.begin))<0&&(Si.x=-Si.x,Si.y=-Si.y),Si=Si.normalize();const ki=fi.radius-Math.sqrt(Ei),Ai=Si.scale(ki),Ii={collider:fi,separation:ki,axis:Si,point:yi,side:vi,localSide:xi};return[new CollisionContact(fi,ci,Ai,Si.negate(),Si.negate().perpendicular(),[yi],[yi.sub(ci.worldPos)],Ii)]},CollideEdgeEdge(){return[]},CollidePolygonEdge(fi,ci){var hi;const _i=fi.center,mi=ci.center.sub(_i).normalize(),gi=new PolygonCollider({points:[ci.begin,ci.end,ci.end.add(mi.scale(100)),ci.begin.add(mi.scale(100))],offset:ci.offset});gi.owner=ci.owner,((hi=ci.owner)===null||hi===void 0?void 0:hi.get(TransformComponent))&&gi.update(ci.owner.get(TransformComponent).get());const xi=this.CollidePolygonPolygon(fi,gi);return xi.length&&(xi[0].colliderB=ci,xi[0].id=Pair.calculatePairHash(fi.id,ci.id)),xi},CollidePolygonPolygon(fi,ci){const hi=SeparatingAxis.findPolygonPolygonSeparation(fi,ci);if(hi.separation>0)return[];const _i=SeparatingAxis.findPolygonPolygonSeparation(ci,fi);if(_i.separation>0)return[];const pi=hi.separation>_i.separation?hi:_i,mi=pi.collider===fi?ci:fi,gi=pi.collider===fi?fi:ci,vi=mi.transform.inverse.multiply(gi.transform.matrix,ScratchMatrix),xi=vi.getRotation(),wi=gi.normals[pi.sideId].rotate(xi,ScratchZero,ScratchNormal);let yi=Number.MAX_VALUE,Ci=0;for(let Ti=0;Ti<mi.normals.length;Ti++){const Pi=wi.dot(mi.normals[Ti]);Pi<yi&&(yi=Pi,Ci=Ti)}if(!pi.localSide||!pi.localAxis||!pi.axis)return[];const Ei=pi.localSide.transform(vi),Si=pi.localAxis.perpendicular().negate().rotate(xi),Ai=new LineSegment(mi.points[Ci],mi.points[(Ci+1)%mi.points.length]).clip(Si.negate(),-Si.dot(Ei.begin),!1);let Ii=null;if(Ai&&(Ii=Ai.clip(Si,Si.dot(Ei.end),!1)),Ii){const Ti=[],Pi=[],Li=Ii.getPoints();for(let Fi=0;Fi<Li.length;Fi++){const Mi=Li[Fi];Ei.below(Mi)&&(Ti.push(Mi),Pi.push(mi.transform.apply(Mi)))}let Ri=pi.axis,Di=Ri.perpendicular();return ci.center.sub(fi.center).dot(Ri)<0&&(Ri=Ri.negate(),Di=Ri.perpendicular()),[new CollisionContact(fi,ci,Ri.scale(-pi.separation),Ri,Di,Pi,Ti,pi)]}return[]},FindContactSeparation(fi,ci){var hi,_i,pi,mi;const gi=fi.colliderA,vi=(_i=(hi=fi.bodyA)===null||hi===void 0?void 0:hi.transform)!==null&&_i!==void 0?_i:new TransformComponent,xi=fi.colliderB,wi=(mi=(pi=fi.bodyB)===null||pi===void 0?void 0:pi.transform)!==null&&mi!==void 0?mi:new TransformComponent;if(gi instanceof CircleCollider&&xi instanceof CircleCollider){const yi=gi.radius+xi.radius,Ci=vi.pos.distance(wi.pos);return-(yi-Ci)}if(gi instanceof PolygonCollider&&xi instanceof PolygonCollider&&fi.info.localSide){let yi,Ci;return fi.info.collider===gi?(yi=new LineSegment(vi.apply(fi.info.localSide.begin).add(gi.offset),vi.apply(fi.info.localSide.end).add(gi.offset)),Ci=wi.apply(ci).add(xi.offset)):(yi=new LineSegment(wi.apply(fi.info.localSide.begin).add(xi.offset),wi.apply(fi.info.localSide.end).add(xi.offset)),Ci=vi.apply(ci).add(gi.offset)),yi.distanceToPoint(Ci,!0)}if(gi instanceof PolygonCollider&&xi instanceof CircleCollider||xi instanceof PolygonCollider&&gi instanceof CircleCollider){const yi=vi.apply(ci);if(fi.info.side)return fi.info.side.distanceToPoint(yi,!0)}if(gi instanceof EdgeCollider&&xi instanceof PolygonCollider||xi instanceof EdgeCollider&&gi instanceof PolygonCollider){let yi;if(fi.info.collider===gi?yi=wi.apply(ci):yi=vi.apply(ci),fi.info.side)return fi.info.side.distanceToPoint(yi,!0)}if(gi instanceof CircleCollider&&xi instanceof EdgeCollider||xi instanceof CircleCollider&&gi instanceof EdgeCollider){const yi=wi.apply(ci);let Ci;gi instanceof CircleCollider&&(Ci=gi.getFurthestPoint(fi.normal));const Ei=yi.distance(Ci);if(fi.info.side)return Ei>0?-Ei:0}return 0}};class EdgeCollider extends Collider{constructor(ci){var hi;super(),this._globalMatrix=AffineMatrix.identity(),this.begin=ci.begin||Vector.Zero,this.end=ci.end||Vector.Zero,this.offset=(hi=ci.offset)!==null&&hi!==void 0?hi:Vector.Zero}clone(){return new EdgeCollider({begin:this.begin.clone(),end:this.end.clone()})}get worldPos(){var ci;const hi=this._transform;return(ci=hi==null?void 0:hi.globalPos.add(this.offset))!==null&&ci!==void 0?ci:this.offset}get center(){const ci=this._getTransformedBegin(),hi=this._getTransformedEnd();return ci.average(hi)}_getTransformedBegin(){return this._globalMatrix.multiply(this.begin)}_getTransformedEnd(){return this._globalMatrix.multiply(this.end)}getSlope(){const ci=this._getTransformedBegin(),hi=this._getTransformedEnd(),_i=ci.distance(hi);return hi.sub(ci).scale(1/_i)}getLength(){const ci=this._getTransformedBegin(),hi=this._getTransformedEnd();return ci.distance(hi)}contains(){return!1}rayCast(ci,hi=1/0){var _i;const pi=this._getTransformedBegin().sub(ci.pos);if(ci.dir.cross(this.getSlope())===0&&pi.cross(ci.dir)!==0)return null;const mi=ci.dir.cross(this.getSlope());if(mi===0)return null;const gi=pi.cross(this.getSlope())/mi;if(gi>=0&&gi<=hi){const vi=pi.cross(ci.dir)/mi/this.getLength();if(vi>=0&&vi<=1)return{distance:gi,normal:this.asLine().normal(),collider:this,body:(_i=this.owner)===null||_i===void 0?void 0:_i.get(BodyComponent),point:ci.getPoint(gi)}}return null}getClosestLineBetween(ci){if(ci instanceof CircleCollider)return ClosestLineJumpTable.CircleEdgeClosestLine(ci,this);if(ci instanceof PolygonCollider)return ClosestLineJumpTable.PolygonEdgeClosestLine(ci,this).flip();if(ci instanceof EdgeCollider)return ClosestLineJumpTable.EdgeEdgeClosestLine(this,ci);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof ci}`)}collide(ci){if(ci instanceof CircleCollider)return CollisionJumpTable.CollideCircleEdge(ci,this);if(ci instanceof PolygonCollider)return CollisionJumpTable.CollidePolygonEdge(ci,this);if(ci instanceof EdgeCollider)return CollisionJumpTable.CollideEdgeEdge();throw new Error(`Edge could not collide with unknown CollisionShape ${typeof ci}`)}getFurthestPoint(ci){const hi=this._getTransformedBegin(),_i=this._getTransformedEnd();return ci.dot(hi)>0?hi:_i}_boundsFromBeginEnd(ci,hi,_i=10){return new BoundingBox(Math.min(ci.x,hi.x)-_i,Math.min(ci.y,hi.y)-_i,Math.max(ci.x,hi.x)+_i,Math.max(ci.y,hi.y)+_i)}get bounds(){const ci=this._getTransformedBegin(),hi=this._getTransformedEnd();return this._boundsFromBeginEnd(ci,hi)}get localBounds(){return this._boundsFromBeginEnd(this.begin,this.end)}asLine(){return new LineSegment(this._getTransformedBegin(),this._getTransformedEnd())}asLocalLine(){return new LineSegment(this.begin,this.end)}get axes(){const hi=this._getTransformedEnd().sub(this._getTransformedBegin()).normal(),_i=[];return _i.push(hi),_i.push(hi.negate()),_i.push(hi.normal()),_i.push(hi.normal().negate()),_i}getInertia(ci){const hi=this.end.sub(this.begin).distance()/2;return ci*hi*hi}update(ci){var hi;this._transform=ci,((hi=ci.matrix)!==null&&hi!==void 0?hi:this._globalMatrix).clone(this._globalMatrix),this._globalMatrix.translate(this.offset.x,this.offset.y)}project(ci){const hi=[],_i=[this._getTransformedBegin(),this._getTransformedEnd()],pi=_i.length;for(let mi=0;mi<pi;mi++)hi.push(_i[mi].dot(ci));return new Projection(Math.min.apply(Math,hi),Math.max.apply(Math,hi))}debug(ci,hi){const _i=this._getTransformedBegin(),pi=this._getTransformedEnd();ci.drawLine(_i,pi,hi,2),ci.drawCircle(_i,2,hi),ci.drawCircle(pi,2,hi)}}class Debug{static registerGraphicsContext(ci){Debug._ctx=ci}static draw(ci){this._drawCalls.push(ci)}static drawPoint(ci,hi){Debug.draw(_i=>{_i.debug.drawPoint(ci,hi)})}static drawLine(ci,hi,_i){Debug.draw(pi=>{pi.debug.drawLine(ci,hi,_i)})}static drawLines(ci,hi){ci.length>1&&Debug.draw(_i=>{for(let pi=0;pi<ci.length-1;pi++)_i.debug.drawLine(ci[pi],ci[pi+1],hi)})}static drawText(ci,hi){Debug.draw(_i=>{_i.debug.drawText(ci,hi)})}static drawPolygon(ci,hi){ci.length>1&&Debug.draw(_i=>{const pi=ci[0],mi=[...ci,pi];for(let gi=0;gi<mi.length-1;gi++)_i.debug.drawLine(mi[gi],mi[gi+1],hi)})}static drawCircle(ci,hi,_i){const{color:pi,strokeColor:mi,width:gi}={color:Color.Black,strokeColor:void 0,width:void 0,..._i};Debug.draw(vi=>{vi.drawCircle(ci,hi,pi,mi,gi)})}static drawBounds(ci,hi){Debug.draw(_i=>{_i.debug.drawRect(ci.left,ci.top,ci.width,ci.height,hi)})}static drawRay(ci,hi){const{distance:_i,color:pi}={color:Color.Blue,distance:10,...hi};Debug.draw(mi=>{const gi=ci.pos,vi=ci.pos.add(ci.dir.scale(_i));mi.debug.drawLine(gi,vi,{color:pi})})}static flush(ci){ci.save(),ci.z=Debug.z;for(const hi of Debug._drawCalls)hi(ci);ci.restore(),Debug.clear()}static clear(){Debug._drawCalls.length=0}}Debug._drawCalls=[];Debug.z=1/0;class PolygonCollider extends Collider{flagDirty(){this._localBoundsDirty=!0,this._localSidesDirty=!0,this._transformedPointsDirty=!0,this._sidesDirty=!0}get normals(){return this._normals}set points(ci){if(ci.length<3)throw new Error("PolygonCollider cannot be created with less that 3 points");this._points=ci,this._checkAndUpdateWinding(this._points),this._calculateNormals(),this.flagDirty()}_calculateNormals(){const ci=[];for(let hi=0;hi<this._points.length;hi++)ci.push(this._points[(hi+1)%this._points.length].sub(this._points[hi]).normal());this._normals=ci}get points(){return this._points}get transform(){return this._transform}constructor(ci){var hi;super(),this._logger=Logger.getInstance(),this._transform=new transform_Transform,this._transformedPoints=[],this._sides=[],this._localSides=[],this._transformedPointsDirty=!0,this._sidesDirty=!0,this._localSidesDirty=!0,this._localBoundsDirty=!0,this.offset=(hi=ci.offset)!==null&&hi!==void 0?hi:Vector.Zero,this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y,this.points=ci.points,this.isConvex()||ci.suppressConvexWarning||this._logger.warn("Excalibur only supports convex polygon colliders and will not behave properly.Call PolygonCollider.triangulate() to build a new collider composed of smaller convex triangles"),this._calculateTransformation()}_checkAndUpdateWinding(ci){this._isCounterClockwiseWinding(ci)||ci.reverse()}_isCounterClockwiseWinding(ci){let hi=0;for(let _i=0;_i<ci.length;_i++)hi+=(ci[(_i+1)%ci.length].x-ci[_i].x)*(ci[(_i+1)%ci.length].y+ci[_i].y);return hi<0}isConvex(){if(this.points.length<3)return!1;let ci=this.points[this.points.length-2],hi=this.points[this.points.length-1],_i=Math.atan2(hi.y-ci.y,hi.x-ci.x),pi=0,mi=0,gi=0;for(const[vi,xi]of this.points.entries()){if(ci=hi,pi=_i,hi=xi,_i=Math.atan2(hi.y-ci.y,hi.x-ci.x),ci.equals(hi))return!1;let wi=_i-pi;if(wi<=-Math.PI?wi+=Math.PI*2:wi>Math.PI&&(wi-=Math.PI*2),vi===0){if(wi===0)return!1;mi=wi>0?1:-1}else if(mi*wi<=0)return!1;gi+=wi}return Math.abs(Math.round(gi/(Math.PI*2)))===1}tessellate(){const ci=[];for(let hi=1;hi<this.points.length-2;hi++)ci.push([this.points[0],this.points[hi+1],this.points[hi+2]]);return ci.push([this.points[0],this.points[1],this.points[2]]),new CompositeCollider(ci.map(hi=>Shape.Polygon(hi)))}triangulate(){if(this.points.length<3)throw Error("Invalid polygon");const ci=[],hi=[...this.points].reverse();let _i=hi.length;function pi(Ci){return Ci===0?_i-1:Ci-1}function mi(Ci){return Ci===_i-1?0:Ci+1}function gi(Ci){const Ei=pi(Ci),Si=mi(Ci),ki=hi[Ei],Ai=hi[Ci],Ii=hi[Si],Ti=ki.sub(Ai),Pi=Ii.sub(Ai);return!(Ti.cross(Pi)<0)}const vi=hi.map((Ci,Ei)=>gi(Ei));function xi(Ci,Ei,Si,ki){const Ai=Si.sub(Ei),Ii=ki.sub(Si),Ti=Ei.sub(ki),Pi=Ci.sub(Ei),Li=Ci.sub(Si),Ri=Ci.sub(ki),Di=Ai.cross(Pi),Fi=Ii.cross(Li),Mi=Ti.cross(Ri);return!(Di>0||Fi>0||Mi>0)}function wi(){for(let Ci=0;Ci<_i;Ci++)if(vi[Ci]){const Ei=pi(Ci),Si=mi(Ci),ki=hi[Ei],Ai=hi[Ci],Ii=hi[Si];let Ti=!0;for(let Pi=0;Pi<_i;Pi++){if(Pi===Ci||Pi===Ei||Pi===Si)continue;const Li=hi[Pi];if(xi(Li,ki,Ai,Ii)){Ti=!1;break}}if(Ti)return Ci}for(let Ci=0;Ci<_i;Ci++)if(vi[Ci])return Ci;return 0}function yi(Ci){const Ei=pi(Ci),Si=mi(Ci),ki=hi[Ei],Ai=hi[Ci],Ii=hi[Si];ci.push([ki,Ai,Ii]),hi.splice(Ci,1),vi.splice(Ci,1),_i--}for(;_i>3;){const Ci=wi();yi(Ci);for(let Ei=0;Ei<_i;Ei++)vi[Ei]=gi(Ei)}return ci.push([hi[0],hi[1],hi[2]]),new CompositeCollider(ci.map(Ci=>Shape.Polygon(Ci,Vector.Zero,!0)))}clone(){return new PolygonCollider({offset:this.offset.clone(),points:this.points.map(ci=>ci.clone())})}get worldPos(){return this._transform.pos}get center(){return this.bounds.center}_calculateTransformation(){const ci=this.points,hi=ci.length;this._transformedPoints.length=0;for(let _i=0;_i<hi;_i++)this._transformedPoints[_i]=this._transform.apply(ci[_i].clone())}getTransformedPoints(){return this._transformedPointsDirty&&(this._calculateTransformation(),this._transformedPointsDirty=!1),this._transformedPoints}getSides(){if(this._sidesDirty){const ci=[],hi=this.getTransformedPoints(),_i=hi.length;for(let pi=0;pi<_i;pi++)ci.push(new LineSegment(hi[pi],hi[(pi+1)%_i]));this._sides=ci,this._sidesDirty=!1}return this._sides}getLocalSides(){if(this._localSidesDirty){const ci=[],hi=this.points,_i=hi.length;for(let pi=0;pi<_i;pi++)ci.push(new LineSegment(hi[pi],hi[(pi+1)%_i]));this._localSides=ci,this._localSidesDirty=!1}return this._localSides}findSide(ci){const hi=this.getSides();let _i=hi[0],pi=-Number.MAX_VALUE;for(let mi=0;mi<hi.length;mi++){const gi=hi[mi],xi=gi.normal().dot(ci);xi>pi&&(_i=gi,pi=xi)}return _i}findLocalSide(ci){const hi=this.getLocalSides();let _i=hi[0],pi=-Number.MAX_VALUE;for(let mi=0;mi<hi.length;mi++){const gi=hi[mi],xi=gi.normal().dot(ci);xi>pi&&(_i=gi,pi=xi)}return _i}get axes(){const ci=[],hi=this.getSides();for(let _i=0;_i<hi.length;_i++)ci.push(hi[_i].normal());return ci}update(ci){ci&&(ci.cloneWithParent(this._transform),this._transformedPointsDirty=!0,this._sidesDirty=!0,(this.offset.x!==0||this.offset.y!==0)&&(this._transform.pos.x+=this.offset.x,this._transform.pos.y+=this.offset.y),this._transform.isMirrored()&&(this.points=this.points.map(hi=>vec(hi.x*sign(this._transform.scale.x),hi.y*sign(this._transform.scale.y))),this._transform.scale.x=Math.abs(this._transform.scale.x),this._transform.scale.y=Math.abs(this._transform.scale.y)))}contains(ci){const hi=this._transform.applyInverse(ci),_i=new Ray(hi,new Vector(1,0));let pi=0;const mi=this.getLocalSides();for(let gi=0;gi<mi.length;gi++){const vi=mi[gi];_i.intersect(vi)>=0&&pi++}return pi%2!==0}getClosestLineBetween(ci){if(ci instanceof CircleCollider)return ClosestLineJumpTable.PolygonCircleClosestLine(this,ci);if(ci instanceof PolygonCollider)return ClosestLineJumpTable.PolygonPolygonClosestLine(this,ci);if(ci instanceof EdgeCollider)return ClosestLineJumpTable.PolygonEdgeClosestLine(this,ci);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof ci}`)}collide(ci){if(ci instanceof CircleCollider)return CollisionJumpTable.CollideCirclePolygon(ci,this);if(ci instanceof PolygonCollider)return CollisionJumpTable.CollidePolygonPolygon(this,ci);if(ci instanceof EdgeCollider)return CollisionJumpTable.CollidePolygonEdge(this,ci);throw new Error(`Polygon could not collide with unknown CollisionShape ${typeof ci}`)}getFurthestPoint(ci){const hi=this.getTransformedPoints();let _i=null,pi=-Number.MAX_VALUE;for(let mi=0;mi<hi.length;mi++){const gi=ci.dot(hi[mi]);gi>pi&&(pi=gi,_i=hi[mi])}return _i}getFurthestLocalPoint(ci){const hi=this.points;let _i=hi[0],pi=-Number.MAX_VALUE;for(let mi=0;mi<hi.length;mi++){const gi=ci.dot(hi[mi]);gi>pi&&(pi=gi,_i=hi[mi])}return _i}getClosestFace(ci){const hi=this.getSides();let _i=Number.POSITIVE_INFINITY,pi=-1,mi=-1;for(let gi=0;gi<hi.length;gi++){const vi=hi[gi].distanceToPoint(ci);vi<_i&&(_i=vi,pi=gi,mi=vi)}return pi!==-1?{distance:hi[pi].normal().scale(mi),face:hi[pi]}:null}get bounds(){return this.localBounds.transform(this._transform.matrix)}get localBounds(){return this._localBoundsDirty&&(this._localBounds=BoundingBox.fromPoints(this.points),this._localBoundsDirty=!1),this._localBounds}getInertia(ci){if(this._cachedMass===ci&&this._cachedInertia)return this._cachedInertia;let hi=0,_i=0;const pi=this.points;for(let mi=0;mi<pi.length;mi++){const gi=(mi+1)%pi.length,vi=pi[gi].cross(pi[mi]);hi+=vi*(pi[mi].dot(pi[mi])+pi[mi].dot(pi[gi])+pi[gi].dot(pi[gi])),_i+=vi}return this._cachedMass=ci,this._cachedInertia=ci/6*(hi/_i)}rayCast(ci,hi=1/0){var _i;const pi=this.getSides(),mi=pi.length;let gi=Number.MAX_VALUE,vi,xi=-1;for(let wi=0;wi<mi;wi++){const yi=ci.intersect(pi[wi]);yi>=0&&yi<gi&&yi<=hi&&(gi=yi,vi=pi[wi],xi=wi)}return xi>=0?{collider:this,distance:gi,body:(_i=this.owner)===null||_i===void 0?void 0:_i.get(BodyComponent),point:ci.getPoint(gi),normal:vi.normal()}:null}project(ci){const hi=this.getTransformedPoints(),_i=hi.length;let pi=Number.MAX_VALUE,mi=-Number.MAX_VALUE;for(let gi=0;gi<_i;gi++){const vi=hi[gi].dot(ci);pi=Math.min(pi,vi),mi=Math.max(mi,vi)}return new Projection(pi,mi)}debug(ci,hi,_i){const pi=this.getTransformedPoints();Debug.drawPolygon(pi,{color:hi})}}class Shape{static Box(ci,hi,_i=Vector.Half,pi=Vector.Zero){return new PolygonCollider({points:new BoundingBox(-ci*_i.x,-hi*_i.y,ci-ci*_i.x,hi-hi*_i.y).getPoints(),offset:pi})}static Polygon(ci,hi=Vector.Zero,_i=!1){return new PolygonCollider({points:ci,offset:hi,suppressConvexWarning:_i})}static Circle(ci,hi=Vector.Zero){return new CircleCollider({radius:ci,offset:hi})}static Edge(ci,hi){return new EdgeCollider({begin:ci,end:hi})}static Capsule(ci,hi,_i=Vector.Zero){const pi=Logger.getInstance();return ci===hi&&pi.warn("A capsule collider with equal width and height is a circle, consider using a ex.Shape.Circle or ex.CircleCollider"),hi>=ci?new CompositeCollider([Shape.Circle(ci/2,vec(0,-hi/2+ci/2).add(_i)),Shape.Box(ci,hi-ci,Vector.Half,_i),Shape.Circle(ci/2,vec(0,hi/2-ci/2).add(_i))]):new CompositeCollider([Shape.Circle(hi/2,vec(-ci/2+hi/2,0).add(_i)),Shape.Box(ci-hi,hi,Vector.Half,_i),Shape.Circle(hi/2,vec(ci/2-hi/2,0).add(_i))])}}class ColliderComponent extends Component{constructor(ci){super(),this.events=new EventEmitter,this.$colliderAdded=new Observable,this.$colliderRemoved=new Observable,this._collidersToRemove=[],this.set(ci)}get(){return this._collider}set(ci){return this.clear(),ci&&(this._collider=ci,this._collider.owner=this.owner,ci.events.pipe(this.events),this.$colliderAdded.notifyAll(ci),this.update()),ci}clear(){this._collider&&(this._collidersToRemove.push(this._collider),this._collider=null)}processColliderRemoval(){for(const ci of this._collidersToRemove)ci.events.unpipe(this.events),this.$colliderRemoved.notifyAll(ci),ci.owner=null}clone(){return new ColliderComponent(this._collider.clone())}get bounds(){var ci,hi;return(hi=(ci=this._collider)===null||ci===void 0?void 0:ci.bounds)!==null&&hi!==void 0?hi:new BoundingBox}get localBounds(){var ci,hi;return(hi=(ci=this._collider)===null||ci===void 0?void 0:ci.localBounds)!==null&&hi!==void 0?hi:new BoundingBox}update(){var ci;const hi=(ci=this.owner)===null||ci===void 0?void 0:ci.get(TransformComponent);this._collider&&(this._collider.owner=this.owner,hi&&this._collider.update(hi.get()))}collide(ci){let hi=this._collider,_i=ci._collider;if(!hi||!_i)return[];let pi=!1;if(_i instanceof CompositeCollider&&(hi=_i,_i=this._collider,pi=!0),this._collider){const mi=hi.collide(_i);return mi?(pi&&mi.forEach(gi=>{gi.mtv=gi.mtv.negate(),gi.normal=gi.normal.negate(),gi.tangent=gi.normal.perpendicular(),gi.colliderA=this._collider,gi.colliderB=ci._collider}),mi):[]}return[]}onAdd(ci){this._collider&&this.update(),this.events.on("precollision",hi=>{const _i=hi;ci.events.emit("precollision",new PreCollisionEvent(_i.self,_i.other,_i.side,_i.intersection,_i.contact)),ci instanceof Actor&&ci.onPreCollisionResolve(_i.self,_i.other,_i.side,_i.contact)}),this.events.on("postcollision",hi=>{const _i=hi;ci.events.emit("postcollision",new PostCollisionEvent(_i.self,_i.other,_i.side,_i.intersection,_i.contact)),ci instanceof Actor&&ci.onPostCollisionResolve(_i.self,_i.other,_i.side,_i.contact)}),this.events.on("collisionstart",hi=>{const _i=hi;ci.events.emit("collisionstart",new CollisionStartEvent(_i.self,_i.other,_i.side,_i.contact)),ci instanceof Actor&&ci.onCollisionStart(_i.self,_i.other,_i.side,_i.contact)}),this.events.on("collisionend",hi=>{const _i=hi;ci.events.emit("collisionend",new CollisionEndEvent(_i.self,_i.other,_i.side,_i.lastContact)),ci instanceof Actor&&ci.onCollisionEnd(_i.self,_i.other,_i.side,_i.lastContact)})}onRemove(){this.events.clear(),this.$colliderRemoved.notifyAll(this._collider)}useBoxCollider(ci,hi,_i=Vector.Half,pi=Vector.Zero){const mi=Shape.Box(ci,hi,_i,pi);return this.set(mi)}usePolygonCollider(ci,hi=Vector.Zero){const _i=Shape.Polygon(ci,hi);return this.set(_i)}useCircleCollider(ci,hi=Vector.Zero){const _i=Shape.Circle(ci,hi);return this.set(_i)}useEdgeCollider(ci,hi){const _i=Shape.Edge(ci,hi);return this.set(_i)}useCompositeCollider(ci){return this.set(new CompositeCollider(ci))}}var DegreeOfFreedom;(function(fi){fi.Rotation="rotation",fi.X="x",fi.Y="y"})(DegreeOfFreedom||(DegreeOfFreedom={}));class BodyComponent extends Component{constructor(ci){var hi,_i,pi;super(),this.dependencies=[TransformComponent,MotionComponent],this.id=createId("body",BodyComponent._ID++),this.events=new EventEmitter,this.oldTransform=new transform_Transform,this.__oldTransformCaptured=!1,this.enableFixedUpdateInterpolate=!0,this.collisionType=CollisionType.PreventCollision,this.group=CollisionGroup.All,this._sleeping=!1,this.bounciness=.2,this.friction=.99,this.useGravity=!0,this.limitDegreeOfFreedom=[],this._oldGlobalPos=Vector.Zero,this.oldVel=new Vector(0,0),this.oldAcc=Vector.Zero,this._impulseScratch=vec(0,0),this._distanceFromCenterScratch=vec(0,0),ci?(this.collisionType=(hi=ci.type)!==null&&hi!==void 0?hi:this.collisionType,this.group=(_i=ci.group)!==null&&_i!==void 0?_i:this.group,this.useGravity=(pi=ci.useGravity)!==null&&pi!==void 0?pi:this.useGravity,this._bodyConfig={...getDefaultPhysicsConfig().bodies,...ci.config}):this._bodyConfig={...getDefaultPhysicsConfig().bodies},this.updatePhysicsConfig(this._bodyConfig),this._mass=BodyComponent._DEFAULT_CONFIG.defaultMass}get matrix(){return this.transform.get().matrix}updatePhysicsConfig(ci){this._bodyConfig={...getDefaultPhysicsConfig().bodies,...ci},this.canSleep=this._bodyConfig.canSleepByDefault,this.sleepMotion=this._bodyConfig.sleepEpsilon*5,this.wakeThreshold=this._bodyConfig.wakeThreshold}static updateDefaultPhysicsConfig(ci){BodyComponent._DEFAULT_CONFIG=ci}get mass(){return this._mass}set mass(ci){this._mass=ci,this._cachedInertia=void 0,this._cachedInverseInertia=void 0}get inverseMass(){return this.collisionType===CollisionType.Fixed?0:1/this.mass}get sleeping(){return this.isSleeping}get isSleeping(){return this._sleeping}setSleeping(ci){this.isSleeping=ci}set isSleeping(ci){this._sleeping=ci,ci?(this.vel=Vector.Zero,this.acc=Vector.Zero,this.angularVelocity=0,this.sleepMotion=0):this.sleepMotion=this._bodyConfig.sleepEpsilon*5}updateMotion(){this._sleeping&&(this.isSleeping=!0);const ci=this.vel.magnitude*this.vel.magnitude+Math.abs(this.angularVelocity*this.angularVelocity),hi=this._bodyConfig.sleepBias;this.sleepMotion=hi*this.sleepMotion+(1-hi)*ci,this.sleepMotion=clamp(this.sleepMotion,0,10*this._bodyConfig.sleepEpsilon),this.canSleep&&this.sleepMotion<this._bodyConfig.sleepEpsilon&&(this.isSleeping=!0)}get inertia(){if(this._cachedInertia)return this._cachedInertia;const ci=this.owner.get(ColliderComponent);if(ci){ci.$colliderAdded.subscribe(()=>{this._cachedInertia=null}),ci.$colliderRemoved.subscribe(()=>{this._cachedInertia=null});const hi=ci.get();if(hi)return this._cachedInertia=hi.getInertia(this.mass)}return 0}get inverseInertia(){return this._cachedInverseInertia?this._cachedInverseInertia:this._cachedInverseInertia=this.collisionType===CollisionType.Fixed?0:1/this.inertia}get active(){var ci;return!!(!((ci=this.owner)===null||ci===void 0)&&ci.isActive)}get isActive(){var ci;return!!(!((ci=this.owner)===null||ci===void 0)&&ci.isActive)}get center(){return this.globalPos}onAdd(ci){var hi,_i;this.transform=(hi=this.owner)===null||hi===void 0?void 0:hi.get(TransformComponent),this.motion=(_i=this.owner)===null||_i===void 0?void 0:_i.get(MotionComponent)}get pos(){return this.transform.pos}set pos(ci){this.transform.pos=ci}get globalPos(){return this.transform.globalPos}set globalPos(ci){this.transform.globalPos=ci}get oldPos(){return this.oldTransform.pos}get oldGlobalPos(){return this._oldGlobalPos}get vel(){return this.motion.vel}set vel(ci){this.motion.vel=ci}get acc(){return this.motion.acc}set acc(ci){this.motion.acc=ci}get torque(){return this.motion.torque}set torque(ci){this.motion.torque=ci}get oldRotation(){return this.oldTransform.rotation}get rotation(){return this.transform.globalRotation}set rotation(ci){this.transform.globalRotation=ci}get scale(){return this.transform.globalScale}set scale(ci){this.transform.globalScale=ci}get oldScale(){return this.oldTransform.scale}get scaleFactor(){return this.motion.scaleFactor}set scaleFactor(ci){this.motion.scaleFactor=ci}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(ci){this.motion.angularVelocity=ci}applyImpulse(ci,hi){if(this.collisionType!==CollisionType.Active)return;const _i=hi.scale(this.inverseMass,this._impulseScratch);if(this.limitDegreeOfFreedom.indexOf(DegreeOfFreedom.X)>-1&&(_i.x=0),this.limitDegreeOfFreedom.indexOf(DegreeOfFreedom.Y)>-1&&(_i.y=0),this.vel.addEqual(_i),!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)){const pi=ci.sub(this.globalPos,this._distanceFromCenterScratch);this.angularVelocity+=this.inverseInertia*pi.cross(hi)}}applyLinearImpulse(ci){if(this.collisionType!==CollisionType.Active)return;const hi=ci.scale(this.inverseMass);this.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)&&(hi.x=0),this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)&&(hi.y=0),this.vel=this.vel.add(hi)}applyAngularImpulse(ci,hi){if(this.collisionType===CollisionType.Active&&!this.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)){const _i=ci.sub(this.globalPos);this.angularVelocity+=this.inverseInertia*_i.cross(hi)}}captureOldTransform(){this.__oldTransformCaptured=!0;const ci=this.transform.get();ci.clone(this.oldTransform),this.oldTransform.parent=ci.parent,this.oldVel.setTo(this.vel.x,this.vel.y),this.oldAcc.setTo(this.acc.x,this.acc.y),this.oldGlobalPos.setTo(this.globalPos.x,this.globalPos.y)}clone(){return super.clone()}}BodyComponent._ID=0;BodyComponent._DEFAULT_CONFIG={...getDefaultPhysicsConfig().bodies};class Rectangle extends Raster{constructor(ci){super(ci),this.width=ci.width,this.height=ci.height,this.rasterize()}clone(){return new Rectangle({width:this.width,height:this.height,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(ci){this.color&&ci.fillRect(0,0,this.width,this.height),this.strokeColor&&ci.strokeRect(0,0,this.width,this.height)}}class Circle extends Raster{get radius(){return this._radius}set radius(ci){this._radius=ci,this.width=this._radius*2,this.height=this._radius*2,this.flagDirty()}constructor(ci){var hi,_i,pi;super(ci),this._radius=0;const mi=(hi=ci.lineWidth)!==null&&hi!==void 0?hi:ci.strokeColor?1:0;this.padding=(_i=ci.padding)!==null&&_i!==void 0?_i:2+mi/2,this.radius=ci.radius,this.filtering=(pi=ci.filtering)!==null&&pi!==void 0?pi:ImageFiltering.Blended,this.rasterize()}clone(){return new Circle({radius:this.radius,...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(ci){this.radius>0&&(ci.beginPath(),ci.arc(this.radius,this.radius,this.radius,0,Math.PI*2),this.color&&ci.fill(),this.strokeColor&&ci.stroke())}}class PointerComponent extends Component{constructor(ci){var hi,_i;super(),this.useColliderShape=!0,this.useGraphicsBounds=!0,this.useColliderShape=(hi=ci==null?void 0:ci.useColliderShape)!==null&&hi!==void 0?hi:this.useColliderShape,this.useGraphicsBounds=(_i=ci==null?void 0:ci.useGraphicsBounds)!==null&&_i!==void 0?_i:this.useGraphicsBounds,this.localBounds=ci==null?void 0:ci.localBounds}}class EasingFunctions{static CreateReversibleEasingFunction(ci){return(hi,_i,pi,mi)=>pi<_i?_i-(ci(hi,pi,_i,mi)-pi):ci(hi,_i,pi,mi)}static CreateVectorEasingFunction(ci){return(hi,_i,pi,mi)=>new Vector(ci(hi,_i.x,pi.x,mi),ci(hi,_i.y,pi.y,mi))}}EasingFunctions.Linear=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,hi*fi/_i+ci));EasingFunctions.EaseInQuad=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,fi/=_i,hi*fi*fi+ci));EasingFunctions.EaseOutQuad=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,fi/=_i,-hi*fi*(fi-2)+ci));EasingFunctions.EaseInOutQuad=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,fi/=_i/2,fi<1?hi/2*fi*fi+ci:(fi--,-hi/2*(fi*(fi-2)-1)+ci)));EasingFunctions.EaseInCubic=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,fi/=_i,hi*fi*fi*fi+ci));EasingFunctions.EaseOutCubic=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,fi/=_i,fi--,hi*(fi*fi*fi+1)+ci));EasingFunctions.EaseInOutCubic=EasingFunctions.CreateReversibleEasingFunction((fi,ci,hi,_i)=>(hi=hi-ci,fi/=_i/2,fi<1?hi/2*fi*fi*fi+ci:(fi-=2,hi/2*(fi*fi*fi+2)+ci)));class ActionQueue{constructor(ci){this._actions=[],this._currentAction=null,this._completedActions=[],this._entity=ci}add(ci){this._actions.push(ci)}remove(ci){const hi=this._actions.indexOf(ci);this._actions.splice(hi,1)}clearActions(){this._actions.length=0,this._completedActions.length=0,this._currentAction&&this._currentAction.stop()}getActions(){return this._actions.concat(this._completedActions)}getIncompleteActions(){return this._actions}getCurrentAction(){return this._currentAction}hasNext(){return this._actions.length>0}isComplete(){return this._actions.length===0}reset(){this._actions=this.getActions();const ci=this._actions.length;for(let hi=0;hi<ci;hi++)this._actions[hi].reset();this._completedActions=[]}update(ci){if(this._actions.length>0&&(this._currentAction!==this._actions[0]&&(this._currentAction=this._actions[0],this._entity.emit("actionstart",new ActionStartEvent(this._currentAction,this._entity))),this._currentAction.update(ci),this._currentAction.isComplete(this._entity))){this._entity.emit("actioncomplete",new ActionCompleteEvent(this._currentAction,this._entity));const hi=this._actions.shift();hi&&this._completedActions.push(hi)}}}let _ACTION_ID=0;function nextActionId(){return _ACTION_ID++}class Repeat{constructor(ci,hi,_i){this.id=nextActionId(),this._stopped=!1,this._repeatBuilder=hi,this._repeatContext=new ActionContext(ci),this._actionQueue=this._repeatContext.getQueue(),this._repeat=_i,this._originalRepeat=_i,this._repeatBuilder(this._repeatContext),this._repeat--}update(ci){this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext),this._repeat--),this._actionQueue.update(ci)}isComplete(){return this._stopped||this._repeat<=0&&this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._repeat=this._originalRepeat}}class RepeatForever{constructor(ci,hi){this.id=nextActionId(),this._stopped=!1,this._repeatBuilder=hi,this._repeatContext=new ActionContext(ci),this._actionQueue=this._repeatContext.getQueue(),this._repeatBuilder(this._repeatContext)}update(ci){this._stopped||(this._actionQueue.isComplete()&&(this._actionQueue.clearActions(),this._repeatBuilder(this._repeatContext)),this._actionQueue.update(ci))}isComplete(){return this._stopped}stop(){this._stopped=!0,this._actionQueue.clearActions()}reset(){}}function lerp(fi,ci,hi){return(1-hi)*fi+ci*hi}function lerpAngle(fi,ci,hi,_i){const pi=(fi-ci+TwoPI)%TwoPI>=Math.PI,mi=Math.abs(ci-fi),gi=TwoPI-mi;let vi=0,xi=0;mi>gi?(vi=gi,xi=mi):(vi=mi,xi=gi);let wi=0,yi=1;switch(hi){case RotationType.ShortestPath:wi=vi,yi=pi?1:-1;break;case RotationType.LongestPath:wi=xi,yi=pi?-1:1;break;case RotationType.Clockwise:yi=1,wi=pi?vi:xi;break;case RotationType.CounterClockwise:yi=-1,wi=pi?xi:vi;break}return fi+yi*(wi*_i)}function lerpVector(fi,ci,hi){return fi.scale(1-hi).add(ci.scale(hi))}function inverseLerp(fi,ci,hi){return(hi-fi)/(ci-fi)}function inverseLerpVector(fi,ci,hi){const _i=hi.sub(fi),pi=ci.sub(fi),mi=_i.x/pi.x,gi=_i.y/pi.y;return Math.min(mi,gi)}function remap(fi,ci,hi,_i,pi){const mi=inverseLerp(fi,ci,pi);return lerp(hi,_i,mi)}function remapVector(fi,ci,hi,_i,pi){const mi=inverseLerpVector(fi,ci,pi);return lerpVector(hi,_i,mi)}function isMoveByOptions(fi){return fi.offset instanceof Vector&&typeof fi.duration=="number"}class MoveByWithOptions{constructor(ci,hi){var _i;if(this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._easing=EasingFunctions.Linear,this._offset=hi.offset,this._easing=(_i=hi.easing)!==null&&_i!==void 0?_i:this._easing,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only MoveBy on Entities with TransformComponents.`);this._durationMs=hi.duration,this._currentMs=this._durationMs}update(ci){this._started||(this._start=this._tx.pos.clone(),this._end=this._start.add(this._offset),this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),_i=this._tx.pos,pi=this._easing(hi,this._start.x,this._end.x,1),mi=this._easing(hi,this._start.y,this._end.y,1),gi=(pi-_i.x)/(ci/1e3),vi=(mi-_i.y)/(ci/1e3);this._motion.vel.x=gi,this._motion.vel.y=vi,this.isComplete(this.entity)&&(this._tx.pos=vec(this._end.x,this._end.y),this._motion.vel=vec(0,0))}isComplete(ci){return this._stopped||this._currentMs<0}stop(){this._motion.vel=vec(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class MoveBy{constructor(ci,hi,_i,pi){if(this.id=nextActionId(),this._started=!1,this._stopped=!1,this._entity=ci,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._speed=pi,this._offset=new Vector(hi,_i),pi<=0)throw Logger.getInstance().error("Attempted to moveBy with speed less than or equal to zero : "+pi),new Error("Speed must be greater than 0 pixels per second")}update(ci){this._started||(this._started=!0,this._start=new Vector(this._tx.pos.x,this._tx.pos.y),this._end=this._start.add(this._offset),this._distance=this._offset.magnitude,this._dir=this._end.sub(this._start).normalize()),this.isComplete(this._entity)?(this._tx.pos=vec(this._end.x,this._end.y),this._motion.vel=vec(0,0)):this._motion.vel=this._dir.scale(this._speed)}isComplete(ci){const hi=ci.get(TransformComponent);return this._stopped||hi.pos.distance(this._start)>=this._distance}stop(){this._motion.vel=vec(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function isMoveToOptions(fi){return fi.pos instanceof Vector&&typeof fi.duration=="number"}class MoveToWithOptions{constructor(ci,hi){var _i;if(this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._easing=EasingFunctions.Linear,this._end=hi.pos,this._easing=(_i=hi.easing)!==null&&_i!==void 0?_i:this._easing,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only moveTo on Entities with TransformComponents.`);this._durationMs=hi.duration,this._currentMs=this._durationMs}update(ci){this._started||(this._start=this._tx.pos.clone(),this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),_i=this._tx.pos,pi=this._easing(hi,this._start.x,this._end.x,1),mi=this._easing(hi,this._start.y,this._end.y,1),gi=(pi-_i.x)/(ci/1e3),vi=(mi-_i.y)/(ci/1e3);this._motion.vel.x=gi,this._motion.vel.y=vi,this.isComplete(this.entity)&&(this._tx.pos=vec(this._end.x,this._end.y),this._motion.vel=vec(0,0))}isComplete(ci){return this._stopped||this._currentMs<0}stop(){this._motion.vel=vec(0,0),this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class MoveTo{constructor(ci,hi,_i,pi){this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._end=new Vector(hi,_i),this._speed=pi}update(ci){this._started||(this._started=!0,this._start=new Vector(this._tx.pos.x,this._tx.pos.y),this._distance=this._start.distance(this._end),this._dir=this._end.sub(this._start).normalize());const hi=this._dir.scale(this._speed);this._motion.vel=vec(hi.x,hi.y),this.isComplete(this.entity)&&(this._tx.pos=vec(this._end.x,this._end.y),this._motion.vel=vec(0,0))}isComplete(ci){const hi=ci.get(TransformComponent);return this._stopped||new Vector(hi.pos.x,hi.pos.y).distance(this._start)>=this._distance}stop(){this._motion.vel=vec(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function isRotateToOptions(fi){return typeof fi.angle=="number"&&typeof fi.duration=="number"}class RotateToWithOptions{constructor(ci,hi){var _i;if(this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._endAngle=0,this._startAngle=0,this._endAngle=hi.angle,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only RotateTo on Entities with TransformComponents.`);this._durationMs=hi.duration,this._rotationType=(_i=hi.rotationType)!==null&&_i!==void 0?_i:RotationType.ShortestPath,this._currentMs=this._durationMs}update(ci){this._started||(this._startAngle=this._tx.rotation,this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),_i=lerpAngle(this._startAngle,this._endAngle,this._rotationType,hi),pi=this._tx.rotation,mi=(_i-pi)/(ci/1e3);this._motion.angularVelocity=mi,this.isComplete(this.entity)&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(ci){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class RotateTo{constructor(ci,hi,_i,pi){this.id=nextActionId(),this._started=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._end=hi,this._speed=_i,this._rotationType=pi||RotationType.ShortestPath}update(ci){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation;const hi=Math.abs(this._end-this._start),_i=TwoPI-hi;switch(hi>_i?(this._shortDistance=_i,this._longDistance=hi):(this._shortDistance=hi,this._longDistance=_i),this._shortestPathIsPositive=(this._start-this._end+TwoPI)%TwoPI>=Math.PI,this._rotationType){case RotationType.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case RotationType.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case RotationType.Clockwise:this._direction=1,this._shortestPathIsPositive?this._distance=this._shortDistance:this._distance=this._longDistance;break;case RotationType.CounterClockwise:this._direction=-1,this._shortestPathIsPositive?this._distance=this._longDistance:this._distance=this._shortDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(ci/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const ci=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||ci>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function isRotateByOptions(fi){return typeof fi.angleRadiansOffset=="number"&&typeof fi.duration=="number"}class RotateByWithOptions{constructor(ci,hi){var _i;if(this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._offset=0,this._startAngle=0,this._endAngle=0,this._offset=hi.angleRadiansOffset,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only RotateBy on Entities with TransformComponents.`);this._durationMs=hi.duration,this._rotationType=(_i=hi.rotationType)!==null&&_i!==void 0?_i:RotationType.ShortestPath,this._currentMs=this._durationMs}update(ci){this._started||(this._startAngle=this._tx.rotation,this._endAngle=canonicalizeAngle(this._startAngle+this._offset),this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),_i=lerpAngle(this._startAngle,this._endAngle,this._rotationType,hi),pi=this._tx.rotation,mi=(_i-pi)/(ci/1e3);this._motion.angularVelocity=mi,this.isComplete()&&(this._tx.rotation=this._endAngle,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.angularVelocity=0,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class RotateBy{constructor(ci,hi,_i,pi){this.id=nextActionId(),this._started=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._speed=_i,this._offset=hi,this._rotationType=pi||RotationType.ShortestPath}update(ci){if(!this._started){this._started=!0,this._start=this._tx.rotation,this._currentNonCannonAngle=this._tx.rotation,this._end=this._start+this._offset;const hi=Math.abs(this._end-this._start),_i=TwoPI-hi;switch(hi>_i?(this._shortDistance=_i,this._longDistance=hi):(this._shortDistance=hi,this._longDistance=_i),this._shortestPathIsPositive=(this._start-this._end+TwoPI)%TwoPI>=Math.PI,this._rotationType){case RotationType.ShortestPath:this._distance=this._shortDistance,this._shortestPathIsPositive?this._direction=1:this._direction=-1;break;case RotationType.LongestPath:this._distance=this._longDistance,this._shortestPathIsPositive?this._direction=-1:this._direction=1;break;case RotationType.Clockwise:this._direction=1,this._shortDistance>=0?this._distance=this._shortDistance:this._distance=this._longDistance;break;case RotationType.CounterClockwise:this._direction=-1,this._shortDistance<=0?this._distance=this._shortDistance:this._distance=this._longDistance;break}}this._motion.angularVelocity=this._direction*this._speed,this._currentNonCannonAngle+=this._direction*this._speed*(ci/1e3),this.isComplete()&&(this._tx.rotation=this._end,this._motion.angularVelocity=0,this._stopped=!0)}isComplete(){const ci=Math.abs(this._currentNonCannonAngle-this._start);return this._stopped||ci>=Math.abs(this._distance)}stop(){this._motion.angularVelocity=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._start=void 0,this._currentNonCannonAngle=void 0,this._distance=void 0}}function isScaleToOptions(fi){return typeof fi.scale=="object"&&typeof fi.duration=="number"}class ScaleToWithOptions{constructor(ci,hi){if(this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._endScale=vec(1,1),this._startScale=vec(1,1),this._endScale=hi.scale,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only ScaleTo on Entities with TransformComponents.`);this._durationMs=hi.duration,this._currentMs=this._durationMs}update(ci){this._started||(this._startScale=this._tx.scale,this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),_i=lerpVector(this._startScale,this._endScale,hi),pi=this._tx.scale,mi=_i.sub(pi).scale(1/(ci/1e3));this._motion.scaleFactor=mi,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=Vector.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ScaleTo{constructor(ci,hi,_i,pi,mi){this.id=nextActionId(),this._started=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._endX=hi,this._endY=_i,this._speedX=pi,this._speedY=mi}update(ci){if(this._started||(this._started=!0,this._startX=this._tx.scale.x,this._startY=this._tx.scale.y,this._distanceX=Math.abs(this._endX-this._startX),this._distanceY=Math.abs(this._endY-this._startY)),Math.abs(this._tx.scale.x-this._startX)>=this._distanceX)this._motion.scaleFactor.x=0;else{const hi=this._endY<this._startY?-1:1;this._motion.scaleFactor.x=this._speedX*hi}if(Math.abs(this._tx.scale.y-this._startY)>=this._distanceY)this._motion.scaleFactor.y=0;else{const hi=this._endY<this._startY?-1:1;this._motion.scaleFactor.y=this._speedY*hi}this.isComplete()&&(this._tx.scale=vec(this._endX,this._endY),this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startX)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startY)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}function isScaleByOptions(fi){return typeof fi.scaleOffset=="object"&&typeof fi.duration=="number"}class ScaleByWithOptions{constructor(ci,hi){if(this.entity=ci,this.id=nextActionId(),this._started=!1,this._stopped=!1,this._endScale=vec(1,1),this._scaleOffset=vec(0,0),this._startScale=vec(1,1),this._scaleOffset=hi.scaleOffset,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only ScaleBy on Entities with TransformComponents.`);this._durationMs=hi.duration,this._currentMs=this._durationMs}update(ci){this._started||(this._startScale=this._tx.scale,this._endScale=this._startScale.add(this._scaleOffset),this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1),_i=lerpVector(this._startScale,this._endScale,hi),pi=this._tx.scale,mi=_i.sub(pi).scale(1/(ci/1e3));this._motion.scaleFactor=mi,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.angularVelocity=0)}isComplete(){return this._stopped||this._currentMs<0}stop(){this._motion.scaleFactor=Vector.Zero,this._stopped=!0,this._currentMs=0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}}class ScaleBy{constructor(ci,hi,_i,pi){this.id=nextActionId(),this._started=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._offset=new Vector(hi,_i),this._speedX=this._speedY=pi}update(ci){this._started||(this._started=!0,this._startScale=this._tx.scale.clone(),this._endScale=this._startScale.add(this._offset),this._distanceX=Math.abs(this._endScale.x-this._startScale.x),this._distanceY=Math.abs(this._endScale.y-this._startScale.y),this._directionX=this._endScale.x<this._startScale.x?-1:1,this._directionY=this._endScale.y<this._startScale.y?-1:1),this._motion.scaleFactor.x=this._speedX*this._directionX,this._motion.scaleFactor.y=this._speedY*this._directionY,this.isComplete()&&(this._tx.scale=this._endScale,this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0)}isComplete(){return this._stopped||Math.abs(this._tx.scale.x-this._startScale.x)>=this._distanceX-.01&&Math.abs(this._tx.scale.y-this._startScale.y)>=this._distanceY-.01}stop(){this._motion.scaleFactor.x=0,this._motion.scaleFactor.y=0,this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class CallMethod{constructor(ci){this.id=nextActionId(),this._hasBeenCalled=!1,this._method=ci}update(ci){this._method(),this._hasBeenCalled=!0}isComplete(){return this._hasBeenCalled}reset(){this._hasBeenCalled=!1}stop(){this._hasBeenCalled=!0}}class EaseTo{constructor(ci,hi,_i,pi,mi){this.easingFcn=mi,this.id=nextActionId(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new Vector(0,0),this._lerpEnd=new Vector(0,0),this._initialized=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._lerpDuration=pi,this._lerpEnd=new Vector(hi,_i)}_initialize(){this._lerpStart=new Vector(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0}update(ci){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=ci;let hi=this._tx.pos.x,_i=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?hi=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):hi=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?_i=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):_i=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=vec((hi-this._tx.pos.x)/(ci/1e3),(_i-this._tx.pos.y)/(ci/1e3))):(this._tx.pos=vec(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=Vector.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=vec(0,0),this._stopped=!0}}class EaseBy{constructor(ci,hi,_i,pi,mi){this.easingFcn=mi,this.id=nextActionId(),this._currentLerpTime=0,this._lerpDuration=1*1e3,this._lerpStart=new Vector(0,0),this._lerpEnd=new Vector(0,0),this._initialized=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._lerpDuration=pi,this._offset=new Vector(hi,_i)}_initialize(){this._lerpStart=new Vector(this._tx.pos.x,this._tx.pos.y),this._currentLerpTime=0,this._lerpEnd=this._lerpStart.add(this._offset)}update(ci){this._initialized||(this._initialize(),this._initialized=!0),this._currentLerpTime+=ci;let hi=this._tx.pos.x,_i=this._tx.pos.y;this._currentLerpTime<this._lerpDuration?(this._lerpEnd.x<this._lerpStart.x?hi=this._lerpStart.x-(this.easingFcn(this._currentLerpTime,this._lerpEnd.x,this._lerpStart.x,this._lerpDuration)-this._lerpEnd.x):hi=this.easingFcn(this._currentLerpTime,this._lerpStart.x,this._lerpEnd.x,this._lerpDuration),this._lerpEnd.y<this._lerpStart.y?_i=this._lerpStart.y-(this.easingFcn(this._currentLerpTime,this._lerpEnd.y,this._lerpStart.y,this._lerpDuration)-this._lerpEnd.y):_i=this.easingFcn(this._currentLerpTime,this._lerpStart.y,this._lerpEnd.y,this._lerpDuration),this._motion.vel=vec((hi-this._tx.pos.x)/(ci/1e3),(_i-this._tx.pos.y)/(ci/1e3))):(this._tx.pos=vec(this._lerpEnd.x,this._lerpEnd.y),this._motion.vel=Vector.Zero)}isComplete(){return this._stopped||this._currentLerpTime>=this._lerpDuration}reset(){this._initialized=!1,this._stopped=!1,this._currentLerpTime=0}stop(){this._motion.vel=vec(0,0),this._stopped=!0}}class Blink{constructor(ci,hi,_i,pi=1){this.id=nextActionId(),this._timeVisible=0,this._timeNotVisible=0,this._elapsedTime=0,this._totalTime=0,this._stopped=!1,this._started=!1,this._graphics=ci.get(GraphicsComponent),this._timeVisible=hi,this._timeNotVisible=_i,this._duration=(hi+_i)*pi}update(ci){this._started||(this._started=!0,this._elapsedTime=0,this._totalTime=0),this._graphics&&(this._elapsedTime+=ci,this._totalTime+=ci,this._graphics.isVisible&&this._elapsedTime>=this._timeVisible&&(this._graphics.isVisible=!1,this._elapsedTime=0),!this._graphics.isVisible&&this._elapsedTime>=this._timeNotVisible&&(this._graphics.isVisible=!0,this._elapsedTime=0),this.isComplete()&&(this._graphics.isVisible=!0))}isComplete(){return this._stopped||this._totalTime>=this._duration}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._elapsedTime=0,this._totalTime=0}}class Fade{constructor(ci,hi,_i){this.id=nextActionId(),this._multiplier=1,this._started=!1,this._stopped=!1,this._graphics=ci.get(GraphicsComponent),this._endOpacity=hi,this._remainingTime=this._originalTime=_i}update(ci){this._graphics&&(this._started||(this._started=!0,this._remainingTime=this._originalTime,this._endOpacity<this._graphics.opacity?this._multiplier=-1:this._multiplier=1),this._remainingTime>0&&(this._graphics.opacity+=this._multiplier*(Math.abs(this._graphics.opacity-this._endOpacity)*ci)/this._remainingTime),this._remainingTime-=ci,this.isComplete()&&(this._graphics.opacity=this._endOpacity),Logger.getInstance().debug("[Action fade] Actor opacity:",this._graphics.opacity))}isComplete(){return this._stopped||this._remainingTime<=0}stop(){this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._remainingTime=this._originalTime}}class Delay{constructor(ci){this.id=nextActionId(),this._elapsedTime=0,this._started=!1,this._stopped=!1,this._delay=ci}update(ci){this._started||(this._started=!0),this._elapsedTime+=ci}isComplete(){return this._stopped||this._elapsedTime>=this._delay}stop(){this._stopped=!0}reset(){this._elapsedTime=0,this._started=!1,this._stopped=!1}}class Die{constructor(ci){this.id=nextActionId(),this._stopped=!1,this._entity=ci}update(ci){this._entity.get(ActionsComponent).clearActions(),this._entity.kill(),this._stopped=!0}isComplete(){return this._stopped}stop(){}reset(){}}class Follow{constructor(ci,hi,_i){this.id=nextActionId(),this._started=!1,this._stopped=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._followTx=hi.get(TransformComponent),this._followMotion=hi.get(MotionComponent),this._current=new Vector(this._tx.pos.x,this._tx.pos.y),this._end=new Vector(this._followTx.pos.x,this._followTx.pos.y),this._maximumDistance=_i!==void 0?_i:this._current.distance(this._end),this._speed=0}update(ci){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const hi=Math.sqrt(Math.pow(this._followMotion.vel.x,2)+Math.pow(this._followMotion.vel.y,2));if(hi!==0&&(this._speed=hi),this._current=vec(this._tx.pos.x,this._tx.pos.y),this._end=vec(this._followTx.pos.x,this._followTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize(),this._distanceBetween>=this._maximumDistance){const _i=this._dir.scale(this._speed);this._motion.vel=vec(_i.x,_i.y)}else this._motion.vel=vec(0,0);this.isComplete()&&(this._tx.pos=vec(this._end.x,this._end.y),this._motion.vel=vec(0,0))}stop(){this._motion.vel=vec(0,0),this._stopped=!0}isComplete(){return this._stopped}reset(){this._started=!1,this._stopped=!1}}class Meet{constructor(ci,hi,_i){this.id=nextActionId(),this._started=!1,this._stopped=!1,this._speedWasSpecified=!1,this._tx=ci.get(TransformComponent),this._motion=ci.get(MotionComponent),this._meetTx=hi.get(TransformComponent),this._meetMotion=hi.get(MotionComponent),this._current=new Vector(this._tx.pos.x,this._tx.pos.y),this._end=new Vector(this._meetTx.pos.x,this._meetTx.pos.y),this._speed=_i||0,_i!==void 0&&(this._speedWasSpecified=!0)}update(ci){this._started||(this._started=!0,this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize());const hi=Math.sqrt(Math.pow(this._meetMotion.vel.x,2)+Math.pow(this._meetMotion.vel.y,2));hi!==0&&!this._speedWasSpecified&&(this._speed=hi),this._current=vec(this._tx.pos.x,this._tx.pos.y),this._end=vec(this._meetTx.pos.x,this._meetTx.pos.y),this._distanceBetween=this._current.distance(this._end),this._dir=this._end.sub(this._current).normalize();const _i=this._dir.scale(this._speed);this._motion.vel=vec(_i.x,_i.y),this.isComplete()&&(this._tx.pos=vec(this._end.x,this._end.y),this._motion.vel=vec(0,0))}isComplete(){return this._stopped||this._distanceBetween<=1}stop(){this._motion.vel=vec(0,0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1,this._distanceBetween=1/0}}class Flash{constructor(ci,hi,_i=1e3){var pi;this.id=nextActionId(),this._stopped=!1,this._started=!1,this._total=0,this._currentDuration=0,this._graphics=ci.get(GraphicsComponent),this._duration=_i,this._entity=ci,this._material=(pi=ci.scene)===null||pi===void 0?void 0:pi.engine.graphicsContext.createMaterial({name:"flash-material",color:hi,fragmentSource:`#version 300 es
    
        precision mediump float;
        uniform float u_blend;
        uniform sampler2D u_graphic;
        uniform vec4 u_color;
    
        in vec2 v_uv; 
        out vec4 color;
    
        void main() { 
            vec4 textureColor = texture(u_graphic, v_uv); 
            color = mix(textureColor, u_color, u_blend * textureColor.a);
            color.rgb = color.rgb * color.a;
        }`}),this._total=_i}update(ci){var hi;this._started||(this._started=!0,this._total=this._duration,this._currentDuration=this._duration,this._entity.graphics.material=this._material),this._graphics&&(this._currentDuration-=ci,this._graphics&&((hi=this._material)===null||hi===void 0||hi.update(_i=>{_i.trySetUniformFloat("u_blend",this._currentDuration/this._total)})),this.isComplete()&&(this._entity.graphics.material=null))}isComplete(){return this._stopped||this._currentDuration<=0}stop(){this._graphics&&(this._graphics.isVisible=!0),this._stopped=!0}reset(){this._started=!1,this._stopped=!1}}class BezierCurve{constructor(ci){var hi;if(this._distLookup=[],this.quality=4,ci.controlPoints.length!==4)throw new Error("Only cubic bezier curves are supported");this._controlPoints=[...ci.controlPoints],this.quality=(hi=ci.quality)!==null&&hi!==void 0?hi:this.quality,this._calculateLookup()}get arcLength(){return this._arcLength}get controlPoints(){return this._controlPoints}set controlPoints(ci){this._controlPoints=[...ci],this._calculateLookup()}setControlPoint(ci,hi){this._controlPoints[ci]=hi,this._calculateLookup()}_calculateLookup(){let ci=0;this._distLookup.length=0;let hi=this.controlPoints[0];const _i=this.controlPoints.length*this.quality;for(let pi=0;pi<_i;pi++){const mi=pi/(_i-1),gi=this.getPoint(mi),vi=hi.distance(gi);ci+=vi,this._distLookup.push(ci),hi=gi}this._arcLength=ci}_getTimeGivenDistance(ci){const hi=this._distLookup.length,_i=this.arcLength;if(ci>=0&&ci<_i){for(let pi=0;pi<hi-1;pi++)if(this._distLookup[pi]<=ci&&ci<this._distLookup[pi+1])return remap(this._distLookup[pi],this._distLookup[pi+1],pi/(hi-1),(pi+1)/(hi-1),ci)}return ci/_i}getPoint(ci){const hi=[...this.controlPoints];for(let _i=1;_i<hi.length;_i++)for(let pi=0;pi<hi.length-_i;pi++)hi[pi]=lerpVector(hi[pi],hi[pi+1],ci);return hi[0]}getTangent(ci){const hi=ci*ci,_i=this.controlPoints[0],pi=this.controlPoints[1],mi=this.controlPoints[2],gi=this.controlPoints[3];return _i.scale(-3*hi+6*ci-3).add(pi.scale(9*hi-12*ci+3).add(mi.scale(-9*hi+6*ci).add(gi.scale(3*hi)))).normalize()}getUniformTangent(ci){const hi=ci*this.arcLength,_i=this._getTimeGivenDistance(hi);return this.getTangent(_i)}getNormal(ci){return this.getTangent(ci).normal()}getUniformNormal(ci){return this.getUniformTangent(ci).normal()}getUniformPoint(ci){const hi=ci*this.arcLength,_i=this._getTimeGivenDistance(hi);return this.getPoint(_i)}clone(){return new BezierCurve({controlPoints:[...this.controlPoints],quality:this.quality})}}class CurveTo{constructor(ci,hi){var _i;if(this.id=nextActionId(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=ci,this._tx=this._entity.get(TransformComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=new BezierCurve({controlPoints:[vec(0,0),...hi.controlPoints],quality:hi.quality}),this._durationMs=hi.duration,this._mode=(_i=hi.mode)!==null&&_i!==void 0?_i:this._mode,this._currentMs=this._durationMs}update(ci){this._started||(this._curve.setControlPoint(0,this._tx.globalPos.clone()),this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(hi):this._tx.pos=this._curve.getUniformPoint(hi),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(ci){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0,this._currentMs=0}}class CurveBy{constructor(ci,hi){var _i;if(this.id=nextActionId(),this._started=!1,this._stopped=!1,this._mode="dynamic",this._entity=ci,this._tx=this._entity.get(TransformComponent),!this._tx)throw new Error(`Entity ${ci.name} has no TransformComponent, can only curveTo on Entities with TransformComponents.`);this._curve=this._curve=new BezierCurve({controlPoints:[vec(0,0),...hi.controlPoints],quality:hi.quality}),this._durationMs=hi.duration,this._mode=(_i=hi.mode)!==null&&_i!==void 0?_i:this._mode,this._currentMs=this._durationMs}update(ci){this._started||(this._curve.setControlPoint(0,this._tx.globalPos),this._curve.setControlPoint(1,this._curve.controlPoints[1].add(this._tx.globalPos)),this._curve.setControlPoint(2,this._curve.controlPoints[2].add(this._tx.globalPos)),this._curve.setControlPoint(3,this._curve.controlPoints[3].add(this._tx.globalPos)),this._started=!0),this._currentMs-=ci;const hi=clamp(remap(0,this._durationMs,0,1,this._durationMs-this._currentMs),0,1);this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(hi):this._tx.pos=this._curve.getUniformPoint(hi),this.isComplete(this._entity)&&(this._mode==="dynamic"?this._tx.pos=this._curve.getPoint(1):this._tx.pos=this._curve.getUniformPoint(1))}isComplete(ci){return this._stopped||this._currentMs<0}reset(){this._currentMs=this._durationMs,this._started=!1,this._stopped=!1}stop(){this._stopped=!0}}class ActionContext{constructor(ci){this._entity=ci,this._queue=new ActionQueue(ci)}getQueue(){return this._queue}update(ci){this._queue.update(ci)}clearActions(){this._queue.clearActions()}runAction(ci){return ci.reset(),this._queue.add(ci),this}curveBy(ci){return this._queue.add(new CurveBy(this._entity,ci)),this}curveTo(ci){return this._queue.add(new CurveTo(this._entity,ci)),this}easeTo(...ci){var hi,_i;let pi=0,mi=0,gi=0,vi=EasingFunctions.Linear;return ci[0]instanceof Vector?(pi=ci[0].x,mi=ci[0].y,gi=ci[1],vi=(hi=ci[2])!==null&&hi!==void 0?hi:vi):(pi=ci[0],mi=ci[1],gi=ci[2],vi=(_i=ci[3])!==null&&_i!==void 0?_i:vi),this._queue.add(new EaseTo(this._entity,pi,mi,gi,vi)),this}easeBy(...ci){var hi,_i;let pi=0,mi=0,gi=0,vi=EasingFunctions.Linear;return ci[0]instanceof Vector?(pi=ci[0].x,mi=ci[0].y,gi=ci[1],vi=(hi=ci[2])!==null&&hi!==void 0?hi:vi):(pi=ci[0],mi=ci[1],gi=ci[2],vi=(_i=ci[3])!==null&&_i!==void 0?_i:vi),this._queue.add(new EaseBy(this._entity,pi,mi,gi,vi)),this}moveTo(ci,hi,_i){let pi=0,mi=0,gi=0;return ci instanceof Vector?(pi=ci.x,mi=ci.y,gi=+(hi??0),this._queue.add(new MoveTo(this._entity,pi,mi,gi))):typeof ci=="number"&&typeof hi=="number"&&typeof _i=="number"?(pi=ci,mi=hi,gi=_i,this._queue.add(new MoveTo(this._entity,pi,mi,gi))):isMoveToOptions(ci)&&this._queue.add(new MoveToWithOptions(this._entity,ci)),this}moveBy(ci,hi,_i){let pi=0,mi=0,gi=0;return ci instanceof Vector&&typeof hi=="number"?(pi=ci.x,mi=ci.y,gi=hi,this._queue.add(new MoveBy(this._entity,pi,mi,gi))):typeof ci=="number"&&typeof hi=="number"&&typeof _i=="number"?(pi=ci,mi=hi,gi=_i,this._queue.add(new MoveBy(this._entity,pi,mi,gi))):isMoveByOptions(ci)&&this._queue.add(new MoveByWithOptions(this._entity,ci)),this}rotateTo(ci,hi,_i){return typeof ci=="number"&&typeof hi=="number"?this._queue.add(new RotateTo(this._entity,ci,hi,_i)):typeof ci=="object"&&this._queue.add(new RotateToWithOptions(this._entity,ci)),this}rotateBy(ci,hi,_i){return typeof ci=="object"?this._queue.add(new RotateByWithOptions(this._entity,ci)):this._queue.add(new RotateBy(this._entity,ci,hi,_i)),this}scaleTo(ci,hi,_i,pi){let mi=1,gi=1,vi=0,xi=0;return isScaleToOptions(ci)?(this._queue.add(new ScaleToWithOptions(this._entity,ci)),this):(ci instanceof Vector&&hi instanceof Vector&&(mi=ci.x,gi=ci.y,vi=hi.x,xi=hi.y),typeof ci=="number"&&typeof hi=="number"&&(mi=ci,gi=hi,vi=_i,xi=pi),this._queue.add(new ScaleTo(this._entity,mi,gi,vi,xi)),this)}scaleBy(ci,hi,_i){if(isScaleByOptions(ci))return this._queue.add(new ScaleByWithOptions(this._entity,ci)),this;let pi=1,mi=1;return ci instanceof Vector&&(pi=ci.x,mi=ci.y,_i=hi),typeof ci=="number"&&typeof hi=="number"&&(pi=ci,mi=hi),this._queue.add(new ScaleBy(this._entity,pi,mi,_i)),this}blink(ci,hi,_i=1){return this._queue.add(new Blink(this._entity,ci,hi,_i)),this}fade(ci,hi){return this._queue.add(new Fade(this._entity,ci,hi)),this}flash(ci,hi=1e3){return this._queue.add(new Flash(this._entity,ci,hi)),this}delay(ci){return this._queue.add(new Delay(ci)),this}die(){return this._queue.add(new Die(this._entity)),this}callMethod(ci){return this._queue.add(new CallMethod(ci)),this}repeat(ci,hi){return hi?(this._queue.add(new Repeat(this._entity,ci,hi)),this):(this.repeatForever(ci),this)}repeatForever(ci){return this._queue.add(new RepeatForever(this._entity,ci)),this}follow(ci,hi){return hi===void 0?this._queue.add(new Follow(this._entity,ci)):this._queue.add(new Follow(this._entity,ci,hi)),this}meet(ci,hi){return hi===void 0?this._queue.add(new Meet(this._entity,ci)):this._queue.add(new Meet(this._entity,ci,hi)),this}toPromise(){return new Promise(hi=>{this._queue.add(new CallMethod(()=>{hi()}))})}}class ActionsComponent extends Component{constructor(){super(...arguments),this.dependencies=[TransformComponent,MotionComponent],this._ctx=null}onAdd(ci){this._ctx=new ActionContext(ci)}onRemove(){this._ctx=null}_getCtx(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no context available");return this._ctx}getQueue(){if(!this._ctx)throw new Error("Actions component not attached to an entity, no queue available");return this._ctx.getQueue()}runAction(ci){if(!this._ctx)throw new Error("Actions component not attached to an entity, cannot run action");return this._ctx.runAction(ci)}update(ci){var hi;return(hi=this._ctx)===null||hi===void 0?void 0:hi.update(ci)}clearActions(){var ci;(ci=this._ctx)===null||ci===void 0||ci.clearActions()}curveBy(ci){return this._getCtx().curveBy.apply(this._ctx,[ci])}curveTo(ci){return this._getCtx().curveTo.apply(this._ctx,[ci])}easeTo(...ci){return this._getCtx().easeTo.apply(this._ctx,ci)}easeBy(...ci){return this._getCtx().easeBy.apply(this._ctx,ci)}moveTo(ci,hi,_i){return this._getCtx().moveTo.apply(this._ctx,[ci,hi,_i])}moveBy(ci,hi,_i){return this._getCtx().moveBy.apply(this._ctx,[ci,hi,_i])}rotateTo(ci,hi,_i){return this._getCtx().rotateTo.apply(this._ctx,[ci,hi,_i])}rotateBy(ci,hi,_i){return this._getCtx().rotateBy.apply(this._ctx,[ci,hi,_i])}scaleTo(ci,hi,_i,pi){return this._getCtx().scaleTo.apply(this._ctx,[ci,hi,_i,pi])}scaleBy(ci,hi,_i){return this._getCtx().scaleBy.apply(this._ctx,[ci,hi,_i])}blink(ci,hi,_i){return this._getCtx().blink(ci,hi,_i)}fade(ci,hi){return this._getCtx().fade(ci,hi)}flash(ci,hi=1e3){return this._getCtx().flash(ci,hi)}delay(ci){return this._getCtx().delay(ci)}die(){return this._getCtx().die()}callMethod(ci){return this._getCtx().callMethod(ci)}repeat(ci,hi){return this._getCtx().repeat(ci,hi)}repeatForever(ci){return this._getCtx().repeatForever(ci)}follow(ci,hi){return this._getCtx().follow(ci,hi)}meet(ci,hi){return this._getCtx().meet(ci,hi)}toPromise(){return this._getCtx().toPromise()}}function isActor(fi){return fi instanceof Actor}const ActorEvents={CollisionStart:"collisionstart",CollisionEnd:"collisionend",PreCollision:"precollision",PostCollision:"postcollision",Kill:"kill",PreKill:"prekill",PostKill:"postkill",PreDraw:"predraw",PostDraw:"postdraw",PreTransformDraw:"pretransformdraw",PostTransformDraw:"posttransformdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerEnter:"pointerenter",PointerLeave:"pointerleave",PointerMove:"pointermove",PointerCancel:"pointercancel",Wheel:"pointerwheel",PointerDrag:"pointerdragstart",PointerDragEnd:"pointerdragend",PointerDragEnter:"pointerdragenter",PointerDragLeave:"pointerdragleave",PointerDragMove:"pointerdragmove",EnterViewPort:"enterviewport",ExitViewPort:"exitviewport",ActionStart:"actionstart",ActionComplete:"actioncomplete"};class Actor extends Entity{get pos(){return this.transform.pos}set pos(ci){this.transform.pos=ci.clone()}get oldPos(){return this.body.oldPos}get oldGlobalPos(){return this.body.oldGlobalPos}set oldPos(ci){this.body.oldPos.setTo(ci.x,ci.y)}get vel(){return this.motion.vel}set vel(ci){this.motion.vel=ci.clone()}get oldVel(){return this.body.oldVel}set oldVel(ci){this.body.oldVel.setTo(ci.x,ci.y)}get acc(){return this.motion.acc}set acc(ci){this.motion.acc=ci.clone()}set oldAcc(ci){this.body.oldAcc.setTo(ci.x,ci.y)}get oldAcc(){return this.body.oldAcc}get rotation(){return this.transform.rotation}set rotation(ci){this.transform.rotation=ci}get angularVelocity(){return this.motion.angularVelocity}set angularVelocity(ci){this.motion.angularVelocity=ci}get scale(){return this.get(TransformComponent).scale}set scale(ci){this.get(TransformComponent).scale=ci}get anchor(){return this._anchor}set anchor(ci){this._anchor=watch(ci,hi=>this._handleAnchorChange(hi)),this._handleAnchorChange(ci)}_handleAnchorChange(ci){this.graphics&&(this.graphics.anchor=ci)}get offset(){return this._offset}set offset(ci){this._offset=watch(ci,hi=>this._handleOffsetChange(hi)),this._handleOffsetChange(ci)}_handleOffsetChange(ci){this.graphics&&(this.graphics.offset=ci)}get isOffScreen(){return this.hasTag("ex.offscreen")}get draggable(){return this._draggable}set draggable(ci){ci&&(ci&&!this._draggable?(this.events.on("pointerdragstart",this._pointerDragStartHandler),this.events.on("pointerdragend",this._pointerDragEndHandler),this.events.on("pointerdragmove",this._pointerDragMoveHandler),this.events.on("pointerdragleave",this._pointerDragLeaveHandler)):!ci&&this._draggable&&(this.events.off("pointerdragstart",this._pointerDragStartHandler),this.events.off("pointerdragend",this._pointerDragEndHandler),this.events.off("pointerdragmove",this._pointerDragMoveHandler),this.events.off("pointerdragleave",this._pointerDragLeaveHandler)),this._draggable=ci)}get color(){return this.graphics.color}set color(ci){this.graphics.color=ci}constructor(ci){super(),this.events=new EventEmitter,this._anchor=watch(Vector.Half,Oi=>this._handleAnchorChange(Oi)),this._offset=watch(Vector.Zero,Oi=>this._handleOffsetChange(Oi)),this.logger=Logger.getInstance(),this._draggable=!1,this._dragging=!1,this._pointerDragStartHandler=()=>{this._dragging=!0},this._pointerDragEndHandler=()=>{this._dragging=!1},this._pointerDragMoveHandler=Oi=>{this._dragging&&(this.pos=Oi.worldPos)},this._pointerDragLeaveHandler=Oi=>{this._dragging&&(this.pos=Oi.worldPos)};const{name:hi,x:_i,y:pi,pos:mi,coordPlane:gi,scale:vi,width:xi,height:wi,radius:yi,collider:Ci,vel:Ei,acc:Si,rotation:ki,angularVelocity:Ai,z:Ii,color:Ti,visible:Pi,opacity:Li,anchor:Ri,offset:Di,collisionType:Fi,collisionGroup:Mi,silenceWarnings:$i}={...ci};this.name=hi??this.name,this.anchor=Ri??Actor.defaults.anchor.clone(),this.offset=Di??Vector.Zero,this.transform=new TransformComponent,this.addComponent(this.transform),this.pos=mi??vec(_i??0,pi??0),this.rotation=ki??0,this.scale=vi??vec(1,1),this.z=Ii??0,this.transform.coordPlane=gi??CoordPlane.World,this._silenceWarnings=$i??!1,this.pointer=new PointerComponent,this.addComponent(this.pointer),this.graphics=new GraphicsComponent({anchor:this.anchor,offset:this.offset,opacity:Li}),this.addComponent(this.graphics),this.motion=new MotionComponent,this.addComponent(this.motion),this.vel=Ei??Vector.Zero,this.acc=Si??Vector.Zero,this.angularVelocity=Ai??0,this.actions=new ActionsComponent,this.addComponent(this.actions),this.body=new BodyComponent,this.addComponent(this.body),this.body.collisionType=Fi??CollisionType.Passive,Mi&&(this.body.group=Mi),Ti&&(this.color=Ti),Ci?(this.collider=new ColliderComponent(Ci),this.addComponent(this.collider)):yi?(this.collider=new ColliderComponent(Shape.Circle(yi)),this.addComponent(this.collider),Ti&&this.graphics.add(new Circle({color:Ti,radius:yi}))):xi>0&&wi>0?(this.collider=new ColliderComponent(Shape.Box(xi,wi,this.anchor)),this.addComponent(this.collider),Ti&&xi&&wi&&this.graphics.add(new Rectangle({color:Ti,width:xi,height:wi}))):(this.collider=new ColliderComponent,this.addComponent(this.collider)),this.graphics.isVisible=Pi??!0}clone(){const ci=new Actor({silenceWarnings:this._silenceWarnings,color:this.color.clone(),anchor:this.anchor.clone(),offset:this.offset.clone()});ci.clearComponents(),ci.processComponentRemoval(),ci.addComponent(ci.transform=this.transform.clone(),!0),ci.addComponent(ci.pointer=this.pointer.clone(),!0),ci.addComponent(ci.graphics=this.graphics.clone(),!0),ci.addComponent(ci.motion=this.motion.clone(),!0),ci.addComponent(ci.actions=this.actions.clone(),!0),ci.addComponent(ci.body=this.body.clone(),!0),ci.addComponent(ci.collider=this.collider.clone(),!0);const hi=[this.transform,this.pointer,this.graphics,this.motion,this.actions,this.body,this.collider],_i=this.getComponents();for(const pi of _i)hi.includes(pi)||ci.addComponent(pi.clone(),!0);return ci}onInitialize(ci){}_initialize(ci){super._initialize(ci);for(const hi of this.children)hi._initialize(ci)}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}_prekill(ci){this.events.emit("prekill",new PreKillEvent(this)),this.onPreKill(ci)}onPreKill(ci){}_postkill(ci){this.events.emit("postkill",new PostKillEvent(this)),this.onPostKill(ci)}onPostKill(ci){}kill(){this.scene?(this._prekill(this.scene),this.events.emit("kill",new KillEvent(this)),super.kill(),this._postkill(this.scene)):this.logger.warn(`Cannot kill actor named "${this.name}", it was never added to the Scene`)}unkill(){this.isActive=!0}isKilled(){return!this.isActive}get z(){return this.get(TransformComponent).z}set z(ci){this.get(TransformComponent).z=ci}get center(){const ci=this.getGlobalPos();return new Vector(ci.x+this.width/2-this.anchor.x*this.width,ci.y+this.height/2-this.anchor.y*this.height)}get localCenter(){return new Vector(this.pos.x+this.width/2-this.anchor.x*this.width,this.pos.y+this.height/2-this.anchor.y*this.height)}get width(){return this.collider.localBounds.width*this.getGlobalScale().x}get height(){return this.collider.localBounds.height*this.getGlobalScale().y}getGlobalRotation(){return this.get(TransformComponent).globalRotation}get globalRotation(){return this.get(TransformComponent).globalRotation}getGlobalPos(){return this.get(TransformComponent).globalPos}get globalPos(){return this.get(TransformComponent).globalPos}getGlobalScale(){return this.get(TransformComponent).globalScale}get globalScale(){return this.get(TransformComponent).globalScale}get globalZ(){return this.get(TransformComponent).globalZ}contains(ci,hi,_i=!1){const pi=vec(ci,hi),mi=this.get(ColliderComponent);mi.update();const gi=mi.get();if(!gi)return!1;const vi=gi.contains(pi);return _i?vi||this.children.some(xi=>xi.contains(ci,hi,!0)):vi}within(ci,hi){const _i=this.get(ColliderComponent),pi=ci.get(ColliderComponent),mi=_i.get(),gi=pi.get();return mi&&gi?mi.getClosestLineBetween(gi).getLength()<=hi:!1}update(ci,hi){this._initialize(ci),this._add(ci),this._preupdate(ci,hi),this._postupdate(ci,hi),this._remove(ci)}onPreUpdate(ci,hi){}onPostUpdate(ci,hi){}onPreCollisionResolve(ci,hi,_i,pi){}onPostCollisionResolve(ci,hi,_i,pi){}onCollisionStart(ci,hi,_i,pi){}onCollisionEnd(ci,hi,_i,pi){}_preupdate(ci,hi){this.events.emit("preupdate",new PreUpdateEvent(ci,hi,this)),this.onPreUpdate(ci,hi)}_postupdate(ci,hi){this.events.emit("postupdate",new PostUpdateEvent(ci,hi,this)),this.onPostUpdate(ci,hi)}}Actor.defaults={anchor:Vector.Half};function isScreenElement(fi){return fi instanceof ScreenElement}class ScreenElement extends Actor{constructor(ci){var hi,_i;super({...ci}),this.get(TransformComponent).coordPlane=CoordPlane.Screen,this.anchor=(hi=ci==null?void 0:ci.anchor)!==null&&hi!==void 0?hi:vec(0,0),this.body.collisionType=(_i=ci==null?void 0:ci.collisionType)!==null&&_i!==void 0?_i:CollisionType.PreventCollision,this.pointer.useGraphicsBounds=!0,this.pointer.useColliderShape=!1,!(ci!=null&&ci.collider)&&(ci==null?void 0:ci.width)>0&&(ci==null?void 0:ci.height)>0&&this.collider.useBoxCollider(this.width,this.height,this.anchor)}_initialize(ci){this._engine=ci,super._initialize(ci)}contains(ci,hi,_i=!0){if(_i)return super.contains(ci,hi);const pi=this._engine.worldToScreenCoordinates(new Vector(ci,hi));return super.contains(pi.x,pi.y)}}class Timer{get complete(){return this._complete}constructor(ci){var hi;this._logger=Logger.getInstance(),this.id=0,this._elapsedTime=0,this._totalTimeAlive=0,this._running=!1,this._numberOfTicks=0,this.interval=10,this.repeats=!1,this.maxNumberOfRepeats=-1,this.randomRange=[0,0],this._baseInterval=10,this._generateRandomInterval=()=>this._baseInterval+this.random.integer(this.randomRange[0],this.randomRange[1]),this._complete=!1,this.scene=null;const _i=(hi=ci.action)!==null&&hi!==void 0?hi:ci.fcn,pi=ci.interval,mi=ci.repeats,gi=ci.numberOfRepeats,vi=ci.randomRange,xi=ci.random;if(gi&&gi>=0&&(this.maxNumberOfRepeats=gi,!mi))throw new Error("repeats must be set to true if numberOfRepeats is set");if(this.id=Timer._MAX_ID++,this._callbacks=[],this._baseInterval=this.interval=pi,vi){if(vi[0]>vi[1])throw new Error("min value must be lower than max value for range");this.random=xi??new Random,this.randomRange=vi,this.interval=this._generateRandomInterval(),this.on(()=>{this.interval=this._generateRandomInterval()})}this.repeats=mi||this.repeats,_i&&this.on(_i)}on(ci){this._callbacks.push(ci)}off(ci){const hi=this._callbacks.indexOf(ci);this._callbacks.splice(hi,1)}update(ci){this._running&&(this._totalTimeAlive+=ci,this._elapsedTime+=ci,this.maxNumberOfRepeats>-1&&this._numberOfTicks>=this.maxNumberOfRepeats&&(this._complete=!0,this._running=!1,this._elapsedTime=0),!this.complete&&this._elapsedTime>=this.interval&&(this._callbacks.forEach(hi=>{hi.call(this)}),this._numberOfTicks++,this.repeats?this._elapsedTime=0:(this._complete=!0,this._running=!1,this._elapsedTime=0)))}reset(ci,hi){if(ci&&ci>=0&&(this._baseInterval=this.interval=ci),this.maxNumberOfRepeats&&this.maxNumberOfRepeats>=0&&(this.maxNumberOfRepeats=hi,!this.repeats))throw new Error("repeats must be set to true if numberOfRepeats is set");this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0}get timesRepeated(){return this._numberOfTicks}getTimeRunning(){return this._totalTimeAlive}get timeToNextAction(){return this.complete?0:this.interval-this._elapsedTime}get timeElapsedTowardNextAction(){return this._elapsedTime}get isRunning(){return this._running}pause(){return this._running=!1,this}resume(){return this._running=!0,this}start(){return this.scene||this._logger.warn("Cannot start a timer not part of a scene, timer wont start until added"),this._running=!0,this.complete&&(this._complete=!1,this._elapsedTime=0,this._numberOfTicks=0),this}stop(){return this._running=!1,this._elapsedTime=0,this._numberOfTicks=0,this}cancel(){this.pause(),this.scene&&this.scene.cancelTimer(this)}}Timer._MAX_ID=0;class ParallaxComponent extends Component{constructor(ci){super(),this.parallaxFactor=vec(1,1),this.parallaxFactor=ci??this.parallaxFactor}}class DebugGraphicsComponent extends Component{constructor(ci,hi=!0){super(),this.draw=ci,this.useTransform=hi}}function hasNestedEvents(fi){return fi&&fi._dispatchPointerEvents&&fi._processPointerToObject}class PointerTargetObjectProxy{get events(){return this.object.events}init(ci,hi,_i){this.object=ci,this.contains=hi,this.active=_i}}class PointerEventsToObjectDispatcher{constructor(){this._proxyPool=new RentalPool(()=>new PointerTargetObjectProxy,ci=>ci,100),this._objectToProxy=new Map,this._proxies=[],this._lastFrameObjectToPointers=new Map,this._currentFrameObjectToPointers=new Map}addObject(ci,hi,_i){const pi=this._proxyPool.rent(!1);pi.init(ci,hi,_i),this._proxies.push(pi),this._objectToProxy.set(ci,pi)}_getProxy(ci){const hi=this._objectToProxy.get(ci);if(hi)return hi;throw new Error("No PointerTargetProxy for object")}removeObject(ci){const hi=this._objectToProxy.get(ci);if(hi){const _i=this._proxies.indexOf(hi);_i>-1&&this._proxies.splice(_i,1),this._proxyPool.return(hi)}}_objectCurrentlyUnderPointer(ci,hi){return!!(this._currentFrameObjectToPointers.has(ci)&&this._currentFrameObjectToPointers.get(ci).includes(hi))}_objectWasUnderPointer(ci,hi){return!!(this._lastFrameObjectToPointers.has(ci)&&this._lastFrameObjectToPointers.get(ci).includes(hi))}_entered(ci,hi){return this._objectCurrentlyUnderPointer(ci,hi)&&!this._lastFrameObjectToPointers.has(ci)}_left(ci,hi){return!this._currentFrameObjectToPointers.has(ci)&&this._objectWasUnderPointer(ci,hi)}addPointerToObject(ci,hi){const _i=this._objectToProxy.get(ci);_i&&this._addPointerToProxy(_i,hi)}_addPointerToProxy(ci,hi){if(!this._currentFrameObjectToPointers.has(ci)){this._currentFrameObjectToPointers.set(ci,[hi]);return}const _i=this._currentFrameObjectToPointers.get(ci);this._currentFrameObjectToPointers.set(ci,_i.concat(hi))}dispatchEvents(ci,hi){const _i=new Set(this._lastFrameObjectToPointers.keys()),pi=new Set(this._currentFrameObjectToPointers.keys());let mi,gi,vi;for(let xi=0;xi<hi.length;xi++){const wi=hi[xi],yi=this._getProxy(wi);if(hasNestedEvents(wi)&&wi._dispatchPointerEvents(ci),_i.has(yi)||pi.has(yi)){vi=this._processDownAndEmit(ci,yi),gi=this._processUpAndEmit(ci,yi),mi=this._processMoveAndEmit(ci,yi);const Ci=[...mi.values(),...vi.values(),...gi.values()];this._processEnterLeaveAndEmit(ci,yi,Ci),this._processCancelAndEmit(ci,yi),this._processWheelAndEmit(ci,yi)}}}processPointerToObject(ci,hi){for(let _i=0;_i<hi.length;_i++){const pi=hi[_i],mi=this._getProxy(pi);hasNestedEvents(pi)&&pi._processPointerToObject(ci);for(const[gi,vi]of ci.currentFramePointerCoords.entries())mi.contains(vi)&&this._addPointerToProxy(mi,gi)}}clear(){this._lastFrameObjectToPointers.clear(),this._lastFrameObjectToPointers=new Map(this._currentFrameObjectToPointers),this._currentFrameObjectToPointers.clear()}_processDownAndEmit(ci,hi){const _i=new Map;for(const pi of ci.currentFrameDown)pi.active&&this._objectCurrentlyUnderPointer(hi,pi.pointerId)&&(hi.events.emit("pointerdown",pi),ci.isDragStart(pi.pointerId)&&hi.events.emit("pointerdragstart",pi)),_i.set(pi.pointerId,pi);return _i}_processUpAndEmit(ci,hi){const _i=new Map;for(const pi of ci.currentFrameUp)pi.active&&this._objectCurrentlyUnderPointer(hi,pi.pointerId)&&(hi.events.emit("pointerup",pi),ci.isDragEnd(pi.pointerId)&&hi.events.emit("pointerdragend",pi)),_i.set(pi.pointerId,pi);return _i}_processMoveAndEmit(ci,hi){const _i=new Map;for(const pi of ci.currentFrameMove)pi.active&&hi.active()&&this._objectCurrentlyUnderPointer(hi,pi.pointerId)&&(hi.events.emit("pointermove",pi),ci.isDragging(pi.pointerId)&&hi.events.emit("pointerdragmove",pi)),_i.set(pi.pointerId,pi);return _i}_processEnterLeaveAndEmit(ci,hi,_i){for(const pi of _i){if(pi.active&&hi.active()&&this._entered(hi,pi.pointerId)){hi.events.emit("pointerenter",pi),ci.isDragging(pi.pointerId)&&hi.events.emit("pointerdragenter",pi);break}if(pi.active&&hi.active()&&(this._left(hi,pi.pointerId)||this._objectCurrentlyUnderPointer(hi,pi.pointerId)&&pi.type==="up")){hi.events.emit("pointerleave",pi),ci.isDragging(pi.pointerId)&&hi.events.emit("pointerdragleave",pi);break}}}_processCancelAndEmit(ci,hi){for(const _i of ci.currentFrameCancel)_i.active&&hi.active()&&this._objectCurrentlyUnderPointer(hi,_i.pointerId)&&hi.events.emit("pointercancel",_i)}_processWheelAndEmit(ci,hi){for(const _i of ci.currentFrameWheel)_i.active&&hi.active()&&this._objectCurrentlyUnderPointer(hi,0)&&hi.events.emit("pointerwheel",_i)}}const TileMapEvents={PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PointerUp:"pointerup",PointerDown:"pointerdown",PointerMove:"pointermove",PointerCancel:"pointercancel"};class TileMap extends Entity{flagCollidersDirty(){this._collidersDirty=!0}flagTilesDirty(){for(let ci=0;ci<this.tiles.length;ci++)this.tiles[ci]&&this.tiles[ci].flagDirty()}get x(){var ci;return(ci=this.transform.pos.x)!==null&&ci!==void 0?ci:0}set x(ci){var hi;!((hi=this.transform)===null||hi===void 0)&&hi.pos&&(this.get(TransformComponent).pos=vec(ci,this.y))}get y(){var ci,hi;return(hi=(ci=this.transform)===null||ci===void 0?void 0:ci.pos.y)!==null&&hi!==void 0?hi:0}set y(ci){var hi;!((hi=this.transform)===null||hi===void 0)&&hi.pos&&(this.transform.pos=vec(this.x,ci))}get z(){var ci;return(ci=this.transform.z)!==null&&ci!==void 0?ci:0}set z(ci){this.transform&&(this.transform.z=ci)}get rotation(){var ci,hi;return(hi=(ci=this.transform)===null||ci===void 0?void 0:ci.rotation)!==null&&hi!==void 0?hi:0}set rotation(ci){this.transform&&(this.transform.rotation=ci)}get scale(){var ci,hi;return(hi=(ci=this.transform)===null||ci===void 0?void 0:ci.scale)!==null&&hi!==void 0?hi:Vector.One}set scale(ci){var hi;!((hi=this.transform)===null||hi===void 0)&&hi.scale&&(this.transform.scale=ci)}get pos(){return this.transform.pos}set pos(ci){this.transform.pos=ci}get vel(){return this._motion.vel}set vel(ci){this._motion.vel=ci}get width(){return this.tileWidth*this.columns*this.scale.x}get height(){return this.tileHeight*this.rows*this.scale.y}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}constructor(ci){var hi,_i,pi;super([],ci.name),this.events=new EventEmitter,this._token=0,this.logger=Logger.getInstance(),this.tiles=[],this._rows=[],this._cols=[],this.renderFromTopOfGraphic=!1,this.meshingLookBehind=10,this._collidersDirty=!0,this._oldRotation=0,this._originalOffsets=new WeakMap,this.meshingLookBehind=(hi=ci.meshingLookBehind)!==null&&hi!==void 0?hi:this.meshingLookBehind,this.addComponent(new TransformComponent),this.addComponent(new MotionComponent),this.addComponent(new BodyComponent({type:CollisionType.Fixed})),this.addComponent(new GraphicsComponent({onPostDraw:(gi,vi)=>this.draw(gi,vi)})),this.addComponent(new DebugGraphicsComponent((gi,vi)=>this.debug(gi,vi),!1)),this.addComponent(new ColliderComponent),this.addComponent(new PointerComponent),this.pointer=this.get(PointerComponent),this._graphics=this.get(GraphicsComponent),this.transform=this.get(TransformComponent),this._motion=this.get(MotionComponent),this.collider=this.get(ColliderComponent),this._composite=this.collider.useCompositeCollider([]),this.transform.pos=(_i=ci.pos)!==null&&_i!==void 0?_i:Vector.Zero,this._oldPos=this.transform.pos.clone(),this._oldScale=this.transform.scale.clone(),this.renderFromTopOfGraphic=(pi=ci.renderFromTopOfGraphic)!==null&&pi!==void 0?pi:this.renderFromTopOfGraphic,this.tileWidth=ci.tileWidth,this.tileHeight=ci.tileHeight,this.rows=ci.rows,this.columns=ci.columns,this._pointerEventDispatcher=new PointerEventsToObjectDispatcher,this.tiles=new Array(this.rows*this.columns),this._rows=new Array(this.rows),this._cols=new Array(this.columns);let mi=[];for(let gi=0;gi<this.columns;gi++){for(let vi=0;vi<this.rows;vi++){const xi=new Tile({x:gi,y:vi,map:this});xi.map=this,this.tiles[gi+vi*this.columns]=xi,this._pointerEventDispatcher.addObject(xi,wi=>xi.bounds.contains(wi.worldPos),()=>!0),mi.push(xi),this._rows[vi]||(this._rows[vi]=[]),this._rows[vi].push(xi)}this._cols[gi]=mi,mi=[]}this._graphics.localBounds=new BoundingBox({left:0,top:0,right:this.columns*this.tileWidth*this.scale.x,bottom:this.rows*this.tileHeight*this.scale.y})}_initialize(ci){super._initialize(ci),this._engine=ci}_getOrSetColliderOriginalOffset(ci){var hi;if(this._originalOffsets.has(ci))return(hi=this._originalOffsets.get(ci))!==null&&hi!==void 0?hi:Vector.Zero;{const _i=ci.offset;return this._originalOffsets.set(ci,_i),_i}}_updateColliders(){this.collider.$colliderRemoved.notifyAll(this._composite),this._composite.clearColliders();const ci=[];this._composite=this.collider.useCompositeCollider([]);let hi=null;const _i=(mi,gi)=>mi&&gi?mi.top===gi.top&&mi.bottom===gi.bottom&&mi.right===gi.left:!1,pi=(mi,gi,vi=this.meshingLookBehind)=>{if(!mi)return!1;for(let xi=gi.length-1;xi>=0;xi--){if(vi--<0)return!1;const wi=gi[xi];if(_i(wi,mi))return gi[xi]=wi.combine(mi),!0}return!1};for(let mi=0;mi<this.columns;mi++){for(let gi=0;gi<this.rows;gi++){const vi=this.tiles[mi+gi*this.columns];if(vi.solid)if(vi.getColliders().length>0){for(const xi of vi.getColliders()){const wi=this._getOrSetColliderOriginalOffset(xi);xi.offset=vec(vi.x*this.tileWidth*this.scale.x,vi.y*this.tileHeight*this.scale.y).add(wi),xi.owner=this,this._composite.addCollider(xi)}hi&&!pi(hi,ci)&&ci.push(hi),hi=null}else hi?hi=hi.combine(vi.defaultGeometry):hi=vi.defaultGeometry;else hi&&!pi(hi,ci)&&ci.push(hi),hi=null}hi&&!pi(hi,ci)&&ci.push(hi),hi=null}for(const mi of ci){const gi=Shape.Box(mi.width,mi.height,Vector.Zero,vec(mi.left-this.pos.x,mi.top-this.pos.y));gi.owner=this,this._composite.addCollider(gi)}this.collider.update(),this.collider.$colliderAdded.notifyAll(this._composite)}getTileByIndex(ci){var hi;return(hi=this.tiles[ci])!==null&&hi!==void 0?hi:null}getTile(ci,hi){return ci<0||hi<0||ci>=this.columns||hi>=this.rows?null:this.tiles[ci+hi*this.columns]}getTileByPoint(ci){const{x:hi,y:_i}=this._getTileCoordinates(ci),pi=this.getTile(hi,_i);return hi>=0&&_i>=0&&hi<this.columns&&_i<this.rows&&pi?pi:null}_getTileCoordinates(ci){ci=this.transform.applyInverse(ci);const hi=Math.floor(ci.x/this.tileWidth),_i=Math.floor(ci.y/this.tileHeight);return{x:hi,y:_i}}getRows(){return this._rows}getColumns(){return this._cols}getOnScreenTiles(){let ci=this._engine.screen.getWorldBounds();const hi=this.get(ParallaxComponent);if(hi&&this.isInitialized){let Si=this.pos;const ki=Vector.One.sub(hi.parallaxFactor),Ai=this._engine.currentScene.camera.pos.scale(ki);Si=Si.sub(Ai),ci=ci.translate(Si)}const _i=this.transform.coordPlane===CoordPlane.Screen?this._engine.screen.getScreenBounds():ci,pi=this._getTileCoordinates(_i.topLeft),mi=this._getTileCoordinates(_i.topRight),gi=this._getTileCoordinates(_i.bottomRight),vi=this._getTileCoordinates(_i.bottomLeft),xi=Math.min(clamp(pi.x,0,this.columns-1),clamp(mi.x,0,this.columns-1)),wi=Math.min(clamp(pi.y,0,this.rows-1),clamp(mi.y,0,this.rows-1)),yi=Math.max(clamp(gi.x,0,this.columns-1),clamp(vi.x,0,this.columns-1)),Ci=Math.max(clamp(gi.y,0,this.rows-1),clamp(vi.y,0,this.rows-1)),Ei=[];for(let Si=xi;Si<=yi;Si++)for(let ki=wi;ki<=Ci;ki++)Ei.push(this.getTile(Si,ki));return Ei}_processPointerToObject(ci){this._pointerEventDispatcher.processPointerToObject(ci,this.tiles)}_dispatchPointerEvents(ci){this._pointerEventDispatcher.dispatchEvents(ci,this.tiles)}update(ci,hi){this._initialize(ci),this.onPreUpdate(ci,hi),this.emit("preupdate",new PreUpdateEvent(ci,hi,this)),(!this._oldPos.equals(this.pos)||this._oldRotation!==this.rotation||!this._oldScale.equals(this.scale))&&(this.flagCollidersDirty(),this.flagTilesDirty()),this._collidersDirty&&(this._collidersDirty=!1,this._updateColliders()),this._pointerEventDispatcher.clear(),this._token++,this.pos.clone(this._oldPos),this._oldRotation=this.rotation,this.scale.clone(this._oldScale),this.transform.pos=this.pos,this.onPostUpdate(ci,hi),this.emit("postupdate",new PostUpdateEvent(ci,hi,this))}draw(ci,hi){if(!this.isInitialized)return;this.emit("predraw",new PreDrawEvent(ci,hi,this));let _i,pi,mi;const gi=this.getOnScreenTiles();for(let vi=0;vi<gi.length;vi++){const xi=gi[vi],wi=xi.getGraphicsOffsets();for(_i=xi.getGraphics(),pi=0,mi=_i.length;pi<mi;pi++){const yi=_i[pi],Ci=wi[pi];if(yi){hasGraphicsTick(yi)&&(yi==null||yi.tick(hi,this._token));const Ei=this.renderFromTopOfGraphic?0:yi.height-this.tileHeight;yi.draw(ci,xi.x*this.tileWidth+Ci.x,xi.y*this.tileHeight-Ei+Ci.y)}}}this.emit("postdraw",new PostDrawEvent(ci,hi,this))}debug(ci,hi){const{showAll:_i,showGrid:pi,gridColor:mi,gridWidth:gi,showSolidBounds:vi,solidBoundsColor:xi,showColliderGeometry:wi}=hi.tilemap,{geometryColor:yi,geometryLineWidth:Ci,geometryPointSize:Ei}=hi.collider,Si=this.tileWidth*this.columns*this.scale.x,ki=this.tileHeight*this.rows*this.scale.y,Ai=this.pos;if(pi||_i){for(let Ii=0;Ii<this.rows+1;Ii++){const Ti=vec(0,Ii*this.tileHeight*this.scale.y);ci.drawLine(Ai.add(Ti),Ai.add(vec(Si,Ti.y)),mi,gi)}for(let Ii=0;Ii<this.columns+1;Ii++){const Ti=vec(Ii*this.tileWidth*this.scale.x,0);ci.drawLine(Ai.add(Ti),Ai.add(vec(Ti.x,ki)),mi,gi)}}if(_i||vi||wi){const Ii=this._composite.getColliders();ci.save(),ci.translate(this.pos.x,this.pos.y),ci.scale(this.scale.x,this.scale.y);for(const Ti of Ii){const Pi=Ti.localBounds,Li=Ti.worldPos.sub(this.pos);vi&&ci.drawRectangle(Li,Pi.width,Pi.height,xi)}if(ci.restore(),wi)for(const Ti of Ii)Ti.debug(ci,yi,{lineWidth:Ci,pointSize:Ei})}if(_i||vi){if(ci.save(),ci.z=999,vi)for(let Ii=0;Ii<this.tiles.length;Ii++)this.tiles[Ii].bounds.draw(ci);ci.restore()}}}class Tile{get pos(){return this._posDirty&&(this._recalculate(),this._posDirty=!1),this._pos}get width(){return this._width}get height(){return this._height}get solid(){return this._solid}set solid(ci){var hi;(hi=this.map)===null||hi===void 0||hi.flagCollidersDirty(),this._solid=ci}getGraphics(){return this._graphics}getGraphicsOffsets(){return this._offsets}addGraphic(ci,hi){this._graphics.push(ci),hi!=null&&hi.offset?this._offsets.push(hi.offset):this._offsets.push(Vector.Zero)}removeGraphic(ci){const hi=this._graphics.indexOf(ci);hi>-1&&(this._graphics.splice(hi,1),this._offsets.splice(hi,1))}clearGraphics(){this._graphics.length=0,this._offsets.length=0}getColliders(){return this._colliders}addCollider(ci){this._colliders.push(ci),this.map.flagCollidersDirty()}removeCollider(ci){const hi=this._colliders.indexOf(ci);hi>-1&&this._colliders.splice(hi,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}constructor(ci){var hi,_i;this._posDirty=!1,this.events=new EventEmitter,this._solid=!1,this._graphics=[],this._offsets=[],this._colliders=[],this.data=new Map,this.x=ci.x,this.y=ci.y,this.map=ci.map,this._width=ci.map.tileWidth*this.map.scale.x,this._height=ci.map.tileHeight*this.map.scale.y,this.solid=(hi=ci.solid)!==null&&hi!==void 0?hi:this.solid,this._graphics=(_i=ci.graphics)!==null&&_i!==void 0?_i:[],this._recalculate()}flagDirty(){return this._posDirty=!0}_recalculate(){const ci=this.map.pos.add(vec(this.x*this.map.tileWidth,this.y*this.map.tileHeight));this._geometry=new BoundingBox(ci.x,ci.y,ci.x+this.map.tileWidth,ci.y+this.map.tileHeight),this._width=this.map.tileWidth*this.map.scale.x,this._height=this.map.tileHeight*this.map.scale.y,this._pos=this.map.pos.add(vec(this.x*this._width,this.y*this._height)),this._bounds=new BoundingBox(this._pos.x,this._pos.y,this._pos.x+this._width,this._pos.y+this._height),this.map.rotation&&(this._bounds=this._bounds.rotate(this.map.rotation,this.map.pos)),this._posDirty=!1}get bounds(){return this._posDirty&&this._recalculate(),this._bounds}get defaultGeometry(){return this._geometry}get center(){return this._posDirty&&this._recalculate(),new Vector(this._pos.x+this._width/2,this._pos.y+this._height/2)}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){hi?this.events.off(ci,hi):this.events.off(ci)}}class StrategyContainer{constructor(ci){this.camera=ci}lockToActor(ci){this.camera.addStrategy(new LockCameraToActorStrategy(ci))}lockToActorAxis(ci,hi){this.camera.addStrategy(new LockCameraToActorAxisStrategy(ci,hi))}elasticToActor(ci,hi,_i){this.camera.addStrategy(new ElasticToActorStrategy(ci,hi,_i))}radiusAroundActor(ci,hi){this.camera.addStrategy(new RadiusAroundActorStrategy(ci,hi))}limitCameraBounds(ci){this.camera.addStrategy(new LimitCameraBoundsStrategy(ci))}}var Axis;(function(fi){fi[fi.X=0]="X",fi[fi.Y=1]="Y"})(Axis||(Axis={}));class LockCameraToActorStrategy{constructor(ci){this.target=ci,this.action=(hi,_i,pi,mi)=>hi.center}}class LockCameraToActorAxisStrategy{constructor(ci,hi){this.target=ci,this.axis=hi,this.action=(_i,pi,mi,gi)=>{const vi=_i.center,xi=pi.getFocus();return this.axis===Axis.X?new Vector(vi.x,xi.y):new Vector(xi.x,vi.y)}}}class ElasticToActorStrategy{constructor(ci,hi,_i){this.target=ci,this.cameraElasticity=hi,this.cameraFriction=_i,this.action=(pi,mi,gi,vi)=>{const xi=pi.center;let wi=mi.getFocus(),yi=mi.vel.clone();const Ci=xi.sub(wi).scale(this.cameraElasticity);yi=yi.add(Ci);const Ei=yi.scale(-1).scale(this.cameraFriction);return yi=yi.add(Ei),wi=wi.add(yi),wi}}}class RadiusAroundActorStrategy{constructor(ci,hi){this.target=ci,this.radius=hi,this.action=(_i,pi,mi,gi)=>{const vi=_i.center,xi=pi.getFocus(),wi=vi.sub(xi),yi=wi.magnitude;if(yi>=this.radius){const Ci=yi-this.radius;return xi.add(wi.normalize().scale(Ci))}return xi}}}class LimitCameraBoundsStrategy{constructor(ci){this.target=ci,this.boundSizeChecked=!1,this.action=(hi,_i,pi,mi)=>{const gi=_i.getFocus();this.boundSizeChecked||((hi.bottom-hi.top<pi.drawHeight||hi.right-hi.left<pi.drawWidth)&&Logger.getInstance().warn("Camera bounds should not be smaller than the engine viewport"),this.boundSizeChecked=!0);let vi=gi.x,xi=gi.y;return gi.x<hi.left+pi.halfDrawWidth?vi=hi.left+pi.halfDrawWidth:gi.x>hi.right-pi.halfDrawWidth&&(vi=hi.right-pi.halfDrawWidth),gi.y<hi.top+pi.halfDrawHeight?xi=hi.top+pi.halfDrawHeight:gi.y>hi.bottom-pi.halfDrawHeight&&(xi=hi.bottom-pi.halfDrawHeight),vec(vi,xi)}}}const CameraEvents={Initialize:"initialize",PreUpdate:"preupdate",PostUpdate:"postupdate"};class Camera{constructor(){this.events=new EventEmitter,this.transform=AffineMatrix.identity(),this.inverse=AffineMatrix.identity(),this._cameraStrategies=[],this.strategy=new StrategyContainer(this),this._z=1,this.dz=0,this.az=0,this.rotation=0,this._angularVelocity=0,this._posChanged=!1,this._pos=new WatchVector(Vector.Zero,()=>{this._posChanged=!0}),this.drawPos=this.pos.clone(),this._oldPos=this.pos.clone(),this.vel=Vector.Zero,this.acc=Vector.Zero,this._cameraMoving=!1,this._currentLerpTime=0,this._lerpDuration=1e3,this._lerpStart=null,this._lerpEnd=null,this._isShaking=!1,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._elapsedShakeTime=0,this._xShake=0,this._yShake=0,this._isZooming=!1,this._zoomStart=1,this._zoomEnd=1,this._currentZoomTime=0,this._zoomDuration=0,this._zoomEasing=EasingFunctions.EaseInOutCubic,this._easing=EasingFunctions.EaseInOutCubic,this._halfWidth=0,this._halfHeight=0,this._viewport=null,this._isInitialized=!1,this._snapPos=vec(0,0)}get zoom(){return this._z}set zoom(ci){this._z=ci,this._engine&&(this._halfWidth=this._engine.halfDrawWidth,this._halfHeight=this._engine.halfDrawHeight)}get angularVelocity(){return this._angularVelocity}set angularVelocity(ci){this._angularVelocity=ci}get pos(){return this._pos}set pos(ci){this._posChanged=!0,this._pos=new WatchVector(ci,()=>{this._posChanged=!0})}hasChanged(){return this._posChanged}get x(){return this.pos.x}set x(ci){!this._follow&&!this._cameraMoving&&(this.pos=vec(ci,this.pos.y))}get y(){return this.pos.y}set y(ci){!this._follow&&!this._cameraMoving&&(this.pos=vec(this.pos.x,ci))}get dx(){return this.vel.x}set dx(ci){this.vel=vec(ci,this.vel.y)}get dy(){return this.vel.y}set dy(ci){this.vel=vec(this.vel.x,ci)}get ax(){return this.acc.x}set ax(ci){this.acc=vec(ci,this.acc.y)}get ay(){return this.acc.y}set ay(ci){this.acc=vec(this.acc.x,ci)}getFocus(){return this.pos}move(ci,hi,_i=EasingFunctions.EaseInOutCubic){if(typeof _i!="function")throw"Please specify an EasingFunction";return this._follow?Promise.reject(ci):(this._lerpPromise&&this._lerpResolve&&this._lerpResolve(ci),this._lerpPromise=new Promise(pi=>{this._lerpResolve=pi}),this._lerpStart=this.getFocus().clone(),this._lerpDuration=hi,this._lerpEnd=ci,this._currentLerpTime=0,this._cameraMoving=!0,this._easing=_i,this._lerpPromise)}shake(ci,hi,_i){this._isShaking=!0,this._shakeMagnitudeX=ci,this._shakeMagnitudeY=hi,this._shakeDuration=_i}zoomOverTime(ci,hi=0,_i=EasingFunctions.EaseInOutCubic){if(this._zoomPromise=new Promise(pi=>{this._zoomResolve=pi}),hi)this._isZooming=!0,this._zoomEasing=_i,this._currentZoomTime=0,this._zoomDuration=hi,this._zoomStart=this.zoom,this._zoomEnd=ci;else return this._isZooming=!1,this.zoom=ci,Promise.resolve(!0);return this._zoomPromise}get viewport(){return this._viewport?this._viewport:new BoundingBox(0,0,0,0)}addStrategy(ci){this._cameraStrategies.push(ci)}removeStrategy(ci){removeItemFromArray(ci,this._cameraStrategies)}clearAllStrategies(){this._cameraStrategies.length=0}_preupdate(ci,hi){this.events.emit("preupdate",new PreUpdateEvent(ci,hi,this)),this.onPreUpdate(ci,hi)}onPreUpdate(ci,hi){}_postupdate(ci,hi){this.events.emit("postupdate",new PostUpdateEvent(ci,hi,this)),this.onPostUpdate(ci,hi)}onPostUpdate(ci,hi){}get isInitialized(){return this._isInitialized}_initialize(ci){if(!this.isInitialized){this._engine=ci,this._screen=ci.screen;const hi=this._screen.contentArea;let _i=vec(hi.width/2,hi.height/2);if(!this._engine.loadingComplete){const pi=this._screen.peekResolution();pi&&(_i=vec(pi.width/2,pi.height/2))}this._halfWidth=_i.x,this._halfHeight=_i.y,this._posChanged||(this.pos=_i),this.pos.clone(this.drawPos),this.updateTransform(this.pos),this.runStrategies(ci,ci.clock.elapsed()),this.updateViewport(),this.updateTransform(this.pos),this.pos.clone(this._oldPos),this.onInitialize(ci),this.events.emit("initialize",new InitializeEvent(ci,this)),this._isInitialized=!0}}onInitialize(ci){}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}runStrategies(ci,hi){for(const _i of this._cameraStrategies)this.pos=_i.action.call(_i,_i.target,this,ci,hi)}updateViewport(){this._viewport=new BoundingBox(this.x-this._halfWidth,this.y-this._halfHeight,this.x+this._halfWidth,this.y+this._halfHeight)}update(ci,hi){if(this._initialize(ci),this._preupdate(ci,hi),this.pos.clone(this._oldPos),this.pos=this.pos.add(this.vel.scale(hi/1e3)),this.zoom+=this.dz*hi/1e3,this.vel=this.vel.add(this.acc.scale(hi/1e3)),this.dz+=this.az*hi/1e3,this.rotation+=this.angularVelocity*hi/1e3,this._isZooming)if(this._currentZoomTime<this._zoomDuration){const _i=this._zoomEasing,pi=_i(this._currentZoomTime,this._zoomStart,this._zoomEnd,this._zoomDuration);this.zoom=pi,this._currentZoomTime+=hi}else this._isZooming=!1,this.zoom=this._zoomEnd,this._currentZoomTime=0,this._zoomResolve(!0);if(this._cameraMoving)if(this._currentLerpTime<this._lerpDuration){const pi=EasingFunctions.CreateVectorEasingFunction(this._easing)(this._currentLerpTime,this._lerpStart,this._lerpEnd,this._lerpDuration);this.pos=pi,this._currentLerpTime+=hi}else{this.pos=this._lerpEnd;const _i=this._lerpEnd.clone();this._lerpStart=null,this._lerpEnd=null,this._currentLerpTime=0,this._cameraMoving=!1,this._lerpResolve(_i)}this._isDoneShaking()?(this._isShaking=!1,this._elapsedShakeTime=0,this._shakeMagnitudeX=0,this._shakeMagnitudeY=0,this._shakeDuration=0,this._xShake=0,this._yShake=0):(this._elapsedShakeTime+=hi,this._xShake=(Math.random()*this._shakeMagnitudeX|0)+1,this._yShake=(Math.random()*this._shakeMagnitudeY|0)+1),this.runStrategies(ci,hi),this.updateViewport(),this.updateTransform(this.pos),this._postupdate(ci,hi),this._posChanged=!1}draw(ci){if(this.pos.clone(this.drawPos),this._engine.fixedUpdateTimestep){const hi=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep,_i=this.pos.scale(hi).add(this._oldPos.scale(1-hi));_i.clone(this.drawPos),this.updateTransform(_i)}if(ci.snapToPixel){const hi=this.drawPos.clone(this._snapPos);hi.x=~~(hi.x+pixelSnapEpsilon*sign(hi.x)),hi.y=~~(hi.y+pixelSnapEpsilon*sign(hi.y)),hi.clone(this.drawPos),this.updateTransform(hi)}ci.multiply(this.transform)}updateTransform(ci){const hi=this._screen.resolution.width/this.zoom,_i=this._screen.resolution.height/this.zoom,pi=vec(-ci.x+hi/2+this._xShake,-ci.y+_i/2+this._yShake);this.transform.reset(),this.transform.scale(this.zoom,this.zoom),this.transform.translate(hi/2,_i/2),this.transform.rotate(this.rotation),this.transform.translate(-hi/2,-_i/2),this.transform.translate(pi.x,pi.y),this.transform.inverse(this.inverse)}_isDoneShaking(){return!this._isShaking||this._elapsedShakeTime>=this._shakeDuration}}const TriggerEvents={ExitTrigger:"exit",EnterTrigger:"enter"};class Trigger extends Actor{constructor(ci){var hi,_i,pi,mi;super({...ci}),this.events=new EventEmitter,this.filter=(hi=ci.filter)!==null&&hi!==void 0?hi:()=>!0,this.repeat=(_i=ci.repeat)!==null&&_i!==void 0?_i:-1,this.action=(pi=ci.action)!==null&&pi!==void 0?pi:()=>{},this.target=ci.target,this.graphics.isVisible=(mi=ci.visible)!==null&&mi!==void 0?mi:!1,this.body.collisionType=CollisionType.Passive,this.events.on("collisionstart",({other:gi})=>{this._matchesTarget(gi.owner)&&(this.events.emit("enter",new EnterTriggerEvent(this,gi.owner)),this._dispatchAction(gi.owner),this.repeat===0&&this.kill())}),this.events.on("collisionend",({other:gi})=>{this._matchesTarget(gi.owner)&&this.events.emit("exit",new ExitTriggerEvent(this,gi.owner))})}_matchesTarget(ci){return this.filter(ci)&&(this.target===void 0||this.target===ci)}_dispatchAction(ci){this.repeat!==0&&(this.action.call(this,ci),this.repeat--)}}const SystemPriority={Highest:-1/0,Higher:-5,Average:0,Lower:5,Lowest:1/0};var SystemType;(function(fi){fi.Update="update",fi.Draw="draw"})(SystemType||(SystemType={}));class System{}System.priority=SystemPriority.Average;class EntityManager{constructor(ci){this._world=ci,this.entities=[],this._entityIndex={},this._childAddedHandlerMap=new Map,this._childRemovedHandlerMap=new Map,this._createChildAddedHandler=()=>hi=>{this.addEntity(hi)},this._createChildRemovedHandler=()=>hi=>{this.removeEntity(hi,!1)},this._entitiesToRemove=[]}updateEntities(ci,hi){for(let _i=0;_i<this.entities.length;_i++){const pi=this.entities[_i];pi.update(ci.engine,hi),pi.isActive||this.removeEntity(pi)}}findEntitiesForRemoval(){for(let ci=0;ci<this.entities.length;ci++){const hi=this.entities[ci];hi.isActive||this.removeEntity(hi)}}addEntity(ci){if(ci.isActive=!0,ci.scene=this._world.scene,ci&&!this._entityIndex[ci.id]){this._entityIndex[ci.id]=ci,this.entities.push(ci),this._world.queryManager.addEntity(ci),ci.children.forEach(pi=>{pi.scene=ci.scene,this.addEntity(pi)});const hi=this._createChildAddedHandler();this._childAddedHandlerMap.set(ci,hi);const _i=this._createChildRemovedHandler();this._childRemovedHandlerMap.set(ci,_i),ci.childrenAdded$.subscribe(hi),ci.childrenRemoved$.subscribe(_i)}}removeEntity(ci,hi=!0){var _i,pi;let mi=0;ci instanceof Entity?mi=ci.id:mi=ci;const gi=this._entityIndex[mi];if(gi&&gi.isActive&&(gi.isActive=!1),gi&&hi){this._entitiesToRemove.push(gi);return}if(delete this._entityIndex[mi],gi){gi.scene=null,removeItemFromArray(gi,this.entities),this._world.queryManager.removeEntity(gi),gi.children.forEach(wi=>{wi.scene=null,this.removeEntity(wi,hi)});const vi=this._childAddedHandlerMap.get(gi);vi&&gi.childrenAdded$.unsubscribe(vi);const xi=this._childRemovedHandlerMap.get(gi);xi&&gi.childrenRemoved$.unsubscribe(xi),!((pi=(_i=this._world)===null||_i===void 0?void 0:_i.scene)===null||pi===void 0)&&pi.engine&&this._world.scene.engine.stats.currFrame.actors.killed++}}processEntityRemovals(){for(let ci=0;ci<this._entitiesToRemove.length;ci++){const hi=this._entitiesToRemove[ci];hi.isActive||this.removeEntity(hi,!1)}this._entitiesToRemove.length=0}processComponentRemovals(){for(let ci=0;ci<this.entities.length;ci++)this.entities[ci].processComponentRemoval()}getById(ci){return this._entityIndex[ci]}getByName(ci){return this.entities.filter(hi=>hi.name===ci)}clear(){for(let ci=this.entities.length-1;ci>=0;ci--)this.removeEntity(this.entities[ci])}}class Query{constructor(ci){if(this.requiredComponents=ci,this.components=new Set,this.entities=[],this.entityAdded$=new Observable,this.entityRemoved$=new Observable,ci.length===0)throw new Error("Cannot create query without components");for(const hi of ci)this.components.add(hi);this.id=Query.createId(ci)}static createId(ci){return ci.slice().map(hi=>hi.name).sort().join("-")}checkAndAdd(ci){return!this.entities.includes(ci)&&ci.hasAll(Array.from(this.components))?(this.entities.push(ci),this.entityAdded$.notifyAll(ci),!0):!1}removeEntity(ci){const hi=this.entities.indexOf(ci);hi>-1&&(this.entities.splice(hi,1),this.entityRemoved$.notifyAll(ci))}getEntities(ci){return ci&&this.entities.sort(ci),this.entities}}class TagQuery{constructor(ci){if(this.requiredTags=ci,this.tags=new Set,this.entities=[],this.entityAdded$=new Observable,this.entityRemoved$=new Observable,ci.length===0)throw new Error("Cannot create tag query without tags");for(const hi of ci)this.tags.add(hi);this.id=TagQuery.createId(ci)}static createId(ci){return ci.slice().sort().join("-")}checkAndAdd(ci){return!this.entities.includes(ci)&&ci.hasAllTags(Array.from(this.tags))?(this.entities.push(ci),this.entityAdded$.notifyAll(ci),!0):!1}removeEntity(ci){const hi=this.entities.indexOf(ci);hi>-1&&(this.entities.splice(hi,1),this.entityRemoved$.notifyAll(ci))}getEntities(ci){return ci&&this.entities.sort(ci),this.entities}}class QueryManager{constructor(ci){this._world=ci,this._queries=new Map,this._addComponentHandlers=new Map,this._removeComponentHandlers=new Map,this._componentToQueriesIndex=new Map,this._tagQueries=new Map,this._addTagHandlers=new Map,this._removeTagHandlers=new Map,this._tagToQueriesIndex=new Map,this._createAddComponentHandler=hi=>_i=>{this.addComponent(hi,_i)},this._createRemoveComponentHandler=hi=>_i=>{this.removeComponent(hi,_i)},this._createAddTagHandler=hi=>_i=>{this.addTag(hi,_i)},this._createRemoveTagHandler=hi=>_i=>{this.removeTag(hi,_i)}}createQuery(ci){const hi=Query.createId(ci);if(this._queries.has(hi))return this._queries.get(hi);const _i=new Query(ci);this._queries.set(_i.id,_i);for(const pi of ci){const mi=this._componentToQueriesIndex.get(pi);mi?mi.push(_i):this._componentToQueriesIndex.set(pi,[_i])}for(const pi of this._world.entities)this.addEntity(pi);return _i}createTagQuery(ci){const hi=TagQuery.createId(ci);if(this._tagQueries.has(hi))return this._tagQueries.get(hi);const _i=new TagQuery(ci);this._tagQueries.set(_i.id,_i);for(const pi of ci){const mi=this._tagToQueriesIndex.get(pi);mi?mi.push(_i):this._tagToQueriesIndex.set(pi,[_i])}for(const pi of this._world.entities)this.addEntity(pi);return _i}addEntity(ci){const hi=this._addComponentHandlers.get(ci),_i=this._removeComponentHandlers.get(ci),pi=hi??this._createAddComponentHandler(ci),mi=_i??this._createRemoveComponentHandler(ci);this._addComponentHandlers.set(ci,pi),this._removeComponentHandlers.set(ci,mi);const gi=this._addTagHandlers.get(ci),vi=this._removeTagHandlers.get(ci),xi=gi??this._createAddTagHandler(ci),wi=vi??this._createRemoveTagHandler(ci);this._addTagHandlers.set(ci,xi),this._removeTagHandlers.set(ci,wi);for(const yi of this._queries.values())yi.checkAndAdd(ci);for(const yi of this._tagQueries.values())yi.checkAndAdd(ci);ci.componentAdded$.subscribe(pi),ci.componentRemoved$.subscribe(mi),ci.tagAdded$.subscribe(xi),ci.tagRemoved$.subscribe(wi)}removeEntity(ci){const hi=this._addComponentHandlers.get(ci),_i=this._removeComponentHandlers.get(ci);for(const gi of this._queries.values())gi.removeEntity(ci);hi&&ci.componentAdded$.unsubscribe(hi),_i&&ci.componentRemoved$.unsubscribe(_i);const pi=this._addTagHandlers.get(ci),mi=this._removeTagHandlers.get(ci);for(const gi of this._tagQueries.values())gi.removeEntity(ci);pi&&ci.tagAdded$.unsubscribe(pi),mi&&ci.tagRemoved$.unsubscribe(mi)}addComponent(ci,hi){var _i;const pi=(_i=this._componentToQueriesIndex.get(hi.constructor))!==null&&_i!==void 0?_i:[];for(const mi of pi)mi.checkAndAdd(ci)}removeComponent(ci,hi){var _i;const pi=(_i=this._componentToQueriesIndex.get(hi.constructor))!==null&&_i!==void 0?_i:[];for(const mi of pi)mi.removeEntity(ci)}addTag(ci,hi){var _i;const pi=(_i=this._tagToQueriesIndex.get(hi))!==null&&_i!==void 0?_i:[];for(const mi of pi)mi.checkAndAdd(ci)}removeTag(ci,hi){var _i;const pi=(_i=this._tagToQueriesIndex.get(hi))!==null&&_i!==void 0?_i:[];for(const mi of pi)mi.removeEntity(ci)}}function isSystemConstructor(fi){var ci,hi;return!!(fi!=null&&fi.prototype)&&!!(!((hi=(ci=fi==null?void 0:fi.prototype)===null||ci===void 0?void 0:ci.constructor)===null||hi===void 0)&&hi.name)}class SystemManager{constructor(ci){this._world=ci,this.systems=[],this.initialized=!1}get(ci){return this.systems.find(hi=>hi instanceof ci)}addSystem(ci){let hi;ci instanceof System?hi=ci:hi=new ci(this._world),this.systems.push(hi),this.systems.sort((_i,pi)=>_i.constructor.priority-pi.constructor.priority),this.initialized&&hi.initialize&&hi.initialize(this._world,this._world.scene)}removeSystem(ci){removeItemFromArray(ci,this.systems)}initialize(){if(!this.initialized){this.initialized=!0;for(const ci of this.systems)ci.initialize&&ci.initialize(this._world,this._world.scene)}}updateSystems(ci,hi,_i){const pi=this.systems.filter(mi=>mi.systemType===ci);for(const mi of pi)mi.preupdate&&mi.preupdate(hi,_i);for(const mi of pi)mi.update(_i);for(const mi of pi)mi.postupdate&&mi.postupdate(hi,_i)}clear(){for(let ci=this.systems.length-1;ci>=0;ci--)this.removeSystem(this.systems[ci])}}class World{constructor(ci){this.scene=ci,this._logger=Logger.getInstance(),this.queryManager=new QueryManager(this),this.entityManager=new EntityManager(this),this.systemManager=new SystemManager(this)}query(ci){return this.queryManager.createQuery(ci)}queryTags(ci){return this.queryManager.createTagQuery(ci)}update(ci,hi){ci===SystemType.Update&&this.entityManager.updateEntities(this.scene,hi),this.systemManager.updateSystems(ci,this.scene,hi),this.entityManager.findEntitiesForRemoval(),this.entityManager.processComponentRemovals(),this.entityManager.processEntityRemovals()}add(ci){if(ci instanceof Entity){this.entityManager.addEntity(ci);return}if(ci instanceof System||isSystemConstructor(ci)){this.systemManager.addSystem(ci);return}this._logger.warn(`Could not add entity/system ${ci.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get(ci){return this.systemManager.get(ci)}remove(ci,hi=!0){if(ci instanceof Entity){this.entityManager.removeEntity(ci,hi);return}if(ci instanceof System){this.systemManager.removeSystem(ci);return}this._logger.warn(`Could not remove entity/system ${ci.constructor.name} to Excalibur!

If this looks like an Excalibur type, this can be caused by 2 versions of excalibur being included on the page.

Check your bundler settings to make sure this is not the case! Excalibur has ESM & UMD bundles be sure one 1 is loaded.`)}get entities(){return this.entityManager.entities}clearEntities(){this.entityManager.clear()}clearSystems(){this.systemManager.clear()}}class MotionSystem extends System{constructor(ci,hi){super(),this.world=ci,this.physics=hi,this.systemType=SystemType.Update,this._physicsConfigDirty=!1,hi.$configUpdate.subscribe(()=>this._physicsConfigDirty=!0),this.query=this.world.query([TransformComponent,MotionComponent])}update(ci){let hi,_i;const pi=this.query.entities,mi=this.physics.config.substep;for(let gi=0;gi<pi.length;gi++){hi=pi[gi].get(TransformComponent),_i=pi[gi].get(MotionComponent);const vi=pi[gi].get(BodyComponent);if(this._physicsConfigDirty&&vi&&vi.updatePhysicsConfig(this.physics.config.bodies),vi!=null&&vi.isSleeping)continue;const xi=_i.acc.clone();(vi==null?void 0:vi.collisionType)===CollisionType.Active&&(vi!=null&&vi.useGravity)&&xi.addEqual(this.physics.config.gravity),pi[gi].parent||this.captureOldTransformWithChildren(pi[gi]),EulerIntegrator.integrate(hi,_i,xi,ci/mi)}this._physicsConfigDirty=!1}captureOldTransformWithChildren(ci){var hi;(hi=ci.get(BodyComponent))===null||hi===void 0||hi.captureOldTransform();for(let _i=0;_i<ci.children.length;_i++)this.captureOldTransformWithChildren(ci.children[_i])}}MotionSystem.priority=SystemPriority.Higher;class ArcadeSolver{constructor(ci){this.config=ci,this.directionMap=new Map,this.distanceMap=new Map}solve(ci){this.preSolve(ci),ci=ci.filter(_i=>!_i.isCanceled());let hi;switch(this.config.contactSolveBias){case ContactSolveBias.HorizontalFirst:{hi=HorizontalFirst;break}case ContactSolveBias.VerticalFirst:{hi=VerticalFirst;break}default:hi=None}ci.sort((_i,pi)=>{const mi=this.directionMap.get(_i.id),gi=this.directionMap.get(pi.id),vi=this.distanceMap.get(_i.id),xi=this.distanceMap.get(pi.id);return hi[mi]-hi[gi]||vi-xi});for(const _i of ci)this.solvePosition(_i),this.solveVelocity(_i);return this.postSolve(ci),ci}preSolve(ci){for(let _i=0;_i<ci.length;_i++){const pi=ci[_i];if(Math.abs(pi.mtv.x)<1e-4&&Math.abs(pi.mtv.y)<1e-4){pi.cancel();continue}const mi=Side.fromDirection(pi.mtv),gi=pi.mtv.negate(),vi=Math.abs(pi.info.separation);this.distanceMap.set(pi.id,vi),this.directionMap.set(pi.id,mi===Side.Left||mi===Side.Right?"horizontal":"vertical"),pi.colliderA.events.emit("precollision",new PreCollisionEvent(pi.colliderA,pi.colliderB,mi,gi,pi)),pi.colliderB.events.emit("precollision",new PreCollisionEvent(pi.colliderB,pi.colliderA,Side.getOpposite(mi),gi.negate(),pi))}}postSolve(ci){var hi,_i;for(let pi=0;pi<ci.length;pi++){const mi=ci[pi];if(mi.isCanceled())continue;const gi=mi.colliderA,vi=mi.colliderB,xi=(hi=gi.owner)===null||hi===void 0?void 0:hi.get(BodyComponent),wi=(_i=vi.owner)===null||_i===void 0?void 0:_i.get(BodyComponent);if(xi&&wi&&(xi.collisionType===CollisionType.Passive||wi.collisionType===CollisionType.Passive))continue;const yi=Side.fromDirection(mi.mtv),Ci=mi.mtv.negate();mi.colliderA.events.emit("postcollision",new PostCollisionEvent(mi.colliderA,mi.colliderB,yi,Ci,mi)),mi.colliderB.events.emit("postcollision",new PostCollisionEvent(mi.colliderB,mi.colliderA,Side.getOpposite(yi),Ci.negate(),mi))}}solvePosition(ci){var hi,_i;if(!ci.colliderA.bounds.overlaps(ci.colliderB.bounds,1e-4)){ci.cancel();return}if(Math.abs(ci.mtv.x)<1e-4&&Math.abs(ci.mtv.y)<1e-4){ci.cancel();return}let mi=ci.mtv;const gi=ci.colliderA,vi=ci.colliderB,xi=(hi=gi.owner)===null||hi===void 0?void 0:hi.get(BodyComponent),wi=(_i=vi.owner)===null||_i===void 0?void 0:_i.get(BodyComponent);if(xi&&wi){if(xi.collisionType===CollisionType.Passive||wi.collisionType===CollisionType.Passive)return;xi.collisionType===CollisionType.Active&&wi.collisionType===CollisionType.Active&&(mi=mi.scale(.5)),xi.collisionType===CollisionType.Active&&(xi.globalPos.x-=mi.x,xi.globalPos.y-=mi.y,gi.update(xi.transform.get())),wi.collisionType===CollisionType.Active&&(wi.globalPos.x+=mi.x,wi.globalPos.y+=mi.y,vi.update(wi.transform.get()))}}solveVelocity(ci){var hi,_i;if(ci.isCanceled())return;const pi=ci.colliderA,mi=ci.colliderB,gi=(hi=pi.owner)===null||hi===void 0?void 0:hi.get(BodyComponent),vi=(_i=mi.owner)===null||_i===void 0?void 0:_i.get(BodyComponent);if(gi&&vi){if(gi.collisionType===CollisionType.Passive||vi.collisionType===CollisionType.Passive)return;const xi=ci.normal,wi=xi.negate();if(gi.collisionType===CollisionType.Active&&gi.vel.normalize().dot(wi)<0){const yi=xi.scale(xi.dot(gi.vel.negate()));gi.vel=gi.vel.add(yi)}if(vi.collisionType===CollisionType.Active&&vi.vel.normalize().dot(xi)<0){const yi=wi.scale(wi.dot(vi.vel.negate()));vi.vel=vi.vel.add(yi)}}}}class ContactConstraintPoint{constructor(ci,hi,_i){this.point=ci,this.local=hi,this.contact=_i,this.normalImpulse=0,this.tangentImpulse=0,this.normalMass=0,this.tangentMass=0,this.aToContact=new Vector(0,0),this.bToContact=new Vector(0,0),this.originalVelocityAndRestitution=0,this.update()}update(){const ci=this.contact.bodyA,hi=this.contact.colliderA,_i=this.contact.bodyB,pi=this.contact.colliderB;if(ci&&_i){const mi=this.contact.normal,gi=this.contact.tangent;this.aToContact=this.point.sub(hi.center),this.bToContact=this.point.sub(pi.center);const vi=this.aToContact.cross(mi),xi=this.bToContact.cross(mi);this.normalMass=ci.inverseMass+_i.inverseMass+ci.inverseInertia*vi*vi+_i.inverseInertia*xi*xi;const wi=this.aToContact.cross(gi),yi=this.bToContact.cross(gi);this.tangentMass=ci.inverseMass+_i.inverseMass+ci.inverseInertia*wi*wi+_i.inverseInertia*yi*yi}return this}getRelativeVelocity(){const ci=this.contact.bodyA,hi=this.contact.bodyB;if(ci&&hi){const _i=ci.vel.add(Vector.cross(ci.angularVelocity,this.aToContact));return hi.vel.add(Vector.cross(hi.angularVelocity,this.bToContact)).sub(_i)}return Vector.Zero}}class RealisticSolver{constructor(ci){this.config=ci,this.directionMap=new Map,this.distanceMap=new Map,this.lastFrameContacts=new Map,this.idToContactConstraint=new Map}getContactConstraints(ci){var hi;return(hi=this.idToContactConstraint.get(ci))!==null&&hi!==void 0?hi:[]}solve(ci){this.preSolve(ci),ci=ci.filter(_i=>!_i.isCanceled());let hi;switch(this.config.contactSolveBias){case ContactSolveBias.HorizontalFirst:{hi=HorizontalFirst;break}case ContactSolveBias.VerticalFirst:{hi=VerticalFirst;break}default:hi=None}return ci.sort((_i,pi)=>{const mi=this.directionMap.get(_i.id),gi=this.directionMap.get(pi.id),vi=this.distanceMap.get(_i.id),xi=this.distanceMap.get(pi.id);return hi[mi]-hi[gi]||vi-xi}),this.solveVelocity(ci),this.solvePosition(ci),this.postSolve(ci),ci}preSolve(ci){var hi,_i,pi,mi;for(let xi=0;xi<ci.length;xi++){const wi=ci[xi];if(Math.abs(wi.mtv.x)<1e-4&&Math.abs(wi.mtv.y)<1e-4){wi.cancel();continue}const yi=Side.fromDirection(wi.mtv),Ci=Math.abs(((hi=wi==null?void 0:wi.info)===null||hi===void 0?void 0:hi.separation)||0);this.distanceMap.set(wi.id,Ci),this.directionMap.set(wi.id,yi===Side.Left||yi===Side.Right?"horizontal":"vertical"),wi.colliderA.events.emit("precollision",new PreCollisionEvent(wi.colliderA,wi.colliderB,yi,wi.mtv,wi)),wi.colliderA.events.emit("beforecollisionresolve",new CollisionPreSolveEvent(wi.colliderA,wi.colliderB,yi,wi.mtv,wi)),wi.colliderB.events.emit("precollision",new PreCollisionEvent(wi.colliderB,wi.colliderA,Side.getOpposite(yi),wi.mtv.negate(),wi)),wi.colliderB.events.emit("beforecollisionresolve",new CollisionPreSolveEvent(wi.colliderB,wi.colliderA,Side.getOpposite(yi),wi.mtv.negate(),wi)),wi.matchAwake()}const vi=Array.from(this.idToContactConstraint.keys());for(let xi=0;xi<ci.length;xi++){const wi=ci[xi],yi=vi.indexOf(wi.id);yi>-1&&vi.splice(yi,1);const Ci=(_i=this.idToContactConstraint.get(wi.id))!==null&&_i!==void 0?_i:[];let Ei=0;const Si=wi.bodyA,ki=wi.colliderA,Ai=wi.bodyB,Ii=wi.colliderB;if(Si&&Ai)for(let Ti=0;Ti<wi.points.length;Ti++){const Pi=wi.points[Ti],Li=wi.normal,Ri=wi.tangent,Di=Pi.sub(ki.center),Fi=Pi.sub(Ii.center),Mi=Di.cross(Li),$i=Fi.cross(Li),Oi=Si.inverseMass+Ai.inverseMass+Si.inverseInertia*Mi*Mi+Ai.inverseInertia*$i*$i,Gi=Di.cross(Ri),Ui=Fi.cross(Ri),zi=Si.inverseMass+Ai.inverseMass+Si.inverseInertia*Gi*Gi+Ai.inverseInertia*Ui*Ui;Ci[Ei]&&((mi=(pi=Ci[Ei])===null||pi===void 0?void 0:pi.point)===null||mi===void 0?void 0:mi.squareDistance(Pi))<4?(Ci[Ei].point=Pi,Ci[Ei].local=wi.localPoints[Ei]):Ci[Ei]=new ContactConstraintPoint(Pi,wi.localPoints[Ei],wi),Ci[Ei].aToContact=Di,Ci[Ei].bToContact=Fi,Ci[Ei].normalMass=1/Oi,Ci[Ei].tangentMass=1/zi;const Wi=Si.bounciness>Ai.bounciness?Si.bounciness:Ai.bounciness,Ni=wi.normal.dot(Ci[Ei].getRelativeVelocity());Ci[Ei].originalVelocityAndRestitution=0,Ni<-.1&&(Ci[Ei].originalVelocityAndRestitution=-Wi*Ni),Ei++}this.idToContactConstraint.set(wi.id,Ci)}for(const xi of vi)this.idToContactConstraint.delete(xi);if(this.config.warmStart)this.warmStart(ci);else for(let xi=0;xi<ci.length;xi++){const wi=ci[xi],yi=this.getContactConstraints(wi.id);for(const Ci of yi)Ci.normalImpulse=0,Ci.tangentImpulse=0}}postSolve(ci){for(let hi=0;hi<ci.length;hi++){const _i=ci[hi],pi=_i.bodyA,mi=_i.bodyB;if(pi&&mi){if(pi.collisionType===CollisionType.Passive||mi.collisionType===CollisionType.Passive)continue;pi.updateMotion(),mi.updateMotion()}const gi=Side.fromDirection(_i.mtv);_i.colliderA.events.emit("postcollision",new PostCollisionEvent(_i.colliderA,_i.colliderB,gi,_i.mtv,_i)),_i.colliderA.events.emit("aftercollisionresolve",new CollisionPostSolveEvent(_i.colliderA,_i.colliderB,gi,_i.mtv,_i)),_i.colliderB.events.emit("postcollision",new PostCollisionEvent(_i.colliderB,_i.colliderA,Side.getOpposite(gi),_i.mtv.negate(),_i)),_i.colliderB.events.emit("aftercollisionresolve",new CollisionPostSolveEvent(_i.colliderB,_i.colliderA,Side.getOpposite(gi),_i.mtv.negate(),_i))}this.lastFrameContacts.clear();for(let hi=0;hi<ci.length;hi++){const _i=ci[hi];this.lastFrameContacts.set(_i.id,_i)}}warmStart(ci){var hi;for(let _i=0;_i<ci.length;_i++){const pi=ci[_i],mi=pi.bodyA,gi=pi.bodyB;if(mi&&gi){const vi=(hi=this.idToContactConstraint.get(pi.id))!==null&&hi!==void 0?hi:[];for(const xi of vi)if(this.config.warmStart){const wi=pi.normal.scale(xi.normalImpulse),yi=pi.tangent.scale(xi.tangentImpulse),Ci=wi.add(yi);mi.applyImpulse(xi.point,Ci.negate()),gi.applyImpulse(xi.point,Ci)}else xi.normalImpulse=0,xi.tangentImpulse=0}}}solvePosition(ci){var hi;for(let _i=0;_i<this.config.positionIterations;_i++)for(let pi=0;pi<ci.length;pi++){const mi=ci[pi],gi=mi.bodyA,vi=mi.bodyB;if(gi&&vi){if(gi.collisionType===CollisionType.Passive||vi.collisionType===CollisionType.Passive)continue;const xi=(hi=this.idToContactConstraint.get(mi.id))!==null&&hi!==void 0?hi:[];for(const wi of xi){const yi=mi.normal,Ci=CollisionJumpTable.FindContactSeparation(mi,wi.local),Ei=this.config.steeringFactor,Si=-5,ki=this.config.slop,Ai=clamp(Ei*(Ci+ki),Si,0),Ii=yi.scale(-Ai*wi.normalMass);if(gi.collisionType===CollisionType.Active){const Ti=Ii.negate().scale(gi.inverseMass);gi.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)&&(Ti.x=0),gi.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)&&(Ti.y=0),gi.globalPos=gi.globalPos.add(Ti),gi.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)||(gi.rotation-=wi.aToContact.cross(Ii)*gi.inverseInertia)}if(vi.collisionType===CollisionType.Active){const Ti=Ii.scale(vi.inverseMass);vi.limitDegreeOfFreedom.includes(DegreeOfFreedom.X)&&(Ti.x=0),vi.limitDegreeOfFreedom.includes(DegreeOfFreedom.Y)&&(Ti.y=0),vi.globalPos=vi.globalPos.add(Ti),vi.limitDegreeOfFreedom.includes(DegreeOfFreedom.Rotation)||(vi.rotation+=wi.bToContact.cross(Ii)*vi.inverseInertia)}}}}}solveVelocity(ci){var hi;for(let _i=0;_i<this.config.velocityIterations;_i++)for(let pi=0;pi<ci.length;pi++){const mi=ci[pi],gi=mi.bodyA,vi=mi.bodyB;if(gi&&vi){if(gi.collisionType===CollisionType.Passive||vi.collisionType===CollisionType.Passive)continue;const xi=Math.min(gi.friction,vi.friction),wi=(hi=this.idToContactConstraint.get(mi.id))!==null&&hi!==void 0?hi:[];for(const yi of wi){let Si=-yi.getRelativeVelocity().dot(mi.tangent)*yi.tangentMass;const ki=xi*yi.normalImpulse,Ai=clamp(yi.tangentImpulse+Si,-ki,ki);Si=Ai-yi.tangentImpulse,yi.tangentImpulse=Ai;const Ii=mi.tangent.scale(Si);gi.applyImpulse(yi.point,Ii.negate()),vi.applyImpulse(yi.point,Ii)}for(const yi of wi){const Ei=yi.getRelativeVelocity().dot(mi.normal);let Si=-yi.normalMass*(Ei-yi.originalVelocityAndRestitution);const ki=Math.max(yi.normalImpulse+Si,0);Si=ki-yi.normalImpulse,yi.normalImpulse=ki;const Ai=mi.normal.scale(Si);gi.applyImpulse(yi.point,Ai.negate()),vi.applyImpulse(yi.point,Ai)}}}}}class CollisionSystem extends System{get _processor(){return this._physics.collisionProcessor}constructor(ci,hi){super(),this._physics=hi,this.systemType=SystemType.Update,this._configDirty=!1,this._lastFrameContacts=new Map,this._currentFrameContacts=new Map,this._arcadeSolver=new ArcadeSolver(hi.config.arcade),this._realisticSolver=new RealisticSolver(hi.config.realistic),this._physics.$configUpdate.subscribe(()=>this._configDirty=!0),this._trackCollider=_i=>this._processor.track(_i),this._untrackCollider=_i=>this._processor.untrack(_i),this.query=ci.query([TransformComponent,MotionComponent,ColliderComponent]),this.query.entityAdded$.subscribe(_i=>{const pi=_i.get(ColliderComponent);pi.$colliderAdded.subscribe(this._trackCollider),pi.$colliderRemoved.subscribe(this._untrackCollider);const mi=pi.get();mi&&this._processor.track(mi)}),this.query.entityRemoved$.subscribe(_i=>{const pi=_i.get(ColliderComponent),mi=pi.get();pi&&mi&&this._processor.untrack(mi)}),this._motionSystem=ci.get(MotionSystem)}initialize(ci,hi){this._engine=hi.engine}update(ci){var hi,_i,pi,mi;if(!this._physics.config.enabled)return;let gi=[];for(let Ci=0;Ci<this.query.entities.length;Ci++){const Si=this.query.entities[Ci].get(ColliderComponent),ki=Si==null?void 0:Si.get();if(Si&&(!((hi=Si.owner)===null||hi===void 0)&&hi.isActive)&&ki)if(Si.update(),ki instanceof CompositeCollider){const Ai=ki.getColliders();ki.compositeStrategy||(ki.compositeStrategy=this._physics.config.colliders.compositeStrategy),gi=gi.concat(Ai)}else gi.push(ki)}this._processor.update(gi,ci);let vi=this._processor.broadphase(gi,ci);this._currentFrameContacts.clear();let xi=[];const wi=this.getSolver(),yi=this._physics.config.substep;for(let Ci=0;Ci<yi;Ci++)if(Ci>0&&this._motionSystem.update(ci),xi.length&&(vi=xi.map(Ei=>new Pair(Ei.colliderA,Ei.colliderB))),vi.length){xi=this._processor.narrowphase(vi,(mi=(pi=(_i=this._engine)===null||_i===void 0?void 0:_i.debug)===null||pi===void 0?void 0:pi.stats)===null||mi===void 0?void 0:mi.currFrame),xi=wi.solve(xi);for(const Ei of xi){if(Ei.isCanceled())continue;const Si=Ei.id.indexOf("|");if(Si>0){const ki=Ei.id.substring(Si+1);this._currentFrameContacts.set(ki,Ei)}else this._currentFrameContacts.set(Ei.id,Ei)}}this.runContactStartEnd(),this._lastFrameContacts.clear(),this._lastFrameContacts=new Map(this._currentFrameContacts);for(const Ci of this.query.entities){const Ei=Ci.get(ColliderComponent);Ei&&Ei.processColliderRemoval()}}postupdate(){SeparatingAxis.SeparationPool.done()}getSolver(){return this._configDirty&&(this._configDirty=!1,this._arcadeSolver=new ArcadeSolver(this._physics.config.arcade),this._realisticSolver=new RealisticSolver(this._physics.config.realistic)),this._physics.config.solver===SolverStrategy.Realistic?this._realisticSolver:this._arcadeSolver}debug(ci){this._processor.debug(ci,0)}runContactStartEnd(){for(const[ci,hi]of this._currentFrameContacts)if(!this._lastFrameContacts.has(ci)){const _i=hi.colliderA,pi=hi.colliderB,mi=Side.fromDirection(hi.mtv),gi=Side.getOpposite(mi);_i.events.emit("collisionstart",new CollisionStartEvent(_i,pi,mi,hi)),_i.events.emit("contactstart",new ContactStartEvent(_i,pi,mi,hi)),pi.events.emit("collisionstart",new CollisionStartEvent(pi,_i,gi,hi)),pi.events.emit("contactstart",new ContactStartEvent(pi,_i,gi,hi))}for(const[ci,hi]of this._lastFrameContacts)if(!this._currentFrameContacts.has(ci)){const _i=hi.colliderA,pi=hi.colliderB,mi=Side.fromDirection(hi.mtv),gi=Side.getOpposite(mi);_i.events.emit("collisionend",new CollisionEndEvent(_i,pi,mi,hi)),_i.events.emit("contactend",new ContactEndEvent(_i,pi,mi,hi)),pi.events.emit("collisionend",new CollisionEndEvent(pi,_i,gi,hi)),pi.events.emit("contactend",new ContactEndEvent(pi,_i,gi,hi))}}}CollisionSystem.priority=SystemPriority.Higher;function blendTransform(fi,ci,hi,_i){if(fi.parent!==ci.parent){const yi=fi.clone(),Ci=fi.globalPos.clone(),Ei=fi.globalScale.clone(),Si=fi.globalRotation;yi.parent=ci.parent,yi.globalPos=Ci,yi.globalScale=Ei,yi.globalRotation=Si,fi=yi}let pi=ci.pos,mi=ci.scale,gi=ci.rotation;pi=ci.pos.scale(hi).add(fi.pos.scale(1-hi)),mi=ci.scale.scale(hi).add(fi.scale.scale(1-hi));const vi=(1-hi)*Math.cos(fi.rotation)+hi*Math.cos(ci.rotation),xi=(1-hi)*Math.sin(fi.rotation)+hi*Math.sin(ci.rotation);gi=Math.atan2(xi,vi);const wi=_i??new transform_Transform;return wi.setTransform(pi,gi,mi),wi}class GraphicsSystem extends System{get sortedTransforms(){return this._sortedTransforms}constructor(ci){super(),this.world=ci,this.systemType=SystemType.Draw,this._token=0,this._sortedTransforms=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this._targetInterpolationTransform=new transform_Transform,this.query=this.world.query([TransformComponent,GraphicsComponent]),this.query.entityAdded$.subscribe(hi=>{const _i=hi.get(TransformComponent);this._sortedTransforms.push(_i),_i.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(hi=>{const _i=hi.get(TransformComponent);_i.zIndexChanged$.unsubscribe(this._zIndexUpdate);const pi=this._sortedTransforms.indexOf(_i);pi>-1&&this._sortedTransforms.splice(pi,1)})}initialize(ci,hi){this._camera=hi.camera,this._engine=hi.engine}preupdate(){this._graphicsContext=this._engine.graphicsContext,this._zHasChanged&&(this._sortedTransforms.sort((ci,hi)=>ci.globalZ-hi.globalZ),this._zHasChanged=!1)}update(ci){this._token++;let hi;FontCache.checkAndClearCache(),this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext);for(let _i=0;_i<this._sortedTransforms.length;_i++){const pi=this._sortedTransforms[_i],mi=pi.owner;if(mi.hasTag("ex.offscreen")||(hi=mi.get(GraphicsComponent),!hi.isVisible))continue;hi.onPreTransformDraw&&hi.onPreTransformDraw(this._graphicsContext,ci),mi.events.emit("pretransformdraw",new PreTransformDrawEvent(this._graphicsContext,ci,mi)),pi.coordPlane===CoordPlane.Screen&&this._graphicsContext.restore(),this._graphicsContext.save(),pi.coordPlane===CoordPlane.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),hi.update(ci,this._token);const gi=mi.get(ParallaxComponent);if(gi){const vi=Vector.One.sub(gi.parallaxFactor),xi=this._camera.drawPos.scale(vi);this._graphicsContext.translate(xi.x,xi.y)}this._applyTransform(mi),hi.material&&(this._graphicsContext.material=hi.material),hi.onPreDraw&&hi.onPreDraw(this._graphicsContext,ci),mi.events.emit("predraw",new PreDrawEvent(this._graphicsContext,ci,mi)),this._applyOpacity(mi),this._drawGraphicsComponent(hi,pi),hi.onPostDraw&&hi.onPostDraw(this._graphicsContext,ci),mi.events.emit("postdraw",new PostDrawEvent(this._graphicsContext,ci,mi)),this._graphicsContext.restore(),pi.coordPlane===CoordPlane.Screen&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext)),hi.onPostTransformDraw&&hi.onPostTransformDraw(this._graphicsContext,ci),mi.events.emit("posttransformdraw",new PostTransformDrawEvent(this._graphicsContext,ci,mi))}this._graphicsContext.restore()}_drawGraphicsComponent(ci,hi){var _i,pi;if(ci.isVisible){const mi=ci.flipHorizontal,gi=ci.flipVertical,vi=ci.current,xi=(_i=ci.currentOptions)!==null&&_i!==void 0?_i:{};if(vi){let wi=ci.anchor,yi=ci.offset,Ci=1,Ei=1;xi!=null&&xi.anchor&&(wi=xi.anchor),xi!=null&&xi.offset&&(yi=xi.offset);const Si=hi.globalScale;Ci*=vi.scale.x*Si.x,Ei*=vi.scale.y*Si.y;const ki=-vi.width*wi.x+yi.x*Ci,Ai=-vi.height*wi.y+yi.y*Ei,Ii=vi.flipHorizontal,Ti=vi.flipVertical;if((mi||gi)&&(vi.flipHorizontal=mi?!Ii:Ii,vi.flipVertical=gi?!Ti:Ti),vi==null||vi.draw(this._graphicsContext,ki,Ai),(mi||gi)&&(vi.flipHorizontal=Ii,vi.flipVertical=Ti),!((pi=this._engine)===null||pi===void 0)&&pi.isDebug&&this._engine.debug.graphics.showBounds){const Pi=vec(ki,Ai);if(vi instanceof GraphicsGroup)for(const Li of vi.members){let Ri,Di=Vector.Zero;Li instanceof Graphic?Ri=Li:(Ri=Li.graphic,Di=Li.offset),vi.useAnchor?Ri==null||Ri.localBounds.translate(Pi.add(Di)).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor):Ri==null||Ri.localBounds.translate(Di).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}else vi==null||vi.localBounds.translate(Pi).draw(this._graphicsContext,this._engine.debug.graphics.boundsColor)}}}}_applyTransform(ci){const hi=ci.getAncestors();for(let _i=0;_i<hi.length;_i++){const pi=hi[_i],mi=pi==null?void 0:pi.get(TransformComponent),gi=pi==null?void 0:pi.get(BodyComponent);if(mi){let vi=mi.get();if(gi&&this._engine.fixedUpdateTimestep&&gi.__oldTransformCaptured&&gi.enableFixedUpdateInterpolate){const xi=this._engine.currentFrameLagMs/this._engine.fixedUpdateTimestep;vi=blendTransform(gi.oldTransform,mi.get(),xi,this._targetInterpolationTransform)}this._graphicsContext.z=mi.globalZ,this._graphicsContext.translate(vi.pos.x,vi.pos.y),this._graphicsContext.scale(vi.scale.x,vi.scale.y),this._graphicsContext.rotate(vi.rotation)}}}_applyOpacity(ci){var hi;const _i=ci.getAncestors();for(let pi=0;pi<_i.length;pi++){const mi=_i[pi],gi=mi==null?void 0:mi.get(GraphicsComponent);this._graphicsContext.opacity*=(hi=gi==null?void 0:gi.opacity)!==null&&hi!==void 0?hi:1}}}GraphicsSystem.priority=SystemPriority.Average;class DebugSystem extends System{constructor(ci){super(),this.world=ci,this.systemType=SystemType.Draw,this.query=this.world.query([TransformComponent])}initialize(ci,hi){this._graphicsContext=hi.engine.graphicsContext,this._camera=hi.camera,this._engine=hi.engine,this._collisionSystem=ci.systemManager.get(CollisionSystem)}update(){var ci;if(!this._engine.isDebug)return;const hi=this._engine.debug.filter;let _i,pi;const mi=this._engine.debug.entity;let gi;const vi=this._engine.debug.transform;let xi;const wi=this._engine.debug.motion;let yi;const Ci=this._engine.debug.collider,Ei=this._engine.debug.physics;let Si;const ki=this._engine.debug.graphics;let Ai,Ii;const Ti=this._engine.debug.body,Pi=this._engine.debug.camera;for(let Li=0;Li<this.query.entities.length;Li++){const Ri=this.query.entities[Li];if(Ri.hasTag("offscreen")||Ri instanceof Particle||hi.useFilter&&(!(hi.ids.length===0||hi.ids.includes(Ri.id))||!(hi.nameQuery===""||Ri.name.includes(hi.nameQuery))))continue;let Di=Vector.Zero;const Fi=vec(0,16);if(_i=Ri.id,pi=Ri.name,gi=Ri.get(TransformComponent),this._pushCameraTransform(gi),this._graphicsContext.save(),gi.coordPlane===CoordPlane.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=vi.debugZIndex,this._applyTransform(Ri),gi&&((vi.showAll||vi.showPosition)&&this._graphicsContext.debug.drawPoint(Vector.Zero,{size:4,color:vi.positionColor}),(vi.showAll||vi.showPositionLabel)&&(this._graphicsContext.debug.drawText(`pos${gi.pos.toString(2)}`,Di),Di=Di.add(Fi)),(vi.showAll||vi.showZIndex)&&(this._graphicsContext.debug.drawText(`z(${gi.z.toFixed(1)})`,Di),Di=Di.add(Fi)),(mi.showAll||mi.showId)&&(this._graphicsContext.debug.drawText(`id(${_i}) ${Ri.parent?"child of id("+((ci=Ri.parent)===null||ci===void 0?void 0:ci.id)+")":""}`,Di),Di=Di.add(Fi)),(mi.showAll||mi.showName)&&(this._graphicsContext.debug.drawText(`name(${pi})`,Di),Di=Di.add(Fi)),(vi.showAll||vi.showRotation)&&(this._graphicsContext.drawLine(Vector.Zero,Vector.fromAngle(gi.rotation).scale(50).add(Vector.Zero),vi.rotationColor,2),this._graphicsContext.debug.drawText(`rot deg(${toDegrees(gi.rotation).toFixed(2)})`,Di),Di=Di.add(Fi)),(vi.showAll||vi.showScale)&&this._graphicsContext.drawLine(Vector.Zero,gi.scale.add(Vector.Zero),vi.scaleColor,2)),Si=Ri.get(GraphicsComponent),Si&&(ki.showAll||ki.showBounds)&&Si.localBounds.draw(this._graphicsContext,ki.boundsColor),Ai=Ri.get(DebugGraphicsComponent),Ai&&(Ai.useTransform||this._graphicsContext.restore(),Ai.draw(this._graphicsContext,this._engine.debug),Ai.useTransform||(this._graphicsContext.save(),this._applyTransform(Ri))),Ii=Ri.get(BodyComponent),Ii&&((Ti.showAll||Ti.showCollisionGroup)&&(this._graphicsContext.debug.drawText(`collision group(${Ii.group.name})`,Di),Di=Di.add(Fi)),(Ti.showAll||Ti.showCollisionType)&&(this._graphicsContext.debug.drawText(`collision type(${Ii.collisionType})`,Di),Di=Di.add(Fi)),(Ti.showAll||Ti.showMass)&&(this._graphicsContext.debug.drawText(`mass(${Ii.mass})`,Di),Di=Di.add(Fi)),(Ti.showAll||Ti.showMotion)&&(this._graphicsContext.debug.drawText(`motion(${Ii.sleepMotion})`,Di),Di=Di.add(Fi)),(Ti.showAll||Ti.showSleeping)&&(this._graphicsContext.debug.drawText(`sleeping(${Ii.canSleep?Ii.isSleeping:"cant sleep"})`,Di),Di=Di.add(Fi))),this._graphicsContext.restore(),this._graphicsContext.save(),gi.coordPlane===CoordPlane.Screen&&this._graphicsContext.translate(this._engine.screen.contentArea.left,this._engine.screen.contentArea.top),this._graphicsContext.z=vi.debugZIndex,xi=Ri.get(MotionComponent),xi&&((wi.showAll||wi.showVelocity)&&(this._graphicsContext.debug.drawText(`vel${xi.vel.toString(2)}`,Di.add(gi.globalPos)),this._graphicsContext.drawLine(gi.globalPos,gi.globalPos.add(xi.vel),wi.velocityColor,2),Di=Di.add(Fi)),(wi.showAll||wi.showAcceleration)&&this._graphicsContext.drawLine(gi.globalPos,gi.globalPos.add(xi.acc),wi.accelerationColor,2)),yi=Ri.get(ColliderComponent),yi){const Mi=yi.get();if((Ci.showAll||Ci.showGeometry)&&Mi&&Mi.debug(this._graphicsContext,Ci.geometryColor,{lineWidth:Ci.geometryLineWidth,pointSize:Ci.geometryPointSize}),Ci.showAll||Ci.showBounds){if(Mi instanceof CompositeCollider){const $i=Mi.getColliders();for(const Oi of $i){const Gi=Oi.bounds,Ui=vec(Gi.left,Gi.top);this._graphicsContext.debug.drawRect(Ui.x,Ui.y,Gi.width,Gi.height,{color:Ci.boundsColor}),(Ci.showAll||Ci.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${Oi.owner.id})`,Ui)}yi.bounds.draw(this._graphicsContext,Ci.boundsColor)}else if(Mi){const $i=yi.bounds,Oi=vec($i.left,$i.top);this._graphicsContext.debug.drawRect(Oi.x,Oi.y,$i.width,$i.height,{color:Ci.boundsColor}),(Ci.showAll||Ci.showOwner)&&this._graphicsContext.debug.drawText(`owner id(${yi.owner.id})`,Oi)}}}this._graphicsContext.restore(),this._popCameraTransform(gi)}if(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(Ei.showAll||Ei.showBroadphaseSpacePartitionDebug)&&this._collisionSystem.debug(this._graphicsContext),Ei.showAll||Ei.showCollisionContacts||Ei.showCollisionNormals)for(const[Li,Ri]of this._engine.debug.stats.currFrame.physics.contacts){if(Ei.showAll||Ei.showCollisionContacts)for(const Di of Ri.points)this._graphicsContext.debug.drawPoint(Di,{size:Ei.contactSize,color:Ei.collisionContactColor});if(Ei.showAll||Ei.showCollisionNormals)for(const Di of Ri.points)this._graphicsContext.debug.drawLine(Di,Ri.normal.scale(30).add(Di),{color:Ei.collisionNormalColor})}this._graphicsContext.restore(),Pi&&(this._graphicsContext.save(),this._camera.draw(this._graphicsContext),(Pi.showAll||Pi.showFocus)&&this._graphicsContext.drawCircle(this._camera.pos,4,Pi.focusColor),(Pi.showAll||Pi.showZoom)&&this._graphicsContext.debug.drawText(`zoom(${this._camera.zoom})`,this._camera.pos),this._graphicsContext.restore()),this._graphicsContext.flush()}postupdate(ci,hi){this._engine.isDebug&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext),Debug.flush(this._graphicsContext),this._graphicsContext.restore())}_applyTransform(ci){const hi=ci.getAncestors();for(const _i of hi){const pi=_i==null?void 0:_i.get(TransformComponent);pi&&(this._graphicsContext.translate(pi.pos.x,pi.pos.y),this._graphicsContext.scale(pi.scale.x,pi.scale.y),this._graphicsContext.rotate(pi.rotation))}}_pushCameraTransform(ci){ci.coordPlane===CoordPlane.World&&(this._graphicsContext.save(),this._camera&&this._camera.draw(this._graphicsContext))}_popCameraTransform(ci){ci.coordPlane===CoordPlane.World&&this._graphicsContext.restore()}}DebugSystem.priority=SystemPriority.Lowest;class HashGridProxy{constructor(ci,hi){this.object=ci,this.id=-1,this.cells=[],this.hasZeroBounds=!1,this.gridSize=hi,this.bounds=ci.bounds,this.hasZeroBounds=this.bounds.hasZeroDimensions(),this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize)}hasChanged(){const ci=this.object.bounds,hi=Math.floor(ci.left/this.gridSize),_i=Math.floor(ci.right/this.gridSize),pi=Math.floor(ci.bottom/this.gridSize),mi=Math.floor(ci.top/this.gridSize);return this.leftX!==hi||this.rightX!==_i||this.bottomY!==pi||this.topY!==mi}clear(){for(const ci of this.cells){const hi=ci.proxies.indexOf(this);hi>-1&&ci.proxies.splice(hi,1)}}updateBounds(){this.bounds=this.object.bounds}update(){this.bounds=this.object.bounds,this.leftX=Math.floor(this.bounds.left/this.gridSize),this.rightX=Math.floor(this.bounds.right/this.gridSize),this.bottomY=Math.floor(this.bounds.bottom/this.gridSize),this.topY=Math.floor(this.bounds.top/this.gridSize),this.hasZeroBounds=this.object.bounds.hasZeroDimensions()}}class HashGridCell{constructor(){this.proxies=[]}configure(ci,hi){this.x=ci,this.y=hi,this.key=HashGridCell.calculateHashKey(ci,hi)}static calculateHashKey(ci,hi){return`${ci}+${hi}`}}class SparseHashGrid{constructor(ci){this.bounds=new BoundingBox,this._hashGridCellPool=new RentalPool(()=>new HashGridCell,hi=>(hi.configure(0,0),hi.proxies.length=0,hi),1e3),this.gridSize=ci.size,this.sparseHashGrid=new Map,this.objectToProxy=new Map,ci.proxyFactory?this._buildProxy=hi=>ci.proxyFactory(hi,this.gridSize):this._buildProxy=hi=>new HashGridProxy(hi,this.gridSize)}query(ci){const hi=new Set;if(ci instanceof BoundingBox){const _i=ci,pi=Math.floor(_i.left/this.gridSize),mi=Math.floor(_i.right/this.gridSize),gi=Math.floor(_i.bottom/this.gridSize),vi=Math.floor(_i.top/this.gridSize);for(let xi=pi;xi<=mi;xi++)for(let wi=vi;wi<=gi;wi++){const yi=HashGridCell.calculateHashKey(xi,wi),Ci=this.sparseHashGrid.get(yi);if(Ci)for(let Ei=0;Ei<Ci.proxies.length;Ei++)Ci.proxies[Ei].updateBounds(),Ci.proxies[Ei].bounds.intersect(_i)&&hi.add(Ci.proxies[Ei].object)}}else{const _i=ci,pi=HashGridCell.calculateHashKey(Math.floor(_i.x/this.gridSize),Math.floor(_i.y/this.gridSize)),mi=this.sparseHashGrid.get(pi);if(mi)for(let gi=0;gi<mi.proxies.length;gi++)mi.proxies[gi].updateBounds(),mi.proxies[gi].bounds.contains(_i)&&hi.add(mi.proxies[gi].object)}return Array.from(hi)}get(ci,hi){const _i=HashGridCell.calculateHashKey(ci,hi);return this.sparseHashGrid.get(_i)}_insert(ci,hi,_i){const pi=HashGridCell.calculateHashKey(ci,hi);let mi=this.sparseHashGrid.get(pi);mi||(mi=this._hashGridCellPool.rent(),mi.configure(ci,hi),this.sparseHashGrid.set(mi.key,mi)),mi.proxies.push(_i),_i.cells.push(mi),this.bounds.combine(_i.bounds,this.bounds)}_remove(ci,hi,_i){const pi=HashGridCell.calculateHashKey(ci,hi),mi=this.sparseHashGrid.get(pi);if(mi){const gi=mi.proxies.indexOf(_i);gi>-1&&mi.proxies.splice(gi,1);const vi=_i.cells.indexOf(mi);vi>-1&&_i.cells.splice(vi,1),mi.proxies.length===0&&(this._hashGridCellPool.return(mi),this.sparseHashGrid.delete(pi))}}track(ci){const hi=this._buildProxy(ci);this.objectToProxy.set(ci,hi);for(let _i=hi.leftX;_i<=hi.rightX;_i++)for(let pi=hi.topY;pi<=hi.bottomY;pi++)this._insert(_i,pi,hi)}untrack(ci){const hi=this.objectToProxy.get(ci);hi&&(hi.clear(),this.objectToProxy.delete(ci))}update(ci){let hi=0;for(const _i of ci){const pi=this.objectToProxy.get(_i);if(pi&&pi.hasChanged()){for(let mi=pi.leftX;mi<=pi.rightX;mi++)for(let gi=pi.topY;gi<=pi.bottomY;gi++)this._remove(mi,gi,pi);pi.update();for(let mi=pi.leftX;mi<=pi.rightX;mi++)for(let gi=pi.topY;gi<=pi.bottomY;gi++)this._insert(mi,gi,pi);hi++}}return hi}debug(ci,hi){const _i=Color.Transparent,pi=Color.White;for(const mi of this.sparseHashGrid.values())ci.drawRectangle(vec(mi.x*this.gridSize,mi.y*this.gridSize),this.gridSize,this.gridSize,_i,pi,2)}}class PointerSystem extends System{constructor(ci){super(),this.world=ci,this.systemType=SystemType.Update,this._graphicsHashGrid=new SparseHashGrid({size:100}),this._graphics=[],this._entityToPointer=new Map,this._pointerEventDispatcher=new PointerEventsToObjectDispatcher,this.overrideUseColliderShape=!1,this.overrideUseGraphicsBounds=!1,this._sortedTransforms=[],this._sortedEntities=[],this._zHasChanged=!1,this._zIndexUpdate=()=>{this._zHasChanged=!0},this.query=this.world.query([TransformComponent,PointerComponent]),this.query.entityAdded$.subscribe(hi=>{const _i=hi.get(TransformComponent),pi=hi.get(PointerComponent);this._pointerEventDispatcher.addObject(hi,gi=>pi&&pi.localBounds?pi.localBounds.transform(_i.get().matrix).contains(_i.coordPlane===CoordPlane.World?gi.worldPos:gi.screenPos):!1,()=>hi.isActive),this._entityToPointer.set(hi,pi);const mi=hi.get(GraphicsComponent);mi&&(this._graphics.push(mi),this._graphicsHashGrid.track(mi)),this._sortedTransforms.push(_i),this._sortedEntities.push(_i.owner),_i.zIndexChanged$.subscribe(this._zIndexUpdate),this._zHasChanged=!0}),this.query.entityRemoved$.subscribe(hi=>{this._pointerEventDispatcher.removeObject(hi);const _i=hi.get(TransformComponent);this._entityToPointer.delete(hi);const pi=hi.get(GraphicsComponent);if(pi){const gi=this._graphics.indexOf(pi);gi>-1&&this._graphics.splice(gi,1),this._graphicsHashGrid.untrack(pi)}_i.zIndexChanged$.unsubscribe(this._zIndexUpdate);const mi=this._sortedTransforms.indexOf(_i);mi>-1&&(this._sortedTransforms.splice(mi,1),this._sortedEntities.splice(mi,1))})}initialize(ci,hi){this._engine=hi.engine,this._scene=hi}preupdate(){this._scene.camera.hasChanged()&&this._scene.camera.updateTransform(this._scene.camera.pos),this._receivers=[this._engine.input.pointers,this._scene.input.pointers],this._engineReceiver=this._engine.input.pointers,this._zHasChanged&&(this._sortedTransforms.sort((ci,hi)=>hi.z-ci.z),this._sortedEntities=this._sortedTransforms.map(ci=>ci.owner),this._zHasChanged=!1)}update(){this._graphicsHashGrid.update(this._graphics);for(const[ci,hi]of this._engineReceiver.currentFramePointerCoords.entries()){const _i=this._scene.physics.query(hi.worldPos);for(let mi=0;mi<_i.length;mi++){const gi=_i[mi],vi=this._entityToPointer.get(gi.owner);vi&&(vi.useColliderShape||this.overrideUseColliderShape)&&this._pointerEventDispatcher.addPointerToObject(gi.owner,ci)}const pi=this._graphicsHashGrid.query(hi.worldPos);for(let mi=0;mi<pi.length;mi++){const gi=pi[mi],vi=this._entityToPointer.get(gi.owner);vi&&(vi.useGraphicsBounds||this.overrideUseGraphicsBounds)&&this._pointerEventDispatcher.addPointerToObject(gi.owner,ci)}}this._pointerEventDispatcher.processPointerToObject(this._engineReceiver,this._sortedEntities),this._pointerEventDispatcher.dispatchEvents(this._engineReceiver,this._sortedEntities),this._receivers.forEach(ci=>ci.update()),this._pointerEventDispatcher.clear(),this._receivers.forEach(ci=>ci.clear())}}PointerSystem.priority=SystemPriority.Higher;class ActionsSystem extends System{constructor(ci){super(),this.world=ci,this.systemType=SystemType.Update,this._actions=[],this.query=this.world.query([ActionsComponent]),this.query.entityAdded$.subscribe(hi=>this._actions.push(hi.get(ActionsComponent))),this.query.entityRemoved$.subscribe(hi=>{const _i=hi.get(ActionsComponent),pi=this._actions.indexOf(_i);pi>-1&&this._actions.splice(pi,1)})}update(ci){for(let hi=0;hi<this._actions.length;hi++)this._actions[hi].update(ci)}}ActionsSystem.priority=SystemPriority.Higher;class IsometricEntityComponent extends Component{constructor(ci){super(),this.elevation=0,this.columns=ci.columns,this.rows=ci.rows,this.tileWidth=ci.tileWidth,this.tileHeight=ci.tileHeight}}class IsometricEntitySystem extends System{constructor(ci){super(),this.world=ci,this.systemType=SystemType.Update,this.query=this.world.query([TransformComponent,IsometricEntityComponent])}update(){let ci,hi;for(let _i=0;_i<this.query.entities.length;_i++){const pi=this.query.entities[_i];ci=pi.get(TransformComponent),hi=pi.get(IsometricEntityComponent);const gi=Math.max(hi.columns*hi.tileWidth,hi.rows*hi.tileHeight)*hi.elevation+ci.pos.y;ci.z=gi}}}IsometricEntitySystem.priority=SystemPriority.Lower;class OffscreenSystem extends System{constructor(ci){super(),this.world=ci,this.systemType=SystemType.Draw,this.query=this.world.query([TransformComponent,GraphicsComponent])}initialize(ci,hi){this._camera=hi.camera,this._screen=hi.engine.screen}update(){this._worldBounds=this._screen.getWorldBounds();let ci,hi,_i;for(let pi=0;pi<this.query.entities.length;pi++){const mi=this.query.entities[pi];hi=mi.get(GraphicsComponent),ci=mi.get(TransformComponent),_i=mi.get(ParallaxComponent);let gi;if(_i){const xi=Vector.One.sub(_i.parallaxFactor);gi=this._camera.pos.scale(xi)}const vi=this._isOffscreen(ci,hi,gi);vi&&!mi.hasTag("ex.offscreen")&&(mi.events.emit("exitviewport",new ExitViewPortEvent(mi)),mi.addTag("ex.offscreen")),!vi&&mi.hasTag("ex.offscreen")&&(mi.events.emit("enterviewport",new EnterViewPortEvent(mi)),mi.removeTag("ex.offscreen"))}}_isOffscreen(ci,hi,_i){if(hi.forceOnScreen)return!1;if(ci.coordPlane===CoordPlane.World){let pi=hi.localBounds;_i&&(pi=pi.translate(_i));const mi=pi.transform(ci.get().matrix);return!this._worldBounds.overlaps(mi)}else return!1}}OffscreenSystem.priority=SystemPriority.Higher;class HashColliderProxy extends HashGridProxy{constructor(ci,hi){var _i,pi;super(ci,hi),this.collider=ci,this.id=-1,this.hasZeroBounds=!1,this.cells=[],this.gridSize=hi;const mi=ci.bounds;this.hasZeroBounds=mi.hasZeroDimensions(),this.leftX=Math.floor(mi.left/this.gridSize),this.rightX=Math.floor(mi.right/this.gridSize),this.bottomY=Math.floor(mi.bottom/this.gridSize),this.topY=Math.floor(mi.top/this.gridSize),this.owner=ci.owner,this.body=(_i=this.owner)===null||_i===void 0?void 0:_i.get(BodyComponent),this.collisionType=(pi=this.body.collisionType)!==null&&pi!==void 0?pi:CollisionType.PreventCollision}update(){var ci,hi;super.update(),this.body=(ci=this.owner)===null||ci===void 0?void 0:ci.get(BodyComponent),this.collisionType=(hi=this.body.collisionType)!==null&&hi!==void 0?hi:CollisionType.PreventCollision,this.hasZeroBounds=this.collider.localBounds.hasZeroDimensions()}}class SparseHashGridCollisionProcessor{constructor(ci){this._pairs=new Set,this._nonPairs=new Set,this._pairPool=new Pool(()=>new Pair({id:createId("collider",0)},{id:createId("collider",0)}),hi=>(hi.colliderA=null,hi.colliderB=null,hi),200),this.gridSize=ci.size,this.hashGrid=new SparseHashGrid({size:this.gridSize,proxyFactory:(hi,_i)=>new HashColliderProxy(hi,_i)}),this._pairPool.disableWarnings=!0}getColliders(){return Array.from(this.hashGrid.objectToProxy.keys())}query(ci){return this.hashGrid.query(ci)}rayCast(ci,hi){var _i,pi,mi;const gi=[],vi=(_i=hi==null?void 0:hi.maxDistance)!==null&&_i!==void 0?_i:1/0,xi=hi==null?void 0:hi.collisionGroup,wi=xi?xi.category:(pi=hi==null?void 0:hi.collisionMask)!==null&&pi!==void 0?pi:CollisionGroup.All.category,yi=(mi=hi==null?void 0:hi.searchAllColliders)!==null&&mi!==void 0?mi:!1,Ci=ci.dir.normalize(),Ei=Ci.y/Ci.x,Si=Ci.x/Ci.y,ki=Math.sqrt(1+Ei*Ei)*this.gridSize,Ai=Math.sqrt(1+Si*Si)*this.gridSize,Ii=ci.pos.x/this.gridSize,Ti=ci.pos.y/this.gridSize,Pi=vec(1,1);let Li=~~Ii,Ri=~~Ti,Di=0,Fi=0;Ci.x<0?(Pi.x=-1,Di=(Ii-Li)*ki):(Pi.x=1,Di=(Li+1-Ii)*ki),Ci.y<0?(Pi.y=-1,Fi=(Ti-Ri)*Ai):(Pi.y=1,Fi=(Ri+1-Ti)*Ai);const Mi=new Set;let $i=!1,Oi=9999;for(;!$i&&Oi>0&&(Oi--,!!this.hashGrid.bounds.contains(vec(Li*this.gridSize,Ri*this.gridSize)));){const Gi=HashGridCell.calculateHashKey(Li,Ri),Ui=this.hashGrid.sparseHashGrid.get(Gi);if(Ui){const zi=[];for(let Wi=0;Wi<Ui.proxies.length;Wi++){const Ni=Ui.proxies[Wi];if(!Mi.has(Ni.collider.id.value)){if(Mi.add(Ni.collider.id.value),hi!=null&&hi.ignoreCollisionGroupAll&&Ni.body.group===CollisionGroup.All)continue;const Hi=(wi&Ni.body.group.category)!==0;if(Ni.body.group&&!Hi)continue;const ji=Ni.collider.rayCast(ci,vi);ji&&zi.push(ji)}}zi.sort((Wi,Ni)=>Wi.distance-Ni.distance);for(let Wi=0;Wi<zi.length;Wi++){const Ni=zi[Wi];if(hi!=null&&hi.filter){if(hi.filter(Ni)&&(gi.push(Ni),!yi)){$i=!0;break}}else if(gi.push(Ni),!yi){$i=!0;break}}}Di<Fi?(Li+=Pi.x,Di+=ki):(Ri+=Pi.y,Fi+=Ai)}return gi.sort((Gi,Ui)=>Gi.distance-Ui.distance),!yi&&gi.length?[gi[0]]:gi}track(ci){let hi=[ci];if(ci instanceof CompositeCollider){const _i=ci.getColliders();for(const pi of _i)pi.owner=ci.owner;hi=_i}for(const _i of hi)this.hashGrid.track(_i)}untrack(ci){let hi=[ci];ci instanceof CompositeCollider&&(hi=ci.getColliders());for(const _i of hi)this.hashGrid.untrack(_i)}_canCollide(ci,hi){return!(ci.collider.id===hi.collider.id||ci.owner&&hi.owner&&ci.owner.id===hi.owner.id||ci.hasZeroBounds||hi.hasZeroBounds||!ci.body.group.canCollide(hi.body.group)||ci.collisionType===CollisionType.Fixed&&hi.collisionType===CollisionType.Fixed||ci.collisionType===CollisionType.PreventCollision||hi.collisionType===CollisionType.PreventCollision||!ci.owner.isActive||!hi.owner.isActive)}broadphase(ci,hi){const _i=[];this._pairs.clear(),this._nonPairs.clear();let pi=0;for(const mi of this.hashGrid.objectToProxy.values())if(mi.id=pi++,!(!mi.owner.isActive||mi.collisionType===CollisionType.PreventCollision))for(let gi=0;gi<mi.cells.length;gi++){const vi=mi.cells[gi];for(let xi=0;xi<vi.proxies.length;xi++){const wi=vi.proxies[xi];if(wi.id===mi.id)continue;const yi=Pair.calculatePairHash(mi.collider.id,wi.collider.id);if(!this._nonPairs.has(yi))if(!this._pairs.has(yi)&&this._canCollide(mi,wi)&&mi.object.bounds.overlaps(wi.object.bounds)){const Ci=this._pairPool.get();Ci.colliderA=mi.collider,Ci.colliderB=wi.collider,Ci.id=yi,this._pairs.add(yi),_i.push(Ci)}else this._nonPairs.add(yi)}}return _i}narrowphase(ci,hi){const _i=[];for(let pi=0;pi<ci.length;pi++){const mi=ci[pi].collide();for(let gi=0;gi<mi.length;gi++){const vi=mi[gi];_i.push(vi),hi&&hi.physics.contacts.set(vi.id,vi)}}return this._pairPool.done(),hi&&(hi.physics.collisions+=_i.length),_i}update(ci,hi){return this.hashGrid.update(ci)}debug(ci,hi){this.hashGrid.debug(ci,hi)}}class PhysicsWorld{get config(){return watchDeep(this._config,ci=>{this.$configUpdate.notifyAll(ci)})}set config(ci){this._config=ci,this.$configUpdate.notifyAll(ci)}get collisionProcessor(){if(this._configDirty){this._configDirty=!1;const ci=this._collisionProcessor.getColliders();this._config.spatialPartition===SpatialPartitionStrategy.SparseHashGrid?this._collisionProcessor=new SparseHashGridCollisionProcessor(this._config.sparseHashGrid):this._collisionProcessor=new DynamicTreeCollisionProcessor(this._config);for(const hi of ci)this._collisionProcessor.track(hi)}return this._collisionProcessor}constructor(ci){this.$configUpdate=new Observable,this._configDirty=!1,this.config=ci,this.$configUpdate.subscribe(hi=>{this._configDirty=!0,BodyComponent.updateDefaultPhysicsConfig(hi.bodies)}),this._config.spatialPartition===SpatialPartitionStrategy.SparseHashGrid?this._collisionProcessor=new SparseHashGridCollisionProcessor(this._config.sparseHashGrid):this._collisionProcessor=new DynamicTreeCollisionProcessor(this._config)}rayCast(ci,hi){return this.collisionProcessor.rayCast(ci,hi)}query(ci){return this._collisionProcessor.query(ci)}}class Gamepads{constructor(){this.events=new EventEmitter,this.enabled=!1,this.supported=!!navigator.getGamepads,this._gamePadTimeStamps=[0,0,0,0],this._oldPads=[],this._pads=[],this._initSuccess=!1,this._navigator=navigator,this._minimumConfiguration=null,this._enabled=!0}init(){this.supported&&(this._initSuccess||(this._oldPads=this._clonePads(this._navigator.getGamepads()),this._oldPads.length&&this._oldPads[0]&&(this._initSuccess=!0)))}toggleEnabled(ci){this._enabled=ci}setMinimumGamepadConfiguration(ci){this._enableAndUpdate(),this._minimumConfiguration=ci}_enableAndUpdate(){this.enabled||(this.enabled=!0,this.update())}_isGamepadValid(ci){if(!this._minimumConfiguration)return!0;if(!ci)return!1;const hi=ci.axes.filter(pi=>typeof pi!==void 0).length,_i=ci.buttons.filter(pi=>typeof pi!==void 0).length;return hi>=this._minimumConfiguration.axis&&_i>=this._minimumConfiguration.buttons&&ci.connected}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this._enableAndUpdate(),this.events.on(ci,hi)}once(ci,hi){return this._enableAndUpdate(),this.events.once(ci,hi)}off(ci,hi){this._enableAndUpdate(),this.events.off(ci,hi)}update(){var ci,hi;if(!this.enabled||!this.supported||!this._enabled)return;this.init();const _i=this._navigator.getGamepads();for(let pi=0;pi<_i.length;pi++){if(_i[pi]){const gi=this.at(pi);!this.at(pi).connected&&this._isGamepadValid(_i[pi])&&(gi.events.pipe(this.events),this.events.emit("connect",new GamepadConnectEvent(pi,this.at(pi)))),this.at(pi).connected=!0}else{const gi=this.at(pi);gi.connected&&(this.events.emit("disconnect",new GamepadDisconnectEvent(pi,gi)),gi.events.unpipe(this.events)),gi.connected=!1;continue}if(this.at(pi).update(),_i[pi].timestamp&&_i[pi].timestamp===this._gamePadTimeStamps[pi])continue;this._gamePadTimeStamps[pi]=_i[pi].timestamp,this.at(pi).navigatorGamepad=_i[pi];const mi=_i[pi];if(mi){for(let gi=0;gi<mi.buttons.length;gi++){const vi=mi.buttons[gi],xi=vi==null?void 0:vi.value;xi!==((ci=this._oldPads[pi])===null||ci===void 0?void 0:ci.getButton(gi))&&(vi!=null&&vi.pressed?(this.at(pi).updateButton(gi,xi),this.at(pi).events.emit("button",new GamepadButtonEvent(gi in Buttons?gi:Buttons.Unknown,gi,xi,this.at(pi)))):this.at(pi).updateButton(gi,0))}for(let gi=0;gi<mi.axes.length;gi++){const vi=mi.axes[gi];vi!==((hi=this._oldPads[pi])===null||hi===void 0?void 0:hi.getAxes(gi))&&(this.at(pi).updateAxes(gi,vi),this.at(pi).events.emit("axis",new GamepadAxisEvent(gi,vi,this.at(pi))))}}this._oldPads[pi]=this._clonePad(_i[pi])}}at(ci){if(this._enableAndUpdate(),ci>=this._pads.length)for(let hi=this._pads.length-1,_i=ci;hi<_i;hi++)this._pads.push(new Gamepad),this._oldPads.push(new Gamepad);return this._pads[ci]}getValidGamepads(){this._enableAndUpdate();const ci=[];for(let hi=0;hi<this._pads.length;hi++)this._isGamepadValid(this.at(hi).navigatorGamepad)&&this.at(hi).connected&&ci.push(this.at(hi));return ci}count(){return this._pads.filter(ci=>ci.connected).length}_clonePads(ci){const hi=[];for(let _i=0,pi=ci.length;_i<pi;_i++)hi.push(this._clonePad(ci[_i]));return hi}_clonePad(ci){let hi,_i;const pi=new Gamepad;if(!ci)return pi;for(hi=0,_i=ci.buttons.length;hi<_i;hi++)ci.buttons[hi]&&pi.updateButton(hi,ci.buttons[hi].value);for(hi=0,_i=ci.axes.length;hi<_i;hi++)pi.updateAxes(hi,ci.axes[hi]);return pi}}Gamepads.MinAxisMoveThreshold=.05;class Gamepad{constructor(){this.events=new EventEmitter,this.connected=!1,this._axes=new Array(4),this._buttons=new Array(16),this._buttonsUp=new Array(16),this._buttonsDown=new Array(16);for(let ci=0;ci<this._buttons.length;ci++)this._buttons[ci]=0;for(let ci=0;ci<this._axes.length;ci++)this._axes[ci]=0}update(){this._buttonsDown=new Array(16),this._buttonsUp=new Array(16)}isButtonPressed(ci,hi=1){return this._buttons[ci]>=hi}isButtonHeld(ci,hi=1){return this._buttons[ci]>=hi}wasButtonPressed(ci,hi=1){return this._buttonsDown[ci]>=hi}wasButtonReleased(ci){return!!this._buttonsUp[ci]}getButton(ci){return this._buttons[ci]}getAxes(ci){const hi=this._axes[ci];return Math.abs(hi)<Gamepads.MinAxisMoveThreshold?0:hi}updateButton(ci,hi){hi===0&&this._buttons[ci]?this._buttonsUp[ci]=1:this._buttonsDown[ci]=hi,this._buttons[ci]=hi}updateAxes(ci,hi){this._axes[ci]=hi}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}}var Buttons;(function(fi){fi[fi.Unknown=-1]="Unknown",fi[fi.Face1=0]="Face1",fi[fi.Face2=1]="Face2",fi[fi.Face3=2]="Face3",fi[fi.Face4=3]="Face4",fi[fi.LeftBumper=4]="LeftBumper",fi[fi.RightBumper=5]="RightBumper",fi[fi.LeftTrigger=6]="LeftTrigger",fi[fi.RightTrigger=7]="RightTrigger",fi[fi.Select=8]="Select",fi[fi.Start=9]="Start",fi[fi.LeftStick=10]="LeftStick",fi[fi.RightStick=11]="RightStick",fi[fi.DpadUp=12]="DpadUp",fi[fi.DpadDown=13]="DpadDown",fi[fi.DpadLeft=14]="DpadLeft",fi[fi.DpadRight=15]="DpadRight",fi[fi.CenterButton=16]="CenterButton",fi[fi.MiscButton1=17]="MiscButton1"})(Buttons||(Buttons={}));var Axes;(function(fi){fi[fi.LeftStickX=0]="LeftStickX",fi[fi.LeftStickY=1]="LeftStickY",fi[fi.RightStickX=2]="RightStickX",fi[fi.RightStickY=3]="RightStickY"})(Axes||(Axes={}));class InputMapper{constructor(ci){this.inputs=ci,this._handlers=new Map}execute(){for(const[ci,hi]of this._handlers.entries()){const _i=ci(this.inputs);_i&&hi(_i)}}on(ci,hi){this._handlers.set(ci,hi)}}function isCrossOriginIframe(){try{const fi=()=>{};window.top.addEventListener("blur",fi),window.top.removeEventListener("blur",fi)}catch{return!0}return!1}var Keys;(function(fi){fi.Backquote="Backquote",fi.Backslash="Backslash",fi.BracketLeft="BracketLeft",fi.BracketRight="BracketRight",fi.Comma="Comma",fi.Key0="Digit0",fi.Key1="Digit1",fi.Key2="Digit2",fi.Key3="Digit3",fi.Key4="Digit4",fi.Key5="Digit5",fi.Key6="Digit6",fi.Key7="Digit7",fi.Key8="Digit8",fi.Key9="Digit9",fi.Digit0="Digit0",fi.Digit1="Digit1",fi.Digit2="Digit2",fi.Digit3="Digit3",fi.Digit4="Digit4",fi.Digit5="Digit5",fi.Digit6="Digit6",fi.Digit7="Digit7",fi.Digit8="Digit8",fi.Digit9="Digit9",fi.Equal="Equal",fi.IntlBackslash="IntlBackslash",fi.IntlRo="IntlRo",fi.IntlYen="IntlYen",fi.A="KeyA",fi.B="KeyB",fi.C="KeyC",fi.D="KeyD",fi.E="KeyE",fi.F="KeyF",fi.G="KeyG",fi.H="KeyH",fi.I="KeyI",fi.J="KeyJ",fi.K="KeyK",fi.L="KeyL",fi.M="KeyM",fi.N="KeyN",fi.O="KeyO",fi.P="KeyP",fi.Q="KeyQ",fi.R="KeyR",fi.S="KeyS",fi.T="KeyT",fi.U="KeyU",fi.V="KeyV",fi.W="KeyW",fi.X="KeyX",fi.Y="KeyY",fi.Z="KeyZ",fi.KeyA="KeyA",fi.KeyB="KeyB",fi.KeyC="KeyC",fi.KeyD="KeyD",fi.KeyE="KeyE",fi.KeyF="KeyF",fi.KeyG="KeyG",fi.KeyH="KeyH",fi.KeyI="KeyI",fi.KeyJ="KeyJ",fi.KeyK="KeyK",fi.KeyL="KeyL",fi.KeyM="KeyM",fi.KeyN="KeyN",fi.KeyO="KeyO",fi.KeyP="KeyP",fi.KeyQ="KeyQ",fi.KeyR="KeyR",fi.KeyS="KeyS",fi.KeyT="KeyT",fi.KeyU="KeyU",fi.KeyV="KeyV",fi.KeyW="KeyW",fi.KeyX="KeyX",fi.KeyY="KeyY",fi.KeyZ="KeyZ",fi.Minus="Minus",fi.Period="Period",fi.Quote="Quote",fi.Semicolon="Semicolon",fi.Slash="Slash",fi.AltLeft="AltLeft",fi.AltRight="AltRight",fi.Alt="Alt",fi.AltGraph="AltGraph",fi.Backspace="Backspace",fi.CapsLock="CapsLock",fi.ContextMenu="ContextMenu",fi.ControlLeft="ControlLeft",fi.ControlRight="ControlRight",fi.Enter="Enter",fi.MetaLeft="MetaLeft",fi.MetaRight="MetaRight",fi.ShiftLeft="ShiftLeft",fi.ShiftRight="ShiftRight",fi.Space="Space",fi.Tab="Tab",fi.Convert="Convert",fi.KanaMode="KanaMode",fi.NonConvert="NonConvert",fi.Delete="Delete",fi.End="End",fi.Help="Help",fi.Home="Home",fi.Insert="Insert",fi.PageDown="PageDown",fi.PageUp="PageUp",fi.Up="ArrowUp",fi.Down="ArrowDown",fi.Left="ArrowLeft",fi.Right="ArrowRight",fi.ArrowUp="ArrowUp",fi.ArrowDown="ArrowDown",fi.ArrowLeft="ArrowLeft",fi.ArrowRight="ArrowRight",fi.NumLock="NumLock",fi.Numpad0="Numpad0",fi.Numpad1="Numpad1",fi.Numpad2="Numpad2",fi.Numpad3="Numpad3",fi.Numpad4="Numpad4",fi.Numpad5="Numpad5",fi.Numpad6="Numpad6",fi.Numpad7="Numpad7",fi.Numpad8="Numpad8",fi.Numpad9="Numpad9",fi.Num0="Numpad0",fi.Num1="Numpad1",fi.Num2="Numpad2",fi.Num3="Numpad3",fi.Num4="Numpad4",fi.Num5="Numpad5",fi.Num6="Numpad6",fi.Num7="Numpad7",fi.Num8="Numpad8",fi.Num9="Numpad9",fi.NumAdd="NumpadAdd",fi.NumpadAdd="NumpadAdd",fi.NumDecimal="NumpadDecimal",fi.NumpadDecimal="NumpadDecimal",fi.NumDivide="NumpadDivide",fi.NumpadDivide="NumpadDivide",fi.NumEnter="NumpadEnter",fi.NumpadEnter="NumpadEnter",fi.NumMultiply="NumpadMultiply",fi.NumpadMultiply="NumpadMultiply",fi.NumSubtract="NumpadSubtract",fi.NumpadSubtract="NumpadSubtract",fi.Esc="Escape",fi.Escape="Escape",fi.F1="F1",fi.F2="F2",fi.F3="F3",fi.F4="F4",fi.F5="F5",fi.F6="F6",fi.F7="F7",fi.F8="F8",fi.F9="F9",fi.F10="F10",fi.F11="F11",fi.F12="F12",fi.F13="F13",fi.F14="F14",fi.F15="F15",fi.F16="F16",fi.F17="F17",fi.F18="F18",fi.F19="F19",fi.F20="F20",fi.PrintScreen="PrintScreen",fi.ScrollLock="ScrollLock",fi.Pause="Pause",fi.Unidentified="Unidentified"})(Keys||(Keys={}));class KeyEvent extends GameEvent{constructor(ci,hi,_i){super(),this.key=ci,this.value=hi,this.originalEvent=_i}}let Keyboard$1=class{constructor(){this.events=new EventEmitter,this._enabled=!0,this._keys=[],this._keysUp=[],this._keysDown=[],this._releaseAllKeys=ci=>{for(const hi of this._keys){const _i=new KeyEvent(hi,ci.key,ci);this.events.emit("up",_i),this.events.emit("release",_i)}this._keysUp=Array.from(new Set(this._keys.concat(this._keysUp))),this._keys.length=0},this._handleKeyDown=ci=>{if(!this._enabled)return;!ci.metaKey&&(this._keys.includes(Keys.MetaLeft)||this._keys.includes(Keys.MetaRight))&&this._releaseAllKeys(ci);const hi=ci.code;if(this._keys.indexOf(hi)===-1){this._keys.push(hi),this._keysDown.push(hi);const _i=new KeyEvent(hi,ci.key,ci);this.events.emit("down",_i),this.events.emit("press",_i)}},this._handleKeyUp=ci=>{if(!this._enabled)return;const hi=ci.code,_i=this._keys.indexOf(hi);this._keys.splice(_i,1),this._keysUp.push(hi);const pi=new KeyEvent(hi,ci.key,ci);this.events.emit("up",pi),this.events.emit("release",pi),ci.key==="Meta"&&this._releaseAllKeys(ci)}}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}init(ci){let{global:hi}=ci;const{grabWindowFocus:_i}=ci;hi||(isCrossOriginIframe()?(hi=window,_i&&window.focus(),Logger.getInstance().warn("Excalibur might be in a cross-origin iframe, in order to receive keyboard events it must be in focus")):hi=window.top),hi.addEventListener("blur",()=>{this._keys.length=0}),hi.addEventListener("keyup",this._handleKeyUp),hi.addEventListener("keydown",this._handleKeyDown)}toggleEnabled(ci){this._enabled=ci}clear(){this._keysDown.length=0,this._keysUp.length=0,this._keys.length=0}update(){this._keysDown.length=0,this._keysUp.length=0;for(let ci=0;ci<this._keys.length;ci++)this.events.emit("hold",new KeyEvent(this._keys[ci]))}getKeys(){return this._keys}wasPressed(ci){return this._enabled?this._keysDown.indexOf(ci)>-1:!1}isHeld(ci){return this._enabled?this._keys.indexOf(ci)>-1:!1}wasReleased(ci){return this._enabled?this._keysUp.indexOf(ci)>-1:!1}triggerEvent(ci,hi,_i){ci==="down"&&this._handleKeyDown(new KeyboardEvent("keydown",{code:hi,key:_i??null})),ci==="up"&&this._handleKeyUp(new KeyboardEvent("keyup",{code:hi,key:_i??null}))}};class GlobalCoordinates{static fromPagePosition(ci,hi,_i){let pi,mi,gi,vi;arguments.length===3?(pi=ci,mi=hi,gi=new Vector(pi,mi),vi=_i):(gi=ci,pi=gi.x,mi=gi.y,vi=hi);const xi=vi.screen.pageToScreenCoordinates(gi),wi=vi.screen.screenToWorldCoordinates(xi);return new GlobalCoordinates(wi,gi,xi)}constructor(ci,hi,_i){this.worldPos=ci,this.pagePos=hi,this.screenPos=_i}}class PointerEvent{cancel(){this.active=!1}get pagePos(){return this.coordinates.pagePos}get screenPos(){return this.coordinates.screenPos}get worldPos(){return this.coordinates.worldPos}constructor(ci,hi,_i,pi,mi,gi){this.type=ci,this.pointerId=hi,this.button=_i,this.pointerType=pi,this.coordinates=mi,this.nativeEvent=gi,this.active=!0}}class WheelEvent{cancel(){this.active=!1}constructor(ci,hi,_i,pi,mi,gi,vi,xi,wi,yi,Ci,Ei){this.x=ci,this.y=hi,this.pageX=_i,this.pageY=pi,this.screenX=mi,this.screenY=gi,this.index=vi,this.deltaX=xi,this.deltaY=wi,this.deltaZ=yi,this.deltaMode=Ci,this.ev=Ei,this.active=!0}}class PointerAbstraction{constructor(){this.events=new EventEmitter,this.lastPagePos=Vector.Zero,this.lastScreenPos=Vector.Zero,this.lastWorldPos=Vector.Zero,this._onPointerMove=ci=>{this.lastPagePos=new Vector(ci.pagePos.x,ci.pagePos.y),this.lastScreenPos=new Vector(ci.screenPos.x,ci.screenPos.y),this.lastWorldPos=new Vector(ci.worldPos.x,ci.worldPos.y)},this._onPointerDown=ci=>{this.lastPagePos=new Vector(ci.pagePos.x,ci.pagePos.y),this.lastScreenPos=new Vector(ci.screenPos.x,ci.screenPos.y),this.lastWorldPos=new Vector(ci.worldPos.x,ci.worldPos.y)},this.on("move",this._onPointerMove),this.on("down",this._onPointerDown)}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}_updateWorldPosition(ci){const hi=GlobalCoordinates.fromPagePosition(this.lastPagePos,ci);this.lastScreenPos=hi.screenPos,this.lastWorldPos=hi.worldPos}}var WheelDeltaMode;(function(fi){fi.Pixel="Pixel",fi.Line="Line",fi.Page="Page"})(WheelDeltaMode||(WheelDeltaMode={}));var NativePointerButton;(function(fi){fi[fi.NoButton=-1]="NoButton",fi[fi.Left=0]="Left",fi[fi.Middle=1]="Middle",fi[fi.Right=2]="Right",fi[fi.Unknown=3]="Unknown"})(NativePointerButton||(NativePointerButton={}));var PointerButton;(function(fi){fi.Left="Left",fi.Middle="Middle",fi.Right="Right",fi.Unknown="Unknown",fi.NoButton="NoButton"})(PointerButton||(PointerButton={}));var PointerType;(function(fi){fi.Touch="Touch",fi.Mouse="Mouse",fi.Pen="Pen",fi.Unknown="Unknown"})(PointerType||(PointerType={}));function isTouchEvent(fi){return globalThis.TouchEvent&&fi instanceof globalThis.TouchEvent}function isPointerEvent(fi){return globalThis.PointerEvent&&fi instanceof globalThis.PointerEvent}class PointerEventReceiver{constructor(ci,hi){this.target=ci,this.engine=hi,this.events=new EventEmitter,this.primary=new PointerAbstraction,this._activeNativePointerIdsToNormalized=new Map,this.lastFramePointerCoords=new Map,this.currentFramePointerCoords=new Map,this.currentFramePointerDown=new Map,this.lastFramePointerDown=new Map,this.currentFrameDown=[],this.currentFrameUp=[],this.currentFrameMove=[],this.currentFrameCancel=[],this.currentFrameWheel=[],this._enabled=!0,this._pointers=[this.primary],this._boundHandle=this._handle.bind(this),this._boundWheel=this._handleWheel.bind(this)}toggleEnabled(ci){this._enabled=ci}recreate(ci,hi){const _i=new PointerEventReceiver(ci,hi);return _i.primary=this.primary,_i._pointers=this._pointers,_i}at(ci){if(ci>=this._pointers.length)for(let hi=this._pointers.length-1,_i=ci;hi<_i;hi++)this._pointers.push(new PointerAbstraction);return this._pointers[ci]}count(){return this._pointers.length}isDown(ci){var hi;return this._enabled&&(hi=this.currentFramePointerDown.get(ci))!==null&&hi!==void 0?hi:!1}wasDown(ci){var hi;return this._enabled&&(hi=this.lastFramePointerDown.get(ci))!==null&&hi!==void 0?hi:!1}isDragging(ci){return this._enabled?this.isDown(ci):!1}isDragStart(ci){return this._enabled?this.isDown(ci)&&!this.wasDown(ci):!1}isDragEnd(ci){return this._enabled?!this.isDown(ci)&&this.wasDown(ci):!1}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}update(){this.lastFramePointerDown=new Map(this.currentFramePointerDown),this.lastFramePointerCoords=new Map(this.currentFramePointerCoords);for(const ci of this.currentFrameDown){if(!ci.active)continue;this.emit("down",ci),this.at(ci.pointerId).emit("down",ci),this.primary.emit("pointerdown",ci)}for(const ci of this.currentFrameUp){if(!ci.active)continue;this.emit("up",ci),this.at(ci.pointerId).emit("up",ci)}for(const ci of this.currentFrameMove){if(!ci.active)continue;this.emit("move",ci),this.at(ci.pointerId).emit("move",ci)}for(const ci of this.currentFrameCancel){if(!ci.active)continue;this.emit("cancel",ci),this.at(ci.pointerId).emit("cancel",ci)}for(const ci of this.currentFrameWheel)ci.active&&(this.emit("pointerwheel",ci),this.emit("wheel",ci),this.primary.emit("pointerwheel",ci),this.primary.emit("wheel",ci));if(this.engine.currentScene.camera.hasChanged())for(const ci of this._pointers)ci._updateWorldPosition(this.engine)}clear(){for(const ci of this.currentFrameUp){this.currentFramePointerCoords.delete(ci.pointerId);const hi=this._activeNativePointerIdsToNormalized.entries();for(const[_i,pi]of hi)pi===ci.pointerId&&this._activeNativePointerIdsToNormalized.delete(_i)}this.currentFrameDown.length=0,this.currentFrameUp.length=0,this.currentFrameMove.length=0,this.currentFrameCancel.length=0,this.currentFrameWheel.length=0}init(ci){var hi;if(this.engine.isDisposed())return;this.target===this.engine.canvas?this.engine.canvas.style.touchAction="none":document.body.style.touchAction="none",window.PointerEvent?(this.target.addEventListener("pointerdown",this._boundHandle),this.target.addEventListener("pointerup",this._boundHandle),this.target.addEventListener("pointermove",this._boundHandle),this.target.addEventListener("pointercancel",this._boundHandle)):(this.target.addEventListener("touchstart",this._boundHandle),this.target.addEventListener("touchend",this._boundHandle),this.target.addEventListener("touchmove",this._boundHandle),this.target.addEventListener("touchcancel",this._boundHandle),this.target.addEventListener("mousedown",this._boundHandle),this.target.addEventListener("mouseup",this._boundHandle),this.target.addEventListener("mousemove",this._boundHandle));const _i={passive:!(this.engine.pageScrollPreventionMode===ScrollPreventionMode.All||this.engine.pageScrollPreventionMode===ScrollPreventionMode.Canvas)};if("onwheel"in document.createElement("div")?this.target.addEventListener("wheel",this._boundWheel,_i):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel,_i):this.target.addEventListener("MozMousePixelScroll",this._boundWheel,_i),((hi=ci==null?void 0:ci.grabWindowFocus)!==null&&hi!==void 0?hi:!0)&&isCrossOriginIframe()){const mi=()=>{window.focus()};window.PointerEvent?this.target.addEventListener("pointerdown",mi):(this.target.addEventListener("touchstart",mi),this.target.addEventListener("mousedown",mi))}}detach(){window.PointerEvent?(this.target.removeEventListener("pointerdown",this._boundHandle),this.target.removeEventListener("pointerup",this._boundHandle),this.target.removeEventListener("pointermove",this._boundHandle),this.target.removeEventListener("pointercancel",this._boundHandle)):(this.target.removeEventListener("touchstart",this._boundHandle),this.target.removeEventListener("touchend",this._boundHandle),this.target.removeEventListener("touchmove",this._boundHandle),this.target.removeEventListener("touchcancel",this._boundHandle),this.target.removeEventListener("mousedown",this._boundHandle),this.target.removeEventListener("mouseup",this._boundHandle),this.target.removeEventListener("mousemove",this._boundHandle)),"onwheel"in document.createElement("div")?this.target.removeEventListener("wheel",this._boundWheel):document.onmousewheel!==void 0?this.target.addEventListener("mousewheel",this._boundWheel):this.target.addEventListener("MozMousePixelScroll",this._boundWheel)}_normalizePointerId(ci){this._activeNativePointerIdsToNormalized.set(ci,-1);const _i=Array.from(this._activeNativePointerIdsToNormalized.keys()).sort((pi,mi)=>pi-mi).findIndex(pi=>pi===ci);return this._activeNativePointerIdsToNormalized.set(ci,_i),_i}_handle(ci){if(!this._enabled)return;ci.preventDefault();const hi=new Map;let _i,pi;if(isTouchEvent(ci)){_i=PointerButton.Unknown,pi=PointerType.Touch;for(let mi=0;mi<ci.changedTouches.length;mi++){const gi=ci.changedTouches[mi],vi=GlobalCoordinates.fromPagePosition(gi.pageX,gi.pageY,this.engine),xi=mi+1,wi=this._normalizePointerId(xi);this.currentFramePointerCoords.set(wi,vi),hi.set(wi,vi)}}else{_i=this._nativeButtonToPointerButton(ci.button),pi=PointerType.Mouse;const mi=GlobalCoordinates.fromPagePosition(ci.pageX,ci.pageY,this.engine);let gi=1;isPointerEvent(ci)&&(gi=ci.pointerId,pi=this._stringToPointerType(ci.pointerType));const vi=this._normalizePointerId(gi);this.currentFramePointerCoords.set(vi,mi),hi.set(vi,mi)}for(const[mi,gi]of hi.entries())switch(ci.type){case"mousedown":case"pointerdown":case"touchstart":this.currentFrameDown.push(new PointerEvent("down",mi,_i,pi,gi,ci)),this.currentFramePointerDown.set(mi,!0);break;case"mouseup":case"pointerup":case"touchend":this.currentFrameUp.push(new PointerEvent("up",mi,_i,pi,gi,ci)),this.currentFramePointerDown.set(mi,!1);break;case"mousemove":case"pointermove":case"touchmove":this.currentFrameMove.push(new PointerEvent("move",mi,_i,pi,gi,ci));break;case"touchcancel":case"pointercancel":this.currentFrameCancel.push(new PointerEvent("cancel",mi,_i,pi,gi,ci));break}}_handleWheel(ci){if(!this._enabled)return;(this.engine.pageScrollPreventionMode===ScrollPreventionMode.All||this.engine.pageScrollPreventionMode===ScrollPreventionMode.Canvas&&ci.target===this.engine.canvas)&&ci.preventDefault();const hi=this.engine.screen.pageToScreenCoordinates(vec(ci.pageX,ci.pageY)),_i=this.engine.screen.screenToWorldCoordinates(hi),pi=-1/40,mi=ci.deltaX||ci.wheelDeltaX*pi||0,gi=ci.deltaY||ci.wheelDeltaY*pi||ci.wheelDelta*pi||ci.detail||0,vi=ci.deltaZ||0;let xi=WheelDeltaMode.Pixel;ci.deltaMode&&(ci.deltaMode===1?xi=WheelDeltaMode.Line:ci.deltaMode===2&&(xi=WheelDeltaMode.Page));const wi=new WheelEvent(_i.x,_i.y,ci.pageX,ci.pageY,hi.x,hi.y,0,mi,gi,vi,xi,ci);this.currentFrameWheel.push(wi)}triggerEvent(ci,hi){const _i=this.engine.screen.worldToPageCoordinates(hi);window.PointerEvent?this._handle(new window.PointerEvent("pointer"+ci,{pointerId:0,clientX:_i.x,clientY:_i.y})):this._handle(new window.MouseEvent("mouse"+ci,{clientX:_i.x,clientY:_i.y}));const pi=this.engine.currentScene.world.get(PointerSystem);pi.preupdate(this.engine.currentScene,1),pi.update(1)}_nativeButtonToPointerButton(ci){switch(ci){case NativePointerButton.NoButton:return PointerButton.NoButton;case NativePointerButton.Left:return PointerButton.Left;case NativePointerButton.Middle:return PointerButton.Middle;case NativePointerButton.Right:return PointerButton.Right;case NativePointerButton.Unknown:return PointerButton.Unknown;default:return fail(ci)}}_stringToPointerType(ci){switch(ci){case"touch":return PointerType.Touch;case"mouse":return PointerType.Mouse;case"pen":return PointerType.Pen;default:return PointerType.Unknown}}}class InputHost{constructor(ci){this._enabled=!0;const{pointerTarget:hi,grabWindowFocus:_i,engine:pi}=ci;this.keyboard=new Keyboard$1,this.pointers=new PointerEventReceiver(hi,pi),this.gamepads=new Gamepads,this.keyboard.init({grabWindowFocus:_i}),this.pointers.init({grabWindowFocus:_i}),this.gamepads.init(),this.inputMapper=new InputMapper({keyboard:this.keyboard,pointers:this.pointers,gamepads:this.gamepads})}get enabled(){return this._enabled}toggleEnabled(ci){this._enabled=ci,this.keyboard.toggleEnabled(this._enabled),this.pointers.toggleEnabled(this._enabled),this.gamepads.toggleEnabled(this._enabled)}update(){this._enabled&&(this.inputMapper.execute(),this.keyboard.update(),this.gamepads.update())}clear(){this.keyboard.clear(),this.pointers.clear()}}class PreLoadEvent{}const SceneEvents={Initialize:"initialize",Activate:"activate",Deactivate:"deactivate",PreUpdate:"preupdate",PostUpdate:"postupdate",PreDraw:"predraw",PostDraw:"postdraw",PreDebugDraw:"predebugdraw",PostDebugDraw:"postdebugdraw",PreLoad:"preload"};function isSceneConstructor(fi){var ci,hi;return!!(fi!=null&&fi.prototype)&&!!(!((hi=(ci=fi==null?void 0:fi.prototype)===null||ci===void 0?void 0:ci.constructor)===null||hi===void 0)&&hi.name)}class Scene{get actors(){return this.world.entityManager.entities.filter(ci=>ci instanceof Actor)}get entities(){return this.world.entityManager.entities}get triggers(){return this.world.entityManager.entities.filter(ci=>ci instanceof Trigger)}get tileMaps(){return this.world.entityManager.entities.filter(ci=>ci instanceof TileMap)}get timers(){return this._timers}constructor(){this._logger=Logger.getInstance(),this.events=new EventEmitter,this.camera=new Camera,this.world=new World(this),this.physics=new PhysicsWorld(getDefaultPhysicsConfig()),this._isInitialized=!1,this._timers=[],this._cancelQueue=[],this.world.add(ActionsSystem),this.world.add(new MotionSystem(this.world,this.physics)),this.world.add(new CollisionSystem(this.world,this.physics)),this.world.add(PointerSystem),this.world.add(IsometricEntitySystem),this.world.add(OffscreenSystem),this.world.add(GraphicsSystem),this.world.add(DebugSystem)}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}onPreLoad(ci){}onTransition(ci){}onInitialize(ci){}onActivate(ci){}onDeactivate(ci){}onPreUpdate(ci,hi){}onPostUpdate(ci,hi){}onPreDraw(ci,hi){}onPostDraw(ci,hi){}_initializeChildren(){for(const ci of this.entities)ci._initialize(this.engine)}get isInitialized(){return this._isInitialized}async _initialize(ci){var hi;if(!this.isInitialized){try{this.engine=ci,this.physics.config=this.engine.physics,this.input=new InputHost({pointerTarget:ci.pointerScope===PointerScope.Canvas?ci.canvas:document,grabWindowFocus:ci.grabWindowFocus,engine:ci}),this.camera._initialize(ci),this.world.systemManager.initialize(),await this.onInitialize(ci),this._initializeChildren(),this._logger.debug("Scene.onInitialize",this,ci),this.events.emit("initialize",new InitializeEvent(ci,this))}catch(_i){throw this._logger.error(`Error during scene initialization for scene ${(hi=ci.director)===null||hi===void 0?void 0:hi.getSceneName(this)}!`),_i}this._isInitialized=!0}}async _activate(ci){var hi,_i;try{this._logger.debug("Scene.onActivate",this),this.input.toggleEnabled(!0),await this.onActivate(ci)}catch(pi){throw this._logger.error(`Error during scene activation for scene ${(_i=(hi=this.engine)===null||hi===void 0?void 0:hi.director)===null||_i===void 0?void 0:_i.getSceneName(this)}!`),pi}}async _deactivate(ci){this._logger.debug("Scene.onDeactivate",this),this.input.toggleEnabled(!1),await this.onDeactivate(ci)}_preupdate(ci,hi){this.emit("preupdate",new PreUpdateEvent(ci,hi,this)),this.onPreUpdate(ci,hi)}_postupdate(ci,hi){this.emit("postupdate",new PostUpdateEvent(ci,hi,this)),this.onPostUpdate(ci,hi)}_predraw(ci,hi){this.emit("predraw",new PreDrawEvent(ci,hi,this)),this.onPreDraw(ci,hi)}_postdraw(ci,hi){this.emit("postdraw",new PostDrawEvent(ci,hi,this)),this.onPostDraw(ci,hi)}update(ci,hi){var _i;if(!this.isInitialized){this._logger.warnOnce(`Scene update called before initialize for scene ${(_i=ci.director)===null||_i===void 0?void 0:_i.getSceneName(this)}!`);return}this._preupdate(ci,hi);let pi,mi;for(pi=0,mi=this._cancelQueue.length;pi<mi;pi++)this.removeTimer(this._cancelQueue[pi]);this._cancelQueue.length=0;for(const gi of this._timers)gi.update(hi);this.world.update(SystemType.Update,hi),this.camera&&this.camera.update(ci,hi),this._collectActorStats(ci),this._postupdate(ci,hi),this.input.update()}draw(ci,hi){var _i;if(!this.isInitialized){this._logger.warnOnce("Scene draw called before initialize!");return}this._predraw(ci,hi),this.world.update(SystemType.Draw,hi),!((_i=this.engine)===null||_i===void 0)&&_i.isDebug&&this.debugDraw(ci),this._postdraw(ci,hi)}debugDraw(ci){this.emit("predebugdraw",new PreDebugDrawEvent(ci,this)),this.emit("postdebugdraw",new PostDebugDrawEvent(ci,this))}contains(ci){return this.actors.indexOf(ci)>-1}add(ci){if(this.emit("entityadded",{target:ci}),ci instanceof Timer){contains(this._timers,ci)||this.addTimer(ci);return}this.world.add(ci),ci.scene=this}transfer(ci){let hi;ci instanceof Entity&&ci.scene&&ci.scene!==this&&(hi=ci.scene,ci.scene.world.remove(ci,!1)),ci instanceof Timer&&ci.scene&&(hi=ci.scene,ci.scene.removeTimer(ci)),hi==null||hi.emit("entityremoved",{target:ci}),this.add(ci)}remove(ci){this.emit("entityremoved",{target:ci}),ci instanceof Entity&&(ci.isActive&&ci.kill(),this.world.remove(ci)),ci instanceof Timer&&this.removeTimer(ci)}clear(ci=!0){for(let hi=this.entities.length-1;hi>=0;hi--)this.world.remove(this.entities[hi],ci);for(let hi=this.timers.length-1;hi>=0;hi--)this.removeTimer(this.timers[hi])}addTimer(ci){return this._timers.push(ci),ci.scene=this,ci}removeTimer(ci){const hi=this._timers.indexOf(ci);return hi!==-1&&this._timers.splice(hi,1),ci}cancelTimer(ci){return this._cancelQueue.push(ci),ci}isTimerActive(ci){return this._timers.indexOf(ci)>-1&&!ci.complete}isCurrentScene(){return this.engine?this.engine.currentScene===this:!1}_collectActorStats(ci){const hi=this.actors;for(let _i=0;_i<hi.length;_i++){const pi=hi[_i];pi instanceof ScreenElement&&ci.stats.currFrame.actors.ui++,ci.stats.currFrame.actors.alive++;for(let mi=0;mi<pi.children.length;mi++){const gi=pi.children[mi];isScreenElement(gi)?ci.stats.currFrame.actors.ui++:ci.stats.currFrame.actors.alive++}}}}var ColorBlindnessMode;(function(fi){fi.Protanope="Protanope",fi.Deuteranope="Deuteranope",fi.Tritanope="Tritanope"})(ColorBlindnessMode||(ColorBlindnessMode={}));const color_blind_fragment=`#version 300 es\r
precision mediump float;\r
// our texture\r
uniform sampler2D u_image;\r
// the texCoords passed in from the vertex shader.\r
in vec2 v_texcoord;\r
\r
// color blind type\r
uniform int u_type;\r
\r
// simulation?\r
uniform bool u_simulate;\r
\r
out vec4 fragColor;\r
\r
void main() {\r
  vec4 o =  texture(u_image, v_texcoord);\r
  // RGB to LMS matrix conversion\r
  float L = (17.8824 * o.r) + (43.5161 * o.g) + (4.11935 * o.b);\r
  float M = (3.45565 * o.r) + (27.1554 * o.g) + (3.86714 * o.b);\r
  float S = (0.0299566 * o.r) + (0.184309 * o.g) + (1.46709 * o.b);\r
  // Simulate color blindness\r
  float l;\r
  float m;\r
  float s;\r
  //MODE CODE//\r
  if (u_type == 0) {\r
    // Protanope\r
    l = 0.0 * L + 2.02344 * M + -2.52581 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;;\r
  } else if (u_type == 1) {\r
    // Deuteranope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.494207 * L + 0.0 * M + 1.24827 * S;\r
    s = 0.0 * L + 0.0 * M + 1.0 * S;\r
  } else if (u_type == 2) {\r
    // Tritanope\r
    l = 1.0 * L + 0.0 * M + 0.0 * S;\r
    m = 0.0 * L + 1.0 * M + 0.0 * S;\r
    s = -0.395913 * L + 0.801109 * M + 0.0 * S;\r
  }\r
\r
  // LMS to RGB matrix conversion\r
  vec4 error; // simulate the colors\r
  error.r = (0.0809444479 * l) + (-0.130504409 * m) + (0.116721066 * s);\r
  error.g = (-0.0102485335 * l) + (0.0540193266 * m) + (-0.113614708 * s);\r
  error.b = (-0.000365296938 * l) + (-0.00412161469 * m) + (0.693511405 * s);\r
  error.a = 1.0;\r
  vec4 diff = o - error;\r
  vec4 correction; // correct the colors\r
  correction.r = 0.0;\r
  correction.g =  (diff.r * 0.7) + (diff.g * 1.0);\r
  correction.b =  (diff.r * 0.7) + (diff.b * 1.0);\r
  correction = o + correction;\r
  correction.a = o.a;\r
  //SIMULATE//\r
\r
  // sim \r
  if (u_simulate) {\r
    fragColor = error.rgba;\r
  } else {\r
    fragColor = correction.rgba;\r
  }\r
}`;class ScreenShader{constructor(ci,hi){this._shader=new Shader({gl:ci,vertexSource:`#version 300 es
      in vec2 a_position;
      in vec2 a_uv;
      out vec2 v_texcoord;
      out vec2 v_uv;

      void main() {
        gl_Position = vec4(a_position, 0.0, 1.0);
        // Pass the texcoord to the fragment shader.
        v_texcoord = a_uv;
        v_uv = a_uv;
      }`,fragmentSource:hi}),this._shader.compile(),this._buffer=new VertexBuffer({gl:ci,type:"static",data:new Float32Array([-1,-1,0,0,-1,1,0,1,1,-1,1,0,1,-1,1,0,-1,1,0,1,1,1,1,1])}),this._layout=new VertexLayout({gl:ci,shader:this._shader,vertexBuffer:this._buffer,attributes:[["a_position",2],["a_uv",2]]}),this._buffer.upload()}getShader(){return this._shader}getLayout(){return this._layout}}class ColorBlindnessPostProcessor{constructor(ci,hi=!1){this._colorBlindnessMode=ci,this._simulate=!1,this._simulate=hi}initialize(ci){this._shader=new ScreenShader(ci,color_blind_fragment),this.simulate=this._simulate,this.colorBlindnessMode=this._colorBlindnessMode}getShader(){return this._shader.getShader()}getLayout(){return this._shader.getLayout()}set colorBlindnessMode(ci){if(this._colorBlindnessMode=ci,this._shader){const hi=this._shader.getShader();hi.use(),this._colorBlindnessMode===ColorBlindnessMode.Protanope?hi.setUniformInt("u_type",0):this._colorBlindnessMode===ColorBlindnessMode.Deuteranope?hi.setUniformInt("u_type",1):this._colorBlindnessMode===ColorBlindnessMode.Tritanope&&hi.setUniformInt("u_type",2)}}get colorBlindnessMode(){return this._colorBlindnessMode}set simulate(ci){if(this._simulate=ci,this._shader){const hi=this._shader.getShader();hi.use(),hi.setUniformBoolean("u_simulate",ci)}}get simulate(){return this._simulate}}class ColorBlindFlags{constructor(ci){this._engine=ci,this._colorBlindPostProcessor=new ColorBlindnessPostProcessor(ColorBlindnessMode.Protanope)}correct(ci){this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=ci,this._colorBlindPostProcessor.simulate=!1,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}simulate(ci){this._engine.graphicsContext instanceof ExcaliburGraphicsContextWebGL&&(this.clear(),this._colorBlindPostProcessor.colorBlindnessMode=ci,this._colorBlindPostProcessor.simulate=!0,this._engine.graphicsContext.addPostProcessor(this._colorBlindPostProcessor))}clear(){this._engine.graphicsContext.removePostProcessor(this._colorBlindPostProcessor)}}class DebugConfig{constructor(ci){this.stats={currFrame:new FrameStats,prevFrame:new FrameStats},this.filter={useFilter:!1,nameQuery:"",ids:[]},this.entity={showAll:!1,showId:!1,showName:!1},this.transform={showAll:!1,debugZIndex:1e7,showPosition:!1,showPositionLabel:!1,positionColor:Color.Yellow,showZIndex:!1,showScale:!1,scaleColor:Color.Green,showRotation:!1,rotationColor:Color.Blue},this.graphics={showAll:!1,showBounds:!1,boundsColor:Color.Yellow},this.collider={showAll:!1,showBounds:!1,boundsColor:Color.Blue,showOwner:!1,showGeometry:!0,geometryColor:Color.Green,geometryLineWidth:1,geometryPointSize:.5},this.physics={showAll:!1,showBroadphaseSpacePartitionDebug:!1,showCollisionNormals:!1,collisionNormalColor:Color.Cyan,showCollisionContacts:!0,contactSize:2,collisionContactColor:Color.Red},this.motion={showAll:!1,showVelocity:!1,velocityColor:Color.Yellow,showAcceleration:!1,accelerationColor:Color.Red},this.body={showAll:!1,showCollisionGroup:!1,showCollisionType:!1,showSleeping:!1,showMotion:!1,showMass:!1},this.camera={showAll:!1,showFocus:!1,focusColor:Color.Red,showZoom:!1},this.tilemap={showAll:!1,showGrid:!1,gridColor:Color.Red,gridWidth:.5,showSolidBounds:!1,solidBoundsColor:Color.fromHex("#8080807F"),showColliderGeometry:!0},this.isometric={showAll:!1,showPosition:!1,positionColor:Color.Yellow,positionSize:1,showGrid:!1,gridColor:Color.Red,gridWidth:1,showColliderGeometry:!0},this._engine=ci,this.colorBlindMode=new ColorBlindFlags(this._engine)}useTestClock(){const ci=this._engine.clock,hi=ci.isRunning();ci.stop();const _i=ci.toTestClock();return hi&&_i.start(),this._engine.clock=_i,_i}useStandardClock(){const ci=this._engine.clock,hi=ci.isRunning();ci.stop();const _i=ci.toStandardClock();return hi&&_i.start(),this._engine.clock=_i,_i}}class FrameStats{constructor(){this._id=0,this._elapsedMs=0,this._fps=0,this._actorStats={alive:0,killed:0,ui:0,get remaining(){return this.alive-this.killed},get total(){return this.remaining+this.ui}},this._durationStats={update:0,draw:0,get total(){return this.update+this.draw}},this._physicsStats=new PhysicsStats,this._graphicsStats={drawCalls:0,drawnImages:0}}reset(ci){ci?(this.id=ci.id,this.elapsedMs=ci.elapsedMs,this.fps=ci.fps,this.actors.alive=ci.actors.alive,this.actors.killed=ci.actors.killed,this.actors.ui=ci.actors.ui,this.duration.update=ci.duration.update,this.duration.draw=ci.duration.draw,this._physicsStats.reset(ci.physics),this.graphics.drawCalls=ci.graphics.drawCalls,this.graphics.drawnImages=ci.graphics.drawnImages):(this.id=this.elapsedMs=this.fps=0,this.actors.alive=this.actors.killed=this.actors.ui=0,this.duration.update=this.duration.draw=0,this._physicsStats.reset(),this.graphics.drawnImages=this.graphics.drawCalls=0)}clone(){const ci=new FrameStats;return ci.reset(this),ci}get id(){return this._id}set id(ci){this._id=ci}get elapsedMs(){return this._elapsedMs}set elapsedMs(ci){this._elapsedMs=ci}get fps(){return this._fps}set fps(ci){this._fps=ci}get actors(){return this._actorStats}get duration(){return this._durationStats}get physics(){return this._physicsStats}get graphics(){return this._graphicsStats}}class PhysicsStats{constructor(){this._pairs=0,this._collisions=0,this._contacts=new Map,this._fastBodies=0,this._fastBodyCollisions=0,this._broadphase=0,this._narrowphase=0}reset(ci){ci?(this.pairs=ci.pairs,this.collisions=ci.collisions,this.contacts=ci.contacts,this.fastBodies=ci.fastBodies,this.fastBodyCollisions=ci.fastBodyCollisions,this.broadphase=ci.broadphase,this.narrowphase=ci.narrowphase):(this.pairs=this.collisions=this.fastBodies=0,this.fastBodyCollisions=this.broadphase=this.narrowphase=0,this.contacts.clear())}clone(){const ci=new PhysicsStats;return ci.reset(this),ci}get pairs(){return this._pairs}set pairs(ci){this._pairs=ci}get collisions(){return this._collisions}set collisions(ci){this._collisions=ci}get contacts(){return this._contacts}set contacts(ci){this._contacts=ci}get fastBodies(){return this._fastBodies}set fastBodies(ci){this._fastBodies=ci}get fastBodyCollisions(){return this._fastBodyCollisions}set fastBodyCollisions(ci){this._fastBodyCollisions=ci}get broadphase(){return this._broadphase}set broadphase(ci){this._broadphase=ci}get narrowphase(){return this._narrowphase}set narrowphase(ci){this._narrowphase=ci}}class BrowserComponent{on(ci,hi){this._nativeHandlers[ci]&&this.off(ci,this._nativeHandlers[ci]),this._nativeHandlers[ci]=this._decorate(hi),this.nativeComponent.addEventListener(ci,this._nativeHandlers[ci])}off(ci,hi){hi||(hi=this._nativeHandlers[ci]),this.nativeComponent.removeEventListener(ci,hi),this._nativeHandlers[ci]=null}_decorate(ci){return hi=>{this._paused||ci(hi)}}pause(){this._paused=!0}resume(){this._paused=!1}clear(){for(const ci in this._nativeHandlers)this.off(ci)}constructor(ci){this.nativeComponent=ci,this._paused=!1,this._nativeHandlers={}}}class BrowserEvents{constructor(ci,hi){this._windowGlobal=ci,this._documentGlobal=hi,this._windowComponent=new BrowserComponent(this._windowGlobal),this._documentComponent=new BrowserComponent(this._documentGlobal)}get window(){return this._windowComponent}get document(){return this._documentComponent}pause(){this.window.pause(),this.document.pause()}resume(){this.window.resume(),this.document.resume()}clear(){this.window.clear(),this.document.clear()}}const DefaultAntialiasOptions={pixelArtSampler:!1,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ImageFiltering.Blended,canvasImageRendering:"auto"},DefaultPixelArtOptions={pixelArtSampler:!0,nativeContextAntialiasing:!1,multiSampleAntialiasing:!0,filtering:ImageFiltering.Blended,canvasImageRendering:"auto"};class FpsSampler{constructor(ci){var hi;this._samplePeriod=100,this._currentFrameTime=0,this._frames=0,this._previousSampleTime=0,this._beginFrameTime=0,this._fps=ci.initialFps,this._samplePeriod=(hi=ci.samplePeriod)!==null&&hi!==void 0?hi:this._samplePeriod,this._currentFrameTime=1e3/ci.initialFps,this._nowFn=ci.nowFn,this._previousSampleTime=this._nowFn()}start(){this._beginFrameTime=this._nowFn()}end(){this._frames++;const ci=this._nowFn();this._currentFrameTime=ci-this._beginFrameTime,ci>=this._previousSampleTime+this._samplePeriod&&(this._fps=this._frames*1e3/(ci-this._previousSampleTime),this._previousSampleTime=ci,this._frames=0)}get fps(){return this._fps}get instant(){return 1e3/this._currentFrameTime}}class Clock{constructor(ci){var hi,_i,pi;this._onFatalException=()=>{},this._maxFps=1/0,this._lastTime=0,this._elapsed=1,this._scheduledCbs=[],this._totalElapsed=0,this._options=ci,this.tick=ci.tick,this._lastTime=(hi=this.now())!==null&&hi!==void 0?hi:0,this._maxFps=(_i=ci.maxFps)!==null&&_i!==void 0?_i:this._maxFps,this._onFatalException=(pi=ci.onFatalException)!==null&&pi!==void 0?pi:this._onFatalException,this.fpsSampler=new FpsSampler({initialFps:60,nowFn:()=>this.now()})}elapsed(){return this._elapsed}now(){return performance.now()}toTestClock(){return new TestClock({...this._options,defaultUpdateMs:16.6})}toStandardClock(){return new StandardClock({...this._options})}setFatalExceptionHandler(ci){this._onFatalException=ci}schedule(ci,hi=0,_i="preframe"){const pi=this._totalElapsed+hi;this._scheduledCbs.push([ci,pi,_i])}__runScheduledCbs(ci="preframe"){for(let hi=this._scheduledCbs.length-1;hi>-1;hi--)ci===this._scheduledCbs[hi][2]&&this._scheduledCbs[hi][1]<=this._totalElapsed&&(this._scheduledCbs[hi][0](this._elapsed),this._scheduledCbs.splice(hi,1))}update(ci){try{this.fpsSampler.start();const hi=this.now();let _i=hi-this._lastTime||1;const pi=1e3/this._maxFps;if(_i>=pi){let mi=0;pi!==0&&(mi=_i%pi,_i=_i-mi),_i>200&&(_i=1),this._elapsed=ci||_i,this._totalElapsed+=this._elapsed,this.__runScheduledCbs("preframe"),this.tick(ci||_i),this.__runScheduledCbs("postframe"),pi!==0?this._lastTime=hi-mi:this._lastTime=hi,this.fpsSampler.end()}}catch(hi){this._onFatalException(hi),this.stop()}}}class StandardClock extends Clock{constructor(ci){super(ci),this._running=!1}isRunning(){return this._running}start(){if(this._running)return;this._running=!0;const ci=()=>{if(this._running)try{this._requestId=window.requestAnimationFrame(ci),this.update()}catch(hi){throw window.cancelAnimationFrame(this._requestId),hi}};ci()}stop(){window.cancelAnimationFrame(this._requestId),this._running=!1}}class TestClock extends Clock{constructor(ci){super({...ci}),this._logger=Logger.getInstance(),this._running=!1,this._currentTime=0,this._updateMs=ci.defaultUpdateMs}now(){var ci;return(ci=this._currentTime)!==null&&ci!==void 0?ci:0}isRunning(){return this._running}start(){this._running=!0}stop(){this._running=!1}step(ci){const hi=ci??this._updateMs;this._running?(this.update(hi),this._currentTime+=hi):this._logger.warn("The clock is not running, no step will be performed")}run(ci,hi){for(let _i=0;_i<ci;_i++)this.step(hi??this._updateMs)}}var Util_Toaster=__webpack_require__(296);class Toaster{constructor(){this._toasterCss=Util_Toaster.A.toString(),this._isInitialized=!1}_initialize(){this._isInitialized||(this._container=document.createElement("div"),this._container.id="ex-toast-container",document.body.appendChild(this._container),this._isInitialized=!0,this._styleBlock=document.createElement("style"),this._styleBlock.textContent=this._toasterCss,document.head.appendChild(this._styleBlock))}dispose(){this._container.parentElement.removeChild(this._container),this._styleBlock.parentElement.removeChild(this._styleBlock),this._isInitialized=!1}_createFragment(ci){const hi=document.createElement("span");return hi.innerText=ci,hi}toast(ci,hi,_i){this._initialize();const pi=document.createElement("div");pi.className="ex-toast-message";const mi=ci.split("[LINK]").map(yi=>this._createFragment(yi));if(hi){const yi=document.createElement("a");yi.href=hi,_i?yi.innerText=_i:yi.innerText=hi,mi.splice(1,0,yi)}const gi=document.createElement("div");mi.forEach(yi=>{gi.appendChild(yi)}),pi.appendChild(gi);const vi=document.createElement("button");vi.innerText="x",vi.addEventListener("click",()=>{this._container.removeChild(pi)}),pi.appendChild(vi);const xi=yi=>{if(yi.key==="Escape")try{this._container.removeChild(pi)}catch{}document.removeEventListener("keydown",xi)};document.addEventListener("keydown",xi);const wi=this._container.firstChild;this._container.insertBefore(pi,wi)}}const DirectorEvents={NavigationStart:"navigationstart",Navigation:"navigation",NavigationEnd:"navigationend"};class Director{get isTransitioning(){return this._isTransitioning}constructor(ci,hi){this._engine=ci,this.events=new EventEmitter,this._logger=Logger.getInstance(),this._initialized=!1,this.scenes={},this._sceneToInstance=new Map,this._sceneToLoader=new Map,this._sceneToTransition=new Map,this._loadedScenes=new Set,this._isTransitioning=!1,this.rootScene=this.currentScene=new Scene,this.add("root",this.rootScene),this.currentScene=this.rootScene,this.currentSceneName="root";for(const _i in hi){const pi=hi[_i];this.add(_i,pi),_i==="root"&&(this.rootScene=this.getSceneInstance("root"),this.currentScene=this.rootScene)}}async onInitialize(){if(!this._initialized)if(this._initialized=!0,this._deferredGoto){const ci=this._deferredGoto;this._deferredGoto=void 0;const hi=this._deferredTransition;this._deferredTransition=void 0;const _i=this.getSceneInstance(ci);_i&&hi&&hi._addToTargetScene(this._engine,_i),await this.swapScene(ci),_i&&hi&&await this.playTransition(hi,_i)}else await this.swapScene("root")}get isInitialized(){return this._initialized}configureStart(ci,hi){const _i=hi==null?void 0:hi.loader;_i instanceof DefaultLoader?this.mainLoader=_i:isLoaderConstructor(_i)?this.mainLoader=new _i:this.mainLoader=new Loader;let pi;if(hi!=null&&hi.inTransition){const{inTransition:mi}=hi;pi=mi}if(this.startScene=ci,pi){const mi=this.getSceneInstance(this.startScene);mi&&(pi._addToTargetScene(this._engine,mi),this.swapScene(this.startScene).then(()=>this.playTransition(pi,mi)))}else this.swapScene(this.startScene);this.currentSceneName=this.startScene}_getLoader(ci){return this._sceneToLoader.get(ci)}_getInTransition(ci){var hi;const _i=this.scenes[ci];if(!(_i instanceof Scene||isSceneConstructor(_i)))return(hi=_i==null?void 0:_i.transitions)===null||hi===void 0?void 0:hi.in}_getOutTransition(ci){var hi;const _i=this.scenes[ci];if(!(_i instanceof Scene||isSceneConstructor(_i)))return(hi=_i==null?void 0:_i.transitions)===null||hi===void 0?void 0:hi.out}getDeferredScene(){const ci=this.getSceneDefinition(this._deferredGoto);return this._deferredGoto&&ci?ci:null}getSceneDefinition(ci){const hi=this.scenes[ci];if(hi instanceof Scene||isSceneConstructor(hi))return hi;if(hi)return hi.scene}getSceneName(ci){for(const[hi,_i]of Object.entries(this.scenes))if(_i instanceof Scene){if(ci===_i)return hi}else if(!isSceneConstructor(_i)&&ci===_i.scene)return hi;for(const[hi,_i]of Object.entries(this.scenes))if(isSceneConstructor(_i)){if(ci.constructor===_i)return hi}else if(!(_i instanceof Scene)&&ci.constructor===_i.scene)return hi;return null}assertAdded(ci){return this}assertRemoved(ci){return this}add(ci,hi){if(!(hi instanceof Scene)&&!isSceneConstructor(hi)){const{loader:_i,transitions:pi}=hi,{in:mi,out:gi}=pi??{};this._sceneToTransition.set(ci,{in:mi,out:gi}),isLoaderConstructor(_i)?this._sceneToLoader.set(ci,new _i):_i&&this._sceneToLoader.set(ci,_i)}return this.scenes[ci]&&this._logger.warn("Scene",ci,"already exists overwriting"),this.scenes[ci]=hi,this.assertAdded(ci)}remove(ci){if(ci instanceof Scene||isSceneConstructor(ci)){const hi=ci;for(const _i in this.scenes)if(this.scenes.hasOwnProperty(_i)){const pi=this.scenes[_i];let mi;if(pi instanceof Scene||isSceneConstructor(pi)?mi=pi:mi=pi.scene,mi===hi){if(_i===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${_i}`);this._sceneToInstance.delete(_i),this._sceneToTransition.delete(_i),this._sceneToLoader.delete(_i),delete this.scenes[_i]}}}if(typeof ci=="string"){if(ci===this.currentSceneName)throw new Error(`Cannot remove a currently active scene: ${ci}`);this._sceneToInstance.delete(ci),this._sceneToTransition.delete(ci),this._sceneToLoader.delete(ci),delete this.scenes[ci]}}async goToScene(ci,hi){var _i,pi,mi,gi,vi,xi;const wi=this.getSceneInstance(ci);if(!wi){this._logger.warn(`Scene ${ci} does not exist! Check the name, are you sure you added it?`);return}const yi=this.currentScene,Ci=this.currentSceneName,Ei=(pi=(_i=this._engine.input)===null||_i===void 0?void 0:_i.enabled)!==null&&pi!==void 0?pi:!0;this._isTransitioning=!0;const Si=(mi=this.getSceneInstance(Ci))===null||mi===void 0?void 0:mi.onTransition("out"),ki=wi==null?void 0:wi.onTransition("in");hi={sourceOut:(gi=this._getOutTransition(this.currentSceneName))!==null&&gi!==void 0?gi:Si,destinationIn:(vi=this._getInTransition(ci))!==null&&vi!==void 0?vi:ki,...hi};const{sourceOut:Ai,destinationIn:Ii,sceneActivationData:Ti}=hi,Pi=Ai??this._getOutTransition(this.currentSceneName),Li=Ii??this._getInTransition(ci),Ri=(Pi==null?void 0:Pi.hideLoader)||(Li==null?void 0:Li.hideLoader);Ri&&this.maybeLoadScene(ci,Ri),this._emitEvent("navigationstart",Ci,ci),Pi&&await this.playTransition(Pi,yi),await this.maybeLoadScene(ci,Ri),Li&&await Li.onPreviousSceneDeactivate(this.currentScene),Li&&Li._addToTargetScene(this._engine,wi),await this.swapScene(ci,Ti),this._emitEvent("navigation",Ci,ci),Li&&await this.playTransition(Li,wi),this._emitEvent("navigationend",Ci,ci),(xi=this._engine.input)===null||xi===void 0||xi.toggleEnabled(Ei),this._isTransitioning=!1}getSceneInstance(ci){const hi=this.getSceneDefinition(ci);if(!hi)return;if(this._sceneToInstance.has(ci))return this._sceneToInstance.get(ci);if(hi instanceof Scene)return this._sceneToInstance.set(ci,hi),hi;const _i=new hi;return this._sceneToInstance.set(ci,_i),_i}async maybeLoadScene(ci,hi=!1){var _i;const pi=(_i=this._getLoader(ci))!==null&&_i!==void 0?_i:new DefaultLoader,mi=this.getSceneDefinition(ci),gi=this.getSceneInstance(ci);mi&&gi&&!this._loadedScenes.has(gi)&&(gi.onPreLoad(pi),gi.events.emit("preload",{loader:pi}),hi?this._engine.load(pi,hi):await this._engine.load(pi),this._loadedScenes.add(gi))}async playTransition(ci,hi){var _i,pi,mi,gi,vi,xi,wi;if(!this.isInitialized){this._deferredTransition=ci;return}if(ci){this.currentTransition=ci;const yi=(pi=(_i=hi.input)===null||_i===void 0?void 0:_i.enabled)!==null&&pi!==void 0?pi:!0;(mi=hi.input)===null||mi===void 0||mi.toggleEnabled(!ci.blockInput),(gi=this._engine.input)===null||gi===void 0||gi.toggleEnabled(!ci.blockInput),this.currentTransition._addToTargetScene(this._engine,hi),await this.currentTransition._play(),(vi=hi.input)===null||vi===void 0||vi.toggleEnabled(yi)}(xi=this.currentTransition)===null||xi===void 0||xi.kill(),(wi=this.currentTransition)===null||wi===void 0||wi.reset(),this.currentTransition=void 0}async swapScene(ci,hi){const _i=this._engine;if(!this.isInitialized){this._deferredGoto=ci;return}const pi=this.getSceneInstance(ci);if(pi){const mi=this.currentScene,gi=pi;if(this._logger.debug("Going to scene:",ci),this.currentScene.isInitialized){const wi={engine:_i,previousScene:mi,nextScene:gi};await this.currentScene._deactivate(wi),this.currentScene.events.emit("deactivate",new DeactivateEvent(wi,this.currentScene)),this.currentScene.input.clear()}const vi=this._sceneToLoader.get(ci);await(vi==null?void 0:vi.areResourcesLoaded()),this.currentScene=gi,this.currentSceneName=ci,_i.screen.setCurrentCamera(gi.camera),await this.currentScene._initialize(_i);const xi={engine:_i,previousScene:mi,nextScene:gi,data:hi};await this.currentScene._activate(xi),this.currentScene.events.emit("activate",new ActivateEvent(xi,this.currentScene))}else this._logger.error("Scene",ci,"does not exist!")}_emitEvent(ci,hi,_i){const pi=this.getSceneDefinition(hi),mi=this.getSceneDefinition(_i);this.events.emit(ci,{sourceScene:pi,sourceName:hi,destinationScene:mi,destinationName:_i})}}function createContext(){const fi={scope:(ci,hi)=>{const _i=fi.value;fi.value=ci;try{return hi()}catch(pi){throw pi}finally{fi.value=_i}},value:void 0};return fi}function useContext(fi){return fi.value}const DefaultGarbageCollectionOptions={textureCollectInterval:6e4};class GarbageCollector{constructor(ci){this.options=ci,this._running=!1,this._collectionMap=new Map,this._collectors=new Map,this.collectStaleResources=hi=>{if(this._running){for(const[_i,[pi,mi]]of this._collectors.entries()){const gi=this.options.getTimestamp();for(const[vi,[xi,wi]]of this._collectionMap.entries()){if(_i!==xi||wi+mi>=gi)continue;pi(vi)&&this._collectionMap.delete(vi)}}this._collectHandle=requestIdleCallback(this.collectStaleResources)}}}registerCollector(ci,hi,_i){this._collectors.set(ci,[_i,hi])}addCollectableResource(ci,hi){this._collectionMap.set(hi,[ci,this.options.getTimestamp()])}touch(ci){const hi=this._collectionMap.get(ci);hi&&this._collectionMap.set(ci,[hi[0],this.options.getTimestamp()])}forceCollectAll(){for(const[ci,[hi]]of this._collectors.entries())for(const[_i]of this._collectionMap.entries())hi(_i)&&this._collectionMap.delete(_i)}start(){this._running=!0,this.collectStaleResources()}stop(){this._running=!1,cancelIdleCallback(this._collectHandle)}}polyfill();const EngineEvents={FallbackGraphicsContext:"fallbackgraphicscontext",Initialize:"initialize",Visible:"visible",Hidden:"hidden",Start:"start",Stop:"stop",PreUpdate:"preupdate",PostUpdate:"postupdate",PreFrame:"preframe",PostFrame:"postframe",PreDraw:"predraw",PostDraw:"postdraw"};var ScrollPreventionMode;(function(fi){fi[fi.None=0]="None",fi[fi.Canvas=1]="Canvas",fi[fi.All=2]="All"})(ScrollPreventionMode||(ScrollPreventionMode={}));class Engine{static useEngine(){const ci=useContext(Engine.Context);if(!ci)throw new Error("Cannot inject engine with `useEngine()`, `useEngine()` was called outside of Engine lifecycle scope.");return ci}get canvasWidth(){return this.screen.canvasWidth}get halfCanvasWidth(){return this.screen.halfCanvasWidth}get canvasHeight(){return this.screen.canvasHeight}get halfCanvasHeight(){return this.screen.halfCanvasHeight}get drawWidth(){return this.screen.drawWidth}get halfDrawWidth(){return this.screen.halfDrawWidth}get drawHeight(){return this.screen.drawHeight}get halfDrawHeight(){return this.screen.halfDrawHeight}get isHiDpi(){return this.screen.isHiDpi}get stats(){return this.debug.stats}get currentScene(){return this.director.currentScene}get currentSceneName(){return this.director.currentSceneName}get rootScene(){return this.director.rootScene}get scenes(){return this.director.scenes}get isFullscreen(){return this.screen.isFullScreen}get displayMode(){return this.screen.displayMode}get pixelRatio(){return this.screen.pixelRatio}get isDebug(){return this._isDebug}get snapToPixel(){return this.graphicsContext.snapToPixel}set snapToPixel(ci){this.graphicsContext.snapToPixel=ci}emit(ci,hi){this.events.emit(ci,hi)}on(ci,hi){return this.events.on(ci,hi)}once(ci,hi){return this.events.once(ci,hi)}off(ci,hi){this.events.off(ci,hi)}constructor(ci){var hi,_i,pi,mi,gi,vi,xi,wi,yi;this.scope=Ri=>Engine.Context.scope(this,Ri),this.version=EX_VERSION,this.events=new EventEmitter,this.maxFps=Number.POSITIVE_INFINITY,this._inputEnabled=!0,this._suppressPlayButton=!1,this.pauseAudioWhenHidden=!0,this._isDebug=!1,this.enableCanvasTransparency=!0,this.onFatalException=Ri=>{Logger.getInstance().fatal(Ri,Ri.stack)},this._toaster=new Toaster,this._timescale=1,this._isInitialized=!1,this._originalOptions={},this._handleWebGLContextLost=Ri=>{var Di;Ri.preventDefault(),this.clock.stop(),this._logger.fatalOnce("WebGL Graphics Lost",Ri);const Fi=document.createElement("div");Fi.id="ex-webgl-graphics-context-lost",Fi.style.position="absolute",Fi.style.zIndex="99",Fi.style.left="50%",Fi.style.top="50%",Fi.style.display="flex",Fi.style.flexDirection="column",Fi.style.transform="translate(-50%, -50%)",Fi.style.backgroundColor="white",Fi.style.padding="10px",Fi.style.borderStyle="solid 1px";const Mi=document.createElement("div");if(Mi.innerHTML=`
      <h1>There was an issue rendering, please refresh the page.</h1>
      <div>
        <p>WebGL Graphics Context Lost</p>

        <button id="ex-webgl-graphics-reload">Refresh Page</button>

        <p>There are a few reasons this might happen:</p>
        <ul>
          <li>Two or more pages are placing a high demand on the GPU</li>
          <li>Another page or operation has stalled the GPU and the browser has decided to reset the GPU</li>
          <li>The computer has multiple GPUs and the user has switched between them</li>
          <li>Graphics driver has crashed or restarted</li>
          <li>Graphics driver was updated</li>
        </ul>
      </div>
    `,Fi.appendChild(Mi),!((Di=this.canvas)===null||Di===void 0)&&Di.parentElement){this.canvas.parentElement.appendChild(Fi);const $i=Mi.querySelector("#ex-webgl-graphics-reload");$i==null||$i.addEventListener("click",()=>location.reload())}},this._performanceThresholdTriggered=!1,this._fpsSamples=[],this._disposed=!1,this._isLoading=!1,this._hideLoader=!1,this._isReadyFuture=new Future,this.currentFrameElapsedMs=0,this.currentFrameLagMs=0,this._lagMs=0,this._screenShotRequests=[],ci={...Engine._DEFAULT_ENGINE_OPTIONS,...ci},this._originalOptions=ci,Flags.freeze(),this.browser=new BrowserEvents(window,document);const Ci=new Detector;if(!ci.suppressMinimumBrowserFeatureDetection&&!(this._compatible=Ci.test())){const Ri=document.createElement("div");if(Ri.innerText="Sorry, your browser does not support all the features needed for Excalibur",document.body.appendChild(Ri),Ci.failedTests.forEach(function(Di){const Fi=document.createElement("div");Fi.innerText="Browser feature missing "+Di,document.body.appendChild(Fi)}),ci.canvasElementId){const Di=document.getElementById(ci.canvasElementId);Di&&Di.parentElement.removeChild(Di)}return}else this._compatible=!0;if(console.log&&!ci.suppressConsoleBootMessage&&(console.log(`%cPowered by Excalibur.js (v${EX_VERSION})`,"background: #176BAA; color: white; border-radius: 5px; padding: 15px; font-size: 1.5em; line-height: 80px;"),console.log(`
      /| ________________
O|===|* >________________>
      \\|`),console.log("Visit","http://excaliburjs.com","for more information")),ci.suppressPlayButton&&(this._suppressPlayButton=!0),this._logger=Logger.getInstance(),this._logger.defaultLevel===LogLevel.Debug&&Ci.logBrowserFeatures(),this._logger.debug("Building engine..."),ci.garbageCollection===!0?this.garbageCollectorConfig={...DefaultGarbageCollectionOptions}:ci.garbageCollection===!1?(this._logger.warn("WebGL Garbage Collection Disabled!!! If you leak any images over time your game will crash when GPU memory is exhausted"),this.garbageCollectorConfig=null):this.garbageCollectorConfig={...DefaultGarbageCollectionOptions,...ci.garbageCollection},this._garbageCollector=new GarbageCollector({getTimestamp:Date.now}),this.canvasElementId=ci.canvasElementId,ci.canvasElementId){if(this._logger.debug("Using Canvas element specified: "+ci.canvasElementId),document.getElementById(ci.canvasElementId)===null)throw new Error("Cannot find existing element in the DOM, please ensure element is created prior to engine creation.");this.canvas=document.getElementById(ci.canvasElementId)}else ci.canvasElement?(this._logger.debug("Using Canvas element specified:",ci.canvasElement),this.canvas=ci.canvasElement):(this._logger.debug("Using generated canvas element"),this.canvas=document.createElement("canvas"));this.canvas&&!ci.enableCanvasContextMenu&&this.canvas.addEventListener("contextmenu",Ri=>{Ri.preventDefault()});let Ei=(hi=ci.displayMode)!==null&&hi!==void 0?hi:DisplayMode.Fixed;ci.width&&ci.height||ci.viewport?(ci.displayMode===void 0&&(Ei=DisplayMode.Fixed),this._logger.debug("Engine viewport is size "+ci.width+" x "+ci.height)):ci.displayMode||(this._logger.debug("Engine viewport is fit"),Ei=DisplayMode.FitScreen),this.grabWindowFocus=ci.grabWindowFocus,this.pointerScope=ci.pointerScope,this._originalDisplayMode=Ei;let Si,ki,Ai,Ii,Ti,Pi;typeof ci.antialiasing=="object"?{pixelArtSampler:Si,nativeContextAntialiasing:Ai,multiSampleAntialiasing:Pi,filtering:Ti,canvasImageRendering:Ii}={...ci.pixelArt?DefaultPixelArtOptions:DefaultAntialiasOptions,...ci.antialiasing}:(Si=!!ci.pixelArt,Ai=!1,Pi=ci.antialiasing,Ii=ci.antialiasing?"auto":"pixelated",Ti=ci.antialiasing?ImageFiltering.Blended:ImageFiltering.Pixel),Ai&&Pi&&this._logger.warnOnce("Cannot use antialias setting nativeContextAntialiasing and multiSampleAntialiasing at the same time, they are incompatible settings. If you aren't sure use multiSampleAntialiasing"),ci.pixelArt&&(ki=.25),(!ci.antialiasing||Ti===ImageFiltering.Pixel)&&(ki=0),ki=(pi=(_i=ci.uvPadding)!==null&&_i!==void 0?_i:ki)!==null&&pi!==void 0?pi:.01;let Li=Flags.isEnabled("use-canvas-context");if(!Li)try{this.graphicsContext=new ExcaliburGraphicsContextWebGL({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,pixelArtSampler:Si,antialiasing:Ai,multiSampleAntialiasing:Pi,uvPadding:ki,powerPreference:ci.powerPreference,backgroundColor:ci.backgroundColor,snapToPixel:ci.snapToPixel,useDrawSorting:ci.useDrawSorting,garbageCollector:this.garbageCollectorConfig?{garbageCollector:this._garbageCollector,collectionInterval:this.garbageCollectorConfig.textureCollectInterval}:null,handleContextLost:(mi=ci.handleContextLost)!==null&&mi!==void 0?mi:this._handleWebGLContextLost,handleContextRestored:ci.handleContextRestored})}catch(Ri){this._logger.warn(`Excalibur could not load webgl for some reason (${Ri.message}) and loaded a Canvas 2D fallback. Some features of Excalibur will not work in this mode. 

Read more about this issue at https://excaliburjs.com/docs/performance`),Li=!0}Li&&(this.graphicsContext=new ExcaliburGraphicsContext2DCanvas({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:Ai,backgroundColor:ci.backgroundColor,snapToPixel:ci.snapToPixel,useDrawSorting:ci.useDrawSorting})),this.screen=new Screen({canvas:this.canvas,context:this.graphicsContext,antialiasing:Ai,canvasImageRendering:Ii,browser:this.browser,viewport:(gi=ci.viewport)!==null&&gi!==void 0?gi:ci.width&&ci.height?{width:ci.width,height:ci.height}:Resolution.SVGA,resolution:ci.resolution,displayMode:Ei,pixelRatio:ci.suppressHiDPIScaling?1:(vi=ci.pixelRatio)!==null&&vi!==void 0?vi:null}),TextureLoader.filtering=Ti,ci.backgroundColor&&(this.backgroundColor=ci.backgroundColor.clone()),this.maxFps=(xi=ci.maxFps)!==null&&xi!==void 0?xi:this.maxFps,this.fixedUpdateTimestep=(wi=ci.fixedUpdateTimestep)!==null&&wi!==void 0?wi:this.fixedUpdateTimestep,this.fixedUpdateFps=(yi=ci.fixedUpdateFps)!==null&&yi!==void 0?yi:this.fixedUpdateFps,this.fixedUpdateTimestep=this.fixedUpdateTimestep||1e3/this.fixedUpdateFps,this.clock=new StandardClock({maxFps:this.maxFps,tick:this._mainloop.bind(this),onFatalException:Ri=>this.onFatalException(Ri)}),this.enableCanvasTransparency=ci.enableCanvasTransparency,typeof ci.physics=="boolean"?this.physics={...getDefaultPhysicsConfig(),enabled:ci.physics}:(this.physics={...getDefaultPhysicsConfig()},mergeDeep(this.physics,ci.physics)),this.debug=new DebugConfig(this),this.director=new Director(this,ci.scenes),this._initialize(ci),window.___EXCALIBUR_DEVTOOL=this,Engine.InstanceCount++}_monitorPerformanceThresholdAndTriggerFallback(){const{allow:ci}=this._originalOptions.configurePerformanceCanvas2DFallback;let{threshold:hi,showPlayerMessage:_i}=this._originalOptions.configurePerformanceCanvas2DFallback;if(hi===void 0&&(hi=Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.threshold),_i===void 0&&(_i=Engine._DEFAULT_ENGINE_OPTIONS.configurePerformanceCanvas2DFallback.showPlayerMessage),!Flags.isEnabled("use-canvas-context")&&ci&&this.ready&&!this._performanceThresholdTriggered){this._fpsSamples.length===hi.numberOfFrames&&this._fpsSamples.splice(0,1),this._fpsSamples.push(this.clock.fpsSampler.fps);let pi=0;for(let gi=0;gi<this._fpsSamples.length;gi++)pi+=this._fpsSamples[gi];const mi=pi/this._fpsSamples.length;this._fpsSamples.length===hi.numberOfFrames&&mi<=hi.fps&&(this._performanceThresholdTriggered=!0,this._logger.warn(`Switching to browser 2D Canvas fallback due to performance. Some features of Excalibur will not work in this mode.
this might mean your browser doesn't have webgl enabled or hardware acceleration is unavailable.

If in Chrome:
  * Visit Settings > Advanced > System, and ensure "Use Hardware Acceleration" is checked.
  * Visit chrome://flags/#ignore-gpu-blocklist and ensure "Override software rendering list" is "enabled"
If in Firefox, visit about:config
  * Ensure webgl.disabled = false
  * Ensure webgl.force-enabled = true
  * Ensure layers.acceleration.force-enabled = true

Read more about this issue at https://excaliburjs.com/docs/performance`),_i&&this._toaster.toast("Excalibur is encountering performance issues. It's possible that your browser doesn't have hardware acceleration enabled. Visit [LINK] for more information and potential solutions.","https://excaliburjs.com/docs/performance"),this.useCanvas2DFallback(),this.emit("fallbackgraphicscontext",this.graphicsContext))}}useCanvas2DFallback(){var ci,hi,_i;const pi=this.canvas.cloneNode(!1);this.canvas.parentNode.replaceChild(pi,this.canvas),this.canvas=pi;const mi={...this._originalOptions,antialiasing:this.screen.antialiasing},gi=this._originalDisplayMode;this.graphicsContext=new ExcaliburGraphicsContext2DCanvas({canvasElement:this.canvas,enableTransparency:this.enableCanvasTransparency,antialiasing:mi.antialiasing,backgroundColor:mi.backgroundColor,snapToPixel:mi.snapToPixel,useDrawSorting:mi.useDrawSorting}),this.screen&&this.screen.dispose(),this.screen=new Screen({canvas:this.canvas,context:this.graphicsContext,antialiasing:(ci=mi.antialiasing)!==null&&ci!==void 0?ci:!0,browser:this.browser,viewport:(hi=mi.viewport)!==null&&hi!==void 0?hi:mi.width&&mi.height?{width:mi.width,height:mi.height}:Resolution.SVGA,resolution:mi.resolution,displayMode:gi,pixelRatio:mi.suppressHiDPIScaling?1:(_i=mi.pixelRatio)!==null&&_i!==void 0?_i:null}),this.screen.setCurrentCamera(this.currentScene.camera),this.input.pointers.detach();const vi=mi.pointerScope===PointerScope.Document?document:this.canvas;this.input.pointers=this.input.pointers.recreate(vi,this),this.input.pointers.init()}dispose(){this._disposed||(this._disposed=!0,this.stop(),this._garbageCollector.forceCollectAll(),this.input.toggleEnabled(!1),this.canvas.parentNode.removeChild(this.canvas),this.canvas=null,this.screen.dispose(),this.graphicsContext.dispose(),this.graphicsContext=null,Engine.InstanceCount--)}isDisposed(){return this._disposed}getWorldBounds(){return this.screen.getWorldBounds()}get timescale(){return this._timescale}set timescale(ci){if(ci<0){Logger.getInstance().warnOnce("engine.timescale to a value less than 0 are ignored");return}this._timescale=ci}addTimer(ci){return this.currentScene.addTimer(ci)}removeTimer(ci){return this.currentScene.removeTimer(ci)}addScene(ci,hi){return this.director.add(ci,hi),this}removeScene(ci){this.director.remove(ci)}add(ci){if(arguments.length===2){this.director.add(arguments[0],arguments[1]);return}const hi=this.director.getDeferredScene();hi instanceof Scene?hi.add(ci):this.currentScene.add(ci)}remove(ci){ci instanceof Entity&&this.currentScene.remove(ci),(ci instanceof Scene||isSceneConstructor(ci))&&this.removeScene(ci),typeof ci=="string"&&this.removeScene(ci)}async goToScene(ci,hi){await this.scope(async()=>{await this.director.goToScene(ci,hi)})}screenToWorldCoordinates(ci){return this.screen.screenToWorldCoordinates(ci)}worldToScreenCoordinates(ci){return this.screen.worldToScreenCoordinates(ci)}_initialize(ci){var hi,_i;this.pageScrollPreventionMode=ci.scrollPreventionMode;const pi=ci&&ci.pointerScope===PointerScope.Document?document:this.canvas,mi=(_i=(hi=this._originalOptions)===null||hi===void 0?void 0:hi.grabWindowFocus)!==null&&_i!==void 0?_i:!0;this.input=new InputHost({pointerTarget:pi,grabWindowFocus:mi,engine:this}),this.inputMapper=this.input.inputMapper,this.browser.document.on("visibilitychange",()=>{document.visibilityState==="hidden"?(this.events.emit("hidden",new HiddenEvent(this)),this._logger.debug("Window hidden")):document.visibilityState==="visible"&&(this.events.emit("visible",new VisibleEvent(this)),this._logger.debug("Window visible"))}),!this.canvasElementId&&!ci.canvasElement&&document.body.appendChild(this.canvas)}toggleInputEnabled(ci){this._inputEnabled=ci,this.input.toggleEnabled(this._inputEnabled)}onInitialize(ci){}get isInitialized(){return this._isInitialized}async _overrideInitialize(ci){this.isInitialized||(await this.director.onInitialize(),await this.onInitialize(ci),this.events.emit("initialize",new InitializeEvent(ci,this)),this._isInitialized=!0)}_update(ci){var hi;if(this._isLoading){(hi=this._loader)===null||hi===void 0||hi.onUpdate(this,ci),this.input.update();return}this.clock.__runScheduledCbs("preupdate"),this._preupdate(ci),this.currentScene.update(this,ci),this.graphicsContext.updatePostProcessors(ci),this.clock.__runScheduledCbs("postupdate"),this._postupdate(ci),this.input.update()}_preupdate(ci){this.emit("preupdate",new PreUpdateEvent(this,ci,this)),this.onPreUpdate(this,ci)}onPreUpdate(ci,hi){}_postupdate(ci){this.emit("postupdate",new PostUpdateEvent(this,ci,this)),this.onPostUpdate(this,ci)}onPostUpdate(ci,hi){}_draw(ci){var hi,_i;if(this.graphicsContext.backgroundColor=(hi=this.currentScene.backgroundColor)!==null&&hi!==void 0?hi:this.backgroundColor,this.graphicsContext.beginDrawLifecycle(),this.graphicsContext.clear(),this.clock.__runScheduledCbs("predraw"),this._predraw(this.graphicsContext,ci),this._isLoading){this._hideLoader||((_i=this._loader)===null||_i===void 0||_i.canvas.draw(this.graphicsContext,0,0),this.clock.__runScheduledCbs("postdraw"),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle());return}this.currentScene.draw(this.graphicsContext,ci),this.clock.__runScheduledCbs("postdraw"),this._postdraw(this.graphicsContext,ci),this.graphicsContext.flush(),this.graphicsContext.endDrawLifecycle(),this._checkForScreenShots()}_predraw(ci,hi){this.emit("predraw",new PreDrawEvent(ci,hi,this)),this.onPreDraw(ci,hi)}onPreDraw(ci,hi){}_postdraw(ci,hi){this.emit("postdraw",new PostDrawEvent(ci,hi,this)),this.onPostDraw(ci,hi)}onPostDraw(ci,hi){}showDebug(ci){this._isDebug=ci}toggleDebug(){return this._isDebug=!this._isDebug,this._isDebug}get loadingComplete(){return!this._isLoading}get ready(){return this._isReadyFuture.isCompleted}isReady(){return this._isReadyFuture.promise}async start(ci,hi){await this.scope(async()=>{if(!this._compatible)throw new Error("Excalibur is incompatible with your browser");this._isLoading=!0;let _i;return ci instanceof DefaultLoader?_i=ci:typeof ci=="string"&&(this.director.configureStart(ci,hi),_i=this.director.mainLoader),this._logger.debug("Starting game clock..."),this.browser.resume(),this.clock.start(),this.garbageCollectorConfig&&this._garbageCollector.start(),this._logger.debug("Game clock started"),await this.load(_i??new Loader),await this._overrideInitialize(this),this._isReadyFuture.resolve(),this.emit("start",new GameStartEvent(this)),this._isReadyFuture.promise})}_mainloop(ci){this.scope(()=>{this.emit("preframe",new PreFrameEvent(this,this.stats.prevFrame));const hi=ci*this.timescale;this.currentFrameElapsedMs=hi;const _i=this.stats.prevFrame.id+1;this.stats.currFrame.reset(),this.stats.currFrame.id=_i,this.stats.currFrame.elapsedMs=hi,this.stats.currFrame.fps=this.clock.fpsSampler.fps,GraphicsDiagnostics.clear();const pi=this.clock.now(),mi=this.fixedUpdateTimestep;if(this.fixedUpdateTimestep)for(this._lagMs+=hi;this._lagMs>=mi;)this._update(mi),this._lagMs-=mi;else this._update(hi);const gi=this.clock.now();this.currentFrameLagMs=this._lagMs,this._draw(hi);const vi=this.clock.now();this.stats.currFrame.duration.update=gi-pi,this.stats.currFrame.duration.draw=vi-gi,this.stats.currFrame.graphics.drawnImages=GraphicsDiagnostics.DrawnImagesCount,this.stats.currFrame.graphics.drawCalls=GraphicsDiagnostics.DrawCallCount,this.emit("postframe",new PostFrameEvent(this,this.stats.currFrame)),this.stats.prevFrame.reset(this.stats.currFrame),this._monitorPerformanceThresholdAndTriggerFallback()})}stop(){this.clock.isRunning()&&(this.emit("stop",new GameStopEvent(this)),this.browser.pause(),this.clock.stop(),this._garbageCollector.stop(),this._logger.debug("Game stopped"))}isRunning(){return this.clock.isRunning()}screenshot(ci=!1){return new Promise(_i=>{this._screenShotRequests.push({preserveHiDPIResolution:ci,resolve:_i})})}_checkForScreenShots(){for(const ci of this._screenShotRequests){const hi=ci.preserveHiDPIResolution?this.canvas.width:this.screen.resolution.width,_i=ci.preserveHiDPIResolution?this.canvas.height:this.screen.resolution.height,pi=document.createElement("canvas");pi.width=hi,pi.height=_i;const mi=pi.getContext("2d");mi.imageSmoothingEnabled=this.screen.antialiasing,mi.drawImage(this.canvas,0,0,hi,_i);const gi=new Image,vi=pi.toDataURL("image/png");gi.onload=()=>{ci.resolve(gi)},gi.src=vi}this._screenShotRequests.length=0}async load(ci,hi=!1){await this.scope(async()=>{try{if(ci.isLoaded())return;this._loader=ci,this._isLoading=!0,this._hideLoader=hi,ci instanceof Loader&&(ci.suppressPlayButton=ci.suppressPlayButton||this._suppressPlayButton),this._loader.onInitialize(this),await ci.load()}catch(_i){this._logger.error("Error loading resources, things may not behave properly",_i),await Promise.resolve()}finally{this._isLoading=!1,this._hideLoader=!1,this._loader=null}})}}Engine.Context=createContext();Engine.InstanceCount=0;Engine._DEFAULT_ENGINE_OPTIONS={width:0,height:0,enableCanvasTransparency:!0,useDrawSorting:!0,configurePerformanceCanvas2DFallback:{allow:!1,showPlayerMessage:!1,threshold:{fps:20,numberOfFrames:100}},canvasElementId:"",canvasElement:void 0,enableCanvasContextMenu:!1,snapToPixel:!1,antialiasing:!0,pixelArt:!1,garbageCollection:!0,powerPreference:"high-performance",pointerScope:PointerScope.Canvas,suppressConsoleBootMessage:null,suppressMinimumBrowserFeatureDetection:null,suppressHiDPIScaling:null,suppressPlayButton:null,grabWindowFocus:!0,scrollPreventionMode:ScrollPreventionMode.Canvas,backgroundColor:Color.fromHex("#2185d0")};class Label extends Actor{set maxWidth(ci){this._text.maxWidth=ci}get maxWidth(){return this._text.maxWidth}get font(){return this._font}set font(ci){this._font=ci,this._text.font=ci}get text(){return this._text.text}set text(ci){this._text.text=ci}get color(){return this._text.color}set color(ci){this._text&&(this._text.color=ci)}get opacity(){return this.graphics.opacity}set opacity(ci){this.graphics.opacity=ci}get spriteFont(){return this._spriteFont}set spriteFont(ci){ci&&(this._spriteFont=ci,this._text.font=this._spriteFont)}constructor(ci){super(ci),this._font=new Font,this._text=new Text({text:"",font:this._font});const{text:hi,pos:_i,x:pi,y:mi,spriteFont:gi,font:vi,color:xi,maxWidth:wi}={text:"",...ci};this.pos=_i??(pi&&mi?vec(pi,mi):this.pos),this.text=hi??this.text,this.font=vi??this.font,this.maxWidth=wi??this.maxWidth,this.spriteFont=gi??this.spriteFont,this._text.color=xi??this.color;const yi=this.get(GraphicsComponent);yi.anchor=Vector.Zero,yi.use(this._text)}_initialize(ci){super._initialize(ci)}getTextWidth(){return this._text.width}}var EmitterType;(function(fi){fi.Circle="circle",fi.Rectangle="rectangle"})(EmitterType||(EmitterType={}));class ParticleEmitter extends Actor{constructor(ci){var hi,_i;super({width:(hi=ci.width)!==null&&hi!==void 0?hi:0,height:(_i=ci.height)!==null&&_i!==void 0?_i:0}),this._particlesToEmit=0,this._particlePool=new RentalPool(()=>new Particle({}),ki=>ki,500),this.numParticles=0,this.isEmitting=!0,this.deadParticles=[],this.emitRate=1,this.emitterType=EmitterType.Rectangle,this.radius=0,this.particle={life:2e3,transform:ParticleTransform.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this._activeParticles=[];const{particle:pi,x:mi,y:gi,z:vi,pos:xi,isEmitting:wi,emitRate:yi,emitterType:Ci,radius:Ei,random:Si}={...ci};this.particle={...this.particle,...pi},this.pos=xi??vec(mi??0,gi??0),this.z=vi??0,this.isEmitting=wi??this.isEmitting,this.emitRate=yi??this.emitRate,this.emitterType=Ci??this.emitterType,this.radius=Ei??this.radius,this.body.collisionType=CollisionType.PreventCollision,this.random=Si??new Random}removeParticle(ci){this.deadParticles.push(ci)}emitParticles(ci){var hi;if(!(ci<=0)){ci=ci|0;for(let _i=0;_i<ci;_i++){const pi=this._createParticle();!((hi=this===null||this===void 0?void 0:this.scene)===null||hi===void 0)&&hi.world&&(this.particle.transform===ParticleTransform.Global?this.scene.world.add(pi):this.addChild(pi)),this._activeParticles.push(pi)}}}clearParticles(){for(let ci=0;ci<this._activeParticles.length;ci++)this.removeParticle(this._activeParticles[ci])}_createParticle(){let ci=0,hi=0;const _i=randomInRange(this.particle.minAngle||0,this.particle.maxAngle||Math.PI*2,this.random),pi=randomInRange(this.particle.minSpeed||0,this.particle.maxSpeed||0,this.random),mi=this.particle.startSize||randomInRange(this.particle.minSize||5,this.particle.maxSize||5,this.random),gi=pi*Math.cos(_i),vi=pi*Math.sin(_i);if(this.emitterType===EmitterType.Rectangle)ci=randomInRange(0,this.width,this.random),hi=randomInRange(0,this.height,this.random);else if(this.emitterType===EmitterType.Circle){const wi=randomInRange(0,this.radius,this.random);ci=wi*Math.cos(_i),hi=wi*Math.sin(_i)}const xi=this._particlePool.rent();return xi.configure({life:this.particle.life,opacity:this.particle.opacity,beginColor:this.particle.beginColor,endColor:this.particle.endColor,pos:vec(ci,hi),vel:vec(gi,vi),acc:this.particle.acc,angularVelocity:this.particle.angularVelocity,startSize:this.particle.startSize,endSize:this.particle.endSize,size:mi,graphic:this.particle.graphic,fade:this.particle.fade}),xi.registerEmitter(this),this.particle.randomRotation&&(xi.transform.rotation=randomInRange(0,Math.PI*2,this.random)),this.particle.focus&&(xi.focus=this.particle.focus.add(vec(this.pos.x,this.pos.y)),xi.focusAccel=this.particle.focusAccel),xi}update(ci,hi){var _i;super.update(ci,hi),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(hi/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit)));for(let pi=0;pi<this.deadParticles.length;pi++){!((_i=this===null||this===void 0?void 0:this.scene)===null||_i===void 0)&&_i.world&&(this.scene.world.remove(this.deadParticles[pi],!1),this._particlePool.return(this.deadParticles[pi]));const mi=this._activeParticles.indexOf(this.deadParticles[pi]);mi>-1&&this._activeParticles.splice(mi,1)}this.deadParticles.length=0}}function assert(fi,ci){}class GpuParticleRenderer{constructor(ci,hi,_i){var pi;this.emitRate=1,this._initialized=!1,this._vaos=[],this._buffers=[],this._drawIndex=0,this._numInputFloats=7,this._particleIndex=0,this._uploadIndex=0,this._wrappedLife=0,this._wrappedParticles=0,this._particleLife=0,this._clearRequested=!1,this._emitted=[],this.emitter=ci,this.particle=_i,this._particleData=new Float32Array(this.emitter.maxParticles*this._numInputFloats),this._random=hi,this._particleLife=(pi=this.particle.life)!==null&&pi!==void 0?pi:2e3}get isInitialized(){return this._initialized}get maxParticles(){return this.emitter.maxParticles}initialize(ci,hi){if(this._initialized)return;const _i=this.emitter.maxParticles,pi=this._numInputFloats,mi=this._particleData,gi=4,vi=ci.createBuffer(),xi=ci.createVertexArray();ci.bindVertexArray(xi),ci.bindBuffer(ci.ARRAY_BUFFER,vi),ci.bufferData(ci.ARRAY_BUFFER,_i*pi*gi,ci.DYNAMIC_DRAW),ci.bufferSubData(ci.ARRAY_BUFFER,0,mi);let wi=0;ci.vertexAttribPointer(0,2,ci.FLOAT,!1,pi*gi,0),wi+=gi*2,ci.vertexAttribPointer(1,2,ci.FLOAT,!1,pi*gi,wi),wi+=gi*2,ci.vertexAttribPointer(2,1,ci.FLOAT,!1,pi*gi,wi),wi+=gi*1,ci.vertexAttribPointer(3,1,ci.FLOAT,!1,pi*gi,wi),wi+=gi*1,ci.vertexAttribPointer(4,1,ci.FLOAT,!1,pi*gi,wi),wi+=gi*1,ci.enableVertexAttribArray(0),ci.enableVertexAttribArray(1),ci.enableVertexAttribArray(2),ci.enableVertexAttribArray(3),ci.enableVertexAttribArray(4),this._vaos.push(xi),this._buffers.push(vi),ci.bindVertexArray(null),ci.bindBuffer(ci.ARRAY_BUFFER,null);const yi=ci.createBuffer(),Ci=ci.createVertexArray();ci.bindVertexArray(Ci),ci.bindBuffer(ci.ARRAY_BUFFER,yi),ci.bufferData(ci.ARRAY_BUFFER,_i*pi*gi,ci.DYNAMIC_DRAW),wi=0,ci.vertexAttribPointer(0,2,ci.FLOAT,!1,pi*gi,0),wi+=gi*2,ci.vertexAttribPointer(1,2,ci.FLOAT,!1,pi*gi,wi),wi+=gi*2,ci.vertexAttribPointer(2,1,ci.FLOAT,!1,pi*gi,wi),wi+=gi*1,ci.vertexAttribPointer(3,1,ci.FLOAT,!1,pi*gi,wi),wi+=gi*1,ci.vertexAttribPointer(4,1,ci.FLOAT,!1,pi*gi,wi),wi+=gi*1,ci.enableVertexAttribArray(0),ci.enableVertexAttribArray(1),ci.enableVertexAttribArray(2),ci.enableVertexAttribArray(3),ci.enableVertexAttribArray(4),this._vaos.push(Ci),this._buffers.push(yi),ci.bindVertexArray(null),ci.bindBuffer(ci.ARRAY_BUFFER,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._initialized=!0}clearParticles(){this._particleData.fill(0),this._clearRequested=!0}emitParticles(ci){const hi=this._particleIndex,_i=this.maxParticles*this._numInputFloats,pi=ci*this._numInputFloats+hi;for(let mi=hi;mi<pi;mi+=this._numInputFloats){const gi=this._random.floating(this.particle.minAngle||0,this.particle.maxAngle||TwoPI),vi=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),xi=this._random.floating(this.particle.minSpeed||0,this.particle.maxSpeed||0),wi=vi*Math.cos(gi),yi=xi*Math.sin(gi);let Ci=0,Ei=0;if(this.emitter.emitterType===EmitterType.Rectangle)Ci=this._random.floating(-.5,.5)*this.emitter.width,Ei=this._random.floating(-.5,.5)*this.emitter.height;else{const Ai=this._random.floating(0,this.emitter.radius);Ci=Ai*Math.cos(gi),Ei=Ai*Math.sin(gi)}const Si=this.emitter.transform.apply(vec(Ci,Ei)),ki=[this.particle.transform===ParticleTransform.Local?Ci:Si.x,this.particle.transform===ParticleTransform.Local?Ei:Si.y,wi,yi,this.particle.randomRotation?randomInRange(0,TwoPI,this._random):this.particle.rotation||0,this.particle.angularVelocity||0,this._particleLife];this._particleData.set(ki,mi%this._particleData.length)}pi>=_i?(this._wrappedParticles+=(pi-_i)/this._numInputFloats,this._wrappedLife=this._particleLife):this._wrappedLife>0&&(this._wrappedParticles+=ci),this._particleIndex=pi%_i,this._emitted.push([this._particleLife,hi])}_uploadEmitted(ci){this._particleIndex!==this._uploadIndex&&(ci.bindBuffer(ci.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),this._particleIndex>=this._uploadIndex?ci.bufferSubData(ci.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleIndex-this._uploadIndex):(ci.bufferSubData(ci.ARRAY_BUFFER,this._uploadIndex*4,this._particleData,this._uploadIndex,this._particleData.length-this._uploadIndex),this._wrappedParticles&&ci.bufferSubData(ci.ARRAY_BUFFER,0,this._particleData,0,this._wrappedParticles*this._numInputFloats),this._wrappedLife=this._particleLife),ci.bindBuffer(ci.ARRAY_BUFFER,null)),this._uploadIndex=this._particleIndex%(this.maxParticles*this._numInputFloats)}update(ci){var hi;if(this._particleLife=(hi=this.particle.life)!==null&&hi!==void 0?hi:this._particleLife,this._wrappedLife>0?this._wrappedLife-=ci:(this._wrappedLife=0,this._wrappedParticles=0),!!this._emitted.length){for(let _i=this._emitted.length-1;_i>=0;_i--){const pi=this._emitted[_i];pi[0]-=ci,pi[0]<=0&&this._emitted.splice(_i,1)}this._emitted.sort((_i,pi)=>_i[0]-pi[0])}}draw(ci){if(this._initialized){if(this._clearRequested?(ci.bindBuffer(ci.ARRAY_BUFFER,this._buffers[(this._drawIndex+1)%2]),ci.bufferSubData(ci.ARRAY_BUFFER,0,this._particleData),ci.bindBuffer(ci.ARRAY_BUFFER,null),this._clearRequested=!1):this._uploadEmitted(ci),ci.bindVertexArray(this._currentVao),ci.bindBufferBase(ci.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer),this._wrappedLife&&this._emitted[0]&&this._emitted[0][1]>0){const hi=this._emitted[0][1]/this._numInputFloats;ci.bindBufferRange(ci.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,this._emitted[0][1]*4,(this.maxParticles-hi)*this._numInputFloats*4),ci.beginTransformFeedback(ci.POINTS),ci.drawArrays(ci.POINTS,hi,this.maxParticles-hi),ci.endTransformFeedback(),ci.bindBufferRange(ci.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._emitted[0][1]*4),ci.beginTransformFeedback(ci.POINTS),ci.drawArrays(ci.POINTS,0,hi),ci.endTransformFeedback()}else ci.bindBufferRange(ci.TRANSFORM_FEEDBACK_BUFFER,0,this._currentBuffer,0,this._particleData.length*4),ci.beginTransformFeedback(ci.POINTS),ci.drawArrays(ci.POINTS,0,this.maxParticles),ci.endTransformFeedback();ci.bindVertexArray(null),ci.bindBufferBase(ci.TRANSFORM_FEEDBACK_BUFFER,0,null),this._currentVao=this._vaos[this._drawIndex%2],this._currentBuffer=this._buffers[(this._drawIndex+1)%2],this._drawIndex=(this._drawIndex+1)%2}}}GpuParticleRenderer.GPU_MAX_PARTICLES=1e5;class GpuParticleEmitter extends Actor{get pos(){return this.transform.pos}set pos(ci){this.transform.pos=ci}get z(){return this.transform.z}set z(ci){this.transform.z=ci}constructor(ci){super({name:"GpuParticleEmitter",width:ci.width,height:ci.height}),this.particle={life:2e3,transform:ParticleTransform.Global,graphic:void 0,opacity:1,angularVelocity:0,focus:void 0,focusAccel:void 0,randomRotation:!1},this.graphics=new GraphicsComponent,this.isEmitting=!1,this.emitRate=1,this.emitterType=EmitterType.Rectangle,this.radius=0,this.maxParticles=2e3,this._particlesToEmit=0,this.addComponent(this.graphics,!0),this.graphics.onPostDraw=this.draw.bind(this);const{particle:hi,maxParticles:_i,x:pi,y:mi,z:gi,pos:vi,isEmitting:xi,emitRate:wi,emitterType:yi,radius:Ci,random:Ei}={...ci};this.maxParticles=clamp(_i??this.maxParticles,0,GpuParticleRenderer.GPU_MAX_PARTICLES),this.pos=vi??vec(pi??0,mi??0),this.z=gi??0,this.isEmitting=xi??this.isEmitting,this.emitRate=wi??this.emitRate,this.emitterType=yi??this.emitterType,this.radius=Ci??this.radius,this.particle={...this.particle,...hi},this.random=Ei??new Random,this.renderer=new GpuParticleRenderer(this,this.random,this.particle)}_initialize(ci){super._initialize(ci);const hi=ci.graphicsContext;this.renderer.initialize(hi.__gl,hi)}update(ci,hi){super.update(ci,hi),this.isEmitting&&(this._particlesToEmit+=this.emitRate*(hi/1e3),this._particlesToEmit>1&&(this.emitParticles(Math.floor(this._particlesToEmit)),this._particlesToEmit=this._particlesToEmit-Math.floor(this._particlesToEmit))),this.renderer.update(hi)}emitParticles(ci){ci<=0||this.renderer.emitParticles(ci|0)}clearParticles(){this.renderer.clearParticles()}draw(ci,hi){ci.draw("ex.particle",this.renderer,hi)}}class IsometricTile extends Entity{getGraphics(){return this._graphics}addGraphic(ci,hi){this._graphics.push(ci),this._gfx.isVisible=this.map.isVisible,this._gfx.opacity=this.map.opacity,hi!=null&&hi.offset&&(this._gfx.offset=hi.offset),this._gfx.localBounds=this._recalculateBounds()}_recalculateBounds(){let ci=this._tileBounds.clone();for(const hi of this._graphics){const _i=vec(this.map.graphicsOffset.x-this.map.tileWidth/2,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:hi.height-this.map.tileHeight));ci=ci.combine(hi.localBounds.translate(_i))}return ci}removeGraphic(ci){const hi=this._graphics.indexOf(ci);hi>-1&&this._graphics.splice(hi,1),this._gfx.localBounds=this._recalculateBounds()}clearGraphics(){this._graphics.length=0,this._gfx.isVisible=!1,this._gfx.localBounds=this._recalculateBounds()}getColliders(){return this._colliders}addCollider(ci){this._colliders.push(ci),this.map.flagCollidersDirty()}removeCollider(ci){const hi=this._colliders.indexOf(ci);hi>-1&&this._colliders.splice(hi,1),this.map.flagCollidersDirty()}clearColliders(){this._colliders.length=0,this.map.flagCollidersDirty()}get pos(){return this.map.tileToWorld(vec(this.x,this.y))}get center(){return this.pos.add(vec(0,this.map.tileHeight/2))}constructor(ci,hi,_i,pi){super([new TransformComponent,new GraphicsComponent({offset:_i??Vector.Zero,onPostDraw:(Ei,Si)=>this.draw(Ei,Si)}),new IsometricEntityComponent(pi)]),this.solid=!1,this.events=new EventEmitter,this._tileBounds=new BoundingBox,this._graphics=[],this._colliders=[],this.data=new Map,this.x=ci,this.y=hi,this.map=pi,this._transform=this.get(TransformComponent),this._isometricEntityComponent=this.get(IsometricEntityComponent);const mi=this.map.tileWidth/2,gi=this.map.tileHeight/2,vi=(this.x-this.y)*mi,xi=(this.x+this.y)*gi;this._transform.pos=vec(vi,xi),this._isometricEntityComponent.elevation=pi.elevation,this._gfx=this.get(GraphicsComponent),this._gfx.isVisible=!1;const wi=this.map.tileWidth,yi=this.map.tileHeight,Ci=vec(0,this.map.renderFromTopOfGraphic?yi:0);this._gfx.localBounds=this._tileBounds=new BoundingBox({left:-wi/2,top:-yi,right:wi/2,bottom:yi}).translate(Ci)}draw(ci,hi){const _i=this.map.tileWidth/2;ci.save(),ci.translate(-_i,0);for(const pi of this._graphics)pi.draw(ci,this.map.graphicsOffset.x,this.map.graphicsOffset.y-(this.map.renderFromTopOfGraphic?0:pi.height-this.map.tileHeight));ci.restore()}}class IsometricMap extends Entity{get visible(){return this.isVisible}set visible(ci){this.isVisible=ci}constructor(ci){super([new TransformComponent,new BodyComponent({type:CollisionType.Fixed}),new ColliderComponent,new PointerComponent,new DebugGraphicsComponent((yi,Ci)=>this.debug(yi,Ci),!1)],ci.name),this.elevation=0,this.isVisible=!0,this.opacity=1,this.renderFromTopOfGraphic=!1,this.graphicsOffset=vec(0,0),this._collidersDirty=!1,this._originalOffsets=new WeakMap;const{pos:hi,tileWidth:_i,tileHeight:pi,columns:mi,rows:gi,renderFromTopOfGraphic:vi,graphicsOffset:xi,elevation:wi}=ci;this.transform=this.get(TransformComponent),hi&&(this.transform.pos=hi),this.collider=this.get(ColliderComponent),this.collider&&this.collider.set(this._composite=new CompositeCollider([])),this.pointer=this.get(PointerComponent),this.renderFromTopOfGraphic=vi??this.renderFromTopOfGraphic,this.graphicsOffset=xi??this.graphicsOffset,this.elevation=wi??this.elevation,this.tileWidth=_i,this.tileHeight=pi,this.columns=mi,this.rows=gi,this._pointerEventDispatcher=new PointerEventsToObjectDispatcher,this.tiles=new Array(mi*gi);for(let yi=0;yi<gi;yi++)for(let Ci=0;Ci<mi;Ci++){const Ei=new IsometricTile(Ci,yi,this.graphicsOffset,this);this.tiles[Ci+yi*mi]=Ei,this.addChild(Ei),this._pointerEventDispatcher.addObject(Ei,Si=>this.getTileByPoint(Si.worldPos)===Ei,()=>!0)}this.pointer.localBounds=BoundingBox.fromDimension(_i*mi*this.transform.scale.x,pi*gi*this.transform.scale.y,vec(.5,0))}_processPointerToObject(ci){this._pointerEventDispatcher.processPointerToObject(ci,this.tiles)}_dispatchPointerEvents(ci){this._pointerEventDispatcher.dispatchEvents(ci,this.tiles)}update(){this._collidersDirty&&(this.updateColliders(),this._collidersDirty=!1),this._pointerEventDispatcher.clear()}flagCollidersDirty(){this._collidersDirty=!0}_getOrSetColliderOriginalOffset(ci){var hi;if(this._originalOffsets.has(ci))return(hi=this._originalOffsets.get(ci))!==null&&hi!==void 0?hi:Vector.Zero;{const _i=ci.offset;return this._originalOffsets.set(ci,_i),_i}}updateColliders(){this._composite.clearColliders();const ci=this.get(TransformComponent).pos;for(const hi of this.tiles)if(hi.solid)for(const _i of hi.getColliders()){const pi=this._getOrSetColliderOriginalOffset(_i);_i.offset=this.tileToWorld(vec(hi.x,hi.y)).sub(ci).add(pi).sub(vec(this.tileWidth/2,this.tileHeight)),_i.owner=this,this._composite.addCollider(_i)}this.collider.update()}worldToTile(ci){ci=ci.sub(this.transform.globalPos);const hi=this.tileWidth/2,_i=this.tileHeight/2;return vec(~~((ci.x/hi+ci.y/_i)/2),~~((ci.y/_i-ci.x/hi)/2))}tileToWorld(ci){const hi=this.tileWidth/2,_i=this.tileHeight/2,pi=(ci.x-ci.y)*hi,mi=(ci.x+ci.y)*_i;return vec(pi,mi).add(this.transform.pos)}getTile(ci,hi){return ci<0||hi<0||ci>=this.columns||hi>=this.rows?null:this.tiles[ci+hi*this.columns]}getTileByPoint(ci){const hi=this.worldToTile(ci);return this.getTile(hi.x,hi.y)}_getMaxZIndex(){let ci=Number.NEGATIVE_INFINITY;for(const hi of this.tiles){const _i=hi.get(TransformComponent).z;_i>ci&&(ci=_i)}return ci}debug(ci,hi){const{showAll:_i,showPosition:pi,positionColor:mi,positionSize:gi,showGrid:vi,gridColor:xi,gridWidth:wi,showColliderGeometry:yi}=hi.isometric,{geometryColor:Ci,geometryLineWidth:Ei,geometryPointSize:Si}=hi.collider;if(ci.save(),ci.z=this._getMaxZIndex()+.5,_i||vi){for(let ki=0;ki<this.rows+1;ki++){const Ai=this.tileToWorld(vec(0,ki)),Ii=this.tileToWorld(vec(this.columns,ki));ci.drawLine(Ai,Ii,xi,wi)}for(let ki=0;ki<this.columns+1;ki++){const Ai=this.tileToWorld(vec(ki,0)),Ii=this.tileToWorld(vec(ki,this.rows));ci.drawLine(Ai,Ii,xi,wi)}}if(_i||pi)for(const ki of this.tiles)ci.drawCircle(this.tileToWorld(vec(ki.x,ki.y)),gi,mi);if(_i||yi){for(const ki of this.tiles)if(ki.solid)for(const Ai of ki.getColliders())Ai.debug(ci,Ci,{lineWidth:Ei,pointSize:Si})}ci.restore()}}class ActionSequence{constructor(ci,hi){this.id=nextActionId(),this._stopped=!1,this._sequenceBuilder=hi,this._sequenceContext=new ActionContext(ci),this._actionQueue=this._sequenceContext.getQueue(),this._sequenceBuilder(this._sequenceContext)}update(ci){this._actionQueue.update(ci)}isComplete(){return this._stopped||this._actionQueue.isComplete()}stop(){this._stopped=!0}reset(){this._stopped=!1,this._actionQueue.reset()}clone(ci){return new ActionSequence(ci,this._sequenceBuilder)}}class ParallelActions{constructor(ci){this.id=nextActionId(),this._actions=ci}update(ci){for(let hi=0;hi<this._actions.length;hi++)this._actions[hi].update(ci)}isComplete(ci){return this._actions.every(hi=>hi.isComplete(ci))}reset(){this._actions.forEach(ci=>ci.reset())}stop(){this._actions.forEach(ci=>ci.stop())}}class QuadTree{constructor(ci,hi){this.bounds=ci,this.options=hi,this._defaultOptions={maxDepth:10,capacity:10,level:0},this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null,this.options={...this._defaultOptions,...hi},this.halfWidth=ci.width/2,this.halfHeight=ci.height/2}_split(){this._isDivided=!0;const ci={maxDepth:this.options.maxDepth,capacity:this.options.capacity,level:this.options.level+1};this.topLeft=new QuadTree(new BoundingBox({left:this.bounds.left,top:this.bounds.top,right:this.bounds.left+this.halfWidth,bottom:this.bounds.top+this.halfHeight}),ci),this.topRight=new QuadTree(new BoundingBox({left:this.bounds.left+this.halfWidth,top:this.bounds.top,right:this.bounds.right,bottom:this.bounds.top+this.halfHeight}),ci),this.bottomLeft=new QuadTree(new BoundingBox({left:this.bounds.left,top:this.bounds.top+this.halfHeight,right:this.bounds.left+this.halfWidth,bottom:this.bounds.bottom}),ci),this.bottomRight=new QuadTree(new BoundingBox({left:this.bounds.left+this.halfWidth,top:this.bounds.top+this.halfHeight,right:this.bounds.right,bottom:this.bounds.bottom}),ci)}_insertIntoSubNodes(ci){var hi,_i,pi,mi;!((hi=this.topLeft)===null||hi===void 0)&&hi.bounds.overlaps(ci.bounds)&&this.topLeft.insert(ci),!((_i=this.topRight)===null||_i===void 0)&&_i.bounds.overlaps(ci.bounds)&&this.topRight.insert(ci),!((pi=this.bottomLeft)===null||pi===void 0)&&pi.bounds.overlaps(ci.bounds)&&this.bottomLeft.insert(ci),!((mi=this.bottomRight)===null||mi===void 0)&&mi.bounds.overlaps(ci.bounds)&&this.bottomRight.insert(ci)}insert(ci){if(this._isDivided){this._insertIntoSubNodes(ci);return}if(this.items.push(ci),this.items.length>this.options.capacity&&this.options.level<this.options.maxDepth){this._isDivided||this._split();for(const hi of this.items)this._insertIntoSubNodes(hi);this.items.length=0}}remove(ci){var hi,_i,pi,mi;if(this.bounds.overlaps(ci.bounds)){if(!this._isDivided){const gi=this.items.indexOf(ci);gi>-1&&this.items.splice(gi,1);return}!((hi=this.topLeft)===null||hi===void 0)&&hi.bounds.overlaps(ci.bounds)&&this.topLeft.remove(ci),!((_i=this.topRight)===null||_i===void 0)&&_i.bounds.overlaps(ci.bounds)&&this.topRight.remove(ci),!((pi=this.bottomLeft)===null||pi===void 0)&&pi.bounds.overlaps(ci.bounds)&&this.bottomLeft.remove(ci),!((mi=this.bottomRight)===null||mi===void 0)&&mi.bounds.overlaps(ci.bounds)&&this.bottomRight.remove(ci)}}query(ci){let hi=this.items;return this._isDivided&&(this.topLeft.bounds.overlaps(ci)&&(hi=hi.concat(this.topLeft.query(ci))),this.topRight.bounds.overlaps(ci)&&(hi=hi.concat(this.topRight.query(ci))),this.bottomLeft.bounds.overlaps(ci)&&(hi=hi.concat(this.bottomLeft.query(ci))),this.bottomRight.bounds.overlaps(ci)&&(hi=hi.concat(this.bottomRight.query(ci)))),hi=hi.filter((_i,pi)=>hi.indexOf(_i)>=pi),hi}clear(){this.items=[],this._isDivided=!1,this.topLeft=null,this.topRight=null,this.bottomLeft=null,this.bottomRight=null}getAllItems(){let ci=this.items;return this._isDivided&&(ci=ci.concat(this.topLeft.getAllItems()),ci=ci.concat(this.topRight.getAllItems()),ci=ci.concat(this.bottomLeft.getAllItems()),ci=ci.concat(this.bottomRight.getAllItems())),ci=ci.filter((hi,_i)=>ci.indexOf(hi)>=_i),ci}getTreeDepth(){return this._isDivided?1+Math.max(this.topLeft.getTreeDepth(),this.topRight.getTreeDepth(),this.bottomLeft.getTreeDepth(),this.bottomRight.getTreeDepth()):0}debug(ci){this.bounds.draw(ci,Color.Yellow),this._isDivided&&(this.topLeft.bounds.draw(ci,Color.Yellow),this.topRight.bounds.draw(ci,Color.Yellow),this.bottomLeft.bounds.draw(ci,Color.Yellow),this.bottomRight.bounds.draw(ci,Color.Yellow))}}function has_initialize(fi){return!!fi._initialize}function has_add(fi){return!!fi.onAdd}function has_remove(fi){return!!fi.onRemove}function hasOnInitialize(fi){return!!fi.onInitialize}function has_preupdate(fi){return!!fi._preupdate}function hasOnPreUpdate(fi){return!!fi.onPreUpdate}function has_postupdate(fi){return!!fi.onPostUpdate}function hasOnPostUpdate(fi){return!!fi.onPostUpdate}function hasOnAdd(fi){return!!fi.onAdd}function hasOnRemove(fi){return!!fi.onRemove}function hasPreDraw(fi){return!!fi.onPreDraw}function hasPostDraw(fi){return!!fi.onPostDraw}class Gif{constructor(ci,hi=!1){this.path=ci,this.width=0,this.height=0,this._images=[],this.data=[],this._sprites=[],this._resource=new Resource(ci,"arraybuffer",hi)}get bustCache(){return this._resource.bustCache}set bustCache(ci){this._resource.bustCache=ci}async load(){const ci=await this._resource.load();this._stream=new Stream$1(ci),this._gif=new GifParser(this._stream);const hi=this._gif.images.map(_i=>new ImageSource(_i.src,!1));return await Promise.all(hi.map(_i=>_i.load())),this.data=this._images=hi,this._sprites=this._images.map(_i=>_i.toSprite()),this.data}isLoaded(){return!!this.data}toSprite(ci=0){var hi;return(hi=this._sprites[ci])!==null&&hi!==void 0?hi:null}toSpriteSheet(){const ci=this._sprites;return ci.length?new SpriteSheet({sprites:ci}):null}toAnimation(ci){var hi;const _i=(hi=this._gif)===null||hi===void 0?void 0:hi.images;if(_i!=null&&_i.length){const pi=_i.map((mi,gi)=>{var vi;return{graphic:this._sprites[gi],duration:((vi=this._gif)===null||vi===void 0?void 0:vi.frames[gi].delayMs)||void 0}});return this._animation=new Animation({frames:pi,frameDuration:ci}),this._animation}return null}get readCheckBytes(){var ci,hi;return(hi=(ci=this._gif)===null||ci===void 0?void 0:ci.checkBytes)!==null&&hi!==void 0?hi:[]}}const bitsToNum=fi=>fi.reduce(function(ci,hi){return ci*2+hi},0),byteToBitArr=fi=>{const ci=[];for(let hi=7;hi>=0;hi--)ci.push(!!(fi&1<<hi));return ci};let Stream$1=class{constructor(ci){if(this.len=0,this.position=0,this.readByte=()=>{if(this.position>=this.data.byteLength)throw new Error("Attempted to read past end of stream.");return this.data[this.position++]},this.readBytes=hi=>{const _i=[];for(let pi=0;pi<hi;pi++)_i.push(this.readByte());return _i},this.read=hi=>{let _i="";for(let pi=0;pi<hi;pi++)_i+=String.fromCharCode(this.readByte());return _i},this.readUnsigned=()=>{const hi=this.readBytes(2);return(hi[1]<<8)+hi[0]},this.data=new Uint8Array(ci),this.len=this.data.byteLength,this.len===0)throw new Error("No data loaded from file")}};const lzwDecode=function(fi,ci){let hi=0;const _i=function(Ei){let Si=0;for(let ki=0;ki<Ei;ki++)ci.charCodeAt(hi>>3)&1<<(hi&7)&&(Si|=1<<ki),hi++;return Si},pi=[],mi=1<<fi,gi=mi+1;let vi=fi+1,xi=[];const wi=function(){xi=[],vi=fi+1;for(let Ei=0;Ei<mi;Ei++)xi[Ei]=[Ei];xi[mi]=[],xi[gi]=null};let yi=0,Ci=0;for(;;){if(Ci=yi,yi=_i(vi),yi===mi){wi();continue}if(yi===gi)break;if(yi<xi.length)Ci!==mi&&xi.push(xi[Ci].concat(xi[yi][0]));else{if(yi!==xi.length)throw new Error("Invalid LZW code.");xi.push(xi[Ci].concat(xi[Ci][0]))}pi.push.apply(pi,xi[yi]),xi.length===1<<vi&&vi<12&&vi++}return pi};class GifParser{constructor(ci){this._handler={},this.frames=[],this.images=[],this.globalColorTableBytes=[],this.checkBytes=[],this.parseColorTableBytes=hi=>{const _i=[];for(let pi=0;pi<hi;pi++){const mi=this._st.readBytes(3);_i.push(mi)}return _i},this.readSubBlocks=()=>{let hi,_i;_i="";do hi=this._st.readByte(),_i+=this._st.read(hi);while(hi!==0);return _i},this.parseHeader=()=>{const hi={sig:"",ver:"",width:0,height:0,colorResolution:0,globalColorTableSize:0,gctFlag:!1,sortedFlag:!1,globalColorTable:[],backgroundColorIndex:0,pixelAspectRatio:0};if(hi.sig=this._st.read(3),hi.ver=this._st.read(3),hi.sig!=="GIF")throw new Error("Not a GIF file.");hi.width=this._st.readUnsigned(),hi.height=this._st.readUnsigned(),this._currentFrameCanvas.width=hi.width,this._currentFrameCanvas.height=hi.height;const _i=byteToBitArr(this._st.readByte());hi.gctFlag=_i.shift(),hi.colorResolution=bitsToNum(_i.splice(0,3)),hi.sortedFlag=_i.shift(),hi.globalColorTableSize=bitsToNum(_i.splice(0,3)),hi.backgroundColorIndex=this._st.readByte(),hi.pixelAspectRatio=this._st.readByte(),hi.gctFlag&&(this.globalColorTableBytes=this.parseColorTableBytes(1<<hi.globalColorTableSize+1)),this._handler.hdr&&this._handler.hdr(hi)&&this.checkBytes.push(this._handler.hdr)},this.parseExt=hi=>{const _i=xi=>{this.checkBytes.push(this._st.readByte());const wi=byteToBitArr(this._st.readByte());return xi.reserved=wi.splice(0,3),xi.disposalMethod=bitsToNum(wi.splice(0,3)),xi.userInputFlag=wi.shift(),xi.transparentColorFlag=wi.shift(),xi.delayTime=this._st.readUnsigned(),xi.transparentColorIndex=this._st.readByte(),xi.terminator=this._st.readByte(),this._handler.gce&&this._handler.gce(xi)&&this.checkBytes.push(this._handler.gce),xi},pi=xi=>{xi.comment=this.readSubBlocks(),this._handler.com&&this._handler.com(xi)&&this.checkBytes.push(this._handler.com)},mi=xi=>{this.checkBytes.push(this._st.readByte()),xi.ptHeader=this._st.readBytes(12),xi.ptData=this.readSubBlocks(),this._handler.pte&&this._handler.pte(xi)&&this.checkBytes.push(this._handler.pte)},gi=xi=>{const wi=Ci=>{this.checkBytes.push(this._st.readByte()),Ci.unknown=this._st.readByte(),Ci.iterations=this._st.readUnsigned(),Ci.terminator=this._st.readByte(),this._handler.app&&this._handler.app.NETSCAPE&&this._handler.app.NETSCAPE(Ci)&&this.checkBytes.push(this._handler.app)},yi=Ci=>{Ci.appData=this.readSubBlocks(),this._handler.app&&this._handler.app[Ci.identifier]&&this._handler.app[Ci.identifier](Ci)&&this.checkBytes.push(this._handler.app[Ci.identifier])};switch(this.checkBytes.push(this._st.readByte()),xi.identifier=this._st.read(8),xi.authCode=this._st.read(3),xi.identifier){case"NETSCAPE":wi(xi);break;default:yi(xi);break}},vi=xi=>{xi.data=this.readSubBlocks(),this._handler.unknown&&this._handler.unknown(xi)&&this.checkBytes.push(this._handler.unknown)};switch(hi.label=this._st.readByte(),hi.label){case 249:hi.extType="gce",this._gce=_i(hi);break;case 254:hi.extType="com",pi(hi);break;case 1:hi.extType="pte",mi(hi);break;case 255:hi.extType="app",gi(hi);break;default:hi.extType="unknown",vi(hi);break}},this.parseImg=hi=>{var _i;const pi=(vi,xi)=>{const wi=new Array(vi.length),yi=vi.length/xi,Ci=(Ai,Ii)=>{const Ti=vi.slice(Ii*xi,(Ii+1)*xi);wi.splice.apply(wi,[Ai*xi,xi].concat(Ti))},Ei=[0,4,2,1],Si=[8,8,4,2];let ki=0;for(let Ai=0;Ai<4;Ai++)for(let Ii=Ei[Ai];Ii<yi;Ii+=Si[Ai])Ci(Ii,ki),ki++;return wi};hi.leftPos=this._st.readUnsigned(),hi.topPos=this._st.readUnsigned(),hi.width=this._st.readUnsigned(),hi.height=this._st.readUnsigned();const mi=byteToBitArr(this._st.readByte());hi.lctFlag=mi.shift(),hi.interlaced=mi.shift(),hi.sorted=mi.shift(),hi.reserved=mi.splice(0,2),hi.lctSize=bitsToNum(mi.splice(0,3)),hi.lctFlag&&(hi.lctBytes=this.parseColorTableBytes(1<<hi.lctSize+1)),hi.lzwMinCodeSize=this._st.readByte();const gi=this.readSubBlocks();hi.pixels=lzwDecode(hi.lzwMinCodeSize,gi),hi.interlaced&&(hi.pixels=pi(hi.pixels,hi.width)),!((_i=this._gce)===null||_i===void 0)&&_i.delayTime&&(hi.delayMs=this._gce.delayTime*10),this.frames.push(hi),this.arrayToImage(hi,hi.lctFlag?hi.lctBytes:this.globalColorTableBytes),this._handler.img&&this._handler.img(hi)&&this.checkBytes.push(this._handler)},this.parseBlocks=()=>{const hi={sentinel:this._st.readByte(),type:""};switch(String.fromCharCode(hi.sentinel)){case"!":hi.type="ext",this.parseExt(hi);break;case",":hi.type="img",this.parseImg(hi);break;case";":hi.type="eof",this._handler.eof&&this._handler.eof(hi)&&this.checkBytes.push(this._handler.eof);break;default:throw new Error("Unknown block: 0x"+hi.sentinel.toString(16))}hi.type!=="eof"&&this.parseBlocks()},this.arrayToImage=(hi,_i)=>{var pi,mi,gi,vi;const xi=document.createElement("canvas");xi.width=hi.width,xi.height=hi.height;const wi=xi.getContext("2d"),yi=wi.getImageData(0,0,xi.width,xi.height);let Ci=-1;!((pi=this._gce)===null||pi===void 0)&&pi.transparentColorFlag&&(Ci=this._gce.transparentColorIndex);for(let Si=0;Si<hi.pixels.length;Si++){const ki=hi.pixels[Si],Ai=_i[ki];ki===Ci?yi.data.set([0,0,0,0],Si*4):yi.data.set([...Ai,255],Si*4)}if(wi.putImageData(yi,0,0),((mi=this._gce)===null||mi===void 0?void 0:mi.disposalMethod)===1&&this.images.length)this._currentFrameContext.drawImage(this.images[this.images.length-1],0,0);else if(((gi=this._gce)===null||gi===void 0?void 0:gi.disposalMethod)===2&&(!((vi=this._hdr)===null||vi===void 0)&&vi.gctFlag)){const Si=_i[this._hdr.backgroundColorIndex];this._currentFrameContext.fillStyle=`rgb(${Si[0]}, ${Si[1]}, ${Si[2]})`,this._currentFrameContext.fillRect(0,0,this._hdr.width,this._hdr.height)}else this._currentFrameContext.clearRect(0,0,this._currentFrameCanvas.width,this._currentFrameCanvas.height);this._currentFrameContext.drawImage(xi,hi.leftPos,hi.topPos,hi.width,hi.height);const Ei=new Image;Ei.src=this._currentFrameCanvas.toDataURL(),this.images.push(Ei)},this._st=ci,this._handler={},this._currentFrameCanvas=document.createElement("canvas"),this._currentFrameContext=this._currentFrameCanvas.getContext("2d"),this.parseHeader(),this.parseBlocks()}}class FontSource{constructor(ci,hi,{bustCache:_i,...pi}={}){this.path=ci,this.family=hi,this._isLoaded=!1,this._resource=new Resource(ci,"blob",_i),this._options=pi}async load(){if(this.isLoaded())return this.data;try{const ci=await this._resource.load(),hi=URL.createObjectURL(ci);this.data||(this.data=new FontFace(this.family,`url(${hi})`),document.fonts.add(this.data)),await this.data.load(),this._isLoaded=!0}catch(ci){throw`Error loading FontSource from path '${this.path}' with error [${ci.message}]`}return this.data}isLoaded(){return this._isLoaded}toFont(ci){return new Font({family:this.family,...this._options,...ci})}}const InsideCoroutineContext=createContext(),generatorFunctionDeclaration=/^\s*(?:function)?\*/;function isCoroutineGenerator(fi){return typeof fi!="function"?!1:generatorFunctionDeclaration.test(Function.prototype.toString.call(fi))?!0:Object.getPrototypeOf?Object.getPrototypeOf(fi)===Object.getPrototypeOf(new Function("return function * () {}")()):!1}function coroutine(...fi){var ci;const hi=Logger.getInstance();let _i,pi,mi,gi;isCoroutineGenerator(fi[0])&&(pi=globalThis,_i=fi[0],mi=fi[1]),isCoroutineGenerator(fi[1])&&(pi=fi[0],_i=fi[1],mi=fi[2]),fi[1]instanceof Engine&&(pi=fi[0],gi=fi[1],_i=fi[2],mi=fi[3]),fi[0]instanceof Engine&&(pi=globalThis,gi=fi[0],_i=fi[1],mi=fi[2]);const vi=useContext(InsideCoroutineContext),xi=mi==null?void 0:mi.timing,wi=vi?!1:(ci=mi==null?void 0:mi.autostart)!==null&&ci!==void 0?ci:!0;let yi;try{yi=gi??Engine.useEngine()}catch{throw Error(`Cannot run coroutine without engine parameter outside of an excalibur lifecycle method.
Pass an engine parameter to ex.coroutine(engine, function * {...})`)}let Ci=!1,Ei=!1,Si=!1;const ki=_i.bind(pi),Ai=ki();let Ii;const Ti=new Promise((Li,Ri)=>{Ii=Di=>{try{if(Si){Ei=!0,Li();return}const{done:Fi,value:Mi}=InsideCoroutineContext.scope(!0,()=>Ai.next(Di));if(Fi||Si){Ei=!0,Li();return}Mi instanceof Promise?Mi.then(()=>{yi.clock.schedule(Ii,0,xi)}):Mi===void 0||Mi===void 0?yi.clock.schedule(Ii,0,xi):yi.clock.schedule(Ii,Mi||0,xi)}catch(Fi){Ri(Fi);return}},wi&&(Ci=!0,Ii(yi.clock.elapsed()))}),Pi={isRunning:()=>Ci&&!Si&&!Ei,isComplete:()=>Ei,cancel:()=>{Si=!0},start:()=>(Ci?hi.warn(`.start() was called on a coroutine that was already started, this is probably a bug:
`,Function.prototype.toString.call(ki)):(Ci=!0,Ii(yi.clock.elapsed())),Pi),generator:Ai,done:Ti,then:Ti.then.bind(Ti),[Symbol.iterator]:()=>Ai};return Pi}class Transition extends Entity{get progress(){return this._currentProgress}get complete(){return this.direction==="out"?this.progress>=1:this.progress<=0}constructor(ci){var hi,_i,pi,mi;super(),this._logger=Logger.getInstance(),this.transform=new TransformComponent,this.graphics=new GraphicsComponent,this._completeFuture=new Future,this.started=!1,this._currentDistance=0,this._currentProgress=0,this.done=this._completeFuture.promise,this.name=`Transition#${this.id}`,this.duration=ci.duration,this.easing=(hi=ci.easing)!==null&&hi!==void 0?hi:EasingFunctions.Linear,this.direction=(_i=ci.direction)!==null&&_i!==void 0?_i:"out",this.hideLoader=(pi=ci.hideLoader)!==null&&pi!==void 0?pi:!1,this.blockInput=(mi=ci.blockInput)!==null&&mi!==void 0?mi:!1,this.transform.coordPlane=CoordPlane.Screen,this.transform.pos=Vector.Zero,this.transform.z=1/0,this.graphics.anchor=Vector.Zero,this.addComponent(this.transform),this.addComponent(this.graphics),this.direction==="out"?this._currentProgress=0:this._currentProgress=1}updateTransition(ci,hi){this.complete||(this._currentDistance+=clamp(hi/this.duration,0,1),this._currentDistance>=1&&(this._currentDistance=1),this.direction==="out"?this._currentProgress=clamp(this.easing(this._currentDistance,0,1,1),0,1):this._currentProgress=clamp(this.easing(this._currentDistance,1,0,1),0,1))}async onPreviousSceneDeactivate(ci){}onStart(ci){}onUpdate(ci){}onEnd(ci){}onReset(){}reset(){this.started=!1,this._completeFuture=new Future,this.done=this._completeFuture.promise,this._currentDistance=0,this.direction==="out"?this._currentProgress=0:this._currentProgress=1,this.onReset()}_addToTargetScene(ci,hi){const _i=hi;if(this.started&&this._logger.warn(`Attempted to add a transition ${this.name} that is already playing.`),_i.world.entityManager.getById(this.id))return this._co;this._engine=ci,_i.add(this);const pi=this;return this._co=coroutine(ci,function*(){for(;!pi.complete;){const mi=yield;pi.updateTransition(pi._engine,mi),pi._execute()}},{autostart:!1}),this._co}async _play(){this.started&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that is already playing, reset transition.`)),(!this._engine||!this._co)&&(this.reset(),this._logger.warn(`Attempted to play a transition ${this.name} that hasn't been added`)),this._co&&await this._co.start()}_execute(){this.isInitialized&&(this.started||(this.started=!0,this.onStart(this.progress)),this.onUpdate(this.progress),this.complete&&!this._completeFuture.isCompleted&&(this.onEnd(this.progress),this._completeFuture.resolve()))}}class FadeInOut extends Transition{constructor(ci){var hi,_i;super({...ci,duration:(hi=ci.duration)!==null&&hi!==void 0?hi:2e3}),this.name=`FadeInOut#${this.id}`,this.color=(_i=ci.color)!==null&&_i!==void 0?_i:Color.Black}onInitialize(ci){this.transform.pos=ci.screen.unsafeArea.topLeft,this.screenCover=new Rectangle({width:ci.screen.resolution.width,height:ci.screen.resolution.height,color:this.color}),this.graphics.add(this.screenCover),this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onStart(ci){this.graphics.opacity=ci}onEnd(ci){this.graphics.opacity=ci}onUpdate(ci){this.graphics.opacity=ci}}class CrossFade extends Transition{constructor(ci){super({direction:"in",...ci}),this.name=`CrossFade#${this.id}`}async onPreviousSceneDeactivate(ci){this.image=await ci.engine.screenshot(!0),await this.image.decode()}onInitialize(ci){this.engine=ci,this.transform.pos=ci.screen.unsafeArea.topLeft,this.screenCover=ImageSource.fromHtmlImageElement(this.image).toSprite(),this.graphics.add(this.screenCover),this.transform.scale=vec(1/ci.screen.pixelRatio,1/ci.screen.pixelRatio),this.graphics.opacity=this.progress}onStart(ci){this.graphics.opacity=this.progress}onReset(){this.graphics.opacity=this.progress}onEnd(ci){this.graphics.opacity=ci}onUpdate(ci){this.graphics.opacity=ci}}class Slide extends Transition{constructor(ci){var hi;super({direction:"in",...ci}),this._easing=EasingFunctions.Linear,this.name=`Slide#${this.id}`,this.slideDirection=ci.slideDirection,this.transform.coordPlane=CoordPlane.World,this.graphics.forceOnScreen=!0,this._easing=(hi=ci.easingFunction)!==null&&hi!==void 0?hi:this._easing,this._vectorEasing=EasingFunctions.CreateVectorEasingFunction(this._easing)}async onPreviousSceneDeactivate(ci){this._image=await ci.engine.screenshot(!0),await this._image.decode(),this._screenCover=ImageSource.fromHtmlImageElement(this._image).toSprite()}onInitialize(ci){switch(this._engine=ci,this.slideDirection){case"up":{this._directionOffset=vec(0,-ci.screen.resolution.height);break}case"down":{this._directionOffset=vec(0,ci.screen.resolution.height);break}case"left":{this._directionOffset=vec(-ci.screen.resolution.width,0);break}case"right":{this._directionOffset=vec(ci.screen.resolution.width,0);break}}this._camera=this._engine.currentScene.camera,this._destinationCameraPosition=this._camera.pos.clone(),this._camera.pos=this._camera.pos.add(this._directionOffset),this.transform.pos=this.transform.pos.add(this._directionOffset),this._startCameraPosition=this._camera.pos.clone(),this.graphics.use(this._screenCover),this.transform.scale=vec(1/ci.screen.pixelRatio,1/ci.screen.pixelRatio)}onUpdate(ci){this._camera.pos=this._vectorEasing(ci,this._destinationCameraPosition,this._startCameraPosition,1)}}class Line extends Graphic{constructor(ci){super(),this.color=Color.Black,this.thickness=1;const{start:hi,end:_i,color:pi,thickness:mi}=ci;this.start=hi,this.end=_i,this.color=pi??this.color,this.thickness=mi??this.thickness,this._localBounds=this._calculateBounds();const{width:gi,height:vi}=this._localBounds;this.width=gi,this.height=vi}get localBounds(){return this._localBounds}_calculateBounds(){const ci=this.end.sub(this.start).normal(),hi=this.thickness/2,_i=[this.start.add(ci.scale(hi)),this.end.add(ci.scale(hi)),this.end.add(ci.scale(-hi)),this.start.add(ci.scale(-hi))];return BoundingBox.fromPoints(_i)}_drawImage(ci,hi,_i){ci.drawLine(this.start,this.end,this.color,this.thickness)}clone(){return new Line({start:this.start,end:this.end,color:this.color,thickness:this.thickness})}}class Polygon extends Raster{get points(){return this._points}set points(ci){this._points=ci;const hi=this.minPoint;this.width=this._points.reduce((_i,pi)=>Math.max(pi.x,_i),0)-hi.x,this.height=this._points.reduce((_i,pi)=>Math.max(pi.y,_i),0)-hi.y,this.flagDirty()}get minPoint(){const ci=this._points.reduce((_i,pi)=>Math.min(pi.x,_i),1/0),hi=this._points.reduce((_i,pi)=>Math.min(pi.y,_i),1/0);return vec(ci,hi)}constructor(ci){super(ci),this._points=[],this.points=ci.points,this.filtering=ImageFiltering.Blended,this.rasterize()}clone(){return new Polygon({points:this.points.map(ci=>ci.clone()),...this.cloneGraphicOptions(),...this.cloneRasterOptions()})}execute(ci){if(this.points&&this.points.length){ci.beginPath();const hi=this.minPoint.negate(),_i=this.points[0].add(hi);ci.moveTo(_i.x,_i.y),this.points.forEach(pi=>{ci.lineTo(pi.x+hi.x,pi.y+hi.y)}),ci.lineTo(_i.x,_i.y),ci.closePath(),this.color&&ci.fill(),this.strokeColor&&ci.stroke()}}}var NineSliceStretch;(function(fi){fi.Stretch="stretch",fi.Tile="tile",fi.TileFit="tile-fit"})(NineSliceStretch||(NineSliceStretch={}));class NineSlice extends Graphic{constructor(ci){super(ci),this._logger=Logger.getInstance(),this._config=ci,this._imgSource=ci.source,this._canvasA=document.createElement("canvas"),this._canvasB=document.createElement("canvas"),this._canvasC=document.createElement("canvas"),this._canvasD=document.createElement("canvas"),this._canvasE=document.createElement("canvas"),this._canvasF=document.createElement("canvas"),this._canvasG=document.createElement("canvas"),this._canvasH=document.createElement("canvas"),this._canvasI=document.createElement("canvas"),this._initialize(),this._imgSource.ready.then(()=>{this._initialize()})}setTargetWidth(ci,hi=!1){this._config.width=ci,hi&&this._initialize()}setTargetHeight(ci,hi=!1){this._config.height=ci,hi&&this._initialize()}setMargins(ci,hi,_i,pi,mi=!1){this._config.sourceConfig.leftMargin=ci,this._config.sourceConfig.topMargin=hi,this._config.sourceConfig.rightMargin=_i,this._config.sourceConfig.bottomMargin=pi,mi&&this._initialize()}setStretch(ci,hi,_i=!1){ci==="horizontal"?this._config.destinationConfig.horizontalStretch=hi:ci==="vertical"?this._config.destinationConfig.verticalStretch=hi:(this._config.destinationConfig.horizontalStretch=hi,this._config.destinationConfig.verticalStretch=hi),_i&&this._initialize()}getConfig(){return this._config}_drawTile(ci,hi,_i,pi,mi,gi,vi){const xi=gi||0,wi=vi||0;let yi,Ci,Ei,Si;const ki=this._getNumberOfTiles(hi.width,_i.x,pi),Ai=this._getNumberOfTiles(hi.height,_i.y,mi);for(let Ii=0;Ii<ki;Ii++)for(let Ti=0;Ti<Ai;Ti++){let{tempSize:Pi,tempPosition:Li}=this._calculateParams(Ii,ki,hi.width,_i.x,this._config.destinationConfig.horizontalStretch);yi=Pi,Ci=Li,{tempSize:Pi,tempPosition:Li}=this._calculateParams(Ti,Ai,hi.height,_i.y,this._config.destinationConfig.verticalStretch),Ei=Pi,Si=Li,ci.drawImage(hi,0,0,hi.width,hi.height,xi+Ci,wi+Si,yi,Ei)}}_drawImage(ci,hi,_i){this._imgSource.isLoaded()?(this._drawTile(ci,this._canvasA,new Vector(this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch),this._drawTile(ci,this._canvasB,new Vector(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,0),this._drawTile(ci,this._canvasC,new Vector(this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,0),this._drawTile(ci,this._canvasD,new Vector(this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.sourceConfig.topMargin),this._config.destinationConfig.drawCenter&&this._drawTile(ci,this._canvasE,new Vector(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin),this._drawTile(ci,this._canvasF,new Vector(this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin-this._config.sourceConfig.topMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin),this._drawTile(ci,this._canvasG,new Vector(this._config.sourceConfig.leftMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,0,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(ci,this._canvasH,new Vector(this._config.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.sourceConfig.leftMargin,this._config.height-this._config.sourceConfig.bottomMargin),this._drawTile(ci,this._canvasI,new Vector(this._config.sourceConfig.rightMargin,this._config.sourceConfig.bottomMargin),this._config.destinationConfig.horizontalStretch,this._config.destinationConfig.verticalStretch,this._config.width-this._config.sourceConfig.rightMargin,this._config.height-this._config.sourceConfig.bottomMargin)):this._logger.warnOnce(`NineSlice ImageSource ${this._imgSource.path} is not yet loaded and won't be drawn. Please call .load() or include in a Loader.

Read https://excaliburjs.com/docs/imagesource for more information.`)}_initialize(){this._sourceSprite=this._imgSource.image,this._canvasA.width=this._config.sourceConfig.leftMargin,this._canvasA.height=this._config.sourceConfig.topMargin;const ci=this._canvasA.getContext("2d");ci==null||ci.drawImage(this._sourceSprite,0,0,this._canvasA.width,this._canvasA.height,0,0,this._canvasA.width,this._canvasA.height),this._canvasB.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasB.height=this._config.sourceConfig.topMargin;const hi=this._canvasB.getContext("2d");hi==null||hi.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,0,this._canvasB.width,this._canvasB.height,0,0,this._canvasB.width,this._canvasB.height),this._canvasC.width=this._config.sourceConfig.rightMargin,this._canvasC.height=this._config.sourceConfig.topMargin;const _i=this._canvasC.getContext("2d");_i==null||_i.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,0,this._canvasC.width,this._canvasC.height,0,0,this._canvasC.width,this._canvasC.height),this._canvasD.width=this._config.sourceConfig.leftMargin,this._canvasD.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const pi=this._canvasD.getContext("2d");pi==null||pi.drawImage(this._sourceSprite,0,this._config.sourceConfig.topMargin,this._canvasD.width,this._canvasD.height,0,0,this._canvasD.width,this._canvasD.height),this._canvasE.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasE.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const mi=this._canvasE.getContext("2d");mi==null||mi.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.topMargin,this._canvasE.width,this._canvasE.height,0,0,this._canvasE.width,this._canvasE.height),this._canvasF.width=this._config.sourceConfig.rightMargin,this._canvasF.height=this._config.sourceConfig.height-this._config.sourceConfig.topMargin-this._config.sourceConfig.bottomMargin;const gi=this._canvasF.getContext("2d");gi==null||gi.drawImage(this._sourceSprite,this._config.sourceConfig.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.topMargin,this._canvasF.width,this._canvasF.height,0,0,this._canvasF.width,this._canvasF.height),this._canvasG.width=this._config.sourceConfig.leftMargin,this._canvasG.height=this._config.sourceConfig.bottomMargin;const vi=this._canvasG.getContext("2d");vi==null||vi.drawImage(this._sourceSprite,0,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasG.width,this._canvasG.height,0,0,this._canvasG.width,this._canvasG.height),this._canvasH.width=this._config.sourceConfig.width-this._config.sourceConfig.leftMargin-this._config.sourceConfig.rightMargin,this._canvasH.height=this._config.sourceConfig.bottomMargin;const xi=this._canvasH.getContext("2d");xi==null||xi.drawImage(this._sourceSprite,this._config.sourceConfig.leftMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasH.width,this._canvasH.height,0,0,this._canvasH.width,this._canvasH.height),this._canvasI.width=this._config.sourceConfig.rightMargin,this._canvasI.height=this._config.sourceConfig.bottomMargin;const wi=this._canvasI.getContext("2d");wi==null||wi.drawImage(this._sourceSprite,this._sourceSprite.width-this._config.sourceConfig.rightMargin,this._config.sourceConfig.height-this._config.sourceConfig.bottomMargin,this._canvasI.width,this._canvasI.height,0,0,this._canvasI.width,this._canvasI.height)}clone(){return new NineSlice(this._config)}_getNumberOfTiles(ci,hi,_i){switch(_i){case NineSliceStretch.Stretch:return 1;case NineSliceStretch.Tile:return Math.ceil(hi/ci);case NineSliceStretch.TileFit:return Math.ceil(hi/ci)}}_calculateParams(ci,hi,_i,pi,mi){switch(mi){case NineSliceStretch.Stretch:return{tempPosition:0,tempSize:pi};case NineSliceStretch.Tile:return ci===hi-1?{tempPosition:ci*_i,tempSize:_i-(hi*_i-pi)}:{tempPosition:ci*_i,tempSize:_i};case NineSliceStretch.TileFit:const gi=pi/hi;return{tempPosition:ci*gi,tempSize:gi}}}}class TiledAnimation extends Animation{constructor(ci){super({...ci,frames:ci.animation.frames.slice(),strategy:ci.animation.strategy,frameDuration:ci.animation.frameDuration,speed:ci.animation.speed,reverse:ci.animation.isReversed}),this._ready=new Future,this.ready=this._ready.promise,this._tiledWidth=0,this._tiledHeight=0,this._sourceView={},this._sourceView={...ci.sourceView},this._tiledWidth=ci.width,this._tiledHeight=ci.height;const hi=[];for(let _i=0;_i<this.frames.length;_i++){const pi=this.frames[_i].graphic;if(pi&&pi instanceof Sprite){const mi=new TiledSprite({image:pi.image,width:ci.width,height:ci.height,sourceView:{...pi.sourceView},wrapping:ci.wrapping,filtering:ci.filtering});this.frames[_i].graphic=mi,mi.ready.then(()=>{mi.sourceView={...mi.sourceView,...this._sourceView}}),hi.push(mi.ready)}}Promise.all(hi).then(()=>this._ready.resolve())}static fromAnimation(ci,hi){return new TiledAnimation({width:ci.width,height:ci.height,...hi,animation:ci})}_updateSourceView(){for(let ci=0;ci<this.frames.length;ci++){const hi=this.frames[ci].graphic;hi&&hi instanceof Sprite&&(hi.sourceView={...hi.sourceView,...this._sourceView})}}get sourceView(){return watch(this._sourceView,()=>this._updateSourceView())}set sourceView(ci){this._sourceView=watch(ci,()=>this._updateSourceView()),this._updateSourceView()}_updateWidthHeight(){for(let ci=0;ci<this.frames.length;ci++){const hi=this.frames[ci].graphic;hi&&hi instanceof Sprite&&(hi.sourceView.height=this._tiledHeight||hi.height,hi.destSize.height=this._tiledHeight||hi.height,hi.sourceView.width=this._tiledWidth||hi.width,hi.destSize.width=this._tiledWidth||hi.width)}}get width(){return this._tiledWidth}get height(){return this._tiledHeight}set width(ci){this._tiledWidth=ci,this._updateWidthHeight()}set height(ci){this._tiledHeight=ci,this._updateWidthHeight()}}const maxMessages=5,obsoleteMessage={},resetObsoleteCounter=()=>{for(const fi in obsoleteMessage)obsoleteMessage[fi]=0},logMessage=(fi,ci)=>{const hi=Flags.isEnabled("suppress-obsolete-message");obsoleteMessage[fi]<maxMessages&&!hi&&(Logger.getInstance().warn(fi),console.trace&&ci.showStackTrace&&console.trace()),obsoleteMessage[fi]++};function obsolete(fi){return fi={message:"This feature will be removed in future versions of Excalibur.",alternateMethod:null,showStackTrace:!1,...fi},function(ci,hi,_i){if(_i&&!(typeof _i.value=="function"||typeof _i.get=="function"||typeof _i.set=="function"))throw new SyntaxError("Only classes/functions/getters/setters can be marked as obsolete");const mi=`${`${ci.name||""}${ci.name&&hi?".":""}${hi||""}`} is marked obsolete: ${fi.message}`+(fi.alternateMethod?` Use ${fi.alternateMethod} instead`:"");obsoleteMessage[mi]||(obsoleteMessage[mi]=0);const gi=_i?{..._i}:ci;if(!_i){class vi extends gi{constructor(...wi){logMessage(mi,fi),super(...wi)}}return vi}return _i&&_i.value?(gi.value=function(){return logMessage(mi,fi),_i.value.apply(this,arguments)},gi):(_i&&_i.get&&(gi.get=function(){return logMessage(mi,fi),_i.get.apply(this,arguments)}),_i&&_i.set&&(gi.set=function(){return logMessage(mi,fi),_i.set.apply(this,arguments)}),gi)}}class AsyncWaitQueue{constructor(){this._queue=[]}get length(){return this._queue.length}enqueue(){const ci=new Future;return this._queue.push(ci),ci.promise}dequeue(ci){this._queue.shift().resolve(ci)}}class Semaphore{constructor(ci){this._count=ci,this._waitQueue=new AsyncWaitQueue}get count(){return this._count}get waiting(){return this._waitQueue.length}async enter(){return this._count!==0?(this._count--,Promise.resolve()):this._waitQueue.enqueue()}exit(ci=1){if(ci!==0){for(;ci!==0&&this._waitQueue.length!==0;)this._waitQueue.dequeue(null),ci--;this._count+=ci}}}const EX_VERSION="0.30.3";polyfill();var __webpack_exports__ActionCompleteEvent=__webpack_exports__.eKr,__webpack_exports__ActionContext=__webpack_exports__.yVm,__webpack_exports__ActionQueue=__webpack_exports__.a7j,__webpack_exports__ActionSequence=__webpack_exports__.U_w,__webpack_exports__ActionStartEvent=__webpack_exports__.JF2,__webpack_exports__ActionsComponent=__webpack_exports__.htg,__webpack_exports__ActionsSystem=__webpack_exports__.HXL,__webpack_exports__ActivateEvent=__webpack_exports__.mcg,__webpack_exports__Actor=__webpack_exports__.Agj,__webpack_exports__ActorEvents=__webpack_exports__.J3_,__webpack_exports__AddEvent=__webpack_exports__.Wgv,__webpack_exports__AddedComponent=__webpack_exports__.u6S,__webpack_exports__AffineMatrix=__webpack_exports__.x7M,__webpack_exports__Animation=__webpack_exports__.X55,__webpack_exports__AnimationDirection=__webpack_exports__.m3M,__webpack_exports__AnimationEvents=__webpack_exports__.aE5,__webpack_exports__AnimationStrategy=__webpack_exports__.YJU,__webpack_exports__ArcadeSolver=__webpack_exports__.eZi,__webpack_exports__AudioContextFactory=__webpack_exports__.GNv,__webpack_exports__Axes=__webpack_exports__.Y56,__webpack_exports__Axis=__webpack_exports__._0v,__webpack_exports__BaseAlign=__webpack_exports__.vhs,__webpack_exports__BezierCurve=__webpack_exports__.vrQ,__webpack_exports__Blink=__webpack_exports__.Z8b,__webpack_exports__BodyComponent=__webpack_exports__.Yfw,__webpack_exports__BoundingBox=__webpack_exports__.IcQ,__webpack_exports__BrowserComponent=__webpack_exports__.kgJ,__webpack_exports__BrowserEvents=__webpack_exports__.GTT,__webpack_exports__Buttons=__webpack_exports__.ypY,__webpack_exports__Camera=__webpack_exports__.i7d,__webpack_exports__CameraEvents=__webpack_exports__.fQ3,__webpack_exports__Canvas=__webpack_exports__.HlI,__webpack_exports__Circle=__webpack_exports__.jlt,__webpack_exports__CircleCollider=__webpack_exports__.VQc,__webpack_exports__Clock=__webpack_exports__.zD7,__webpack_exports__ClosestLineJumpTable=__webpack_exports__.AUF,__webpack_exports__Collider=__webpack_exports__.JoF,__webpack_exports__ColliderComponent=__webpack_exports__.MlA,__webpack_exports__CollisionContact=__webpack_exports__.PZh,__webpack_exports__CollisionEndEvent=__webpack_exports__.qA,__webpack_exports__CollisionGroup=__webpack_exports__.CrD,__webpack_exports__CollisionGroupManager=__webpack_exports__.dQK,__webpack_exports__CollisionJumpTable=__webpack_exports__.D3r,__webpack_exports__CollisionPostSolveEvent=__webpack_exports__.Qpo,__webpack_exports__CollisionPreSolveEvent=__webpack_exports__.D9n,__webpack_exports__CollisionStartEvent=__webpack_exports__.b6v,__webpack_exports__CollisionSystem=__webpack_exports__.mvh,__webpack_exports__CollisionType=__webpack_exports__.Bpo,__webpack_exports__Color=__webpack_exports__.Q1f,__webpack_exports__ColorBlindFlags=__webpack_exports__.IKv,__webpack_exports__ColorBlindnessMode=__webpack_exports__.fcV,__webpack_exports__ColorBlindnessPostProcessor=__webpack_exports__.Glf,__webpack_exports__Component=__webpack_exports__.uAl,__webpack_exports__CompositeCollider=__webpack_exports__.ElT,__webpack_exports__ConsoleAppender=__webpack_exports__.Z8r,__webpack_exports__ContactConstraintPoint=__webpack_exports__.QSL,__webpack_exports__ContactEndEvent=__webpack_exports__.sPV,__webpack_exports__ContactSolveBias=__webpack_exports__.nAn,__webpack_exports__ContactStartEvent=__webpack_exports__.zCU,__webpack_exports__CoordPlane=__webpack_exports__.QrV,__webpack_exports__CrossFade=__webpack_exports__.fF9,__webpack_exports__CurveBy=__webpack_exports__.Jqv,__webpack_exports__CurveTo=__webpack_exports__.d_u,__webpack_exports__DeactivateEvent=__webpack_exports__.xI8,__webpack_exports__Debug=__webpack_exports__.yar,__webpack_exports__DebugConfig=__webpack_exports__.SP7,__webpack_exports__DebugGraphicsComponent=__webpack_exports__.oRy,__webpack_exports__DebugSystem=__webpack_exports__.f5X,__webpack_exports__DebugText=__webpack_exports__.V1c,__webpack_exports__DefaultAntialiasOptions=__webpack_exports__.Mlx,__webpack_exports__DefaultGarbageCollectionOptions=__webpack_exports__.ZiM,__webpack_exports__DefaultLoader=__webpack_exports__.ZCo,__webpack_exports__DefaultPixelArtOptions=__webpack_exports__.J5p,__webpack_exports__DegreeOfFreedom=__webpack_exports__.mL_,__webpack_exports__Delay=__webpack_exports__.Guw,__webpack_exports__Detector=__webpack_exports__.N5j,__webpack_exports__Die=__webpack_exports__.pgY,__webpack_exports__Direction=__webpack_exports__.OP3,__webpack_exports__Director=__webpack_exports__.rl5,__webpack_exports__DirectorEvents=__webpack_exports__.eod,__webpack_exports__DisplayMode=__webpack_exports__.q5Z,__webpack_exports__DynamicTree=__webpack_exports__.YUC,__webpack_exports__DynamicTreeCollisionProcessor=__webpack_exports__.saR,__webpack_exports__EX_VERSION=__webpack_exports__.hvr,__webpack_exports__EaseBy=__webpack_exports__.Qol,__webpack_exports__EaseTo=__webpack_exports__.Wf4,__webpack_exports__EasingFunctions=__webpack_exports__.JCs,__webpack_exports__EdgeCollider=__webpack_exports__.gJV,__webpack_exports__ElasticToActorStrategy=__webpack_exports__.fWD,__webpack_exports__EmitterType=__webpack_exports__.Va_,__webpack_exports__Engine=__webpack_exports__.N$8,__webpack_exports__EngineEvents=__webpack_exports__._jQ,__webpack_exports__EnterTriggerEvent=__webpack_exports__.rxj,__webpack_exports__EnterViewPortEvent=__webpack_exports__.rhv,__webpack_exports__Entity=__webpack_exports__.wCu,__webpack_exports__EntityEvents=__webpack_exports__.HAp,__webpack_exports__EntityManager=__webpack_exports__.Zy1,__webpack_exports__EventEmitter=__webpack_exports__.bkB,__webpack_exports__EventTypes=__webpack_exports__.wfL,__webpack_exports__Events=__webpack_exports__.sVA,__webpack_exports__ExResponse=__webpack_exports__.$Gs,__webpack_exports__ExcaliburGraphicsContext2DCanvas=__webpack_exports__.CJ0,__webpack_exports__ExcaliburGraphicsContextWebGL=__webpack_exports__.NWh,__webpack_exports__ExitTriggerEvent=__webpack_exports__.tWi,__webpack_exports__ExitViewPortEvent=__webpack_exports__.xAj,__webpack_exports__Fade=__webpack_exports__.zWh,__webpack_exports__FadeInOut=__webpack_exports__.i_4,__webpack_exports__Flags=__webpack_exports__.iIx,__webpack_exports__Flash=__webpack_exports__.Hxo,__webpack_exports__Follow=__webpack_exports__.c9e,__webpack_exports__Font=__webpack_exports__.KQV,__webpack_exports__FontCache=__webpack_exports__.weH,__webpack_exports__FontSource=__webpack_exports__.jXp,__webpack_exports__FontStyle=__webpack_exports__.zzY,__webpack_exports__FontUnit=__webpack_exports__.yRQ,__webpack_exports__FpsSampler=__webpack_exports__.MtE,__webpack_exports__FrameStats=__webpack_exports__.rPj,__webpack_exports__Future=__webpack_exports__.KLc,__webpack_exports__GameEvent=__webpack_exports__.Fir,__webpack_exports__GameStartEvent=__webpack_exports__.V5f,__webpack_exports__GameStopEvent=__webpack_exports__.Xj7,__webpack_exports__Gamepad=__webpack_exports__.Wud,__webpack_exports__GamepadAxisEvent=__webpack_exports__.FVg,__webpack_exports__GamepadButtonEvent=__webpack_exports__.g5Y,__webpack_exports__GamepadConnectEvent=__webpack_exports__.YQB,__webpack_exports__GamepadDisconnectEvent=__webpack_exports__.KPb,__webpack_exports__Gamepads=__webpack_exports__.nHK,__webpack_exports__GarbageCollector=__webpack_exports__.Jrb,__webpack_exports__Gif=__webpack_exports__.TX_,__webpack_exports__GifParser=__webpack_exports__.Olt,__webpack_exports__GlobalCoordinates=__webpack_exports__.r3n,__webpack_exports__GpuParticleEmitter=__webpack_exports__.Fvk,__webpack_exports__GpuParticleRenderer=__webpack_exports__.gpR,__webpack_exports__Graphic=__webpack_exports__.vYh,__webpack_exports__GraphicsComponent=__webpack_exports__.hnk,__webpack_exports__GraphicsGroup=__webpack_exports__.D2R,__webpack_exports__GraphicsSystem=__webpack_exports__.n1o,__webpack_exports__HashColliderProxy=__webpack_exports__.h9O,__webpack_exports__HashGridCell=__webpack_exports__.X5j,__webpack_exports__HashGridProxy=__webpack_exports__.p3P,__webpack_exports__HiddenEvent=__webpack_exports__.RLG,__webpack_exports__HorizontalFirst=__webpack_exports__.fBU,__webpack_exports__ImageFiltering=__webpack_exports__.Adb,__webpack_exports__ImageSource=__webpack_exports__.bEs,__webpack_exports__ImageSourceAttributeConstants=__webpack_exports__.wCy,__webpack_exports__ImageWrapping=__webpack_exports__.CbD,__webpack_exports__InitializeEvent=__webpack_exports__.x_C,__webpack_exports__InputHost=__webpack_exports__.pGf,__webpack_exports__InputMapper=__webpack_exports__.ibQ,__webpack_exports__IsometricEntityComponent=__webpack_exports__.shR,__webpack_exports__IsometricEntitySystem=__webpack_exports__.Yjk,__webpack_exports__IsometricMap=__webpack_exports__._u1,__webpack_exports__IsometricTile=__webpack_exports__.OBI,__webpack_exports__KeyEvent=__webpack_exports__.klh,__webpack_exports__Keyboard=__webpack_exports__.s3S,__webpack_exports__Keys=__webpack_exports__.D$R,__webpack_exports__KillEvent=__webpack_exports__.xth,__webpack_exports__Label=__webpack_exports__.JU7,__webpack_exports__LimitCameraBoundsStrategy=__webpack_exports__.h9x,__webpack_exports__Line=__webpack_exports__.N1A,__webpack_exports__LineSegment=__webpack_exports__.e_k,__webpack_exports__Loader=__webpack_exports__.aHM,__webpack_exports__LoaderEvents=__webpack_exports__.tlv,__webpack_exports__LockCameraToActorAxisStrategy=__webpack_exports__.Vi9,__webpack_exports__LockCameraToActorStrategy=__webpack_exports__.ieR,__webpack_exports__LogLevel=__webpack_exports__.$bb,__webpack_exports__Logger=__webpack_exports__.VyI,__webpack_exports__Material=__webpack_exports__.imn,__webpack_exports__Matrix=__webpack_exports__.uqu,__webpack_exports__MatrixLocations=__webpack_exports__.QnL,__webpack_exports__MediaEvent=__webpack_exports__.vnc,__webpack_exports__Meet=__webpack_exports__.wk_,__webpack_exports__MotionComponent=__webpack_exports__.GH0,__webpack_exports__MotionSystem=__webpack_exports__._1r,__webpack_exports__MoveBy=__webpack_exports__.l0X,__webpack_exports__MoveByWithOptions=__webpack_exports__.bT,__webpack_exports__MoveTo=__webpack_exports__.HHX,__webpack_exports__MoveToWithOptions=__webpack_exports__.jtW,__webpack_exports__NativePointerButton=__webpack_exports__.tjk,__webpack_exports__NativeSoundEvent=__webpack_exports__.rWe,__webpack_exports__NativeSoundProcessedEvent=__webpack_exports__.j9l,__webpack_exports__NineSlice=__webpack_exports__.l0$,__webpack_exports__NineSliceStretch=__webpack_exports__.sGJ,__webpack_exports__None=__webpack_exports__.NVp,__webpack_exports__Observable=__webpack_exports__.cPK,__webpack_exports__OffscreenSystem=__webpack_exports__.XoL,__webpack_exports__Pair=__webpack_exports__.RmF,__webpack_exports__ParallaxComponent=__webpack_exports__.DXI,__webpack_exports__ParallelActions=__webpack_exports__.tCD,__webpack_exports__Particle=__webpack_exports__.J3D,__webpack_exports__ParticleEmitter=__webpack_exports__.vCJ,__webpack_exports__ParticleRenderer=__webpack_exports__.e6k,__webpack_exports__ParticleTransform=__webpack_exports__.f9l,__webpack_exports__PhysicsStats=__webpack_exports__.v9m,__webpack_exports__PhysicsWorld=__webpack_exports__.yRJ,__webpack_exports__PointerAbstraction=__webpack_exports__.EU6,__webpack_exports__PointerButton=__webpack_exports__.m3O,__webpack_exports__PointerComponent=__webpack_exports__.Ryz,__webpack_exports__PointerEvent=__webpack_exports__.OxP,__webpack_exports__PointerEventReceiver=__webpack_exports__.LEs,__webpack_exports__PointerScope=__webpack_exports__.Ec,__webpack_exports__PointerSystem=__webpack_exports__.Pi5,__webpack_exports__PointerType=__webpack_exports__.gmH,__webpack_exports__Polygon=__webpack_exports__.tS,__webpack_exports__PolygonCollider=__webpack_exports__.XxX,__webpack_exports__Pool=__webpack_exports__.bCz,__webpack_exports__PostCollisionEvent=__webpack_exports__.nYS,__webpack_exports__PostDebugDrawEvent=__webpack_exports__.yiT,__webpack_exports__PostDrawEvent=__webpack_exports__.NHl,__webpack_exports__PostFrameEvent=__webpack_exports__.mO8,__webpack_exports__PostKillEvent=__webpack_exports__.PXI,__webpack_exports__PostTransformDrawEvent=__webpack_exports__.bn5,__webpack_exports__PostUpdateEvent=__webpack_exports__.Ywr,__webpack_exports__PreCollisionEvent=__webpack_exports__.cMd,__webpack_exports__PreDebugDrawEvent=__webpack_exports__.Bs6,__webpack_exports__PreDrawEvent=__webpack_exports__.G0k,__webpack_exports__PreFrameEvent=__webpack_exports__.pyn,__webpack_exports__PreKillEvent=__webpack_exports__.QeM,__webpack_exports__PreLoadEvent=__webpack_exports__.aPX,__webpack_exports__PreTransformDrawEvent=__webpack_exports__.ITP,__webpack_exports__PreUpdateEvent=__webpack_exports__.BY0,__webpack_exports__Projection=__webpack_exports__.MFw,__webpack_exports__QuadIndexBuffer=__webpack_exports__.sBn,__webpack_exports__QuadTree=__webpack_exports__.S3L,__webpack_exports__Query=__webpack_exports__.XKQ,__webpack_exports__QueryManager=__webpack_exports__.ESI,__webpack_exports__RadiusAroundActorStrategy=__webpack_exports__.uxz,__webpack_exports__Random=__webpack_exports__.o8N,__webpack_exports__Raster=__webpack_exports__.u_r,__webpack_exports__Ray=__webpack_exports__.RlV,__webpack_exports__RealisticSolver=__webpack_exports__.gVA,__webpack_exports__Rectangle=__webpack_exports__.M_G,__webpack_exports__RemoveEvent=__webpack_exports__.BpG,__webpack_exports__RemovedComponent=__webpack_exports__.GRB,__webpack_exports__Repeat=__webpack_exports__.kM6,__webpack_exports__RepeatForever=__webpack_exports__.dO8,__webpack_exports__Resolution=__webpack_exports__.jgM,__webpack_exports__Resource=__webpack_exports__.FWq,__webpack_exports__ResourceEvents=__webpack_exports__.s3j,__webpack_exports__RotateBy=__webpack_exports__.hlw,__webpack_exports__RotateByWithOptions=__webpack_exports__.L0q,__webpack_exports__RotateTo=__webpack_exports__.B7e,__webpack_exports__RotateToWithOptions=__webpack_exports__.PGN,__webpack_exports__RotationType=__webpack_exports__.H_X,__webpack_exports__ScaleBy=__webpack_exports__.S_d,__webpack_exports__ScaleByWithOptions=__webpack_exports__._Tq,__webpack_exports__ScaleTo=__webpack_exports__.U7E,__webpack_exports__ScaleToWithOptions=__webpack_exports__.IOH,__webpack_exports__Scene=__webpack_exports__.Z58,__webpack_exports__SceneEvents=__webpack_exports__.yh2,__webpack_exports__Screen=__webpack_exports__.ff$,__webpack_exports__ScreenAppender=__webpack_exports__.cWi,__webpack_exports__ScreenElement=__webpack_exports__.NBt,__webpack_exports__ScreenEvents=__webpack_exports__.oNz,__webpack_exports__ScreenShader=__webpack_exports__.QlU,__webpack_exports__ScrollPreventionMode=__webpack_exports__.Xey,__webpack_exports__Semaphore=__webpack_exports__.jft,__webpack_exports__SeparatingAxis=__webpack_exports__._r8,__webpack_exports__SeparationInfo=__webpack_exports__.bTC,__webpack_exports__Shader=__webpack_exports__.Mtr,__webpack_exports__Shape=__webpack_exports__.ypk,__webpack_exports__Side=__webpack_exports__.mnM,__webpack_exports__Slide=__webpack_exports__.q7S,__webpack_exports__SolverStrategy=__webpack_exports__.bAZ,__webpack_exports__Sound=__webpack_exports__.ABN,__webpack_exports__SoundEvents=__webpack_exports__.VK6,__webpack_exports__SparseHashGrid=__webpack_exports__.Hj2,__webpack_exports__SparseHashGridCollisionProcessor=__webpack_exports__.Df8,__webpack_exports__SpatialPartitionStrategy=__webpack_exports__.oOx,__webpack_exports__Sprite=__webpack_exports__.kxk,__webpack_exports__SpriteFont=__webpack_exports__.DT1,__webpack_exports__SpriteSheet=__webpack_exports__.FLG,__webpack_exports__StandardClock=__webpack_exports__.qN_,__webpack_exports__StateMachine=__webpack_exports__.Z37,__webpack_exports__StrategyContainer=__webpack_exports__.FtL,__webpack_exports__Stream=__webpack_exports__.Z6X,__webpack_exports__System=__webpack_exports__.iQT,__webpack_exports__SystemManager=__webpack_exports__.ziO,__webpack_exports__SystemPriority=__webpack_exports__.OEF,__webpack_exports__SystemType=__webpack_exports__.uuE,__webpack_exports__TagQuery=__webpack_exports__.tiv,__webpack_exports__TestClock=__webpack_exports__.T$Y,__webpack_exports__Text=__webpack_exports__.EYj,__webpack_exports__TextAlign=__webpack_exports__.nOB,__webpack_exports__TextureLoader=__webpack_exports__.Tap,__webpack_exports__Tile=__webpack_exports__.FAs,__webpack_exports__TileMap=__webpack_exports__.B_P,__webpack_exports__TileMapEvents=__webpack_exports__.aA5,__webpack_exports__TiledAnimation=__webpack_exports__.J3s,__webpack_exports__TiledSprite=__webpack_exports__.Y0Q,__webpack_exports__Timer=__webpack_exports__.M4G,__webpack_exports__Toaster=__webpack_exports__.l$l,__webpack_exports__Transform=__webpack_exports__.dLy,__webpack_exports__TransformComponent=__webpack_exports__.WZP,__webpack_exports__Transition=__webpack_exports__.eB6,__webpack_exports__TreeNode=__webpack_exports__.nFK,__webpack_exports__Trigger=__webpack_exports__.l9z,__webpack_exports__TriggerEvents=__webpack_exports__.YOF,__webpack_exports__TwoPI=__webpack_exports__.yhB,__webpack_exports__Util=__webpack_exports__.J0N,__webpack_exports__Vector=__webpack_exports__.Miz,__webpack_exports__VectorView=__webpack_exports__.Bj4,__webpack_exports__VertexBuffer=__webpack_exports__.Rcs,__webpack_exports__VertexLayout=__webpack_exports__.vJ4,__webpack_exports__VerticalFirst=__webpack_exports__.TqC,__webpack_exports__VisibleEvent=__webpack_exports__.nM0,__webpack_exports__WebAudio=__webpack_exports__.X1u,__webpack_exports__WebAudioInstance=__webpack_exports__.SpZ,__webpack_exports__WheelDeltaMode=__webpack_exports__.DX8,__webpack_exports__WheelEvent=__webpack_exports__.Yx$,__webpack_exports__World=__webpack_exports__.HK4,__webpack_exports__approximatelyEqual=__webpack_exports__.yt5,__webpack_exports__assert=__webpack_exports__.vAR,__webpack_exports__canonicalizeAngle=__webpack_exports__.SE$,__webpack_exports__clamp=__webpack_exports__.qE8,__webpack_exports__coroutine=__webpack_exports__.Pz7,__webpack_exports__createId=__webpack_exports__.sX_,__webpack_exports__frac=__webpack_exports__.JuI,__webpack_exports__getDefaultPhysicsConfig=__webpack_exports__.pxT,__webpack_exports__hasGraphicsTick=__webpack_exports__.Nl$,__webpack_exports__hasOnAdd=__webpack_exports__.zDr,__webpack_exports__hasOnInitialize=__webpack_exports__.OwT,__webpack_exports__hasOnPostUpdate=__webpack_exports__.P$G,__webpack_exports__hasOnPreUpdate=__webpack_exports__.mHV,__webpack_exports__hasOnRemove=__webpack_exports__.kEA,__webpack_exports__hasPostDraw=__webpack_exports__.Fx_,__webpack_exports__hasPreDraw=__webpack_exports__.WFC,__webpack_exports__has_add=__webpack_exports__.vKu,__webpack_exports__has_initialize=__webpack_exports__.aDq,__webpack_exports__has_postupdate=__webpack_exports__.jIg,__webpack_exports__has_preupdate=__webpack_exports__.UH3,__webpack_exports__has_remove=__webpack_exports__.AJO,__webpack_exports__inverseLerp=__webpack_exports__.U4,__webpack_exports__inverseLerpVector=__webpack_exports__.xAc,__webpack_exports__isActor=__webpack_exports__._3Y,__webpack_exports__isAddedComponent=__webpack_exports__.K6X,__webpack_exports__isComponentCtor=__webpack_exports__.C1Y,__webpack_exports__isLoaderConstructor=__webpack_exports__.Aw1,__webpack_exports__isMoveByOptions=__webpack_exports__.tm8,__webpack_exports__isMoveToOptions=__webpack_exports__.LBV,__webpack_exports__isRemovedComponent=__webpack_exports__.A8$,__webpack_exports__isRotateByOptions=__webpack_exports__.F5e,__webpack_exports__isRotateToOptions=__webpack_exports__.ran,__webpack_exports__isScaleByOptions=__webpack_exports__.c8L,__webpack_exports__isScaleToOptions=__webpack_exports__.o6M,__webpack_exports__isSceneConstructor=__webpack_exports__.hsx,__webpack_exports__isScreenElement=__webpack_exports__.l9E,__webpack_exports__isSystemConstructor=__webpack_exports__.aSf,__webpack_exports__lerp=__webpack_exports__.CcK,__webpack_exports__lerpAngle=__webpack_exports__.nU8,__webpack_exports__lerpVector=__webpack_exports__.td6,__webpack_exports__maxMessages=__webpack_exports__.Zex,__webpack_exports__nextActionId=__webpack_exports__.bkJ,__webpack_exports__obsolete=__webpack_exports__.mXP,__webpack_exports__parseImageFiltering=__webpack_exports__.vt$,__webpack_exports__parseImageWrapping=__webpack_exports__.hCA,__webpack_exports__pixelSnapEpsilon=__webpack_exports__.pjR,__webpack_exports__randomInRange=__webpack_exports__.U43,__webpack_exports__randomIntInRange=__webpack_exports__.pSZ,__webpack_exports__range=__webpack_exports__.y17,__webpack_exports__remap=__webpack_exports__.Ew7,__webpack_exports__remapVector=__webpack_exports__.hG1,__webpack_exports__resetObsoleteCounter=__webpack_exports__.jVr,__webpack_exports__sign=__webpack_exports__._SZ,__webpack_exports__toDegrees=__webpack_exports__.xWn,__webpack_exports__toRadians=__webpack_exports__.ehJ,__webpack_exports__vec=__webpack_exports__.t6s,__webpack_exports__webgl=__webpack_exports__.Eyn;const ex=Object.freeze(Object.defineProperty({__proto__:null,ActionCompleteEvent:__webpack_exports__ActionCompleteEvent,ActionContext:__webpack_exports__ActionContext,ActionQueue:__webpack_exports__ActionQueue,ActionSequence:__webpack_exports__ActionSequence,ActionStartEvent:__webpack_exports__ActionStartEvent,ActionsComponent:__webpack_exports__ActionsComponent,ActionsSystem:__webpack_exports__ActionsSystem,ActivateEvent:__webpack_exports__ActivateEvent,Actor:__webpack_exports__Actor,ActorEvents:__webpack_exports__ActorEvents,AddEvent:__webpack_exports__AddEvent,AddedComponent:__webpack_exports__AddedComponent,AffineMatrix:__webpack_exports__AffineMatrix,Animation:__webpack_exports__Animation,AnimationDirection:__webpack_exports__AnimationDirection,AnimationEvents:__webpack_exports__AnimationEvents,AnimationStrategy:__webpack_exports__AnimationStrategy,ArcadeSolver:__webpack_exports__ArcadeSolver,AudioContextFactory:__webpack_exports__AudioContextFactory,Axes:__webpack_exports__Axes,Axis:__webpack_exports__Axis,BaseAlign:__webpack_exports__BaseAlign,BezierCurve:__webpack_exports__BezierCurve,Blink:__webpack_exports__Blink,BodyComponent:__webpack_exports__BodyComponent,BoundingBox:__webpack_exports__BoundingBox,BrowserComponent:__webpack_exports__BrowserComponent,BrowserEvents:__webpack_exports__BrowserEvents,Buttons:__webpack_exports__Buttons,Camera:__webpack_exports__Camera,CameraEvents:__webpack_exports__CameraEvents,Canvas:__webpack_exports__Canvas,Circle:__webpack_exports__Circle,CircleCollider:__webpack_exports__CircleCollider,Clock:__webpack_exports__Clock,ClosestLineJumpTable:__webpack_exports__ClosestLineJumpTable,Collider:__webpack_exports__Collider,ColliderComponent:__webpack_exports__ColliderComponent,CollisionContact:__webpack_exports__CollisionContact,CollisionEndEvent:__webpack_exports__CollisionEndEvent,CollisionGroup:__webpack_exports__CollisionGroup,CollisionGroupManager:__webpack_exports__CollisionGroupManager,CollisionJumpTable:__webpack_exports__CollisionJumpTable,CollisionPostSolveEvent:__webpack_exports__CollisionPostSolveEvent,CollisionPreSolveEvent:__webpack_exports__CollisionPreSolveEvent,CollisionStartEvent:__webpack_exports__CollisionStartEvent,CollisionSystem:__webpack_exports__CollisionSystem,CollisionType:__webpack_exports__CollisionType,Color:__webpack_exports__Color,ColorBlindFlags:__webpack_exports__ColorBlindFlags,ColorBlindnessMode:__webpack_exports__ColorBlindnessMode,ColorBlindnessPostProcessor:__webpack_exports__ColorBlindnessPostProcessor,Component:__webpack_exports__Component,CompositeCollider:__webpack_exports__CompositeCollider,ConsoleAppender:__webpack_exports__ConsoleAppender,ContactConstraintPoint:__webpack_exports__ContactConstraintPoint,ContactEndEvent:__webpack_exports__ContactEndEvent,ContactSolveBias:__webpack_exports__ContactSolveBias,ContactStartEvent:__webpack_exports__ContactStartEvent,CoordPlane:__webpack_exports__CoordPlane,CrossFade:__webpack_exports__CrossFade,CurveBy:__webpack_exports__CurveBy,CurveTo:__webpack_exports__CurveTo,DeactivateEvent:__webpack_exports__DeactivateEvent,Debug:__webpack_exports__Debug,DebugConfig:__webpack_exports__DebugConfig,DebugGraphicsComponent:__webpack_exports__DebugGraphicsComponent,DebugSystem:__webpack_exports__DebugSystem,DebugText:__webpack_exports__DebugText,DefaultAntialiasOptions:__webpack_exports__DefaultAntialiasOptions,DefaultGarbageCollectionOptions:__webpack_exports__DefaultGarbageCollectionOptions,DefaultLoader:__webpack_exports__DefaultLoader,DefaultPixelArtOptions:__webpack_exports__DefaultPixelArtOptions,DegreeOfFreedom:__webpack_exports__DegreeOfFreedom,Delay:__webpack_exports__Delay,Detector:__webpack_exports__Detector,Die:__webpack_exports__Die,Direction:__webpack_exports__Direction,Director:__webpack_exports__Director,DirectorEvents:__webpack_exports__DirectorEvents,DisplayMode:__webpack_exports__DisplayMode,DynamicTree:__webpack_exports__DynamicTree,DynamicTreeCollisionProcessor:__webpack_exports__DynamicTreeCollisionProcessor,EX_VERSION:__webpack_exports__EX_VERSION,EaseBy:__webpack_exports__EaseBy,EaseTo:__webpack_exports__EaseTo,EasingFunctions:__webpack_exports__EasingFunctions,EdgeCollider:__webpack_exports__EdgeCollider,ElasticToActorStrategy:__webpack_exports__ElasticToActorStrategy,EmitterType:__webpack_exports__EmitterType,Engine:__webpack_exports__Engine,EngineEvents:__webpack_exports__EngineEvents,EnterTriggerEvent:__webpack_exports__EnterTriggerEvent,EnterViewPortEvent:__webpack_exports__EnterViewPortEvent,Entity:__webpack_exports__Entity,EntityEvents:__webpack_exports__EntityEvents,EntityManager:__webpack_exports__EntityManager,EventEmitter:__webpack_exports__EventEmitter,EventTypes:__webpack_exports__EventTypes,Events:__webpack_exports__Events,ExResponse:__webpack_exports__ExResponse,ExcaliburGraphicsContext2DCanvas:__webpack_exports__ExcaliburGraphicsContext2DCanvas,ExcaliburGraphicsContextWebGL:__webpack_exports__ExcaliburGraphicsContextWebGL,ExitTriggerEvent:__webpack_exports__ExitTriggerEvent,ExitViewPortEvent:__webpack_exports__ExitViewPortEvent,Fade:__webpack_exports__Fade,FadeInOut:__webpack_exports__FadeInOut,Flags:__webpack_exports__Flags,Flash:__webpack_exports__Flash,Follow:__webpack_exports__Follow,Font:__webpack_exports__Font,FontCache:__webpack_exports__FontCache,FontSource:__webpack_exports__FontSource,FontStyle:__webpack_exports__FontStyle,FontUnit:__webpack_exports__FontUnit,FpsSampler:__webpack_exports__FpsSampler,FrameStats:__webpack_exports__FrameStats,Future:__webpack_exports__Future,GameEvent:__webpack_exports__GameEvent,GameStartEvent:__webpack_exports__GameStartEvent,GameStopEvent:__webpack_exports__GameStopEvent,Gamepad:__webpack_exports__Gamepad,GamepadAxisEvent:__webpack_exports__GamepadAxisEvent,GamepadButtonEvent:__webpack_exports__GamepadButtonEvent,GamepadConnectEvent:__webpack_exports__GamepadConnectEvent,GamepadDisconnectEvent:__webpack_exports__GamepadDisconnectEvent,Gamepads:__webpack_exports__Gamepads,GarbageCollector:__webpack_exports__GarbageCollector,Gif:__webpack_exports__Gif,GifParser:__webpack_exports__GifParser,GlobalCoordinates:__webpack_exports__GlobalCoordinates,GpuParticleEmitter:__webpack_exports__GpuParticleEmitter,GpuParticleRenderer:__webpack_exports__GpuParticleRenderer,Graphic:__webpack_exports__Graphic,GraphicsComponent:__webpack_exports__GraphicsComponent,GraphicsGroup:__webpack_exports__GraphicsGroup,GraphicsSystem:__webpack_exports__GraphicsSystem,HashColliderProxy:__webpack_exports__HashColliderProxy,HashGridCell:__webpack_exports__HashGridCell,HashGridProxy:__webpack_exports__HashGridProxy,HiddenEvent:__webpack_exports__HiddenEvent,HorizontalFirst:__webpack_exports__HorizontalFirst,ImageFiltering:__webpack_exports__ImageFiltering,ImageSource:__webpack_exports__ImageSource,ImageSourceAttributeConstants:__webpack_exports__ImageSourceAttributeConstants,ImageWrapping:__webpack_exports__ImageWrapping,InitializeEvent:__webpack_exports__InitializeEvent,InputHost:__webpack_exports__InputHost,InputMapper:__webpack_exports__InputMapper,IsometricEntityComponent:__webpack_exports__IsometricEntityComponent,IsometricEntitySystem:__webpack_exports__IsometricEntitySystem,IsometricMap:__webpack_exports__IsometricMap,IsometricTile:__webpack_exports__IsometricTile,KeyEvent:__webpack_exports__KeyEvent,Keyboard:__webpack_exports__Keyboard,Keys:__webpack_exports__Keys,KillEvent:__webpack_exports__KillEvent,Label:__webpack_exports__Label,LimitCameraBoundsStrategy:__webpack_exports__LimitCameraBoundsStrategy,Line:__webpack_exports__Line,LineSegment:__webpack_exports__LineSegment,Loader:__webpack_exports__Loader,LoaderEvents:__webpack_exports__LoaderEvents,LockCameraToActorAxisStrategy:__webpack_exports__LockCameraToActorAxisStrategy,LockCameraToActorStrategy:__webpack_exports__LockCameraToActorStrategy,LogLevel:__webpack_exports__LogLevel,Logger:__webpack_exports__Logger,Material:__webpack_exports__Material,Matrix:__webpack_exports__Matrix,MatrixLocations:__webpack_exports__MatrixLocations,MediaEvent:__webpack_exports__MediaEvent,Meet:__webpack_exports__Meet,MotionComponent:__webpack_exports__MotionComponent,MotionSystem:__webpack_exports__MotionSystem,MoveBy:__webpack_exports__MoveBy,MoveByWithOptions:__webpack_exports__MoveByWithOptions,MoveTo:__webpack_exports__MoveTo,MoveToWithOptions:__webpack_exports__MoveToWithOptions,NativePointerButton:__webpack_exports__NativePointerButton,NativeSoundEvent:__webpack_exports__NativeSoundEvent,NativeSoundProcessedEvent:__webpack_exports__NativeSoundProcessedEvent,NineSlice:__webpack_exports__NineSlice,NineSliceStretch:__webpack_exports__NineSliceStretch,None:__webpack_exports__None,Observable:__webpack_exports__Observable,OffscreenSystem:__webpack_exports__OffscreenSystem,Pair:__webpack_exports__Pair,ParallaxComponent:__webpack_exports__ParallaxComponent,ParallelActions:__webpack_exports__ParallelActions,Particle:__webpack_exports__Particle,ParticleEmitter:__webpack_exports__ParticleEmitter,ParticleRenderer:__webpack_exports__ParticleRenderer,ParticleTransform:__webpack_exports__ParticleTransform,PhysicsStats:__webpack_exports__PhysicsStats,PhysicsWorld:__webpack_exports__PhysicsWorld,PointerAbstraction:__webpack_exports__PointerAbstraction,PointerButton:__webpack_exports__PointerButton,PointerComponent:__webpack_exports__PointerComponent,PointerEvent:__webpack_exports__PointerEvent,PointerEventReceiver:__webpack_exports__PointerEventReceiver,PointerScope:__webpack_exports__PointerScope,PointerSystem:__webpack_exports__PointerSystem,PointerType:__webpack_exports__PointerType,Polygon:__webpack_exports__Polygon,PolygonCollider:__webpack_exports__PolygonCollider,Pool:__webpack_exports__Pool,PostCollisionEvent:__webpack_exports__PostCollisionEvent,PostDebugDrawEvent:__webpack_exports__PostDebugDrawEvent,PostDrawEvent:__webpack_exports__PostDrawEvent,PostFrameEvent:__webpack_exports__PostFrameEvent,PostKillEvent:__webpack_exports__PostKillEvent,PostTransformDrawEvent:__webpack_exports__PostTransformDrawEvent,PostUpdateEvent:__webpack_exports__PostUpdateEvent,PreCollisionEvent:__webpack_exports__PreCollisionEvent,PreDebugDrawEvent:__webpack_exports__PreDebugDrawEvent,PreDrawEvent:__webpack_exports__PreDrawEvent,PreFrameEvent:__webpack_exports__PreFrameEvent,PreKillEvent:__webpack_exports__PreKillEvent,PreLoadEvent:__webpack_exports__PreLoadEvent,PreTransformDrawEvent:__webpack_exports__PreTransformDrawEvent,PreUpdateEvent:__webpack_exports__PreUpdateEvent,Projection:__webpack_exports__Projection,QuadIndexBuffer:__webpack_exports__QuadIndexBuffer,QuadTree:__webpack_exports__QuadTree,Query:__webpack_exports__Query,QueryManager:__webpack_exports__QueryManager,RadiusAroundActorStrategy:__webpack_exports__RadiusAroundActorStrategy,Random:__webpack_exports__Random,Raster:__webpack_exports__Raster,Ray:__webpack_exports__Ray,RealisticSolver:__webpack_exports__RealisticSolver,Rectangle:__webpack_exports__Rectangle,RemoveEvent:__webpack_exports__RemoveEvent,RemovedComponent:__webpack_exports__RemovedComponent,Repeat:__webpack_exports__Repeat,RepeatForever:__webpack_exports__RepeatForever,Resolution:__webpack_exports__Resolution,Resource:__webpack_exports__Resource,ResourceEvents:__webpack_exports__ResourceEvents,RotateBy:__webpack_exports__RotateBy,RotateByWithOptions:__webpack_exports__RotateByWithOptions,RotateTo:__webpack_exports__RotateTo,RotateToWithOptions:__webpack_exports__RotateToWithOptions,RotationType:__webpack_exports__RotationType,ScaleBy:__webpack_exports__ScaleBy,ScaleByWithOptions:__webpack_exports__ScaleByWithOptions,ScaleTo:__webpack_exports__ScaleTo,ScaleToWithOptions:__webpack_exports__ScaleToWithOptions,Scene:__webpack_exports__Scene,SceneEvents:__webpack_exports__SceneEvents,Screen:__webpack_exports__Screen,ScreenAppender:__webpack_exports__ScreenAppender,ScreenElement:__webpack_exports__ScreenElement,ScreenEvents:__webpack_exports__ScreenEvents,ScreenShader:__webpack_exports__ScreenShader,ScrollPreventionMode:__webpack_exports__ScrollPreventionMode,Semaphore:__webpack_exports__Semaphore,SeparatingAxis:__webpack_exports__SeparatingAxis,SeparationInfo:__webpack_exports__SeparationInfo,Shader:__webpack_exports__Shader,Shape:__webpack_exports__Shape,Side:__webpack_exports__Side,Slide:__webpack_exports__Slide,SolverStrategy:__webpack_exports__SolverStrategy,Sound:__webpack_exports__Sound,SoundEvents:__webpack_exports__SoundEvents,SparseHashGrid:__webpack_exports__SparseHashGrid,SparseHashGridCollisionProcessor:__webpack_exports__SparseHashGridCollisionProcessor,SpatialPartitionStrategy:__webpack_exports__SpatialPartitionStrategy,Sprite:__webpack_exports__Sprite,SpriteFont:__webpack_exports__SpriteFont,SpriteSheet:__webpack_exports__SpriteSheet,StandardClock:__webpack_exports__StandardClock,StateMachine:__webpack_exports__StateMachine,StrategyContainer:__webpack_exports__StrategyContainer,Stream:__webpack_exports__Stream,System:__webpack_exports__System,SystemManager:__webpack_exports__SystemManager,SystemPriority:__webpack_exports__SystemPriority,SystemType:__webpack_exports__SystemType,TagQuery:__webpack_exports__TagQuery,TestClock:__webpack_exports__TestClock,Text:__webpack_exports__Text,TextAlign:__webpack_exports__TextAlign,TextureLoader:__webpack_exports__TextureLoader,Tile:__webpack_exports__Tile,TileMap:__webpack_exports__TileMap,TileMapEvents:__webpack_exports__TileMapEvents,TiledAnimation:__webpack_exports__TiledAnimation,TiledSprite:__webpack_exports__TiledSprite,Timer:__webpack_exports__Timer,Toaster:__webpack_exports__Toaster,Transform:__webpack_exports__Transform,TransformComponent:__webpack_exports__TransformComponent,Transition:__webpack_exports__Transition,TreeNode:__webpack_exports__TreeNode,Trigger:__webpack_exports__Trigger,TriggerEvents:__webpack_exports__TriggerEvents,TwoPI:__webpack_exports__TwoPI,Util:__webpack_exports__Util,Vector:__webpack_exports__Vector,VectorView:__webpack_exports__VectorView,VertexBuffer:__webpack_exports__VertexBuffer,VertexLayout:__webpack_exports__VertexLayout,VerticalFirst:__webpack_exports__VerticalFirst,VisibleEvent:__webpack_exports__VisibleEvent,WebAudio:__webpack_exports__WebAudio,WebAudioInstance:__webpack_exports__WebAudioInstance,WheelDeltaMode:__webpack_exports__WheelDeltaMode,WheelEvent:__webpack_exports__WheelEvent,World:__webpack_exports__World,approximatelyEqual:__webpack_exports__approximatelyEqual,assert:__webpack_exports__assert,canonicalizeAngle:__webpack_exports__canonicalizeAngle,clamp:__webpack_exports__clamp,coroutine:__webpack_exports__coroutine,createId:__webpack_exports__createId,frac:__webpack_exports__frac,getDefaultPhysicsConfig:__webpack_exports__getDefaultPhysicsConfig,hasGraphicsTick:__webpack_exports__hasGraphicsTick,hasOnAdd:__webpack_exports__hasOnAdd,hasOnInitialize:__webpack_exports__hasOnInitialize,hasOnPostUpdate:__webpack_exports__hasOnPostUpdate,hasOnPreUpdate:__webpack_exports__hasOnPreUpdate,hasOnRemove:__webpack_exports__hasOnRemove,hasPostDraw:__webpack_exports__hasPostDraw,hasPreDraw:__webpack_exports__hasPreDraw,has_add:__webpack_exports__has_add,has_initialize:__webpack_exports__has_initialize,has_postupdate:__webpack_exports__has_postupdate,has_preupdate:__webpack_exports__has_preupdate,has_remove:__webpack_exports__has_remove,inverseLerp:__webpack_exports__inverseLerp,inverseLerpVector:__webpack_exports__inverseLerpVector,isActor:__webpack_exports__isActor,isAddedComponent:__webpack_exports__isAddedComponent,isComponentCtor:__webpack_exports__isComponentCtor,isLoaderConstructor:__webpack_exports__isLoaderConstructor,isMoveByOptions:__webpack_exports__isMoveByOptions,isMoveToOptions:__webpack_exports__isMoveToOptions,isRemovedComponent:__webpack_exports__isRemovedComponent,isRotateByOptions:__webpack_exports__isRotateByOptions,isRotateToOptions:__webpack_exports__isRotateToOptions,isScaleByOptions:__webpack_exports__isScaleByOptions,isScaleToOptions:__webpack_exports__isScaleToOptions,isSceneConstructor:__webpack_exports__isSceneConstructor,isScreenElement:__webpack_exports__isScreenElement,isSystemConstructor:__webpack_exports__isSystemConstructor,lerp:__webpack_exports__lerp,lerpAngle:__webpack_exports__lerpAngle,lerpVector:__webpack_exports__lerpVector,maxMessages:__webpack_exports__maxMessages,nextActionId:__webpack_exports__nextActionId,obsolete:__webpack_exports__obsolete,parseImageFiltering:__webpack_exports__parseImageFiltering,parseImageWrapping:__webpack_exports__parseImageWrapping,pixelSnapEpsilon:__webpack_exports__pixelSnapEpsilon,randomInRange:__webpack_exports__randomInRange,randomIntInRange:__webpack_exports__randomIntInRange,range:__webpack_exports__range,remap:__webpack_exports__remap,remapVector:__webpack_exports__remapVector,resetObsoleteCounter:__webpack_exports__resetObsoleteCounter,sign:__webpack_exports__sign,toDegrees:__webpack_exports__toDegrees,toRadians:__webpack_exports__toRadians,vec:__webpack_exports__vec,webgl:__webpack_exports__webgl},Symbol.toStringTag,{value:"Module"})),scriptRel="modulepreload",assetsURL=function(fi){return"/roke/"+fi},seen={},__vitePreload=function(ci,hi,_i){let pi=Promise.resolve();if(hi&&hi.length>0){document.getElementsByTagName("link");const gi=document.querySelector("meta[property=csp-nonce]"),vi=(gi==null?void 0:gi.nonce)||(gi==null?void 0:gi.getAttribute("nonce"));pi=Promise.allSettled(hi.map(xi=>{if(xi=assetsURL(xi),xi in seen)return;seen[xi]=!0;const wi=xi.endsWith(".css"),yi=wi?'[rel="stylesheet"]':"";if(document.querySelector(`link[href="${xi}"]${yi}`))return;const Ci=document.createElement("link");if(Ci.rel=wi?"stylesheet":scriptRel,wi||(Ci.as="script"),Ci.crossOrigin="",Ci.href=xi,vi&&Ci.setAttribute("nonce",vi),document.head.appendChild(Ci),wi)return new Promise((Ei,Si)=>{Ci.addEventListener("load",Ei),Ci.addEventListener("error",()=>Si(new Error(`Unable to preload CSS for ${xi}`)))})}))}function mi(gi){const vi=new Event("vite:preloadError",{cancelable:!0});if(vi.payload=gi,window.dispatchEvent(vi),!vi.defaultPrevented)throw gi}return pi.then(gi=>{for(const vi of gi||[])vi.status==="rejected"&&mi(vi.reason);return ci().catch(mi)})};/*! Capacitor: https://capacitorjs.com/ - MIT License */const createCapacitorPlatforms=fi=>{const ci=new Map;ci.set("web",{name:"web"});const hi=fi.CapacitorPlatforms||{currentPlatform:{name:"web"},platforms:ci},_i=(mi,gi)=>{hi.platforms.set(mi,gi)},pi=mi=>{hi.platforms.has(mi)&&(hi.currentPlatform=hi.platforms.get(mi))};return hi.addPlatform=_i,hi.setPlatform=pi,hi},initPlatforms=fi=>fi.CapacitorPlatforms=createCapacitorPlatforms(fi),CapacitorPlatforms=initPlatforms(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{});CapacitorPlatforms.addPlatform;CapacitorPlatforms.setPlatform;var ExceptionCode;(function(fi){fi.Unimplemented="UNIMPLEMENTED",fi.Unavailable="UNAVAILABLE"})(ExceptionCode||(ExceptionCode={}));class CapacitorException extends Error{constructor(ci,hi,_i){super(ci),this.message=ci,this.code=hi,this.data=_i}}const getPlatformId=fi=>{var ci,hi;return fi!=null&&fi.androidBridge?"android":!((hi=(ci=fi==null?void 0:fi.webkit)===null||ci===void 0?void 0:ci.messageHandlers)===null||hi===void 0)&&hi.bridge?"ios":"web"},createCapacitor=fi=>{var ci,hi,_i,pi,mi;const gi=fi.CapacitorCustomPlatform||null,vi=fi.Capacitor||{},xi=vi.Plugins=vi.Plugins||{},wi=fi.CapacitorPlatforms,yi=()=>gi!==null?gi.name:getPlatformId(fi),Ci=((ci=wi==null?void 0:wi.currentPlatform)===null||ci===void 0?void 0:ci.getPlatform)||yi,Ei=()=>Ci()!=="web",Si=((hi=wi==null?void 0:wi.currentPlatform)===null||hi===void 0?void 0:hi.isNativePlatform)||Ei,ki=Mi=>{const $i=Ri.get(Mi);return!!($i!=null&&$i.platforms.has(Ci())||Ti(Mi))},Ai=((_i=wi==null?void 0:wi.currentPlatform)===null||_i===void 0?void 0:_i.isPluginAvailable)||ki,Ii=Mi=>{var $i;return($i=vi.PluginHeaders)===null||$i===void 0?void 0:$i.find(Oi=>Oi.name===Mi)},Ti=((pi=wi==null?void 0:wi.currentPlatform)===null||pi===void 0?void 0:pi.getPluginHeader)||Ii,Pi=Mi=>fi.console.error(Mi),Li=(Mi,$i,Oi)=>Promise.reject(`${Oi} does not have an implementation of "${$i}".`),Ri=new Map,Di=(Mi,$i={})=>{const Oi=Ri.get(Mi);if(Oi)return console.warn(`Capacitor plugin "${Mi}" already registered. Cannot register plugins twice.`),Oi.proxy;const Gi=Ci(),Ui=Ti(Mi);let zi;const Wi=async()=>(!zi&&Gi in $i?zi=typeof $i[Gi]=="function"?zi=await $i[Gi]():zi=$i[Gi]:gi!==null&&!zi&&"web"in $i&&(zi=typeof $i.web=="function"?zi=await $i.web():zi=$i.web),zi),Ni=(Vi,qi)=>{var Yi,Qi;if(Ui){const ts=Ui==null?void 0:Ui.methods.find(Zi=>qi===Zi.name);if(ts)return ts.rtype==="promise"?Zi=>vi.nativePromise(Mi,qi.toString(),Zi):(Zi,is)=>vi.nativeCallback(Mi,qi.toString(),Zi,is);if(Vi)return(Yi=Vi[qi])===null||Yi===void 0?void 0:Yi.bind(Vi)}else{if(Vi)return(Qi=Vi[qi])===null||Qi===void 0?void 0:Qi.bind(Vi);throw new CapacitorException(`"${Mi}" plugin is not implemented on ${Gi}`,ExceptionCode.Unimplemented)}},Hi=Vi=>{let qi;const Yi=(...Qi)=>{const ts=Wi().then(Zi=>{const is=Ni(Zi,Vi);if(is){const ss=is(...Qi);return qi=ss==null?void 0:ss.remove,ss}else throw new CapacitorException(`"${Mi}.${Vi}()" is not implemented on ${Gi}`,ExceptionCode.Unimplemented)});return Vi==="addListener"&&(ts.remove=async()=>qi()),ts};return Yi.toString=()=>`${Vi.toString()}() { [capacitor code] }`,Object.defineProperty(Yi,"name",{value:Vi,writable:!1,configurable:!1}),Yi},ji=Hi("addListener"),Bi=Hi("removeListener"),Ji=(Vi,qi)=>{const Yi=ji({eventName:Vi},qi),Qi=async()=>{const Zi=await Yi;Bi({eventName:Vi,callbackId:Zi},qi)},ts=new Promise(Zi=>Yi.then(()=>Zi({remove:Qi})));return ts.remove=async()=>{console.warn("Using addListener() without 'await' is deprecated."),await Qi()},ts},Ki=new Proxy({},{get(Vi,qi){switch(qi){case"$$typeof":return;case"toJSON":return()=>({});case"addListener":return Ui?Ji:ji;case"removeListener":return Bi;default:return Hi(qi)}}});return xi[Mi]=Ki,Ri.set(Mi,{name:Mi,proxy:Ki,platforms:new Set([...Object.keys($i),...Ui?[Gi]:[]])}),Ki},Fi=((mi=wi==null?void 0:wi.currentPlatform)===null||mi===void 0?void 0:mi.registerPlugin)||Di;return vi.convertFileSrc||(vi.convertFileSrc=Mi=>Mi),vi.getPlatform=Ci,vi.handleError=Pi,vi.isNativePlatform=Si,vi.isPluginAvailable=Ai,vi.pluginMethodNoop=Li,vi.registerPlugin=Fi,vi.Exception=CapacitorException,vi.DEBUG=!!vi.DEBUG,vi.isLoggingEnabled=!!vi.isLoggingEnabled,vi.platform=vi.getPlatform(),vi.isNative=vi.isNativePlatform(),vi},initCapacitorGlobal=fi=>fi.Capacitor=createCapacitor(fi),Capacitor=initCapacitorGlobal(typeof globalThis<"u"?globalThis:typeof self<"u"?self:typeof window<"u"?window:typeof global<"u"?global:{}),registerPlugin=Capacitor.registerPlugin;Capacitor.Plugins;class WebPlugin{constructor(ci){this.listeners={},this.retainedEventArguments={},this.windowListeners={},ci&&(console.warn(`Capacitor WebPlugin "${ci.name}" config object was deprecated in v3 and will be removed in v4.`),this.config=ci)}addListener(ci,hi){let _i=!1;this.listeners[ci]||(this.listeners[ci]=[],_i=!0),this.listeners[ci].push(hi);const mi=this.windowListeners[ci];mi&&!mi.registered&&this.addWindowListener(mi),_i&&this.sendRetainedArgumentsForEvent(ci);const gi=async()=>this.removeListener(ci,hi);return Promise.resolve({remove:gi})}async removeAllListeners(){this.listeners={};for(const ci in this.windowListeners)this.removeWindowListener(this.windowListeners[ci]);this.windowListeners={}}notifyListeners(ci,hi,_i){const pi=this.listeners[ci];if(!pi){if(_i){let mi=this.retainedEventArguments[ci];mi||(mi=[]),mi.push(hi),this.retainedEventArguments[ci]=mi}return}pi.forEach(mi=>mi(hi))}hasListeners(ci){return!!this.listeners[ci].length}registerWindowListener(ci,hi){this.windowListeners[hi]={registered:!1,windowEventName:ci,pluginEventName:hi,handler:_i=>{this.notifyListeners(hi,_i)}}}unimplemented(ci="not implemented"){return new Capacitor.Exception(ci,ExceptionCode.Unimplemented)}unavailable(ci="not available"){return new Capacitor.Exception(ci,ExceptionCode.Unavailable)}async removeListener(ci,hi){const _i=this.listeners[ci];if(!_i)return;const pi=_i.indexOf(hi);this.listeners[ci].splice(pi,1),this.listeners[ci].length||this.removeWindowListener(this.windowListeners[ci])}addWindowListener(ci){window.addEventListener(ci.windowEventName,ci.handler),ci.registered=!0}removeWindowListener(ci){ci&&(window.removeEventListener(ci.windowEventName,ci.handler),ci.registered=!1)}sendRetainedArgumentsForEvent(ci){const hi=this.retainedEventArguments[ci];hi&&(delete this.retainedEventArguments[ci],hi.forEach(_i=>{this.notifyListeners(ci,_i)}))}}const encode=fi=>encodeURIComponent(fi).replace(/%(2[346B]|5E|60|7C)/g,decodeURIComponent).replace(/[()]/g,escape),decode=fi=>fi.replace(/(%[\dA-F]{2})+/gi,decodeURIComponent);class CapacitorCookiesPluginWeb extends WebPlugin{async getCookies(){const ci=document.cookie,hi={};return ci.split(";").forEach(_i=>{if(_i.length<=0)return;let[pi,mi]=_i.replace(/=/,"CAP_COOKIE").split("CAP_COOKIE");pi=decode(pi).trim(),mi=decode(mi).trim(),hi[pi]=mi}),hi}async setCookie(ci){try{const hi=encode(ci.key),_i=encode(ci.value),pi=`; expires=${(ci.expires||"").replace("expires=","")}`,mi=(ci.path||"/").replace("path=",""),gi=ci.url!=null&&ci.url.length>0?`domain=${ci.url}`:"";document.cookie=`${hi}=${_i||""}${pi}; path=${mi}; ${gi};`}catch(hi){return Promise.reject(hi)}}async deleteCookie(ci){try{document.cookie=`${ci.key}=; Max-Age=0`}catch(hi){return Promise.reject(hi)}}async clearCookies(){try{const ci=document.cookie.split(";")||[];for(const hi of ci)document.cookie=hi.replace(/^ +/,"").replace(/=.*/,`=;expires=${new Date().toUTCString()};path=/`)}catch(ci){return Promise.reject(ci)}}async clearAllCookies(){try{await this.clearCookies()}catch(ci){return Promise.reject(ci)}}}registerPlugin("CapacitorCookies",{web:()=>new CapacitorCookiesPluginWeb});const readBlobAsBase64=async fi=>new Promise((ci,hi)=>{const _i=new FileReader;_i.onload=()=>{const pi=_i.result;ci(pi.indexOf(",")>=0?pi.split(",")[1]:pi)},_i.onerror=pi=>hi(pi),_i.readAsDataURL(fi)}),normalizeHttpHeaders=(fi={})=>{const ci=Object.keys(fi);return Object.keys(fi).map(pi=>pi.toLocaleLowerCase()).reduce((pi,mi,gi)=>(pi[mi]=fi[ci[gi]],pi),{})},buildUrlParams=(fi,ci=!0)=>fi?Object.entries(fi).reduce((_i,pi)=>{const[mi,gi]=pi;let vi,xi;return Array.isArray(gi)?(xi="",gi.forEach(wi=>{vi=ci?encodeURIComponent(wi):wi,xi+=`${mi}=${vi}&`}),xi.slice(0,-1)):(vi=ci?encodeURIComponent(gi):gi,xi=`${mi}=${vi}`),`${_i}&${xi}`},"").substr(1):null,buildRequestInit=(fi,ci={})=>{const hi=Object.assign({method:fi.method||"GET",headers:fi.headers},ci),pi=normalizeHttpHeaders(fi.headers)["content-type"]||"";if(typeof fi.data=="string")hi.body=fi.data;else if(pi.includes("application/x-www-form-urlencoded")){const mi=new URLSearchParams;for(const[gi,vi]of Object.entries(fi.data||{}))mi.set(gi,vi);hi.body=mi.toString()}else if(pi.includes("multipart/form-data")||fi.data instanceof FormData){const mi=new FormData;if(fi.data instanceof FormData)fi.data.forEach((vi,xi)=>{mi.append(xi,vi)});else for(const vi of Object.keys(fi.data))mi.append(vi,fi.data[vi]);hi.body=mi;const gi=new Headers(hi.headers);gi.delete("content-type"),hi.headers=gi}else(pi.includes("application/json")||typeof fi.data=="object")&&(hi.body=JSON.stringify(fi.data));return hi};class CapacitorHttpPluginWeb extends WebPlugin{async request(ci){const hi=buildRequestInit(ci,ci.webFetchExtra),_i=buildUrlParams(ci.params,ci.shouldEncodeUrlParams),pi=_i?`${ci.url}?${_i}`:ci.url,mi=await fetch(pi,hi),gi=mi.headers.get("content-type")||"";let{responseType:vi="text"}=mi.ok?ci:{};gi.includes("application/json")&&(vi="json");let xi,wi;switch(vi){case"arraybuffer":case"blob":wi=await mi.blob(),xi=await readBlobAsBase64(wi);break;case"json":xi=await mi.json();break;case"document":case"text":default:xi=await mi.text()}const yi={};return mi.headers.forEach((Ci,Ei)=>{yi[Ei]=Ci}),{data:xi,headers:yi,status:mi.status,url:mi.url}}async get(ci){return this.request(Object.assign(Object.assign({},ci),{method:"GET"}))}async post(ci){return this.request(Object.assign(Object.assign({},ci),{method:"POST"}))}async put(ci){return this.request(Object.assign(Object.assign({},ci),{method:"PUT"}))}async patch(ci){return this.request(Object.assign(Object.assign({},ci),{method:"PATCH"}))}async delete(ci){return this.request(Object.assign(Object.assign({},ci),{method:"DELETE"}))}}registerPlugin("CapacitorHttp",{web:()=>new CapacitorHttpPluginWeb});const Motion=registerPlugin("Motion",{android:()=>__vitePreload(()=>import("./web-BQL2583Z.js"),[]).then(fi=>new fi.MotionWeb),ios:()=>__vitePreload(()=>import("./web-BQL2583Z.js"),[]).then(fi=>new fi.MotionWeb),web:()=>__vitePreload(()=>import("./web-BQL2583Z.js"),[]).then(fi=>new fi.MotionWeb)});var t$1={d:(fi,ci)=>{for(var hi in ci)t$1.o(ci,hi)&&!t$1.o(fi,hi)&&Object.defineProperty(fi,hi,{enumerable:!0,get:ci[hi]})},o:(fi,ci)=>Object.prototype.hasOwnProperty.call(fi,ci)},i$1={};t$1.d(i$1,{dd:()=>ai,UZ:()=>l$1,NN:()=>ni,e1:()=>Gt,a8:()=>Rt,u6:()=>Ut,oK:()=>$t,U_:()=>Ft,sn:()=>Kt,GY:()=>ui,$t:()=>oi,RI:()=>di,_k:()=>ri,eZ:()=>r$1,pf:()=>li,N5:()=>a$1,qD:()=>n,hu:()=>o$1,Uk:()=>d$1});const s$1=(fi=>{var ci={};return t$1.d(ci,fi),ci})({Actor:()=>__webpack_exports__Actor,BoundingBox:()=>__webpack_exports__BoundingBox,Color:()=>__webpack_exports__Color,GraphicsComponent:()=>__webpack_exports__GraphicsComponent,ImageSource:()=>__webpack_exports__ImageSource,SpriteSheet:()=>__webpack_exports__SpriteSheet,TileMap:()=>__webpack_exports__TileMap,TransformComponent:()=>__webpack_exports__TransformComponent,Vector:()=>__webpack_exports__Vector,vec:()=>__webpack_exports__vec});let r$1=class{constructor(ci,hi,_i,pi){var mi,gi,vi,xi;if(this.order=pi,this.worldPos=(0,s$1.vec)(ci.ldtkLevel.worldX,ci.ldtkLevel.worldY),this.offset=(0,s$1.vec)(hi.__pxTotalOffsetX,hi.__pxTotalOffsetY),this.ldtkLayer=hi,this.tilemap=new s$1.TileMap({name:hi.__identifier,pos:this.worldPos.add(this.offset),tileWidth:hi.__gridSize,tileHeight:hi.__gridSize,rows:hi.__cHei,columns:hi.__cWid}),this.tilemap.z=pi,this.tilemap.get(s$1.GraphicsComponent).isVisible=hi.visible,hi.__tilesetDefUid){this.tileset=_i.tilesets.get(hi.__tilesetDefUid);for(let wi of hi.gridTiles){const yi=Math.floor(wi.px[0]/hi.__gridSize),Ci=Math.floor(wi.px[1]/hi.__gridSize),Ei=this.tilemap.getTile(yi,Ci);if(this.tileset){const Si=Math.floor((wi.src[0]-((mi=this.tileset.ldtkTileset.padding)!==null&&mi!==void 0?mi:0))/(this.tileset.ldtkTileset.tileGridSize+((gi=this.tileset.ldtkTileset.spacing)!==null&&gi!==void 0?gi:0))),ki=Math.floor((wi.src[1]-((vi=this.tileset.ldtkTileset.padding)!==null&&vi!==void 0?vi:0))/(this.tileset.ldtkTileset.tileGridSize+((xi=this.tileset.ldtkTileset.spacing)!==null&&xi!==void 0?xi:0))),Ai=!!(1&wi.f),Ii=!!(2&wi.f);let Ti=this.tileset.spritesheet.getSprite(Si,ki);(Ai||Ii)&&(Ti=Ti.clone(),Ti.flipHorizontal=Ai,Ti.flipVertical=Ii),Ti?Ei.addGraphic(Ti):console.error("Could not find sprite in LDtk spritesheet at",Si,ki)}}}else console.error("Could not tileset in LDtk",hi.__tilesetDefUid,hi.__tilesetRelPath)}};function a$1(fi){const ci=fi.match(/[^/\\&\?]+\.\w{2,4}(?=([\#\?&].*$|$))/gi);if(ci)return ci[0];throw new Error(`Could not locate filename from path: ${fi}`)}function n(fi,ci){for(const{path:hi,output:_i}of ci)if(typeof hi=="string"){if(fi.includes(hi))return _i}else{const pi=fi.match(hi);if(pi)return _i.replace("[match]",pi[0])}return fi}function o$1(fi,ci){if(!ci)return!1;for(const{path:hi,output:_i}of ci)if(typeof hi=="string"){if(fi.includes(hi))return!0}else if(fi.match(hi))return!0;return!1}function d$1(fi,ci,hi){if(o$1(ci,hi)&&hi)return n(ci,hi);if(ci.indexOf("/")===0)return ci;const _i=fi.split("/"),pi=ci.split("/");return _i[_i.length-1].includes(".")&&_i.pop(),_i.concat(pi).join("/")}const l$1=async(fi,ci)=>{const hi=await fetch(fi);switch(ci.toLowerCase()){case"xml":default:return await hi.text();case"json":return await hi.json()}};var u$1,c$1;(function(fi){fi.assertEqual=ci=>ci,fi.assertIs=function(ci){},fi.assertNever=function(ci){throw new Error},fi.arrayToEnum=ci=>{const hi={};for(const _i of ci)hi[_i]=_i;return hi},fi.getValidEnumValues=ci=>{const hi=fi.objectKeys(ci).filter(pi=>typeof ci[ci[pi]]!="number"),_i={};for(const pi of hi)_i[pi]=ci[pi];return fi.objectValues(_i)},fi.objectValues=ci=>fi.objectKeys(ci).map(function(hi){return ci[hi]}),fi.objectKeys=typeof Object.keys=="function"?ci=>Object.keys(ci):ci=>{const hi=[];for(const _i in ci)Object.prototype.hasOwnProperty.call(ci,_i)&&hi.push(_i);return hi},fi.find=(ci,hi)=>{for(const _i of ci)if(hi(_i))return _i},fi.isInteger=typeof Number.isInteger=="function"?ci=>Number.isInteger(ci):ci=>typeof ci=="number"&&isFinite(ci)&&Math.floor(ci)===ci,fi.joinValues=function(ci,hi=" | "){return ci.map(_i=>typeof _i=="string"?`'${_i}'`:_i).join(hi)},fi.jsonStringifyReplacer=(ci,hi)=>typeof hi=="bigint"?hi.toString():hi})(u$1||(u$1={})),function(fi){fi.mergeShapes=(ci,hi)=>({...ci,...hi})}(c$1||(c$1={}));const h$1=u$1.arrayToEnum(["string","nan","number","integer","float","boolean","date","bigint","symbol","function","undefined","null","array","object","unknown","promise","void","never","map","set"]),p$1=fi=>{switch(typeof fi){case"undefined":return h$1.undefined;case"string":return h$1.string;case"number":return isNaN(fi)?h$1.nan:h$1.number;case"boolean":return h$1.boolean;case"function":return h$1.function;case"bigint":return h$1.bigint;case"symbol":return h$1.symbol;case"object":return Array.isArray(fi)?h$1.array:fi===null?h$1.null:fi.then&&typeof fi.then=="function"&&fi.catch&&typeof fi.catch=="function"?h$1.promise:typeof Map<"u"&&fi instanceof Map?h$1.map:typeof Set<"u"&&fi instanceof Set?h$1.set:typeof Date<"u"&&fi instanceof Date?h$1.date:h$1.object;default:return h$1.unknown}},f$1=u$1.arrayToEnum(["invalid_type","invalid_literal","custom","invalid_union","invalid_union_discriminator","invalid_enum_value","unrecognized_keys","invalid_arguments","invalid_return_type","invalid_date","invalid_string","too_small","too_big","invalid_intersection_types","not_multiple_of","not_finite"]);let m$1=class _s extends Error{get errors(){return this.issues}constructor(ci){super(),this.issues=[],this.addIssue=_i=>{this.issues=[...this.issues,_i]},this.addIssues=(_i=[])=>{this.issues=[...this.issues,..._i]};const hi=new.target.prototype;Object.setPrototypeOf?Object.setPrototypeOf(this,hi):this.__proto__=hi,this.name="ZodError",this.issues=ci}format(ci){const hi=ci||function(mi){return mi.message},_i={_errors:[]},pi=mi=>{for(const gi of mi.issues)if(gi.code==="invalid_union")gi.unionErrors.map(pi);else if(gi.code==="invalid_return_type")pi(gi.returnTypeError);else if(gi.code==="invalid_arguments")pi(gi.argumentsError);else if(gi.path.length===0)_i._errors.push(hi(gi));else{let vi=_i,xi=0;for(;xi<gi.path.length;){const wi=gi.path[xi];xi===gi.path.length-1?(vi[wi]=vi[wi]||{_errors:[]},vi[wi]._errors.push(hi(gi))):vi[wi]=vi[wi]||{_errors:[]},vi=vi[wi],xi++}}};return pi(this),_i}static assert(ci){if(!(ci instanceof _s))throw new Error(`Not a ZodError: ${ci}`)}toString(){return this.message}get message(){return JSON.stringify(this.issues,u$1.jsonStringifyReplacer,2)}get isEmpty(){return this.issues.length===0}flatten(ci=hi=>hi.message){const hi={},_i=[];for(const pi of this.issues)pi.path.length>0?(hi[pi.path[0]]=hi[pi.path[0]]||[],hi[pi.path[0]].push(ci(pi))):_i.push(ci(pi));return{formErrors:_i,fieldErrors:hi}}get formErrors(){return this.flatten()}};m$1.create=fi=>new m$1(fi);const y$1=(fi,ci)=>{let hi;switch(fi.code){case f$1.invalid_type:hi=fi.received===h$1.undefined?"Required":`Expected ${fi.expected}, received ${fi.received}`;break;case f$1.invalid_literal:hi=`Invalid literal value, expected ${JSON.stringify(fi.expected,u$1.jsonStringifyReplacer)}`;break;case f$1.unrecognized_keys:hi=`Unrecognized key(s) in object: ${u$1.joinValues(fi.keys,", ")}`;break;case f$1.invalid_union:hi="Invalid input";break;case f$1.invalid_union_discriminator:hi=`Invalid discriminator value. Expected ${u$1.joinValues(fi.options)}`;break;case f$1.invalid_enum_value:hi=`Invalid enum value. Expected ${u$1.joinValues(fi.options)}, received '${fi.received}'`;break;case f$1.invalid_arguments:hi="Invalid function arguments";break;case f$1.invalid_return_type:hi="Invalid function return type";break;case f$1.invalid_date:hi="Invalid date";break;case f$1.invalid_string:typeof fi.validation=="object"?"includes"in fi.validation?(hi=`Invalid input: must include "${fi.validation.includes}"`,typeof fi.validation.position=="number"&&(hi=`${hi} at one or more positions greater than or equal to ${fi.validation.position}`)):"startsWith"in fi.validation?hi=`Invalid input: must start with "${fi.validation.startsWith}"`:"endsWith"in fi.validation?hi=`Invalid input: must end with "${fi.validation.endsWith}"`:u$1.assertNever(fi.validation):hi=fi.validation!=="regex"?`Invalid ${fi.validation}`:"Invalid";break;case f$1.too_small:hi=fi.type==="array"?`Array must contain ${fi.exact?"exactly":fi.inclusive?"at least":"more than"} ${fi.minimum} element(s)`:fi.type==="string"?`String must contain ${fi.exact?"exactly":fi.inclusive?"at least":"over"} ${fi.minimum} character(s)`:fi.type==="number"?`Number must be ${fi.exact?"exactly equal to ":fi.inclusive?"greater than or equal to ":"greater than "}${fi.minimum}`:fi.type==="date"?`Date must be ${fi.exact?"exactly equal to ":fi.inclusive?"greater than or equal to ":"greater than "}${new Date(Number(fi.minimum))}`:"Invalid input";break;case f$1.too_big:hi=fi.type==="array"?`Array must contain ${fi.exact?"exactly":fi.inclusive?"at most":"less than"} ${fi.maximum} element(s)`:fi.type==="string"?`String must contain ${fi.exact?"exactly":fi.inclusive?"at most":"under"} ${fi.maximum} character(s)`:fi.type==="number"?`Number must be ${fi.exact?"exactly":fi.inclusive?"less than or equal to":"less than"} ${fi.maximum}`:fi.type==="bigint"?`BigInt must be ${fi.exact?"exactly":fi.inclusive?"less than or equal to":"less than"} ${fi.maximum}`:fi.type==="date"?`Date must be ${fi.exact?"exactly":fi.inclusive?"smaller than or equal to":"smaller than"} ${new Date(Number(fi.maximum))}`:"Invalid input";break;case f$1.custom:hi="Invalid input";break;case f$1.invalid_intersection_types:hi="Intersection results could not be merged";break;case f$1.not_multiple_of:hi=`Number must be a multiple of ${fi.multipleOf}`;break;case f$1.not_finite:hi="Number must be finite";break;default:hi=ci.defaultError,u$1.assertNever(fi)}return{message:hi}};let g$2=y$1;function _$1(){return g$2}const v$1=fi=>{const{data:ci,path:hi,errorMaps:_i,issueData:pi}=fi,mi=[...hi,...pi.path||[]],gi={...pi,path:mi};if(pi.message!==void 0)return{...pi,path:mi,message:pi.message};let vi="";const xi=_i.filter(wi=>!!wi).slice().reverse();for(const wi of xi)vi=wi(gi,{data:ci,defaultError:vi}).message;return{...pi,path:mi,message:vi}};function b(fi,ci){const hi=_$1(),_i=v$1({issueData:ci,data:fi.data,path:fi.path,errorMaps:[fi.common.contextualErrorMap,fi.schemaErrorMap,hi,hi===y$1?void 0:y$1].filter(pi=>!!pi)});fi.common.issues.push(_i)}let k$2=class us{constructor(){this.value="valid"}dirty(){this.value==="valid"&&(this.value="dirty")}abort(){this.value!=="aborted"&&(this.value="aborted")}static mergeArray(ci,hi){const _i=[];for(const pi of hi){if(pi.status==="aborted")return x$2;pi.status==="dirty"&&ci.dirty(),_i.push(pi.value)}return{status:ci.value,value:_i}}static async mergeObjectAsync(ci,hi){const _i=[];for(const pi of hi){const mi=await pi.key,gi=await pi.value;_i.push({key:mi,value:gi})}return us.mergeObjectSync(ci,_i)}static mergeObjectSync(ci,hi){const _i={};for(const pi of hi){const{key:mi,value:gi}=pi;if(mi.status==="aborted"||gi.status==="aborted")return x$2;mi.status==="dirty"&&ci.dirty(),gi.status==="dirty"&&ci.dirty(),mi.value==="__proto__"||gi.value===void 0&&!pi.alwaysSet||(_i[mi.value]=gi.value)}return{status:ci.value,value:_i}}};const x$2=Object.freeze({status:"aborted"}),w$2=fi=>({status:"dirty",value:fi}),T$2=fi=>({status:"valid",value:fi}),Z$1=fi=>fi.status==="aborted",L$1=fi=>fi.status==="dirty",C$2=fi=>fi.status==="valid",S=fi=>typeof Promise<"u"&&fi instanceof Promise;function E$1(fi,ci,hi,_i){if(typeof ci=="function"?fi!==ci||!_i:!ci.has(fi))throw new TypeError("Cannot read private member from an object whose class did not declare it");return ci.get(fi)}function O$1(fi,ci,hi,_i,pi){if(typeof ci=="function"?fi!==ci||!pi:!ci.has(fi))throw new TypeError("Cannot write private member to an object whose class did not declare it");return ci.set(fi,hi),hi}var j$2,I$1,A$2;typeof SuppressedError=="function"&&SuppressedError,function(fi){fi.errToObj=ci=>typeof ci=="string"?{message:ci}:ci||{},fi.toString=ci=>typeof ci=="string"?ci:ci==null?void 0:ci.message}(j$2||(j$2={}));let N$1=class{constructor(ci,hi,_i,pi){this._cachedPath=[],this.parent=ci,this.data=hi,this._path=_i,this._key=pi}get path(){return this._cachedPath.length||(this._key instanceof Array?this._cachedPath.push(...this._path,...this._key):this._cachedPath.push(...this._path,this._key)),this._cachedPath}};const P$2=(fi,ci)=>{if(C$2(ci))return{success:!0,data:ci.value};if(!fi.common.issues.length)throw new Error("Validation failed but no issues detected.");return{success:!1,get error(){if(this._error)return this._error;const hi=new m$1(fi.common.issues);return this._error=hi,this._error}}};function M$1(fi){if(!fi)return{};const{errorMap:ci,invalid_type_error:hi,required_error:_i,description:pi}=fi;if(ci&&(hi||_i))throw new Error(`Can't use "invalid_type_error" or "required_error" in conjunction with custom error map.`);return ci?{errorMap:ci,description:pi}:{errorMap:(mi,gi)=>{var vi,xi;const{message:wi}=fi;return mi.code==="invalid_enum_value"?{message:wi??gi.defaultError}:gi.data===void 0?{message:(vi=wi??_i)!==null&&vi!==void 0?vi:gi.defaultError}:mi.code!=="invalid_type"?{message:gi.defaultError}:{message:(xi=wi??hi)!==null&&xi!==void 0?xi:gi.defaultError}},description:pi}}let R$1=class{get description(){return this._def.description}_getType(ci){return p$1(ci.data)}_getOrReturnCtx(ci,hi){return hi||{common:ci.parent.common,data:ci.data,parsedType:p$1(ci.data),schemaErrorMap:this._def.errorMap,path:ci.path,parent:ci.parent}}_processInputParams(ci){return{status:new k$2,ctx:{common:ci.parent.common,data:ci.data,parsedType:p$1(ci.data),schemaErrorMap:this._def.errorMap,path:ci.path,parent:ci.parent}}}_parseSync(ci){const hi=this._parse(ci);if(S(hi))throw new Error("Synchronous parse encountered promise.");return hi}_parseAsync(ci){const hi=this._parse(ci);return Promise.resolve(hi)}parse(ci,hi){const _i=this.safeParse(ci,hi);if(_i.success)return _i.data;throw _i.error}safeParse(ci,hi){var _i;const pi={common:{issues:[],async:(_i=hi==null?void 0:hi.async)!==null&&_i!==void 0&&_i,contextualErrorMap:hi==null?void 0:hi.errorMap},path:(hi==null?void 0:hi.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:ci,parsedType:p$1(ci)},mi=this._parseSync({data:ci,path:pi.path,parent:pi});return P$2(pi,mi)}"~validate"(ci){var hi,_i;const pi={common:{issues:[],async:!!this["~standard"].async},path:[],schemaErrorMap:this._def.errorMap,parent:null,data:ci,parsedType:p$1(ci)};if(!this["~standard"].async)try{const mi=this._parseSync({data:ci,path:[],parent:pi});return C$2(mi)?{value:mi.value}:{issues:pi.common.issues}}catch(mi){!((_i=(hi=mi==null?void 0:mi.message)===null||hi===void 0?void 0:hi.toLowerCase())===null||_i===void 0)&&_i.includes("encountered")&&(this["~standard"].async=!0),pi.common={issues:[],async:!0}}return this._parseAsync({data:ci,path:[],parent:pi}).then(mi=>C$2(mi)?{value:mi.value}:{issues:pi.common.issues})}async parseAsync(ci,hi){const _i=await this.safeParseAsync(ci,hi);if(_i.success)return _i.data;throw _i.error}async safeParseAsync(ci,hi){const _i={common:{issues:[],contextualErrorMap:hi==null?void 0:hi.errorMap,async:!0},path:(hi==null?void 0:hi.path)||[],schemaErrorMap:this._def.errorMap,parent:null,data:ci,parsedType:p$1(ci)},pi=this._parse({data:ci,path:_i.path,parent:_i}),mi=await(S(pi)?pi:Promise.resolve(pi));return P$2(_i,mi)}refine(ci,hi){const _i=pi=>typeof hi=="string"||hi===void 0?{message:hi}:typeof hi=="function"?hi(pi):hi;return this._refinement((pi,mi)=>{const gi=ci(pi),vi=()=>mi.addIssue({code:f$1.custom,..._i(pi)});return typeof Promise<"u"&&gi instanceof Promise?gi.then(xi=>!!xi||(vi(),!1)):!!gi||(vi(),!1)})}refinement(ci,hi){return this._refinement((_i,pi)=>!!ci(_i)||(pi.addIssue(typeof hi=="function"?hi(_i,pi):hi),!1))}_refinement(ci){return new Re({schema:this,typeName:Ye.ZodEffects,effect:{type:"refinement",refinement:ci}})}superRefine(ci){return this._refinement(ci)}constructor(ci){this.spa=this.safeParseAsync,this._def=ci,this.parse=this.parse.bind(this),this.safeParse=this.safeParse.bind(this),this.parseAsync=this.parseAsync.bind(this),this.safeParseAsync=this.safeParseAsync.bind(this),this.spa=this.spa.bind(this),this.refine=this.refine.bind(this),this.refinement=this.refinement.bind(this),this.superRefine=this.superRefine.bind(this),this.optional=this.optional.bind(this),this.nullable=this.nullable.bind(this),this.nullish=this.nullish.bind(this),this.array=this.array.bind(this),this.promise=this.promise.bind(this),this.or=this.or.bind(this),this.and=this.and.bind(this),this.transform=this.transform.bind(this),this.brand=this.brand.bind(this),this.default=this.default.bind(this),this.catch=this.catch.bind(this),this.describe=this.describe.bind(this),this.pipe=this.pipe.bind(this),this.readonly=this.readonly.bind(this),this.isNullable=this.isNullable.bind(this),this.isOptional=this.isOptional.bind(this),this["~standard"]={version:1,vendor:"zod",validate:hi=>this["~validate"](hi)}}optional(){return $e.create(this,this._def)}nullable(){return Fe.create(this,this._def)}nullish(){return this.nullable().optional()}array(){return _e.create(this)}promise(){return Me.create(this,this._def)}or(ci){return ke.create([this,ci],this._def)}and(ci){return Ze.create(this,ci,this._def)}transform(ci){return new Re({...M$1(this._def),schema:this,typeName:Ye.ZodEffects,effect:{type:"transform",transform:ci}})}default(ci){const hi=typeof ci=="function"?ci:()=>ci;return new ze({...M$1(this._def),innerType:this,defaultValue:hi,typeName:Ye.ZodDefault})}brand(){return new Ue({typeName:Ye.ZodBranded,type:this,...M$1(this._def)})}catch(ci){const hi=typeof ci=="function"?ci:()=>ci;return new De({...M$1(this._def),innerType:this,catchValue:hi,typeName:Ye.ZodCatch})}describe(ci){return new this.constructor({...this._def,description:ci})}pipe(ci){return Ge.create(this,ci)}readonly(){return We.create(this)}isOptional(){return this.safeParse(void 0).success}isNullable(){return this.safeParse(null).success}};const $$1=/^c[^\s-]{8,}$/i,F$2=/^[0-9a-z]+$/,z$2=/^[0-9A-HJKMNP-TV-Z]{26}$/i,D$2=/^[0-9a-fA-F]{8}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{4}\b-[0-9a-fA-F]{12}$/i,B$2=/^[a-z0-9_-]{21}$/i,V$1=/^[A-Za-z0-9-_]+\.[A-Za-z0-9-_]+\.[A-Za-z0-9-_]*$/,U$1=/^[-+]?P(?!$)(?:(?:[-+]?\d+Y)|(?:[-+]?\d+[.,]\d+Y$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:(?:[-+]?\d+W)|(?:[-+]?\d+[.,]\d+W$))?(?:(?:[-+]?\d+D)|(?:[-+]?\d+[.,]\d+D$))?(?:T(?=[\d+-])(?:(?:[-+]?\d+H)|(?:[-+]?\d+[.,]\d+H$))?(?:(?:[-+]?\d+M)|(?:[-+]?\d+[.,]\d+M$))?(?:[-+]?\d+(?:[.,]\d+)?S)?)??$/,G$1=/^(?!\.)(?!.*\.\.)([A-Z0-9_'+\-\.]*)[A-Z0-9_+-]@([A-Z0-9][A-Z0-9\-]*\.)+[A-Z]{2,}$/i;let W$1;const K$1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])$/,H$1=/^(?:(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\.){3}(?:25[0-5]|2[0-4][0-9]|1[0-9][0-9]|[1-9][0-9]|[0-9])\/(3[0-2]|[12]?[0-9])$/,Y$1=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))$/,X$1=/^(([0-9a-fA-F]{1,4}:){7,7}[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,7}:|([0-9a-fA-F]{1,4}:){1,6}:[0-9a-fA-F]{1,4}|([0-9a-fA-F]{1,4}:){1,5}(:[0-9a-fA-F]{1,4}){1,2}|([0-9a-fA-F]{1,4}:){1,4}(:[0-9a-fA-F]{1,4}){1,3}|([0-9a-fA-F]{1,4}:){1,3}(:[0-9a-fA-F]{1,4}){1,4}|([0-9a-fA-F]{1,4}:){1,2}(:[0-9a-fA-F]{1,4}){1,5}|[0-9a-fA-F]{1,4}:((:[0-9a-fA-F]{1,4}){1,6})|:((:[0-9a-fA-F]{1,4}){1,7}|:)|fe80:(:[0-9a-fA-F]{0,4}){0,4}%[0-9a-zA-Z]{1,}|::(ffff(:0{1,4}){0,1}:){0,1}((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])|([0-9a-fA-F]{1,4}:){1,4}:((25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9])\.){3,3}(25[0-5]|(2[0-4]|1{0,1}[0-9]){0,1}[0-9]))\/(12[0-8]|1[01][0-9]|[1-9]?[0-9])$/,q$2=/^([0-9a-zA-Z+/]{4})*(([0-9a-zA-Z+/]{2}==)|([0-9a-zA-Z+/]{3}=))?$/,J$1=/^([0-9a-zA-Z-_]{4})*(([0-9a-zA-Z-_]{2}(==)?)|([0-9a-zA-Z-_]{3}(=)?))?$/,Q$1="((\\d\\d[2468][048]|\\d\\d[13579][26]|\\d\\d0[48]|[02468][048]00|[13579][26]00)-02-29|\\d{4}-((0[13578]|1[02])-(0[1-9]|[12]\\d|3[01])|(0[469]|11)-(0[1-9]|[12]\\d|30)|(02)-(0[1-9]|1\\d|2[0-8])))",ee=new RegExp(`^${Q$1}$`);function te(fi){let ci="([01]\\d|2[0-3]):[0-5]\\d:[0-5]\\d";return fi.precision?ci=`${ci}\\.\\d{${fi.precision}}`:fi.precision==null&&(ci=`${ci}(\\.\\d+)?`),ci}function ie(fi){let ci=`${Q$1}T${te(fi)}`;const hi=[];return hi.push(fi.local?"Z?":"Z"),fi.offset&&hi.push("([+-]\\d{2}:?\\d{2})"),ci=`${ci}(${hi.join("|")})`,new RegExp(`^${ci}$`)}function se(fi,ci){if(!V$1.test(fi))return!1;try{const[hi]=fi.split("."),_i=hi.replace(/-/g,"+").replace(/_/g,"/").padEnd(hi.length+(4-hi.length%4)%4,"="),pi=JSON.parse(atob(_i));return typeof pi=="object"&&pi!==null&&!(!pi.typ||!pi.alg)&&(!ci||pi.alg===ci)}catch{return!1}}function re(fi,ci){return!(ci!=="v4"&&ci||!H$1.test(fi))||!(ci!=="v6"&&ci||!X$1.test(fi))}class ae extends R$1{_parse(ci){if(this._def.coerce&&(ci.data=String(ci.data)),this._getType(ci)!==h$1.string){const gi=this._getOrReturnCtx(ci);return b(gi,{code:f$1.invalid_type,expected:h$1.string,received:gi.parsedType}),x$2}const hi=new k$2;let _i;for(const gi of this._def.checks)if(gi.kind==="min")ci.data.length<gi.value&&(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.too_small,minimum:gi.value,type:"string",inclusive:!0,exact:!1,message:gi.message}),hi.dirty());else if(gi.kind==="max")ci.data.length>gi.value&&(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.too_big,maximum:gi.value,type:"string",inclusive:!0,exact:!1,message:gi.message}),hi.dirty());else if(gi.kind==="length"){const vi=ci.data.length>gi.value,xi=ci.data.length<gi.value;(vi||xi)&&(_i=this._getOrReturnCtx(ci,_i),vi?b(_i,{code:f$1.too_big,maximum:gi.value,type:"string",inclusive:!0,exact:!0,message:gi.message}):xi&&b(_i,{code:f$1.too_small,minimum:gi.value,type:"string",inclusive:!0,exact:!0,message:gi.message}),hi.dirty())}else if(gi.kind==="email")G$1.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"email",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="emoji")W$1||(W$1=new RegExp("^(\\p{Extended_Pictographic}|\\p{Emoji_Component})+$","u")),W$1.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"emoji",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="uuid")D$2.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"uuid",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="nanoid")B$2.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"nanoid",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="cuid")$$1.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"cuid",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="cuid2")F$2.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"cuid2",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="ulid")z$2.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"ulid",code:f$1.invalid_string,message:gi.message}),hi.dirty());else if(gi.kind==="url")try{new URL(ci.data)}catch{_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"url",code:f$1.invalid_string,message:gi.message}),hi.dirty()}else gi.kind==="regex"?(gi.regex.lastIndex=0,gi.regex.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"regex",code:f$1.invalid_string,message:gi.message}),hi.dirty())):gi.kind==="trim"?ci.data=ci.data.trim():gi.kind==="includes"?ci.data.includes(gi.value,gi.position)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.invalid_string,validation:{includes:gi.value,position:gi.position},message:gi.message}),hi.dirty()):gi.kind==="toLowerCase"?ci.data=ci.data.toLowerCase():gi.kind==="toUpperCase"?ci.data=ci.data.toUpperCase():gi.kind==="startsWith"?ci.data.startsWith(gi.value)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.invalid_string,validation:{startsWith:gi.value},message:gi.message}),hi.dirty()):gi.kind==="endsWith"?ci.data.endsWith(gi.value)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.invalid_string,validation:{endsWith:gi.value},message:gi.message}),hi.dirty()):gi.kind==="datetime"?ie(gi).test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.invalid_string,validation:"datetime",message:gi.message}),hi.dirty()):gi.kind==="date"?ee.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.invalid_string,validation:"date",message:gi.message}),hi.dirty()):gi.kind==="time"?new RegExp(`^${te(gi)}$`).test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.invalid_string,validation:"time",message:gi.message}),hi.dirty()):gi.kind==="duration"?U$1.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"duration",code:f$1.invalid_string,message:gi.message}),hi.dirty()):gi.kind==="ip"?(pi=ci.data,((mi=gi.version)!=="v4"&&mi||!K$1.test(pi))&&(mi!=="v6"&&mi||!Y$1.test(pi))&&(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"ip",code:f$1.invalid_string,message:gi.message}),hi.dirty())):gi.kind==="jwt"?se(ci.data,gi.alg)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"jwt",code:f$1.invalid_string,message:gi.message}),hi.dirty()):gi.kind==="cidr"?re(ci.data,gi.version)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"cidr",code:f$1.invalid_string,message:gi.message}),hi.dirty()):gi.kind==="base64"?q$2.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"base64",code:f$1.invalid_string,message:gi.message}),hi.dirty()):gi.kind==="base64url"?J$1.test(ci.data)||(_i=this._getOrReturnCtx(ci,_i),b(_i,{validation:"base64url",code:f$1.invalid_string,message:gi.message}),hi.dirty()):u$1.assertNever(gi);var pi,mi;return{status:hi.value,value:ci.data}}_regex(ci,hi,_i){return this.refinement(pi=>ci.test(pi),{validation:hi,code:f$1.invalid_string,...j$2.errToObj(_i)})}_addCheck(ci){return new ae({...this._def,checks:[...this._def.checks,ci]})}email(ci){return this._addCheck({kind:"email",...j$2.errToObj(ci)})}url(ci){return this._addCheck({kind:"url",...j$2.errToObj(ci)})}emoji(ci){return this._addCheck({kind:"emoji",...j$2.errToObj(ci)})}uuid(ci){return this._addCheck({kind:"uuid",...j$2.errToObj(ci)})}nanoid(ci){return this._addCheck({kind:"nanoid",...j$2.errToObj(ci)})}cuid(ci){return this._addCheck({kind:"cuid",...j$2.errToObj(ci)})}cuid2(ci){return this._addCheck({kind:"cuid2",...j$2.errToObj(ci)})}ulid(ci){return this._addCheck({kind:"ulid",...j$2.errToObj(ci)})}base64(ci){return this._addCheck({kind:"base64",...j$2.errToObj(ci)})}base64url(ci){return this._addCheck({kind:"base64url",...j$2.errToObj(ci)})}jwt(ci){return this._addCheck({kind:"jwt",...j$2.errToObj(ci)})}ip(ci){return this._addCheck({kind:"ip",...j$2.errToObj(ci)})}cidr(ci){return this._addCheck({kind:"cidr",...j$2.errToObj(ci)})}datetime(ci){var hi,_i;return typeof ci=="string"?this._addCheck({kind:"datetime",precision:null,offset:!1,local:!1,message:ci}):this._addCheck({kind:"datetime",precision:(ci==null?void 0:ci.precision)===void 0?null:ci==null?void 0:ci.precision,offset:(hi=ci==null?void 0:ci.offset)!==null&&hi!==void 0&&hi,local:(_i=ci==null?void 0:ci.local)!==null&&_i!==void 0&&_i,...j$2.errToObj(ci==null?void 0:ci.message)})}date(ci){return this._addCheck({kind:"date",message:ci})}time(ci){return typeof ci=="string"?this._addCheck({kind:"time",precision:null,message:ci}):this._addCheck({kind:"time",precision:(ci==null?void 0:ci.precision)===void 0?null:ci==null?void 0:ci.precision,...j$2.errToObj(ci==null?void 0:ci.message)})}duration(ci){return this._addCheck({kind:"duration",...j$2.errToObj(ci)})}regex(ci,hi){return this._addCheck({kind:"regex",regex:ci,...j$2.errToObj(hi)})}includes(ci,hi){return this._addCheck({kind:"includes",value:ci,position:hi==null?void 0:hi.position,...j$2.errToObj(hi==null?void 0:hi.message)})}startsWith(ci,hi){return this._addCheck({kind:"startsWith",value:ci,...j$2.errToObj(hi)})}endsWith(ci,hi){return this._addCheck({kind:"endsWith",value:ci,...j$2.errToObj(hi)})}min(ci,hi){return this._addCheck({kind:"min",value:ci,...j$2.errToObj(hi)})}max(ci,hi){return this._addCheck({kind:"max",value:ci,...j$2.errToObj(hi)})}length(ci,hi){return this._addCheck({kind:"length",value:ci,...j$2.errToObj(hi)})}nonempty(ci){return this.min(1,j$2.errToObj(ci))}trim(){return new ae({...this._def,checks:[...this._def.checks,{kind:"trim"}]})}toLowerCase(){return new ae({...this._def,checks:[...this._def.checks,{kind:"toLowerCase"}]})}toUpperCase(){return new ae({...this._def,checks:[...this._def.checks,{kind:"toUpperCase"}]})}get isDatetime(){return!!this._def.checks.find(ci=>ci.kind==="datetime")}get isDate(){return!!this._def.checks.find(ci=>ci.kind==="date")}get isTime(){return!!this._def.checks.find(ci=>ci.kind==="time")}get isDuration(){return!!this._def.checks.find(ci=>ci.kind==="duration")}get isEmail(){return!!this._def.checks.find(ci=>ci.kind==="email")}get isURL(){return!!this._def.checks.find(ci=>ci.kind==="url")}get isEmoji(){return!!this._def.checks.find(ci=>ci.kind==="emoji")}get isUUID(){return!!this._def.checks.find(ci=>ci.kind==="uuid")}get isNANOID(){return!!this._def.checks.find(ci=>ci.kind==="nanoid")}get isCUID(){return!!this._def.checks.find(ci=>ci.kind==="cuid")}get isCUID2(){return!!this._def.checks.find(ci=>ci.kind==="cuid2")}get isULID(){return!!this._def.checks.find(ci=>ci.kind==="ulid")}get isIP(){return!!this._def.checks.find(ci=>ci.kind==="ip")}get isCIDR(){return!!this._def.checks.find(ci=>ci.kind==="cidr")}get isBase64(){return!!this._def.checks.find(ci=>ci.kind==="base64")}get isBase64url(){return!!this._def.checks.find(ci=>ci.kind==="base64url")}get minLength(){let ci=null;for(const hi of this._def.checks)hi.kind==="min"&&(ci===null||hi.value>ci)&&(ci=hi.value);return ci}get maxLength(){let ci=null;for(const hi of this._def.checks)hi.kind==="max"&&(ci===null||hi.value<ci)&&(ci=hi.value);return ci}}function ne(fi,ci){const hi=(fi.toString().split(".")[1]||"").length,_i=(ci.toString().split(".")[1]||"").length,pi=hi>_i?hi:_i;return parseInt(fi.toFixed(pi).replace(".",""))%parseInt(ci.toFixed(pi).replace(".",""))/Math.pow(10,pi)}ae.create=fi=>{var ci;return new ae({checks:[],typeName:Ye.ZodString,coerce:(ci=fi==null?void 0:fi.coerce)!==null&&ci!==void 0&&ci,...M$1(fi)})};class oe extends R$1{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte,this.step=this.multipleOf}_parse(ci){if(this._def.coerce&&(ci.data=Number(ci.data)),this._getType(ci)!==h$1.number){const pi=this._getOrReturnCtx(ci);return b(pi,{code:f$1.invalid_type,expected:h$1.number,received:pi.parsedType}),x$2}let hi;const _i=new k$2;for(const pi of this._def.checks)pi.kind==="int"?u$1.isInteger(ci.data)||(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.invalid_type,expected:"integer",received:"float",message:pi.message}),_i.dirty()):pi.kind==="min"?(pi.inclusive?ci.data<pi.value:ci.data<=pi.value)&&(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.too_small,minimum:pi.value,type:"number",inclusive:pi.inclusive,exact:!1,message:pi.message}),_i.dirty()):pi.kind==="max"?(pi.inclusive?ci.data>pi.value:ci.data>=pi.value)&&(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.too_big,maximum:pi.value,type:"number",inclusive:pi.inclusive,exact:!1,message:pi.message}),_i.dirty()):pi.kind==="multipleOf"?ne(ci.data,pi.value)!==0&&(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.not_multiple_of,multipleOf:pi.value,message:pi.message}),_i.dirty()):pi.kind==="finite"?Number.isFinite(ci.data)||(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.not_finite,message:pi.message}),_i.dirty()):u$1.assertNever(pi);return{status:_i.value,value:ci.data}}gte(ci,hi){return this.setLimit("min",ci,!0,j$2.toString(hi))}gt(ci,hi){return this.setLimit("min",ci,!1,j$2.toString(hi))}lte(ci,hi){return this.setLimit("max",ci,!0,j$2.toString(hi))}lt(ci,hi){return this.setLimit("max",ci,!1,j$2.toString(hi))}setLimit(ci,hi,_i,pi){return new oe({...this._def,checks:[...this._def.checks,{kind:ci,value:hi,inclusive:_i,message:j$2.toString(pi)}]})}_addCheck(ci){return new oe({...this._def,checks:[...this._def.checks,ci]})}int(ci){return this._addCheck({kind:"int",message:j$2.toString(ci)})}positive(ci){return this._addCheck({kind:"min",value:0,inclusive:!1,message:j$2.toString(ci)})}negative(ci){return this._addCheck({kind:"max",value:0,inclusive:!1,message:j$2.toString(ci)})}nonpositive(ci){return this._addCheck({kind:"max",value:0,inclusive:!0,message:j$2.toString(ci)})}nonnegative(ci){return this._addCheck({kind:"min",value:0,inclusive:!0,message:j$2.toString(ci)})}multipleOf(ci,hi){return this._addCheck({kind:"multipleOf",value:ci,message:j$2.toString(hi)})}finite(ci){return this._addCheck({kind:"finite",message:j$2.toString(ci)})}safe(ci){return this._addCheck({kind:"min",inclusive:!0,value:Number.MIN_SAFE_INTEGER,message:j$2.toString(ci)})._addCheck({kind:"max",inclusive:!0,value:Number.MAX_SAFE_INTEGER,message:j$2.toString(ci)})}get minValue(){let ci=null;for(const hi of this._def.checks)hi.kind==="min"&&(ci===null||hi.value>ci)&&(ci=hi.value);return ci}get maxValue(){let ci=null;for(const hi of this._def.checks)hi.kind==="max"&&(ci===null||hi.value<ci)&&(ci=hi.value);return ci}get isInt(){return!!this._def.checks.find(ci=>ci.kind==="int"||ci.kind==="multipleOf"&&u$1.isInteger(ci.value))}get isFinite(){let ci=null,hi=null;for(const _i of this._def.checks){if(_i.kind==="finite"||_i.kind==="int"||_i.kind==="multipleOf")return!0;_i.kind==="min"?(hi===null||_i.value>hi)&&(hi=_i.value):_i.kind==="max"&&(ci===null||_i.value<ci)&&(ci=_i.value)}return Number.isFinite(hi)&&Number.isFinite(ci)}}oe.create=fi=>new oe({checks:[],typeName:Ye.ZodNumber,coerce:(fi==null?void 0:fi.coerce)||!1,...M$1(fi)});class de extends R$1{constructor(){super(...arguments),this.min=this.gte,this.max=this.lte}_parse(ci){if(this._def.coerce)try{ci.data=BigInt(ci.data)}catch{return this._getInvalidInput(ci)}if(this._getType(ci)!==h$1.bigint)return this._getInvalidInput(ci);let hi;const _i=new k$2;for(const pi of this._def.checks)pi.kind==="min"?(pi.inclusive?ci.data<pi.value:ci.data<=pi.value)&&(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.too_small,type:"bigint",minimum:pi.value,inclusive:pi.inclusive,message:pi.message}),_i.dirty()):pi.kind==="max"?(pi.inclusive?ci.data>pi.value:ci.data>=pi.value)&&(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.too_big,type:"bigint",maximum:pi.value,inclusive:pi.inclusive,message:pi.message}),_i.dirty()):pi.kind==="multipleOf"?ci.data%pi.value!==BigInt(0)&&(hi=this._getOrReturnCtx(ci,hi),b(hi,{code:f$1.not_multiple_of,multipleOf:pi.value,message:pi.message}),_i.dirty()):u$1.assertNever(pi);return{status:_i.value,value:ci.data}}_getInvalidInput(ci){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.bigint,received:hi.parsedType}),x$2}gte(ci,hi){return this.setLimit("min",ci,!0,j$2.toString(hi))}gt(ci,hi){return this.setLimit("min",ci,!1,j$2.toString(hi))}lte(ci,hi){return this.setLimit("max",ci,!0,j$2.toString(hi))}lt(ci,hi){return this.setLimit("max",ci,!1,j$2.toString(hi))}setLimit(ci,hi,_i,pi){return new de({...this._def,checks:[...this._def.checks,{kind:ci,value:hi,inclusive:_i,message:j$2.toString(pi)}]})}_addCheck(ci){return new de({...this._def,checks:[...this._def.checks,ci]})}positive(ci){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!1,message:j$2.toString(ci)})}negative(ci){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!1,message:j$2.toString(ci)})}nonpositive(ci){return this._addCheck({kind:"max",value:BigInt(0),inclusive:!0,message:j$2.toString(ci)})}nonnegative(ci){return this._addCheck({kind:"min",value:BigInt(0),inclusive:!0,message:j$2.toString(ci)})}multipleOf(ci,hi){return this._addCheck({kind:"multipleOf",value:ci,message:j$2.toString(hi)})}get minValue(){let ci=null;for(const hi of this._def.checks)hi.kind==="min"&&(ci===null||hi.value>ci)&&(ci=hi.value);return ci}get maxValue(){let ci=null;for(const hi of this._def.checks)hi.kind==="max"&&(ci===null||hi.value<ci)&&(ci=hi.value);return ci}}de.create=fi=>{var ci;return new de({checks:[],typeName:Ye.ZodBigInt,coerce:(ci=fi==null?void 0:fi.coerce)!==null&&ci!==void 0&&ci,...M$1(fi)})};class le extends R$1{_parse(ci){if(this._def.coerce&&(ci.data=!!ci.data),this._getType(ci)!==h$1.boolean){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.boolean,received:hi.parsedType}),x$2}return T$2(ci.data)}}le.create=fi=>new le({typeName:Ye.ZodBoolean,coerce:(fi==null?void 0:fi.coerce)||!1,...M$1(fi)});class ue extends R$1{_parse(ci){if(this._def.coerce&&(ci.data=new Date(ci.data)),this._getType(ci)!==h$1.date){const pi=this._getOrReturnCtx(ci);return b(pi,{code:f$1.invalid_type,expected:h$1.date,received:pi.parsedType}),x$2}if(isNaN(ci.data.getTime()))return b(this._getOrReturnCtx(ci),{code:f$1.invalid_date}),x$2;const hi=new k$2;let _i;for(const pi of this._def.checks)pi.kind==="min"?ci.data.getTime()<pi.value&&(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.too_small,message:pi.message,inclusive:!0,exact:!1,minimum:pi.value,type:"date"}),hi.dirty()):pi.kind==="max"?ci.data.getTime()>pi.value&&(_i=this._getOrReturnCtx(ci,_i),b(_i,{code:f$1.too_big,message:pi.message,inclusive:!0,exact:!1,maximum:pi.value,type:"date"}),hi.dirty()):u$1.assertNever(pi);return{status:hi.value,value:new Date(ci.data.getTime())}}_addCheck(ci){return new ue({...this._def,checks:[...this._def.checks,ci]})}min(ci,hi){return this._addCheck({kind:"min",value:ci.getTime(),message:j$2.toString(hi)})}max(ci,hi){return this._addCheck({kind:"max",value:ci.getTime(),message:j$2.toString(hi)})}get minDate(){let ci=null;for(const hi of this._def.checks)hi.kind==="min"&&(ci===null||hi.value>ci)&&(ci=hi.value);return ci!=null?new Date(ci):null}get maxDate(){let ci=null;for(const hi of this._def.checks)hi.kind==="max"&&(ci===null||hi.value<ci)&&(ci=hi.value);return ci!=null?new Date(ci):null}}ue.create=fi=>new ue({checks:[],coerce:(fi==null?void 0:fi.coerce)||!1,typeName:Ye.ZodDate,...M$1(fi)});class ce extends R$1{_parse(ci){if(this._getType(ci)!==h$1.symbol){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.symbol,received:hi.parsedType}),x$2}return T$2(ci.data)}}ce.create=fi=>new ce({typeName:Ye.ZodSymbol,...M$1(fi)});class he extends R$1{_parse(ci){if(this._getType(ci)!==h$1.undefined){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.undefined,received:hi.parsedType}),x$2}return T$2(ci.data)}}he.create=fi=>new he({typeName:Ye.ZodUndefined,...M$1(fi)});class pe extends R$1{_parse(ci){if(this._getType(ci)!==h$1.null){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.null,received:hi.parsedType}),x$2}return T$2(ci.data)}}pe.create=fi=>new pe({typeName:Ye.ZodNull,...M$1(fi)});class fe extends R$1{constructor(){super(...arguments),this._any=!0}_parse(ci){return T$2(ci.data)}}fe.create=fi=>new fe({typeName:Ye.ZodAny,...M$1(fi)});class me extends R$1{constructor(){super(...arguments),this._unknown=!0}_parse(ci){return T$2(ci.data)}}me.create=fi=>new me({typeName:Ye.ZodUnknown,...M$1(fi)});class ye extends R$1{_parse(ci){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.never,received:hi.parsedType}),x$2}}ye.create=fi=>new ye({typeName:Ye.ZodNever,...M$1(fi)});class ge extends R$1{_parse(ci){if(this._getType(ci)!==h$1.undefined){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.void,received:hi.parsedType}),x$2}return T$2(ci.data)}}ge.create=fi=>new ge({typeName:Ye.ZodVoid,...M$1(fi)});class _e extends R$1{_parse(ci){const{ctx:hi,status:_i}=this._processInputParams(ci),pi=this._def;if(hi.parsedType!==h$1.array)return b(hi,{code:f$1.invalid_type,expected:h$1.array,received:hi.parsedType}),x$2;if(pi.exactLength!==null){const gi=hi.data.length>pi.exactLength.value,vi=hi.data.length<pi.exactLength.value;(gi||vi)&&(b(hi,{code:gi?f$1.too_big:f$1.too_small,minimum:vi?pi.exactLength.value:void 0,maximum:gi?pi.exactLength.value:void 0,type:"array",inclusive:!0,exact:!0,message:pi.exactLength.message}),_i.dirty())}if(pi.minLength!==null&&hi.data.length<pi.minLength.value&&(b(hi,{code:f$1.too_small,minimum:pi.minLength.value,type:"array",inclusive:!0,exact:!1,message:pi.minLength.message}),_i.dirty()),pi.maxLength!==null&&hi.data.length>pi.maxLength.value&&(b(hi,{code:f$1.too_big,maximum:pi.maxLength.value,type:"array",inclusive:!0,exact:!1,message:pi.maxLength.message}),_i.dirty()),hi.common.async)return Promise.all([...hi.data].map((gi,vi)=>pi.type._parseAsync(new N$1(hi,gi,hi.path,vi)))).then(gi=>k$2.mergeArray(_i,gi));const mi=[...hi.data].map((gi,vi)=>pi.type._parseSync(new N$1(hi,gi,hi.path,vi)));return k$2.mergeArray(_i,mi)}get element(){return this._def.type}min(ci,hi){return new _e({...this._def,minLength:{value:ci,message:j$2.toString(hi)}})}max(ci,hi){return new _e({...this._def,maxLength:{value:ci,message:j$2.toString(hi)}})}length(ci,hi){return new _e({...this._def,exactLength:{value:ci,message:j$2.toString(hi)}})}nonempty(ci){return this.min(1,ci)}}function ve(fi){if(fi instanceof be){const ci={};for(const hi in fi.shape){const _i=fi.shape[hi];ci[hi]=$e.create(ve(_i))}return new be({...fi._def,shape:()=>ci})}return fi instanceof _e?new _e({...fi._def,type:ve(fi.element)}):fi instanceof $e?$e.create(ve(fi.unwrap())):fi instanceof Fe?Fe.create(ve(fi.unwrap())):fi instanceof Le?Le.create(fi.items.map(ci=>ve(ci))):fi}_e.create=(fi,ci)=>new _e({type:fi,minLength:null,maxLength:null,exactLength:null,typeName:Ye.ZodArray,...M$1(ci)});class be extends R$1{constructor(){super(...arguments),this._cached=null,this.nonstrict=this.passthrough,this.augment=this.extend}_getCached(){if(this._cached!==null)return this._cached;const ci=this._def.shape(),hi=u$1.objectKeys(ci);return this._cached={shape:ci,keys:hi}}_parse(ci){if(this._getType(ci)!==h$1.object){const xi=this._getOrReturnCtx(ci);return b(xi,{code:f$1.invalid_type,expected:h$1.object,received:xi.parsedType}),x$2}const{status:hi,ctx:_i}=this._processInputParams(ci),{shape:pi,keys:mi}=this._getCached(),gi=[];if(!(this._def.catchall instanceof ye&&this._def.unknownKeys==="strip"))for(const xi in _i.data)mi.includes(xi)||gi.push(xi);const vi=[];for(const xi of mi){const wi=pi[xi],yi=_i.data[xi];vi.push({key:{status:"valid",value:xi},value:wi._parse(new N$1(_i,yi,_i.path,xi)),alwaysSet:xi in _i.data})}if(this._def.catchall instanceof ye){const xi=this._def.unknownKeys;if(xi==="passthrough")for(const wi of gi)vi.push({key:{status:"valid",value:wi},value:{status:"valid",value:_i.data[wi]}});else if(xi==="strict")gi.length>0&&(b(_i,{code:f$1.unrecognized_keys,keys:gi}),hi.dirty());else if(xi!=="strip")throw new Error("Internal ZodObject error: invalid unknownKeys value.")}else{const xi=this._def.catchall;for(const wi of gi){const yi=_i.data[wi];vi.push({key:{status:"valid",value:wi},value:xi._parse(new N$1(_i,yi,_i.path,wi)),alwaysSet:wi in _i.data})}}return _i.common.async?Promise.resolve().then(async()=>{const xi=[];for(const wi of vi){const yi=await wi.key,Ci=await wi.value;xi.push({key:yi,value:Ci,alwaysSet:wi.alwaysSet})}return xi}).then(xi=>k$2.mergeObjectSync(hi,xi)):k$2.mergeObjectSync(hi,vi)}get shape(){return this._def.shape()}strict(ci){return j$2.errToObj,new be({...this._def,unknownKeys:"strict",...ci!==void 0?{errorMap:(hi,_i)=>{var pi,mi,gi,vi;const xi=(gi=(mi=(pi=this._def).errorMap)===null||mi===void 0?void 0:mi.call(pi,hi,_i).message)!==null&&gi!==void 0?gi:_i.defaultError;return hi.code==="unrecognized_keys"?{message:(vi=j$2.errToObj(ci).message)!==null&&vi!==void 0?vi:xi}:{message:xi}}}:{}})}strip(){return new be({...this._def,unknownKeys:"strip"})}passthrough(){return new be({...this._def,unknownKeys:"passthrough"})}extend(ci){return new be({...this._def,shape:()=>({...this._def.shape(),...ci})})}merge(ci){return new be({unknownKeys:ci._def.unknownKeys,catchall:ci._def.catchall,shape:()=>({...this._def.shape(),...ci._def.shape()}),typeName:Ye.ZodObject})}setKey(ci,hi){return this.augment({[ci]:hi})}catchall(ci){return new be({...this._def,catchall:ci})}pick(ci){const hi={};return u$1.objectKeys(ci).forEach(_i=>{ci[_i]&&this.shape[_i]&&(hi[_i]=this.shape[_i])}),new be({...this._def,shape:()=>hi})}omit(ci){const hi={};return u$1.objectKeys(this.shape).forEach(_i=>{ci[_i]||(hi[_i]=this.shape[_i])}),new be({...this._def,shape:()=>hi})}deepPartial(){return ve(this)}partial(ci){const hi={};return u$1.objectKeys(this.shape).forEach(_i=>{const pi=this.shape[_i];ci&&!ci[_i]?hi[_i]=pi:hi[_i]=pi.optional()}),new be({...this._def,shape:()=>hi})}required(ci){const hi={};return u$1.objectKeys(this.shape).forEach(_i=>{if(ci&&!ci[_i])hi[_i]=this.shape[_i];else{let pi=this.shape[_i];for(;pi instanceof $e;)pi=pi._def.innerType;hi[_i]=pi}}),new be({...this._def,shape:()=>hi})}keyof(){return Ae(u$1.objectKeys(this.shape))}}be.create=(fi,ci)=>new be({shape:()=>fi,unknownKeys:"strip",catchall:ye.create(),typeName:Ye.ZodObject,...M$1(ci)}),be.strictCreate=(fi,ci)=>new be({shape:()=>fi,unknownKeys:"strict",catchall:ye.create(),typeName:Ye.ZodObject,...M$1(ci)}),be.lazycreate=(fi,ci)=>new be({shape:fi,unknownKeys:"strip",catchall:ye.create(),typeName:Ye.ZodObject,...M$1(ci)});class ke extends R$1{_parse(ci){const{ctx:hi}=this._processInputParams(ci),_i=this._def.options;if(hi.common.async)return Promise.all(_i.map(async pi=>{const mi={...hi,common:{...hi.common,issues:[]},parent:null};return{result:await pi._parseAsync({data:hi.data,path:hi.path,parent:mi}),ctx:mi}})).then(function(pi){for(const gi of pi)if(gi.result.status==="valid")return gi.result;for(const gi of pi)if(gi.result.status==="dirty")return hi.common.issues.push(...gi.ctx.common.issues),gi.result;const mi=pi.map(gi=>new m$1(gi.ctx.common.issues));return b(hi,{code:f$1.invalid_union,unionErrors:mi}),x$2});{let pi;const mi=[];for(const vi of _i){const xi={...hi,common:{...hi.common,issues:[]},parent:null},wi=vi._parseSync({data:hi.data,path:hi.path,parent:xi});if(wi.status==="valid")return wi;wi.status!=="dirty"||pi||(pi={result:wi,ctx:xi}),xi.common.issues.length&&mi.push(xi.common.issues)}if(pi)return hi.common.issues.push(...pi.ctx.common.issues),pi.result;const gi=mi.map(vi=>new m$1(vi));return b(hi,{code:f$1.invalid_union,unionErrors:gi}),x$2}}get options(){return this._def.options}}ke.create=(fi,ci)=>new ke({options:fi,typeName:Ye.ZodUnion,...M$1(ci)});const xe=fi=>fi instanceof je?xe(fi.schema):fi instanceof Re?xe(fi.innerType()):fi instanceof Ie?[fi.value]:fi instanceof Ne?fi.options:fi instanceof Pe?u$1.objectValues(fi.enum):fi instanceof ze?xe(fi._def.innerType):fi instanceof he?[void 0]:fi instanceof pe?[null]:fi instanceof $e?[void 0,...xe(fi.unwrap())]:fi instanceof Fe?[null,...xe(fi.unwrap())]:fi instanceof Ue||fi instanceof We?xe(fi.unwrap()):fi instanceof De?xe(fi._def.innerType):[];class we extends R$1{_parse(ci){const{ctx:hi}=this._processInputParams(ci);if(hi.parsedType!==h$1.object)return b(hi,{code:f$1.invalid_type,expected:h$1.object,received:hi.parsedType}),x$2;const _i=this.discriminator,pi=hi.data[_i],mi=this.optionsMap.get(pi);return mi?hi.common.async?mi._parseAsync({data:hi.data,path:hi.path,parent:hi}):mi._parseSync({data:hi.data,path:hi.path,parent:hi}):(b(hi,{code:f$1.invalid_union_discriminator,options:Array.from(this.optionsMap.keys()),path:[_i]}),x$2)}get discriminator(){return this._def.discriminator}get options(){return this._def.options}get optionsMap(){return this._def.optionsMap}static create(ci,hi,_i){const pi=new Map;for(const mi of hi){const gi=xe(mi.shape[ci]);if(!gi.length)throw new Error(`A discriminator value for key \`${ci}\` could not be extracted from all schema options`);for(const vi of gi){if(pi.has(vi))throw new Error(`Discriminator property ${String(ci)} has duplicate value ${String(vi)}`);pi.set(vi,mi)}}return new we({typeName:Ye.ZodDiscriminatedUnion,discriminator:ci,options:hi,optionsMap:pi,...M$1(_i)})}}function Te(fi,ci){const hi=p$1(fi),_i=p$1(ci);if(fi===ci)return{valid:!0,data:fi};if(hi===h$1.object&&_i===h$1.object){const pi=u$1.objectKeys(ci),mi=u$1.objectKeys(fi).filter(vi=>pi.indexOf(vi)!==-1),gi={...fi,...ci};for(const vi of mi){const xi=Te(fi[vi],ci[vi]);if(!xi.valid)return{valid:!1};gi[vi]=xi.data}return{valid:!0,data:gi}}if(hi===h$1.array&&_i===h$1.array){if(fi.length!==ci.length)return{valid:!1};const pi=[];for(let mi=0;mi<fi.length;mi++){const gi=Te(fi[mi],ci[mi]);if(!gi.valid)return{valid:!1};pi.push(gi.data)}return{valid:!0,data:pi}}return hi===h$1.date&&_i===h$1.date&&+fi==+ci?{valid:!0,data:fi}:{valid:!1}}class Ze extends R$1{_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci),pi=(mi,gi)=>{if(Z$1(mi)||Z$1(gi))return x$2;const vi=Te(mi.value,gi.value);return vi.valid?((L$1(mi)||L$1(gi))&&hi.dirty(),{status:hi.value,value:vi.data}):(b(_i,{code:f$1.invalid_intersection_types}),x$2)};return _i.common.async?Promise.all([this._def.left._parseAsync({data:_i.data,path:_i.path,parent:_i}),this._def.right._parseAsync({data:_i.data,path:_i.path,parent:_i})]).then(([mi,gi])=>pi(mi,gi)):pi(this._def.left._parseSync({data:_i.data,path:_i.path,parent:_i}),this._def.right._parseSync({data:_i.data,path:_i.path,parent:_i}))}}Ze.create=(fi,ci,hi)=>new Ze({left:fi,right:ci,typeName:Ye.ZodIntersection,...M$1(hi)});class Le extends R$1{_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci);if(_i.parsedType!==h$1.array)return b(_i,{code:f$1.invalid_type,expected:h$1.array,received:_i.parsedType}),x$2;if(_i.data.length<this._def.items.length)return b(_i,{code:f$1.too_small,minimum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),x$2;!this._def.rest&&_i.data.length>this._def.items.length&&(b(_i,{code:f$1.too_big,maximum:this._def.items.length,inclusive:!0,exact:!1,type:"array"}),hi.dirty());const pi=[..._i.data].map((mi,gi)=>{const vi=this._def.items[gi]||this._def.rest;return vi?vi._parse(new N$1(_i,mi,_i.path,gi)):null}).filter(mi=>!!mi);return _i.common.async?Promise.all(pi).then(mi=>k$2.mergeArray(hi,mi)):k$2.mergeArray(hi,pi)}get items(){return this._def.items}rest(ci){return new Le({...this._def,rest:ci})}}Le.create=(fi,ci)=>{if(!Array.isArray(fi))throw new Error("You must pass an array of schemas to z.tuple([ ... ])");return new Le({items:fi,typeName:Ye.ZodTuple,rest:null,...M$1(ci)})};class Ce extends R$1{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci);if(_i.parsedType!==h$1.object)return b(_i,{code:f$1.invalid_type,expected:h$1.object,received:_i.parsedType}),x$2;const pi=[],mi=this._def.keyType,gi=this._def.valueType;for(const vi in _i.data)pi.push({key:mi._parse(new N$1(_i,vi,_i.path,vi)),value:gi._parse(new N$1(_i,_i.data[vi],_i.path,vi)),alwaysSet:vi in _i.data});return _i.common.async?k$2.mergeObjectAsync(hi,pi):k$2.mergeObjectSync(hi,pi)}get element(){return this._def.valueType}static create(ci,hi,_i){return new Ce(hi instanceof R$1?{keyType:ci,valueType:hi,typeName:Ye.ZodRecord,...M$1(_i)}:{keyType:ae.create(),valueType:ci,typeName:Ye.ZodRecord,...M$1(hi)})}}class Se extends R$1{get keySchema(){return this._def.keyType}get valueSchema(){return this._def.valueType}_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci);if(_i.parsedType!==h$1.map)return b(_i,{code:f$1.invalid_type,expected:h$1.map,received:_i.parsedType}),x$2;const pi=this._def.keyType,mi=this._def.valueType,gi=[..._i.data.entries()].map(([vi,xi],wi)=>({key:pi._parse(new N$1(_i,vi,_i.path,[wi,"key"])),value:mi._parse(new N$1(_i,xi,_i.path,[wi,"value"]))}));if(_i.common.async){const vi=new Map;return Promise.resolve().then(async()=>{for(const xi of gi){const wi=await xi.key,yi=await xi.value;if(wi.status==="aborted"||yi.status==="aborted")return x$2;wi.status!=="dirty"&&yi.status!=="dirty"||hi.dirty(),vi.set(wi.value,yi.value)}return{status:hi.value,value:vi}})}{const vi=new Map;for(const xi of gi){const wi=xi.key,yi=xi.value;if(wi.status==="aborted"||yi.status==="aborted")return x$2;wi.status!=="dirty"&&yi.status!=="dirty"||hi.dirty(),vi.set(wi.value,yi.value)}return{status:hi.value,value:vi}}}}Se.create=(fi,ci,hi)=>new Se({valueType:ci,keyType:fi,typeName:Ye.ZodMap,...M$1(hi)});class Ee extends R$1{_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci);if(_i.parsedType!==h$1.set)return b(_i,{code:f$1.invalid_type,expected:h$1.set,received:_i.parsedType}),x$2;const pi=this._def;pi.minSize!==null&&_i.data.size<pi.minSize.value&&(b(_i,{code:f$1.too_small,minimum:pi.minSize.value,type:"set",inclusive:!0,exact:!1,message:pi.minSize.message}),hi.dirty()),pi.maxSize!==null&&_i.data.size>pi.maxSize.value&&(b(_i,{code:f$1.too_big,maximum:pi.maxSize.value,type:"set",inclusive:!0,exact:!1,message:pi.maxSize.message}),hi.dirty());const mi=this._def.valueType;function gi(xi){const wi=new Set;for(const yi of xi){if(yi.status==="aborted")return x$2;yi.status==="dirty"&&hi.dirty(),wi.add(yi.value)}return{status:hi.value,value:wi}}const vi=[..._i.data.values()].map((xi,wi)=>mi._parse(new N$1(_i,xi,_i.path,wi)));return _i.common.async?Promise.all(vi).then(xi=>gi(xi)):gi(vi)}min(ci,hi){return new Ee({...this._def,minSize:{value:ci,message:j$2.toString(hi)}})}max(ci,hi){return new Ee({...this._def,maxSize:{value:ci,message:j$2.toString(hi)}})}size(ci,hi){return this.min(ci,hi).max(ci,hi)}nonempty(ci){return this.min(1,ci)}}Ee.create=(fi,ci)=>new Ee({valueType:fi,minSize:null,maxSize:null,typeName:Ye.ZodSet,...M$1(ci)});class Oe extends R$1{constructor(){super(...arguments),this.validate=this.implement}_parse(ci){const{ctx:hi}=this._processInputParams(ci);if(hi.parsedType!==h$1.function)return b(hi,{code:f$1.invalid_type,expected:h$1.function,received:hi.parsedType}),x$2;function _i(vi,xi){return v$1({data:vi,path:hi.path,errorMaps:[hi.common.contextualErrorMap,hi.schemaErrorMap,_$1(),y$1].filter(wi=>!!wi),issueData:{code:f$1.invalid_arguments,argumentsError:xi}})}function pi(vi,xi){return v$1({data:vi,path:hi.path,errorMaps:[hi.common.contextualErrorMap,hi.schemaErrorMap,_$1(),y$1].filter(wi=>!!wi),issueData:{code:f$1.invalid_return_type,returnTypeError:xi}})}const mi={errorMap:hi.common.contextualErrorMap},gi=hi.data;if(this._def.returns instanceof Me){const vi=this;return T$2(async function(...xi){const wi=new m$1([]),yi=await vi._def.args.parseAsync(xi,mi).catch(Ei=>{throw wi.addIssue(_i(xi,Ei)),wi}),Ci=await Reflect.apply(gi,this,yi);return await vi._def.returns._def.type.parseAsync(Ci,mi).catch(Ei=>{throw wi.addIssue(pi(Ci,Ei)),wi})})}{const vi=this;return T$2(function(...xi){const wi=vi._def.args.safeParse(xi,mi);if(!wi.success)throw new m$1([_i(xi,wi.error)]);const yi=Reflect.apply(gi,this,wi.data),Ci=vi._def.returns.safeParse(yi,mi);if(!Ci.success)throw new m$1([pi(yi,Ci.error)]);return Ci.data})}}parameters(){return this._def.args}returnType(){return this._def.returns}args(...ci){return new Oe({...this._def,args:Le.create(ci).rest(me.create())})}returns(ci){return new Oe({...this._def,returns:ci})}implement(ci){return this.parse(ci)}strictImplement(ci){return this.parse(ci)}static create(ci,hi,_i){return new Oe({args:ci||Le.create([]).rest(me.create()),returns:hi||me.create(),typeName:Ye.ZodFunction,...M$1(_i)})}}class je extends R$1{get schema(){return this._def.getter()}_parse(ci){const{ctx:hi}=this._processInputParams(ci);return this._def.getter()._parse({data:hi.data,path:hi.path,parent:hi})}}je.create=(fi,ci)=>new je({getter:fi,typeName:Ye.ZodLazy,...M$1(ci)});class Ie extends R$1{_parse(ci){if(ci.data!==this._def.value){const hi=this._getOrReturnCtx(ci);return b(hi,{received:hi.data,code:f$1.invalid_literal,expected:this._def.value}),x$2}return{status:"valid",value:ci.data}}get value(){return this._def.value}}function Ae(fi,ci){return new Ne({values:fi,typeName:Ye.ZodEnum,...M$1(ci)})}Ie.create=(fi,ci)=>new Ie({value:fi,typeName:Ye.ZodLiteral,...M$1(ci)});class Ne extends R$1{constructor(){super(...arguments),I$1.set(this,void 0)}_parse(ci){if(typeof ci.data!="string"){const hi=this._getOrReturnCtx(ci),_i=this._def.values;return b(hi,{expected:u$1.joinValues(_i),received:hi.parsedType,code:f$1.invalid_type}),x$2}if(E$1(this,I$1)||O$1(this,I$1,new Set(this._def.values)),!E$1(this,I$1).has(ci.data)){const hi=this._getOrReturnCtx(ci),_i=this._def.values;return b(hi,{received:hi.data,code:f$1.invalid_enum_value,options:_i}),x$2}return T$2(ci.data)}get options(){return this._def.values}get enum(){const ci={};for(const hi of this._def.values)ci[hi]=hi;return ci}get Values(){const ci={};for(const hi of this._def.values)ci[hi]=hi;return ci}get Enum(){const ci={};for(const hi of this._def.values)ci[hi]=hi;return ci}extract(ci,hi=this._def){return Ne.create(ci,{...this._def,...hi})}exclude(ci,hi=this._def){return Ne.create(this.options.filter(_i=>!ci.includes(_i)),{...this._def,...hi})}}I$1=new WeakMap,Ne.create=Ae;class Pe extends R$1{constructor(){super(...arguments),A$2.set(this,void 0)}_parse(ci){const hi=u$1.getValidEnumValues(this._def.values),_i=this._getOrReturnCtx(ci);if(_i.parsedType!==h$1.string&&_i.parsedType!==h$1.number){const pi=u$1.objectValues(hi);return b(_i,{expected:u$1.joinValues(pi),received:_i.parsedType,code:f$1.invalid_type}),x$2}if(E$1(this,A$2)||O$1(this,A$2,new Set(u$1.getValidEnumValues(this._def.values))),!E$1(this,A$2).has(ci.data)){const pi=u$1.objectValues(hi);return b(_i,{received:_i.data,code:f$1.invalid_enum_value,options:pi}),x$2}return T$2(ci.data)}get enum(){return this._def.values}}A$2=new WeakMap,Pe.create=(fi,ci)=>new Pe({values:fi,typeName:Ye.ZodNativeEnum,...M$1(ci)});class Me extends R$1{unwrap(){return this._def.type}_parse(ci){const{ctx:hi}=this._processInputParams(ci);if(hi.parsedType!==h$1.promise&&hi.common.async===!1)return b(hi,{code:f$1.invalid_type,expected:h$1.promise,received:hi.parsedType}),x$2;const _i=hi.parsedType===h$1.promise?hi.data:Promise.resolve(hi.data);return T$2(_i.then(pi=>this._def.type.parseAsync(pi,{path:hi.path,errorMap:hi.common.contextualErrorMap})))}}Me.create=(fi,ci)=>new Me({type:fi,typeName:Ye.ZodPromise,...M$1(ci)});class Re extends R$1{innerType(){return this._def.schema}sourceType(){return this._def.schema._def.typeName===Ye.ZodEffects?this._def.schema.sourceType():this._def.schema}_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci),pi=this._def.effect||null,mi={addIssue:gi=>{b(_i,gi),gi.fatal?hi.abort():hi.dirty()},get path(){return _i.path}};if(mi.addIssue=mi.addIssue.bind(mi),pi.type==="preprocess"){const gi=pi.transform(_i.data,mi);if(_i.common.async)return Promise.resolve(gi).then(async vi=>{if(hi.value==="aborted")return x$2;const xi=await this._def.schema._parseAsync({data:vi,path:_i.path,parent:_i});return xi.status==="aborted"?x$2:xi.status==="dirty"||hi.value==="dirty"?w$2(xi.value):xi});{if(hi.value==="aborted")return x$2;const vi=this._def.schema._parseSync({data:gi,path:_i.path,parent:_i});return vi.status==="aborted"?x$2:vi.status==="dirty"||hi.value==="dirty"?w$2(vi.value):vi}}if(pi.type==="refinement"){const gi=vi=>{const xi=pi.refinement(vi,mi);if(_i.common.async)return Promise.resolve(xi);if(xi instanceof Promise)throw new Error("Async refinement encountered during synchronous parse operation. Use .parseAsync instead.");return vi};if(_i.common.async===!1){const vi=this._def.schema._parseSync({data:_i.data,path:_i.path,parent:_i});return vi.status==="aborted"?x$2:(vi.status==="dirty"&&hi.dirty(),gi(vi.value),{status:hi.value,value:vi.value})}return this._def.schema._parseAsync({data:_i.data,path:_i.path,parent:_i}).then(vi=>vi.status==="aborted"?x$2:(vi.status==="dirty"&&hi.dirty(),gi(vi.value).then(()=>({status:hi.value,value:vi.value}))))}if(pi.type==="transform"){if(_i.common.async===!1){const gi=this._def.schema._parseSync({data:_i.data,path:_i.path,parent:_i});if(!C$2(gi))return gi;const vi=pi.transform(gi.value,mi);if(vi instanceof Promise)throw new Error("Asynchronous transform encountered during synchronous parse operation. Use .parseAsync instead.");return{status:hi.value,value:vi}}return this._def.schema._parseAsync({data:_i.data,path:_i.path,parent:_i}).then(gi=>C$2(gi)?Promise.resolve(pi.transform(gi.value,mi)).then(vi=>({status:hi.value,value:vi})):gi)}u$1.assertNever(pi)}}Re.create=(fi,ci,hi)=>new Re({schema:fi,typeName:Ye.ZodEffects,effect:ci,...M$1(hi)}),Re.createWithPreprocess=(fi,ci,hi)=>new Re({schema:ci,effect:{type:"preprocess",transform:fi},typeName:Ye.ZodEffects,...M$1(hi)});class $e extends R$1{_parse(ci){return this._getType(ci)===h$1.undefined?T$2(void 0):this._def.innerType._parse(ci)}unwrap(){return this._def.innerType}}$e.create=(fi,ci)=>new $e({innerType:fi,typeName:Ye.ZodOptional,...M$1(ci)});class Fe extends R$1{_parse(ci){return this._getType(ci)===h$1.null?T$2(null):this._def.innerType._parse(ci)}unwrap(){return this._def.innerType}}Fe.create=(fi,ci)=>new Fe({innerType:fi,typeName:Ye.ZodNullable,...M$1(ci)});class ze extends R$1{_parse(ci){const{ctx:hi}=this._processInputParams(ci);let _i=hi.data;return hi.parsedType===h$1.undefined&&(_i=this._def.defaultValue()),this._def.innerType._parse({data:_i,path:hi.path,parent:hi})}removeDefault(){return this._def.innerType}}ze.create=(fi,ci)=>new ze({innerType:fi,typeName:Ye.ZodDefault,defaultValue:typeof ci.default=="function"?ci.default:()=>ci.default,...M$1(ci)});class De extends R$1{_parse(ci){const{ctx:hi}=this._processInputParams(ci),_i={...hi,common:{...hi.common,issues:[]}},pi=this._def.innerType._parse({data:_i.data,path:_i.path,parent:{..._i}});return S(pi)?pi.then(mi=>({status:"valid",value:mi.status==="valid"?mi.value:this._def.catchValue({get error(){return new m$1(_i.common.issues)},input:_i.data})})):{status:"valid",value:pi.status==="valid"?pi.value:this._def.catchValue({get error(){return new m$1(_i.common.issues)},input:_i.data})}}removeCatch(){return this._def.innerType}}De.create=(fi,ci)=>new De({innerType:fi,typeName:Ye.ZodCatch,catchValue:typeof ci.catch=="function"?ci.catch:()=>ci.catch,...M$1(ci)});class Be extends R$1{_parse(ci){if(this._getType(ci)!==h$1.nan){const hi=this._getOrReturnCtx(ci);return b(hi,{code:f$1.invalid_type,expected:h$1.nan,received:hi.parsedType}),x$2}return{status:"valid",value:ci.data}}}Be.create=fi=>new Be({typeName:Ye.ZodNaN,...M$1(fi)});const Ve=Symbol("zod_brand");class Ue extends R$1{_parse(ci){const{ctx:hi}=this._processInputParams(ci),_i=hi.data;return this._def.type._parse({data:_i,path:hi.path,parent:hi})}unwrap(){return this._def.type}}class Ge extends R$1{_parse(ci){const{status:hi,ctx:_i}=this._processInputParams(ci);if(_i.common.async)return(async()=>{const pi=await this._def.in._parseAsync({data:_i.data,path:_i.path,parent:_i});return pi.status==="aborted"?x$2:pi.status==="dirty"?(hi.dirty(),w$2(pi.value)):this._def.out._parseAsync({data:pi.value,path:_i.path,parent:_i})})();{const pi=this._def.in._parseSync({data:_i.data,path:_i.path,parent:_i});return pi.status==="aborted"?x$2:pi.status==="dirty"?(hi.dirty(),{status:"dirty",value:pi.value}):this._def.out._parseSync({data:pi.value,path:_i.path,parent:_i})}}static create(ci,hi){return new Ge({in:ci,out:hi,typeName:Ye.ZodPipeline})}}class We extends R$1{_parse(ci){const hi=this._def.innerType._parse(ci),_i=pi=>(C$2(pi)&&(pi.value=Object.freeze(pi.value)),pi);return S(hi)?hi.then(pi=>_i(pi)):_i(hi)}unwrap(){return this._def.innerType}}function Ke(fi,ci={},hi){return fi?fe.create().superRefine((_i,pi)=>{var mi,gi;if(!fi(_i)){const vi=typeof ci=="function"?ci(_i):typeof ci=="string"?{message:ci}:ci,xi=(gi=(mi=vi.fatal)!==null&&mi!==void 0?mi:hi)===null||gi===void 0||gi,wi=typeof vi=="string"?{message:vi}:vi;pi.addIssue({code:"custom",...wi,fatal:xi})}}):fe.create()}We.create=(fi,ci)=>new We({innerType:fi,typeName:Ye.ZodReadonly,...M$1(ci)});const He={object:be.lazycreate};var Ye;(function(fi){fi.ZodString="ZodString",fi.ZodNumber="ZodNumber",fi.ZodNaN="ZodNaN",fi.ZodBigInt="ZodBigInt",fi.ZodBoolean="ZodBoolean",fi.ZodDate="ZodDate",fi.ZodSymbol="ZodSymbol",fi.ZodUndefined="ZodUndefined",fi.ZodNull="ZodNull",fi.ZodAny="ZodAny",fi.ZodUnknown="ZodUnknown",fi.ZodNever="ZodNever",fi.ZodVoid="ZodVoid",fi.ZodArray="ZodArray",fi.ZodObject="ZodObject",fi.ZodUnion="ZodUnion",fi.ZodDiscriminatedUnion="ZodDiscriminatedUnion",fi.ZodIntersection="ZodIntersection",fi.ZodTuple="ZodTuple",fi.ZodRecord="ZodRecord",fi.ZodMap="ZodMap",fi.ZodSet="ZodSet",fi.ZodFunction="ZodFunction",fi.ZodLazy="ZodLazy",fi.ZodLiteral="ZodLiteral",fi.ZodEnum="ZodEnum",fi.ZodEffects="ZodEffects",fi.ZodNativeEnum="ZodNativeEnum",fi.ZodOptional="ZodOptional",fi.ZodNullable="ZodNullable",fi.ZodDefault="ZodDefault",fi.ZodCatch="ZodCatch",fi.ZodPromise="ZodPromise",fi.ZodBranded="ZodBranded",fi.ZodPipeline="ZodPipeline",fi.ZodReadonly="ZodReadonly"})(Ye||(Ye={}));const Xe=ae.create,qe=oe.create,Je=Be.create,Qe=de.create,et=le.create,tt=ue.create,it=ce.create,st=he.create,rt=pe.create,at=fe.create,nt=me.create,ot=ye.create,dt=ge.create,lt=_e.create,ut=be.create,ct=be.strictCreate,ht=ke.create,pt=we.create,ft=Ze.create,mt=Le.create,yt=Ce.create,gt=Se.create,_t=Ee.create,vt=Oe.create,bt=je.create,kt=Ie.create,xt=Ne.create,wt=Pe.create,Tt=Me.create,Zt=Re.create,Lt=$e.create,Ct=Fe.create,St=Re.createWithPreprocess,Et=Ge.create,Ot={string:fi=>ae.create({...fi,coerce:!0}),number:fi=>oe.create({...fi,coerce:!0}),boolean:fi=>le.create({...fi,coerce:!0}),bigint:fi=>de.create({...fi,coerce:!0}),date:fi=>ue.create({...fi,coerce:!0})},jt=x$2;var It=Object.freeze({__proto__:null,defaultErrorMap:y$1,setErrorMap:function(fi){g$2=fi},getErrorMap:_$1,makeIssue:v$1,EMPTY_PATH:[],addIssueToContext:b,ParseStatus:k$2,INVALID:x$2,DIRTY:w$2,OK:T$2,isAborted:Z$1,isDirty:L$1,isValid:C$2,isAsync:S,get util(){return u$1},get objectUtil(){return c$1},ZodParsedType:h$1,getParsedType:p$1,ZodType:R$1,datetimeRegex:ie,ZodString:ae,ZodNumber:oe,ZodBigInt:de,ZodBoolean:le,ZodDate:ue,ZodSymbol:ce,ZodUndefined:he,ZodNull:pe,ZodAny:fe,ZodUnknown:me,ZodNever:ye,ZodVoid:ge,ZodArray:_e,ZodObject:be,ZodUnion:ke,ZodDiscriminatedUnion:we,ZodIntersection:Ze,ZodTuple:Le,ZodRecord:Ce,ZodMap:Se,ZodSet:Ee,ZodFunction:Oe,ZodLazy:je,ZodLiteral:Ie,ZodEnum:Ne,ZodNativeEnum:Pe,ZodPromise:Me,ZodEffects:Re,ZodTransformer:Re,ZodOptional:$e,ZodNullable:Fe,ZodDefault:ze,ZodCatch:De,ZodNaN:Be,BRAND:Ve,ZodBranded:Ue,ZodPipeline:Ge,ZodReadonly:We,custom:Ke,Schema:R$1,ZodSchema:R$1,late:He,get ZodFirstPartyTypeKind(){return Ye},coerce:Ot,any:at,array:lt,bigint:Qe,boolean:et,date:tt,discriminatedUnion:pt,effect:Zt,enum:xt,function:vt,instanceof:(fi,ci={message:`Input not instance of ${fi.name}`})=>Ke(hi=>hi instanceof fi,ci),intersection:ft,lazy:bt,literal:kt,map:gt,nan:Je,nativeEnum:wt,never:ot,null:rt,nullable:Ct,number:qe,object:ut,oboolean:()=>et().optional(),onumber:()=>qe().optional(),optional:Lt,ostring:()=>Xe().optional(),pipeline:Et,preprocess:St,promise:Tt,record:yt,set:_t,strictObject:ct,string:Xe,symbol:it,transformer:Zt,tuple:mt,undefined:st,union:ht,unknown:nt,void:dt,NEVER:jt,ZodIssueCode:f$1,quotelessJson:fi=>JSON.stringify(fi,null,2).replace(/"([^"]+)":/g,"$1:"),ZodError:m$1});const At=It.object({h:It.number(),tilesetUid:It.number(),w:It.number(),x:It.number(),y:It.number()}),Nt=It.tuple([It.number(),It.number()]),Pt=It.object({__identifier:It.string(),__tile:At.nullable(),__type:It.string(),__value:It.any(),defUid:It.number()}),Mt=It.object({a:It.number(),f:It.number(),px:Nt,src:Nt,t:It.number()}),Rt=It.object({__grid:Nt,__identifier:It.string(),__pivot:Nt,__smartColor:It.string(),__tags:It.array(It.string()),__tile:At.nullable(),__worldX:It.number().nullable(),__worldY:It.number().nullable(),defUid:It.number(),fieldInstances:It.array(Pt),height:It.number(),iid:It.string(),px:Nt,width:It.number()}),$t=It.object({__cHei:It.number(),__cWid:It.number(),__gridSize:It.number(),__identifier:It.string(),__opacity:It.number(),__pxTotalOffsetX:It.number(),__pxTotalOffsetY:It.number(),__tilesetDefUid:It.number().nullable(),__tilesetRelPath:It.string().nullable(),__type:It.union([It.literal("IntGrid"),It.literal("Entities"),It.literal("Tiles"),It.literal("AutoLayer")]),autoLayerTiles:It.array(Mt),entityInstances:It.array(Rt),gridTiles:It.array(Mt),iid:It.string(),intGridCsv:It.array(It.number()),layerDefUid:It.number(),levelId:It.number(),overrideTilesetUid:It.number().nullable(),pxOffsetX:It.number(),pxOffsetY:It.number(),visible:It.boolean()}),Ft=It.object({__bgColor:It.string().nullable(),bgColor:It.string().nullable(),__bgPos:It.object({cropRect:It.array(It.tuple([It.number(),It.number(),It.number(),It.number()])),scale:It.tuple([It.number(),It.number()]),topLeftPx:Nt}).nullable(),__neighbours:It.array(It.object({dir:It.union([It.literal("n"),It.literal("s"),It.literal("w"),It.literal("e"),It.literal("ne"),It.literal("nw"),It.literal("se"),It.literal("sw"),It.literal("o"),It.literal("<"),It.literal(">")]),levelIid:It.string()})),bgRelPath:It.string().nullable(),externalRelPath:It.string().nullable(),fieldInstances:It.array(Pt),identifier:It.string(),iid:It.string(),layerInstances:It.array($t).nullable(),pxHei:It.number(),pxWid:It.number(),uid:It.number(),worldDepth:It.number(),worldX:It.number(),worldY:It.number()}),zt=It.object({identifier:It.string(),iid:It.string(),levels:It.array(Ft),worldGridHeight:It.number(),worldGridWidth:It.number(),worldLayout:It.union([It.literal("Free"),It.literal("GridVania"),It.literal("LinearHorizontal"),It.literal("LinearVertical")])}),Dt=It.object({color:It.number(),id:It.string(),tileRect:At.nullable()}),Bt=It.object({externalRelPath:It.string().nullable(),iconTilesetUid:It.number().nullable(),identifier:It.string(),tags:It.array(It.string()),uid:It.number(),values:It.array(Dt)}),Vt=It.object({__cHei:It.number(),__cWid:It.number(),customData:It.array(It.object({data:It.string(),tileId:It.number()})),embedAtlas:It.string().nullable(),enumTags:It.optional(It.array(It.object({enumValueId:It.string(),tileIds:It.array(It.number())}))),identifier:It.string(),padding:It.number(),pxHei:It.number(),pxWid:It.number(),relPath:It.string().nullable(),spacing:It.number(),tags:It.array(It.string()),tagsSourceEnumUid:It.number().nullable(),tileGridSize:It.number(),uid:It.number()}),Ut=It.object({__type:It.union([It.literal("IntGrid"),It.literal("Entities"),It.literal("Tiles"),It.literal("AutoLayer")]),autoSourceLayerDefUid:It.number().nullable(),displayOpacity:It.number(),gridSize:It.number(),identifier:It.string(),intGridValues:It.array(It.object({color:It.string(),groupUid:It.number(),identifier:It.string().nullable(),tile:At.nullable(),value:It.number()})),intGridValuesGroups:It.array(It.object({color:It.string().nullable(),identifier:It.string().nullable(),uid:It.number()})),parallaxFactorX:It.number(),parallaxFactorY:It.number(),parallaxScaling:It.boolean(),pxOffsetX:It.number(),pxOffsetY:It.number(),tilesetDefUid:It.number().nullable(),uid:It.number()}),Gt=It.object({color:It.string(),height:It.number(),identifier:It.string(),nineSliceBorders:It.array(It.number()),pivotX:It.number(),pivotY:It.number(),tileRect:At.nullable(),tileRenderMode:It.union([It.literal("Cover"),It.literal("FitInside"),It.literal("Repeat"),It.literal("Stretch"),It.literal("FullSizeCropped"),It.literal("FullSizeUncropped"),It.literal("NineSlice")]),tilesetId:It.number().nullable(),uiTileRect:At.nullable(),uid:It.number(),width:It.number()}),Wt=It.object({tilesets:It.array(Vt),enums:It.array(Bt),layers:It.array(Ut),entities:It.array(Gt)}),Kt=It.object({iid:It.string(),bgColor:It.string().nullable(),defs:Wt,externalLevels:It.boolean(),jsonVersion:It.string(),levels:It.array(Ft),toc:It.array(It.object({identifier:It.string(),instancesData:It.array(It.object({fields:It.any(),heiPx:It.number(),iids:It.string(),widPix:It.number(),worldX:It.number(),worldY:It.number()}))})),worldGridHeight:It.number().nullable(),worldGridWidth:It.number().nullable(),worldLayout:It.union([It.literal("Free"),It.literal("GridVania"),It.literal("LinearHorizontal"),It.literal("LinearVertical")]).nullable(),worlds:It.array(zt)}),Ht=/^[v^~<>=]*?(\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+)(?:\.([x*]|\d+))?(?:-([\da-z\-]+(?:\.[\da-z\-]+)*))?(?:\+[\da-z\-]+(?:\.[\da-z\-]+)*)?)?)?$/i,Yt=fi=>{if(typeof fi!="string")throw new TypeError("Invalid argument expected string");const ci=fi.match(Ht);if(!ci)throw new Error(`Invalid argument not valid semver ('${fi}' received)`);return ci.shift(),ci},Xt=fi=>fi==="*"||fi==="x"||fi==="X",qt=fi=>{const ci=parseInt(fi,10);return isNaN(ci)?fi:ci},Jt=(fi,ci)=>{if(Xt(fi)||Xt(ci))return 0;const[hi,_i]=((pi,mi)=>typeof pi!=typeof mi?[String(pi),String(mi)]:[pi,mi])(qt(fi),qt(ci));return hi>_i?1:hi<_i?-1:0},Qt=(fi,ci)=>{for(let hi=0;hi<Math.max(fi.length,ci.length);hi++){const _i=Jt(fi[hi]||"0",ci[hi]||"0");if(_i!==0)return _i}return 0},ei=(fi,ci,hi)=>{si(hi);const _i=((pi,mi)=>{const gi=Yt(pi),vi=Yt(mi),xi=gi.pop(),wi=vi.pop(),yi=Qt(gi,vi);return yi!==0?yi:xi&&wi?Qt(xi.split("."),wi.split(".")):xi||wi?xi?-1:1:0})(fi,ci);return ti[hi].includes(_i)},ti={">":[1],">=":[0,1],"=":[0],"<=":[-1,0],"<":[-1],"!=":[-1,1]},ii=Object.keys(ti),si=fi=>{if(ii.indexOf(fi)===-1)throw new Error(`Invalid operator, expected one of ${ii.join("|")}`)};class ri{constructor(ci){this.type=ci,this._loaded=!1,this.cache=new Map}getOrAdd(...ci){let hi=this.cache.get(ci.join("+"));return hi||(hi=new this.type(...ci),this.cache.set(ci.join("+"),hi),hi)}values(){if(this._loaded)return Array.from(this.cache.values());throw new Error("Read through cache not yet loaded! No values to return!")}async load(){const ci=Array.from(this.cache.entries()),hi=await Promise.allSettled(ci.map(pi=>pi[1].load()));let _i=0;for(let pi=0;pi<hi.length;pi++){const mi=hi[pi];mi.status==="rejected"&&(console.error(`Error loading resource at ${ci[pi][0]}, is your pathMap correct? or your LDtk map corrupted?`,mi.reason),_i++)}if(_i)throw new Error(`Error loading ${_i} resources`);this._loaded=!0}}class ai{constructor(ci,hi,_i,pi){var mi,gi;if(this.ldtkLayer=hi,this.resource=_i,this.order=pi,this.entities=[],this.ldtkToEntity=new Map,this.entityToLdtk=new Map,this.worldPos=(0,s$1.vec)(ci.ldtkLevel.worldX,ci.ldtkLevel.worldY),this.offset=(0,s$1.vec)(hi.__pxTotalOffsetX,hi.__pxTotalOffsetY),hi.entityInstances)for(let vi of hi.entityInstances){const xi=_i.projectMetadata.defs.entities.find(wi=>wi.identifier===vi.__identifier);if(_i.factories.has(vi.__identifier)){const wi=_i.factories.get(vi.__identifier);if(wi){const yi=wi({type:vi.__identifier,worldPos:(0,s$1.vec)(vi.px[0],vi.px[1]).add(this.worldPos.add(this.offset)),entity:vi,definition:xi,layer:this});yi&&(this.entities.push(yi),this.ldtkToEntity.set(vi,yi),this.entityToLdtk.set(yi,vi))}}else{const wi=new s$1.Actor({name:vi.__identifier,pos:(0,s$1.vec)(vi.px[0],vi.px[1]).add(this.worldPos.add(this.offset)),width:vi.width,height:vi.height,anchor:(0,s$1.vec)((mi=xi==null?void 0:xi.pivotX)!==null&&mi!==void 0?mi:0,(gi=xi==null?void 0:xi.pivotY)!==null&&gi!==void 0?gi:0),z:pi});if(vi.__tile){const yi=_i.tilesets.get(vi.__tile.tilesetUid);if(yi){const Ci=Math.floor(vi.__tile.x/vi.__tile.w),Ei=Math.floor(vi.__tile.y/vi.__tile.h),Si=yi.spritesheet.getSprite(Ci,Ei);Si&&wi.graphics.use(Si)}}this.entities.push(wi),this.ldtkToEntity.set(vi,wi),this.entityToLdtk.set(wi,vi)}}}runFactories(){for(let ci of this.ldtkLayer.entityInstances){const hi=this.resource.factories.get(ci.__identifier);if(!hi)continue;const _i=this.resource.projectMetadata.defs.entities.find(mi=>mi.identifier===ci.__identifier),pi=hi({type:ci.__identifier,worldPos:(0,s$1.vec)(ci.px[0],ci.px[1]).add(this.worldPos.add(this.offset)),entity:ci,definition:_i,layer:this});if(pi){const mi=this.ldtkToEntity.get(ci);if(mi){const gi=this.entities.indexOf(mi);gi>-1&&(this.entities.splice(gi,1),this.ldtkToEntity.delete(ci),this.entityToLdtk.delete(mi))}this.entities.push(pi),this.ldtkToEntity.set(ci,pi),this.entityToLdtk.set(pi,ci)}}}getEntitiesByIdentifier(ci){const hi=this.getLdtkEntitiesByIdentifier(ci);let _i=[];for(const pi of hi){const mi=this.ldtkToEntity.get(pi);mi&&_i.push(mi)}return _i}getEntitiesByField(ci,hi){const _i=this.getLdtkEntitiesByField(ci,hi);let pi=[];for(const mi of _i){const gi=this.ldtkToEntity.get(mi);gi&&pi.push(gi)}return pi}getLdtkEntitiesByIdentifier(ci){return this.ldtkLayer.entityInstances.filter(hi=>hi.__identifier.toLocaleLowerCase()===ci.toLowerCase())}getLdtkEntitiesByField(ci,hi){return this.ldtkLayer.entityInstances.filter(_i=>{if(hi!==void 0){let pi=hi;typeof hi=="string"&&(pi=hi.toLocaleLowerCase());const mi=_i.fieldInstances.find(gi=>gi.__identifier.toLocaleLowerCase()===ci.toLocaleLowerCase());return!!mi&&mi.__value===pi}return!!_i.fieldInstances.find(pi=>pi.__identifier.toLocaleLowerCase()===ci.toLocaleLowerCase())})}}class ni{constructor(ci,hi,_i,pi){var mi,gi,vi,xi;if(this.order=pi,this.worldPos=(0,s$1.vec)(ci.ldtkLevel.worldX,ci.ldtkLevel.worldY),this.offset=(0,s$1.vec)(hi.__pxTotalOffsetX,hi.__pxTotalOffsetY),this.ldtkLayer=hi,hi.intGridCsv.length||hi.autoLayerTiles.length){const wi=hi.__cHei,yi=hi.__cWid;this.tilemap=new s$1.TileMap({name:hi.__identifier,pos:this.worldPos.add(this.offset),tileWidth:hi.__gridSize,tileHeight:hi.__gridSize,rows:wi,columns:yi}),this.tilemap.z=pi,this.tilemap.get(s$1.GraphicsComponent).isVisible=hi.visible;const Ci=_i.projectMetadata.defs.layers.find(Ei=>hi.__identifier===Ei.identifier);if(Ci){const Ei=Ci.intGridValues.find(Si=>{var ki;return((ki=Si==null?void 0:Si.identifier)===null||ki===void 0?void 0:ki.toLocaleLowerCase())==="solid"});for(let Si=0;Si<hi.intGridCsv.length;Si++){const ki=Si%yi,Ai=Math.floor(Si/yi),Ii=this.tilemap.getTile(ki,Ai);Ei&&hi.intGridCsv[Si]===Ei.value&&(Ii.solid=!0),Ei||hi.intGridCsv[Si]!==1||(Ii.solid=!0)}if(hi.__tilesetDefUid){this.tileset=_i.tilesets.get(hi.__tilesetDefUid);for(let Si=0;Si<hi.autoLayerTiles.length;Si++){const ki=hi.autoLayerTiles[Si],Ai=Math.floor(ki.px[0]/hi.__gridSize),Ii=Math.floor(ki.px[1]/hi.__gridSize),Ti=this.tilemap.getTile(Ai,Ii);if(Ti&&this.tileset){const Pi=Math.floor((ki.src[0]-((mi=this.tileset.ldtkTileset.padding)!==null&&mi!==void 0?mi:0))/(this.tileset.ldtkTileset.tileGridSize+((gi=this.tileset.ldtkTileset.spacing)!==null&&gi!==void 0?gi:0))),Li=Math.floor((ki.src[1]-((vi=this.tileset.ldtkTileset.padding)!==null&&vi!==void 0?vi:0))/(this.tileset.ldtkTileset.tileGridSize+((xi=this.tileset.ldtkTileset.spacing)!==null&&xi!==void 0?xi:0))),Ri=!!(1&ki.f),Di=!!(2&ki.f);let Fi=this.tileset.spritesheet.getSprite(Pi,Li);(Ri||Di)&&(Fi=Fi.clone(),Fi.flipHorizontal=Ri,Fi.flipVertical=Di),Fi?Ti.addGraphic(Fi):console.error("Could not find sprite in LDtk spritesheet at",Pi,Li)}}}}}}}class oi{constructor(ci,hi){var _i,pi,mi,gi;if(this.ldtkLevel=ci,this.resource=hi,this.layers=[],ci.__bgColor&&(this.backgroundColor=s$1.Color.fromHex(ci.__bgColor)),ci.layerInstances){let vi=hi.startZIndex,xi=ci.layerInstances.slice().reverse();for(let wi of xi)((_i=wi.entityInstances)===null||_i===void 0?void 0:_i.length)!==0&&this.layers.push(new ai(this,wi,hi,vi)),((pi=wi.gridTiles)===null||pi===void 0?void 0:pi.length)!==0&&this.layers.push(new r$1(this,wi,hi,vi)),((mi=wi.intGridCsv)===null||mi===void 0?void 0:mi.length)===0&&((gi=wi.autoLayerTiles)===null||gi===void 0?void 0:gi.length)===0||this.layers.push(new ni(this,wi,hi,vi)),vi++}}}class di{constructor(ci,hi,_i){this.path=ci,this.resource=hi,this.fileLoader=l$1,this.strict=!0,this.headless=!1;const{headless:pi,strict:mi,fileLoader:gi,imageLoader:vi,pathMap:xi}={..._i};this.fileLoader=gi??this.fileLoader,this.strict=mi??this.strict,this.headless=pi??this.headless,this.imageLoader=vi??new ri(s$1.ImageSource),this.pathMap=xi??this.pathMap}async load(){const ci=await this.fileLoader(this.path,"json");let hi;if(this.strict)try{hi=Ft.parse(ci)}catch(_i){throw console.error(`Could not parse LDtk level data at ${this.path} are you sure a level is there and not corrupt?`),_i}else hi=ci;return this.data=new oi(hi,this.resource)}isLoaded(){return!!this.data}}class li{constructor(ci){var hi,_i,pi,mi;const{image:gi,ldtkTileset:vi}=ci;this.image=gi,this.ldtkTileset=vi,this.spritesheet=s$1.SpriteSheet.fromImageSource({image:gi,grid:{rows:vi.pxHei/vi.tileGridSize,columns:vi.pxWid/vi.tileGridSize,spriteHeight:vi.tileGridSize,spriteWidth:vi.tileGridSize},spacing:{margin:{x:(hi=vi.spacing)!==null&&hi!==void 0?hi:0,y:(_i=vi.spacing)!==null&&_i!==void 0?_i:0},originOffset:{x:(pi=vi.padding)!==null&&pi!==void 0?pi:0,y:(mi=vi.padding)!==null&&mi!==void 0?mi:0}}})}}class ui{constructor(ci,hi){this.path=ci,this.tilesets=new Map,this.levels=new Map,this.levelsByName=new Map,this.factories=new Map,this.fileLoader=l$1,this._imageLoader=new ri(s$1.ImageSource),this._levelLoader=new ri(di),this.startZIndex=0,this.textQuality=4,this.useExcaliburWiring=!0,this.useMapBackgroundColor=!1,this.useTilemapCameraStrategy=!1,this.headless=!1,this.strict=!0;const{useExcaliburWiring:_i,useTilemapCameraStrategy:pi,entityIdentifierFactories:mi,pathMap:gi,useMapBackgroundColor:vi,fileLoader:xi,strict:wi,headless:yi,startZIndex:Ci}={...hi};this.strict=wi??this.strict,this.headless=yi??this.headless,this.useExcaliburWiring=_i??this.useExcaliburWiring,this.useTilemapCameraStrategy=pi??this.useTilemapCameraStrategy,this.useMapBackgroundColor=vi??this.useMapBackgroundColor,this.startZIndex=Ci??this.startZIndex,this.fileLoader=xi??this.fileLoader,this.pathMap=gi;for(const Ei in mi)this.registerEntityIdentifierFactory(Ei,mi[Ei])}async load(){var ci;const hi=await this.fileLoader(this.path,"json");if(this.strict)try{this.projectMetadata=Kt.parse(hi)}catch(_i){throw console.error(`Could not parse LDtk map from location ${this.path}.
Excalibur only supports the latest version of LDtk formats as of the plugin's release.`),console.error("Is your map file corrupted or being interpreted as the wrong type?"),_i}else this.projectMetadata=hi;ei(ui.supportedLdtkVersion,(ci=this.projectMetadata.jsonVersion)!==null&&ci!==void 0?ci:"0.0.0",">")&&console.warn(`The excalibur ldtk plugin officially supports ${ui.supportedLdtkVersion}+, the current map has LDtk version ${this.projectMetadata.jsonVersion}`);for(let _i of this.projectMetadata.defs.tilesets)if(_i.relPath){const pi=d$1(this.path,_i.relPath,this.pathMap),mi=this._imageLoader.getOrAdd(pi),gi=new li({image:mi,ldtkTileset:_i});this.tilesets.set(_i.uid,gi)}else _i.identifier!=="Internal_Icons"&&console.warn(`No tileset image provided for ${_i.identifier}`);for(let _i of this.projectMetadata.levels)if(_i.externalRelPath){const pi=d$1(this.path,_i.externalRelPath,this.pathMap);this._levelLoader.getOrAdd(pi,this,{headless:this.headless,strict:this.strict,fileLoader:this.fileLoader,imageLoader:this._imageLoader,pathMap:this.pathMap})}else{const pi=new oi(_i,this);this.levels.set(_i.uid,pi),this.levelsByName.set(_i.identifier.toLowerCase(),pi)}return await Promise.all([this._imageLoader.load(),this._levelLoader.load()]),this._levelLoader.values().forEach(_i=>{this.levels.set(_i.data.ldtkLevel.uid,_i.data),this.levelsByName.set(_i.data.ldtkLevel.identifier.toLowerCase(),_i.data)}),this.data=this.projectMetadata}isLoaded(){return!!this.data}registerEntityIdentifierFactory(ci,hi){this.factories.set(ci,hi)}registerEntityIdentifierFactories(ci){for(const hi in ci)this.registerEntityIdentifierFactory(hi,ci[hi])}getLevel(ci){return this.levelsByName.get(ci.toLowerCase())}getEntityLayers(ci){let hi=[];if(ci){const _i=this.getLevel(ci);if(_i)for(let pi of _i.layers)pi instanceof ai&&hi.push(pi)}else for(const _i of this.levels.values())for(let pi of _i.layers)pi instanceof ai&&hi.push(pi);return hi}getTileLayers(ci){let hi=[];if(ci){const _i=this.getLevel(ci);if(_i)for(let pi of _i.layers)pi instanceof r$1&&hi.push(pi)}else for(const _i of this.levels.values())for(let pi of _i.layers)pi instanceof r$1&&hi.push(pi);return hi}getIntGridLayers(ci){let hi=[];if(ci){const _i=this.getLevel(ci);if(_i)for(let pi of _i.layers)pi instanceof ni&&hi.push(pi)}else for(const _i of this.levels.values())for(let pi of _i.layers)pi instanceof ni&&hi.push(pi);return hi}getLdtkEntitiesByIdentifier(ci,hi){let _i=[];const pi=hi??Array.from(this.levels.values()).map(mi=>mi.ldtkLevel.identifier);for(const mi of pi){const gi=this.getEntityLayers(mi);for(let vi of gi)_i=_i.concat(vi.getLdtkEntitiesByIdentifier(ci))}return _i}getLdtkEntitiesByField(ci,hi,_i){let pi=[];const mi=_i??Array.from(this.levels.values()).map(gi=>gi.ldtkLevel.identifier);for(const gi of mi){const vi=this.getEntityLayers(gi);for(let xi of vi)pi=pi.concat(xi.getLdtkEntitiesByField(ci,hi))}return pi}getEntitiesByIdentifier(ci,hi){let _i=[];const pi=hi??Array.from(this.levels.values()).map(mi=>mi.ldtkLevel.identifier);for(const mi of pi){const gi=this.getEntityLayers(mi);for(let vi of gi)_i=_i.concat(vi.getEntitiesByIdentifier(ci))}return _i}getEntitiesByField(ci,hi,_i){let pi=[];const mi=_i??Array.from(this.levels.values()).map(gi=>gi.ldtkLevel.identifier);for(const gi of mi){const vi=this.getEntityLayers(gi);for(let xi of vi)pi=pi.concat(xi.getEntitiesByField(ci,hi))}return pi}getLevelBounds(ci){ci=ci??Array.from(this.levelsByName.keys());let hi=null;for(const _i of this.levels.values()){if(!ci.includes(_i.ldtkLevel.identifier))continue;const pi=this.getTileLayers(_i.ldtkLevel.identifier)[0];if(pi){const mi=s$1.BoundingBox.fromDimension(pi.tilemap.tileWidth*pi.tilemap.columns,pi.tilemap.tileHeight*pi.tilemap.rows,s$1.Vector.Zero,pi.tilemap.pos);hi=hi?hi.combine(mi):mi}}return hi??new s$1.BoundingBox}addToScene(ci,hi){var _i,pi;const{pos:mi,useLevelOffsets:gi}={pos:(0,s$1.vec)(0,0),useLevelOffsets:!0,...hi};for(let[vi,xi]of this.levels.entries())if(!(!((_i=hi==null?void 0:hi.levelFilter)===null||_i===void 0)&&_i.length)||hi.levelFilter.includes(xi.ldtkLevel.identifier))for(let wi of xi.layers)if(wi instanceof r$1||wi instanceof ni)wi.tilemap.pos=wi.tilemap.pos.add(mi),gi||(wi.tilemap.pos=wi.tilemap.pos.sub(wi.worldPos)),ci.add(wi.tilemap);else{wi.runFactories();for(let yi of wi.entities){const Ci=yi.get(s$1.TransformComponent);Ci&&(Ci.pos=Ci.pos.add(mi),gi||(Ci.pos=Ci.pos.sub(wi.worldPos))),ci.add(yi)}}if(this.useExcaliburWiring){const vi=this.getLdtkEntitiesByField("camera",!0)[0];if(vi){ci.camera.pos=(0,s$1.vec)(vi.px[0],vi.px[0]);const xi=vi.fieldInstances.find(wi=>wi.__identifier.toLocaleLowerCase()==="zoom");xi&&(ci.camera.zoom=+xi.__value)}}if(this.useTilemapCameraStrategy){let vi=this.getLevelBounds(hi==null?void 0:hi.levelFilter);ci.camera.strategy.limitCameraBounds(vi)}if(this.useMapBackgroundColor){for(let[vi,xi]of this.levels.entries())if(!(!((pi=hi==null?void 0:hi.levelFilter)===null||pi===void 0)&&pi.length)||hi.levelFilter.includes(xi.ldtkLevel.identifier)){ci.backgroundColor=xi.backgroundColor;break}}}}ui.supportedLdtkVersion="1.5.3";i$1.dd;i$1.UZ;i$1.NN;i$1.e1;i$1.a8;i$1.u6;i$1.oK;i$1.U_;i$1.sn;var bi=i$1.GY;i$1.$t;i$1.RI;i$1._k;i$1.eZ;i$1.pf;i$1.N5;i$1.qD;i$1.hu;i$1.Uk;const FRAC=23283064365386963e-26;class RNG{constructor(){this._seed=0,this._s0=0,this._s1=0,this._s2=0,this._c=0}getSeed(){return this._seed}setSeed(ci){return ci=ci<1?1/ci:ci,this._seed=ci,this._s0=(ci>>>0)*FRAC,ci=ci*69069+1>>>0,this._s1=ci*FRAC,ci=ci*69069+1>>>0,this._s2=ci*FRAC,this._c=1,this}getUniform(){let ci=2091639*this._s0+this._c*FRAC;return this._s0=this._s1,this._s1=this._s2,this._c=ci|0,this._s2=ci-this._c,this._s2}getUniformInt(ci,hi){let _i=Math.max(ci,hi),pi=Math.min(ci,hi);return Math.floor(this.getUniform()*(_i-pi+1))+pi}getNormal(ci=0,hi=1){let _i,pi,mi;do _i=2*this.getUniform()-1,pi=2*this.getUniform()-1,mi=_i*_i+pi*pi;while(mi>1||mi==0);let gi=_i*Math.sqrt(-2*Math.log(mi)/mi);return ci+gi*hi}getPercentage(){return 1+Math.floor(this.getUniform()*100)}getItem(ci){return ci.length?ci[Math.floor(this.getUniform()*ci.length)]:null}shuffle(ci){let hi=[],_i=ci.slice();for(;_i.length;){let pi=_i.indexOf(this.getItem(_i));hi.push(_i.splice(pi,1)[0])}return hi}getWeightedValue(ci){let hi=0;for(let gi in ci)hi+=ci[gi];let _i=this.getUniform()*hi,pi,mi=0;for(pi in ci)if(mi+=ci[pi],_i<mi)return pi;return pi}getState(){return[this._s0,this._s1,this._s2,this._c]}setState(ci){return this._s0=ci[0],this._s1=ci[1],this._s2=ci[2],this._c=ci[3],this}clone(){return new RNG().setState(this.getState())}}const RNG$1=new RNG().setSeed(Date.now());class Backend{getContainer(){return null}setOptions(ci){this._options=ci}}class Canvas extends Backend{constructor(){super(),this._ctx=document.createElement("canvas").getContext("2d")}schedule(ci){requestAnimationFrame(ci)}getContainer(){return this._ctx.canvas}setOptions(ci){super.setOptions(ci);const _i=`${ci.fontStyle?`${ci.fontStyle} `:""} ${ci.fontSize}px ${ci.fontFamily}`;this._ctx.font=_i,this._updateSize(),this._ctx.font=_i,this._ctx.textAlign="center",this._ctx.textBaseline="middle"}clear(){const ci=this._ctx.globalCompositeOperation;this._ctx.globalCompositeOperation="copy",this._ctx.fillStyle=this._options.bg,this._ctx.fillRect(0,0,this._ctx.canvas.width,this._ctx.canvas.height),this._ctx.globalCompositeOperation=ci}eventToPosition(ci,hi){let _i=this._ctx.canvas,pi=_i.getBoundingClientRect();return ci-=pi.left,hi-=pi.top,ci*=_i.width/pi.width,hi*=_i.height/pi.height,ci<0||hi<0||ci>=_i.width||hi>=_i.height?[-1,-1]:this._normalizedEventToPosition(ci,hi)}}class Rect extends Canvas{constructor(){super(),this._spacingX=0,this._spacingY=0,this._canvasCache={}}setOptions(ci){super.setOptions(ci),this._canvasCache={}}draw(ci,hi){Rect.cache?this._drawWithCache(ci):this._drawNoCache(ci,hi)}_drawWithCache(ci){let[hi,_i,pi,mi,gi]=ci,vi=""+pi+mi+gi,xi;if(vi in this._canvasCache)xi=this._canvasCache[vi];else{let wi=this._options.border;xi=document.createElement("canvas");let yi=xi.getContext("2d");if(xi.width=this._spacingX,xi.height=this._spacingY,yi.fillStyle=gi,yi.fillRect(wi,wi,xi.width-wi,xi.height-wi),pi){yi.fillStyle=mi,yi.font=this._ctx.font,yi.textAlign="center",yi.textBaseline="middle";let Ci=[].concat(pi);for(let Ei=0;Ei<Ci.length;Ei++)yi.fillText(Ci[Ei],this._spacingX/2,Math.ceil(this._spacingY/2))}this._canvasCache[vi]=xi}this._ctx.drawImage(xi,hi*this._spacingX,_i*this._spacingY)}_drawNoCache(ci,hi){let[_i,pi,mi,gi,vi]=ci;if(hi){let wi=this._options.border;this._ctx.fillStyle=vi,this._ctx.fillRect(_i*this._spacingX+wi,pi*this._spacingY+wi,this._spacingX-wi,this._spacingY-wi)}if(!mi)return;this._ctx.fillStyle=gi;let xi=[].concat(mi);for(let wi=0;wi<xi.length;wi++)this._ctx.fillText(xi[wi],(_i+.5)*this._spacingX,Math.ceil((pi+.5)*this._spacingY))}computeSize(ci,hi){let _i=Math.floor(ci/this._spacingX),pi=Math.floor(hi/this._spacingY);return[_i,pi]}computeFontSize(ci,hi){let _i=Math.floor(ci/this._options.width),pi=Math.floor(hi/this._options.height),mi=this._ctx.font;this._ctx.font="100px "+this._options.fontFamily;let gi=Math.ceil(this._ctx.measureText("W").width);this._ctx.font=mi;let xi=gi/100*pi/_i;return xi>1&&(pi=Math.floor(pi/xi)),Math.floor(pi/this._options.spacing)}_normalizedEventToPosition(ci,hi){return[Math.floor(ci/this._spacingX),Math.floor(hi/this._spacingY)]}_updateSize(){const ci=this._options,hi=Math.ceil(this._ctx.measureText("W").width);this._spacingX=Math.ceil(ci.spacing*hi),this._spacingY=Math.ceil(ci.spacing*ci.fontSize),ci.forceSquareRatio&&(this._spacingX=this._spacingY=Math.max(this._spacingX,this._spacingY)),this._ctx.canvas.width=ci.width*this._spacingX,this._ctx.canvas.height=ci.height*this._spacingY}}Rect.cache=!1;let DEFAULT_WIDTH=80,DEFAULT_HEIGHT=25;const DIRS={4:[[0,-1],[1,0],[0,1],[-1,0]],8:[[0,-1],[1,-1],[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1]],6:[[-1,-1],[1,-1],[2,0],[1,1],[-1,1],[-2,0]]};let Map$2=class{constructor(ci=DEFAULT_WIDTH,hi=DEFAULT_HEIGHT){this._width=ci,this._height=hi}_fillMap(ci){let hi=[];for(let _i=0;_i<this._width;_i++){hi.push([]);for(let pi=0;pi<this._height;pi++)hi[_i].push(ci)}return hi}};class Arena extends Map$2{create(ci){let hi=this._width-1,_i=this._height-1;for(let pi=0;pi<=hi;pi++)for(let mi=0;mi<=_i;mi++){let gi=pi&&mi&&pi<hi&&mi<_i;ci(pi,mi,gi?0:1)}return this}}class Dungeon extends Map$2{constructor(ci,hi){super(ci,hi),this._rooms=[],this._corridors=[]}getRooms(){return this._rooms}getCorridors(){return this._corridors}}class Feature{}class Room extends Feature{constructor(ci,hi,_i,pi,mi,gi){super(),this._x1=ci,this._y1=hi,this._x2=_i,this._y2=pi,this._doors={},mi!==void 0&&gi!==void 0&&this.addDoor(mi,gi)}static createRandomAt(ci,hi,_i,pi,mi){let gi=mi.roomWidth[0],vi=mi.roomWidth[1],xi=RNG$1.getUniformInt(gi,vi);gi=mi.roomHeight[0],vi=mi.roomHeight[1];let wi=RNG$1.getUniformInt(gi,vi);if(_i==1){let yi=hi-Math.floor(RNG$1.getUniform()*wi);return new this(ci+1,yi,ci+xi,yi+wi-1,ci,hi)}if(_i==-1){let yi=hi-Math.floor(RNG$1.getUniform()*wi);return new this(ci-xi,yi,ci-1,yi+wi-1,ci,hi)}if(pi==1){let yi=ci-Math.floor(RNG$1.getUniform()*xi);return new this(yi,hi+1,yi+xi-1,hi+wi,ci,hi)}if(pi==-1){let yi=ci-Math.floor(RNG$1.getUniform()*xi);return new this(yi,hi-wi,yi+xi-1,hi-1,ci,hi)}throw new Error("dx or dy must be 1 or -1")}static createRandomCenter(ci,hi,_i){let pi=_i.roomWidth[0],mi=_i.roomWidth[1],gi=RNG$1.getUniformInt(pi,mi);pi=_i.roomHeight[0],mi=_i.roomHeight[1];let vi=RNG$1.getUniformInt(pi,mi),xi=ci-Math.floor(RNG$1.getUniform()*gi),wi=hi-Math.floor(RNG$1.getUniform()*vi),yi=xi+gi-1,Ci=wi+vi-1;return new this(xi,wi,yi,Ci)}static createRandom(ci,hi,_i){let pi=_i.roomWidth[0],mi=_i.roomWidth[1],gi=RNG$1.getUniformInt(pi,mi);pi=_i.roomHeight[0],mi=_i.roomHeight[1];let vi=RNG$1.getUniformInt(pi,mi),xi=ci-gi-1,wi=hi-vi-1,yi=1+Math.floor(RNG$1.getUniform()*xi),Ci=1+Math.floor(RNG$1.getUniform()*wi),Ei=yi+gi-1,Si=Ci+vi-1;return new this(yi,Ci,Ei,Si)}addDoor(ci,hi){return this._doors[ci+","+hi]=1,this}getDoors(ci){for(let hi in this._doors){let _i=hi.split(",");ci(parseInt(_i[0]),parseInt(_i[1]))}return this}clearDoors(){return this._doors={},this}addDoors(ci){let hi=this._x1-1,_i=this._x2+1,pi=this._y1-1,mi=this._y2+1;for(let gi=hi;gi<=_i;gi++)for(let vi=pi;vi<=mi;vi++)gi!=hi&&gi!=_i&&vi!=pi&&vi!=mi||ci(gi,vi)||this.addDoor(gi,vi);return this}debug(){console.log("room",this._x1,this._y1,this._x2,this._y2)}isValid(ci,hi){let _i=this._x1-1,pi=this._x2+1,mi=this._y1-1,gi=this._y2+1;for(let vi=_i;vi<=pi;vi++)for(let xi=mi;xi<=gi;xi++)if(vi==_i||vi==pi||xi==mi||xi==gi){if(!ci(vi,xi))return!1}else if(!hi(vi,xi))return!1;return!0}create(ci){let hi=this._x1-1,_i=this._x2+1,pi=this._y1-1,mi=this._y2+1,gi=0;for(let vi=hi;vi<=_i;vi++)for(let xi=pi;xi<=mi;xi++)vi+","+xi in this._doors?gi=2:vi==hi||vi==_i||xi==pi||xi==mi?gi=1:gi=0,ci(vi,xi,gi)}getCenter(){return[Math.round((this._x1+this._x2)/2),Math.round((this._y1+this._y2)/2)]}getLeft(){return this._x1}getRight(){return this._x2}getTop(){return this._y1}getBottom(){return this._y2}}class Corridor extends Feature{constructor(ci,hi,_i,pi){super(),this._startX=ci,this._startY=hi,this._endX=_i,this._endY=pi,this._endsWithAWall=!0}static createRandomAt(ci,hi,_i,pi,mi){let gi=mi.corridorLength[0],vi=mi.corridorLength[1],xi=RNG$1.getUniformInt(gi,vi);return new this(ci,hi,ci+_i*xi,hi+pi*xi)}debug(){console.log("corridor",this._startX,this._startY,this._endX,this._endY)}isValid(ci,hi){let _i=this._startX,pi=this._startY,mi=this._endX-_i,gi=this._endY-pi,vi=1+Math.max(Math.abs(mi),Math.abs(gi));mi&&(mi=mi/Math.abs(mi)),gi&&(gi=gi/Math.abs(gi));let xi=gi,wi=-mi,yi=!0;for(let Si=0;Si<vi;Si++){let ki=_i+Si*mi,Ai=pi+Si*gi;if(hi(ki,Ai)||(yi=!1),ci(ki+xi,Ai+wi)||(yi=!1),ci(ki-xi,Ai-wi)||(yi=!1),!yi){vi=Si,this._endX=ki-mi,this._endY=Ai-gi;break}}if(vi==0||vi==1&&ci(this._endX+mi,this._endY+gi))return!1;let Ci=!ci(this._endX+mi+xi,this._endY+gi+wi),Ei=!ci(this._endX+mi-xi,this._endY+gi-wi);return this._endsWithAWall=ci(this._endX+mi,this._endY+gi),!((Ci||Ei)&&this._endsWithAWall)}create(ci){let hi=this._startX,_i=this._startY,pi=this._endX-hi,mi=this._endY-_i,gi=1+Math.max(Math.abs(pi),Math.abs(mi));pi&&(pi=pi/Math.abs(pi)),mi&&(mi=mi/Math.abs(mi));for(let vi=0;vi<gi;vi++){let xi=hi+vi*pi,wi=_i+vi*mi;ci(xi,wi,0)}return!0}createPriorityWalls(ci){if(!this._endsWithAWall)return;let hi=this._startX,_i=this._startY,pi=this._endX-hi,mi=this._endY-_i;pi&&(pi=pi/Math.abs(pi)),mi&&(mi=mi/Math.abs(mi));let gi=mi,vi=-pi;ci(this._endX+pi,this._endY+mi),ci(this._endX+gi,this._endY+vi),ci(this._endX-gi,this._endY-vi)}}class Uniform extends Dungeon{constructor(ci,hi,_i){super(ci,hi),this._options={roomWidth:[3,9],roomHeight:[3,5],roomDugPercentage:.1,timeLimit:1e3},Object.assign(this._options,_i),this._map=[],this._dug=0,this._roomAttempts=20,this._corridorAttempts=20,this._connected=[],this._unconnected=[],this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this)}create(ci){let hi=Date.now();for(;;){if(Date.now()-hi>this._options.timeLimit)return null;if(this._map=this._fillMap(1),this._dug=0,this._rooms=[],this._unconnected=[],this._generateRooms(),!(this._rooms.length<2)&&this._generateCorridors())break}if(ci)for(let _i=0;_i<this._width;_i++)for(let pi=0;pi<this._height;pi++)ci(_i,pi,this._map[_i][pi]);return this}_generateRooms(){let ci=this._width-2,hi=this._height-2,_i;do if(_i=this._generateRoom(),this._dug/(ci*hi)>this._options.roomDugPercentage)break;while(_i)}_generateRoom(){let ci=0;for(;ci<this._roomAttempts;){ci++;let hi=Room.createRandom(this._width,this._height,this._options);if(hi.isValid(this._isWallCallback,this._canBeDugCallback))return hi.create(this._digCallback),this._rooms.push(hi),hi}return null}_generateCorridors(){let ci=0;for(;ci<this._corridorAttempts;){ci++,this._corridors=[],this._map=this._fillMap(1);for(let hi=0;hi<this._rooms.length;hi++){let _i=this._rooms[hi];_i.clearDoors(),_i.create(this._digCallback)}for(this._unconnected=RNG$1.shuffle(this._rooms.slice()),this._connected=[],this._unconnected.length&&this._connected.push(this._unconnected.pop());;){let hi=RNG$1.getItem(this._connected);if(!hi)break;let _i=this._closestRoom(this._unconnected,hi);if(!_i)break;let pi=this._closestRoom(this._connected,_i);if(!pi||!this._connectRooms(_i,pi))break;if(!this._unconnected.length)return!0}}return!1}_closestRoom(ci,hi){let _i=1/0,pi=hi.getCenter(),mi=null;for(let gi=0;gi<ci.length;gi++){let vi=ci[gi],xi=vi.getCenter(),wi=xi[0]-pi[0],yi=xi[1]-pi[1],Ci=wi*wi+yi*yi;Ci<_i&&(_i=Ci,mi=vi)}return mi}_connectRooms(ci,hi){let _i=ci.getCenter(),pi=hi.getCenter(),mi=pi[0]-_i[0],gi=pi[1]-_i[1],vi,xi,wi,yi,Ci,Ei,Si;if(Math.abs(mi)<Math.abs(gi)?(wi=gi>0?2:0,yi=(wi+2)%4,Ci=hi.getLeft(),Ei=hi.getRight(),Si=0):(wi=mi>0?1:3,yi=(wi+2)%4,Ci=hi.getTop(),Ei=hi.getBottom(),Si=1),vi=this._placeInWall(ci,wi),!vi)return!1;if(vi[Si]>=Ci&&vi[Si]<=Ei){xi=vi.slice();let ki=0;switch(yi){case 0:ki=hi.getTop()-1;break;case 1:ki=hi.getRight()+1;break;case 2:ki=hi.getBottom()+1;break;case 3:ki=hi.getLeft()-1;break}xi[(Si+1)%2]=ki,this._digLine([vi,xi])}else if(vi[Si]<Ci-1||vi[Si]>Ei+1){let ki=vi[Si]-pi[Si],Ai=0;switch(yi){case 0:case 1:Ai=ki<0?3:1;break;case 2:case 3:Ai=ki<0?1:3;break}if(yi=(yi+Ai)%4,xi=this._placeInWall(hi,yi),!xi)return!1;let Ii=[0,0];Ii[Si]=vi[Si];let Ti=(Si+1)%2;Ii[Ti]=xi[Ti],this._digLine([vi,Ii,xi])}else{let ki=(Si+1)%2;if(xi=this._placeInWall(hi,yi),!xi)return!1;let Ai=Math.round((xi[ki]+vi[ki])/2),Ii=[0,0],Ti=[0,0];Ii[Si]=vi[Si],Ii[ki]=Ai,Ti[Si]=xi[Si],Ti[ki]=Ai,this._digLine([vi,Ii,Ti,xi])}return ci.addDoor(vi[0],vi[1]),hi.addDoor(xi[0],xi[1]),Si=this._unconnected.indexOf(ci),Si!=-1&&(this._unconnected.splice(Si,1),this._connected.push(ci)),Si=this._unconnected.indexOf(hi),Si!=-1&&(this._unconnected.splice(Si,1),this._connected.push(hi)),!0}_placeInWall(ci,hi){let _i=[0,0],pi=[0,0],mi=0;switch(hi){case 0:pi=[1,0],_i=[ci.getLeft(),ci.getTop()-1],mi=ci.getRight()-ci.getLeft()+1;break;case 1:pi=[0,1],_i=[ci.getRight()+1,ci.getTop()],mi=ci.getBottom()-ci.getTop()+1;break;case 2:pi=[1,0],_i=[ci.getLeft(),ci.getBottom()+1],mi=ci.getRight()-ci.getLeft()+1;break;case 3:pi=[0,1],_i=[ci.getLeft()-1,ci.getTop()],mi=ci.getBottom()-ci.getTop()+1;break}let gi=[],vi=-2;for(let xi=0;xi<mi;xi++){let wi=_i[0]+xi*pi[0],yi=_i[1]+xi*pi[1];gi.push(null),this._map[wi][yi]==1?vi!=xi-1&&(gi[xi]=[wi,yi]):(vi=xi,xi&&(gi[xi-1]=null))}for(let xi=gi.length-1;xi>=0;xi--)gi[xi]||gi.splice(xi,1);return gi.length?RNG$1.getItem(gi):null}_digLine(ci){for(let hi=1;hi<ci.length;hi++){let _i=ci[hi-1],pi=ci[hi],mi=new Corridor(_i[0],_i[1],pi[0],pi[1]);mi.create(this._digCallback),this._corridors.push(mi)}}_digCallback(ci,hi,_i){this._map[ci][hi]=_i,_i==0&&this._dug++}_isWallCallback(ci,hi){return ci<0||hi<0||ci>=this._width||hi>=this._height?!1:this._map[ci][hi]==1}_canBeDugCallback(ci,hi){return ci<1||hi<1||ci+1>=this._width||hi+1>=this._height?!1:this._map[ci][hi]==1}}class Cellular extends Map$2{constructor(ci,hi,_i={}){super(ci,hi),this._options={born:[5,6,7,8],survive:[4,5,6,7,8],topology:8},this.setOptions(_i),this._dirs=DIRS[this._options.topology],this._map=this._fillMap(0)}randomize(ci){for(let hi=0;hi<this._width;hi++)for(let _i=0;_i<this._height;_i++)this._map[hi][_i]=RNG$1.getUniform()<ci?1:0;return this}setOptions(ci){Object.assign(this._options,ci)}set(ci,hi,_i){this._map[ci][hi]=_i}create(ci){let hi=this._fillMap(0),_i=this._options.born,pi=this._options.survive;for(let mi=0;mi<this._height;mi++){let gi=1,vi=0;this._options.topology==6&&(gi=2,vi=mi%2);for(let xi=vi;xi<this._width;xi+=gi){let wi=this._map[xi][mi],yi=this._getNeighbors(xi,mi);(wi&&pi.indexOf(yi)!=-1||!wi&&_i.indexOf(yi)!=-1)&&(hi[xi][mi]=1)}}this._map=hi,ci&&this._serviceCallback(ci)}_serviceCallback(ci){for(let hi=0;hi<this._height;hi++){let _i=1,pi=0;this._options.topology==6&&(_i=2,pi=hi%2);for(let mi=pi;mi<this._width;mi+=_i)ci(mi,hi,this._map[mi][hi])}}_getNeighbors(ci,hi){let _i=0;for(let pi=0;pi<this._dirs.length;pi++){let mi=this._dirs[pi],gi=ci+mi[0],vi=hi+mi[1];gi<0||gi>=this._width||vi<0||vi>=this._height||(_i+=this._map[gi][vi]==1?1:0)}return _i}connect(ci,hi,_i){hi||(hi=0);let pi=[],mi={},gi=1,vi=[0,0];this._options.topology==6&&(gi=2,vi=[0,1]);for(let Ci=0;Ci<this._height;Ci++)for(let Ei=vi[Ci%2];Ei<this._width;Ei+=gi)if(this._freeSpace(Ei,Ci,hi)){let Si=[Ei,Ci];mi[this._pointKey(Si)]=Si,pi.push([Ei,Ci])}let xi=pi[RNG$1.getUniformInt(0,pi.length-1)],wi=this._pointKey(xi),yi={};for(yi[wi]=xi,delete mi[wi],this._findConnected(yi,mi,[xi],!1,hi);Object.keys(mi).length>0;){let Ci=this._getFromTo(yi,mi),Ei=Ci[0],Si=Ci[1],ki={};ki[this._pointKey(Ei)]=Ei,this._findConnected(ki,mi,[Ei],!0,hi),(this._options.topology==6?this._tunnelToConnected6:this._tunnelToConnected).call(this,Si,Ei,yi,mi,hi,_i);for(let Ii in ki){let Ti=ki[Ii];this._map[Ti[0]][Ti[1]]=hi,yi[Ii]=Ti,delete mi[Ii]}}ci&&this._serviceCallback(ci)}_getFromTo(ci,hi){let _i=[0,0],pi=[0,0],mi,gi=Object.keys(ci),vi=Object.keys(hi);for(let xi=0;xi<5;xi++){if(gi.length<vi.length){let wi=gi;pi=ci[wi[RNG$1.getUniformInt(0,wi.length-1)]],_i=this._getClosest(pi,hi)}else{let wi=vi;_i=hi[wi[RNG$1.getUniformInt(0,wi.length-1)]],pi=this._getClosest(_i,ci)}if(mi=(_i[0]-pi[0])*(_i[0]-pi[0])+(_i[1]-pi[1])*(_i[1]-pi[1]),mi<64)break}return[_i,pi]}_getClosest(ci,hi){let _i=null,pi=null;for(let mi in hi){let gi=hi[mi],vi=(gi[0]-ci[0])*(gi[0]-ci[0])+(gi[1]-ci[1])*(gi[1]-ci[1]);(pi==null||vi<pi)&&(pi=vi,_i=gi)}return _i}_findConnected(ci,hi,_i,pi,mi){for(;_i.length>0;){let gi=_i.splice(0,1)[0],vi;this._options.topology==6?vi=[[gi[0]+2,gi[1]],[gi[0]+1,gi[1]-1],[gi[0]-1,gi[1]-1],[gi[0]-2,gi[1]],[gi[0]-1,gi[1]+1],[gi[0]+1,gi[1]+1]]:vi=[[gi[0]+1,gi[1]],[gi[0]-1,gi[1]],[gi[0],gi[1]+1],[gi[0],gi[1]-1]];for(let xi=0;xi<vi.length;xi++){let wi=this._pointKey(vi[xi]);ci[wi]==null&&this._freeSpace(vi[xi][0],vi[xi][1],mi)&&(ci[wi]=vi[xi],pi||delete hi[wi],_i.push(vi[xi]))}}}_tunnelToConnected(ci,hi,_i,pi,mi,gi){let vi,xi;hi[0]<ci[0]?(vi=hi,xi=ci):(vi=ci,xi=hi);for(let yi=vi[0];yi<=xi[0];yi++){this._map[yi][vi[1]]=mi;let Ci=[yi,vi[1]],Ei=this._pointKey(Ci);_i[Ei]=Ci,delete pi[Ei]}gi&&vi[0]<xi[0]&&gi(vi,[xi[0],vi[1]]);let wi=xi[0];hi[1]<ci[1]?(vi=hi,xi=ci):(vi=ci,xi=hi);for(let yi=vi[1];yi<xi[1];yi++){this._map[wi][yi]=mi;let Ci=[wi,yi],Ei=this._pointKey(Ci);_i[Ei]=Ci,delete pi[Ei]}gi&&vi[1]<xi[1]&&gi([xi[0],vi[1]],[xi[0],xi[1]])}_tunnelToConnected6(ci,hi,_i,pi,mi,gi){let vi,xi;hi[0]<ci[0]?(vi=hi,xi=ci):(vi=ci,xi=hi);let wi=vi[0],yi=vi[1];for(;!(wi==xi[0]&&yi==xi[1]);){let Ci=2;yi<xi[1]?(yi++,Ci=1):yi>xi[1]&&(yi--,Ci=1),wi<xi[0]?wi+=Ci:wi>xi[0]||xi[1]%2?wi-=Ci:wi+=Ci,this._map[wi][yi]=mi;let Ei=[wi,yi],Si=this._pointKey(Ei);_i[Si]=Ei,delete pi[Si]}gi&&gi(hi,ci)}_freeSpace(ci,hi,_i){return ci>=0&&ci<this._width&&hi>=0&&hi<this._height&&this._map[ci][hi]==_i}_pointKey(ci){return ci[0]+"."+ci[1]}}const FEATURES={room:Room,corridor:Corridor};class Digger extends Dungeon{constructor(ci,hi,_i={}){super(ci,hi),this._options=Object.assign({roomWidth:[3,9],roomHeight:[3,5],corridorLength:[3,10],dugPercentage:.2,timeLimit:1e3},_i),this._features={room:4,corridor:4},this._map=[],this._featureAttempts=20,this._walls={},this._dug=0,this._digCallback=this._digCallback.bind(this),this._canBeDugCallback=this._canBeDugCallback.bind(this),this._isWallCallback=this._isWallCallback.bind(this),this._priorityWallCallback=this._priorityWallCallback.bind(this)}create(ci){this._rooms=[],this._corridors=[],this._map=this._fillMap(1),this._walls={},this._dug=0;let hi=(this._width-2)*(this._height-2);this._firstRoom();let _i=Date.now(),pi;do{if(pi=0,Date.now()-_i>this._options.timeLimit)break;let gi=this._findWall();if(!gi)break;let vi=gi.split(","),xi=parseInt(vi[0]),wi=parseInt(vi[1]),yi=this._getDiggingDirection(xi,wi);if(!yi)continue;let Ci=0;do if(Ci++,this._tryFeature(xi,wi,yi[0],yi[1])){this._removeSurroundingWalls(xi,wi),this._removeSurroundingWalls(xi-yi[0],wi-yi[1]);break}while(Ci<this._featureAttempts);for(let Ei in this._walls)this._walls[Ei]>1&&pi++}while(this._dug/hi<this._options.dugPercentage||pi);if(this._addDoors(),ci)for(let mi=0;mi<this._width;mi++)for(let gi=0;gi<this._height;gi++)ci(mi,gi,this._map[mi][gi]);return this._walls={},this._map=[],this}_digCallback(ci,hi,_i){_i==0||_i==2?(this._map[ci][hi]=0,this._dug++):this._walls[ci+","+hi]=1}_isWallCallback(ci,hi){return ci<0||hi<0||ci>=this._width||hi>=this._height?!1:this._map[ci][hi]==1}_canBeDugCallback(ci,hi){return ci<1||hi<1||ci+1>=this._width||hi+1>=this._height?!1:this._map[ci][hi]==1}_priorityWallCallback(ci,hi){this._walls[ci+","+hi]=2}_firstRoom(){let ci=Math.floor(this._width/2),hi=Math.floor(this._height/2),_i=Room.createRandomCenter(ci,hi,this._options);this._rooms.push(_i),_i.create(this._digCallback)}_findWall(){let ci=[],hi=[];for(let mi in this._walls)this._walls[mi]==2?hi.push(mi):ci.push(mi);let _i=hi.length?hi:ci;if(!_i.length)return null;let pi=RNG$1.getItem(_i.sort());return delete this._walls[pi],pi}_tryFeature(ci,hi,_i,pi){let mi=RNG$1.getWeightedValue(this._features),vi=FEATURES[mi].createRandomAt(ci,hi,_i,pi,this._options);return vi.isValid(this._isWallCallback,this._canBeDugCallback)?(vi.create(this._digCallback),vi instanceof Room&&this._rooms.push(vi),vi instanceof Corridor&&(vi.createPriorityWalls(this._priorityWallCallback),this._corridors.push(vi)),!0):!1}_removeSurroundingWalls(ci,hi){let _i=DIRS[4];for(let pi=0;pi<_i.length;pi++){let mi=_i[pi],gi=ci+mi[0],vi=hi+mi[1];delete this._walls[gi+","+vi],gi=ci+2*mi[0],vi=hi+2*mi[1],delete this._walls[gi+","+vi]}}_getDiggingDirection(ci,hi){if(ci<=0||hi<=0||ci>=this._width-1||hi>=this._height-1)return null;let _i=null,pi=DIRS[4];for(let mi=0;mi<pi.length;mi++){let gi=pi[mi],vi=ci+gi[0],xi=hi+gi[1];if(!this._map[vi][xi]){if(_i)return null;_i=gi}}return _i?[-_i[0],-_i[1]]:null}_addDoors(){let ci=this._map;function hi(_i,pi){return ci[_i][pi]==1}for(let _i=0;_i<this._rooms.length;_i++){let pi=this._rooms[_i];pi.clearDoors(),pi.addDoors(hi)}}}function addToList(fi,ci,hi){hi[ci[fi+1]]=hi[fi],ci[hi[fi]]=ci[fi+1],hi[fi]=fi+1,ci[fi+1]=fi}function removeFromList(fi,ci,hi){hi[ci[fi]]=hi[fi],ci[hi[fi]]=ci[fi],hi[fi]=fi,ci[fi]=fi}class EllerMaze extends Map$2{create(ci){let hi=this._fillMap(1),_i=Math.ceil((this._width-2)/2),pi=9/24,mi=[],gi=[];for(let xi=0;xi<_i;xi++)mi.push(xi),gi.push(xi);mi.push(_i-1);let vi;for(vi=1;vi+3<this._height;vi+=2)for(let xi=0;xi<_i;xi++){let wi=2*xi+1,yi=vi;hi[wi][yi]=0,xi!=mi[xi+1]&&RNG$1.getUniform()>pi&&(addToList(xi,mi,gi),hi[wi+1][yi]=0),xi!=mi[xi]&&RNG$1.getUniform()>pi?removeFromList(xi,mi,gi):hi[wi][yi+1]=0}for(let xi=0;xi<_i;xi++){let wi=2*xi+1,yi=vi;hi[wi][yi]=0,xi!=mi[xi+1]&&(xi==mi[xi]||RNG$1.getUniform()>pi)&&(addToList(xi,mi,gi),hi[wi+1][yi]=0),removeFromList(xi,mi,gi)}for(let xi=0;xi<this._width;xi++)for(let wi=0;wi<this._height;wi++)ci(xi,wi,hi[xi][wi]);return this}}class DividedMaze extends Map$2{constructor(){super(...arguments),this._stack=[],this._map=[]}create(ci){let hi=this._width,_i=this._height;this._map=[];for(let pi=0;pi<hi;pi++){this._map.push([]);for(let mi=0;mi<_i;mi++){let gi=pi==0||mi==0||pi+1==hi||mi+1==_i;this._map[pi].push(gi?1:0)}}this._stack=[[1,1,hi-2,_i-2]],this._process();for(let pi=0;pi<hi;pi++)for(let mi=0;mi<_i;mi++)ci(pi,mi,this._map[pi][mi]);return this._map=[],this}_process(){for(;this._stack.length;){let ci=this._stack.shift();this._partitionRoom(ci)}}_partitionRoom(ci){let hi=[],_i=[];for(let wi=ci[0]+1;wi<ci[2];wi++){let yi=this._map[wi][ci[1]-1],Ci=this._map[wi][ci[3]+1];yi&&Ci&&!(wi%2)&&hi.push(wi)}for(let wi=ci[1]+1;wi<ci[3];wi++){let yi=this._map[ci[0]-1][wi],Ci=this._map[ci[2]+1][wi];yi&&Ci&&!(wi%2)&&_i.push(wi)}if(!hi.length||!_i.length)return;let pi=RNG$1.getItem(hi),mi=RNG$1.getItem(_i);this._map[pi][mi]=1;let gi=[],vi=[];gi.push(vi);for(let wi=ci[0];wi<pi;wi++)this._map[wi][mi]=1,wi%2&&vi.push([wi,mi]);vi=[],gi.push(vi);for(let wi=pi+1;wi<=ci[2];wi++)this._map[wi][mi]=1,wi%2&&vi.push([wi,mi]);vi=[],gi.push(vi);for(let wi=ci[1];wi<mi;wi++)this._map[pi][wi]=1,wi%2&&vi.push([pi,wi]);vi=[],gi.push(vi);for(let wi=mi+1;wi<=ci[3];wi++)this._map[pi][wi]=1,wi%2&&vi.push([pi,wi]);let xi=RNG$1.getItem(gi);for(let wi=0;wi<gi.length;wi++){let yi=gi[wi];if(yi==xi)continue;let Ci=RNG$1.getItem(yi);this._map[Ci[0]][Ci[1]]=0}this._stack.push([ci[0],ci[1],pi-1,mi-1]),this._stack.push([pi+1,ci[1],ci[2],mi-1]),this._stack.push([ci[0],mi+1,pi-1,ci[3]]),this._stack.push([pi+1,mi+1,ci[2],ci[3]])}}class IceyMaze extends Map$2{constructor(ci,hi,_i=0){super(ci,hi),this._regularity=_i,this._map=[]}create(ci){let hi=this._width,_i=this._height,pi=this._fillMap(1);hi-=hi%2?1:2,_i-=_i%2?1:2;let mi=0,gi=0,vi=0,xi=0,wi=0,yi=!1,Ci=[[0,0],[0,0],[0,0],[0,0]];do if(mi=1+2*Math.floor(RNG$1.getUniform()*(hi-1)/2),gi=1+2*Math.floor(RNG$1.getUniform()*(_i-1)/2),wi||(pi[mi][gi]=0),!pi[mi][gi]){this._randomize(Ci);do{Math.floor(RNG$1.getUniform()*(this._regularity+1))==0&&this._randomize(Ci),yi=!0;for(let Ei=0;Ei<4;Ei++)if(vi=mi+Ci[Ei][0]*2,xi=gi+Ci[Ei][1]*2,this._isFree(pi,vi,xi,hi,_i)){pi[vi][xi]=0,pi[mi+Ci[Ei][0]][gi+Ci[Ei][1]]=0,mi=vi,gi=xi,yi=!1,wi++;break}}while(!yi)}while(wi+1<hi*_i/4);for(let Ei=0;Ei<this._width;Ei++)for(let Si=0;Si<this._height;Si++)ci(Ei,Si,pi[Ei][Si]);return this._map=[],this}_randomize(ci){for(let hi=0;hi<4;hi++)ci[hi][0]=0,ci[hi][1]=0;switch(Math.floor(RNG$1.getUniform()*4)){case 0:ci[0][0]=-1,ci[1][0]=1,ci[2][1]=-1,ci[3][1]=1;break;case 1:ci[3][0]=-1,ci[2][0]=1,ci[1][1]=-1,ci[0][1]=1;break;case 2:ci[2][0]=-1,ci[3][0]=1,ci[0][1]=-1,ci[1][1]=1;break;case 3:ci[1][0]=-1,ci[0][0]=1,ci[3][1]=-1,ci[2][1]=1;break}}_isFree(ci,hi,_i,pi,mi){return hi<1||_i<1||hi>=pi||_i>=mi?!1:ci[hi][_i]}}class Rogue extends Map$2{constructor(ci,hi,_i){super(ci,hi),this.map=[],this.rooms=[],this.connectedCells=[],_i=Object.assign({cellWidth:3,cellHeight:3},_i),_i.hasOwnProperty("roomWidth")||(_i.roomWidth=this._calculateRoomSize(this._width,_i.cellWidth)),_i.hasOwnProperty("roomHeight")||(_i.roomHeight=this._calculateRoomSize(this._height,_i.cellHeight)),this._options=_i}create(ci){if(this.map=this._fillMap(1),this.rooms=[],this.connectedCells=[],this._initRooms(),this._connectRooms(),this._connectUnconnectedRooms(),this._createRandomRoomConnections(),this._createRooms(),this._createCorridors(),ci)for(let hi=0;hi<this._width;hi++)for(let _i=0;_i<this._height;_i++)ci(hi,_i,this.map[hi][_i]);return this}_calculateRoomSize(ci,hi){let _i=Math.floor(ci/hi*.8),pi=Math.floor(ci/hi*.25);return pi<2&&(pi=2),_i<2&&(_i=2),[pi,_i]}_initRooms(){for(let ci=0;ci<this._options.cellWidth;ci++){this.rooms.push([]);for(let hi=0;hi<this._options.cellHeight;hi++)this.rooms[ci].push({x:0,y:0,width:0,height:0,connections:[],cellx:ci,celly:hi})}}_connectRooms(){let ci=RNG$1.getUniformInt(0,this._options.cellWidth-1),hi=RNG$1.getUniformInt(0,this._options.cellHeight-1),_i,pi,mi,gi=!1,vi,xi,wi;do{wi=[0,2,4,6],wi=RNG$1.shuffle(wi);do if(gi=!1,_i=wi.pop(),pi=ci+DIRS[8][_i][0],mi=hi+DIRS[8][_i][1],!(pi<0||pi>=this._options.cellWidth)&&!(mi<0||mi>=this._options.cellHeight)){if(vi=this.rooms[ci][hi],vi.connections.length>0&&vi.connections[0][0]==pi&&vi.connections[0][1]==mi)break;xi=this.rooms[pi][mi],xi.connections.length==0&&(xi.connections.push([ci,hi]),this.connectedCells.push([pi,mi]),ci=pi,hi=mi,gi=!0)}while(wi.length>0&&gi==!1)}while(wi.length>0)}_connectUnconnectedRooms(){let ci=this._options.cellWidth,hi=this._options.cellHeight;this.connectedCells=RNG$1.shuffle(this.connectedCells);let _i,pi,mi;for(let gi=0;gi<this._options.cellWidth;gi++)for(let vi=0;vi<this._options.cellHeight;vi++)if(_i=this.rooms[gi][vi],_i.connections.length==0){let xi=[0,2,4,6];xi=RNG$1.shuffle(xi),mi=!1;do{let wi=xi.pop(),yi=gi+DIRS[8][wi][0],Ci=vi+DIRS[8][wi][1];if(!(yi<0||yi>=ci||Ci<0||Ci>=hi)){if(pi=this.rooms[yi][Ci],mi=!0,pi.connections.length==0)break;for(let Ei=0;Ei<pi.connections.length;Ei++)if(pi.connections[Ei][0]==gi&&pi.connections[Ei][1]==vi){mi=!1;break}if(mi)break}}while(xi.length);mi?_i.connections.push([pi.cellx,pi.celly]):console.log("-- Unable to connect room.")}}_createRandomRoomConnections(){}_createRooms(){let ci=this._width,hi=this._height,_i=this._options.cellWidth,pi=this._options.cellHeight,mi=Math.floor(this._width/_i),gi=Math.floor(this._height/pi),vi,xi,wi=this._options.roomWidth,yi=this._options.roomHeight,Ci,Ei,Si;for(let ki=0;ki<_i;ki++)for(let Ai=0;Ai<pi;Ai++){if(Ci=mi*ki,Ei=gi*Ai,Ci==0&&(Ci=1),Ei==0&&(Ei=1),vi=RNG$1.getUniformInt(wi[0],wi[1]),xi=RNG$1.getUniformInt(yi[0],yi[1]),Ai>0)for(Si=this.rooms[ki][Ai-1];Ei-(Si.y+Si.height)<3;)Ei++;if(ki>0)for(Si=this.rooms[ki-1][Ai];Ci-(Si.x+Si.width)<3;)Ci++;let Ii=Math.round(RNG$1.getUniformInt(0,mi-vi)/2),Ti=Math.round(RNG$1.getUniformInt(0,gi-xi)/2);for(;Ci+Ii+vi>=ci;)Ii?Ii--:vi--;for(;Ei+Ti+xi>=hi;)Ti?Ti--:xi--;Ci=Ci+Ii,Ei=Ei+Ti,this.rooms[ki][Ai].x=Ci,this.rooms[ki][Ai].y=Ei,this.rooms[ki][Ai].width=vi,this.rooms[ki][Ai].height=xi;for(let Pi=Ci;Pi<Ci+vi;Pi++)for(let Li=Ei;Li<Ei+xi;Li++)this.map[Pi][Li]=0}}_getWallPosition(ci,hi){let _i,pi,mi;return hi==1||hi==3?(_i=RNG$1.getUniformInt(ci.x+1,ci.x+ci.width-2),hi==1?(pi=ci.y-2,mi=pi+1):(pi=ci.y+ci.height+1,mi=pi-1),this.map[_i][mi]=0):(pi=RNG$1.getUniformInt(ci.y+1,ci.y+ci.height-2),hi==2?(_i=ci.x+ci.width+1,mi=_i-1):(_i=ci.x-2,mi=_i+1),this.map[mi][pi]=0),[_i,pi]}_drawCorridor(ci,hi){let _i=hi[0]-ci[0],pi=hi[1]-ci[1],mi=ci[0],gi=ci[1],vi,xi,wi,yi,Ci=[],Ei=Math.abs(_i),Si=Math.abs(pi),ki=RNG$1.getUniform(),Ai=ki,Ii=1-ki;for(xi=_i>0?2:6,wi=pi>0?4:0,Ei<Si?(vi=Math.ceil(Si*Ai),Ci.push([wi,vi]),Ci.push([xi,Ei]),vi=Math.floor(Si*Ii),Ci.push([wi,vi])):(vi=Math.ceil(Ei*Ai),Ci.push([xi,vi]),Ci.push([wi,Si]),vi=Math.floor(Ei*Ii),Ci.push([xi,vi])),this.map[mi][gi]=0;Ci.length>0;)for(yi=Ci.pop();yi[1]>0;)mi+=DIRS[8][yi[0]][0],gi+=DIRS[8][yi[0]][1],this.map[mi][gi]=0,yi[1]=yi[1]-1}_createCorridors(){let ci=this._options.cellWidth,hi=this._options.cellHeight,_i,pi,mi,gi,vi;for(let xi=0;xi<ci;xi++)for(let wi=0;wi<hi;wi++){_i=this.rooms[xi][wi];for(let yi=0;yi<_i.connections.length;yi++)pi=_i.connections[yi],mi=this.rooms[pi[0]][pi[1]],mi.cellx>_i.cellx?(gi=2,vi=4):mi.cellx<_i.cellx?(gi=4,vi=2):mi.celly>_i.celly?(gi=3,vi=1):(gi=1,vi=3),this._drawCorridor(this._getWallPosition(_i,gi),this._getWallPosition(mi,vi))}}}const Map$1={Arena,Uniform,Cellular,Digger,EllerMaze,DividedMaze,IceyMaze,Rogue},vsl0_map="/roke/assets/vsm0-2-YyyfH2.ldtk";function generateAutoLayerTiles(fi,ci,hi,_i,pi,mi){const gi=[];function vi(xi,wi){return xi<0||xi>=hi||wi<0||wi>=_i?1:fi[wi*hi+xi]}for(let xi=0;xi<_i;xi++)for(let wi=0;wi<hi;wi++)for(const yi of ci)if(yi.active)for(const Ci of yi.rules){if(!Ci.active)continue;let Ei=!0;for(let Si=0;Si<Ci.size;Si++){for(let ki=0;ki<Ci.size;ki++){const Ai=Ci.pattern[Si*Ci.size+ki],Ii=vi(wi+(ki-Math.floor(Ci.size/2)),xi+Si-Math.floor(Ci.size/2));if(Ai==-1&&Ii==1||Ai==1&&Ii==0){Ei=!1;break}}if(!Ei)break}if(Ei){const Si=Ci.tileRectsIds[0],ki=wi*pi,Ai=xi*pi;gi.push({px:[ki,Ai],src:[mi.sprites[Si].sourceView.x,mi.sprites[Si].sourceView.y],f:0,t:Si,d:[wi,xi],a:1});break}}return gi}async function calcAutoLayer(fi,ci,hi,_i,pi){const vi=(await(await fetch(vsl0_map)).json()).defs.layers[0].autoRuleGroups;return generateAutoLayerTiles(fi,vi,ci,hi,_i,pi)}class AutoMap extends bi{constructor(ci,hi){super(ci,hi)}async retile(ci=0){const hi=this.getIntGridLayers()[0].tilemap,_i=this.getIntGridLayers()[0].tileset;window.tileset=_i;const pi=hi.columns,mi=hi.rows;RNG$1.setSeed(ci);const gi=new Map$1.Uniform(pi,mi),vi=[];function xi(Ci,Ei,Si){hi.tiles[Ci+Ei*pi].solid=Si,vi[Ci+Ei*pi]=Si?1:0}gi.create(xi);const wi=this.getIntGridLayers()[0].ldtkLayer;this.openSides(gi,xi);const yi=await calcAutoLayer(vi,hi.columns,hi.rows,hi.tileWidth,_i.spritesheet);if(hi.tiles.forEach(Ci=>{Ci.clearGraphics()}),wi.__tilesetDefUid){const Ci=this.tilesets.get(wi.__tilesetDefUid);for(let Ei=0;Ei<yi.length;Ei++){const Si=yi[Ei],ki=Math.floor(Si.px[0]/wi.__gridSize),Ai=Math.floor(Si.px[1]/wi.__gridSize),Ii=hi.getTile(ki,Ai);if(Ii&&Ci){const Ti=Math.floor((Si.src[0]-(Ci.ldtkTileset.padding??0))/(Ci.ldtkTileset.tileGridSize+(Ci.ldtkTileset.spacing??0))),Pi=Math.floor((Si.src[1]-(Ci.ldtkTileset.padding??0))/(Ci.ldtkTileset.tileGridSize+(Ci.ldtkTileset.spacing??0))),Li=!!(Si.f&1),Ri=!!(Si.f&2);let Di=Ci.spritesheet.getSprite(Ti,Pi);(Li||Ri)&&(Di=Di.clone(),Di.flipHorizontal=Li,Di.flipVertical=Ri),Di?Ii.addGraphic(Di):console.error("Could not find sprite in LDtk spritesheet at",Ti,Pi)}}}return gi}openSides(ci,hi){const _i=ci.getRooms();_i.sort((gi,vi)=>gi.getLeft()<vi.getLeft()?-1:1);const pi=_i[0],mi=_i[_i.length-1];for(let gi=pi.getLeft();gi>=0;gi--)hi(gi,pi.getBottom(),0);for(let gi=mi.getRight();gi<ci._width;gi++)hi(gi,mi.getBottom(),0)}}const idleMan0="/roke/assets/obj_Idle000-i9pCXwgB.png",idleMan1="/roke/assets/obj_Idle001-BRPWzyy5.png",idleMan2="/roke/assets/obj_Idle002-Ctd3xmyQ.png",idleMan3="/roke/assets/obj_Idle003-Bgcq_I2t.png",walkMan0="/roke/assets/obj_Walk000-CsY9yx1v.png",walkMan1="/roke/assets/obj_Walk001-DxlVFu8s.png",walkMan2="/roke/assets/obj_Walk002-DZrJYcyT.png",walkMan3="/roke/assets/obj_Walk003-C0ulW498.png",walkMan4="/roke/assets/obj_Walk004-BY9D8wIO.png",walkMan5="/roke/assets/obj_Walk005-CbI1zowy.png",walkMan6="/roke/assets/obj_Walk006-GQW229K6.png",walkMan7="/roke/assets/obj_Walk007-ALBjbHaj.png",runMan0="/roke/assets/obj_Run000-DgiSq-9B.png",runMan1="/roke/assets/obj_Run001-9jJOcIuM.png",runMan2="/roke/assets/obj_Run002-PIw5APUp.png",runMan3="/roke/assets/obj_Run003-DzI5jIj0.png",runMan4="/roke/assets/obj_Run004-D4NS3tiI.png",runMan5="/roke/assets/obj_Run005-eRZAf4eN.png",runMan6="/roke/assets/obj_Run006-BFLwEGbS.png",runMan7="/roke/assets/obj_Run007-D5C_OUBF.png",flyMan0="/roke/assets/obj_Flying000-C0v0O6eR.png",flyMan1="/roke/assets/obj_Flying001-DaKuWiBU.png",coin="/roke/assets/coins-CySCqBf3.png",caverna="/roke/assets/Cavernas_by_Adam_Saltsman-CDCGIlrX.png",scifitm="/roke/assets/scifi_platformTiles_32x32-Bkxv9-UB.png",vsl0_level="/roke/assets/Level_0-DL4SAEqz.ldtkl",cityBackFull="/roke/assets/10-CAUTu1f7.png",dsml1=new AutoMap(vsl0_map,{pathMap:[{path:"vsm0/Level_0.ldtk",output:vsl0_level},{path:"Cavernas_by_Adam_Saltsman.png",output:caverna},{path:"scifi_platformTiles_32x32.png",output:scifitm}]}),resources=[idleMan0,idleMan1,idleMan2,idleMan3,walkMan0,walkMan1,walkMan2,walkMan3,walkMan4,walkMan5,walkMan6,walkMan7,runMan0,runMan1,runMan2,runMan3,runMan4,runMan5,runMan6,runMan7,flyMan0,flyMan1,caverna,cityBackFull,scifitm,coin].map(fi=>new __webpack_exports__ImageSource(fi));function resourceByPath(fi){return resources.find(ci=>ci.path===fi)}const click=100,idleMan=new __webpack_exports__Animation({frames:[idleMan0,idleMan1,idleMan2,idleMan3,idleMan2,idleMan1].map(fi=>({graphic:resourceByPath(fi).toSprite(),duration:click}))}),walkMan=new __webpack_exports__Animation({frames:[walkMan0,walkMan1,walkMan2,walkMan3,walkMan4,walkMan5,walkMan6,walkMan7].map(fi=>({graphic:resourceByPath(fi).toSprite(),duration:click}))}),runMan=new __webpack_exports__Animation({frames:[runMan0,runMan1,runMan2,runMan3,runMan4,runMan5,runMan6,runMan7].map(fi=>({graphic:resourceByPath(fi).toSprite(),duration:click}))}),flyMan=new __webpack_exports__Animation({frames:[flyMan0,flyMan1].map(fi=>({graphic:resourceByPath(fi).toSprite(),duration:click}))}),coinSheet=__webpack_exports__SpriteSheet.fromImageSource({image:resourceByPath(coin),grid:{rows:1,columns:8,spriteWidth:16,spriteHeight:16}});__webpack_exports__Animation.fromSpriteSheet(coinSheet,__webpack_exports__range(0,7),200);resourceByPath(cityBackFull).toSprite();const isSafari=/^((?!chrome|android).)*safari/i.test(navigator.userAgent);function addPermission(){typeof DeviceMotionEvent<"u"&&typeof DeviceMotionEvent.requestPermission=="function"&&(alert("Acepta los permisos para usar el sensor."),DeviceMotionEvent.requestPermission().then(fi=>{console.log("Permission status:",fi)}).catch(console.error))}const levels=[{level:"Level 0",name:"The Lobby",class:"1",class_details:"Safe, Secure, Minimal Entity Count",bases:null,entrances:["The Frontrooms","Level 283"],entities:["Bacteria"],exits:["Level 1","Level 27","Level -12","Level -0","The Basement"]},{level:"Level 0.1",name:"Zenith Station",class:"0",class_details:"Safe, Secure, Devoid of Entities",bases:[null],entities:[null],entrances:["Level 0"],exits:["Level 0","Level 1"]},{level:"Level 0.2",name:"Remodeled Mess",class:"3",class_details:"Unsafe, Secure, Low Entity Count",bases:[null],entities:[null],entrances:["Level 0"],exits:["Level 0"]},{level:"Level 0.3",name:"The Icy Rooms",class:"1",class_details:"Safe, Secure, Minimal Entity Count",bases:[null],entities:[null],entrances:["Level 0"],exits:["Level 0"]},{level:"Level 1",name:"Habitable Zone",class:1,class_details:"Safe, Secure, Minimal Entity Count",bases:["M.E.G.","B.N.T.G.","Tom's Diner"],entities:["Smilers","Skin-Stealers","Hounds","Dullers","Facelings"],entrances:["Level 0","Level 11.1","Level 92","Level 94"],exits:["Level 2","Level 19","Level Fun"]},{level:"Level 1.1",name:"Corrupted Corridor",class:"Variable",class_varible:["0","2","4","Deadzone","N/A"],class_details:"Varied Safety, Unsecured, Varied Entity Count",class_details_variable:["Safe, Secure, Devoid of Enetities","Unsafe, Secure, Low Entity Count","Unsafe, Unsecure, Medium Entity Count","Environmental Hazards, Strictly Uninhabitable, Potential for Anomalous Entities","Existence Unconfirmed, Likely Inaccessible, Unfit for Life"],bases:["M.E.G.","The Tunnel Gang","Outpost 1","Outpost 2","Outpost 3","Jakob's Hut","Outpost 4"],entities:["Smilers","Hounds","Skin-Stealers"],entrances:["level 1"],exits:["Level 1"]},{level:"Level 1.3",name:"Malignance",class:"0",class_details:"Safe, Secure, Devoid of Entities",bases:["The Ward"],entities:[null],entrances:[null],exits:[null]},{level:"Level 2",name:null,class:"Sigma",class_details:"Unreliable Files, Non-Euclidean Space, Unidentified Entities",bases:[null],entities:["The eternal nature of numbers"],entrances:["Level 81"],exits:["Level 1"]},{level:"Level 2",name:"Pipe Dreams",class:"3",class_details:"Unsafe, Unsecure, Low Entity Count",bases:["Followers of Jerry","M.E.G.","B.N.T.G."],entities:["Windows","Smilers","Deathmoths","Clumps","Jerry","Hounds","Facelings","Skin-Stealers","Wretches","Nguithr'xurhs","Deathrats","Cannibal Cuisines","Wranglers","Photoshop","Growlers","Swindlebirds"],entrances:["The Frontrooms","Level 1","Level 55","Level 287","Level 2.2","Level 8","Level 11","Level 43","Level 84","Level 127","Level 141","Level 158","Level 173","Level 309","Level 480","Level 522","Level 997"],exits:["Level 3","Level 4","Level 31","Level 127","Level 137","Level 70","Level 283","Level 101","Level 126","Level 141","Level 175","Level 997","Level 811","Level 998","The Hub","Level 606","Level 38","Level 64","Level 127","Level 158","Level 902","Level 189"]},{level:"Level 2.2",name:"Constant Buzz",class:"4",class_details:"Unsafe, Unsecure, Medium Entity Count",bases:[""],entities:["Phantom Bees","Smilers","Howlers","Lighters","Deathrats"],entrances:["Level 3"],exits:["Level 2","Level 3","Level 98"]},{level:" ",name:"Office Space EL3A",class:"1",class_details:"Safe, Secure, Minimal Entity Count",bases:["B.N.T.G."],entities:["Smilers","Hounds","Skin-Stealers","Photoshop"],entrances:["Level 2"],exits:["Level 2"]},{level:"Level 3",name:"Electrical Station",class:"4",class_details:"Unsafe, Unsecure, Medium Entity Count",bases:["M.E.G.","B.N.T.G.","Followers of Jerry","The Masked Maidens","U.E.C."],entities:["Hounds","Facelings","Wretches","Deathmoths","Skin-Stealers","Dullers","Smilers","Clumps","Bursters","Crawler Fungus"],entrances:["Level 2","Level 4","Level 5","Level 10","Level 11","Level 13","The Metro"],exits:["Level 4","Level 5","Level 31","Level 69"]},{level:"Level 4",name:"Abandoned Office",class:"1",class_details:"Safe, Secure, Minimal Entity Count",bases:["M.E.G.","Amor Incrementum","T.B.D"],entities:["Hounds","Dullers"],entrances:["Level 3","The Hub","Level 2","Level 283"],exits:["Level 5","Level 6","Level 3","Level 71"]},{level:"Level 5",name:"Terror Hotel",class:"2",class_details:"Unsafe, Secure, Low Entity Count",bases:["M.E.G.","Homely Hotel","The Originals","The Lost Hall Society"],entities:["Deathmoths","Hounds","Woodlins","Skin-Stealers","Watchers","Nguithr'xurhs","Growlers","Deathrats","Wranglers","Samantha","Ants"],entrances:["Level 4","Level 3","Level 19","Level 126","Level 54","Level 10","Level 82","Level 92","Level 4.2"],exits:["Level 6","Level 3","Level 4","Level 9","Level 63","Level 98","Level 427","Level 40","Level 78","Level 84","Level 171"]},{level:"Level 6",name:"Lights Out",class:"Pending",class_details:"Safety Undetermined, Unsecured, Presence of Enetities Undetermined",bases:["The World's Quietest Room","Mimicry"],entities:[null],entrances:["Level 5","Level 4"],exits:["Level 7","Level 129","Level 6.1"]},{level:"Level 7",name:"Talassophobia",class:"4",class_details:"Unsafe, Unsecure, Medium Entity Count",bases:["Fort Surrender"],entities:["Tiny","The Thing On Level 7"],entrances:["Level 6","Level 8"],exits:["Level 8","Level 83","Level 9","Level 880"]},{level:"Level 8",name:"Cave System",class:"5",class_details:"Unsafe, Unsecure, Entity Infestation",bases:["M.E.G.","The Town of Kavragost"],entities:["Smilers","Skin-Stealers","Wretches","Camo Crawlers","Transporters","Deathmoths","Facelings","Hens","Hounds","Deathrats","Paralies","Clumps","Reviooks","Wranglers","Crawlers","Wranglers","Windows","Stalkers"],entrances:["Level 7","Level 103","Level 64","Level 135","Level 52","Level 283"],exits:["Level 9","Level 75","Level 2","Level 7","Level 91","Level 93","Level 205","Level 104","Level 69"]},{level:"",name:"",class:"",class_details:"",bases:[""],entities:[""],entrances:[""],exits:[""]}],VERSION="0.9.1";let auto=!1,kind,fetch$1,FormData$1,File$1,ReadableStream$1,getMultipartRequestOptions,getDefaultAgent,fileFromPath,isFsReadStream;function setShims(fi,ci={auto:!1}){if(auto)throw new Error(`you must \`import 'groq-sdk/shims/${fi.kind}'\` before importing anything else from groq-sdk`);if(kind)throw new Error(`can't \`import 'groq-sdk/shims/${fi.kind}'\` after \`import 'groq-sdk/shims/${kind}'\``);auto=ci.auto,kind=fi.kind,fetch$1=fi.fetch,FormData$1=fi.FormData,File$1=fi.File,ReadableStream$1=fi.ReadableStream,getMultipartRequestOptions=fi.getMultipartRequestOptions,getDefaultAgent=fi.getDefaultAgent,fileFromPath=fi.fileFromPath,isFsReadStream=fi.isFsReadStream}class MultipartBody{constructor(ci){this.body=ci}get[Symbol.toStringTag](){return"MultipartBody"}}function getRuntime({manuallyImported:fi}={}){const ci=fi?"You may need to use polyfills":"Add one of these imports before your first `import  from 'groq-sdk'`:\n- `import 'groq-sdk/shims/node'` (if you're running on Node)\n- `import 'groq-sdk/shims/web'` (otherwise)\n";let hi,_i,pi,mi;try{hi=fetch,_i=Request,pi=Response,mi=Headers}catch(gi){throw new Error(`this environment is missing the following Web Fetch API type: ${gi.message}. ${ci}`)}return{kind:"web",fetch:hi,Request:_i,Response:pi,Headers:mi,FormData:typeof FormData<"u"?FormData:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'FormData' is undefined. ${ci}`)}},Blob:typeof Blob<"u"?Blob:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'Blob' is undefined. ${ci}`)}},File:typeof File<"u"?File:class{constructor(){throw new Error(`file uploads aren't supported in this environment yet as 'File' is undefined. ${ci}`)}},ReadableStream:typeof ReadableStream<"u"?ReadableStream:class{constructor(){throw new Error(`streaming isn't supported in this environment yet as 'ReadableStream' is undefined. ${ci}`)}},getMultipartRequestOptions:async(gi,vi)=>({...vi,body:new MultipartBody(gi)}),getDefaultAgent:gi=>{},fileFromPath:()=>{throw new Error("The `fileFromPath` function is only supported in Node. See the README for more details: https://www.github.com/groq/groq-typescript#file-uploads")},isFsReadStream:gi=>!1}}kind||setShims(getRuntime(),{auto:!0});class GroqError extends Error{}class APIError extends GroqError{constructor(ci,hi,_i,pi){super(`${APIError.makeMessage(ci,hi,_i)}`),this.status=ci,this.headers=pi,this.error=hi}static makeMessage(ci,hi,_i){const pi=hi!=null&&hi.message?typeof hi.message=="string"?hi.message:JSON.stringify(hi.message):hi?JSON.stringify(hi):_i;return ci&&pi?`${ci} ${pi}`:ci?`${ci} status code (no body)`:pi||"(no status code or body)"}static generate(ci,hi,_i,pi){if(!ci||!pi)return new APIConnectionError({message:_i,cause:castToError(hi)});const mi=hi;return ci===400?new BadRequestError(ci,mi,_i,pi):ci===401?new AuthenticationError(ci,mi,_i,pi):ci===403?new PermissionDeniedError(ci,mi,_i,pi):ci===404?new NotFoundError(ci,mi,_i,pi):ci===409?new ConflictError(ci,mi,_i,pi):ci===422?new UnprocessableEntityError(ci,mi,_i,pi):ci===429?new RateLimitError(ci,mi,_i,pi):ci>=500?new InternalServerError(ci,mi,_i,pi):new APIError(ci,mi,_i,pi)}}class APIUserAbortError extends APIError{constructor({message:ci}={}){super(void 0,void 0,ci||"Request was aborted.",void 0)}}class APIConnectionError extends APIError{constructor({message:ci,cause:hi}){super(void 0,void 0,ci||"Connection error.",void 0),hi&&(this.cause=hi)}}class APIConnectionTimeoutError extends APIConnectionError{constructor({message:ci}={}){super({message:ci??"Request timed out."})}}class BadRequestError extends APIError{}class AuthenticationError extends APIError{}class PermissionDeniedError extends APIError{}class NotFoundError extends APIError{}class ConflictError extends APIError{}class UnprocessableEntityError extends APIError{}class RateLimitError extends APIError{}class InternalServerError extends APIError{}class Stream{constructor(ci,hi){this.iterator=ci,this.controller=hi}static fromSSEResponse(ci,hi){let _i=!1;const pi=new SSEDecoder;async function*mi(){if(!ci.body)throw hi.abort(),new GroqError("Attempted to iterate over a response with no body");const vi=new LineDecoder,xi=readableStreamAsyncIterable(ci.body);for await(const wi of xi)for(const yi of vi.decode(wi)){const Ci=pi.decode(yi);Ci&&(yield Ci)}for(const wi of vi.flush()){const yi=pi.decode(wi);yi&&(yield yi)}}async function*gi(){if(_i)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");_i=!0;let vi=!1;try{for await(const xi of mi())if(!vi){if(xi.data.startsWith("[DONE]")){vi=!0;continue}if(xi.event===null||xi.event==="error"){let wi;try{wi=JSON.parse(xi.data)}catch(yi){throw console.error("Could not parse message into JSON:",xi.data),console.error("From chunk:",xi.raw),yi}if(wi&&wi.error)throw new APIError(wi.error.status_code,wi.error,wi.error.message,void 0);yield wi}}vi=!0}catch(xi){if(xi instanceof Error&&xi.name==="AbortError")return;throw xi}finally{vi||hi.abort()}}return new Stream(gi,hi)}static fromReadableStream(ci,hi){let _i=!1;async function*pi(){const gi=new LineDecoder,vi=readableStreamAsyncIterable(ci);for await(const xi of vi)for(const wi of gi.decode(xi))yield wi;for(const xi of gi.flush())yield xi}async function*mi(){if(_i)throw new Error("Cannot iterate over a consumed stream, use `.tee()` to split the stream.");_i=!0;let gi=!1;try{for await(const vi of pi())gi||vi&&(yield JSON.parse(vi));gi=!0}catch(vi){if(vi instanceof Error&&vi.name==="AbortError")return;throw vi}finally{gi||hi.abort()}}return new Stream(mi,hi)}[Symbol.asyncIterator](){return this.iterator()}tee(){const ci=[],hi=[],_i=this.iterator(),pi=mi=>({next:()=>{if(mi.length===0){const gi=_i.next();ci.push(gi),hi.push(gi)}return mi.shift()}});return[new Stream(()=>pi(ci),this.controller),new Stream(()=>pi(hi),this.controller)]}toReadableStream(){const ci=this;let hi;const _i=new TextEncoder;return new ReadableStream$1({async start(){hi=ci[Symbol.asyncIterator]()},async pull(pi){try{const{value:mi,done:gi}=await hi.next();if(gi)return pi.close();const vi=_i.encode(JSON.stringify(mi)+`
`);pi.enqueue(vi)}catch(mi){pi.error(mi)}},async cancel(){var pi;await((pi=hi.return)==null?void 0:pi.call(hi))}})}}class SSEDecoder{constructor(){this.event=null,this.data=[],this.chunks=[]}decode(ci){if(ci.endsWith("\r")&&(ci=ci.substring(0,ci.length-1)),!ci){if(!this.event&&!this.data.length)return null;const mi={event:this.event,data:this.data.join(`
`),raw:this.chunks};return this.event=null,this.data=[],this.chunks=[],mi}if(this.chunks.push(ci),ci.startsWith(":"))return null;let[hi,_i,pi]=partition(ci,":");return pi.startsWith(" ")&&(pi=pi.substring(1)),hi==="event"?this.event=pi:hi==="data"&&this.data.push(pi),null}}class LineDecoder{constructor(){this.buffer=[],this.trailingCR=!1}decode(ci){let hi=this.decodeText(ci);if(this.trailingCR&&(hi="\r"+hi,this.trailingCR=!1),hi.endsWith("\r")&&(this.trailingCR=!0,hi=hi.slice(0,-1)),!hi)return[];const _i=LineDecoder.NEWLINE_CHARS.has(hi[hi.length-1]||"");let pi=hi.split(LineDecoder.NEWLINE_REGEXP);return pi.length===1&&!_i?(this.buffer.push(pi[0]),[]):(this.buffer.length>0&&(pi=[this.buffer.join("")+pi[0],...pi.slice(1)],this.buffer=[]),_i||(this.buffer=[pi.pop()||""]),pi)}decodeText(ci){if(ci==null)return"";if(typeof ci=="string")return ci;if(typeof Buffer<"u"){if(ci instanceof Buffer)return ci.toString();if(ci instanceof Uint8Array)return Buffer.from(ci).toString();throw new GroqError(`Unexpected: received non-Uint8Array (${ci.constructor.name}) stream chunk in an environment with a global "Buffer" defined, which this library assumes to be Node. Please report this error.`)}if(typeof TextDecoder<"u"){if(ci instanceof Uint8Array||ci instanceof ArrayBuffer)return this.textDecoder??(this.textDecoder=new TextDecoder("utf8")),this.textDecoder.decode(ci);throw new GroqError(`Unexpected: received non-Uint8Array/ArrayBuffer (${ci.constructor.name}) in a web platform. Please report this error.`)}throw new GroqError("Unexpected: neither Buffer nor TextDecoder are available as globals. Please report this error.")}flush(){if(!this.buffer.length&&!this.trailingCR)return[];const ci=[this.buffer.join("")];return this.buffer=[],this.trailingCR=!1,ci}}LineDecoder.NEWLINE_CHARS=new Set([`
`,"\r","\v","\f","","","","","\u2028","\u2029"]);LineDecoder.NEWLINE_REGEXP=/\r\n|[\n\r\x0b\x0c\x1c\x1d\x1e\x85\u2028\u2029]/g;function partition(fi,ci){const hi=fi.indexOf(ci);return hi!==-1?[fi.substring(0,hi),ci,fi.substring(hi+ci.length)]:[fi,"",""]}function readableStreamAsyncIterable(fi){if(fi[Symbol.asyncIterator])return fi;const ci=fi.getReader();return{async next(){try{const hi=await ci.read();return hi!=null&&hi.done&&ci.releaseLock(),hi}catch(hi){throw ci.releaseLock(),hi}},async return(){const hi=ci.cancel();return ci.releaseLock(),await hi,{done:!0,value:void 0}},[Symbol.asyncIterator](){return this}}}const isResponseLike=fi=>fi!=null&&typeof fi=="object"&&typeof fi.url=="string"&&typeof fi.blob=="function",isFileLike=fi=>fi!=null&&typeof fi=="object"&&typeof fi.name=="string"&&typeof fi.lastModified=="number"&&isBlobLike(fi),isBlobLike=fi=>fi!=null&&typeof fi=="object"&&typeof fi.size=="number"&&typeof fi.type=="string"&&typeof fi.text=="function"&&typeof fi.slice=="function"&&typeof fi.arrayBuffer=="function",isUploadable=fi=>isFileLike(fi)||isResponseLike(fi)||isFsReadStream(fi);async function toFile(fi,ci,hi){var pi;if(fi=await fi,isFileLike(fi))return fi;if(isResponseLike(fi)){const mi=await fi.blob();ci||(ci=new URL(fi.url).pathname.split(/[\\/]/).pop()??"unknown_file");const gi=isBlobLike(mi)?[await mi.arrayBuffer()]:[mi];return new File$1(gi,ci,hi)}const _i=await getBytes(fi);if(ci||(ci=getName(fi)??"unknown_file"),!(hi!=null&&hi.type)){const mi=(pi=_i[0])==null?void 0:pi.type;typeof mi=="string"&&(hi={...hi,type:mi})}return new File$1(_i,ci,hi)}async function getBytes(fi){var hi;let ci=[];if(typeof fi=="string"||ArrayBuffer.isView(fi)||fi instanceof ArrayBuffer)ci.push(fi);else if(isBlobLike(fi))ci.push(await fi.arrayBuffer());else if(isAsyncIterableIterator(fi))for await(const _i of fi)ci.push(_i);else throw new Error(`Unexpected data type: ${typeof fi}; constructor: ${(hi=fi==null?void 0:fi.constructor)==null?void 0:hi.name}; props: ${propsForError(fi)}`);return ci}function propsForError(fi){return`[${Object.getOwnPropertyNames(fi).map(hi=>`"${hi}"`).join(", ")}]`}function getName(fi){var ci;return getStringFromMaybeBuffer(fi.name)||getStringFromMaybeBuffer(fi.filename)||((ci=getStringFromMaybeBuffer(fi.path))==null?void 0:ci.split(/[\\/]/).pop())}const getStringFromMaybeBuffer=fi=>{if(typeof fi=="string")return fi;if(typeof Buffer<"u"&&fi instanceof Buffer)return String(fi)},isAsyncIterableIterator=fi=>fi!=null&&typeof fi=="object"&&typeof fi[Symbol.asyncIterator]=="function",isMultipartBody=fi=>fi&&typeof fi=="object"&&fi.body&&fi[Symbol.toStringTag]==="MultipartBody",multipartFormRequestOptions=async fi=>{const ci=await createForm(fi.body);return getMultipartRequestOptions(ci,fi)},createForm=async fi=>{const ci=new FormData$1;return await Promise.all(Object.entries(fi||{}).map(([hi,_i])=>addFormValue(ci,hi,_i))),ci},addFormValue=async(fi,ci,hi)=>{if(hi!==void 0){if(hi==null)throw new TypeError(`Received null for "${ci}"; to pass null in FormData, you must use the string 'null'`);if(typeof hi=="string"||typeof hi=="number"||typeof hi=="boolean")fi.append(ci,String(hi));else if(isUploadable(hi)){const _i=await toFile(hi);fi.append(ci,_i)}else if(Array.isArray(hi))await Promise.all(hi.map(_i=>addFormValue(fi,ci+"[]",_i)));else if(typeof hi=="object")await Promise.all(Object.entries(hi).map(([_i,pi])=>addFormValue(fi,`${ci}[${_i}]`,pi)));else throw new TypeError(`Invalid value given to form, expected a string, number, boolean, object, Array, File or Blob but got ${hi} instead`)}};var define_process_env_default={};async function defaultParseResponse(fi){const{response:ci}=fi;if(fi.options.stream)return debug("response",ci.status,ci.url,ci.headers,ci.body),fi.options.__streamClass?fi.options.__streamClass.fromSSEResponse(ci,fi.controller):Stream.fromSSEResponse(ci,fi.controller);if(ci.status===204)return null;if(fi.options.__binaryResponse)return ci;const hi=ci.headers.get("content-type");if((hi==null?void 0:hi.includes("application/json"))||(hi==null?void 0:hi.includes("application/vnd.api+json"))){const mi=await ci.json();return debug("response",ci.status,ci.url,ci.headers,mi),mi}const pi=await ci.text();return debug("response",ci.status,ci.url,ci.headers,pi),pi}class APIPromise extends Promise{constructor(ci,hi=defaultParseResponse){super(_i=>{_i(null)}),this.responsePromise=ci,this.parseResponse=hi}_thenUnwrap(ci){return new APIPromise(this.responsePromise,async hi=>ci(await this.parseResponse(hi),hi))}asResponse(){return this.responsePromise.then(ci=>ci.response)}async withResponse(){const[ci,hi]=await Promise.all([this.parse(),this.asResponse()]);return{data:ci,response:hi}}parse(){return this.parsedPromise||(this.parsedPromise=this.responsePromise.then(this.parseResponse)),this.parsedPromise}then(ci,hi){return this.parse().then(ci,hi)}catch(ci){return this.parse().catch(ci)}finally(ci){return this.parse().finally(ci)}}class APIClient{constructor({baseURL:ci,maxRetries:hi=2,timeout:_i=6e4,httpAgent:pi,fetch:mi}){this.baseURL=ci,this.maxRetries=validatePositiveInteger("maxRetries",hi),this.timeout=validatePositiveInteger("timeout",_i),this.httpAgent=pi,this.fetch=mi??fetch$1}authHeaders(ci){return{}}defaultHeaders(ci){return{Accept:"application/json","Content-Type":"application/json","User-Agent":this.getUserAgent(),...getPlatformHeaders(),...this.authHeaders(ci)}}validateHeaders(ci,hi){}defaultIdempotencyKey(){return`stainless-node-retry-${uuid4()}`}get(ci,hi){return this.methodRequest("get",ci,hi)}post(ci,hi){return this.methodRequest("post",ci,hi)}patch(ci,hi){return this.methodRequest("patch",ci,hi)}put(ci,hi){return this.methodRequest("put",ci,hi)}delete(ci,hi){return this.methodRequest("delete",ci,hi)}methodRequest(ci,hi,_i){return this.request(Promise.resolve(_i).then(async pi=>{const mi=pi&&isBlobLike(pi==null?void 0:pi.body)?new DataView(await pi.body.arrayBuffer()):(pi==null?void 0:pi.body)instanceof DataView?pi.body:(pi==null?void 0:pi.body)instanceof ArrayBuffer?new DataView(pi.body):pi&&ArrayBuffer.isView(pi==null?void 0:pi.body)?new DataView(pi.body.buffer):pi==null?void 0:pi.body;return{method:ci,path:hi,...pi,body:mi}}))}getAPIList(ci,hi,_i){return this.requestAPIList(hi,{method:"get",path:ci,..._i})}calculateContentLength(ci){if(typeof ci=="string"){if(typeof Buffer<"u")return Buffer.byteLength(ci,"utf8").toString();if(typeof TextEncoder<"u")return new TextEncoder().encode(ci).length.toString()}else if(ArrayBuffer.isView(ci))return ci.byteLength.toString();return null}buildRequest(ci,{retryCount:hi=0}={}){var Ai;const{method:_i,path:pi,query:mi,headers:gi={}}=ci,vi=ArrayBuffer.isView(ci.body)||ci.__binaryRequest&&typeof ci.body=="string"?ci.body:isMultipartBody(ci.body)?ci.body.body:ci.body?JSON.stringify(ci.body,null,2):null,xi=this.calculateContentLength(vi),wi=this.buildURL(pi,mi);"timeout"in ci&&validatePositiveInteger("timeout",ci.timeout);const yi=ci.timeout??this.timeout,Ci=ci.httpAgent??this.httpAgent??getDefaultAgent(wi),Ei=yi+1e3;typeof((Ai=Ci==null?void 0:Ci.options)==null?void 0:Ai.timeout)=="number"&&Ei>(Ci.options.timeout??0)&&(Ci.options.timeout=Ei),this.idempotencyHeader&&_i!=="get"&&(ci.idempotencyKey||(ci.idempotencyKey=this.defaultIdempotencyKey()),gi[this.idempotencyHeader]=ci.idempotencyKey);const Si=this.buildHeaders({options:ci,headers:gi,contentLength:xi,retryCount:hi});return{req:{method:_i,...vi&&{body:vi},headers:Si,...Ci&&{agent:Ci},signal:ci.signal??null},url:wi,timeout:yi}}buildHeaders({options:ci,headers:hi,contentLength:_i,retryCount:pi}){const mi={};_i&&(mi["content-length"]=_i);const gi=this.defaultHeaders(ci);return applyHeadersMut(mi,gi),applyHeadersMut(mi,hi),isMultipartBody(ci.body)&&kind!=="node"&&delete mi["content-type"],getHeader(gi,"x-stainless-retry-count")===void 0&&getHeader(hi,"x-stainless-retry-count")===void 0&&(mi["x-stainless-retry-count"]=String(pi)),this.validateHeaders(mi,hi),mi}async prepareOptions(ci){}async prepareRequest(ci,{url:hi,options:_i}){}parseHeaders(ci){return ci?Symbol.iterator in ci?Object.fromEntries(Array.from(ci).map(hi=>[...hi])):{...ci}:{}}makeStatusError(ci,hi,_i,pi){return APIError.generate(ci,hi,_i,pi)}request(ci,hi=null){return new APIPromise(this.makeRequest(ci,hi))}async makeRequest(ci,hi){var Ci,Ei;const _i=await ci,pi=_i.maxRetries??this.maxRetries;hi==null&&(hi=pi),await this.prepareOptions(_i);const{req:mi,url:gi,timeout:vi}=this.buildRequest(_i,{retryCount:pi-hi});if(await this.prepareRequest(mi,{url:gi,options:_i}),debug("request",gi,_i,mi.headers),(Ci=_i.signal)!=null&&Ci.aborted)throw new APIUserAbortError;const xi=new AbortController,wi=await this.fetchWithTimeout(gi,mi,vi,xi).catch(castToError);if(wi instanceof Error){if((Ei=_i.signal)!=null&&Ei.aborted)throw new APIUserAbortError;if(hi)return this.retryRequest(_i,hi);throw wi.name==="AbortError"?new APIConnectionTimeoutError:new APIConnectionError({cause:wi})}const yi=createResponseHeaders(wi.headers);if(!wi.ok){if(hi&&this.shouldRetry(wi)){const Pi=`retrying, ${hi} attempts remaining`;return debug(`response (error; ${Pi})`,wi.status,gi,yi),this.retryRequest(_i,hi,yi)}const Si=await wi.text().catch(Pi=>castToError(Pi).message),ki=safeJSON(Si),Ai=ki?void 0:Si;throw debug(`response (error; ${hi?"(error; no more retries left)":"(error; not retryable)"})`,wi.status,gi,yi,Ai),this.makeStatusError(wi.status,ki,Ai,yi)}return{response:wi,options:_i,controller:xi}}requestAPIList(ci,hi){const _i=this.makeRequest(hi,null);return new PagePromise(this,_i,ci)}buildURL(ci,hi){const _i=isAbsoluteURL(ci)?new URL(ci):new URL(this.baseURL+(this.baseURL.endsWith("/")&&ci.startsWith("/")?ci.slice(1):ci)),pi=this.defaultQuery();return isEmptyObj(pi)||(hi={...pi,...hi}),typeof hi=="object"&&hi&&!Array.isArray(hi)&&(_i.search=this.stringifyQuery(hi)),_i.toString()}stringifyQuery(ci){return Object.entries(ci).filter(([hi,_i])=>typeof _i<"u").map(([hi,_i])=>{if(typeof _i=="string"||typeof _i=="number"||typeof _i=="boolean")return`${encodeURIComponent(hi)}=${encodeURIComponent(_i)}`;if(_i===null)return`${encodeURIComponent(hi)}=`;throw new GroqError(`Cannot stringify type ${typeof _i}; Expected string, number, boolean, or null. If you need to pass nested query parameters, you can manually encode them, e.g. { query: { 'foo[key1]': value1, 'foo[key2]': value2 } }, and please open a GitHub issue requesting better support for your use case.`)}).join("&")}async fetchWithTimeout(ci,hi,_i,pi){const{signal:mi,...gi}=hi||{};mi&&mi.addEventListener("abort",()=>pi.abort());const vi=setTimeout(()=>pi.abort(),_i);return this.fetch.call(void 0,ci,{signal:pi.signal,...gi}).finally(()=>{clearTimeout(vi)})}shouldRetry(ci){const hi=ci.headers.get("x-should-retry");return hi==="true"?!0:hi==="false"?!1:ci.status===408||ci.status===409||ci.status===429||ci.status>=500}async retryRequest(ci,hi,_i){let pi;const mi=_i==null?void 0:_i["retry-after-ms"];if(mi){const vi=parseFloat(mi);Number.isNaN(vi)||(pi=vi)}const gi=_i==null?void 0:_i["retry-after"];if(gi&&!pi){const vi=parseFloat(gi);Number.isNaN(vi)?pi=Date.parse(gi)-Date.now():pi=vi*1e3}if(!(pi&&0<=pi&&pi<60*1e3)){const vi=ci.maxRetries??this.maxRetries;pi=this.calculateDefaultRetryTimeoutMillis(hi,vi)}return await sleep(pi),this.makeRequest(ci,hi-1)}calculateDefaultRetryTimeoutMillis(ci,hi){const mi=hi-ci,gi=Math.min(.5*Math.pow(2,mi),8),vi=1-Math.random()*.25;return gi*vi*1e3}getUserAgent(){return`${this.constructor.name}/JS ${VERSION}`}}class PagePromise extends APIPromise{constructor(ci,hi,_i){super(hi,async pi=>new _i(ci,pi.response,await defaultParseResponse(pi),pi.options))}async*[Symbol.asyncIterator](){const ci=await this;for await(const hi of ci)yield hi}}const createResponseHeaders=fi=>new Proxy(Object.fromEntries(fi.entries()),{get(ci,hi){const _i=hi.toString();return ci[_i.toLowerCase()]||ci[_i]}}),getPlatformProperties=()=>{var ci;if(typeof Deno<"u"&&Deno.build!=null)return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":normalizePlatform(Deno.build.os),"X-Stainless-Arch":normalizeArch(Deno.build.arch),"X-Stainless-Runtime":"deno","X-Stainless-Runtime-Version":typeof Deno.version=="string"?Deno.version:((ci=Deno.version)==null?void 0:ci.deno)??"unknown"};if(typeof EdgeRuntime<"u")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":"Unknown","X-Stainless-Arch":`other:${EdgeRuntime}`,"X-Stainless-Runtime":"edge","X-Stainless-Runtime-Version":process.version};if(Object.prototype.toString.call(typeof process<"u"?process:0)==="[object process]")return{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":normalizePlatform(process.platform),"X-Stainless-Arch":normalizeArch(process.arch),"X-Stainless-Runtime":"node","X-Stainless-Runtime-Version":process.version};const fi=getBrowserInfo();return fi?{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":`browser:${fi.browser}`,"X-Stainless-Runtime-Version":fi.version}:{"X-Stainless-Lang":"js","X-Stainless-Package-Version":VERSION,"X-Stainless-OS":"Unknown","X-Stainless-Arch":"unknown","X-Stainless-Runtime":"unknown","X-Stainless-Runtime-Version":"unknown"}};function getBrowserInfo(){if(typeof navigator>"u"||!navigator)return null;const fi=[{key:"edge",pattern:/Edge(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/MSIE(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"ie",pattern:/Trident(?:.*rv\:(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"chrome",pattern:/Chrome(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"firefox",pattern:/Firefox(?:\W+(\d+)\.(\d+)(?:\.(\d+))?)?/},{key:"safari",pattern:/(?:Version\W+(\d+)\.(\d+)(?:\.(\d+))?)?(?:\W+Mobile\S*)?\W+Safari/}];for(const{key:ci,pattern:hi}of fi){const _i=hi.exec(navigator.userAgent);if(_i){const pi=_i[1]||0,mi=_i[2]||0,gi=_i[3]||0;return{browser:ci,version:`${pi}.${mi}.${gi}`}}}return null}const normalizeArch=fi=>fi==="x32"?"x32":fi==="x86_64"||fi==="x64"?"x64":fi==="arm"?"arm":fi==="aarch64"||fi==="arm64"?"arm64":fi?`other:${fi}`:"unknown",normalizePlatform=fi=>(fi=fi.toLowerCase(),fi.includes("ios")?"iOS":fi==="android"?"Android":fi==="darwin"?"MacOS":fi==="win32"?"Windows":fi==="freebsd"?"FreeBSD":fi==="openbsd"?"OpenBSD":fi==="linux"?"Linux":fi?`Other:${fi}`:"Unknown");let _platformHeaders;const getPlatformHeaders=()=>_platformHeaders??(_platformHeaders=getPlatformProperties()),safeJSON=fi=>{try{return JSON.parse(fi)}catch{return}},startsWithSchemeRegexp=/^[a-z][a-z0-9+.-]*:/i,isAbsoluteURL=fi=>startsWithSchemeRegexp.test(fi),sleep=fi=>new Promise(ci=>setTimeout(ci,fi)),validatePositiveInteger=(fi,ci)=>{if(typeof ci!="number"||!Number.isInteger(ci))throw new GroqError(`${fi} must be an integer`);if(ci<0)throw new GroqError(`${fi} must be a positive integer`);return ci},castToError=fi=>{if(fi instanceof Error)return fi;if(typeof fi=="object"&&fi!==null)try{return new Error(JSON.stringify(fi))}catch{}return new Error(fi)},readEnv=fi=>{var ci,hi,_i,pi;if(typeof process<"u")return((ci=define_process_env_default==null?void 0:define_process_env_default[fi])==null?void 0:ci.trim())??void 0;if(typeof Deno<"u")return(pi=(_i=(hi=Deno.env)==null?void 0:hi.get)==null?void 0:_i.call(hi,fi))==null?void 0:pi.trim()};function isEmptyObj(fi){if(!fi)return!0;for(const ci in fi)return!1;return!0}function hasOwn(fi,ci){return Object.prototype.hasOwnProperty.call(fi,ci)}function applyHeadersMut(fi,ci){for(const hi in ci){if(!hasOwn(ci,hi))continue;const _i=hi.toLowerCase();if(!_i)continue;const pi=ci[hi];pi===null?delete fi[_i]:pi!==void 0&&(fi[_i]=pi)}}function debug(fi,...ci){typeof process<"u"&&(define_process_env_default==null?void 0:define_process_env_default.DEBUG)==="true"&&console.log(`Groq:DEBUG:${fi}`,...ci)}const uuid4=()=>"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,fi=>{const ci=Math.random()*16|0;return(fi==="x"?ci:ci&3|8).toString(16)}),isRunningInBrowser=()=>typeof window<"u"&&typeof window.document<"u"&&typeof navigator<"u",isHeadersProtocol=fi=>typeof(fi==null?void 0:fi.get)=="function",getHeader=(fi,ci)=>{var _i;const hi=ci.toLowerCase();if(isHeadersProtocol(fi)){const pi=((_i=ci[0])==null?void 0:_i.toUpperCase())+ci.substring(1).replace(/([^\w])(\w)/g,(mi,gi,vi)=>gi+vi.toUpperCase());for(const mi of[ci,hi,ci.toUpperCase(),pi]){const gi=fi.get(mi);if(gi)return gi}}for(const[pi,mi]of Object.entries(fi))if(pi.toLowerCase()===hi)return Array.isArray(mi)?(mi.length<=1||console.warn(`Received ${mi.length} entries for the ${ci} header, using the first entry.`),mi[0]):mi};class APIResource{constructor(ci){this._client=ci}}class Transcriptions extends APIResource{create(ci,hi){return this._client.post("/openai/v1/audio/transcriptions",multipartFormRequestOptions({body:ci,...hi}))}}class Translations extends APIResource{create(ci,hi){return this._client.post("/openai/v1/audio/translations",multipartFormRequestOptions({body:ci,...hi}))}}let Audio$1=class extends APIResource{constructor(){super(...arguments),this.transcriptions=new Transcriptions(this._client),this.translations=new Translations(this._client)}};Audio$1.Transcriptions=Transcriptions;Audio$1.Translations=Translations;let Completions$1=class extends APIResource{create(ci,hi){return this._client.post("/openai/v1/chat/completions",{body:ci,...hi,stream:ci.stream??!1})}};class Chat extends APIResource{constructor(){super(...arguments),this.completions=new Completions$1(this._client)}}Chat.Completions=Completions$1;class Completions extends APIResource{}class Embeddings extends APIResource{create(ci,hi){return this._client.post("/openai/v1/embeddings",{body:ci,...hi})}}class Models extends APIResource{retrieve(ci,hi){return this._client.get(`/openai/v1/models/${ci}`,hi)}list(ci){return this._client.get("/openai/v1/models",ci)}delete(ci,hi){return this._client.delete(`/openai/v1/models/${ci}`,hi)}}var _a;class Groq extends APIClient{constructor({baseURL:ci=readEnv("GROQ_BASE_URL"),apiKey:hi=readEnv("GROQ_API_KEY"),..._i}={}){if(hi===void 0)throw new GroqError("The GROQ_API_KEY environment variable is missing or empty; either provide it, or instantiate the Groq client with an apiKey option, like new Groq({ apiKey: 'My API Key' }).");const pi={apiKey:hi,..._i,baseURL:ci||"https://api.groq.com"};if(!pi.dangerouslyAllowBrowser&&isRunningInBrowser())throw new GroqError(`It looks like you're running in a browser-like environment.

This is disabled by default, as it risks exposing your secret API credentials to attackers.
If you understand the risks and have appropriate mitigations in place,
you can set the \`dangerouslyAllowBrowser\` option to \`true\`, e.g.,

new Groq({ apiKey, dangerouslyAllowBrowser: true })`);super({baseURL:pi.baseURL,timeout:pi.timeout??6e4,httpAgent:pi.httpAgent,maxRetries:pi.maxRetries,fetch:pi.fetch}),this.completions=new Completions(this),this.chat=new Chat(this),this.embeddings=new Embeddings(this),this.audio=new Audio$1(this),this.models=new Models(this),this._options=pi,this.apiKey=hi}defaultQuery(){return this._options.defaultQuery}defaultHeaders(ci){return{...super.defaultHeaders(ci),...this._options.defaultHeaders}}authHeaders(ci){return{Authorization:`Bearer ${this.apiKey}`}}}_a=Groq;Groq.Groq=_a;Groq.DEFAULT_TIMEOUT=6e4;Groq.GroqError=GroqError;Groq.APIError=APIError;Groq.APIConnectionError=APIConnectionError;Groq.APIConnectionTimeoutError=APIConnectionTimeoutError;Groq.APIUserAbortError=APIUserAbortError;Groq.NotFoundError=NotFoundError;Groq.ConflictError=ConflictError;Groq.RateLimitError=RateLimitError;Groq.BadRequestError=BadRequestError;Groq.AuthenticationError=AuthenticationError;Groq.InternalServerError=InternalServerError;Groq.PermissionDeniedError=PermissionDeniedError;Groq.UnprocessableEntityError=UnprocessableEntityError;Groq.toFile=toFile;Groq.fileFromPath=fileFromPath;Groq.Completions=Completions;Groq.Chat=Chat;Groq.Embeddings=Embeddings;Groq.Audio=Audio$1;Groq.Models=Models;const model="llama-3.3-70b-versatile";let groq;function initGroq(fi){groq=new Groq({apiKey:fi,dangerouslyAllowBrowser:!0})}console.log(window.location.hash);localStorage.getItem("groqApiKey")?initGroq(localStorage.getItem("groqApiKey")):window.location.hash.startsWith("#gsk_")&&window.location.hash.length==57&&initGroq(window.location.hash.slice(1));const messages=[];function groqBanner(){window.term.writeObject({msg:`No es posible activar las funciones generativas.
Para jugar R.O.K.E. con todas sus caractersticas necesitas una API KEY.
Por favor, obtenga una API KEY.`,"dnde?":"Puedes pedirle una a Sebastian (autor de R.O.K.E.) o crear la tuya propia en Groq.com.",listo:"Bien, ahora escribe abajo la API KEY sin nada ms."},"msg")}async function converse(fi,ci){if(!groq){groqBanner();return}window.term.loading(!0);let hi;try{hi=await groq.chat.completions.create({messages:[{role:"system",content:`Eres el guionista y dramaturgo de un videojuego llamado R.O.K.E. - 
          que consiste en explorar un espacio infinito del lore del Internet 
          llamado "Backrooms". 
          
          Tu respuesta debe ser un objeto json que contenga al menos:
           "response", "advice" y "demotivationalQuote".

           El input del usuario vendr en el campo "content" y el estatus del
           usuario en el campo "status" del objeto json que recibiris.
          `},...messages,{role:"user",content:JSON.stringify({content:fi,status:ci.status})}],response_format:{type:"json_object"},model,temperature:1.4,max_tokens:3e3,top_p:1,stream:!1,stop:null})}catch(pi){console.error(pi)}finally{window.term.loading(!1)}const _i=JSON.parse(hi.choices[0].message.content);return messages.push(hi.choices[0].message),_i}async function getRoomDescription(fi,ci){if(!groq){groqBanner();return}window.term.loading(!0);let hi;try{hi=await groq.chat.completions.create({messages:[{role:"system",content:`Eres el guionista y dramaturgo de un videojuego llamado R.O.K.E. - 
          que consiste en explorar un espacio infinito del lore del Internet 
          llamado "Backrooms". En cada cambio de pantalla el front-end del 
          juego te enviar un json describiendo el nivel y opcionalmente el 
          estatus del jugador. Tu tarea es retornar una prosa del nivel y/o 
          la situacin, muy breve y levemente sarcstica. No alucines.
          
          Piensa bien tu respuesta, que sea narrativa y no mucho ms.
          Usa oraciones completas y gramtica correcta en todos los campos.
          
          El jugador acaba de entrar a: ${ci.status.location.level} - ${ci.status.location.room}.
          Haz una referencia a la habitacin.

          Tu respuesta debe ser un objeto que contenga al menos:
           "shortDescription", "longDescription" y "easterEgg".
           
           Recuerda ser breve.
           `},{role:"user",content:JSON.stringify({room:fi,player_status:ci.status})}],response_format:{type:"json_object"},model:"llama-3.3-70b-versatile",temperature:1.6,max_tokens:3e3,top_p:1,stream:!1,stop:null})}catch(pi){console.error(pi)}finally{window.term.loading(!1)}const _i=JSON.parse(hi.choices[0].message.content);return messages.push(hi.choices[0].message),window.term.writeObject(_i,"shortDescription"),hi}function simpleChecksum(fi){let ci=0;for(let hi=0;hi<fi.length;hi++)ci+=fi.charCodeAt(hi);return ci%256}function getRoom(fi){const ci=levels.find(_i=>_i.level==fi.status.location.level),hi=fi.status.location.room;return getRoomDescription(ci,fi),window.visual.flash(u$2(k$3,{children:[u$2("h2",{children:['"',ci.name,'"']}),u$2("h3",{children:["Sector ",hi]})]})),{...ci,checksum:simpleChecksum(ci.level+"#"+hi)}}function getOrSet(fi,ci){return localStorage.getItem(fi)===null&&localStorage.setItem(fi,ci),localStorage.getItem(fi)}class Player extends __webpack_exports__Actor{constructor(hi,_i){super({name:getOrSet("name","Roke"),pos:__webpack_exports__vec(hi,_i),width:36,height:72,anchor:__webpack_exports__vec(.5,.95),scale:__webpack_exports__vec(.4,.4),collisionType:__webpack_exports__CollisionType.Active});hs(this,"status",{firstGame:getOrSet("firstGame",Date.now()),location:{level:getOrSet("level","Level 0"),room:parseInt(getOrSet("room",0))}});hs(this,"world",null);Motion.addListener("accel",pi=>this.handleAccel(pi)),this.world=getRoom(this)}gotoRoom(hi){const _i=window.dsml1.getIntGridLayers()[0].tilemap;this.status.location={level:this.world.level,room:hi},this.status.enteredRoom=Date.now(),window.game.stop(),this.world=getRoom(this);let pi=__webpack_exports__vec(this.pos.x%32+16,this.pos.y%32);window.dsml1.retile(this.world.checksum).then(mi=>{let gi=mi.getRooms()[0],vi=mi.getRooms()[mi.getRooms().length-1];this.pos.x<0?this.pos=__webpack_exports__vec(mi._width*32-32,vi.getBottom()*32).add(pi):this.pos.x>_i.width&&(this.pos=__webpack_exports__vec(0,gi.getBottom()*32).add(pi)),window.game.currentScene.camera.pos=this.pos,window.game.start()})}update(hi){const _i=window.dsml1.getIntGridLayers()[0].tilemap;this.pos.x>=_i.width&&this.gotoRoom(this.status.location.room+1),this.pos.x<=0&&this.gotoRoom(this.status.location.room-1),(hi.input.keyboard.isHeld(__webpack_exports__Keys.Up)||hi.input.gamepads.at(0).getAxes(__webpack_exports__Axes.LeftStickY)>.5)&&this.vel.addEqual(__webpack_exports__vec(0,-10)),(hi.input.keyboard.isHeld(__webpack_exports__Keys.Left)||hi.input.gamepads.at(0).getAxes(__webpack_exports__Axes.LeftStickX)<-.5)&&this.vel.addEqual(__webpack_exports__vec(-10,0)),(hi.input.keyboard.isHeld(__webpack_exports__Keys.Right)||hi.input.gamepads.at(0).getAxes(__webpack_exports__Axes.LeftStickX)>.5)&&this.vel.addEqual(__webpack_exports__vec(10,0)),this.vel.y>90?this.graphics.use(flyMan):Math.abs(this.vel.x)>120?this.graphics.use(runMan):Math.abs(this.vel.x)>2?this.graphics.use(walkMan):this.graphics.use(idleMan),this.vel.x>.1?this.graphics.flipHorizontal=!1:this.vel.x<-.1&&(this.graphics.flipHorizontal=!0)}handleAccel(hi){__webpack_exports__vec(hi.accelerationIncludingGravity.x,hi.accelerationIncludingGravity.y).magnitude>2&&(isSafari?this.vel.addEqual(__webpack_exports__vec(hi.accelerationIncludingGravity.x,-hi.accelerationIncludingGravity.y<0?-hi.accelerationIncludingGravity.y:0)):this.vel.addEqual(__webpack_exports__vec(-hi.accelerationIncludingGravity.x,hi.accelerationIncludingGravity.y<0?hi.accelerationIncludingGravity.y:0)))}}const logo="/roke/assets/logo640-BoXgrRm0.png";var t,r,u,i,o=0,f=[],c=l$2,e=c.__b,a=c.__r,v=c.diffed,l=c.__c,m=c.unmount,s=c.__;function d(fi,ci){c.__h&&c.__h(r,fi,o||ci),o=0;var hi=r.__H||(r.__H={__:[],__h:[]});return fi>=hi.__.length&&hi.__.push({}),hi.__[fi]}function h(fi){return o=1,p(D$1,fi)}function p(fi,ci,hi){var _i=d(t++,2);if(_i.t=fi,!_i.__c&&(_i.__=[hi?hi(ci):D$1(void 0,ci),function(vi){var xi=_i.__N?_i.__N[0]:_i.__[0],wi=_i.t(xi,vi);xi!==wi&&(_i.__N=[wi,_i.__[1]],_i.__c.setState({}))}],_i.__c=r,!r.u)){var pi=function(vi,xi,wi){if(!_i.__c.__H)return!0;var yi=_i.__c.__H.__.filter(function(Ei){return!!Ei.__c});if(yi.every(function(Ei){return!Ei.__N}))return!mi||mi.call(this,vi,xi,wi);var Ci=_i.__c.props!==vi;return yi.forEach(function(Ei){if(Ei.__N){var Si=Ei.__[0];Ei.__=Ei.__N,Ei.__N=void 0,Si!==Ei.__[0]&&(Ci=!0)}}),mi&&mi.call(this,vi,xi,wi)||Ci};r.u=!0;var mi=r.shouldComponentUpdate,gi=r.componentWillUpdate;r.componentWillUpdate=function(vi,xi,wi){if(this.__e){var yi=mi;mi=void 0,pi(vi,xi,wi),mi=yi}gi&&gi.call(this,vi,xi,wi)},r.shouldComponentUpdate=pi}return _i.__N||_i.__}function y(fi,ci){var hi=d(t++,3);!c.__s&&C$1(hi.__H,ci)&&(hi.__=fi,hi.i=ci,r.__H.__h.push(hi))}function _(fi,ci){var hi=d(t++,4);!c.__s&&C$1(hi.__H,ci)&&(hi.__=fi,hi.i=ci,r.__h.push(hi))}function A$1(fi){return o=5,T$1(function(){return{current:fi}},[])}function F$1(fi,ci,hi){o=6,_(function(){return typeof fi=="function"?(fi(ci()),function(){return fi(null)}):fi?(fi.current=ci(),function(){return fi.current=null}):void 0},hi==null?hi:hi.concat(fi))}function T$1(fi,ci){var hi=d(t++,7);return C$1(hi.__H,ci)&&(hi.__=fi(),hi.__H=ci,hi.__h=fi),hi.__}function q$1(fi,ci){return o=8,T$1(function(){return fi},ci)}function x$1(fi){var ci=r.context[fi.__c],hi=d(t++,9);return hi.c=fi,ci?(hi.__==null&&(hi.__=!0,ci.sub(r)),ci.props.value):fi.__}function P$1(fi,ci){c.useDebugValue&&c.useDebugValue(ci?ci(fi):fi)}function g$1(){var fi=d(t++,11);if(!fi.__){for(var ci=r.__v;ci!==null&&!ci.__m&&ci.__!==null;)ci=ci.__;var hi=ci.__m||(ci.__m=[0,0]);fi.__="P"+hi[0]+"-"+hi[1]++}return fi.__}function j$1(){for(var fi;fi=f.shift();)if(fi.__P&&fi.__H)try{fi.__H.__h.forEach(z$1),fi.__H.__h.forEach(B$1),fi.__H.__h=[]}catch(ci){fi.__H.__h=[],c.__e(ci,fi.__v)}}c.__b=function(fi){r=null,e&&e(fi)},c.__=function(fi,ci){fi&&ci.__k&&ci.__k.__m&&(fi.__m=ci.__k.__m),s&&s(fi,ci)},c.__r=function(fi){a&&a(fi),t=0;var ci=(r=fi.__c).__H;ci&&(u===r?(ci.__h=[],r.__h=[],ci.__.forEach(function(hi){hi.__N&&(hi.__=hi.__N),hi.i=hi.__N=void 0})):(ci.__h.forEach(z$1),ci.__h.forEach(B$1),ci.__h=[],t=0)),u=r},c.diffed=function(fi){v&&v(fi);var ci=fi.__c;ci&&ci.__H&&(ci.__H.__h.length&&(f.push(ci)!==1&&i===c.requestAnimationFrame||((i=c.requestAnimationFrame)||w$1)(j$1)),ci.__H.__.forEach(function(hi){hi.i&&(hi.__H=hi.i),hi.i=void 0})),u=r=null},c.__c=function(fi,ci){ci.some(function(hi){try{hi.__h.forEach(z$1),hi.__h=hi.__h.filter(function(_i){return!_i.__||B$1(_i)})}catch(_i){ci.some(function(pi){pi.__h&&(pi.__h=[])}),ci=[],c.__e(_i,hi.__v)}}),l&&l(fi,ci)},c.unmount=function(fi){m&&m(fi);var ci,hi=fi.__c;hi&&hi.__H&&(hi.__H.__.forEach(function(_i){try{z$1(_i)}catch(pi){ci=pi}}),hi.__H=void 0,ci&&c.__e(ci,hi.__v))};var k$1=typeof requestAnimationFrame=="function";function w$1(fi){var ci,hi=function(){clearTimeout(_i),k$1&&cancelAnimationFrame(ci),setTimeout(fi)},_i=setTimeout(hi,100);k$1&&(ci=requestAnimationFrame(hi))}function z$1(fi){var ci=r,hi=fi.__c;typeof hi=="function"&&(fi.__c=void 0,hi()),r=ci}function B$1(fi){var ci=r;fi.__c=fi.__(),r=ci}function C$1(fi,ci){return!fi||fi.length!==ci.length||ci.some(function(hi,_i){return hi!==fi[_i]})}function D$1(fi,ci){return typeof ci=="function"?ci(fi):ci}function g(fi,ci){for(var hi in fi)if(hi!=="__source"&&!(hi in ci))return!0;for(var _i in ci)if(_i!=="__source"&&fi[_i]!==ci[_i])return!0;return!1}function E(fi,ci){var hi=ci(),_i=h({t:{__:hi,u:ci}}),pi=_i[0].t,mi=_i[1];return _(function(){pi.__=hi,pi.u=ci,C(pi)&&mi({t:pi})},[fi,hi,ci]),y(function(){return C(pi)&&mi({t:pi}),fi(function(){C(pi)&&mi({t:pi})})},[fi]),hi}function C(fi){var ci,hi,_i=fi.u,pi=fi.__;try{var mi=_i();return!((ci=pi)===(hi=mi)&&(ci!==0||1/ci==1/hi)||ci!=ci&&hi!=hi)}catch{return!0}}function x(fi){fi()}function R(fi){return fi}function w(){return[!1,x]}var k=_;function I(fi,ci){this.props=fi,this.context=ci}function N(fi,ci){function hi(pi){var mi=this.props.ref,gi=mi==pi.ref;return!gi&&mi&&(mi.call?mi(null):mi.current=null),ci?!ci(this.props,pi)||!gi:g(this.props,pi)}function _i(pi){return this.shouldComponentUpdate=hi,g$3(fi,pi)}return _i.displayName="Memo("+(fi.displayName||fi.name)+")",_i.prototype.isReactComponent=!0,_i.__f=!0,_i}(I.prototype=new x$3).isPureReactComponent=!0,I.prototype.shouldComponentUpdate=function(fi,ci){return g(this.props,fi)||g(this.state,ci)};var M=l$2.__b;l$2.__b=function(fi){fi.type&&fi.type.__f&&fi.ref&&(fi.props.ref=fi.ref,fi.ref=null),M&&M(fi)};var T=typeof Symbol<"u"&&Symbol.for&&Symbol.for("react.forward_ref")||3911;function A(fi){function ci(hi){if(!("ref"in hi))return fi(hi,null);var _i=hi.ref;delete hi.ref;var pi=fi(hi,_i);return hi.ref=_i,pi}return ci.$$typeof=T,ci.render=ci,ci.prototype.isReactComponent=ci.__f=!0,ci.displayName="ForwardRef("+(fi.displayName||fi.name)+")",ci}var D=function(fi,ci){return fi==null?null:H$2(H$2(fi).map(ci))},L={map:D,forEach:D,count:function(fi){return fi?H$2(fi).length:0},only:function(fi){var ci=H$2(fi);if(ci.length!==1)throw"Children.only";return ci[0]},toArray:H$2},O=l$2.__e;l$2.__e=function(fi,ci,hi,_i){if(fi.then){for(var pi,mi=ci;mi=mi.__;)if((pi=mi.__c)&&pi.__c)return ci.__e==null&&(ci.__e=hi.__e,ci.__k=hi.__k),pi.__c(fi,ci)}O(fi,ci,hi,_i)};var F=l$2.unmount;function U(fi,ci,hi){return fi&&(fi.__c&&fi.__c.__H&&(fi.__c.__H.__.forEach(function(_i){typeof _i.__c=="function"&&_i.__c()}),fi.__c.__H=null),(fi=function(_i,pi){for(var mi in pi)_i[mi]=pi[mi];return _i}({},fi)).__c!=null&&(fi.__c.__P===hi&&(fi.__c.__P=ci),fi.__c=null),fi.__k=fi.__k&&fi.__k.map(function(_i){return U(_i,ci,hi)})),fi}function V(fi,ci,hi){return fi&&hi&&(fi.__v=null,fi.__k=fi.__k&&fi.__k.map(function(_i){return V(_i,ci,hi)}),fi.__c&&fi.__c.__P===ci&&(fi.__e&&hi.appendChild(fi.__e),fi.__c.__e=!0,fi.__c.__P=hi)),fi}function W(){this.__u=0,this.o=null,this.__b=null}function P(fi){var ci=fi.__.__c;return ci&&ci.__a&&ci.__a(fi)}function j(fi){var ci,hi,_i;function pi(mi){if(ci||(ci=fi()).then(function(gi){hi=gi.default||gi},function(gi){_i=gi}),_i)throw _i;if(!hi)throw ci;return g$3(hi,mi)}return pi.displayName="Lazy",pi.__f=!0,pi}function z(){this.i=null,this.l=null}l$2.unmount=function(fi){var ci=fi.__c;ci&&ci.__R&&ci.__R(),ci&&32&fi.__u&&(fi.type=null),F&&F(fi)},(W.prototype=new x$3).__c=function(fi,ci){var hi=ci.__c,_i=this;_i.o==null&&(_i.o=[]),_i.o.push(hi);var pi=P(_i.__v),mi=!1,gi=function(){mi||(mi=!0,hi.__R=null,pi?pi(vi):vi())};hi.__R=gi;var vi=function(){if(!--_i.__u){if(_i.state.__a){var xi=_i.state.__a;_i.__v.__k[0]=V(xi,xi.__c.__P,xi.__c.__O)}var wi;for(_i.setState({__a:_i.__b=null});wi=_i.o.pop();)wi.forceUpdate()}};_i.__u++||32&ci.__u||_i.setState({__a:_i.__b=_i.__v.__k[0]}),fi.then(gi,gi)},W.prototype.componentWillUnmount=function(){this.o=[]},W.prototype.render=function(fi,ci){if(this.__b){if(this.__v.__k){var hi=document.createElement("div"),_i=this.__v.__k[0].__c;this.__v.__k[0]=U(this.__b,hi,_i.__O=_i.__P)}this.__b=null}var pi=ci.__a&&g$3(k$3,null,fi.fallback);return pi&&(pi.__u&=-33),[g$3(k$3,null,ci.__a?null:fi.children),pi]};var B=function(fi,ci,hi){if(++hi[1]===hi[0]&&fi.l.delete(ci),fi.props.revealOrder&&(fi.props.revealOrder[0]!=="t"||!fi.l.size))for(hi=fi.i;hi;){for(;hi.length>3;)hi.pop()();if(hi[1]<hi[0])break;fi.i=hi=hi[2]}};function H(fi){return this.getChildContext=function(){return fi.context},fi.children}function Z(fi){var ci=this,hi=fi.h;ci.componentWillUnmount=function(){D$3(null,ci.v),ci.v=null,ci.h=null},ci.h&&ci.h!==hi&&ci.componentWillUnmount(),ci.v||(ci.h=hi,ci.v={nodeType:1,parentNode:hi,childNodes:[],contains:function(){return!0},appendChild:function(_i){this.childNodes.push(_i),ci.h.appendChild(_i)},insertBefore:function(_i,pi){this.childNodes.push(_i),ci.h.insertBefore(_i,pi)},removeChild:function(_i){this.childNodes.splice(this.childNodes.indexOf(_i)>>>1,1),ci.h.removeChild(_i)}}),D$3(g$3(H,{context:ci.context},fi.__v),ci.v)}function Y(fi,ci){var hi=g$3(Z,{__v:fi,h:ci});return hi.containerInfo=ci,hi}(z.prototype=new x$3).__a=function(fi){var ci=this,hi=P(ci.__v),_i=ci.l.get(fi);return _i[0]++,function(pi){var mi=function(){ci.props.revealOrder?(_i.push(pi),B(ci,fi,_i)):pi()};hi?hi(mi):mi()}},z.prototype.render=function(fi){this.i=null,this.l=new Map;var ci=H$2(fi.children);fi.revealOrder&&fi.revealOrder[0]==="b"&&ci.reverse();for(var hi=ci.length;hi--;)this.l.set(ci[hi],this.i=[1,0,this.i]);return fi.children},z.prototype.componentDidUpdate=z.prototype.componentDidMount=function(){var fi=this;this.l.forEach(function(ci,hi){B(fi,hi,ci)})};var $=typeof Symbol<"u"&&Symbol.for&&Symbol.for("react.element")||60103,q=/^(?:accent|alignment|arabic|baseline|cap|clip(?!PathU)|color|dominant|fill|flood|font|glyph(?!R)|horiz|image(!S)|letter|lighting|marker(?!H|W|U)|overline|paint|pointer|shape|stop|strikethrough|stroke|text(?!L)|transform|underline|unicode|units|v|vector|vert|word|writing|x(?!C))[A-Z]/,G=/^on(Ani|Tra|Tou|BeforeInp|Compo)/,J=/[A-Z0-9]/g,K=typeof document<"u",Q=function(fi){return(typeof Symbol<"u"&&typeof Symbol()=="symbol"?/fil|che|rad/:/fil|che|ra/).test(fi)};function X(fi,ci,hi){return ci.__k==null&&(ci.textContent=""),D$3(fi,ci),typeof hi=="function"&&hi(),fi?fi.__c:null}function nn(fi,ci,hi){return E$2(fi,ci),typeof hi=="function"&&hi(),fi?fi.__c:null}x$3.prototype.isReactComponent={},["componentWillMount","componentWillReceiveProps","componentWillUpdate"].forEach(function(fi){Object.defineProperty(x$3.prototype,fi,{configurable:!0,get:function(){return this["UNSAFE_"+fi]},set:function(ci){Object.defineProperty(this,fi,{configurable:!0,writable:!0,value:ci})}})});var tn=l$2.event;function en(){}function rn(){return this.cancelBubble}function un(){return this.defaultPrevented}l$2.event=function(fi){return tn&&(fi=tn(fi)),fi.persist=en,fi.isPropagationStopped=rn,fi.isDefaultPrevented=un,fi.nativeEvent=fi};var on,cn={enumerable:!1,configurable:!0,get:function(){return this.class}},fn=l$2.vnode;l$2.vnode=function(fi){typeof fi.type=="string"&&function(ci){var hi=ci.props,_i=ci.type,pi={},mi=_i.indexOf("-")===-1;for(var gi in hi){var vi=hi[gi];if(!(gi==="value"&&"defaultValue"in hi&&vi==null||K&&gi==="children"&&_i==="noscript"||gi==="class"||gi==="className")){var xi=gi.toLowerCase();gi==="defaultValue"&&"value"in hi&&hi.value==null?gi="value":gi==="download"&&vi===!0?vi="":xi==="translate"&&vi==="no"?vi=!1:xi[0]==="o"&&xi[1]==="n"?xi==="ondoubleclick"?gi="ondblclick":xi!=="onchange"||_i!=="input"&&_i!=="textarea"||Q(hi.type)?xi==="onfocus"?gi="onfocusin":xi==="onblur"?gi="onfocusout":G.test(gi)&&(gi=xi):xi=gi="oninput":mi&&q.test(gi)?gi=gi.replace(J,"-$&").toLowerCase():vi===null&&(vi=void 0),xi==="oninput"&&pi[gi=xi]&&(gi="oninputCapture"),pi[gi]=vi}}_i=="select"&&pi.multiple&&Array.isArray(pi.value)&&(pi.value=H$2(hi.children).forEach(function(wi){wi.props.selected=pi.value.indexOf(wi.props.value)!=-1})),_i=="select"&&pi.defaultValue!=null&&(pi.value=H$2(hi.children).forEach(function(wi){wi.props.selected=pi.multiple?pi.defaultValue.indexOf(wi.props.value)!=-1:pi.defaultValue==wi.props.value})),hi.class&&!hi.className?(pi.class=hi.class,Object.defineProperty(pi,"className",cn)):(hi.className&&!hi.class||hi.class&&hi.className)&&(pi.class=pi.className=hi.className),ci.props=pi}(fi),fi.$$typeof=$,fn&&fn(fi)};var ln=l$2.__r;l$2.__r=function(fi){ln&&ln(fi),on=fi.__c};var an=l$2.diffed;l$2.diffed=function(fi){an&&an(fi);var ci=fi.props,hi=fi.__e;hi!=null&&fi.type==="textarea"&&"value"in ci&&ci.value!==hi.value&&(hi.value=ci.value==null?"":ci.value),on=null};var sn={ReactCurrentDispatcher:{current:{readContext:function(fi){return on.__n[fi.__c].props.value},useCallback:q$1,useContext:x$1,useDebugValue:P$1,useDeferredValue:R,useEffect:y,useId:g$1,useImperativeHandle:F$1,useInsertionEffect:k,useLayoutEffect:_,useMemo:T$1,useReducer:p,useRef:A$1,useState:h,useSyncExternalStore:E,useTransition:w}}};function vn(fi){return g$3.bind(null,fi)}function dn(fi){return!!fi&&fi.$$typeof===$}function pn(fi){return dn(fi)&&fi.type===k$3}function mn(fi){return!!fi&&!!fi.displayName&&(typeof fi.displayName=="string"||fi.displayName instanceof String)&&fi.displayName.startsWith("Memo(")}function yn(fi){return dn(fi)?G$2.apply(null,arguments):fi}function _n(fi){return!!fi.__k&&(D$3(null,fi),!0)}function bn(fi){return fi&&(fi.base||fi.nodeType===1&&fi)||null}var Sn=function(fi,ci){return fi(ci)},gn=function(fi,ci){return fi(ci)},En=k$3,Cn=dn,xn={useState:h,useId:g$1,useReducer:p,useEffect:y,useLayoutEffect:_,useInsertionEffect:k,useTransition:w,useDeferredValue:R,useSyncExternalStore:E,startTransition:x,useRef:A$1,useImperativeHandle:F$1,useMemo:T$1,useCallback:q$1,useContext:x$1,useDebugValue:P$1,version:"18.3.1",Children:L,render:X,hydrate:nn,unmountComponentAtNode:_n,createPortal:Y,createElement:g$3,createContext:J$2,createFactory:vn,cloneElement:yn,createRef:b$1,Fragment:k$3,isValidElement:dn,isElement:Cn,isFragment:pn,isMemo:mn,findDOMNode:bn,Component:x$3,PureComponent:I,memo:N,forwardRef:A,flushSync:gn,unstable_batchedUpdates:Sn,StrictMode:En,Suspense:W,SuspenseList:z,lazy:j,__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED:sn},Keyboard;(function(fi){fi.ARROW_DOWN="ArrowDown",fi.ARROW_LEFT="ArrowLeft",fi.ARROW_RIGHT="ArrowRight",fi.ARROW_UP="ArrowUp",fi.END="End",fi.HOME="Home",fi.PAGE_DOWN="PageDown",fi.PAGE_UP="PageUp",fi.DELETE="Delete",fi.BACKSPACE="Backspace",fi.ENTER="Enter"})(Keyboard||(Keyboard={}));var exhaustiveCheck=function(fi){return function(ci){throw new Error("".concat(fi).concat(ci))}},moveActions=[Keyboard.ARROW_LEFT,Keyboard.ARROW_RIGHT,Keyboard.HOME,Keyboard.END],setOfActions$4=new Set(moveActions),isMoveActions=function(fi){return setOfActions$4.has(fi)},moveLeft=function(fi){var ci=fi-1;return ci<0?0:ci},moveRight=function(fi,ci){var hi=fi+1;return hi>ci?ci:hi},moveHome=function(){return 0},moveEnd=function(fi){return fi},checkMoveActions=exhaustiveCheck("Invalid move action: "),newPosition$2=function(fi,ci){var hi=fi.cursorPosition,_i=fi.lastPosition;switch(ci){case Keyboard.ARROW_LEFT:return moveLeft(hi);case Keyboard.ARROW_RIGHT:return moveRight(hi,_i);case Keyboard.HOME:return moveHome();case Keyboard.END:return moveEnd(_i);default:checkMoveActions(ci)}return hi},moveCursor=function(fi,ci){var hi=fi.renderValue,_i=fi.cursorPosition,pi=fi.inputValue,mi=hi.length;return{renderValue:hi,cursorPosition:newPosition$2({cursorPosition:_i,lastPosition:mi},ci),inputValue:pi}},preventedActions=[Keyboard.ARROW_DOWN,Keyboard.ARROW_LEFT,Keyboard.ARROW_RIGHT,Keyboard.ARROW_UP,Keyboard.END,Keyboard.HOME,Keyboard.PAGE_DOWN,Keyboard.PAGE_UP,Keyboard.DELETE,Keyboard.BACKSPACE,Keyboard.ENTER],setOfActions$3=new Set(preventedActions),isPreventedActions=function(fi){return setOfActions$3.has(fi)},preventActions=function(fi){fi.preventDefault()},submitActions=[Keyboard.ENTER],setOfActions$2=new Set(submitActions),isSubmitActions=function(fi){return setOfActions$2.has(fi)},DEFAULT_INPUT="",DEFAULT_RENDER=[],DEFAULT_POSITION=0,submit=function(){return{inputValue:DEFAULT_INPUT,renderValue:DEFAULT_RENDER,cursorPosition:DEFAULT_POSITION}};/*! *****************************************************************************
Copyright (c) Microsoft Corporation.

Permission to use, copy, modify, and/or distribute this software for any
purpose with or without fee is hereby granted.

THE SOFTWARE IS PROVIDED "AS IS" AND THE AUTHOR DISCLAIMS ALL WARRANTIES WITH
REGARD TO THIS SOFTWARE INCLUDING ALL IMPLIED WARRANTIES OF MERCHANTABILITY
AND FITNESS. IN NO EVENT SHALL THE AUTHOR BE LIABLE FOR ANY SPECIAL, DIRECT,
INDIRECT, OR CONSEQUENTIAL DAMAGES OR ANY DAMAGES WHATSOEVER RESULTING FROM
LOSS OF USE, DATA OR PROFITS, WHETHER IN AN ACTION OF CONTRACT, NEGLIGENCE OR
OTHER TORTIOUS ACTION, ARISING OUT OF OR IN CONNECTION WITH THE USE OR
PERFORMANCE OF THIS SOFTWARE.
***************************************************************************** */var __assign=function(){return __assign=Object.assign||function(ci){for(var hi,_i=1,pi=arguments.length;_i<pi;_i++){hi=arguments[_i];for(var mi in hi)Object.prototype.hasOwnProperty.call(hi,mi)&&(ci[mi]=hi[mi])}return ci},__assign.apply(this,arguments)};function __rest(fi,ci){var hi={};for(var _i in fi)Object.prototype.hasOwnProperty.call(fi,_i)&&ci.indexOf(_i)<0&&(hi[_i]=fi[_i]);if(fi!=null&&typeof Object.getOwnPropertySymbols=="function")for(var pi=0,_i=Object.getOwnPropertySymbols(fi);pi<_i.length;pi++)ci.indexOf(_i[pi])<0&&Object.prototype.propertyIsEnumerable.call(fi,_i[pi])&&(hi[_i[pi]]=fi[_i[pi]]);return hi}function __awaiter(fi,ci,hi,_i){function pi(mi){return mi instanceof hi?mi:new hi(function(gi){gi(mi)})}return new(hi||(hi=Promise))(function(mi,gi){function vi(yi){try{wi(_i.next(yi))}catch(Ci){gi(Ci)}}function xi(yi){try{wi(_i.throw(yi))}catch(Ci){gi(Ci)}}function wi(yi){yi.done?mi(yi.value):pi(yi.value).then(vi,xi)}wi((_i=_i.apply(fi,[])).next())})}function __generator(fi,ci){var hi={label:0,sent:function(){if(mi[0]&1)throw mi[1];return mi[1]},trys:[],ops:[]},_i,pi,mi,gi;return gi={next:vi(0),throw:vi(1),return:vi(2)},typeof Symbol=="function"&&(gi[Symbol.iterator]=function(){return this}),gi;function vi(wi){return function(yi){return xi([wi,yi])}}function xi(wi){if(_i)throw new TypeError("Generator is already executing.");for(;hi;)try{if(_i=1,pi&&(mi=wi[0]&2?pi.return:wi[0]?pi.throw||((mi=pi.return)&&mi.call(pi),0):pi.next)&&!(mi=mi.call(pi,wi[1])).done)return mi;switch(pi=0,mi&&(wi=[wi[0]&2,mi.value]),wi[0]){case 0:case 1:mi=wi;break;case 4:return hi.label++,{value:wi[1],done:!1};case 5:hi.label++,pi=wi[1],wi=[0];continue;case 7:wi=hi.ops.pop(),hi.trys.pop();continue;default:if(mi=hi.trys,!(mi=mi.length>0&&mi[mi.length-1])&&(wi[0]===6||wi[0]===2)){hi=0;continue}if(wi[0]===3&&(!mi||wi[1]>mi[0]&&wi[1]<mi[3])){hi.label=wi[1];break}if(wi[0]===6&&hi.label<mi[1]){hi.label=mi[1],mi=wi;break}if(mi&&hi.label<mi[2]){hi.label=mi[2],hi.ops.push(wi);break}mi[2]&&hi.ops.pop(),hi.trys.pop();continue}wi=ci.call(fi,hi)}catch(yi){wi=[6,yi],pi=0}finally{_i=mi=0}if(wi[0]&5)throw wi[1];return{value:wi[0]?wi[1]:void 0,done:!0}}}function __spreadArray(fi,ci,hi){if(hi||arguments.length===2)for(var _i=0,pi=ci.length,mi;_i<pi;_i++)(mi||!(_i in ci))&&(mi||(mi=Array.prototype.slice.call(ci,0,_i)),mi[_i]=ci[_i]);return fi.concat(mi||Array.prototype.slice.call(ci))}var removeActions=[Keyboard.BACKSPACE,Keyboard.DELETE],setOfActions$1=new Set(removeActions),isRemoveActions=function(fi){return setOfActions$1.has(fi)},checkRemoveActions=exhaustiveCheck("Invalid remove action: "),newPosition$1=function(fi,ci){return fi<0?0:fi>ci?ci:fi},newRender$1=function(fi,ci){return __spreadArray(__spreadArray([],fi.slice(0,ci),!0),fi.slice(ci+1),!0)},newValue=function(fi,ci){return"".concat(fi.substring(0,ci)).concat(fi.substring(ci+1))},handleBackspace=function(fi){var ci=fi.renderValue,hi=fi.inputValue,_i=fi.cursorPosition,pi=_i-1;return pi<0?fi:{renderValue:newRender$1(ci,pi),inputValue:newValue(hi,pi),cursorPosition:newPosition$1(pi,ci.length)}},handleDelete=function(fi){var ci=fi.renderValue,hi=fi.inputValue,_i=fi.cursorPosition;return _i===ci.length?fi:{renderValue:newRender$1(ci,_i),inputValue:newValue(hi,_i),cursorPosition:newPosition$1(_i,ci.length-1)}},remove=function(fi,ci){switch(ci){case Keyboard.BACKSPACE:return handleBackspace(fi);case Keyboard.DELETE:return handleDelete(fi);default:checkRemoveActions(ci)}return fi},newPosition=function(fi){var ci=fi.oldLength,hi=fi.newLength,_i=fi.cursorPosition,pi=ci===_i;return pi?hi:_i},newRender=function(fi){var ci=fi.renderValue,hi=fi.cursorPosition,_i=fi.newInput,pi=ci.length,mi=_i.length-ci.length,gi=_i.substring(hi,hi+mi);return __spreadArray(__spreadArray(__spreadArray([],ci.slice(0,hi),!0),gi.split(""),!0),ci.slice(hi,pi),!0)},press=function(fi){var ci=fi.newInput,hi=fi.renderValue,_i=fi.cursorPosition;if(!ci)throw new Error("Cannot press without a new input");if(ci.length<hi.length)throw new Error("New input is shorter then old one");return{inputValue:ci,renderValue:newRender({newInput:ci,renderValue:hi,cursorPosition:_i}),cursorPosition:newPosition({oldLength:hi.length,newLength:ci.length,cursorPosition:_i})}},serviceActions=[Keyboard.ARROW_UP,Keyboard.ARROW_DOWN],setOfActions=new Set(serviceActions),isServiceActions=function(fi){return setOfActions.has(fi)},checkServiceActions=exhaustiveCheck("Invalid service action: "),handleHistoryMove=function(fi){var ci=fi(),hi=ci.length,_i=ci.split("");return{renderValue:_i,inputValue:ci,cursorPosition:hi}},provideService=function(fi,ci){var hi=fi.renderValue,_i=fi.inputValue,pi=fi.cursorPosition,mi=fi.services,gi=mi.nextCommand,vi=mi.prevCommand;switch(ci){case Keyboard.ARROW_UP:return handleHistoryMove(vi);case Keyboard.ARROW_DOWN:return handleHistoryMove(gi);default:checkServiceActions(ci)}return{renderValue:hi,inputValue:_i,cursorPosition:pi}},defaultState$3={renderValue:[],inputValue:"",cursorPosition:0};function useCommandLine(){var fi=h(defaultState$3.inputValue),ci=fi[0],hi=fi[1],_i=h(defaultState$3.renderValue),pi=_i[0],mi=_i[1],gi=h(defaultState$3.cursorPosition),vi=gi[0],xi=gi[1],wi=function(Ti){var Pi=Ti.renderValue,Li=Ti.inputValue,Ri=Ti.cursorPosition;pi!==Pi&&mi(Pi),ci!==Li&&hi(Li),vi!==Ri&&xi(Ri)},yi=function(Ti){return preventActions(Ti)},Ci=function(Ti){return wi(press({renderValue:pi,inputValue:ci,cursorPosition:vi,newInput:Ti}))},Ei=function(Ti){return wi({renderValue:Ti.split(""),inputValue:Ti,cursorPosition:Ti.length})},Si=function(Ti){return wi(remove({renderValue:pi,inputValue:ci,cursorPosition:vi},Ti))},ki=function(Ti){return wi(moveCursor({renderValue:pi,inputValue:ci,cursorPosition:vi},Ti))},Ai=function(){return wi(submit())},Ii=function(Ti,Pi){return wi(provideService({renderValue:pi,inputValue:ci,cursorPosition:vi,services:Pi},Ti))};return{state:{inputValue:ci,renderValue:pi,cursorPosition:vi},handlers:{preventDefault:yi,addCharacter:Ci,setInput:Ei,moveCommandCursor:ki,removeCharacter:Si,submitCommand:Ai,provideCommandService:Ii}}}function useCommandLineInput(){var fi=A$1(null),ci=function(_i){fi.current&&(fi.current.selectionStart=_i,fi.current.selectionEnd=_i)},hi=function(){var _i;return(_i=fi.current)===null||_i===void 0?void 0:_i.focus()};return{state:{inputElementRef:fi},handlers:{focus:hi,setInputCursor:ci}}}var DEFAULT_COMMAND="",next$1=function(fi){var ci=fi.commandsHistory,hi=fi.cursorPosition,_i=ci.length-1,pi=hi+1,mi=_i<pi?ci.length:pi,gi=ci[mi]||DEFAULT_COMMAND;return{commandsHistory:ci,cursorPosition:mi,command:gi}},prev=function(fi){var ci=fi.commandsHistory,hi=fi.cursorPosition,_i=hi-1,pi=_i<0?-1:_i,mi=ci[pi]||DEFAULT_COMMAND;return{commandsHistory:ci,cursorPosition:pi,command:mi}},add=function(fi){var ci=fi.commandsHistory,hi=fi.command,_i=fi.maxHistoryCommands,pi=ci.length,mi=pi-1,gi=ci[mi]===hi;if(gi)return{commandsHistory:ci,cursorPosition:pi};var vi=pi<_i;if(vi)return{commandsHistory:__spreadArray(__spreadArray([],ci,!0),[hi],!1),cursorPosition:pi+1};var xi=!!pi;return xi?{commandsHistory:__spreadArray(__spreadArray([],ci.slice(1),!0),[hi],!1),cursorPosition:pi}:{commandsHistory:ci,cursorPosition:pi}},defaultState$2={commandsHistory:[],cursorPosition:0};function useCommandHistory(fi){var ci=fi.maxHistoryCommands,hi=h(defaultState$2.commandsHistory),_i=hi[0],pi=hi[1],mi=h(defaultState$2.cursorPosition),gi=mi[0],vi=mi[1],xi=function(Ei){var Si=Ei.commandsHistory,ki=Ei.cursorPosition;_i!==Si&&pi(Si),gi!==ki&&vi(ki)},wi=function(Ei){xi(add({maxHistoryCommands:ci,commandsHistory:_i,command:Ei}))},yi=function(){var Ei=next$1({commandsHistory:_i,cursorPosition:gi}),Si=Ei.command,ki=__rest(Ei,["command"]);return xi(ki),Si},Ci=function(){var Ei=prev({commandsHistory:_i,cursorPosition:gi}),Si=Ei.command,ki=__rest(Ei,["command"]);return xi(ki),Si};return{state:{commandsHistory:_i},handlers:{addCommand:wi,nextCommand:yi,prevCommand:Ci}}}var printWords=function(fi){var ci=fi.remainingWords,hi=fi.printedWords,_i=fi.charactersToPrint,pi=ci[0];if(!pi)return{printedWords:hi,remainingWords:null,wordFullyPrinted:!0};var mi=pi.characters.slice(0,_i),gi=mi.length;return gi===_i?gi<pi.characters.length?{printedWords:__spreadArray(__spreadArray([],hi,!0),[__assign(__assign({},pi),{characters:mi})],!1),remainingWords:__spreadArray([__assign(__assign({},pi),{characters:pi.characters.slice(gi)})],ci.slice(1),!0),wordFullyPrinted:!1}:{printedWords:__spreadArray(__spreadArray([],hi,!0),[pi],!1),remainingWords:ci.slice(1),wordFullyPrinted:!0}:printWords({remainingWords:ci.slice(1),printedWords:__spreadArray(__spreadArray([],hi,!0),[pi],!1),charactersToPrint:_i-gi})},combineWords=function(fi){var ci=fi.prevWord,hi=fi.nextWord,_i=fi.wordFullyPrinted;return ci&&hi&&!_i?__assign(__assign({},ci),{characters:ci.characters+hi.characters}):hi},makeWordChunk=function(fi){var ci=fi.firstWord,hi=fi.printedWords;return ci?__spreadArray([ci],hi.slice(1),!0):hi},appendWordChunk=function(fi){var ci=fi.printedWordsPrev,hi=fi.wordChunk,_i=fi.wordFullyPrintedPrev;return __spreadArray(_i?__spreadArray([],ci,!0):__spreadArray([],ci.slice(0,ci.length-1),!0),hi,!0)},getRemainingLine=function(fi){var ci=fi.remainingLine,hi=fi.remainingWords;return hi&&hi.length>0?__assign(__assign({},ci),{words:hi}):null},printLine=function(fi){var ci=fi.remainingLine,hi=fi.printedLine,_i=fi.charactersToPrint,pi=fi.wordFullyPrinted,mi=hi.words,gi=printWords({remainingWords:ci.words,printedWords:[],charactersToPrint:_i}),vi=gi.printedWords,xi=gi.remainingWords,wi=gi.wordFullyPrinted,yi=mi[mi.length-1],Ci=vi[0],Ei=combineWords({prevWord:yi,nextWord:Ci,wordFullyPrinted:pi}),Si=makeWordChunk({firstWord:Ei,printedWords:vi});return{remainingLine:getRemainingLine({remainingLine:ci,remainingWords:xi}),printedLine:__assign(__assign({},hi),{words:appendWordChunk({printedWordsPrev:mi,wordChunk:Si,wordFullyPrintedPrev:pi})}),wordFullyPrinted:wi}},combinePrintedLines=function(fi){var ci=fi.printedLines,hi=fi.printedLine,_i=fi.newLine;return _i?__spreadArray(__spreadArray([],ci,!0),[hi],!1):__spreadArray(__spreadArray([],ci.slice(0,ci.length-1),!0),[hi],!1)},combineRemainingLines=function(fi){var ci=fi.remainingLines,hi=fi.remainingLine,_i=hi?__spreadArray([hi],ci.slice(1),!0):ci.slice(1);return _i.length>0?_i:null},printMultiline=function(fi){var ci=fi.remainingLines,hi=fi.printedLines,_i=fi.wordFullyPrinted,pi=fi.newLine,mi=fi.charactersToPrint,gi=ci[0];if(!gi)return{newLine:pi,wordFullyPrinted:_i,printedLines:hi,remainingLines:null};var vi=printLine({remainingLine:gi,printedLine:pi?__assign(__assign({},gi),{words:[]}):hi[hi.length-1],charactersToPrint:mi,wordFullyPrinted:_i}),xi=vi.remainingLine,wi=vi.printedLine,yi=vi.wordFullyPrinted;return{newLine:!xi,wordFullyPrinted:yi,printedLines:combinePrintedLines({printedLines:hi,printedLine:wi,newLine:pi}),remainingLines:combineRemainingLines({remainingLines:ci,remainingLine:xi})}},makeNewState=function(fi){var ci=fi.prevState,hi=fi.printedLinesNext,_i=fi.newLine;return __spreadArray(_i?__spreadArray([],ci,!0):__spreadArray([],ci.slice(0,ci.length-1),!0),hi,!0)},printer=function(fi){var ci=fi.remainingLines,hi=fi.printedLines,_i=fi.state,pi=fi.wordFullyPrinted,mi=fi.newLine,gi=fi.charactersToPrint,vi=printMultiline({remainingLines:ci,printedLines:hi,wordFullyPrinted:pi,newLine:mi,charactersToPrint:gi}),xi=vi.remainingLines,wi=vi.printedLines,yi=vi.wordFullyPrinted,Ci=vi.newLine;return{remainingLines:xi,printedLines:wi,wordFullyPrinted:yi,newLine:Ci,state:makeNewState({prevState:_i,printedLinesNext:wi,newLine:mi})}},createPrinterTask=function(fi,ci){return setTimeout(function(){return fi()},ci)},defaultState$1={state:[],remainingLines:null,printedLines:[],wordFullyPrinted:!0,newLine:!0};function usePrinter(fi){var ci=this,hi=fi.printerSpeed,_i=fi.charactersPerTick,pi=fi.afterPrintCallback,mi=fi.onPrintStatusChange,gi=h(!1),vi=gi[0],xi=gi[1],wi=h(null),yi=wi[0],Ci=wi[1],Ei=h(defaultState$1),Si=Ei[0],ki=Ei[1],Ai=A$1(null),Ii=function(){yi&&(clearTimeout(yi),Ci(null))},Ti=function(){Ai.current&&(Ai.current(!0),Ai.current=null)},Pi=function(){var Fi=Si.remainingLines,Mi=Si.printedLines,$i=Si.wordFullyPrinted,Oi=Si.newLine,Gi=Si.state;if(Fi){var Ui=printer({remainingLines:Fi,printedLines:Oi?[]:Mi,wordFullyPrinted:$i,newLine:Oi,state:Gi,charactersToPrint:_i});ki(Ui),Ci(null)}},Li=function(Fi){return __awaiter(ci,void 0,void 0,function(){var Mi;return __generator(this,function($i){return Mi=printer({remainingLines:Fi,printedLines:[],state:Si.state,wordFullyPrinted:!0,newLine:!0,charactersToPrint:_i}),xi(!0),ki(Mi),mi==null||mi(!0),[2,new Promise(function(Oi){Ai.current=Oi})]})})},Ri=function(){xi(!1),Ti(),mi==null||mi(!1)},Di=function(){ki(defaultState$1)};return y(function(){var Fi=vi&&!Si.remainingLines,Mi=vi&&!yi,$i=!vi&&yi;return Fi?(Ri(),pi()):Mi?(Ci(createPrinterTask(Pi,hi)),pi()):$i&&Ii(),function(){}},[vi,yi]),y(function(){return function(){Ii(),Ti()}},[]),{state:Si.state,handlers:{startPrint:Li,clear:Di}}}function useCommandScreen(fi){var ci=fi.printerConfig,hi=usePrinter(ci),_i=hi.state,pi=hi.handlers,mi=pi.startPrint,gi=pi.clear;return{state:_i,handlers:{print:mi,clear:gi}}}var WordTypes;(function(fi){fi.ANCHOR="ANCHOR",fi.TEXT="TEXT",fi.BUTTON="BUTTON",fi.COMMAND="COMMAND"})(WordTypes||(WordTypes={}));var textWord=function(fi){var ci=fi.characters,hi=fi.dataAttribute,_i=fi.className,pi=fi.id;return{type:WordTypes.TEXT,characters:ci,dataAttribute:hi,id:pi,className:_i}},buttonWord=function(fi){var ci=fi.characters,hi=fi.onClick,_i=fi.dataAttribute,pi=fi.className,mi=fi.id;return{type:WordTypes.BUTTON,characters:ci,onClick:hi,dataAttribute:_i,id:mi,className:pi}},commandWord=function(fi){var ci=fi.characters,hi=fi.prompt,_i=fi.dataAttribute,pi=fi.className,mi=fi.id;return{type:WordTypes.COMMAND,characters:ci,prompt:hi,dataAttribute:_i,className:pi,id:mi}},LineTypes;(function(fi){fi.TEXT="TEXT",fi.COMMAND="COMMAND"})(LineTypes||(LineTypes={}));var commandLine=function(fi){var ci=fi.words,hi=fi.dataAttribute,_i=fi.className,pi=fi.id;return{type:LineTypes.COMMAND,words:ci,dataAttribute:hi,className:_i,id:pi}},textLine=function(fi){var ci=fi.words,hi=fi.dataAttribute,_i=fi.className,pi=fi.id;return{type:LineTypes.TEXT,words:ci,dataAttribute:hi,className:_i,id:pi}},PrinterEvents;(function(fi){fi.PRINT="PRINT",fi.CLEAR="CLEAR"})(PrinterEvents||(PrinterEvents={}));var defaultQueue$2=[];function usePrinterQueue(){var fi=A$1(defaultQueue$2).current,ci=h(__spreadArray([],defaultQueue$2,!0)),hi=ci[0],_i=ci[1],pi=function(wi){fi.push(wi),_i(__spreadArray([],fi,!0))},mi=function(wi){fi.shift(),_i(__spreadArray([],fi,!0)),wi()},gi=function(){return hi[0]},vi=function(wi){pi({type:PrinterEvents.PRINT,payload:wi})},xi=function(){pi({type:PrinterEvents.CLEAR})};return{state:hi,handlers:{print:vi,clear:xi,dequeue:mi,nextEvent:gi}}}var TerminalEvents;(function(fi){fi.FOCUS="FOCUS",fi.LOCK="LOCK",fi.LOADING="LOADING"})(TerminalEvents||(TerminalEvents={}));var defaultQueue$1=[];function useTerminalQueue(){var fi=A$1(defaultQueue$1).current,ci=h(__spreadArray([],defaultQueue$1,!0)),hi=ci[0],_i=ci[1],pi=function(yi){fi.push(yi),_i(__spreadArray([],fi,!0))},mi=function(yi){fi.shift(),_i(__spreadArray([],fi,!0)),yi()},gi=function(){return hi[0]},vi=function(){pi({type:TerminalEvents.FOCUS})},xi=function(yi){pi({type:TerminalEvents.LOCK,payload:yi})},wi=function(yi){pi({type:TerminalEvents.LOADING,payload:yi})};return{state:hi,handlers:{focus:vi,lock:xi,loading:wi,dequeue:mi,nextEvent:gi}}}var defaultQueue=[];function useEventQueue(){var fi=A$1(defaultQueue).current,ci=h(__spreadArray([],defaultQueue,!0)),hi=ci[0],_i=ci[1],pi=function(Ei){fi.push(Ei),_i(__spreadArray([],fi,!0))},mi=function(Ei){fi.shift(),_i(__spreadArray([],fi,!0)),Ei()},gi=function(){return hi[0]},vi=function(Ei){pi({type:PrinterEvents.PRINT,payload:Ei})},xi=function(){pi({type:PrinterEvents.CLEAR})},wi=function(){pi({type:TerminalEvents.FOCUS})},yi=function(Ei){pi({type:TerminalEvents.LOCK,payload:Ei})},Ci=function(Ei){pi({type:TerminalEvents.LOADING,payload:Ei})};return{state:hi,api:{enqueue:pi,dequeue:mi,nextEvent:gi},handlers:{print:vi,clear:xi,focus:wi,lock:yi,loading:Ci}}}var printCommandLine=function(fi){var ci=fi.characters,hi=fi.prompt;return commandLine({words:[commandWord({characters:ci,prompt:hi})]})};function useTerminalController(fi){var ci=this,hi=fi.terminalApp,_i=hi.state.inputLocked,pi=hi.handlers.lock,mi=fi.input.handlers,gi=mi.setInputCursor,vi=mi.focus,xi=fi.commandScreen.handlers,wi=xi.print,yi=xi.clear,Ci=fi.commandLine,Ei=Ci.state,Si=Ei.cursorPosition,ki=Ei.inputValue,Ai=Ci.handlers,Ii=Ai.preventDefault,Ti=Ai.addCharacter,Pi=Ai.removeCharacter,Li=Ai.moveCommandCursor,Ri=Ai.submitCommand,Di=Ai.provideCommandService,Fi=fi.commandHistory.handlers,Mi=Fi.addCommand,$i=Fi.nextCommand,Oi=Fi.prevCommand,Gi=fi.loaderComponent,Ui=Gi.isLoading,zi=Gi.handlers,Wi=zi.startLoading,Ni=zi.endLoading,Hi=fi.interface,ji=Hi.onCommand,Bi=Hi.prompt,Ji=Hi.banner,Ki=Hi.queue.api.enqueue,Vi=fi.focusOnMount,qi=h(!1),Yi=qi[0],Qi=qi[1],ts=function(){vi()},Zi=function(Xi){var es=Ui&&!Xi;es||pi(Xi)},is=function(){return yi()},ss=function(Xi){return __awaiter(ci,void 0,void 0,function(){return __generator(this,function(es){switch(es.label){case 0:return[4,wi(Xi)];case 1:return es.sent(),[2]}})})},ns=function(Xi){var es=Xi&&Xi!==_i,ps=!Xi&&Yi;es?(pi(!0),Qi(!0)):ps&&(pi(!1),Qi(!1))},as=function(Xi){Xi&&!Ui?(ns(!0),Wi()):!Xi&&Ui&&(Ni(),ns(!1))},ls=function(Xi){_i||Ti(Xi)},cs=function(Xi){if(isMoveActions(Xi)&&Li(Xi),isRemoveActions(Xi)&&Pi(Xi),isServiceActions(Xi)&&Di(Xi,{nextCommand:$i,prevCommand:Oi}),isSubmitActions(Xi)){Ri();var es=ki.trim();es&&(Mi(es),Ki({type:PrinterEvents.PRINT,payload:[printCommandLine({characters:es,prompt:Bi})]}),ji(es))}},rs=function(Xi){var es=Xi.key;isPreventedActions(es)&&Ii(Xi),_i||cs(es)};y(function(){gi(Si)},[Si]);var os=A$1(!1);return y(function(){Ji&&!os.current&&(os.current=!0,Ki({type:PrinterEvents.PRINT,payload:Ji})),Vi&&vi()},[]),{handlers:{focus:ts,lock:Zi,clear:is,print:ss,handleInputChange:ls,handleKeyboardDown:rs,loading:as}}}var defaultState={inputLocked:!1};function useTerminalApp(){var fi=h(defaultState.inputLocked),ci=fi[0],hi=fi[1],_i=A$1(null),pi=function(vi){var xi=vi.inputLocked;ci!==xi&&hi(xi)},mi=function(vi){return pi({inputLocked:vi})},gi=function(){var vi=_i.current;vi&&(vi.scrollTop=vi.scrollHeight)};return{state:{terminalRef:_i,inputLocked:ci},handlers:{lock:mi,scrollDown:gi}}}function useSubscribePrinterQueue(fi){var ci=this,hi=fi.controller,_i=hi.clear,pi=hi.print,mi=fi.queue,gi=mi.state,vi=mi.handlers,xi=vi.dequeue,wi=vi.nextEvent,yi=h(null),Ci=yi[0],Ei=yi[1],Si=function(){return Ei(null)},ki=function(Ai){return __awaiter(ci,void 0,void 0,function(){var Ii;return __generator(this,function(Ti){switch(Ti.label){case 0:switch(Ii=Ai.type,Ii){case PrinterEvents.CLEAR:return[3,1];case PrinterEvents.PRINT:return[3,2]}return[3,4];case 1:return _i(),xi(Si),[3,4];case 2:return[4,pi(Ai.payload)];case 3:return Ti.sent(),xi(Si),[3,4];case 4:return[2]}})})};y(function(){var Ai=wi(),Ii=Ci!==Ai;Ai&&Ii&&(Ei(Ai),ki(Ai))},[gi,Ci])}function useSubscribeTerminalQueue(fi){var ci=fi.controller,hi=ci.focus,_i=ci.loading,pi=ci.lock,mi=fi.queue,gi=mi.state,vi=mi.handlers,xi=vi.dequeue,wi=vi.nextEvent,yi=h(null),Ci=yi[0],Ei=yi[1],Si=function(){return Ei(null)},ki=function(Ai){switch(Ai.type){case TerminalEvents.FOCUS:hi(),xi(Si);break;case TerminalEvents.LOADING:_i(Ai.payload),xi(Si);break;case TerminalEvents.LOCK:pi(Ai.payload),xi(Si);break}};y(function(){var Ai=wi(),Ii=Ci!==Ai;Ai&&Ii&&(Ei(Ai),ki(Ai))},[gi,Ci])}function useSubscribeEventQueue(fi){var ci=fi.controller,hi=fi.queue,_i=hi.state,pi=hi.api,mi=pi.dequeue,gi=pi.nextEvent,vi=h(null),xi=vi[0],wi=vi[1],yi=function(){return wi(null)},Ci=usePrinterQueue(),Ei=Ci.handlers,Si=Ei.print,ki=Ei.clear;useSubscribePrinterQueue({queue:Ci,controller:ci});var Ai=useTerminalQueue(),Ii=Ai.handlers,Ti=Ii.focus,Pi=Ii.loading,Li=Ii.lock;useSubscribeTerminalQueue({queue:Ai,controller:ci});var Ri=function(Di){switch(Di.type){case TerminalEvents.FOCUS:Ti(),mi(yi);break;case TerminalEvents.LOADING:Pi(Di.payload),mi(yi);break;case TerminalEvents.LOCK:Li(Di.payload),mi(yi);break;case PrinterEvents.CLEAR:ki(),mi(yi);break;case PrinterEvents.PRINT:Si(Di.payload),mi(yi);break}};y(function(){var Di=gi(),Fi=xi!==Di;Di&&Fi&&(wi(Di),Ri(Di))},[_i,xi])}var DEFAULT_SLIDE="",DEFAULT_SLIDE_INDEX=-1,next=function(fi){var ci=fi.slides,hi=fi.slideIndex,_i=hi+1,pi=ci[_i];return pi?{slideIndex:_i,slide:pi}:{slideIndex:0,slide:ci[0]||DEFAULT_SLIDE}},createLoader=function(fi,ci){return setTimeout(function(){return fi()},ci)};function useLoader(fi){var ci=fi.slides,hi=fi.loaderSpeed,_i=fi.onSetOuterState,pi=h(!1),mi=pi[0],gi=pi[1],vi=h(DEFAULT_SLIDE_INDEX),xi=vi[0],wi=vi[1],yi=h(null),Ci=yi[0],Ei=yi[1],Si=function(){Ci&&(clearTimeout(Ci),Ei(null))},ki=function(Ti){return function(){var Pi=next({slides:ci,slideIndex:xi}),Li=Pi.slide,Ri=Pi.slideIndex;wi(Ri),Ti(Li),Ei(null)}},Ai=function(){gi(!0),ki(_i)()},Ii=function(){gi(!1),_i(DEFAULT_SLIDE),wi(DEFAULT_SLIDE_INDEX)};return y(function(){var Ti=!mi&&Ci,Pi=mi&&!Ci;return Pi?Ei(createLoader(ki(_i),hi)):Ti&&Si(),function(){}},[mi,Ci]),y(function(){return function(){return Si()}},[]),{isLoading:mi,handlers:{startLoading:Ai,endLoading:Ii}}}function styleInject(fi,ci){ci===void 0&&(ci={});var hi=ci.insertAt;if(!(!fi||typeof document>"u")){var _i=document.head||document.getElementsByTagName("head")[0],pi=document.createElement("style");pi.type="text/css",hi==="top"&&_i.firstChild?_i.insertBefore(pi,_i.firstChild):_i.appendChild(pi),pi.styleSheet?pi.styleSheet.cssText=fi:pi.appendChild(document.createTextNode(fi))}}var css_248z$7=`.printer-line-module_commandLine__estqY {
  padding: 1.4285714286rem 1.4285714286rem 1.4285714286rem 1.4285714286rem;
}

.printer-line-module_textLine__nz4P- {
  padding: 0 1.4285714286rem 0 2.8571428571rem;
}`,classes$7={commandLine:"printer-line-module_commandLine__estqY",textLine:"printer-line-module_textLine__nz4P-"};styleInject(css_248z$7);var checkLines=exhaustiveCheck("Unknown line type: "),PrinterLine=function(ci){var hi=ci.line,_i=ci.children,pi=hi.className,mi=pi===void 0?"":pi,gi=hi.dataAttribute,vi=hi.id;return function(){switch(hi.type){case LineTypes.TEXT:return xn.createElement("div",{id:vi,className:[classes$7.textLine,"crt-text-line",mi].join(" "),"data-crt-terminal":gi},_i);case LineTypes.COMMAND:return xn.createElement("div",{id:vi,className:[classes$7.commandLine,"crt-command-line",mi].join(" "),"data-crt-terminal":gi},_i);default:return checkLines(hi)}}()},css_248z$6=`@-webkit-keyframes character-module_blink-character__xvpwk {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@keyframes character-module_blink-character__xvpwk {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@-webkit-keyframes character-module_scanner__eZs7v {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@keyframes character-module_scanner__eZs7v {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@-webkit-keyframes character-module_pulse-text__PBNwr {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@keyframes character-module_pulse-text__PBNwr {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@-webkit-keyframes character-module_shiver-screen__37A2O {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
@keyframes character-module_shiver-screen__37A2O {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
.character-module_character__MzT4w {
  white-space: pre-wrap;
  word-break: break-all;
}

.character-module_characterSelected__axWlO {
  color: #111010;
  background-color: #d0fc7e;
  -webkit-animation: character-module_blink-character__xvpwk 1s steps(1, end) infinite;
          animation: character-module_blink-character__xvpwk 1s steps(1, end) infinite;
}`,classes$6={character:"character-module_character__MzT4w",characterSelected:"character-module_characterSelected__axWlO","blink-character":"character-module_blink-character__xvpwk",scanner:"character-module_scanner__eZs7v","pulse-text":"character-module_pulse-text__PBNwr","shiver-screen":"character-module_shiver-screen__37A2O"};styleInject(css_248z$6);var Character=function(ci){var hi=ci.children,_i=ci.selected,pi=_i===void 0?!1:_i,mi=ci.className,gi=mi===void 0?"":mi,vi=pi?classes$6.characterSelected:"";return xn.createElement("span",{className:[classes$6.character,vi,gi,"crt-character"].join(" ")},hi)},css_248z$5=`.printer-word-module_commandWord__nSXjX {
  display: inline-block;
}

.printer-word-module_textWord__akJYx {
  display: inline-block;
}

.printer-word-module_buttonWord__iu6fj {
  font-family: "Courier New", courier, monospace;
  font-size: 1rem;
  line-height: 1.5;
  text-shadow: 0 0 1.1428571429rem #d0fc7e, 0 0 1.7142857143rem #d0fc7e;
  color: #d0fc7e;
  margin: 0;
  padding: 0 5px;
  display: inline-block;
  background-color: transparent;
  border: 1px solid #d0fc7e;
  cursor: pointer;
}
.printer-word-module_buttonWord__iu6fj:hover {
  color: #111010;
  background-color: #d0fc7e;
}

.printer-word-module_anchorWord__dLnZB {
  font-family: "Courier New", courier, monospace;
  font-size: 1rem;
  line-height: 1.5;
  text-shadow: 0 0 1.1428571429rem #d0fc7e, 0 0 1.7142857143rem #d0fc7e;
  color: #d0fc7e;
  display: inline-block;
}
.printer-word-module_anchorWord__dLnZB:hover {
  color: white;
}`,classes$5={commandWord:"printer-word-module_commandWord__nSXjX",textWord:"printer-word-module_textWord__akJYx",buttonWord:"printer-word-module_buttonWord__iu6fj",anchorWord:"printer-word-module_anchorWord__dLnZB"};styleInject(css_248z$5);var checkWords=exhaustiveCheck("Unknown word type: "),PrinterWord=function(ci){var hi=ci.word,_i=ci.children,pi=hi.className,mi=pi===void 0?"":pi,gi=hi.dataAttribute,vi=hi.id;return function(){switch(hi.type){case WordTypes.TEXT:return xn.createElement("span",{id:vi,className:[classes$5.textWord,"crt-text-word",mi].join(" "),"data-crt-terminal":gi},xn.createElement(Character,null,_i));case WordTypes.ANCHOR:return xn.createElement("a",{id:vi,className:[classes$5.anchorWord,"crt-anchor-word",mi].join(" "),"data-crt-terminal":gi,href:hi.href,onClick:hi.onClick},xn.createElement(Character,null,_i));case WordTypes.BUTTON:return xn.createElement("button",{type:"button",id:vi,className:[classes$5.buttonWord,"crt-button-word",mi].join(" "),"data-crt-terminal":gi,onClick:hi.onClick},xn.createElement(Character,null,_i));case WordTypes.COMMAND:return xn.createElement("span",{id:vi,className:[classes$5.commandWord,"crt-command-word",mi].join(" "),"data-crt-terminal":gi},xn.createElement(Character,null,hi.prompt),xn.createElement(Character,null,_i));default:return checkWords(hi)}}()},TerminalScreen=N(function(fi){var ci=fi.state;return xn.createElement("div",{className:"crt-screen"},ci.map(function(hi,_i){return xn.createElement(PrinterLine,{line:hi,key:_i},hi.words.map(function(pi,mi){return xn.createElement(PrinterWord,{word:pi,key:mi},pi.characters)}))}))}),css_248z$4=`@-webkit-keyframes overlay-module_blink-character__Ye2qL {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@keyframes overlay-module_blink-character__Ye2qL {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@-webkit-keyframes overlay-module_scanner__jkhjA {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@keyframes overlay-module_scanner__jkhjA {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@-webkit-keyframes overlay-module_pulse-text__KyZ3A {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@keyframes overlay-module_pulse-text__KyZ3A {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@-webkit-keyframes overlay-module_shiver-screen__sjqEZ {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
@keyframes overlay-module_shiver-screen__sjqEZ {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
.overlay-module_overlay__zbWt1 {
  position: absolute;
  z-index: 2;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  pointer-events: none;
}

.overlay-module_scanner__jkhjA {
  position: absolute;
  z-index: 1;
  top: 0;
  right: 0;
  left: 0;
  height: 1.7142857143rem;
  opacity: 0.05;
  background: linear-gradient(180deg, transparent 0, #fffcfc 85%, #d0fc7e 0, transparent);
  -webkit-animation: overlay-module_scanner__jkhjA 8s linear infinite forwards;
          animation: overlay-module_scanner__jkhjA 8s linear infinite forwards;
}

.overlay-module_pixels__m5X6w {
  position: absolute;
  z-index: 2;
  top: 0;
  right: 0;
  bottom: 0;
  left: 0;
  display: block;
  background: linear-gradient(transparent 50%, rgba(0, 0, 0, 0.21) 0), linear-gradient(90deg, rgba(255, 0, 0, 0.055), rgba(0, 255, 0, 0.03), rgba(0, 0, 255, 0.055));
  background-position-y: 0.0714285714rem;
  background-size: 100% 0.2142857143rem, 0.2857142857rem 100%;
}`,classes$4={overlay:"overlay-module_overlay__zbWt1",scanner:"overlay-module_scanner__jkhjA",pixels:"overlay-module_pixels__m5X6w","blink-character":"overlay-module_blink-character__Ye2qL","pulse-text":"overlay-module_pulse-text__KyZ3A","shiver-screen":"overlay-module_shiver-screen__sjqEZ"};styleInject(css_248z$4);var Overlay=function(ci){var hi=ci.scanner,_i=ci.pixels;return xn.createElement("div",{className:[classes$4.overlay,"crt-overlay"].join(" ")},hi&&xn.createElement("div",{className:[classes$4.scanner,"crt-scanner"].join(" ")}),_i&&xn.createElement("div",{className:[classes$4.pixels,"crt-pixels"].join(" ")}))},css_248z$3=`@-webkit-keyframes text-effects-module_blink-character__CrwdV {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@keyframes text-effects-module_blink-character__CrwdV {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@-webkit-keyframes text-effects-module_scanner__EXIFB {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@keyframes text-effects-module_scanner__EXIFB {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@-webkit-keyframes text-effects-module_pulse-text__AVts8 {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@keyframes text-effects-module_pulse-text__AVts8 {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@-webkit-keyframes text-effects-module_shiver-screen__ysQ0c {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
@keyframes text-effects-module_shiver-screen__ysQ0c {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
.text-effects-module_textEffects__OWNjV {
  position: relative;
  width: 100%;
  height: 100%;
  -webkit-animation: text-effects-module_pulse-text__AVts8 5s linear infinite;
          animation: text-effects-module_pulse-text__AVts8 5s linear infinite;
}`,classes$3={textEffects:"text-effects-module_textEffects__OWNjV","pulse-text":"text-effects-module_pulse-text__AVts8","blink-character":"text-effects-module_blink-character__CrwdV",scanner:"text-effects-module_scanner__EXIFB","shiver-screen":"text-effects-module_shiver-screen__ysQ0c"};styleInject(css_248z$3);var TextEffects=function(ci){var hi=ci.enabled,_i=ci.children;return xn.createElement(xn.Fragment,null,hi?xn.createElement("div",{className:[classes$3.textEffects,"crt-text-effects"].join(" ")},_i):_i)},css_248z$2=`@-webkit-keyframes screen-effects-module_blink-character__CftBz {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@keyframes screen-effects-module_blink-character__CftBz {
  50% {
    color: #d0fc7e;
    background-color: transparent;
  }
}
@-webkit-keyframes screen-effects-module_scanner__N91BH {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@keyframes screen-effects-module_scanner__N91BH {
  0% {
    top: 0%;
  }
  50% {
    top: 100%;
  }
  100% {
    top: 100%;
  }
}
@-webkit-keyframes screen-effects-module_pulse-text__awrsE {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@keyframes screen-effects-module_pulse-text__awrsE {
  50% {
    text-shadow: 0 0 1.1428571429rem white, 0 0 1.5714285714rem white;
    color: #c6fc7e;
  }
}
@-webkit-keyframes screen-effects-module_shiver-screen__xieUK {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
@keyframes screen-effects-module_shiver-screen__xieUK {
  0% {
    transform: skewX(0deg);
  }
  4% {
    transform: skewX(0.7deg) scale(1.0001);
  }
  8% {
    transform: skewX(0.2deg) skewY(-0.1deg);
  }
  16% {
    transform: skewX(0.2deg);
  }
  50% {
    transform: skewX(0.2deg);
  }
}
.screen-effects-module_screenEffects__bNTzl {
  width: 100%;
  height: 100%;
  -webkit-animation: screen-effects-module_shiver-screen__xieUK 10s linear infinite;
          animation: screen-effects-module_shiver-screen__xieUK 10s linear infinite;
}`,classes$2={screenEffects:"screen-effects-module_screenEffects__bNTzl","shiver-screen":"screen-effects-module_shiver-screen__xieUK","blink-character":"screen-effects-module_blink-character__CftBz",scanner:"screen-effects-module_scanner__N91BH","pulse-text":"screen-effects-module_pulse-text__awrsE"};styleInject(css_248z$2);var ScreenEffects=function(ci){var hi=ci.enabled,_i=ci.children;return xn.createElement(xn.Fragment,null,hi?xn.createElement("div",{className:[classes$2.screenEffects,"crt-screen-effects"].join(" ")},_i):_i)},InputString=N(function(fi){var ci=fi.cursorPosition,hi=fi.renderValue;return xn.createElement(xn.Fragment,null,hi.map(function(_i,pi){return xn.createElement(Character,{selected:ci===pi,key:pi},_i)}))}),css_248z$1=`.command-line-module_commandLine__lnMf6 {
  padding: 1.4285714286rem 1.4285714286rem 1.4285714286rem 1.4285714286rem;
}

.command-line-module_inputWrap__OpY8r {
  display: inline-block;
}

.command-line-module_input__ZPwEm {
  position: absolute;
  opacity: 0;
  pointer-events: none;
  -webkit-user-select: none;
     -moz-user-select: none;
      -ms-user-select: none;
          user-select: none;
}

.command-line-module_inputString__J1jZF {
  display: inline-block;
  overflow: visible;
  white-space: normal;
  word-break: break-all;
}`,classes$1={commandLine:"command-line-module_commandLine__lnMf6",inputWrap:"command-line-module_inputWrap__OpY8r",input:"command-line-module_input__ZPwEm",inputString:"command-line-module_inputString__J1jZF"};styleInject(css_248z$1);var CommandLine=xn.forwardRef(function(fi,ci){var hi=fi.state,_i=hi.cursorPosition,pi=hi.renderValue,mi=hi.inputValue,gi=fi.handleKeyboardDown,vi=fi.handleInputChange,xi=fi.prompt,wi=fi.cursorSymbol,yi=function(Si){var ki=Si.currentTarget.value;vi(ki)},Ci=function(Si){gi(Si)},Ei=_i===pi.length;return xn.createElement("div",{className:[classes$1.commandLine,"crt-command-line"].join(" ")},xn.createElement("span",{className:"crt-command-line__prompt"},xi),xn.createElement("div",{className:[classes$1.inputWrap,"crt-command-line__input-wrapper"].join(" ")},xn.createElement("input",{className:[classes$1.input,"crt-command-line__input"].join(" "),id:"crt-command-line-input",ref:ci,value:mi,onInput:yi,onKeyDown:Ci,type:"text"}),xn.createElement("div",{className:[classes$1.inputString,"crt-command-line__input-string"].join(" ")},xn.createElement(InputString,{renderValue:pi,cursorPosition:_i}),Ei&&xn.createElement(Character,{className:"crt-cursor-symbol",selected:!0},wi))))}),css_248z=`.terminal-module_terminal__4qfYI {
  font-family: "Courier New", courier, monospace;
  font-size: 1rem;
  line-height: 1.5;
  text-shadow: 0 0 1.1428571429rem #d0fc7e, 0 0 1.7142857143rem #d0fc7e;
  color: #d0fc7e;
  position: relative;
  margin: 0;
  padding: 1.1428571429rem 0.5714285714rem;
  display: block;
  overflow: hidden;
  box-sizing: border-box;
  width: 100%;
  height: 100%;
  max-height: 100%;
  background: radial-gradient(50% 50% at 50% 50%, #354228 0, #0f140a 100%);
  border: 1.1428571429rem solid #111010;
  border-radius: 3.4285714286rem;
  box-shadow: 0 0 2.8571428571rem #252925, inset 0 0 2rem 1.4285714286rem #000;
  -webkit-font-smoothing: antialiased;
}
.terminal-module_terminal__4qfYI ::-moz-selection {
  color: #111010;
  background: #d0fc7e;
  -moz-appearance: none;
       appearance: none;
}
.terminal-module_terminal__4qfYI ::selection {
  color: #111010;
  background: #d0fc7e;
  -webkit-appearance: none;
     -moz-appearance: none;
          appearance: none;
}
.terminal-module_terminal__4qfYI * {
  box-sizing: border-box;
}

.terminal-module_overflowContainer__p2duW {
  position: relative;
  overflow-y: auto;
  width: 100%;
  max-height: 100%;
  border-radius: 1.2857142857rem;
}
.terminal-module_overflowContainer__p2duW::-webkit-scrollbar {
  width: 0.3571428571rem;
  height: 0.3571428571rem;
}
.terminal-module_overflowContainer__p2duW::-webkit-scrollbar-button {
  width: 0;
  height: 0;
}
.terminal-module_overflowContainer__p2duW::-webkit-scrollbar-thumb {
  background: #d0fc7e;
  border: 0 none #fffcfc;
  border-radius: 0.2857142857rem;
}`,classes={terminal:"terminal-module_terminal__4qfYI",overflowContainer:"terminal-module_overflowContainer__p2duW"};styleInject(css_248z);var Terminal=function(ci){var hi=ci.onCommand,_i=ci.queue,pi=ci.banner,mi=ci.prompt,gi=mi===void 0?">":mi,vi=ci.cursorSymbol,xi=vi===void 0?"":vi,wi=ci.maxHistoryCommands,yi=wi===void 0?10:wi,Ci=ci.loader,Ei=Ci===void 0?{}:Ci,Si=Ei.slides,ki=Si===void 0?[".","..","..."]:Si,Ai=Ei.loaderSpeed,Ii=Ai===void 0?1e3:Ai,Ti=ci.printer,Pi=Ti===void 0?{}:Ti,Li=Pi.printerSpeed,Ri=Li===void 0?20:Li,Di=Pi.charactersPerTick,Fi=Di===void 0?5:Di,Mi=Pi.onPrintStatusChange,$i=ci.effects,Oi=$i===void 0?{}:$i,Gi=Oi.scanner,Ui=Gi===void 0?!0:Gi,zi=Oi.pixels,Wi=zi===void 0?!0:zi,Ni=Oi.screenEffects,Hi=Ni===void 0?!0:Ni,ji=Oi.textEffects,Bi=ji===void 0?!0:ji,Ji=ci.focusOnMount,Ki=Ji===void 0?!0:Ji,Vi=useTerminalApp(),qi=Vi.state.terminalRef,Yi=Vi.handlers.scrollDown,Qi=useCommandScreen({printerConfig:{printerSpeed:Ri,charactersPerTick:Fi,afterPrintCallback:Yi,onPrintStatusChange:Mi}}),ts=Qi.state,Zi=Qi.handlers,is=useCommandLine(),ss=useCommandLineInput(),ns=ss.state.inputElementRef,as=ss.handlers,ls=useCommandHistory({maxHistoryCommands:yi}),cs=useLoader({slides:ki,loaderSpeed:Ii,onSetOuterState:is.handlers.setInput}),rs=useTerminalController({input:{handlers:as},terminalApp:Vi,commandHistory:ls,commandLine:is,commandScreen:{handlers:Zi},loaderComponent:cs,interface:{banner:pi,prompt:gi,onCommand:hi,queue:_i},focusOnMount:Ki}).handlers,os=rs.handleKeyboardDown,Xi=rs.handleInputChange;return useSubscribeEventQueue({queue:_i,controller:rs}),xn.createElement("label",{className:[classes.terminal,"crt-terminal"].join(" "),htmlFor:"crt-command-line-input"},xn.createElement(Overlay,{scanner:Ui,pixels:Wi}),xn.createElement(ScreenEffects,{enabled:Hi},xn.createElement("div",{ref:qi,className:[classes.overflowContainer,"crt-terminal__overflow-container"].join(" ")},xn.createElement(TextEffects,{enabled:Bi},xn.createElement("div",{className:"crt-terminal__screen"},xn.createElement(TerminalScreen,{state:ts})),xn.createElement("div",{className:"crt-terminal__command-line"},xn.createElement(CommandLine,{ref:ns,prompt:gi,cursorSymbol:xi,state:is.state,handleKeyboardDown:os,handleInputChange:Xi}))))))};const bannerText=`
Iniciando R.O.K.E.

`;function CrtTerminal(){const eventQueue=useEventQueue(),{print}=eventQueue.handlers;function onButton(fi,ci){window.term.write(fi+`

`),ci.remove()}function printObject(fi,ci=null){const hi=Object.keys(fi).filter(_i=>_i!=ci);print([textLine({words:[textWord({characters:fi[ci]||"<="})]}),textLine({words:hi.map(_i=>buttonWord({characters:_i,onClick:pi=>onButton(fi[_i].toString(),pi.target)}))})])}window.term={write:fi=>print([textLine({words:[textWord({characters:fi})]})]),writeObject:printObject,...eventQueue.handlers};async function onCommand(command){if(command.startsWith("gsk_")&&command.length==56){localStorage.setItem("groqApiKey",command),initGroq(command),window.term.write("API KEY guardada.");return}let result;try{const res=eval(command);console.log(res),res&&(result={response:res.toString?res.toString():res})}catch(fi){console.error(fi);try{result=await converse(command,window.player)}catch(ci){console.error(ci)}}result&&printObject(result,"response")}return u$2("div",{id:"terminal",style:{width:"1000px",height:"550px"},children:u$2(Terminal,{queue:eventQueue,banner:[textLine({words:[textWord({characters:bannerText})]})],onCommand})})}function CrtVisual(){const[fi,ci]=h("");function hi(_i){ci(_i)}return window.visual={flash:hi},u$2("div",{id:"game",children:[u$2("div",{id:"game_overlay",children:fi}),u$2("canvas",{tabIndex:"1",id:"game_canvas"})]})}__webpack_exports__Flags.useCanvasGraphicsContext();D$3(u$2(k$3,{children:[u$2(CrtVisual,{}),u$2(CrtTerminal,{})]}),document.getElementById("app"));const game=new __webpack_exports__Engine({width:640,height:480,displayMode:__webpack_exports__DisplayMode.Fixed,canvasElementId:"game_canvas",backgroundColor:__webpack_exports__Color.Black,pixelArt:!0,physics:{solver:__webpack_exports__SolverStrategy.Realistic}}),loader=new __webpack_exports__Loader([dsml1,...resources]);loader.backgroundColor="#020610";loader.logo=logo;loader.logoHeight=480;loader.logoWidth=640;loader.logoPosition=__webpack_exports__vec(game.screen.width/2-320,0);loader.loadingBarPosition=__webpack_exports__vec(game.screen.width/2-320,380);loader.loadingBarHeight=10;loader.loadingBarColor=__webpack_exports__Color.Yellow;loader.suppressPlayButton=!0;document.body.addEventListener("click",function fi(){this.removeEventListener("click",fi),addPermission()});document.getElementById("game").onclick=fi=>{fi.target.focus()};game.start(loader).then(()=>{game.currentScene.physics.config.gravity=__webpack_exports__vec(0,200);let fi=new Player(492,50);dsml1.addToScene(game.currentScene),game.add(fi),window.player=fi,game.currentScene.camera.strategy.elasticToActor(fi,.3,.8),game.currentScene.camera.pos=fi.pos,game.currentScene.camera.zoom=3;let ci=new __webpack_exports__BoundingBox(0,0,dsml1.data.levels[0].pxWid,dsml1.data.levels[0].pxHei);game.currentScene.camera.strategy.limitCameraBounds(ci),game.currentScene.camera.zoomOverTime(2,2e3)});window.dsml1=dsml1;window.game=game;window.ex=ex;export{WebPlugin as W};
//# sourceMappingURL=index-NFcv5XO2.js.map
